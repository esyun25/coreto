<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORETO å£²è²·å ±å‘Šæ›¸</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--card:#0f1119;--card2:#141720;--border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--gold-l:#e8c96a;--gold-dim:#7a5f22;--gold-glow:rgba(201,168,76,.12);
  --blue:#4f9cf9;--green:#34d399;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;
  --muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;
}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;
  background-image:radial-gradient(ellipse 60% 40% at 80% 10%,rgba(201,168,76,.05) 0%,transparent 60%)}
.header{display:flex;align-items:center;justify-content:space-between;padding:0 32px;height:56px;
  border-bottom:1px solid var(--border);background:rgba(7,9,15,.8);backdrop-filter:blur(12px);
  position:sticky;top:0;z-index:100}
.logo{font-family:'Syne',sans-serif;font-size:19px;font-weight:800;color:var(--gold);letter-spacing:3px}
.hdr-badge{font-size:10px;font-weight:700;padding:3px 10px;border-radius:5px;
  background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red)}
.hdr-right{display:flex;align-items:center;gap:12px}
.hdr-agent{font-size:12px;font-weight:600}
.hdr-id{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.page{padding:24px 32px;max-width:960px;margin:0 auto}
.page-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--gold);margin-bottom:4px}
.page-sub{font-size:11px;color:var(--muted);margin-bottom:24px}
.panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px;margin-bottom:16px}
.panel-title{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:var(--gold);
  letter-spacing:2px;text-transform:uppercase;display:flex;align-items:center;gap:8px;margin-bottom:16px}
.panel-title::before{content:'';width:3px;height:14px;background:var(--gold);border-radius:2px;flex-shrink:0}
.s-label{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;
  padding:10px 0 7px;border-bottom:1px solid var(--border);margin-bottom:10px;margin-top:18px;
  display:flex;align-items:center;gap:8px}
.s-label:first-child{margin-top:0}
.fg label{font-size:11px;color:var(--sub);display:block;margin-bottom:4px}
.req{color:var(--red);margin-left:2px;font-size:9px}
.hint{color:var(--muted);font-size:9px;margin-left:6px}
.auto-tag{font-size:8px;color:var(--blue);background:rgba(79,156,249,.1);
  border:1px solid rgba(79,156,249,.2);border-radius:3px;padding:1px 5px}
input,select,textarea{width:100%;background:#0a0c14;border:1px solid var(--border2);border-radius:8px;
  padding:9px 12px;color:var(--text);font-size:13px;font-family:'Noto Sans JP',sans-serif;
  transition:border-color .15s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--gold);background:#0c0e18}
input[type=date]{color-scheme:dark}
input[readonly]{background:#0c0e18;border-color:rgba(79,156,249,.25);color:var(--blue);cursor:default}
.mono{font-family:'DM Mono',monospace!important}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.err-msg{font-size:10px;color:var(--red);margin-top:3px;display:none}
.err-msg.show{display:block}
.tg{padding:6px 13px;border-radius:7px;font-size:11px;cursor:pointer;border:1px solid var(--border2);
  background:transparent;color:var(--muted);font-family:'Noto Sans JP',sans-serif;transition:all .2s}
.tg.on{background:rgba(201,168,76,.12);border-color:var(--gold-dim);color:var(--gold);font-weight:700}
.tg.on.bl{background:rgba(79,156,249,.12);border-color:rgba(79,156,249,.4);color:var(--blue)}
.tg.on.re{background:rgba(248,113,113,.12);border-color:rgba(248,113,113,.4);color:var(--red)}
.tg-group{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border-radius:9px;font-size:12px;
  font-weight:600;cursor:pointer;border:none;font-family:'Noto Sans JP',sans-serif;transition:all .2s}
.btn-gold{background:linear-gradient(135deg,var(--gold),#a8872f);color:#0a0c10}
.btn-gold:hover{background:linear-gradient(135deg,var(--gold-l),var(--gold));transform:translateY(-1px)}
.btn-blue{background:rgba(79,156,249,.15);color:var(--blue);border:1px solid rgba(79,156,249,.3)}
.btn-muted{background:transparent;color:var(--muted);border:1px solid var(--border2)}
.badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700}
.badge-orange{background:rgba(251,146,60,.12);color:var(--orange);border:1px solid rgba(251,146,60,.2)}
.badge-green{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.badge-blue{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.2)}
.result-box{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:12px}
.result-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;
  font-size:12px;border-bottom:1px solid var(--border)}
.result-row:last-child{border-bottom:none}
.result-row.total{font-weight:700;font-size:14px;color:var(--gold);margin-top:4px;padding-top:8px}
.timeline{display:flex;flex-direction:column;gap:0}
.tl-item{display:flex;gap:14px;align-items:flex-start;padding:10px 0;position:relative}
.tl-item:not(:last-child)::before{content:'';position:absolute;left:11px;top:34px;
  width:1px;height:calc(100% - 10px);background:var(--border)}
.tl-dot{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:700;flex-shrink:0;border:1.5px solid}
.tl-dot.active{background:rgba(201,168,76,.15);border-color:var(--gold);color:var(--gold)}
.tl-dot.future{background:transparent;border-color:var(--border2);color:var(--muted)}
.tl-dot.done{background:rgba(52,211,153,.15);border-color:var(--green);color:var(--green)}
.tl-content{flex:1;padding-top:2px}
.tl-title{font-size:12px;font-weight:600}
.tl-note{font-size:10px;color:var(--muted);margin-top:2px}
.tl-date{font-size:10px;font-family:'DM Mono',monospace;color:var(--sub);margin-top:2px}
.submit-bar{display:flex;align-items:center;justify-content:space-between;gap:12px;
  background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 22px;margin-top:8px}
.submit-note{font-size:11px;color:var(--muted)}
.hidden{display:none!important}
.progress-bar{height:4px;border-radius:2px;background:var(--border2);overflow:hidden;margin-top:8px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold-l));
  border-radius:2px;transition:width .5s ease}
#modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);
  z-index:200;align-items:center;justify-content:center}
#modal-overlay.show{display:flex}
#modal-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;
  max-width:480px;width:90%}
.modal-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--gold);margin-bottom:16px}
.toast{position:fixed;bottom:28px;right:28px;background:var(--card);border:1px solid var(--green);
  border-radius:10px;padding:12px 18px;font-size:12px;color:var(--green);z-index:300;
  display:none;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center;gap:16px">
    <div class="logo">CORETO</div>
    <div class="hdr-badge">ğŸ¢ å£²è²·å ±å‘Šæ›¸</div>
  </div>
  <div class="hdr-right">
    <div>
      <div class="hdr-agent" id="hdr-agent">â€” ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ â€”</div>
      <div class="hdr-id" id="hdr-id">ID: â€”â€”</div>
    </div>
    <button class="btn btn-muted" style="font-size:11px;padding:6px 14px" onclick="history.back()">â† æˆ»ã‚‹</button>
  </div>
</div>

<div class="page">
  <div class="page-title">å£²è²·å ±å‘Šæ›¸</div>
  <div class="page-sub">è²·ä»˜ç”³è¾¼å—é ˜æ™‚ã«ä½œæˆãƒ»æå‡ºã€‚HQæ‰¿èªå¾Œã€å–å¼•é€²è¡Œãƒ•ãƒ­ãƒ¼ã¸ç§»è¡Œã—ã¾ã™ã€‚</div>

  <!-- â‘  åŸºæœ¬æƒ…å ± -->
  <div class="panel">
    <div class="panel-title">â‘  åŸºæœ¬æƒ…å ±</div>
    <div class="two-col" style="margin-bottom:12px">
      <div class="fg">
        <label>Case ID <span class="req">*</span></label>
        <input type="text" id="case-id" class="mono" placeholder="S0001" oninput="fetchCase()">
      </div>
      <div class="fg">
        <label>å ±å‘Šæ—¥ <span class="req">*</span></label>
        <input type="date" id="report-date" class="mono">
      </div>
    </div>
    <div class="two-col">
      <div class="fg">
        <label>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ <span class="auto-tag">è‡ªå‹•å…¥åŠ›</span></label>
        <input type="text" id="agent-name" class="mono" readonly>
      </div>
      <div class="fg">
        <label>æ¡ˆä»¶ã‚½ãƒ¼ã‚¹</label>
        <div class="tg-group" id="g-source">
          <button class="tg on bl" data-v="self" onclick="tog('g-source',this)">è‡ªå·±é–‹æ‹“</button>
          <button class="tg" data-v="pt" onclick="tog('g-source',this)">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç´¹ä»‹</button>
          <button class="tg" data-v="hq" onclick="tog('g-source',this)">HQç´¹ä»‹</button>
        </div>
      </div>
    </div>
    <!-- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼ˆsource=ptæ™‚ï¼‰ -->
    <div id="sec-partner" class="hidden" style="margin-top:12px">
      <div class="two-col">
        <div class="fg"><label>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å</label><input type="text" id="pt-name"></div>
        <div class="fg"><label>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ID</label><input type="text" id="pt-id" class="mono"></div>
      </div>
    </div>
  </div>

  <!-- â‘¡ ç‰©ä»¶æƒ…å ± -->
  <div class="panel">
    <div class="panel-title">â‘¡ ç‰©ä»¶æƒ…å ±</div>
    <div class="fg" style="margin-bottom:12px">
      <label>ç‰©ä»¶åç§° <span class="req">*</span></label>
      <input type="text" id="property-name" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 2LDK 301å·å®¤">
    </div>
    <div class="two-col" style="margin-bottom:12px">
      <div class="fg">
        <label>ç‰©ä»¶ä½æ‰€ <span class="req">*</span></label>
        <input type="text" id="property-addr" placeholder="æ±äº¬éƒ½æ¸‹è°·åŒºã€‡ã€‡1-2-3">
      </div>
      <div class="fg">
        <label>ç‰©ä»¶ç¨®åˆ¥</label>
        <div class="tg-group" id="g-prop-type">
          <button class="tg on bl" data-v="mansion" onclick="tog('g-prop-type',this)">åŒºåˆ†ãƒãƒ³ã‚·ãƒ§ãƒ³</button>
          <button class="tg" data-v="ikkodate" onclick="tog('g-prop-type',this)">ä¸€æˆ¸å»ºã¦</button>
          <button class="tg" data-v="tochi" onclick="tog('g-prop-type',this)">åœŸåœ°</button>
          <button class="tg" data-v="other" onclick="tog('g-prop-type',this)">ãã®ä»–</button>
        </div>
      </div>
    </div>
    <div class="three-col">
      <div class="fg">
        <label>å£²è²·ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰<span class="req">*</span></label>
        <input type="number" id="sale-price" class="mono" placeholder="0" oninput="calcAll()">
      </div>
      <div class="fg">
        <label>æ¶ˆè²»ç¨é¡</label>
        <input type="number" id="tax-amount" class="mono" placeholder="0" oninput="calcAll()">
      </div>
      <div class="fg">
        <label>ç¯‰å¹´æ•°</label>
        <input type="number" id="building-age" class="mono" placeholder="0">
      </div>
    </div>
  </div>

  <!-- â‘¢ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ± -->
  <div class="panel">
    <div class="panel-title">â‘¢ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±</div>
    <div class="two-col" style="margin-bottom:12px">
      <div class="fg">
        <label>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ°å <span class="req">*</span></label>
        <input type="text" id="client-name">
      </div>
      <div class="fg">
        <label>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID</label>
        <input type="text" id="client-id" class="mono">
      </div>
    </div>
    <div class="two-col" style="margin-bottom:12px">
      <div class="fg">
        <label>é›»è©±ç•ªå·</label>
        <input type="tel" id="client-tel" class="mono">
      </div>
      <div class="fg">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="client-email">
      </div>
    </div>
    <div class="fg">
      <label>å£²ä¸»ï¼ˆç›¸æ‰‹æ–¹ï¼‰</label>
      <input type="text" id="seller-name" placeholder="å£²ä¸»æ°åã¾ãŸã¯æ³•äººå">
    </div>
  </div>

  <!-- â‘£ è²·ä»˜æ¡ä»¶ -->
  <div class="panel">
    <div class="panel-title">â‘£ è²·ä»˜æ¡ä»¶</div>
    <div class="two-col" style="margin-bottom:12px">
      <div class="fg">
        <label>è²·ä»˜é‡‘é¡ï¼ˆç”³è¾¼é¡ï¼‰<span class="req">*</span></label>
        <input type="number" id="offer-price" class="mono" placeholder="0" oninput="calcAll()">
      </div>
      <div class="fg">
        <label>è²·ä»˜å—é ˜æ—¥ <span class="req">*</span></label>
        <input type="date" id="offer-date" class="mono" onchange="updateTimeline()">
      </div>
    </div>
    <div class="two-col" style="margin-bottom:12px">
      <div class="fg">
        <label>èè³‡ç‰¹ç´„</label>
        <div class="tg-group" id="g-loan">
          <button class="tg on bl" data-v="yes" onclick="tog('g-loan',this)">ã‚ã‚Šï¼ˆèè³‡æ¡ä»¶ä»˜ãï¼‰</button>
          <button class="tg" data-v="no" onclick="tog('g-loan',this)">ãªã—ï¼ˆç¾é‡‘ãƒ»ç¢ºç´„ï¼‰</button>
        </div>
      </div>
      <div class="fg">
        <label>ãƒ­ãƒ¼ãƒ³å¯©æŸ»æœŸé™</label>
        <input type="date" id="loan-deadline" class="mono">
      </div>
    </div>
    <div class="two-col">
      <div class="fg">
        <label>æ‰‹ä»˜é‡‘é¡</label>
        <input type="number" id="deposit-amount" class="mono" placeholder="0" oninput="calcAll()">
      </div>
      <div class="fg">
        <label>æ‰‹ä»˜æ”¯æ‰•æœŸé™</label>
        <input type="date" id="deposit-deadline" class="mono">
      </div>
    </div>
  </div>

  <!-- â‘¤ å–å¼•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
  <div class="panel">
    <div class="panel-title">â‘¤ å–å¼•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
    <div class="three-col" style="margin-bottom:16px">
      <div class="fg">
        <label>å£²è²·å¥‘ç´„äºˆå®šæ—¥</label>
        <input type="date" id="contract-date" class="mono" onchange="updateTimeline()">
      </div>
      <div class="fg">
        <label>æ±ºæ¸ˆæ—¥ï¼ˆå¼•æ¸¡æ—¥ï¼‰<span class="req">*</span> <span class="hint">ãƒã‚¤ãƒ³ãƒˆåˆ¤å®šåŸºæº–æ—¥</span></label>
        <input type="date" id="settlement-date" class="mono" onchange="calcAll(); updateTimeline()">
      </div>
      <div class="fg">
        <label>å…¥å±…äºˆå®šæ—¥</label>
        <input type="date" id="move-in-date" class="mono">
      </div>
    </div>

    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <div class="s-label">å–å¼•ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
    <div class="timeline" id="timeline">
      <div class="tl-item">
        <div class="tl-dot done">âœ“</div>
        <div class="tl-content">
          <div class="tl-title">è²·ä»˜ç”³è¾¼å—é ˜</div>
          <div class="tl-note">æœ¬å ±å‘Šæ›¸ã‚’ä½œæˆãƒ»æå‡º</div>
          <div class="tl-date" id="tl-offer-date">â€”</div>
        </div>
      </div>
      <div class="tl-item">
        <div class="tl-dot active">â–¶</div>
        <div class="tl-content">
          <div class="tl-title">HQæ‰¿èª â†’ å£²ä¸»å´äº¤æ¸‰</div>
          <div class="tl-note">æ¡ä»¶èª¿æ•´ãƒ»å£²ä¸»æ‰¿è«¾ç¢ºèª</div>
        </div>
      </div>
      <div class="tl-item">
        <div class="tl-dot future">3</div>
        <div class="tl-content">
          <div class="tl-title">å£²è²·å¥‘ç´„ç· çµï¼ˆé‡è¦äº‹é …èª¬æ˜ï¼‰</div>
          <div class="tl-note">å®…å»ºå£«ç«‹ä¼šãƒ»æ‰‹ä»˜é‡‘æˆå—</div>
          <div class="tl-date" id="tl-contract-date">â€”</div>
        </div>
      </div>
      <div class="tl-item">
        <div class="tl-dot future">4</div>
        <div class="tl-content">
          <div class="tl-title">ãƒ­ãƒ¼ãƒ³å¯©æŸ»æœŸé™</div>
          <div class="tl-note">èè³‡ç‰¹ç´„ã‚ã‚Šæ¡ˆä»¶ã®ã¿</div>
          <div class="tl-date" id="tl-loan-date">â€”</div>
        </div>
      </div>
      <div class="tl-item">
        <div class="tl-dot future">5</div>
        <div class="tl-content">
          <div class="tl-title">æ±ºæ¸ˆãƒ»å¼•æ¸¡ã—</div>
          <div class="tl-note" style="color:var(--gold)">ğŸ† ãƒã‚¤ãƒ³ãƒˆåˆ¤å®šåŸºæº–æ—¥</div>
          <div class="tl-date" id="tl-settlement-date">â€”</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â‘¥ ä»²ä»‹æ‰‹æ•°æ–™ãƒ»å ±é…¬è¨ˆç®— -->
  <div class="panel">
    <div class="panel-title">â‘¥ ä»²ä»‹æ‰‹æ•°æ–™ãƒ»å ±é…¬è¨ˆç®—</div>
    <div class="two-col" style="margin-bottom:16px">
      <div>
        <div class="s-label" style="margin-top:0">æ³•å®šä¸Šé™è¨ˆç®—</div>
        <div class="result-box">
          <div class="result-row">
            <span style="color:var(--sub)">å£²è²·ä¾¡æ ¼</span>
            <span class="mono" id="disp-price">Â¥â€”</span>
          </div>
          <div class="result-row">
            <span style="color:var(--sub)">æ³•å®šä¸Šé™ï¼ˆç¨è¾¼ï¼‰</span>
            <span class="mono" id="disp-legal-max">Â¥â€”</span>
          </div>
          <div class="result-row">
            <span style="color:var(--sub)">å®Ÿéš›ã®æ‰‹æ•°æ–™ï¼ˆç¨è¾¼ï¼‰</span>
            <input type="number" id="actual-fee" class="mono" style="width:160px;padding:4px 8px;font-size:12px" 
              placeholder="0" oninput="calcAll()">
          </div>
        </div>
      </div>
      <div>
        <div class="s-label" style="margin-top:0">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå ±é…¬</div>
        <div class="result-box">
          <div class="result-row">
            <span style="color:var(--sub)">å ±é…¬ç‡ï¼ˆãƒ©ãƒ³ã‚¯åˆ¥ï¼‰</span>
            <span class="mono" id="disp-rate">65%</span>
          </div>
          <div class="result-row">
            <span style="color:var(--sub)">AGå ±é…¬ï¼ˆç¨æŠœï¼‰</span>
            <span class="mono" id="disp-ag-reward">Â¥â€”</span>
          </div>
          <div class="result-row">
            <span style="color:var(--sub)">æºæ³‰å¾´åï¼ˆ10.21%ï¼‰</span>
            <span class="mono" id="disp-withholding">Â¥â€”</span>
          </div>
          <div class="result-row total">
            <span>æŒ¯è¾¼é¡ï¼ˆç¨å¼•å¾Œï¼‰</span>
            <span class="mono" id="disp-payout">Â¥â€”</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ¡ˆä»¶ã®å ´åˆ -->
    <div id="sec-pt-fee" class="hidden">
      <div class="s-label">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å ±é…¬</div>
      <div class="result-box">
        <div class="result-row">
          <span style="color:var(--sub)">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å ±é…¬ç‡</span>
          <span class="mono">25%ï¼ˆç¨æŠœæ‰‹æ•°æ–™ã«å¯¾ã—ã¦ï¼‰</span>
        </div>
        <div class="result-row total">
          <span>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æŒ¯è¾¼é¡</span>
          <span class="mono" id="disp-pt-payout">Â¥â€”</span>
        </div>
      </div>
    </div>

    <!-- ãƒã‚¤ãƒ³ãƒˆè©¦ç®— -->
    <div class="s-label">ãƒã‚¤ãƒ³ãƒˆè©¦ç®—ï¼ˆæ±ºæ¸ˆæ—¥è¨ˆä¸Šï¼‰</div>
    <div class="result-box">
      <div class="result-row">
        <span style="color:var(--sub)">æ‰‹æ•°æ–™ãƒã‚¤ãƒ³ãƒˆï¼ˆ10ä¸‡å††/1ptï¼‰</span>
        <span class="mono" id="pt-fee-pts">â€” pt</span>
      </div>
      <div class="result-row">
        <span style="color:var(--sub)">æ¡ˆä»¶å®Œäº†ãƒœãƒ¼ãƒŠã‚¹</span>
        <span class="mono" id="pt-bonus">
          <span id="pt-bonus-self">1.0 pt</span>
          <span id="pt-bonus-pt" class="hidden" style="color:var(--blue)">0.5 ptï¼ˆãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ¡ˆä»¶ï¼‰</span>
        </span>
      </div>
      <div class="result-row total">
        <span>ä»Šå›ç²å¾—äºˆå®šãƒã‚¤ãƒ³ãƒˆåˆè¨ˆ</span>
        <span class="mono" style="color:var(--gold)" id="pt-total">â€” pt</span>
      </div>
    </div>
  </div>

  <!-- â‘¦ ç‰¹è¨˜äº‹é … -->
  <div class="panel">
    <div class="panel-title">â‘¦ ç‰¹è¨˜äº‹é …ãƒ»å‚™è€ƒ</div>
    <div class="fg" style="margin-bottom:12px">
      <label>è²·ä»˜æ¡ä»¶ãƒ»äº¤æ¸‰çµŒç·¯</label>
      <textarea id="memo-nego" rows="3" placeholder="ä¾¡æ ¼äº¤æ¸‰ã®çµŒç·¯ã€å£²ä¸»ã®åå¿œã€ç‰¹åˆ¥æ¡ä»¶ãªã©"></textarea>
    </div>
    <div class="fg">
      <label>ç‰©ä»¶ç‰¹è¨˜äº‹é …ï¼ˆå‘ŠçŸ¥äº‹é …ãƒ»ç‘•ç–µç­‰ï¼‰</label>
      <textarea id="memo-property" rows="3" placeholder="å¿ƒç†çš„ç‘•ç–µãƒ»ç‰©ç†çš„ç‘•ç–µãƒ»æ³•çš„åˆ¶é™ãƒ»å¢ƒç•Œç¢ºèªçŠ¶æ³ãªã©"></textarea>
    </div>
  </div>

  <!-- é€ä¿¡ãƒãƒ¼ -->
  <div class="submit-bar">
    <div class="submit-note">
      é€ä¿¡å¾Œï¼šHQãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ Slack #å£²è²·æ¡ˆä»¶ é€šçŸ¥ â†’ Kintone æ¡ˆä»¶ç™»éŒ²
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-muted" onclick="saveDraft()">ğŸ’¾ ä¸‹æ›¸ãä¿å­˜</button>
      <button class="btn btn-gold" id="submit-btn" onclick="showConfirmModal()">ğŸ“¤ HQã¸æå‡º</button>
    </div>
  </div>
</div>

<!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal-overlay">
  <div id="modal-box">
    <div class="modal-title">ğŸ“¤ å£²è²·å ±å‘Šæ›¸ã‚’æå‡º</div>
    <div id="modal-summary" style="font-size:12px;color:var(--sub);line-height:2;margin-bottom:20px"></div>
    <div id="progress-wrap" class="hidden">
      <div style="font-size:11px;color:var(--muted);margin-bottom:6px" id="progress-msg">å‡¦ç†ä¸­...</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    </div>
    <div id="modal-btns" style="display:flex;gap:10px;margin-top:20px">
      <button class="btn btn-muted" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-gold" style="flex:2" onclick="submitReport()" id="confirm-btn">âœ… æå‡ºç¢ºå®š</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">âœ… å£²è²·å ±å‘Šæ›¸ã‚’æå‡ºã—ã¾ã—ãŸ â€” HQãƒ»Slackãƒ»Kintoneã«è‡ªå‹•é€šçŸ¥</div>

<script>
// â”€â”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³ â”€â”€
const session = JSON.parse(sessionStorage.getItem('coreto_session') || '{}');
const RANK_RATE = { platinum:0.75, gold:0.70, silver:0.675, bronze:0.65 };

document.addEventListener('DOMContentLoaded', () => {
  // ãƒ˜ãƒƒãƒ€ãƒ¼
  if (session.name) {
    document.getElementById('hdr-agent').textContent = session.name;
    document.getElementById('hdr-id').textContent = 'ID: ' + (session.userId || 'â€”â€”');
    document.getElementById('agent-name').value = session.name;
  }
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('report-date').value = today;
  document.getElementById('offer-date').value = today;
  updateTimeline();
  checkSource();
});

function tog(groupId, el) {
  document.querySelectorAll(`#${groupId} .tg`).forEach(b => b.classList.remove('on','bl','re'));
  el.classList.add('on');
  if (el.dataset.v === 'pt') el.classList.add('bl');
  checkSource();
  calcAll();
}
function gv(groupId) {
  const el = document.querySelector(`#${groupId} .tg.on`);
  return el ? el.dataset.v : null;
}

function checkSource() {
  const src = gv('g-source');
  const isPt = src === 'pt';
  document.getElementById('sec-partner').classList.toggle('hidden', !isPt);
  document.getElementById('sec-pt-fee').classList.toggle('hidden', !isPt);
  // ãƒã‚¤ãƒ³ãƒˆãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤º
  document.getElementById('pt-bonus-self').classList.toggle('hidden', isPt);
  document.getElementById('pt-bonus-pt').classList.toggle('hidden', !isPt);
  calcAll();
}

function fetchCase() {
  const id = document.getElementById('case-id').value.trim();
  if (!id) return;
  // Demo: auto-fill
  if (id === 'S0001') {
    document.getElementById('client-name').value = 'ç”°ä¸­ é›„ä»‹';
    document.getElementById('client-id').value = 'CNT-001';
    document.getElementById('property-name').value = 'æ¸‹è°·åŒºæ¡œä¸˜ æˆ¸å»ºã¦';
    document.getElementById('property-addr').value = 'æ±äº¬éƒ½æ¸‹è°·åŒºæ¡œä¸˜1-2-3';
    document.getElementById('sale-price').value = '65000000';
    calcAll();
  }
}

function calcAll() {
  const price = parseFloat(document.getElementById('sale-price').value) || 0;
  const actualFee = parseFloat(document.getElementById('actual-fee').value) || 0;
  const src = gv('g-source');
  const rankKey = session.rankKey || 'bronze';
  const rate = RANK_RATE[rankKey] || 0.65;
  const isPt = src === 'pt';

  // æ³•å®šä¸Šé™ï¼ˆ3%+6ä¸‡å††+æ¶ˆè²»ç¨ï¼‰
  let legalBase = 0;
  if (price <= 2000000) legalBase = price * 0.05;
  else if (price <= 4000000) legalBase = price * 0.04 + 20000;
  else legalBase = price * 0.03 + 60000;
  const legalMax = Math.round(legalBase * 1.1);

  // è¡¨ç¤º
  document.getElementById('disp-price').textContent = price ? 'Â¥' + price.toLocaleString() : 'Â¥â€”';
  document.getElementById('disp-legal-max').textContent = legalMax ? 'Â¥' + legalMax.toLocaleString() : 'Â¥â€”';
  document.getElementById('disp-rate').textContent = Math.round(rate*100) + '%';

  if (actualFee > 0) {
    const feeExTax = Math.round(actualFee / 1.1);
    const agReward = Math.round(feeExTax * rate);
    const withholding = Math.round(agReward * 0.1021);
    const payout = agReward - withholding;
    document.getElementById('disp-ag-reward').textContent = 'Â¥' + agReward.toLocaleString();
    document.getElementById('disp-withholding').textContent = 'Â¥' + withholding.toLocaleString();
    document.getElementById('disp-payout').textContent = 'Â¥' + payout.toLocaleString();

    // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å ±é…¬
    if (isPt) {
      const ptReward = Math.round(feeExTax * 0.25);
      document.getElementById('disp-pt-payout').textContent = 'Â¥' + ptReward.toLocaleString();
    }

    // ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
    const feePts = Math.floor(actualFee / 100000) * (isPt ? 0.5 : 1.0);
    const bonusPts = isPt ? 0.5 : 1.0;
    const totalPts = feePts + bonusPts;
    document.getElementById('pt-fee-pts').textContent = feePts.toFixed(1) + ' pt';
    document.getElementById('pt-total').textContent = totalPts.toFixed(1) + ' pt';
  }
}

function updateTimeline() {
  const fmt = d => d ? new Date(d).toLocaleDateString('ja-JP',{year:'numeric',month:'long',day:'numeric'}) : 'â€”';
  document.getElementById('tl-offer-date').textContent = fmt(document.getElementById('offer-date').value);
  document.getElementById('tl-contract-date').textContent = fmt(document.getElementById('contract-date').value);
  document.getElementById('tl-loan-date').textContent = fmt(document.getElementById('loan-deadline').value);
  document.getElementById('tl-settlement-date').textContent = fmt(document.getElementById('settlement-date').value);
}

function showConfirmModal() {
  const required = [
    ['case-id','Case ID'],['client-name','ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ°å'],
    ['property-name','ç‰©ä»¶åç§°'],['sale-price','å£²è²·ä¾¡æ ¼'],
    ['offer-date','è²·ä»˜å—é ˜æ—¥'],['settlement-date','æ±ºæ¸ˆæ—¥'],
  ];
  for (const [id, label] of required) {
    if (!document.getElementById(id).value.trim()) {
      alert(`ã€Œ${label}ã€ã¯å¿…é ˆé …ç›®ã§ã™ã€‚`);
      document.getElementById(id).focus();
      return;
    }
  }

  const price = parseFloat(document.getElementById('sale-price').value)||0;
  const fee   = parseFloat(document.getElementById('actual-fee').value)||0;
  const settlementDate = document.getElementById('settlement-date').value;
  const ptTotal = document.getElementById('pt-total').textContent;
  const fmt = d => d ? new Date(d).toLocaleDateString('ja-JP') : 'â€”';

  document.getElementById('modal-summary').innerHTML = `
    <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px">
      <span style="color:var(--muted)">Case ID</span><strong>${document.getElementById('case-id').value}</strong>
      <span style="color:var(--muted)">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</span><strong>${document.getElementById('client-name').value}</strong>
      <span style="color:var(--muted)">ç‰©ä»¶åç§°</span><strong>${document.getElementById('property-name').value}</strong>
      <span style="color:var(--muted)">å£²è²·ä¾¡æ ¼</span><strong>Â¥${price.toLocaleString()}</strong>
      <span style="color:var(--muted)">ä»²ä»‹æ‰‹æ•°æ–™</span><strong>Â¥${fee.toLocaleString()}</strong>
      <span style="color:var(--muted)">è²·ä»˜å—é ˜æ—¥</span><strong>${fmt(document.getElementById('offer-date').value)}</strong>
      <span style="color:var(--muted)">æ±ºæ¸ˆæ—¥</span><strong style="color:var(--gold)">${fmt(settlementDate)}</strong>
      <span style="color:var(--muted)">ç²å¾—äºˆå®š pt</span><strong style="color:var(--gold)">${ptTotal}</strong>
    </div>`;

  document.getElementById('modal-overlay').classList.add('show');
}

function submitReport() {
  document.getElementById('modal-btns').classList.add('hidden');
  const wrap = document.getElementById('progress-wrap');
  wrap.classList.remove('hidden');
  const fill = document.getElementById('progress-fill');
  const msg  = document.getElementById('progress-msg');

  const steps = [
    [700, 30,  'â‘  Kintone æ¡ˆä»¶ç™»éŒ²ä¸­...'],
    [600, 60,  'â‘¡ Slack #å£²è²·æ¡ˆä»¶ é€šçŸ¥ä¸­...'],
    [500, 85,  'â‘¢ HQæ‰¿èªãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...'],
    [400, 100, 'âœ… å®Œäº†'],
  ];

  let i = 0;
  function next() {
    if (i >= steps.length) {
      setTimeout(() => {
        document.getElementById('modal-overlay').classList.remove('show');
        document.getElementById('submit-btn').textContent = 'ğŸ“¦ æå‡ºæ¸ˆã¿';
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').style.opacity = '0.5';
        const t = document.getElementById('toast');
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 4000);
      }, 400);
      return;
    }
    const [delay, pct, label] = steps[i++];
    setTimeout(() => {
      fill.style.width = pct + '%';
      msg.textContent = label;
      next();
    }, delay);
  }
  next();
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('show');
  document.getElementById('modal-btns').classList.remove('hidden');
  document.getElementById('progress-wrap').classList.add('hidden');
  document.getElementById('progress-fill').style.width = '0%';
}

function saveDraft() {
  const toast = document.getElementById('toast');
  toast.textContent = 'ğŸ’¾ ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ';
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; toast.textContent = 'âœ… å£²è²·å ±å‘Šæ›¸ã‚’æå‡ºã—ã¾ã—ãŸ â€” HQãƒ»Slackãƒ»Kintoneã«è‡ªå‹•é€šçŸ¥'; }, 2000);
}
</script>
</body>
</html>
