<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ¡ˆä»¶ç®¡ç†ãƒ»ä»‹å…¥ | CORETO HQ</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://hooks.slack.com https://hooks.zapier.com; frame-src 'none'; object-src 'none';">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--bg2:#0c0e18;--card:#0f1119;--card2:#131621;
  --border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--gold2:#e8c96a;
  --blue:#4f9cf9;--green:#34d399;--red:#f87171;
  --orange:#fb923c;--purple:#a78bfa;
  --muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif}
body{display:grid;grid-template-rows:52px 1fr;overflow:hidden}

/* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hdr{background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 20px;gap:16px}
.hdr-logo{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--gold);letter-spacing:4px}
.hdr-sep{color:var(--border2)}
.hdr-title{font-size:12px;font-weight:700;color:var(--blue)}
.hdr-r{margin-left:auto;display:flex;align-items:center;gap:10px}
.hdr-user{font-size:11px;color:var(--sub)}
.hdr-back{font-size:11px;color:var(--muted);text-decoration:none;
  padding:4px 10px;border:1px solid var(--border2);border-radius:7px;transition:.15s}
.hdr-back:hover{color:var(--text);border-color:var(--sub)}

/* â”€â”€ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout{display:grid;grid-template-columns:320px 1fr;height:100%;overflow:hidden}

/* â”€â”€ å·¦ãƒšã‚¤ãƒ³ï¼šæ¡ˆä»¶ãƒªã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.list-pane{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.list-toolbar{padding:12px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:8px}
.search-row{display:flex;gap:6px}
.search-input{flex:1;background:var(--bg);border:1px solid var(--border2);border-radius:8px;
  color:var(--text);font-family:inherit;font-size:11px;padding:7px 10px;outline:none}
.search-input:focus{border-color:var(--blue)}
.filter-row{display:flex;gap:4px;flex-wrap:wrap}
.fchip{font-size:10px;padding:3px 9px;border-radius:10px;cursor:pointer;
  border:1px solid var(--border2);color:var(--sub);background:transparent;
  font-family:inherit;transition:.15s;white-space:nowrap}
.fchip:hover{border-color:var(--sub);color:var(--text)}
.fchip.on{border-color:var(--blue);color:var(--blue);background:rgba(79,156,249,.08)}

.list-count{padding:6px 12px;font-size:10px;color:var(--muted);border-bottom:1px solid var(--border)}
.list-scroll{overflow-y:auto;flex:1}
.case-item{padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:.1s;position:relative}
.case-item:hover{background:rgba(255,255,255,.02)}
.case-item.active{background:rgba(79,156,249,.06);border-right:2px solid var(--blue)}
.case-item.stale::after{content:'';position:absolute;top:10px;right:10px;
  width:6px;height:6px;border-radius:50%;background:var(--red);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.ci-top{display:flex;align-items:center;gap:6px;margin-bottom:3px}
.ci-id{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted)}
.ci-type{font-size:9px;padding:1px 5px;border-radius:4px;font-weight:700}
.type-reLet{background:rgba(79,156,249,.1);color:var(--blue)}
.type-reSale{background:rgba(201,168,76,.1);color:var(--gold)}
.type-sannai{background:rgba(167,139,250,.1);color:var(--purple)}
.type-hr{background:rgba(52,211,153,.1);color:var(--green)}
.ci-name{font-size:12px;font-weight:600;color:var(--text)}
.ci-sub{font-size:10px;color:var(--sub);margin:2px 0}
.ci-foot{display:flex;align-items:center;gap:8px}
.ci-agent{font-size:9px;color:var(--muted)}
.ci-step{font-size:9px;padding:1px 6px;border-radius:4px;background:var(--card2);color:var(--sub)}
.ci-age{font-size:9px;margin-left:auto}
.age-old{color:var(--red)}
.age-mid{color:var(--orange)}
.age-new{color:var(--green)}

/* â”€â”€ å³ãƒšã‚¤ãƒ³ï¼šè©³ç´°/ä»‹å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-pane{overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;color:var(--muted)}
.empty-icon{font-size:48px;margin-bottom:12px}

/* â”€â”€ ã‚«ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:14px}
.ch{display:flex;align-items:center;gap:10px;padding:14px 18px;border-bottom:1px solid var(--border)}
.ch-title{font-size:13px;font-weight:700;color:var(--text)}
.ch-sub{font-size:10px;color:var(--muted);margin-left:auto}
.cb{padding:16px 18px}

/* â”€â”€ æ¡ˆä»¶ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.case-hdr{background:var(--card2);border:1px solid var(--border2);border-radius:14px;padding:18px}
.case-hdr-top{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px}
.case-hdr-id{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:2px}
.case-hdr-name{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--text)}
.case-hdr-sub{font-size:11px;color:var(--sub);margin-top:3px}
.case-hdr-r{margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:6px}

/* â”€â”€ ãƒ¡ã‚¿ã‚°ãƒªãƒƒãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.meta-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.meta-item{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 12px}
.meta-label{font-size:9px;color:var(--muted);font-weight:700;letter-spacing:.5px;margin-bottom:3px;text-transform:uppercase}
.meta-val{font-size:12px;font-weight:600;color:var(--text)}

/* â”€â”€ ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.step-bar{display:flex;align-items:center;margin-bottom:4px}
.step-node{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;cursor:pointer}
.step-node:not(:last-child)::after{content:'';position:absolute;top:11px;left:50%;width:100%;
  height:1px;background:var(--border2);z-index:0}
.step-node.done::after{background:var(--green)}
.step-node.active::after{background:linear-gradient(90deg,var(--gold),var(--border2))}
.step-circle{width:22px;height:22px;border-radius:50%;border:2px solid var(--border2);
  display:flex;align-items:center;justify-content:center;
  background:var(--bg);font-size:10px;z-index:1;transition:.2s}
.step-node.done .step-circle{background:var(--green);border-color:var(--green);color:#0a0c10;font-size:9px}
.step-node.active .step-circle{background:var(--gold);border-color:var(--gold);color:#0a0c10;box-shadow:0 0 10px rgba(201,168,76,.4)}
.step-node.future .step-circle{color:var(--muted)}
.step-lbl{font-size:7px;margin-top:3px;font-weight:700;letter-spacing:.3px;color:var(--muted);white-space:nowrap}
.step-node.done .step-lbl{color:var(--green)}
.step-node.active .step-lbl{color:var(--gold)}

/* â”€â”€ ãƒãƒƒã‚¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{display:inline-flex;align-items:center;font-size:10px;font-weight:700;
  padding:2px 8px;border-radius:8px;white-space:nowrap}
.b-blue  {background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.25)}
.b-gold  {background:rgba(201,168,76,.12);color:var(--gold);border:1px solid rgba(201,168,76,.25)}
.b-green {background:rgba(52,211,153,.1);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.b-red   {background:rgba(248,113,113,.1);color:var(--red);border:1px solid rgba(248,113,113,.2)}
.b-orange{background:rgba(251,146,60,.1);color:var(--orange);border:1px solid rgba(251,146,60,.2)}
.b-purple{background:rgba(167,139,250,.1);color:var(--purple);border:1px solid rgba(167,139,250,.2)}
.b-muted {background:rgba(74,82,112,.15);color:var(--sub);border:1px solid var(--border2)}

/* â”€â”€ ãƒœã‚¿ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;
  border-radius:8px;border:none;cursor:pointer;font-size:11px;font-weight:700;
  font-family:inherit;transition:.15s;white-space:nowrap}
.btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{filter:brightness(1.1)}
.btn-gold{background:var(--gold);color:#0a0c10}.btn-gold:hover{background:var(--gold2)}
.btn-ghost{background:transparent;color:var(--sub);border:1px solid var(--border2)}
.btn-ghost:hover{color:var(--text);border-color:var(--sub)}
.btn-danger{background:rgba(248,113,113,.1);color:var(--red);border:1px solid rgba(248,113,113,.25)}
.btn-danger:hover{background:rgba(248,113,113,.2)}
.btn-orange{background:rgba(251,146,60,.1);color:var(--orange);border:1px solid rgba(251,146,60,.25)}
.btn-sm{padding:4px 10px;font-size:10px}
.btn-xs{padding:3px 8px;font-size:10px;border-radius:6px}

/* â”€â”€ ä»‹å…¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚°ãƒªãƒƒãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.action-btn{background:var(--card2);border:1px solid var(--border2);border-radius:10px;
  padding:12px 14px;cursor:pointer;text-align:left;transition:.15s;font-family:inherit}
.action-btn:hover{border-color:var(--blue);background:rgba(79,156,249,.04)}
.action-btn.danger:hover{border-color:var(--red);background:rgba(248,113,113,.04)}
.action-btn.gold:hover{border-color:var(--gold);background:rgba(201,168,76,.04)}
.action-btn .ab-icon{font-size:18px;margin-bottom:6px}
.action-btn .ab-label{font-size:11px;font-weight:700;color:var(--text)}
.action-btn .ab-desc{font-size:9px;color:var(--muted);margin-top:2px;line-height:1.5}

/* â”€â”€ å±¥æ­´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hist-item{display:flex;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:11px}
.hist-item:last-child{border-bottom:none}
.hist-dot{width:7px;height:7px;border-radius:50%;background:var(--border2);flex-shrink:0;margin-top:5px}
.hist-dot.hq{background:var(--blue)}
.hist-text{color:var(--sub);line-height:1.6;flex:1}
.hist-text strong{color:var(--text)}

/* â”€â”€ ãƒ•ã‚©ãƒ¼ãƒ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input,select,textarea{background:var(--bg);border:1px solid var(--border2);border-radius:8px;
  color:var(--text);font-family:inherit;font-size:12px;padding:8px 12px;
  outline:none;transition:border-color .15s;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--blue)}
.fg{margin-bottom:12px}
.fg label{display:block;font-size:10px;font-weight:700;color:var(--sub);margin-bottom:5px}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

/* â”€â”€ ã‚¢ãƒ©ãƒ¼ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert{border-radius:10px;padding:10px 14px;font-size:11px;line-height:1.8;margin-bottom:12px}
.al-warn{background:rgba(251,146,60,.07);border:1px solid rgba(251,146,60,.2);color:var(--orange)}
.al-info{background:rgba(79,156,249,.07);border:1px solid rgba(79,156,249,.2);color:var(--blue)}
.al-danger{background:rgba(248,113,113,.07);border:1px solid rgba(248,113,113,.2);color:var(--red)}
.al-success{background:rgba(52,211,153,.07);border:1px solid rgba(52,211,153,.2);color:var(--green)}

/* â”€â”€ ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);
  z-index:900;display:none;align-items:center;justify-content:center;padding:20px}
.modal-bg.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border2);border-radius:16px;
  width:520px;max-width:100%;max-height:90vh;overflow-y:auto;
  box-shadow:0 24px 60px rgba(0,0,0,.6)}
.m-hdr{display:flex;align-items:center;justify-content:space-between;
  padding:18px 22px;border-bottom:1px solid var(--border)}
.m-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;color:var(--text)}
.m-close{background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;line-height:1}
.m-close:hover{color:var(--text)}
.m-body{padding:20px 22px}
.m-footer{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}

/* â”€â”€ ãƒˆãƒ¼ã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{position:fixed;bottom:24px;right:24px;background:var(--card2);
  border:1px solid var(--border2);border-radius:10px;padding:10px 16px;
  font-size:12px;color:var(--text);opacity:0;transition:opacity .3s;z-index:999;pointer-events:none}
.toast.show{opacity:1}

/* â”€â”€ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}

/* â”€â”€ ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbl{width:100%;border-collapse:collapse;font-size:11px}
.tbl th{font-size:9px;color:var(--muted);padding:5px 8px;text-align:left;
  border-bottom:1px solid var(--border);font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.tbl td{padding:8px 8px;border-bottom:1px solid var(--border);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
</style>
</head>
<body>

<div class="hdr">
  <span class="hdr-logo">CORETO</span>
  <span class="hdr-sep">|</span>
  <span class="hdr-title">æ¡ˆä»¶ç®¡ç†ãƒ»ä»‹å…¥</span>
  <div class="hdr-r">
    <span class="hdr-user" id="hdr-user">â€”â€”</span>
    <a href="coreto-hub.html" class="hdr-back">â† ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</a>
  </div>
</div>

<div class="layout">
  <!-- å·¦ãƒšã‚¤ãƒ³: æ¡ˆä»¶ãƒªã‚¹ãƒˆ -->
  <div class="list-pane">
    <!-- çµ±è¨ˆãƒãƒƒãƒ— -->
    <div class="stats-bar" id="stats-bar"></div>

    <div class="list-toolbar">
      <div class="search-row">
        <input class="search-input" id="search" placeholder="IDãƒ»åå‰ãƒ»ç‰©ä»¶ã§æ¤œç´¢..." oninput="applyFilter()">
        <button class="btn btn-gold btn-sm" onclick="openNewCaseModal()" style="flex-shrink:0">ï¼‹ æ–°è¦</button>
      </div>
      <div class="filter-row">
        <button class="fchip on" id="f-all" onclick="setTypeFilter('all',this)">ã™ã¹ã¦</button>
        <button class="fchip" id="f-reLet"  onclick="setTypeFilter('reLet',this)" >ğŸ  è³ƒè²¸</button>
        <button class="fchip" id="f-reSale" onclick="setTypeFilter('reSale',this)">ğŸ¢ å£²è²·</button>
        <button class="fchip" id="f-sannai" onclick="setTypeFilter('sannai',this)">ğŸ”„ ä¸‰ç‚º</button>
        <button class="fchip" id="f-hr"     onclick="setTypeFilter('hr',this)"    >ğŸ‘¥ äººæ</button>
        <button class="fchip" id="f-stale"  onclick="setTypeFilter('stale',this)" >âš ï¸ åœæ»</button>
        <button class="fchip" id="f-cancel" onclick="setTypeFilter('cancel',this)">ğŸš« å–æ¶ˆ</button>
        <button class="fchip" id="f-priority" onclick="setTypeFilter('priority',this)">ğŸ”¥ å„ªå…ˆ</button>
      </div>
    </div>

    <!-- ã‚½ãƒ¼ãƒˆ -->
    <div class="sort-row">
      <span class="sort-lbl">ä¸¦æ›¿:</span>
      <button class="sort-btn on" id="sort-age"  onclick="setSort('age',this)">æ›´æ–°æ—¥</button>
      <button class="sort-btn" id="sort-type" onclick="setSort('type',this)">ç¨®åˆ¥</button>
      <button class="sort-btn" id="sort-step" onclick="setSort('step',this)">ã‚¹ãƒ†ãƒƒãƒ—</button>
      <button class="sort-btn" id="sort-agent" onclick="setSort('agent',this)">æ‹…å½“è€…</button>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button class="sort-btn" onclick="selectAll()">å…¨é¸æŠ</button>
        <button class="sort-btn" onclick="csvExport()">CSVå‡ºåŠ›</button>
      </div>
    </div>

    <!-- ä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
    <div class="bulk-bar" id="bulk-bar">
      <span class="bulk-count" id="bulk-count">0ä»¶é¸æŠä¸­</span>
      <button class="btn btn-primary btn-xs" onclick="bulkStepModal()">ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´</button>
      <button class="btn btn-ghost btn-xs" onclick="bulkAgentModal()">æ‹…å½“è€…å¤‰æ›´</button>
      <button class="btn btn-danger btn-xs" onclick="bulkCancelModal()">ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-ghost btn-xs" style="margin-left:auto" onclick="clearSelection()">âœ• é¸æŠè§£é™¤</button>
    </div>

    <div class="list-count" id="list-count">â€”ä»¶</div>
    <div class="list-scroll" id="list-scroll"></div>
  </div>

  <!-- å³ãƒšã‚¤ãƒ³: è©³ç´°ãƒ»ä»‹å…¥ -->
  <div class="detail-pane" id="detail-pane">
    <div class="empty-state">
      <div class="empty-icon">ğŸ“‹</div>
      <div style="font-size:13px;font-weight:700;color:var(--sub);margin-bottom:6px">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div style="font-size:11px;color:var(--muted)">å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ä»‹å…¥ã™ã‚‹æ¡ˆä»¶ã‚’é¸æŠã—ã¾ã™</div>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <div class="m-hdr">
      <span class="m-title" id="m-title"></span>
      <button class="m-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="m-body" id="m-body"></div>
    <div class="m-footer" id="m-footer"></div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script src="db.js"></script>
<script>
// â•â• AUTH GUARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  var s = null;
  try{ s = JSON.parse(sessionStorage.getItem('coreto_session')||'null'); }catch(e){}
  if(!s||!s.userId||!s.sessionToken||s.sessionToken.length!==64){
    sessionStorage.removeItem('coreto_session');
    location.replace('coreto-login-hq.html'); return;
  }
  var la = new Date(s.loginAt).getTime();
  if(isNaN(la)||(Date.now()-la)>28800000){
    sessionStorage.removeItem('coreto_session');
    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚');
    location.replace('coreto-login-hq.html'); return;
  }
  if(s.type!=='hq'){ location.replace('coreto-login.html'); return; }
  window._SESSION = s;
})();

const SESSION = window._SESSION||{};
document.getElementById('hdr-user').textContent = SESSION.name||SESSION.userId||'â€”â€”';

// â•â• ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function today(){ return new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'}); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function toast(msg){
  var t=document.getElementById('toast');
  t.textContent=msg; t.className='toast show';
  setTimeout(function(){ t.className='toast'; },3000);
}
function notifySlack(msg){
  var wh = (typeof window.SLACK_CONFIG!=='undefined'&&window.SLACK_CONFIG)
    ? window.SLACK_CONFIG.GENERAL : null;
  if(!wh) return;
  fetch(wh,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({text:'[HQä»‹å…¥] '+msg})}).catch(function(){});
}
function saveHqLog(action, detail){
  var logs = [];
  try{ logs=JSON.parse(localStorage.getItem('coreto_hq_case_log')||'[]'); }catch(e){}
  logs.unshift({action,detail,by:SESSION.name||SESSION.userId,at:new Date().toISOString()});
  if(logs.length>500) logs=logs.slice(0,500);
  localStorage.setItem('coreto_hq_case_log',JSON.stringify(logs));
}

// â•â• ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒã‚¹ã‚¿ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AGENTS_MASTER = (typeof USERS!=='undefined') ? USERS : {};
function agentName(id){
  if(!id) return 'â€”â€”';
  if(AGENTS_MASTER[id]) return AGENTS_MASTER[id].name;
  var map={'10008':'ä½è—¤ èŠ±å­','10012':'å±±ç”° èª ','10023':'éˆ´æœ¨ å¥å¤ª','10041':'æ¸¡è¾º éš†',
           '20005':'ç”°ä¸­ ç¾ç©‚','20010':'æ¾æœ¬ ç”±ç¾','00001':'HQ çµ±æ‹¬','00347':'HQãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼','00891':'HQã‚¹ã‚¿ãƒƒãƒ•'};
  return map[id]||id;
}

// â•â• ã‚¹ãƒ†ãƒƒãƒ—å®šç¾© â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STEP_DEFS = {
  reLet:  [{id:'naiken',label:'å†…è¦‹'},{id:'apply',label:'ç”³è¾¼'},{id:'screening',label:'å¯©æŸ»'},
           {id:'invoice',label:'è«‹æ±‚æ›¸'},{id:'prekey',label:'é‡èª¬ãƒ»å…¥é‡‘'},{id:'key',label:'éµæ¸¡ã—'},
           {id:'done',label:'å®Œäº†'},{id:'cancel',label:'å–æ¶ˆ'}],
  reSale: [{id:'naiken',label:'å†…è¦‹'},{id:'offer',label:'è²·ä»˜'},{id:'invoice',label:'è«‹æ±‚æ›¸'},
           {id:'contract',label:'å¥‘ç´„'},{id:'settlement',label:'æ±ºæ¸ˆ'},
           {id:'done',label:'å®Œäº†'},{id:'cancel',label:'å–æ¶ˆ'}],
  sannai: [{id:'naiken',label:'å†…è¦‹'},{id:'verify',label:'æ¥­è€…ç¢ºèª'},{id:'offer',label:'è²·ä»˜'},
           {id:'invoice',label:'è«‹æ±‚æ›¸'},{id:'contract',label:'å¥‘ç´„'},{id:'settlement',label:'æ±ºæ¸ˆ'},
           {id:'done',label:'å®Œäº†'},{id:'cancel',label:'å–æ¶ˆ'}],
  hr:     [{id:'screening',label:'æ›¸é¡é¸è€ƒ'},{id:'job-check',label:'æ±‚äººç¢ºèª'},
           {id:'interview',label:'é¢æ¥èª¿æ•´'},{id:'offer',label:'å†…å®š'},{id:'onboard',label:'å…¥ç¤¾'},
           {id:'zaiki',label:'åœ¨ç±ç¢ºèª'},{id:'pay2',label:'ç¬¬2å›å ±é…¬'},
           {id:'done',label:'å®Œäº†'},{id:'cancel',label:'å–æ¶ˆ'}],
};
const TYPE_LABELS = {reLet:'è³ƒè²¸',reSale:'å£²è²·',sannai:'ä¸‰ç‚º',hr:'äººæç´¹ä»‹'};
const STEP_LABEL_MAP = {};
Object.values(STEP_DEFS).flat().forEach(function(s){ STEP_LABEL_MAP[s.id]=s.label; });

// â•â• CASESãƒ‡ãƒ¼ã‚¿ï¼ˆpipeline.htmlã¨å…±æœ‰ or ç‹¬ç«‹ãƒ‡ãƒ¢ï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æœ¬ç•ª: localStorage 'coreto_cases' ã‹ã‚‰èª­ã¿è¾¼ã‚€
// ãƒ‡ãƒ¢: pipeline.htmlã¨åŒä¸€ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ã„ã‚Œã°localStorageã‚’å…±æœ‰
// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
const DEMO_CASES = [
  {id:'R042857',name:'ç”°ä¸­ é›„ä»‹',type:'reLet',corp:false,agent:'10012',
   sub:'æ¸‹è°·åŒº 2LDK ã€œÂ¥220,000',step:'screening',age:3,stale:false,
   apps:[{id:'A001',prop:'æ¸‹è°·åŒºæ¡œä¸˜ 2LDK',status:'rejected'},{id:'A002',prop:'æ¸‹è°·åŒºä»£ã€…æœ¨ 2LDK',status:'reviewing'}],
   dates:{naiken:'2026-02-17'},hist:['2/17 å†…è¦‹å®Œäº†','2/18 ç”³è¾¼â†’å¯©æŸ»è½ã¡','2/21 åˆ¥ç‰©ä»¶ã§å†ç”³è¾¼']},
  {id:'R039102',name:'æœ¨æ‘ å½©é¦™',type:'reLet',corp:false,agent:'10012',
   sub:'å“å·åŒº 1K ã€œÂ¥85,000',step:'screening',age:1,stale:false,
   apps:[{id:'A010',prop:'å“å·åŒºå¤§å´ 1K',status:'reviewing'},{id:'A011',prop:'å“å·åŒºäº”åç”° 1K',status:'reviewing'}],
   dates:{naiken:'2026-02-20'},hist:['2/20 å†…è¦‹å®Œäº†','2/21 2ç‰©ä»¶åŒæ™‚ç”³è¾¼']},
  {id:'R041003',name:'æ–è—¤ äº®',type:'reLet',corp:false,agent:'10023',
   sub:'æ–°å®¿åŒº 1LDK ã€œÂ¥130,000',step:'naiken',age:9,stale:true,
   apps:[],dates:{},hist:['2/11 å•åˆã›å—ä¿¡']},
  {id:'R045500',name:'ä¼Šè—¤ ç¿”å¤ª',type:'reLet',corp:false,agent:'10012',
   sub:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK Â¥155,000',step:'invoice',age:2,stale:false,
   apps:[{id:'A020',prop:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK',status:'approved'}],
   dates:{naiken:'2026-02-14',approved:'2026-02-17'},hist:['2/14 å†…è¦‹','2/15 ç”³è¾¼','2/17 å¯©æŸ»é€šé']},
  {id:'R038291',name:'æ¾æœ¬ æµ©äºŒ',type:'reLet',corp:false,agent:'10012',
   sub:'æ¸‹è°·åŒº 2K Â¥170,000',step:'prekey',age:0,stale:false,
   apps:[{id:'A040',prop:'æ¸‹è°·åŒº 2K',status:'approved'}],
   dates:{naiken:'2026-02-07',approved:'2026-02-12'},
   taskDone:{paid:true,itsetsu:false},hist:['2/07 å†…è¦‹','2/08 ç”³è¾¼','2/12 å¯©æŸ»é€šé','2/17 å…¥é‡‘ç¢ºèª']},
  {id:'R046001',name:'åŠ è—¤ ç¾å’²',type:'reLet',corp:false,agent:'10008',
   sub:'æ¸¯åŒºå—é’å±± 1LDK Â¥180,000',step:'cancel',age:0,stale:false,
   apps:[],dates:{naiken:'2026-02-09'},hist:['2/09 å†…è¦‹','2/10 ç”³è¾¼','2/21 ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæœ¬äººéƒ½åˆï¼‰']},
  {id:'S819204',name:'å‰ç”° å¤§è¼”',type:'reSale',corp:false,agent:'10008',
   sub:'ç›®é»’åŒº æˆ¸å»ºã¦ Â¥32,000,000',step:'contract',age:5,stale:false,
   salePrice:32000000,apps:[],dates:{naiken:'2026-02-10',offer:'2026-02-15',contract:'2026-02-20'},
   hist:['2/15 è²·ä»˜å—é ˜','2/20 å£²è²·å¥‘ç´„ç· çµ']},
  {id:'S291047',name:'ç”°ä¸­ ç¾å’²',type:'reSale',corp:false,agent:'10012',
   sub:'æ¸¯åŒº ã‚¿ãƒ¯ãƒãƒ³ Â¥65,000,000',step:'offer',age:2,stale:false,
   salePrice:65000000,apps:[],dates:{offer:'2026-02-21'},hist:['2/21 å†…è¦‹ãªã—ãƒ»è²·ä»˜æå‡º']},
  {id:'N001001',name:'æ ªå¼ä¼šç¤¾ã‚¢ãƒ«ãƒ•ã‚¡ä¸å‹•ç”£',type:'sannai',corp:true,contactName:'å±±ç”° èª²é•·',agent:'10008',
   sub:'ä¸–ç”°è°·åŒº ä¸€æ£Ÿãƒãƒ³ã‚·ãƒ§ãƒ³ Â¥180,000,000',step:'verify',age:1,stale:false,
   salePrice:180000000,apps:[],dates:{naiken:'2026-02-21'},
   hist:['2/21 å†…è¦‹å®Œäº†','2/22 æ¥­è€…ç¢ºèªä¾é ¼é€ä¿¡']},
  {id:'H00341',name:'éˆ´æœ¨ å¥ä¸€',type:'hr',corp:false,agent:'20005',
   sub:'ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ / å¹´å600ä¸‡ã€œ',step:'apply',age:5,stale:false,apps:[],dates:{},
   hist:['2/17 æ¡ˆä»¶ç™»éŒ²','2/18 3ç¤¾ã«æ›¸é¡æå‡º','2/21 2æ¬¡é¢æ¥é€šé']},
  {id:'H00389',name:'ç”°æ‘ çœŸç”±',type:'hr',corp:false,agent:'20005',
   sub:'Webãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ / å¹´å450ä¸‡ã€œ',step:'contract',age:2,stale:false,apps:[],dates:{},
   hist:['2/10 æ¡ˆä»¶ç™»éŒ²','2/20 å†…å®š','2/22 å†…å®šæ‰¿è«¾']},
];

// CASESã‚’localStorageã‹ã‚‰èª­ã‚€ï¼ˆpipeline.htmlã¨å…±æœ‰ï¼‰ã¾ãŸã¯ç‹¬ç«‹ãƒ‡ãƒ¢
function loadCases(){
  try{
    var raw = localStorage.getItem('coreto_cases');
    if(raw){ var parsed=JSON.parse(raw); if(parsed&&parsed.length) return parsed; }
  }catch(e){}
  return DEMO_CASES;
}
function saveCases(cases){
  try{ localStorage.setItem('coreto_cases',JSON.stringify(cases)); }catch(e){}
}

var CASES = loadCases();
var currentId = null;
var typeFilter = 'all';

// â•â• ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ãƒªã‚¹ãƒˆæç”» â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTypeFilter(type, el){
  typeFilter = type;
  document.querySelectorAll('.fchip').forEach(function(c){ c.classList.remove('on'); });
  el.classList.add('on');
  applyFilter();
}
function applyFilter(){
  var q = document.getElementById('search').value.trim().toLowerCase();
  var filtered = CASES.filter(function(c){
    if(typeFilter==='stale'    && !c.stale) return false;
    if(typeFilter==='cancel'   && c.step!=='cancel') return false;
    if(typeFilter==='done'     && c.step!=='done') return false;
    if(typeFilter==='active'   && (c.step==='cancel'||c.step==='done')) return false;
    if(typeFilter==='priority' && !c.hqPriority) return false;
    if(typeFilter!=='all'&&typeFilter!=='stale'&&typeFilter!=='cancel'&&typeFilter!=='done'
       &&typeFilter!=='active'&&typeFilter!=='priority' && c.type!==typeFilter) return false;
    if(q && !(c.id.toLowerCase().includes(q)||c.name.toLowerCase().includes(q)
              ||(c.sub||'').toLowerCase().includes(q)
              ||agentName(c.agent).toLowerCase().includes(q))) return false;
    return true;
  });
  renderList(sortCases(filtered));
}
function renderList(cases){
  document.getElementById('list-count').textContent = cases.length+'ä»¶';
  var html = '';
  cases.forEach(function(c){
    var stepLabel = STEP_LABEL_MAP[c.step]||c.step;
    var ageClass = c.age>=7?'age-old':c.age>=3?'age-mid':'age-new';
    var typeLabel = TYPE_LABELS[c.type]||c.type;
    html += '<div class="case-item'+(c.stale?' stale':'')+(currentId===c.id?' active':'')+'" onclick="openCase(\''+c.id+'\')">'
      +'<div class="ci-top">'
      +'<span class="ci-id">'+esc(c.id)+'</span>'
      +'<span class="ci-type type-'+c.type+'">'+typeLabel+'</span>'
      +(c.corp?'<span class="badge b-purple" style="font-size:8px;padding:1px 4px">æ³•äºº</span>':'')
      +'</div>'
      +'<div class="ci-name">'+esc(c.name)+'</div>'
      +'<div class="ci-sub">'+esc(c.sub||'')+'</div>'
      +'<div class="ci-foot">'
      +'<span class="ci-agent">'+esc(agentName(c.agent))+'</span>'
      +'<span class="ci-step">'+esc(stepLabel)+'</span>'
      +'<span class="ci-age '+ageClass+'">'+(c.age===0?'æœ¬æ—¥':c.age+'æ—¥å‰')+'</span>'
      +'</div></div>';
  });
  document.getElementById('list-scroll').innerHTML = html||'<div style="padding:24px;text-align:center;font-size:11px;color:var(--muted)">è©²å½“æ¡ˆä»¶ãªã—</div>';
}

// â•â• è©³ç´°ãƒ‘ãƒãƒ« â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCase(id){
  currentId = id;
  applyFilter(); // ãƒªã‚¹ãƒˆã®activeã‚’æ›´æ–°
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  if(!c.dates) c.dates={};
  if(!c.hist)  c.hist=[];
  renderDetail(c);
}

function renderDetail(c){
  var steps = STEP_DEFS[c.type]||[];
  var curIdx = steps.findIndex(function(s){ return s.id===c.step; });

  // ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒ¼
  var stepBar = '<div class="step-bar">';
  steps.filter(function(s){ return s.id!=='cancel'; }).forEach(function(s,i){
    var isDone   = i < curIdx;
    var isActive = s.id === c.step;
    var cls = isDone?'done':isActive?'active':'future';
    stepBar += '<div class="step-node '+cls+'">'
      +'<div class="step-circle">'+(isDone?'âœ“':i+1)+'</div>'
      +'<div class="step-lbl">'+s.label+'</div></div>';
  });
  stepBar += '</div>';

  // ç¨®åˆ¥ãƒãƒƒã‚¸
  var typeBadge = {reLet:'b-blue',reSale:'b-gold',sannai:'b-purple',hr:'b-green'}[c.type]||'b-muted';
  var stepBadge = c.step==='cancel'?'<span class="badge b-red">å–æ¶ˆ</span>'
    :c.step==='done'?'<span class="badge b-green">å®Œäº†</span>'
    :'<span class="badge b-blue">'+esc(STEP_LABEL_MAP[c.step]||c.step)+'</span>';

  // HQãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¡¨ç¤º
  var hqMemoHtml = '';
  if(c.hqMemo){
    hqMemoHtml = '<div class="alert al-info" style="margin-top:10px">ğŸ“Œ HQãƒ¡ãƒ¢: '+esc(c.hqMemo)+'</div>';
  }
  if(c.stale){
    hqMemoHtml += '<div class="alert al-warn" style="margin-top:8px">âš ï¸ åœæ»æ¡ˆä»¶ï¼šæœ€çµ‚æ›´æ–°ã‹ã‚‰'+c.age+'æ—¥ãŒçµŒéã—ã¦ã„ã¾ã™</div>';
  }

  // ç”³è¾¼ä¸€è¦§ï¼ˆè³ƒè²¸ç³»ï¼‰
  var appsHtml = '';
  if(c.apps&&c.apps.length){
    appsHtml = '<div class="card"><div class="ch"><span class="ch-title">ğŸ“‹ ç”³è¾¼ä¸€è¦§</span></div><div class="cb"><table class="tbl"><thead><tr><th>ç‰©ä»¶</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>';
    c.apps.forEach(function(a){
      var aBadge = a.status==='approved'?'<span class="badge b-green">é€šé</span>'
        :a.status==='rejected'?'<span class="badge b-red">è½ã¡</span>'
        :'<span class="badge b-orange">å¯©æŸ»ä¸­</span>';
      appsHtml += '<tr><td>'+esc(a.prop||a.id)+'</td><td>'+aBadge+'</td>'
        +'<td><button class="btn btn-ghost btn-xs" onclick="openAppStatusModal(\''+c.id+'\',\''+a.id+'\')">çŠ¶æ…‹å¤‰æ›´</button></td></tr>';
    });
    appsHtml += '</tbody></table></div></div>';
  }

  // å±¥æ­´
  var histHtml = '<div class="card"><div class="ch"><span class="ch-title">ğŸ“ æ¡ˆä»¶å±¥æ­´</span>'
    +'<button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="openAddHistModal(\''+c.id+'\')">+ ãƒ¡ãƒ¢è¿½åŠ </button></div><div class="cb">';
  if(!c.hist||!c.hist.length){
    histHtml += '<div style="text-align:center;color:var(--muted);font-size:11px;padding:16px">å±¥æ­´ãªã—</div>';
  } else {
    c.hist.forEach(function(h){
      var isHq = h.indexOf('[HQ]')!==-1;
      histHtml += '<div class="hist-item"><div class="hist-dot'+(isHq?' hq':'')+'"></div>'
        +'<div class="hist-text">'+esc(h)+'</div></div>';
    });
  }
  histHtml += '</div></div>';

  // ä»‹å…¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  var canGoBack  = curIdx > 0 && c.step!=='cancel';
  var canAdvance = curIdx >= 0 && c.step!=='done' && c.step!=='cancel';
  var isCancelled = c.step==='cancel';

  var actionHtml = '<div class="card"><div class="ch"><span class="ch-title">ğŸ¢ HQä»‹å…¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span></div><div class="cb"><div class="action-grid">';
  actionHtml += '<div class="action-btn" onclick="openStepModal(\''+c.id+'\')">'
    +'<div class="ab-icon">ğŸ”€</div><div class="ab-label">ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´</div>'
    +'<div class="ab-desc">ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¼·åˆ¶çš„ã«å¤‰æ›´ã—ã¾ã™</div></div>';
  actionHtml += '<div class="action-btn" onclick="openAgentModal(\''+c.id+'\')">'
    +'<div class="ab-icon">ğŸ‘¤</div><div class="ab-label">æ‹…å½“è€…å¤‰æ›´</div>'
    +'<div class="ab-desc">æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å¤‰æ›´ã—ã¾ã™</div></div>';
  actionHtml += '<div class="action-btn" onclick="openMemoModal(\''+c.id+'\')">'
    +'<div class="ab-icon">ğŸ“Œ</div><div class="ab-label">HQãƒ¡ãƒ¢</div>'
    +'<div class="ab-desc">HQã‹ã‚‰ã®æ³¨æ„äº‹é …ã‚’è¿½è¨˜ã—ã¾ã™</div></div>';
  actionHtml += '<div class="action-btn" onclick="openFlagModal(\''+c.id+'\')">'
    +'<div class="ab-icon">ğŸš©</div><div class="ab-label">ãƒ•ãƒ©ã‚°è¨­å®š</div>'
    +'<div class="ab-desc">åœæ»ãƒ»è¦æ³¨æ„ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¾ã™</div></div>';
  actionHtml += '<div class="action-btn" onclick="openEditModal(\''+c.id+'\')">'
    +'<div class="ab-icon">âœï¸</div><div class="ab-label">æ¡ˆä»¶æƒ…å ±ç·¨é›†</div>'
    +'<div class="ab-desc">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåãƒ»ç‰©ä»¶æƒ…å ±ãªã©ã‚’ä¿®æ­£ã—ã¾ã™</div></div>';
  if(!isCancelled){
    actionHtml += '<div class="action-btn danger" onclick="openCancelModal(\''+c.id+'\')">'
      +'<div class="ab-icon">ğŸš«</div><div class="ab-label">æ¡ˆä»¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>'
      +'<div class="ab-desc">æ¡ˆä»¶ã‚’å–æ¶ˆã«å¤‰æ›´ã—ã¾ã™</div></div>';
  } else {
    actionHtml += '<div class="action-btn gold" onclick="restoreCase(\''+c.id+'\')">'
      +'<div class="ab-icon">ğŸ”„</div><div class="ab-label">æ¡ˆä»¶å¾©æ´»</div>'
      +'<div class="ab-desc">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’å–ã‚Šæ¶ˆã—ã¦å†é–‹ã—ã¾ã™</div></div>';
  }
  actionHtml += '</div></div></div>';

  document.getElementById('detail-pane').innerHTML =
    // æ¡ˆä»¶ãƒ˜ãƒƒãƒ€ãƒ¼
    '<div class="case-hdr">'
      +'<div class="case-hdr-top">'
        +'<div>'
          +'<div class="case-hdr-id">'+esc(c.id)+'</div>'
          +'<div class="case-hdr-name">'+esc(c.name)+(c.corp?'<span class="badge b-purple" style="font-size:10px;margin-left:8px">æ³•äºº</span>':'')+'</div>'
          +'<div class="case-hdr-sub">'+esc(c.sub||'')+(c.contactName?' â€” æ‹…å½“: '+esc(c.contactName):'')+'</div>'
        +'</div>'
        +'<div class="case-hdr-r">'
          +'<span class="badge '+typeBadge+'">'+esc(TYPE_LABELS[c.type]||c.type)+'</span>'
          +stepBadge
        +'</div>'
      +'</div>'
      +stepBar
      +hqMemoHtml
    +'</div>'
    // ãƒ¡ã‚¿æƒ…å ±
    +'<div class="meta-grid">'
      +metaItem('æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ', agentName(c.agent))
      +metaItem('æœ€çµ‚æ›´æ–°', c.age===0?'æœ¬æ—¥':c.age+'æ—¥å‰')
      +metaItem('æ¡ˆä»¶ç¨®åˆ¥', TYPE_LABELS[c.type]||c.type)
      +(c.salePrice?metaItem('ç‰©ä»¶ä¾¡æ ¼','Â¥'+c.salePrice.toLocaleString()):'')
      +metaItem('ç”³è¾¼æ•°', (c.apps&&c.apps.length||0)+'ä»¶')
      +metaItem('ã‚¹ãƒ†ãƒƒãƒ—', STEP_LABEL_MAP[c.step]||c.step)
    +'</div>'
    // ä»‹å…¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    +actionHtml
    // ç”³è¾¼ä¸€è¦§
    +appsHtml
    // å±¥æ­´
    +histHtml;
}

function metaItem(label, val){
  return '<div class="meta-item"><div class="meta-label">'+label+'</div><div class="meta-val">'+esc(String(val||'â€”â€”'))+'</div></div>';
}

// â•â• ä»‹å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â‘  ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´
function openStepModal(id){
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  var steps = STEP_DEFS[c.type]||[];
  var opts = steps.map(function(s){
    var sel = s.id===c.step?' selected':'';
    return '<option value="'+s.id+'"'+sel+'>'+s.label+'</option>';
  }).join('');
  openModal('ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´',
    '<div class="alert al-warn">âš ï¸ HQã«ã‚ˆã‚‹å¼·åˆ¶çš„ãªã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´ã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚</div>'
    +'<div style="background:var(--bg);border:1px solid var(--border2);border-radius:10px;padding:12px;margin-bottom:14px;font-size:11px">'
    +'ç¾åœ¨: <span class="badge b-blue">'+esc(STEP_LABEL_MAP[c.step]||c.step)+'</span></div>'
    +'<div class="fg"><label>å¤‰æ›´å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—</label><select id="m-step">'+opts+'</select></div>'
    +'<div class="fg"><label>å¤‰æ›´ç†ç”±</label><textarea id="m-reason" rows="2" placeholder="ç†ç”±ã‚’å…¥åŠ›ï¼ˆSlacké€šçŸ¥ã«å«ã¾ã‚Œã¾ã™ï¼‰"></textarea></div>',
    [{label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'ğŸ”€ ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¤‰æ›´',cls:'btn-primary',fn:'execStepChange("'+id+'")'}]
  );
}
function execStepChange(id){
  var newStep = document.getElementById('m-step').value;
  var reason  = document.getElementById('m-reason').value;
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  var prev = STEP_LABEL_MAP[c.step]||c.step;
  c.step = newStep;
  c.age  = 0;
  var note = today()+' [HQ] ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´: '+prev+' â†’ '+(STEP_LABEL_MAP[newStep]||newStep)+(reason?' ç†ç”±: '+reason:'');
  c.hist.unshift(note);
  saveCases(CASES);
  saveHqLog('ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´', c.id+' '+prev+'â†’'+(STEP_LABEL_MAP[newStep]||newStep));
  notifySlack(note+' ('+c.id+' '+c.name+')');
  closeModal();
  toast('âœ… ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
  renderDetail(c);
  applyFilter();
}

// â‘¡ æ‹…å½“è€…å¤‰æ›´
function openAgentModal(id){
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  var agentIds = ['10008','10012','10023','10041','20005','20010','00001','00347','00891'];
  var opts = agentIds.map(function(aid){
    var sel = aid===c.agent?' selected':'';
    return '<option value="'+aid+'"'+sel+'>'+agentName(aid)+'ï¼ˆ'+aid+'ï¼‰</option>';
  }).join('');
  openModal('æ‹…å½“è€…å¤‰æ›´',
    '<div style="background:var(--bg);border:1px solid var(--border2);border-radius:10px;padding:12px;margin-bottom:14px;font-size:11px">'
    +'ç¾åœ¨ã®æ‹…å½“: <strong>'+esc(agentName(c.agent))+'ï¼ˆ'+esc(c.agent)+'ï¼‰</strong></div>'
    +'<div class="fg"><label>æ–°ã—ã„æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</label><select id="m-agent">'+opts+'</select></div>'
    +'<div class="fg"><label>å¤‰æ›´ç†ç”±</label><textarea id="m-reason" rows="2" placeholder="ç†ç”±ã‚’å…¥åŠ›"></textarea></div>',
    [{label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'ğŸ‘¤ æ‹…å½“è€…ã‚’å¤‰æ›´',cls:'btn-primary',fn:'execAgentChange("'+id+'")'}]
  );
}
function execAgentChange(id){
  var newAgent = document.getElementById('m-agent').value;
  var reason   = document.getElementById('m-reason').value;
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  var prev = agentName(c.agent);
  c.agent = newAgent;
  var note = today()+' [HQ] æ‹…å½“å¤‰æ›´: '+prev+' â†’ '+agentName(newAgent)+(reason?' ç†ç”±: '+reason:'');
  c.hist.unshift(note);
  saveCases(CASES);
  saveHqLog('æ‹…å½“è€…å¤‰æ›´', c.id+' '+prev+'â†’'+agentName(newAgent));
  notifySlack(note+' ('+c.id+' '+c.name+')');
  closeModal();
  toast('âœ… æ‹…å½“è€…ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
  renderDetail(c);
  applyFilter();
}

// â‘¢ HQãƒ¡ãƒ¢
function openMemoModal(id){
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  openModal('HQãƒ¡ãƒ¢è¨­å®š',
    '<div class="fg"><label>ãƒ¡ãƒ¢å†…å®¹ï¼ˆæ¡ˆä»¶è©³ç´°ãƒ‘ãƒãƒ«ã®ä¸Šéƒ¨ã«å¸¸æ™‚è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</label>'
    +'<textarea id="m-memo" rows="3" placeholder="ä¾‹: ä¿è¨¼ä¼šç¤¾å¯©æŸ»ã«æ³¨æ„ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé€£çµ¡ã¯åˆå¾Œã®ã¿ã€‚">'+esc(c.hqMemo||'')+'</textarea></div>',
    [{label:'ã‚¯ãƒªã‚¢',cls:'btn-danger',fn:'execMemoClear("'+id+'")'},
     {label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'ğŸ“Œ ãƒ¡ãƒ¢ã‚’ä¿å­˜',cls:'btn-gold',fn:'execMemoSave("'+id+'")'}]
  );
}
function execMemoSave(id){
  var memo = document.getElementById('m-memo').value.trim();
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  c.hqMemo = memo;
  if(memo) c.hist.unshift(today()+' [HQ] ãƒ¡ãƒ¢è¨­å®š: '+memo);
  saveCases(CASES);
  saveHqLog('HQãƒ¡ãƒ¢è¨­å®š', c.id+' '+memo.slice(0,40));
  closeModal();
  toast('âœ… ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  renderDetail(c);
}
function execMemoClear(id){
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  c.hqMemo = '';
  saveCases(CASES);
  closeModal();
  toast('ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  renderDetail(c);
}

// â‘£ ãƒ•ãƒ©ã‚°è¨­å®š
function openFlagModal(id){
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  openModal('ãƒ•ãƒ©ã‚°è¨­å®š',
    '<div style="display:flex;flex-direction:column;gap:8px">'
    +'<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg);border:1px solid var(--border2);border-radius:8px;cursor:pointer">'
    +'<input type="checkbox" id="f-stale" '+(c.stale?'checked':'')+' style="width:auto"> <span style="font-size:12px">âš ï¸ åœæ»ãƒ•ãƒ©ã‚°ï¼ˆ'+(c.age||0)+'æ—¥çµŒéï¼‰</span></label>'
    +'<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg);border:1px solid var(--border2);border-radius:8px;cursor:pointer">'
    +'<input type="checkbox" id="f-priority" '+(c.hqPriority?'checked':'')+' style="width:auto"> <span style="font-size:12px">ğŸ”¥ å„ªå…ˆå¯¾å¿œãƒ•ãƒ©ã‚°</span></label>'
    +'<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg);border:1px solid var(--border2);border-radius:8px;cursor:pointer">'
    +'<input type="checkbox" id="f-hold" '+(c.hqHold?'checked':'')+' style="width:auto"> <span style="font-size:12px">â¸ ä¿ç•™ãƒ•ãƒ©ã‚°ï¼ˆé€²è¡Œåœæ­¢ï¼‰</span></label>'
    +'</div>',
    [{label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'ğŸš© ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°',cls:'btn-primary',fn:'execFlagUpdate("'+id+'")'}]
  );
}
function execFlagUpdate(id){
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  c.stale       = document.getElementById('f-stale').checked;
  c.hqPriority  = document.getElementById('f-priority').checked;
  c.hqHold      = document.getElementById('f-hold').checked;
  var flags = [c.stale&&'åœæ»',c.hqPriority&&'å„ªå…ˆ',c.hqHold&&'ä¿ç•™'].filter(Boolean);
  c.hist.unshift(today()+' [HQ] ãƒ•ãƒ©ã‚°æ›´æ–°: '+(flags.length?flags.join(', '):'ã™ã¹ã¦è§£é™¤'));
  saveCases(CASES);
  saveHqLog('ãƒ•ãƒ©ã‚°è¨­å®š', c.id+' '+flags.join(','));
  closeModal();
  toast('âœ… ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  renderDetail(c);
  applyFilter();
}

// â‘¤ æ¡ˆä»¶æƒ…å ±ç·¨é›†
function openEditModal(id){
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  openModal('æ¡ˆä»¶æƒ…å ±ç·¨é›†',
    '<div class="fg"><label>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå</label><input type="text" id="e-name" value="'+esc(c.name||'')+'"></div>'
    +'<div class="fg"><label>ç‰©ä»¶æ¦‚è¦ãƒ»ãƒ¡ãƒ¢</label><input type="text" id="e-sub"  value="'+esc(c.sub||'')+'"></div>'
    +(c.corp?'<div class="fg"><label>æ‹…å½“è€…åï¼ˆæ³•äººï¼‰</label><input type="text" id="e-contact" value="'+esc(c.contactName||'')+'"></div>':'')
    +(c.salePrice!==undefined?'<div class="fg"><label>ç‰©ä»¶ä¾¡æ ¼ï¼ˆå††ï¼‰</label><input type="number" id="e-price" value="'+(c.salePrice||0)+'"></div>':'')
    +'<div class="fg"><label>é›»è©±ç•ªå·</label><input type="text" id="e-tel" value="'+esc(c.tel||'')+'"></div>',
    [{label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'âœï¸ ä¿å­˜',cls:'btn-gold',fn:'execEdit("'+id+'")'}]
  );
}
function execEdit(id){
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  var changes = [];
  var newName = document.getElementById('e-name').value.trim();
  var newSub  = document.getElementById('e-sub').value.trim();
  if(newName&&newName!==c.name){ changes.push('åå‰: '+c.name+'â†’'+newName); c.name=newName; }
  if(newSub&&newSub!==c.sub)   { changes.push('ç‰©ä»¶: '+c.sub+'â†’'+newSub); c.sub=newSub; }
  var eContact = document.getElementById('e-contact');
  if(eContact){ var nc=eContact.value.trim(); if(nc!==c.contactName){ c.contactName=nc; changes.push('æ‹…å½“: '+nc); } }
  var ePrice = document.getElementById('e-price');
  if(ePrice){ var np=parseFloat(ePrice.value)||0; if(np!==c.salePrice){ c.salePrice=np; changes.push('ä¾¡æ ¼: Â¥'+np.toLocaleString()); } }
  var eTel = document.getElementById('e-tel');
  if(eTel){ c.tel=eTel.value.trim(); }
  if(changes.length) c.hist.unshift(today()+' [HQ] æƒ…å ±ç·¨é›†: '+changes.join(', '));
  saveCases(CASES);
  saveHqLog('æƒ…å ±ç·¨é›†', c.id+' '+changes.join(', '));
  closeModal();
  toast('âœ… æ¡ˆä»¶æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  renderDetail(c);
  applyFilter();
}

// â‘¥ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function openCancelModal(id){
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  openModal('æ¡ˆä»¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    '<div class="alert al-danger">âš ï¸ ã“ã®æ¡ˆä»¶ã‚’å–æ¶ˆã«ã—ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸Slacké€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚</div>'
    +'<div style="background:var(--bg);border:1px solid rgba(248,113,113,.2);border-radius:10px;padding:12px;margin-bottom:14px;font-size:11px">'
    +'<strong>'+esc(c.id)+'</strong> â€” '+esc(c.name)+'ã€€'+esc(c.sub||'')+'</div>'
    +'<div class="fg"><label>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”± <span style="color:var(--red)">*</span></label>'
    +'<textarea id="m-reason" rows="2" placeholder="ç†ç”±ã‚’å…¥åŠ›"></textarea></div>',
    [{label:'æˆ»ã‚‹',cls:'btn-ghost',fn:'closeModal()'},
     {label:'ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹',cls:'btn-danger',fn:'execCancelCase("'+id+'")'}]
  );
}
function execCancelCase(id){
  var reason = document.getElementById('m-reason').value.trim();
  if(!reason){ toast('ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  c.prevStep = c.step;
  c.step = 'cancel';
  var note = today()+' [HQ] ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† ç†ç”±: '+reason;
  c.hist.unshift(note);
  saveCases(CASES);
  saveHqLog('æ¡ˆä»¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«', c.id+' '+reason);
  notifySlack(c.id+' '+c.name+' ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† ç†ç”±: '+reason);
  closeModal();
  toast('æ¡ˆä»¶ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
  renderDetail(c);
  applyFilter();
}

// æ¡ˆä»¶å¾©æ´»
function restoreCase(id){
  if(!confirm('ã“ã®æ¡ˆä»¶ã‚’å¾©æ´»ã•ã›ã¾ã™ã‹ï¼Ÿ')) return;
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  c.step = c.prevStep||'naiken';
  delete c.prevStep;
  c.hist.unshift(today()+' [HQ] æ¡ˆä»¶å¾©æ´»ï¼ˆã‚¹ãƒ†ãƒƒãƒ—: '+(STEP_LABEL_MAP[c.step]||c.step)+'ï¼‰');
  saveCases(CASES);
  saveHqLog('æ¡ˆä»¶å¾©æ´»', c.id);
  toast('âœ… æ¡ˆä»¶ã‚’å¾©æ´»ã•ã›ã¾ã—ãŸ');
  renderDetail(c);
  applyFilter();
}

// â‘¦ ãƒ¡ãƒ¢è¿½åŠ 
function openAddHistModal(id){
  openModal('å±¥æ­´ãƒ¡ãƒ¢ã‚’è¿½åŠ ',
    '<div class="fg"><label>ãƒ¡ãƒ¢å†…å®¹</label>'
    +'<textarea id="h-memo" rows="3" placeholder="ä¾‹: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€£çµ¡ã‚ã‚Šã€‚ä¿è¨¼ä¼šç¤¾å¤‰æ›´ã‚’æ¤œè¨ä¸­ã€‚"></textarea></div>',
    [{label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'+ è¿½è¨˜',cls:'btn-gold',fn:'execAddHist("'+id+'")'}]
  );
}
function execAddHist(id){
  var memo = document.getElementById('h-memo').value.trim();
  if(!memo){ toast('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  var c = CASES.find(function(x){ return x.id===id; });
  if(!c) return;
  c.hist.unshift(today()+' [HQ] '+memo);
  saveCases(CASES);
  saveHqLog('ãƒ¡ãƒ¢è¿½è¨˜', c.id+' '+memo.slice(0,40));
  closeModal();
  toast('âœ… ãƒ¡ãƒ¢ã‚’è¿½è¨˜ã—ã¾ã—ãŸ');
  renderDetail(c);
}

// â‘§ ç”³è¾¼çŠ¶æ…‹å¤‰æ›´
function openAppStatusModal(caseId, appId){
  var c = CASES.find(function(x){ return x.id===caseId; });
  if(!c) return;
  var a = c.apps.find(function(x){ return x.id===appId; });
  if(!a) return;
  var opts = ['reviewing','approved','rejected'].map(function(s){
    var labels={reviewing:'å¯©æŸ»ä¸­',approved:'æ‰¿èª',rejected:'è½ã¡'};
    return '<option value="'+s+'"'+(a.status===s?' selected':'')+'>'+labels[s]+'</option>';
  }).join('');
  openModal('ç”³è¾¼çŠ¶æ…‹ã®å¤‰æ›´',
    '<div class="fg"><label>ç”³è¾¼ç‰©ä»¶</label><input type="text" readonly value="'+esc(a.prop||a.id)+'"></div>'
    +'<div class="fg"><label>çŠ¶æ…‹</label><select id="app-status">'+opts+'</select></div>',
    [{label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'å¤‰æ›´',cls:'btn-primary',fn:'execAppStatus("'+caseId+'","'+appId+'")'}]
  );
}
function execAppStatus(caseId, appId){
  var c = CASES.find(function(x){ return x.id===caseId; });
  if(!c) return;
  var a = c.apps.find(function(x){ return x.id===appId; });
  if(!a) return;
  var labels={reviewing:'å¯©æŸ»ä¸­',approved:'æ‰¿èª',rejected:'è½ã¡'};
  var newSt = document.getElementById('app-status').value;
  a.status = newSt;
  c.hist.unshift(today()+' [HQ] ç”³è¾¼çŠ¶æ…‹å¤‰æ›´: '+esc(a.prop||a.id)+' â†’ '+labels[newSt]);
  saveCases(CASES);
  saveHqLog('ç”³è¾¼çŠ¶æ…‹å¤‰æ›´', caseId+' '+appId+' '+newSt);
  closeModal();
  toast('âœ… ç”³è¾¼çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
  renderDetail(c);
}

// â•â• ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(title, bodyHtml, buttons){
  document.getElementById('m-title').textContent=title;
  document.getElementById('m-body').innerHTML=bodyHtml;
  document.getElementById('m-footer').innerHTML=buttons.map(function(b){
    return '<button class="btn '+b.cls+'" onclick="'+b.fn+'">'+b.label+'</button>';
  }).join('');
  document.getElementById('modal-bg').classList.add('open');
}
function closeModal(){
  document.getElementById('modal-bg').classList.remove('open');
}
document.getElementById('modal-bg').addEventListener('click',function(e){
  if(e.target===this) closeModal();
});

// â•â• çµ±è¨ˆãƒãƒ¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats(){
  var total   = CASES.length;
  var active  = CASES.filter(function(c){ return c.step!=='cancel'&&c.step!=='done'; }).length;
  var stale   = CASES.filter(function(c){ return c.stale; }).length;
  var done    = CASES.filter(function(c){ return c.step==='done'; }).length;
  var cancel  = CASES.filter(function(c){ return c.step==='cancel'; }).length;
  var priority= CASES.filter(function(c){ return c.hqPriority; }).length;

  document.getElementById('stats-bar').innerHTML =
    statChip('å…¨æ¡ˆä»¶', total, '', 'all')
   +statChip('é€²è¡Œä¸­', active, 'sv-blue', 'active')
   +statChip('åœæ»',   stale,  stale>0?'sv-red':'', 'stale')
   +statChip('å®Œäº†',   done,   'sv-green', 'done-filter')
   +statChip('å–æ¶ˆ',   cancel, '', 'cancel')
   +statChip('ğŸ”¥ å„ªå…ˆ',priority, 'sv-gold', 'priority');
}
function statChip(label, val, cls, filter){
  return '<div class="stat-chip '+cls+'" onclick="setStatFilter(''+filter+'')">'
    +'<div class="sv">'+val+'</div><div class="sl">'+label+'</div></div>';
}
function setStatFilter(f){
  var map = {'all':'all','active':'active','stale':'stale','done-filter':'done','cancel':'cancel','priority':'priority'};
  var type = map[f]||'all';
  var chipMap = {'all':'f-all','reLet':'f-reLet','reSale':'f-reSale','sannai':'f-sannai',
                 'hr':'f-hr','stale':'f-stale','cancel':'f-cancel','priority':'f-priority'};
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒƒãƒ—ã¨åŒæœŸ
  Object.values(chipMap).forEach(function(id){ var el=document.getElementById(id); if(el) el.classList.remove('on'); });
  var targetChip = chipMap[type];
  if(targetChip){ var el=document.getElementById(targetChip); if(el) el.classList.add('on'); }
  typeFilter = type;
  applyFilter();
}

// â•â• ã‚½ãƒ¼ãƒˆ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var sortKey = 'age';
function setSort(key, el){
  sortKey = key;
  document.querySelectorAll('.sort-btn').forEach(function(b){ b.classList.remove('on'); });
  el.classList.add('on');
  applyFilter();
}
function sortCases(cases){
  return cases.slice().sort(function(a,b){
    if(sortKey==='age')   return (a.age||0)-(b.age||0);  // åœæ»é †ï¼ˆå¤ã„â†’æ–°ã—ã„ï¼‰
    if(sortKey==='type')  return (a.type||'').localeCompare(b.type||'');
    if(sortKey==='step')  return (a.step||'').localeCompare(b.step||'');
    if(sortKey==='agent') return (a.agent||'').localeCompare(b.agent||'');
    return 0;
  });
}

// â•â• ä¸€æ‹¬é¸æŠ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var selectedIds = new Set();
function toggleSelect(id, ev){
  ev.stopPropagation();
  if(selectedIds.has(id)) selectedIds.delete(id);
  else selectedIds.add(id);
  updateBulkBar();
  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®UIã‚’æ›´æ–°
  var cb = document.getElementById('cb-'+id);
  if(cb) cb.checked = selectedIds.has(id);
}
function selectAll(){
  var items = document.querySelectorAll('.case-item');
  items.forEach(function(el){
    var id = el.dataset.id;
    if(id) selectedIds.add(id);
    var cb = document.getElementById('cb-'+id);
    if(cb) cb.checked = true;
  });
  updateBulkBar();
}
function clearSelection(){
  selectedIds.clear();
  document.querySelectorAll('.ci-check').forEach(function(cb){ cb.checked=false; });
  updateBulkBar();
}
function updateBulkBar(){
  var bar = document.getElementById('bulk-bar');
  var cnt = document.getElementById('bulk-count');
  bar.className = 'bulk-bar' + (selectedIds.size>0?' show':'');
  cnt.textContent = selectedIds.size+'ä»¶é¸æŠä¸­';
}

// â”€â”€ ä¸€æ‹¬ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´
function bulkStepModal(){
  if(!selectedIds.size) return;
  var allSteps = ['naiken','apply','screening','invoice','prekey','key',
                  'offer','contract','settlement','interview','onboard','zaiki','done'];
  var opts = allSteps.map(function(s){
    return '<option value="'+s+'">'+(STEP_LABEL_MAP[s]||s)+'</option>';
  }).join('');
  openModal('ä¸€æ‹¬ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´ï¼ˆ'+selectedIds.size+'ä»¶ï¼‰',
    '<div class="alert al-warn">âš ï¸ é¸æŠã—ãŸå…¨æ¡ˆä»¶ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¤‰æ›´ã—ã¾ã™ã€‚ç¨®åˆ¥ã«åˆã‚ãªã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’é¸ã¶ã¨æ•´åˆãŒå´©ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</div>'
    +'<div class="fg"><label>å¤‰æ›´å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—</label><select id="bk-step">'+opts+'</select></div>'
    +'<div class="fg"><label>ç†ç”±</label><textarea id="bk-reason" rows="2"></textarea></div>',
    [{label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'ğŸ”€ ä¸€æ‹¬å¤‰æ›´',cls:'btn-primary',fn:'execBulkStep()'}]
  );
}
function execBulkStep(){
  var newStep = document.getElementById('bk-step').value;
  var reason  = document.getElementById('bk-reason').value;
  var label   = STEP_LABEL_MAP[newStep]||newStep;
  var count = 0;
  selectedIds.forEach(function(id){
    var c = CASES.find(function(x){ return x.id===id; });
    if(!c) return;
    c.step = newStep; c.age = 0;
    c.hist.unshift(today()+' [HQä¸€æ‹¬] ã‚¹ãƒ†ãƒƒãƒ—â†’'+label+(reason?' '+reason:''));
    count++;
  });
  saveCases(CASES);
  saveHqLog('ä¸€æ‹¬ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´', count+'ä»¶ â†’'+label);
  clearSelection();
  closeModal();
  toast('âœ… '+count+'ä»¶ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
  renderStats(); applyFilter();
  if(currentId) openCase(currentId);
}

// â”€â”€ ä¸€æ‹¬æ‹…å½“è€…å¤‰æ›´
function bulkAgentModal(){
  if(!selectedIds.size) return;
  var agentIds = ['10008','10012','10023','10041','20005','20010','00001','00347'];
  var opts = agentIds.map(function(a){ return '<option value="'+a+'">'+agentName(a)+'</option>'; }).join('');
  openModal('ä¸€æ‹¬æ‹…å½“è€…å¤‰æ›´ï¼ˆ'+selectedIds.size+'ä»¶ï¼‰',
    '<div class="fg"><label>æ–°ã—ã„æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</label><select id="bk-agent">'+opts+'</select></div>'
    +'<div class="fg"><label>ç†ç”±</label><textarea id="bk-reason" rows="2"></textarea></div>',
    [{label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'ğŸ‘¤ ä¸€æ‹¬å¤‰æ›´',cls:'btn-primary',fn:'execBulkAgent()'}]
  );
}
function execBulkAgent(){
  var newAgent = document.getElementById('bk-agent').value;
  var reason   = document.getElementById('bk-reason').value;
  var name     = agentName(newAgent);
  var count = 0;
  selectedIds.forEach(function(id){
    var c = CASES.find(function(x){ return x.id===id; });
    if(!c) return;
    var prev = agentName(c.agent);
    c.agent = newAgent;
    c.hist.unshift(today()+' [HQä¸€æ‹¬] æ‹…å½“å¤‰æ›´: '+prev+'â†’'+name+(reason?' '+reason:''));
    count++;
  });
  saveCases(CASES);
  saveHqLog('ä¸€æ‹¬æ‹…å½“å¤‰æ›´', count+'ä»¶ â†’'+name);
  clearSelection();
  closeModal();
  toast('âœ… '+count+'ä»¶ã®æ‹…å½“è€…ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
  applyFilter();
  if(currentId) openCase(currentId);
}

// â”€â”€ ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function bulkCancelModal(){
  if(!selectedIds.size) return;
  openModal('ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆ'+selectedIds.size+'ä»¶ï¼‰',
    '<div class="alert al-danger">âš ï¸ é¸æŠã—ãŸ'+selectedIds.size+'ä»¶ã‚’ã™ã¹ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</div>'
    +'<div class="fg"><label>ç†ç”± <span style="color:var(--red)">*</span></label><textarea id="bk-reason" rows="2"></textarea></div>',
    [{label:'æˆ»ã‚‹',cls:'btn-ghost',fn:'closeModal()'},
     {label:'ğŸš« ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-danger',fn:'execBulkCancel()'}]
  );
}
function execBulkCancel(){
  var reason = document.getElementById('bk-reason').value.trim();
  if(!reason){ toast('ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  var count = 0;
  selectedIds.forEach(function(id){
    var c = CASES.find(function(x){ return x.id===id; });
    if(!c||c.step==='cancel') return;
    c.prevStep = c.step; c.step = 'cancel';
    c.hist.unshift(today()+' [HQä¸€æ‹¬] ã‚­ãƒ£ãƒ³ã‚»ãƒ«: '+reason);
    count++;
  });
  saveCases(CASES);
  saveHqLog('ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«', count+'ä»¶ '+reason);
  clearSelection();
  closeModal();
  toast(count+'ä»¶ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
  renderStats(); applyFilter();
}

// â•â• CSVå‡ºåŠ› â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function csvExport(){
  var cols = ['æ¡ˆä»¶ID','ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ','ç¨®åˆ¥','æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ','ã‚¹ãƒ†ãƒƒãƒ—','ç‰©ä»¶æ¦‚è¦','çµŒéæ—¥æ•°','åœæ»','å„ªå…ˆ'];
  var rows = [cols];
  CASES.forEach(function(c){
    rows.push([
      c.id, c.name, TYPE_LABELS[c.type]||c.type, agentName(c.agent),
      STEP_LABEL_MAP[c.step]||c.step, c.sub||'', c.age||0,
      c.stale?'åœæ»':'', c.hqPriority?'å„ªå…ˆ':''
    ]);
  });
  var csv = rows.map(function(r){
    return r.map(function(v){ return '"'+String(v).replace(/"/g,'""')+'"'; }).join(',');
  }).join('\n');
  var blob = new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'coreto_cases_'+todayISO()+'.csv';
  a.click();
  toast('âœ… CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆ'+CASES.length+'ä»¶ï¼‰');
}

// â•â• æ–°è¦æ¡ˆä»¶ç™»éŒ² â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewCaseModal(){
  var agentIds = ['10008','10012','10023','10041','20005','20010','00001','00347'];
  var agentOpts = agentIds.map(function(a){ return '<option value="'+a+'">'+agentName(a)+'ï¼ˆ'+a+'ï¼‰</option>'; }).join('');
  openModal('æ–°è¦æ¡ˆä»¶ç™»éŒ²ï¼ˆHQèµ·ç¥¨ï¼‰',
    '<div class="fg-row">'
    +'<div class="fg"><label>æ¡ˆä»¶ç¨®åˆ¥ <span style="color:var(--red)">*</span></label>'
    +'<select id="n-type" onchange="updateNewCaseId()">'
    +'<option value="reLet">ğŸ  è³ƒè²¸</option>'
    +'<option value="reSale">ğŸ¢ å£²è²·</option>'
    +'<option value="sannai">ğŸ”„ ä¸‰ç‚º</option>'
    +'<option value="hr">ğŸ‘¥ äººæç´¹ä»‹</option>'
    +'</select></div>'
    +'<div class="fg"><label>æ¡ˆä»¶IDï¼ˆè‡ªå‹•ï¼‰</label><input type="text" id="n-id" readonly style="color:var(--muted)"></div>'
    +'</div>'
    +'<div class="fg"><label>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå <span style="color:var(--red)">*</span></label>'
    +'<input type="text" id="n-name" placeholder="ç”°ä¸­ é›„ä»‹ / æ ªå¼ä¼šç¤¾ã€‡ã€‡"></div>'
    +'<div class="fg"><label>æ³•äºº</label>'
    +'<label style="display:flex;align-items:center;gap:8px;margin-top:4px;cursor:pointer">'
    +'<input type="checkbox" id="n-corp" style="width:auto"> <span style="font-size:12px">æ³•äººæ¡ˆä»¶</span></label></div>'
    +'<div class="fg"><label>ç‰©ä»¶æ¦‚è¦ / æ±‚äººæ¦‚è¦</label>'
    +'<input type="text" id="n-sub" placeholder="æ¸‹è°·åŒº 2LDK Â¥180,000 / ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ å¹´å600ä¸‡"></div>'
    +'<div class="fg"><label>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ <span style="color:var(--red)">*</span></label>'
    +'<select id="n-agent">'+agentOpts+'</select></div>'
    +'<div class="fg"><label>é›»è©±ç•ªå·</label><input type="text" id="n-tel" placeholder="090-XXXX-XXXX"></div>'
    +'<div class="fg"><label>åˆæœŸãƒ¡ãƒ¢</label><textarea id="n-memo" rows="2" placeholder="èµ·ç¥¨æ™‚ã®çŠ¶æ³ãƒ¡ãƒ¢"></textarea></div>',
    [{label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',cls:'btn-ghost',fn:'closeModal()'},
     {label:'âœ… æ¡ˆä»¶ã‚’ç™»éŒ²',cls:'btn-gold',fn:'execNewCase()'}]
  );
  updateNewCaseId();
}
function updateNewCaseId(){
  var type = document.getElementById('n-type')&&document.getElementById('n-type').value||'reLet';
  var prefix = {reLet:'R',reSale:'S',sannai:'N',hr:'H'}[type]||'R';
  var num = String(Math.floor(Math.random()*90000+10000));
  var id = prefix+Date.now().toString().slice(-6);
  var el = document.getElementById('n-id');
  if(el) el.value = id;
}
function execNewCase(){
  var type  = document.getElementById('n-type').value;
  var id    = document.getElementById('n-id').value;
  var name  = document.getElementById('n-name').value.trim();
  var corp  = document.getElementById('n-corp').checked;
  var sub   = document.getElementById('n-sub').value.trim();
  var agent = document.getElementById('n-agent').value;
  var tel   = document.getElementById('n-tel').value.trim();
  var memo  = document.getElementById('n-memo').value.trim();
  if(!name){ toast('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  var firstStep = {reLet:'naiken',reSale:'naiken',sannai:'naiken',hr:'screening'}[type];
  var newCase = {
    id: id, name: name, type: type, corp: corp,
    agent: agent, sub: sub, tel: tel,
    step: firstStep, age: 0, stale: false,
    apps: [], dates: {}, 
    hqCreated: true,
    createdBy: SESSION.name||SESSION.userId,
    hist: [today()+' [HQèµ·ç¥¨] æ¡ˆä»¶ç™»éŒ² æ‹…å½“: '+agentName(agent)+(memo?' ãƒ¡ãƒ¢: '+memo:'')],
  };
  CASES.unshift(newCase);
  saveCases(CASES);
  saveHqLog('æ–°è¦æ¡ˆä»¶ç™»éŒ²', id+' '+name+' æ‹…å½“: '+agentName(agent));
  notifySlack('ğŸ“ æ–°è¦æ¡ˆä»¶ç™»éŒ²ï¼ˆHQèµ·ç¥¨ï¼‰: '+id+' '+name+' æ‹…å½“: '+agentName(agent));
  closeModal();
  toast('âœ… æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆ'+id+'ï¼‰');
  renderStats();
  applyFilter();
  openCase(id);
}

// â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
applyFilter();
renderStats();
</script>
</body>
</html>
