<!DOC
  {id:'N001001', name:'æ ªå¼ä¼šç¤¾ã‚¢ãƒ«ãƒ•ã‚¡ä¸å‹•ç”£', type:'sannai', corp:true, contactName:'å±±ç”° èª²é•·', agent:'10008',
   sub:'ä¸–ç”°è°·åŒº ä¸€æ£Ÿãƒãƒ³ã‚·ãƒ§ãƒ³ Â¥180,000,000', step:'verify', age:1, stale:false,
   salePrice:180000000,
   sannai:{buyPrice:165000000, sellPrice:180000000, commPayMode:'both',
     commBuyCo:'æ±æ€¥ãƒªãƒãƒ–ãƒ«', commBuyAmt:3300000,
     commSellCo:'ä½å‹ä¸å‹•ç”£è²©å£²', commSellAmt:2200000,
     delegPay:[{co:'ã‚³ãƒ³ã‚µãƒ«æ ªå¼ä¼šç¤¾', type:'other', amt:550000}]},
   buyer:{name:'æœ‰é™ä¼šç¤¾ãƒ™ãƒ¼ã‚¿é–‹ç™º', takkenNum:'æ±äº¬éƒ½çŸ¥äº‹ï¼ˆ3ï¼‰ç¬¬12345å·', verified:false,
     verifyState:'pending', pendingCode:'K7X9QM'},
   apps:[], dates:{naiken:'2026-02-21'},
   hist:['2/21 å†…è¦‹å®Œäº†','2/22 æ¥­è€…ç¢ºèªä¾é ¼é€ä¿¡ / æœ‰é™ä¼šç¤¾ãƒ™ãƒ¼ã‚¿é–‹ç™º (æ±äº¬éƒ½çŸ¥äº‹ï¼ˆ3ï¼‰ç¬¬12345å·)'],
  },
  {id:'N002002', name:'åˆåŒä¼šç¤¾ã‚µã‚¯ãƒ©æŠ•è³‡', type:'sannai', corp:true, contactName:'ä½è—¤ éƒ¨é•·', agent:'10012',
   sub:'ç›®é»’åŒº åŒºåˆ†ãƒãƒ³ã‚·ãƒ§ãƒ³ Â¥45,000,000', step:'naiken', age:0, stale:false,
   salePrice:45000000,
   apps:[], dates:{naiken:'2026-02-23'},
   hist:['2/23 å†…è¦‹äºˆå®š'],
  },TYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORETO â€” æ¡ˆä»¶ç®¡ç†</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--card:#0f1119;--card2:#141720;--border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--gold-dim:#7a5f22;--gold-glow:rgba(201,168,76,.1);
  --blue:#4f9cf9;--green:#34d399;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;
  --muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;
}
html,body{height:100%;font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);overflow:hidden}

/* â”€â”€ Layout â”€â”€ */
.layout{display:flex;flex-direction:column;height:100vh}
.hdr{height:52px;display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;border-bottom:1px solid var(--border);background:rgba(7,9,15,.96);flex-shrink:0;z-index:50}
.logo{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;color:var(--gold);letter-spacing:3px}
.toolbar{height:44px;display:flex;align-items:center;gap:10px;padding:0 16px;
  border-bottom:1px solid var(--border);background:var(--card2);flex-shrink:0}
.main{display:flex;flex:1;overflow:hidden}

/* â”€â”€ Board â”€â”€ */
.board-wrap{flex:1;overflow-x:auto;overflow-y:hidden;display:flex}
.board{display:flex;height:100%}
.col{width:230px;flex-shrink:0;display:flex;flex-direction:column;border-right:1px solid var(--border)}
.col:last-child{border-right:none}
.col-hdr{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.col-title{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;display:flex;align-items:center;gap:7px}
.col-dot{width:7px;height:7px;border-radius:50%}
.col-count{font-size:9px;padding:1px 7px;border-radius:8px;font-weight:700}
.col-body{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:7px}

/* â”€â”€ Case cards â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:11px 12px;
  cursor:pointer;transition:.15s;position:relative}
.card:hover{border-color:var(--border2);background:#111420;transform:translateY(-1px)}
.card.active{border-color:var(--gold);background:#13110a}
.card-type{font-size:8px;font-weight:700;letter-spacing:.5px;margin-bottom:5px;display:flex;align-items:center;gap:5px}
.card-name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.card-sub{font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:6px}
.card-foot{display:flex;align-items:center;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px}
.card-id{font-family:'DM Mono',monospace;font-size:8px;color:var(--muted)}
.age{font-size:8px;padding:1px 6px;border-radius:4px;font-weight:700}
.stale{position:absolute;top:8px;right:8px;width:6px;height:6px;border-radius:50%;background:var(--red);animation:blink 2s infinite}
@keyframes blink{50%{opacity:.2}}
.add-row{padding:7px;border:1px dashed var(--border2);border-radius:8px;text-align:center;
  font-size:10px;color:var(--muted);cursor:pointer;transition:.15s}
.add-row:hover{border-color:var(--blue);color:var(--blue)}

/* â”€â”€ Detail Panel â”€â”€ */
.panel{width:0;overflow:hidden;border-left:1px solid var(--border);transition:.2s cubic-bezier(.4,0,.2,1);
  display:flex;flex-direction:column;background:var(--card);flex-shrink:0}
.panel.open{width:460px}
.panel-top{padding:16px 18px 0;flex-shrink:0}
.panel-body{flex:1;overflow-y:auto;padding:0 18px 18px}

/* â”€â”€ Step Progress â”€â”€ */
.step-bar{display:flex;align-items:center;margin:16px 0 20px}
.step-node{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;cursor:pointer}
.step-node:not(:last-child)::after{content:'';position:absolute;top:14px;left:50%;width:100%;height:1px;background:var(--border2);z-index:0}
.step-node.done::after{background:var(--green)}
.step-node.active::after{background:linear-gradient(90deg,var(--gold),var(--border2))}
.step-circle{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;border:2px solid var(--border2);background:var(--bg);
  position:relative;z-index:1;transition:.2s}
.step-node.done .step-circle{background:var(--green);border-color:var(--green);color:#0a0c10;font-size:12px}
.step-node.active .step-circle{background:var(--gold);border-color:var(--gold);color:#0a0c10;box-shadow:0 0 12px rgba(201,168,76,.4)}
.step-node.future .step-circle{color:var(--muted)}
.step-label{font-size:8px;margin-top:4px;font-weight:600;letter-spacing:.3px;white-space:nowrap}
.step-node.done .step-label{color:var(--green)}
.step-node.active .step-label{color:var(--gold)}
.step-node.future .step-label{color:var(--muted)}

/* â”€â”€ Step Content â”€â”€ */
.step-content{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:18px}
.step-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;margin-bottom:14px;
  display:flex;align-items:center;gap:8px}

/* â”€â”€ Inputs â”€â”€ */
.fi{margin-bottom:10px}
.fi label{font-size:10px;color:var(--sub);display:block;margin-bottom:3px}
.fi input,.fi select,.fi textarea{width:100%;background:#090b13;border:1px solid var(--border2);
  border-radius:7px;padding:8px 11px;color:var(--text);font-size:12px;
  font-family:'Noto Sans JP',sans-serif;outline:none;transition:border .15s}
.fi input:focus,.fi select:focus{border-color:var(--gold)}
input[type=date]{color-scheme:dark}
.mono{font-family:'DM Mono',monospace!important}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:9px 18px;border-radius:9px;font-size:12px;font-weight:700;cursor:pointer;
  font-family:'Noto Sans JP',sans-serif;transition:.15s;border:none;display:inline-flex;align-items:center;gap:7px}
.btn-green{background:var(--green);color:#0a0c10}
.btn-green:hover{background:#2ec98a;transform:translateY(-1px)}
.btn-red{background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.3)}
.btn-red:hover{background:rgba(248,113,113,.25)}
.btn-gold{background:linear-gradient(135deg,var(--gold),#a8872f);color:#0a0c10}
.btn-gold:hover{transform:translateY(-1px)}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--sub)}
.btn-ghost:hover{color:var(--text);border-color:var(--sub)}
.btn-blue{background:rgba(79,156,249,.15);color:var(--blue);border:1px solid rgba(79,156,249,.3)}
.btn-sm{padding:5px 12px;font-size:10px;border-radius:7px}
.btn-xs{padding:3px 9px;font-size:9px;border-radius:5px}
.row{display:flex;gap:8px}
.row .btn{flex:1;justify-content:center}

/* â”€â”€ Pill tags â”€â”€ */
.pill{display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:8px;font-weight:700}
.pill-green{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.pill-orange{background:rgba(251,146,60,.12);color:var(--orange);border:1px solid rgba(251,146,60,.2)}
.pill-red{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.2)}
.pill-purple{background:rgba(167,139,250,.12);color:var(--purple);border:1px solid rgba(167,139,250,.2)}
.pill-blue{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.2)}
.pill-muted{background:rgba(74,82,112,.15);color:var(--sub);border:1px solid var(--border2)}
.pill-gold{background:rgba(201,168,76,.12);color:var(--gold);border:1px solid rgba(201,168,76,.2)}

/* â”€â”€ App list (è¤‡æ•°ç”³è¾¼) â”€â”€ */
.app-item{background:#0b0d15;border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:6px}
.app-item.active-app{border-color:var(--gold)}
.app-name{font-size:12px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;justify-content:space-between}
.app-meta{font-size:10px;color:var(--sub)}

/* â”€â”€ History â”€â”€ */
.hist-item{display:flex;gap:8px;padding:4px 0}
.hist-dot{width:7px;height:7px;border-radius:50%;background:var(--border2);flex-shrink:0;margin-top:4px}
.hist-dot.cur{background:var(--gold)}
.hist-line{width:1px;height:14px;background:var(--border2);margin:1px auto}

/* â”€â”€ Modal â”€â”€ */
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(3px);z-index:200;align-items:center;justify-content:center}
#overlay.on{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px;max-width:400px;width:90%}
.warn-agree-box{background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.25);
  border-radius:10px;padding:14px;font-size:11px;color:var(--sub);line-height:1.9;margin-bottom:14px}
.warn-agree-box strong{color:var(--red)}
.warn-chk-row{display:flex;align-items:flex-start;gap:8px;margin-top:10px;cursor:pointer}
.warn-chk-row input{margin-top:2px;accent-color:var(--gold);width:14px;height:14px;flex-shrink:0;cursor:pointer}
.modal-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold);margin-bottom:14px}

/* â”€â”€ Toast â”€â”€ */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--card);
  border:1px solid var(--green);border-radius:9px;padding:9px 16px;font-size:11px;
  color:var(--green);z-index:300;display:none;white-space:nowrap}

/* â”€â”€ Done state â”€â”€ */
.done-card{text-align:center;padding:20px}
.done-icon{font-size:48px;margin-bottom:8px}
.done-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--green)}

/* â”€â”€ cancel state â”€â”€ */
.cancel-card{text-align:center;padding:16px;color:var(--red)}

/* â”€â”€ ç´¹ä»‹ãƒªãƒ³ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
#ref-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:9000;align-items:center;justify-content:center}
#ref-modal-overlay.open{display:flex}
#ref-modal{background:var(--card);border:1px solid var(--border2);border-radius:16px;padding:0;width:min(460px,92vw);overflow:hidden}
.ref-mhdr{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ref-mhdr-t{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold)}
.ref-mbody{padding:20px}
.ref-url{background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:10px 12px;font-family:'DM Mono',monospace;font-size:11px;color:var(--sub);word-break:break-all;margin:10px 0;min-height:36px}
.ref-copy-btn{width:100%;padding:10px;border-radius:8px;border:none;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;background:var(--gold);color:#0a0c10;margin-top:4px}
.ref-copy-btn:hover{opacity:.9}

/* â”€â”€ ç´¹ä»‹ãƒªãƒ³ã‚¯ å·¦ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ â”€â”€ */
#ref-float-btn {
  position: fixed;
  left: 0;
  top: 50%;
  transform: translateY(-50%) translateX(-100%) rotate(-90deg);
  transform-origin: right bottom;
  z-index: 8000;
  background: rgba(201,168,76,.18);
  border: 1px solid rgba(201,168,76,.4);
  border-bottom: none;
  border-radius: 8px 8px 0 0;
  color: var(--gold);
  padding: 6px 16px;
  font-size: 11px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  white-space: nowrap;
  letter-spacing: .5px;
  transition: background .15s;
}
#ref-float-btn:hover { background: rgba(201,168,76,.32); }
</style>
</head>
<body>
<div class="layout">

<div class="hdr">
  <div style="display:flex;align-items:center;gap:14px">
    <div class="logo">CORETO</div>
    <span style="font-size:9px;color:var(--muted);font-weight:600;letter-spacing:1px">æ¡ˆä»¶ç®¡ç†</span>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-ghost btn-sm" onclick="history.back()">â† æˆ»ã‚‹</button>
    <button class="btn btn-gold btn-sm" onclick="openNewModal()">ï¼‹ æ–°è¦æ¡ˆä»¶</button>
  </div>
</div>

<div class="toolbar">
  <select id="f-type" onchange="render()" style="background:#090b13;border:1px solid var(--border2);border-radius:6px;padding:4px 10px;color:var(--text);font-size:11px;font-family:inherit">
    <option value="reLet">ğŸ  è³ƒè²¸</option>
    <option value="reSale">ğŸ¢ å£²è²·</option>
    <option value="sannai">ğŸ”„ ä¸‰ç‚º</option>
    <option value="hr">ğŸ‘¥ äººæ</option>
  </select>

  <span id="board-count" style="margin-left:auto;font-size:10px;color:var(--muted)"></span>
</div>

<div class="main">
  <div class="board-wrap"><div class="board" id="board"></div></div>

  <!-- Detail Panel -->
  <div class="panel" id="panel">
    <div class="panel-top" id="panel-top"></div>
    <div class="panel-body" id="panel-body"></div>
  </div>
</div>

</div><!-- /layout -->

<!-- Modal -->
<div id="overlay"><div class="modal" id="modal-box"></div></div>
<div class="toast" id="toast"></div>

<script>
// â•â• AUTH GUARD (è¦ãƒ­ã‚°ã‚¤ãƒ³) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  var s = null;
  try { s = JSON.parse(sessionStorage.getItem('coreto_session') || 'null'); } catch(e) {}
  if (!s) { location.replace('coreto-hub.html'); }
  window._SESSION = s;
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STAGES = [
  {id:'new',      label:'æ–°è¦',     dot:'#4a5270', color:'var(--sub)'},
  {id:'naiken',   label:'å†…è¦‹',     dot:'#4f9cf9', color:'var(--blue)',    labelHR:'æ›¸é¡é¸è€ƒ'},
  {id:'apply',    label:'ç”³è¾¼ãƒ»å¯©æŸ»',dot:'#fb923c', color:'var(--orange)', labelSale:'è²·ä»˜', labelHR:'é¢æ¥èª¿æ•´'},
  {id:'contract', label:'å¥‘ç´„ä¸­',   dot:'#c9a84c', color:'var(--gold)',    labelHR:'å†…å®šãƒ»å…¥ç¤¾'},
  {id:'payment',  label:'å…¥é‡‘å¾…ã¡', dot:'#a78bfa', color:'var(--purple)',  labelHR:'åœ¨ç±ç¢ºèª'},
  {id:'done',     label:'å®Œäº†',     dot:'#34d399', color:'var(--green)'},
  {id:'cancel',   label:'å–æ¶ˆ',     dot:'#f87171', color:'var(--red)'},
];

// ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆäººæç´¹ä»‹ï¼‰
const STEPS_HR = [
  {id:'screening', label:'æ›¸é¡é¸è€ƒ', icon:'ğŸ“„', stage:'naiken'},
  {id:'job-check', label:'æ±‚äººç¥¨ç¢ºèª', icon:'ğŸ”', stage:'naiken'},
  {id:'interview', label:'é¢æ¥èª¿æ•´',  icon:'ğŸ“…', stage:'apply'},
  {id:'offer',     label:'å†…å®š',      icon:'ğŸ‰', stage:'contract'},
  {id:'onboard',   label:'å…¥ç¤¾',      icon:'ğŸ¢', stage:'contract'},
  {id:'zaiki',     label:'åœ¨ç±ç¢ºèª',  icon:'âœ…', stage:'payment'},
  {id:'pay2',      label:'ç¬¬2å›å ±é…¬', icon:'ğŸ’°', stage:'done'},
];

// ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆè³ƒè²¸ï¼‰
const STEPS_RELET = [
  {id:'naiken',   label:'å†…è¦‹',   icon:'ğŸ ', stage:'naiken'},
  {id:'apply',    label:'ç”³è¾¼',   icon:'ğŸ“‹', stage:'apply'},
  {id:'screening',label:'å¯©æŸ»',   icon:'â³', stage:'apply'},
  {id:'invoice',  label:'è«‹æ±‚æ›¸', icon:'ğŸ§¾', stage:'contract'},
  {id:'prekey',   label:'é‡èª¬ãƒ»å…¥é‡‘', icon:'ğŸ“', stage:'contract'},
  {id:'key',      label:'éµæ¸¡ã—', icon:'ğŸ”‘', stage:'done'},
];

// ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆå£²è²·ï¼‰
const STEPS_RESALE = [
  {id:'naiken',   label:'å†…è¦‹',   icon:'ğŸ ', stage:'naiken'},
  {id:'offer',    label:'è²·ä»˜',   icon:'ğŸ“„', stage:'apply'},
  {id:'invoice',  label:'è«‹æ±‚æ›¸', icon:'ğŸ§¾', stage:'contract'},
  {id:'contract', label:'å¥‘ç´„',   icon:'âœï¸', stage:'contract'},
  {id:'settlement',label:'æ±ºæ¸ˆ',  icon:'ğŸ’´', stage:'done'},
];


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Slack ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SLACK_CH = {
  æ–°è¦æ¡ˆä»¶: 'æ–°è¦æ¡ˆä»¶ç™»éŒ²',
  å†…è¦‹:     'å†…è¦‹å®Œäº†',
  å¯©æŸ»:     'å¯©æŸ»çŠ¶æ³',
  ä¸‰ç‚ºç¢ºèª: 'ä¸‰ç‚ºæ¥­è€…ç¢ºèª',  // æ¥­è€…ç¢ºèªä¾é ¼ + èªè¨¼å®Œäº†
  è«‹æ±‚æ›¸:   'è«‹æ±‚æ›¸ç™ºè¡Œ',
  å¥‘ç´„:     'å¥‘ç´„ç· çµ',
  æ±ºæ¸ˆ:     'æ±ºæ¸ˆå®Œäº†',
  é‡èª¬:     'ITé‡èª¬å®Œäº†',
  å…¥é‡‘:     'å…¥é‡‘ç¢ºèª',
  é€€è·å ±å‘Š: 'æ—©æœŸé€€è·å ±å‘Š',
  é‡èª¬æ—¥ç¨‹: 'ITé‡èª¬æ—¥ç¨‹èª¿æ•´',
};

// æ±ç”¨Slacké€ä¿¡ï¼ˆãƒ¢ãƒƒã‚¯: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ + console.logï¼‰
function slackSend(channel, lines) {
  const text = lines.filter(Boolean).join('\n');
  console.log(`[Slack #${channel}]\n`, text);
  try {
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  } catch(e) {}
  // æœ¬ç•ª: fetch(SLACK_WEBHOOK_URL, {method:'POST', body: JSON.stringify({text, channel:'#'+channel})})
}

function slackHeader(emoji, title) {
  return ['â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', emoji+' *'+title+'*', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'];
}

function slackFooter() {
  return ['â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'ğŸ• '+new Date().toLocaleString('ja-JP')];
}

function slackCase(c) {
  const typeLabel = c.type==='sannai'?'ä¸‰ç‚º':c.type==='reSale'?'å£²è²·':'è³ƒè²¸';
  return [
    'ğŸ“ *æ¡ˆä»¶ID*ï¼š'+c.id,
    'ğŸ‘¤ *ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ*ï¼š'+c.name,
    'ğŸ· *ç¨®åˆ¥*ï¼š'+typeLabel,
    'ğŸ‘¨â€ğŸ’¼ *æ‹…å½“*ï¼š'+c.agent,
  ];
}

// ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆä¸‰ç‚ºï¼‰
const STEPS_SANNAI = [
  {id:'naiken',    label:'å†…è¦‹',     icon:'ğŸ ', stage:'naiken'},
  {id:'verify',    label:'æ¥­è€…ç¢ºèª', icon:'ğŸ”', stage:'apply'},
  {id:'offer',     label:'è²·ä»˜',     icon:'ğŸ“„', stage:'apply'},
  {id:'invoice',   label:'è«‹æ±‚æ›¸',   icon:'ğŸ§¾', stage:'contract'},
  {id:'contract',  label:'å¥‘ç´„',     icon:'âœï¸', stage:'contract'},
  {id:'settlement',label:'æ±ºæ¸ˆ',     icon:'ğŸ’´', stage:'done'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CASES = [
  {id:'R042857', name:'ç”°ä¸­ é›„ä»‹', type:'reLet', corp:false, agent:'10012', tel:'09012345678',
   sub:'æ¸‹è°·åŒº 2LDK ã€œÂ¥220,000', step:'screening', age:3, stale:false,
   apps:[
     {id:'A001', prop:'æ¸‹è°·åŒºæ¡œä¸˜ 2LDK', mgmt:'ä¸‰äº•ä½å‹ç®¡ç†', date:'2026-02-18', status:'rejected'},
     {id:'A002', prop:'æ¸‹è°·åŒºä»£ã€…æœ¨ 2LDK', mgmt:'æ±æ€¥ãƒªãƒãƒ–ãƒ«ç®¡ç†', date:'2026-02-21', status:'reviewing'},
   ],
   dates:{naiken:'2026-02-17'}, hist:['2/17 å†…è¦‹å®Œäº†','2/18 ç”³è¾¼â†’å¯©æŸ»è½ã¡','2/21 åˆ¥ç‰©ä»¶ã§å†ç”³è¾¼'],
  },
  {id:'R039102', name:'æœ¨æ‘ å½©é¦™', type:'reLet', corp:false, agent:'10012', tel:'09087654321',
   sub:'å“å·åŒº 1K ã€œÂ¥85,000', step:'screening', age:1, stale:false,
   apps:[
     {id:'A010', prop:'å“å·åŒºå¤§å´ 1K', mgmt:'å¤§å´ç®¡ç†', date:'2026-02-21', status:'reviewing', sim:true},
     {id:'A011', prop:'å“å·åŒºäº”åç”° 1K', mgmt:'æ±æ€¥ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', date:'2026-02-21', status:'reviewing', sim:true},
   ],
   dates:{naiken:'2026-02-20'}, hist:['2/20 å†…è¦‹å®Œäº†','2/21 2ç‰©ä»¶åŒæ™‚ç”³è¾¼'],
  },
  {id:'R041003', name:'æ–è—¤ äº®', type:'reLet', corp:false, agent:'10023',
   sub:'æ–°å®¿åŒº 1LDK ã€œÂ¥130,000', step:'naiken', age:9, stale:true,
   apps:[], dates:{}, hist:['2/11 å•åˆã›å—ä¿¡'],
  },
  {id:'R044201', name:'æ©‹æœ¬ æ—©è‹—', type:'reLet', corp:false, agent:'10012',
   sub:'ç›®é»’åŒº 1LDK ã€œÂ¥150,000', step:'naiken', age:1, stale:false,
   apps:[], dates:{naiken:'2026-02-23'}, hist:['2/21 å†…è¦‹äºˆç´„: 2/23 10:00'],
  },
  {id:'R045500', name:'ä¼Šè—¤ ç¿”å¤ª', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK Â¥155,000', step:'invoice', age:2, stale:false,
   apps:[{id:'A020', prop:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK', mgmt:'æ±æ€¥ç®¡ç†', date:'2026-02-15', status:'approved'}],
   dates:{naiken:'2026-02-14', applied:'2026-02-15', approved:'2026-02-17', paid:'2026-02-20'}, adOnly:false, taskDone:{paid:true,itsetsu:false},
   hist:['2/14 å†…è¦‹','2/15 ç”³è¾¼','2/17 å¯©æŸ»é€šé','2/20 å…¥é‡‘ç¢ºèªæ¸ˆ'],
  },
  {id:'R047800', name:'æ ªå¼ä¼šç¤¾ã‚¿ãƒŠã‚«å•†äº‹', type:'reLet', corp:true, contactName:'ç”°ä¸­ ä¸€éƒ', agent:'10008',
   sub:'æ–°å®¿åŒº äº‹å‹™æ‰€ ã€œÂ¥250,000', step:'screening', age:0, stale:false,
   apps:[
     {id:'A060', prop:'æ–°å®¿åŒºè¥¿æ–°å®¿ 30åª', mgmt:'ä¸‰è±åœ°æ‰€ç®¡ç†', date:'2026-02-22', status:'reviewing', sim:true},
     {id:'A061', prop:'æ–°å®¿åŒºæ–°å®¿ 25åª', mgmt:'æ±æ€¥ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', date:'2026-02-22', status:'reviewing', sim:true},
   ],
   dates:{naiken:'2026-02-22'}, hist:['2/22 å†…è¦‹','2/22 2ç‰©ä»¶åŒæ™‚ç”³è¾¼ï¼ˆæ³•äººï¼‰'],
  },
  {id:'R038291', name:'æ¾æœ¬ æµ©äºŒ', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸‹è°·åŒº 2K Â¥170,000', step:'prekey', age:0, stale:false,
   apps:[{id:'A040', prop:'æ¸‹è°·åŒº 2K', mgmt:'æ±äº¬å»ºç‰©ç®¡ç†', date:'2026-02-08', status:'approved'}],
   dates:{naiken:'2026-02-07', applied:'2026-02-08', approved:'2026-02-12', paid:'2026-02-17', itsetsu:'2026-02-20', chinkaku:'2026-03-01'}, adOnly:false, taskDone:{paid:true,itsetsu:true},
   hist:['2/07 å†…è¦‹','2/08 ç”³è¾¼','2/12 å¯©æŸ»é€šé','2/17 å…¥é‡‘ç¢ºèª','2/20 ITé‡èª¬å®Œäº†'],
  },
  {id:'R049001', name:'å±±å´ å¥', type:'reLet', corp:false, agent:'10023',
   sub:'æ¸¯åŒº 1K Â¥110,000 ADæ¡ˆä»¶', step:'prekey', age:1, stale:false, adOnly:true,
   apps:[{id:'A080', prop:'æ¸¯åŒº 1K', mgmt:'æ±äº¬å»ºç‰©ç®¡ç†', date:'2026-02-21', status:'approved'}],
   dates:{naiken:'2026-02-20', applied:'2026-02-21', approved:'2026-02-22'}, taskDone:{paid:false,itsetsu:false},
   hist:['2/20 å†…è¦‹','2/21 ç”³è¾¼','2/22 å¯©æŸ»é€šéï¼ˆADæ¡ˆä»¶ï¼‰'],
  },
  {id:'R040011', name:'ä¸­æ‘ ç”±ç¾', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸¯åŒº 1R Â¥95,000', step:'done', age:0, stale:false,
   apps:[{id:'A050', prop:'æ¸¯åŒº 1R', mgmt:'ä½å‹ä¸å‹•ç”£ç®¡ç†', date:'2026-02-01', status:'approved'}],
   dates:{naiken:'2026-02-01', applied:'2026-02-01', approved:'2026-02-05', paid:'2026-02-10', itsetsu:'2026-02-15', chinkaku:'2026-03-01'},
   hist:['2/01 å†…è¦‹ãƒ»ç”³è¾¼','2/05 å¯©æŸ»é€šé','2/10 å…¥é‡‘','2/15 é‡èª¬','2/18 éµæ¸¡ã—å®Œäº†'],
  },
  {id:'R046001', name:'åŠ è—¤ ç¾å’²', type:'reLet', corp:false, agent:'10008',
   sub:'æ¸¯åŒºå—é’å±± 1LDK Â¥180,000', step:'cancel', age:0, stale:false,
   apps:[{id:'A030', prop:'æ¸¯åŒºå—é’å±± 1LDK', mgmt:'ä½å‹ä¸å‹•ç”£ç®¡ç†', date:'2026-02-10', status:'cancelled'}],
   dates:{naiken:'2026-02-09'}, hist:['2/09 å†…è¦‹','2/10 ç”³è¾¼','2/14 å¯©æŸ»é€šé','2/21 ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæœ¬äººéƒ½åˆï¼‰'],
  },
  {id:'S819204', name:'å‰ç”° å¤§è¼”', type:'reSale', corp:false, agent:'10008',
   sub:'ç›®é»’åŒº æˆ¸å»ºã¦ Â¥32,000,000', step:'contract', age:5, stale:false,
   salePrice:32000000,
   apps:[], dates:{naiken:'2026-02-10', offer:'2026-02-15', contract:'2026-02-20'},
   hist:['2/15 è²·ä»˜å—é ˜','2/20 å£²è²·å¥‘ç´„ç· çµ'],
  },

  {id:'S291047', name:'ç”°ä¸­ ç¾å’²', type:'reSale', corp:false, agent:'10012',
   sub:'æ¸¯åŒº ã‚¿ãƒ¯ãƒãƒ³ Â¥65,000,000', step:'offer', age:2, stale:false,
   salePrice:65000000,
   apps:[], dates:{offer:'2026-02-21'},
   hist:['2/21 å†…è¦‹ãªã—ãƒ»è²·ä»˜æå‡º'],
  },
  {id:'S104382', name:'æ¸¡è¾º å¥ä¸€', type:'reSale', corp:true, agent:'10008',
   sub:'æ¸‹è°·åŒº ãƒãƒ³ã‚·ãƒ§ãƒ³ Â¥28,500,000', step:'naiken', age:1, stale:false,
   salePrice:28500000,
   apps:[], dates:{naiken:'2026-02-22'},
   hist:['2/22 å†…è¦‹äºˆå®š'],
  },
  // â”€â”€ äººæç´¹ä»‹ ãƒ‡ãƒ¢ â”€â”€
  {id:'H00341', name:'éˆ´æœ¨ å¥ä¸€', type:'hr', corp:false, agent:'20005',
   sub:'ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ / å¹´å600ä¸‡ã€œ',
   step:'apply', age:5, stale:false, apps:[], dates:{},
   industry:'IT', position:'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', salary:'600',
   companies:[
     {id:'CO001', name:'æ ªå¼ä¼šç¤¾ãƒ†ã‚¯ãƒã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³', industry:'IT', position:'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
      salary:650, status:'interview', interviewCount:2, nextInterview:'2026-02-28',
      fee:0, startDate:'', notes:'2æ¬¡é¢æ¥ã¾ã§é€šéã€‚æŠ€è¡“è©¦é¨“ã‚ã‚Šã€‚'},
     {id:'CO002', name:'ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ ªå¼ä¼šç¤¾', industry:'IT', position:'ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
      salary:600, status:'screening', interviewCount:0, nextInterview:'',
      fee:0, startDate:'', notes:'æ›¸é¡é¸è€ƒä¸­'},
     {id:'CO003', name:'æ ªå¼ä¼šç¤¾ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹', industry:'IT', position:'ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
      salary:580, status:'rejected', interviewCount:1, nextInterview:'',
      fee:0, startDate:'', notes:'1æ¬¡é¢æ¥ã§ä¸æ¡ç”¨é€šçŸ¥'},
   ],
   hist:['2/17 æ¡ˆä»¶ç™»éŒ²','2/18 3ç¤¾ã«æ›¸é¡æå‡º','2/21 CO001 2æ¬¡é¢æ¥é€šé','2/22 CO003 ä¸æ¡ç”¨'],
  },
  {id:'H00389', name:'ç”°æ‘ çœŸç”±', type:'hr', corp:false, agent:'20005',
   sub:'Webãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ / å¹´å450ä¸‡ã€œ',
   step:'contract', age:2, stale:false, apps:[], dates:{},
   industry:'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–', position:'UIãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼', salary:'450',
   companies:[
     {id:'CO010', name:'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚¹ã‚¿ã‚¸ã‚ªæ ªå¼ä¼šç¤¾', industry:'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–', position:'UIãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼',
      salary:480, status:'accepted', interviewCount:3, nextInterview:'',
      fee:2100000, startDate:'2026-04-01', notes:'å†…å®šæ‰¿è«¾æ¸ˆã¿ã€‚å…¥ç¤¾æ—¥4/1ç¢ºå®šã€‚'},
     {id:'CO011', name:'æ ªå¼ä¼šç¤¾ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ã‚¹', industry:'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–', position:'Webãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼',
      salary:450, status:'withdrawn', interviewCount:2, nextInterview:'',
      fee:0, startDate:'', notes:'å†…å®šå¾Œè¾é€€'},
   ],
   hist:['2/10 æ¡ˆä»¶ç™»éŒ²','2/15 2ç¤¾ã«å¿œå‹Ÿ','2/20 CO010 å†…å®š','2/22 CO010 å†…å®šæ‰¿è«¾ãƒ»CO011 è¾é€€'],
  },
  {id:'H00412', name:'æœ¨æ‘ å¥ˆã€…', type:'hr', corp:false, agent:'20005',
   sub:'äººäº‹ / å¹´å500ä¸‡ã€œ',
   step:'naiken', age:1, stale:false, apps:[], dates:{},
   industry:'HRãƒ»ç®¡ç†', position:'äººäº‹', salary:'500',
   companies:[
     {id:'CO020', name:'ã‚°ãƒ­ãƒ¼ãƒãƒ«æ ªå¼ä¼šç¤¾', industry:'HRãƒ»ç®¡ç†', position:'äººäº‹æ‹…å½“',
      salary:520, status:'screening', interviewCount:0, nextInterview:'',
      fee:0, startDate:'', notes:'æ›¸é¡æå‡ºæ¸ˆã¿'},
   ],
   hist:['2/23 æ¡ˆä»¶ç™»éŒ²','2/23 1ç¤¾ã«æ›¸é¡æå‡º'],
  },];

let cur = null; // current case id

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stageOf(c) {
  const step = c.step;
  if (step==='done') return 'done';
  if (step==='cancel') return 'cancel';
  if (step==='naiken') return 'naiken';
  if (step==='apply'||step==='screening'||step==='offer'||step==='verify') return 'apply';
  if (step==='payment') return 'payment';
  if (step==='invoice'||step==='prekey'||step==='itsetsu'||step==='key'||step==='contract') return 'contract';
  if (step==='settlement') return 'done';
  if (step==='offer') return 'apply';
  return 'new';
}

function render() {
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: f-type ãŒç©ºãªã‚‰ reLet ã«ã‚»ãƒƒãƒˆ
  const ft = document.getElementById('f-type');
  if(ft && ft.value==='') ft.value='reLet';

  const tf = document.getElementById('f-type').value;
  // HQãƒ­ãƒ¼ãƒ«ã¯å…¨æ¡ˆä»¶è¡¨ç¤ºã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯è‡ªåˆ†ã®æ¡ˆä»¶ã®ã¿
  const _s = window._SESSION;
  const _isHQ = _s && _s.type === 'hq';
  let cs = _isHQ ? CASES : CASES.filter(c => c.agent === (_s ? _s.userId : '__none__'));
  if (tf) cs = cs.filter(c=>c.type===tf);

  const board = document.getElementById('board');
  board.innerHTML = STAGES.map(st=>{
    const cols = cs.filter(c=>stageOf(c)===st.id);
    const canAdd = st.id!=='done'&&st.id!=='cancel';
    return '<div class="col">'
      +'<div class="col-hdr">'
      +'<div class="col-title"><div class="col-dot" style="background:'+st.dot+'"></div>'+(tf==='hr'&&st.labelHR?st.labelHR:(tf!=='reLet'&&st.labelSale?st.labelSale:st.label))+'</div>'
      +'<span class="col-count" style="background:'+st.dot+'22;color:'+st.color+';border:1px solid '+st.dot+'55">'+cols.length+'</span>'
      +'</div>'
      +'<div class="col-body">'
      +cols.map(c=>cardHTML(c,st)).join('')
      +(canAdd?'<div class="add-row" onclick="openNewModal(\''+st.id+'\')">ï¼‹</div>':'')
      +'</div></div>';
  }).join('');

  document.getElementById('board-count').textContent = cs.length+' / '+CASES.length+' ä»¶';
}

function cardHTML(c, st) {
  const isCur = c.id===cur;
  const pendingApps = (c.apps||[]).filter(a=>a.status==='reviewing'||a.status==='submitted').length;
  const rejApps     = (c.apps||[]).filter(a=>a.status==='rejected').length;

  let badge = '';
  if (c.corp) badge += '<span class="pill pill-purple" style="font-size:7px">æ³•äºº</span> ';
  if (pendingApps>1) badge += '<span class="pill pill-orange" style="font-size:7px">åŒæ™‚'+pendingApps+'ä»¶</span>';
  if (rejApps>0 && c.step==='screening' && c.type==='reLet') badge += ' <span class="pill pill-red" style="font-size:7px">è½ã¡'+rejApps+'</span>';

  const ageEl = c.age===0
    ? '<span class="age" style="background:rgba(52,211,153,.1);color:var(--green)">æœ¬æ—¥</span>'
    : c.age>=7
    ? '<span class="age" style="background:rgba(248,113,113,.1);color:var(--red)">'+c.age+'æ—¥å‰</span>'
    : '<span class="age" style="background:rgba(74,82,112,.15);color:var(--sub)">'+c.age+'æ—¥å‰</span>';

  const typeEl = c.type==='reLet'?'ğŸ  è³ƒè²¸':c.type==='reSale'?'ğŸ¢ å£²è²·':c.type==='sannai'?'ğŸ”„ ä¸‰ç‚º':'ğŸ‘¥ äººæ';

  return '<div class="card'+(isCur?' active':'')+'" onclick="open_case(\''+c.id+'\')">'
    +(c.stale?'<div class="stale"></div>':'')
    +'<div class="card-type" style="color:'+st.color+'">'+typeEl+(badge?' '+badge:'')+'</div>'
    +'<div class="card-name">'+c.name+'</div>'
    +'<div class="card-sub">'+c.sub+'</div>'
    +'<div class="card-foot"><span class="card-id">'+c.id+'</span>'+ageEl+'</div>'
    +'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function open_case(id) {
  try {
  cur = id;
  const c = CASES.find(x=>x.id===id);
  if(!c) { console.error('open_case: not found', id); return; }
  if(!c.dates) c.dates = {};
  if(!c.hist)  c.hist  = [];
  if(!c.apps)  c.apps  = [];

  document.getElementById('panel').classList.add('open');

  // Header
  const corpBadge = c.corp ? ' <span class="pill pill-purple">æ³•äºº</span>' : '';
  document.getElementById('panel-top').innerHTML =
    '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px">'
    +'<div>'
    +'<div style="font-family:\'DM Mono\',monospace;font-size:10px;color:var(--muted);margin-bottom:2px">'+c.id+'</div>'
    +'<div style="font-size:16px;font-weight:800">'+c.name+corpBadge+'</div>'
    +(c.corp&&c.contactName?'<div style="font-size:11px;color:var(--sub);margin-top:1px">æ‹…å½“: '+c.contactName+'</div>':'')
    +'<div style="font-size:11px;color:var(--muted);margin-top:2px">'+c.sub+'</div>'
    +'</div>'
    +'<button class="btn btn-ghost btn-sm" onclick="close_panel()">âœ•</button>'
    +'</div>'
    + buildStepBar(c);

  buildStepContent(c);
  render();
  } catch(e) { console.error('open_case error:', e); toast('è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: '+e.message); }
}

function close_panel() {
  cur = null;
  document.getElementById('panel').classList.remove('open');
  render();
}

function buildStepBar(c) {
  const steps = c.type==='reLet' ? STEPS_RELET : c.type==='reSale' ? STEPS_RESALE : c.type==='sannai' ? STEPS_SANNAI : c.type==='hr' ? STEPS_HR : [];
  if (!steps.length) return '';
  const curIdx = steps.findIndex(s=>s.id===c.step);

  return '<div class="step-bar">'
    +steps.map((s,i)=>{
      const cls = i<curIdx?'done':i===curIdx?'active':'future';
      const inner = i<curIdx ? 'âœ“' : s.icon;
      // å®Œäº†æ¸ˆã¿ã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯ï¼ˆèª¤ã£ã¦å‰ã‚¹ãƒ†ãƒƒãƒ—ã«æˆ»ã‚‰ãªã„ã‚ˆã†ï¼‰
      // æœªæ¥ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ã‚¯ãƒªãƒƒã‚¯ã§å…ˆé€ã‚Šã§ãã‚‹
      if (i <= curIdx) {
        return '<div class="step-node '+cls+'" style="cursor:default">'
          +'<div class="step-circle">'+inner+'</div>'
          +'<div class="step-label">'+s.label+'</div>'
          +'</div>';
      }
      return '<div class="step-node '+cls+'" style="cursor:pointer" onclick="jumpStep(\''+c.id+'\',\''+s.id+'\')">'
          +'<div class="step-circle">'+inner+'</div>'
          +'<div class="step-label">'+s.label+'</div>'
          +'</div>';
    }).join('')
    +'</div>';
}

function buildStepContent(c) {
  const body = document.getElementById('panel-body');

  if (c.step==='done') {
    body.innerHTML = '<div class="done-card"><div class="done-icon">ğŸ‰</div>'
      +'<div class="done-title">æˆç´„å®Œäº†</div>'
      +'<div style="font-size:11px;color:var(--sub);margin-top:6px">'+(c.dates.chinkaku||'')+'</div>'
      +'</div>'+histHTML(c);
    return;
  }
  if (c.step==='cancel') {
    body.innerHTML = '<div class="cancel-card"><div style="font-size:32px">ğŸš«</div>'
      +'<div style="font-weight:700;margin-top:4px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div></div>'+histHTML(c)
      +'<div style="margin-top:12px"><button class="btn btn-ghost btn-sm" onclick="reactivate(\''+c.id+'\')">â†© å†é–‹</button></div>';
    return;
  }

  let html = '<div class="step-content">';

  // â”€â”€ è³ƒè²¸ãƒ•ãƒ­ãƒ¼ â”€â”€
  if (c.type==='reLet') {
    if (c.step==='naiken') html += stepNaiken(c);
    else if (c.step==='apply') html += stepApply(c);
    else if (c.step==='screening') html += stepScreening(c);
    else if (c.step==='invoice') html += stepInvoice(c);
    else if (c.step==='prekey') html += stepPrekey(c);
    else if (c.step==='payment') html += stepPayment(c);
    else if (c.step==='itsetsu') html += stepPrekey(c);
    else if (c.step==='key') html += stepKey(c);
  }
  // â”€â”€ ä¸‰ç‚ºãƒ•ãƒ­ãƒ¼ â”€â”€
  else if (c.type==='sannai') {
    if (c.step==='naiken') html += stepSaleNaiken(c);
    else if (c.step==='verify') html += stepSannaiVerify(c);
    else if (c.step==='offer') html += stepSannaiOffer(c);
    else if (c.step==='invoice') html += stepInvoice(c);
    else if (c.step==='contract') html += stepSannaiContract(c);
    else if (c.step==='settlement') html += stepSettlement(c);
  }
  // â”€â”€ å£²è²·ãƒ•ãƒ­ãƒ¼ â”€â”€
  else if (c.type==='reSale') {
    if (c.step==='naiken') html += stepSaleNaiken(c);
    else if (c.step==='offer') html += stepOffer(c);
    else if (c.step==='invoice') html += stepInvoice(c);
    else if (c.step==='contract') html += stepSaleContract(c);
    else if (c.step==='settlement'||c.step==='payment') html += stepSettlement(c);
  }

  // â”€â”€ äººæç´¹ä»‹ãƒ•ãƒ­ãƒ¼ â”€â”€
  else if (c.type==='hr') {
    html += stepHR(c);
  }

  html += '</div>';

  // è¤‡æ•°ç”³è¾¼ãƒªã‚¹ãƒˆï¼ˆscreeningæ™‚ = è³ƒè²¸ã®ã¿ï¼‰
  if (c.type==='reLet' && c.step==='screening' && c.apps.length>0) {
    html += '<div style="margin-top:12px">'+appsHTML(c)+'</div>';
  }

  html += histHTML(c);

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
  html += '<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">'
    +'<button class="btn btn-red btn-sm" onclick="cancelCase(\''+c.id+'\')">ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
    +'</div>';

  body.innerHTML = html;
}

// â”€â”€ STEP RENDERERS â”€â”€

function stepHR(c) {
  if (!c.companies) c.companies = [];
  const cos = c.companies;

  const STATUS_LABEL = {
    screening:'æ›¸é¡é¸è€ƒä¸­', interview:'é¢æ¥èª¿æ•´ä¸­', offered:'å†…å®š',
    accepted:'å†…å®šæ‰¿è«¾âœ…', rejected:'ä¸æ¡ç”¨', withdrawn:'è¾é€€'
  };
  const STATUS_COLOR = {
    screening:'var(--blue)', interview:'var(--orange)', offered:'var(--gold)',
    accepted:'var(--green)', rejected:'var(--red)', withdrawn:'var(--muted)'
  };
  const fmtFee = function(v){ return v ? 'Â¥'+parseInt(v).toLocaleString() : 'æœªå®š'; };

  var html = '<div class="step-title">ğŸ‘¥ äººæç´¹ä»‹ â€” å¿œå‹Ÿå…ˆç®¡ç†</div>';

  // å€™è£œè€…ã‚µãƒãƒªãƒ¼
  html += '<div style="background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:10px 12px;margin-bottom:12px;font-size:11px;line-height:1.9">';
  html += '<div><span style="color:var(--muted)">å€™è£œè€…ï¼š</span><strong>'+c.name+'</strong></div>';
  if(c.position) html += '<div><span style="color:var(--muted)">å¸Œæœ›è·ç¨®ï¼š</span>'+c.position+'</div>';
  if(c.salary)   html += '<div><span style="color:var(--muted)">å¸Œæœ›å¹´åï¼š</span>'+c.salary+'ä¸‡å††ã€œ</div>';
  html += '</div>';

  // å¿œå‹Ÿå…ˆãƒªã‚¹ãƒˆ
  html += '<div style="font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:6px">å¿œå‹Ÿå…ˆä¸€è¦§ï¼ˆ'+cos.length+'ç¤¾ï¼‰</div>';

  if (cos.length === 0) {
    html += '<div style="background:var(--bg);border:1px dashed var(--border2);border-radius:8px;padding:16px;text-align:center;font-size:11px;color:var(--muted);margin-bottom:10px">ã¾ã å¿œå‹Ÿå…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
  } else {
    cos.forEach(function(co, i) {
      const stCol = STATUS_COLOR[co.status] || 'var(--muted)';
      const stLabel = STATUS_LABEL[co.status] || co.status;
      const isActive = co.status !== 'rejected' && co.status !== 'withdrawn';
      html += '<div style="background:var(--bg);border:1px solid '+(isActive?'var(--border2)':'var(--border)')+';border-radius:8px;padding:10px 12px;margin-bottom:8px;opacity:'+(isActive?'1':'.55')+'">';
      html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">';
      html += '<strong style="font-size:12px">'+(co.name||'ä¼æ¥­åæœªè¨­å®š')+'</strong>';
      html += '<span style="font-size:10px;padding:2px 8px;border-radius:20px;background:'+stCol+'22;color:'+stCol+';border:1px solid '+stCol+'55">'+stLabel+'</span>';
      html += '</div>';
      if(co.position) html += '<div style="font-size:11px;color:var(--sub)">'+co.position+(co.salary?' / Â¥'+co.salary+'ä¸‡':'')+'</div>';
      if(co.interviewCount) html += '<div style="font-size:10px;color:var(--muted)">é¢æ¥ '+co.interviewCount+'æ¬¡ã¾ã§å®Œäº†</div>';
      if(co.notes) html += '<div style="font-size:10px;color:var(--muted);margin-top:2px">ğŸ“ '+co.notes+'</div>';
      if(co.status==='accepted') html += '<div style="font-size:10px;color:var(--green);margin-top:2px">å…¥ç¤¾äºˆå®šæ—¥ï¼š'+(co.startDate||'æœªå®š')+'ã€€æ‰‹æ•°æ–™ï¼š'+fmtFee(co.fee)+'</div>';
      // æ“ä½œãƒœã‚¿ãƒ³ï¼ˆçµ‚äº†æ¸ˆã¿ä»¥å¤–ï¼‰
      if(isActive) {
        html += '<div style="display:flex;gap:6px;margin-top:8px">';
        html += '<button class="btn btn-ghost btn-sm" style="flex:1;justify-content:center;font-size:10px" '
              + 'data-cid="'+c.id+'" data-coid="'+co.id+'" onclick="hrCoModal(this.dataset.cid,this.dataset.coid)">âœï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</button>';
        html += '<button class="btn btn-ghost btn-sm" style="color:var(--red);border-color:rgba(248,113,113,.3);font-size:10px" '
              + 'data-cid="'+c.id+'" data-coid="'+co.id+'" onclick="hrCoRemove(this.dataset.cid,this.dataset.coid)">ğŸ—‘</button>';
        html += '</div>';
      }
      html += '</div>';
    });
  }

  // å¿œå‹Ÿå…ˆè¿½åŠ ãƒœã‚¿ãƒ³
  html += '<button class="btn btn-ghost" style="width:100%;justify-content:center;margin-bottom:12px;border-style:dashed" '
        + 'data-cid="'+c.id+'" onclick="hrCoAdd(this.dataset.cid)">ï¼‹ å¿œå‹Ÿå…ˆã‚’è¿½åŠ </button>';

  // åœ¨ç±ç¢ºèªãƒ»æˆç´„ã‚¨ãƒªã‚¢ï¼ˆå†…å®šæ‰¿è«¾æ¸ˆã¿ã®ä¼æ¥­ãŒã‚ã‚‹å ´åˆï¼‰
  var accepted = cos.find(function(x){ return x.status==='accepted'; });
  if (c.step === 'payment') {
    html += '<div style="background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.25);border-radius:8px;padding:12px;font-size:11px;margin-bottom:10px">';
    html += 'âœ… å…¥ç¤¾å¾Œã®åœ¨ç±ç¢ºèªãŒå¿…è¦ã§ã™ã€‚åœ¨ç±ç¢ºèªå®Œäº†ã§ç¬¬2å›å ±é…¬ãŒç™ºç”Ÿã—ã¾ã™ã€‚</div>';
    html += '<button class="btn btn-ghost" style="width:100%;justify-content:center;margin-bottom:6px;border-color:rgba(248,113,113,.4);color:var(--red)" data-cid="'+c.id+'" onclick="openQuitModal(this.dataset.cid)">âš ï¸ é€€è·ã‚’å ±å‘Šã™ã‚‹</button>';
    html += '<button class="btn btn-green" style="width:100%;justify-content:center" data-cid="'+c.id+'" onclick="hrAdvance(this.dataset.cid,\'done\')">åœ¨ç±ç¢ºèªå®Œäº† â†’ æˆç´„</button>';
  } else if (c.step === 'contract' && accepted) {
    html += '<div style="background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.25);border-radius:8px;padding:12px;font-size:11px;margin-bottom:10px">';
    html += '<strong style="color:var(--green)">'+accepted.name+'</strong> ã¸ã®å†…å®šæ‰¿è«¾ãŒç¢ºå®šã—ã¦ã„ã¾ã™ã€‚<br>';
    html += 'å…¥ç¤¾æ—¥ï¼š'+(accepted.startDate||'æœªå®š')+'ã€€æ‰‹æ•°æ–™ï¼š'+fmtFee(accepted.fee)+'</div>';
    html += '<button class="btn btn-green" style="width:100%;justify-content:center" data-cid="'+c.id+'" onclick="hrAdvance(this.dataset.cid,\'payment\')">å…¥ç¤¾ç¢ºèª â†’ åœ¨ç±ç¢ºèªã¸</button>';
    html += '<button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;margin-top:6px;border-color:rgba(248,113,113,.3);color:var(--red)" data-cid="'+c.id+'" onclick="openQuitModal(this.dataset.cid)">âš ï¸ æ—©æœŸé€€è·ãƒ•ã‚©ãƒ­ãƒ¼ã‚’è¨˜éŒ²</button>';
  }

  return html;
}

// â”€â”€ å¿œå‹Ÿå…ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€
function hrCoModal(cid, coId) {
  const c = CASES.find(x=>x.id===cid); if(!c) return;
  if(!c.companies) c.companies=[];
  const co = c.companies.find(x=>x.id===coId); if(!co) return;

  const STATUS_OPTS = [
    {v:'screening', l:'ğŸ“‹ æ›¸é¡é¸è€ƒä¸­'},
    {v:'interview', l:'ğŸ“… é¢æ¥èª¿æ•´ä¸­'},
    {v:'offered',   l:'ğŸ‰ å†…å®š'},
    {v:'accepted',  l:'âœ… å†…å®šæ‰¿è«¾'},
    {v:'rejected',  l:'âŒ ä¸æ¡ç”¨'},
    {v:'withdrawn', l:'ğŸ”™ è¾é€€'},
  ];

  const overlay = document.createElement('div');
  overlay.id = 'hr-co-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';
  overlay.innerHTML = `
    <div style="background:#11141f;border:1px solid #2a3050;border-radius:16px;width:min(420px,100%);max-height:90vh;overflow-y:auto;font-family:inherit">
      <div style="padding:16px 20px;border-bottom:1px solid #1e2235;display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:14px;font-weight:700;color:#e8eaf0">${co.name}</div>
          <div style="font-size:10px;color:#5a6080;margin-top:2px">${co.position||'ãƒã‚¸ã‚·ãƒ§ãƒ³æœªè¨­å®š'}</div>
        </div>
        <button onclick="document.getElementById('hr-co-overlay').remove()" style="background:transparent;border:none;color:#5a6080;cursor:pointer;font-size:18px">âœ•</button>
      </div>
      <div style="padding:18px 20px">
        <div class="fi">
          <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="hco-status" style="width:100%;background:#090b13;border:1px solid #2a3050;border-radius:8px;padding:9px 10px;color:#e8eaf0;font-family:inherit;font-size:12px">
            ${STATUS_OPTS.map(o=>'<option value="'+o.v+'"'+(o.v===co.status?' selected':'')+'>'+o.l+'</option>').join('')}
          </select>
        </div>
        <div class="fi">
          <label>ä¼æ¥­å</label>
          <input type="text" id="hco-name" value="${co.name||''}" placeholder="æ ªå¼ä¼šç¤¾ãƒ†ã‚¯ãƒ">
        </div>
        <div class="fi">
          <label>ãƒã‚¸ã‚·ãƒ§ãƒ³</label>
          <input type="text" id="hco-position" value="${co.position||''}" placeholder="ä¾‹: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢">
        </div>
        <div class="fi">
          <label>æƒ³å®šå¹´åï¼ˆä¸‡å††ï¼‰</label>
          <input type="number" id="hco-salary" value="${co.salary||''}" placeholder="ä¾‹: 600">
        </div>
        <div class="fi">
          <label>é¢æ¥å›æ•°</label>
          <input type="number" id="hco-interview-count" value="${co.interviewCount||''}" min="0" max="10" placeholder="ä¾‹: 2">
        </div>
        <div class="fi">
          <label>æ¬¡å›é¢æ¥æ—¥</label>
          <input type="date" id="hco-next-interview" value="${co.nextInterview||''}">
        </div>
        <div id="hco-accept-area" style="${co.status==='accepted'||co.status==='offered'?'':'display:none'}">
          <div class="fi">
            <label>å…¥ç¤¾äºˆå®šæ—¥</label>
            <input type="date" id="hco-start-date" value="${co.startDate||''}">
          </div>
          <div class="fi">
            <label>æ‰‹æ•°æ–™ï¼ˆç¨è¾¼ãƒ»å††ï¼‰</label>
            <input type="number" id="hco-fee" value="${co.fee||''}" placeholder="ä¾‹: 2100000">
          </div>
        </div>
        <div class="fi">
          <label>ãƒ¡ãƒ¢</label>
          <input type="text" id="hco-notes" value="${co.notes||''}" placeholder="é¢æ¥ã®æ‰€æ„Ÿãªã©">
        </div>
        <script>document.getElementById('hco-status').addEventListener('change',function(){
          document.getElementById('hco-accept-area').style.display=this.value==='accepted'||this.value==='offered'?'':'none';
        });<\/script>
        <div style="display:flex;gap:8px;margin-top:4px">
          <button onclick="document.getElementById('hr-co-overlay').remove()" style="flex:1;background:transparent;border:1px solid #2a3050;color:#a0a8c0;border-radius:8px;padding:10px;cursor:pointer;font-family:inherit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button data-cid="${cid}" data-coid="${coId}" onclick="hrCoSave(this.dataset.cid,this.dataset.coid)" style="flex:2;background:rgba(201,168,76,.12);border:1px solid rgba(201,168,76,.35);color:#c9a840;border-radius:8px;padding:10px;cursor:pointer;font-family:inherit;font-weight:700">ä¿å­˜</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

// å¿œå‹Ÿå…ˆä¿å­˜
function hrCoSave(cid, coId) {
  const c = CASES.find(x=>x.id===cid); if(!c) return;
  if(!c.companies) c.companies=[];
  const co = c.companies.find(x=>x.id===coId); if(!co) return;

  const oldStatus = co.status;
  co.status        = document.getElementById('hco-status')?.value || co.status;
  co.name          = document.getElementById('hco-name')?.value.trim() || co.name;
  co.position      = document.getElementById('hco-position')?.value.trim() || '';
  co.salary        = parseInt(document.getElementById('hco-salary')?.value) || 0;
  co.interviewCount= parseInt(document.getElementById('hco-interview-count')?.value) || 0;
  co.nextInterview = document.getElementById('hco-next-interview')?.value || '';
  co.startDate     = document.getElementById('hco-start-date')?.value || '';
  co.fee           = parseInt(document.getElementById('hco-fee')?.value) || 0;
  co.notes         = document.getElementById('hco-notes')?.value.trim() || '';

  if(!c.hist) c.hist=[];
  if(co.status !== oldStatus) {
    const STATUS_LABEL={screening:'æ›¸é¡é¸è€ƒä¸­',interview:'é¢æ¥èª¿æ•´ä¸­',offered:'å†…å®š',accepted:'å†…å®šæ‰¿è«¾',rejected:'ä¸æ¡ç”¨',withdrawn:'è¾é€€'};
    c.hist.push(today()+' '+co.name+' â†’ '+STATUS_LABEL[co.status]);
  }

  // å†…å®šæ‰¿è«¾ã§æ¡ˆä»¶å…¨ä½“ã‚’ contract ã¸
  hrAutoStep(c);

  document.getElementById('hr-co-overlay')?.remove();
  render();
  open_case(cid);
}

// å¿œå‹Ÿå…ˆè¿½åŠ 
function hrCoAdd(cid) {
  const c = CASES.find(x=>x.id===cid); if(!c) return;
  if(!c.companies) c.companies=[];
  // æ–°è¦ã¨ã—ã¦ç©ºã®ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  const newCo = {
    id:'CO'+String(Date.now()).slice(-6),
    name:'', industry:'', position:'', salary:0,
    status:'screening', interviewCount:0, nextInterview:'',
    fee:0, startDate:'', notes:''
  };
  c.companies.push(newCo);
  render();
  open_case(cid);
  // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  setTimeout(function(){ hrCoModal(cid, newCo.id); }, 50);
}

// å¿œå‹Ÿå…ˆå‰Šé™¤
function hrCoRemove(cid, coId) {
  if(!confirm('ã“ã®å¿œå‹Ÿå…ˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const c = CASES.find(x=>x.id===cid); if(!c) return;
  if(!c.companies) return;
  c.companies = c.companies.filter(x=>x.id!==coId);
  hrAutoStep(c);
  render();
  open_case(cid);
}

// æ¡ˆä»¶å…¨ä½“ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¿œå‹Ÿå…ˆã®çŠ¶æ³ã‹ã‚‰è‡ªå‹•æ›´æ–°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é€€è·å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆâ†’HQé€ä¿¡â†’Slackï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openQuitModal(cid) {
  const c = CASES.find(x => x.id === cid);
  if (!c) return;

  const accepted = (c.companies||[]).find(x => x.status === 'accepted');
  const companyName = accepted ? accepted.name : (c.company || 'â€”');
  const startDate   = accepted ? (accepted.startDate || '') : '';
  const feeStr      = accepted ? (accepted.fee ? 'Â¥' + parseInt(accepted.fee).toLocaleString() : '') : '';

  const REASONS = [
    'æœ¬äººéƒ½åˆï¼ˆå®¶åº­ãƒ»ä½“èª¿ï¼‰',
    'æœ¬äººéƒ½åˆï¼ˆå¾…é‡ãƒ»ç’°å¢ƒã¸ã®ä¸æº€ï¼‰',
    'æœ¬äººéƒ½åˆï¼ˆä»–ç¤¾å†…å®šï¼‰',
    'ä¼šç¤¾éƒ½åˆï¼ˆè©¦ç”¨æœŸé–“æº€äº†ï¼‰',
    'ä¼šç¤¾éƒ½åˆï¼ˆæ¥­ç¸¾æ‚ªåŒ–ãƒ»ãƒªã‚¹ãƒˆãƒ©ï¼‰',
    'ãã®ä»–',
  ];

  const overlay = document.createElement('div');
  overlay.id = 'quit-modal-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';

  overlay.innerHTML = `
    <div style="background:#11141f;border:1px solid #3a1f1f;border-radius:16px;width:min(460px,100%);max-height:92vh;overflow-y:auto;font-family:inherit">
      <div style="padding:16px 20px;border-bottom:1px solid #2a1515;display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:15px;font-weight:800;color:#f87171;font-family:'Syne',sans-serif">âš ï¸ é€€è·å ±å‘Š</div>
          <div style="font-size:10px;color:#a06060;margin-top:2px">${c.name} â€” ${companyName}</div>
        </div>
        <button onclick="document.getElementById('quit-modal-overlay').remove()" style="background:transparent;border:none;color:#7a5050;cursor:pointer;font-size:18px;padding:4px 8px">âœ•</button>
      </div>
      <div style="padding:20px">

        <!-- åŸºæœ¬æƒ…å ±ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ -->
        <div style="background:#0d0a0a;border:1px solid #2a1515;border-radius:8px;padding:12px;margin-bottom:16px;font-size:11px;line-height:2;color:#c0a0a0">
          <div><span style="color:#7a5050">å€™è£œè€…ï¼š</span><strong style="color:#f0e0e0">${c.name}</strong></div>
          <div><span style="color:#7a5050">å…¥ç¤¾ä¼æ¥­ï¼š</span>${companyName}</div>
          ${startDate ? '<div><span style="color:#7a5050">å…¥ç¤¾æ—¥ï¼š</span>' + startDate + '</div>' : ''}
          ${feeStr ? '<div><span style="color:#7a5050">æ‰‹æ•°æ–™ï¼š</span>' + feeStr + '</div>' : ''}
        </div>

        <!-- é€€è·æ—¥ -->
        <div class="fi">
          <label style="color:#f87171">é€€è·æ—¥ <span style="color:#f87171">*</span></label>
          <input type="date" id="qm-quit-date" style="background:#0d0a0a;border-color:#3a1f1f;color:#f0e0e0">
        </div>

        <!-- é€€è·ç†ç”± -->
        <div class="fi">
          <label style="color:#f87171">é€€è·ç†ç”± <span style="color:#f87171">*</span></label>
          <select id="qm-reason" style="width:100%;background:#0d0a0a;border:1px solid #3a1f1f;border-radius:8px;padding:9px 10px;color:#f0e0e0;font-family:inherit;font-size:12px">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            ${REASONS.map(r => '<option value="' + r + '">' + r + '</option>').join('')}
          </select>
        </div>

        <!-- è¿”é‡‘é¡ -->
        <div class="fi">
          <label>è¿”é‡‘äºˆå®šé¡ï¼ˆç¨è¾¼ãƒ»å††ï¼‰</label>
          <input type="number" id="qm-refund" placeholder="ä¾‹: 1050000ã€€â€»ä¿è¨¼è¦å®šã«åŸºã¥ãè¨ˆç®—" style="background:#0d0a0a;border-color:#3a1f1f;color:#f0e0e0">
        </div>

        <!-- é€€è·æœˆæ•°ï¼ˆåœ¨ç±ç¢ºèªç”¨ï¼‰ -->
        <div class="fi">
          <label>åœ¨ç±æœŸé–“ï¼ˆãƒ¶æœˆï¼‰</label>
          <input type="number" id="qm-months" min="0" max="24" placeholder="ä¾‹: 3" style="background:#0d0a0a;border-color:#3a1f1f;color:#f0e0e0">
        </div>

        <!-- è©³ç´°ãƒ¡ãƒ¢ -->
        <div class="fi">
          <label>è©³ç´°ãƒ»çµŒç·¯ï¼ˆHQã¸ã®ç”³ã—é€ã‚Šï¼‰</label>
          <textarea id="qm-notes" rows="3" placeholder="å€™è£œè€…ã‹ã‚‰èã„ãŸçµŒç·¯ãƒ»ä¼æ¥­å´ã®åå¿œãƒ»å¯¾å¿œçŠ¶æ³ãªã©"
            style="width:100%;background:#0d0a0a;border:1px solid #3a1f1f;border-radius:8px;padding:9px 10px;color:#f0e0e0;font-family:inherit;font-size:12px;resize:vertical;box-sizing:border-box"></textarea>
        </div>

        <!-- æ³¨æ„æ›¸ã -->
        <div style="background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.2);border-radius:8px;padding:10px 12px;font-size:10px;color:#c08080;line-height:1.8;margin-bottom:16px">
          é€ä¿¡å¾Œã€HQã®Slackã«é€šçŸ¥ãŒå±Šãã¾ã™ã€‚è¿”é‡‘å‡¦ç†ãƒ»ä¿è¨¼å¯¾å¿œã¯HQãŒ early-quit ç®¡ç†ãƒšãƒ¼ã‚¸ã§è¡Œã„ã¾ã™ã€‚
        </div>

        <div style="display:flex;gap:8px">
          <button onclick="document.getElementById('quit-modal-overlay').remove()"
            style="flex:1;background:transparent;border:1px solid #2a1515;color:#a06060;border-radius:8px;padding:11px;cursor:pointer;font-family:inherit">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button data-cid="${cid}" onclick="submitQuitReport(this.dataset.cid)"
            style="flex:2;background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.4);color:#f87171;border-radius:8px;padding:11px;cursor:pointer;font-family:inherit;font-weight:700">
            âš ï¸ HQã«é€ä¿¡ãƒ»Slacké€šçŸ¥
          </button>
        </div>
      </div>
    </div>`;

  document.body.appendChild(overlay);
  setTimeout(() => document.getElementById('qm-quit-date')?.focus(), 100);
}

function submitQuitReport(cid) {
  const c = CASES.find(x => x.id === cid);
  if (!c) return;

  const quitDate = document.getElementById('qm-quit-date')?.value;
  const reason   = document.getElementById('qm-reason')?.value;
  if (!quitDate) { alert('é€€è·æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!reason)   { alert('é€€è·ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

  const refund = document.getElementById('qm-refund')?.value;
  const months = document.getElementById('qm-months')?.value;
  const notes  = document.getElementById('qm-notes')?.value.trim();

  const accepted = (c.companies||[]).find(x => x.status === 'accepted');
  const companyName = accepted ? accepted.name : (c.company || 'â€”');
  const feeStr = accepted && accepted.fee ? 'Â¥' + parseInt(accepted.fee).toLocaleString() : 'æœªç™»éŒ²';
  const refundStr = refund ? 'Â¥' + parseInt(refund).toLocaleString() : 'æœªå®š';
  const u = window._SESSION || {};

  // æ¡ˆä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  c.quitDate   = quitDate;
  c.quitReason = reason;
  c.quitRefund = refund ? parseInt(refund) : 0;
  c.quitMonths = months ? parseInt(months) : 0;
  c.quitNotes  = notes;
  c.quitStatus = 'reported';  // HQç¢ºèªå¾…ã¡
  if (!c.hist) c.hist = [];
  c.hist.push(today() + ' âš ï¸ é€€è·å ±å‘Šé€ä¿¡ï¼ˆ' + reason + 'ï¼‰');

  // å†…å®šæ‰¿è«¾ä¼æ¥­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
  if (accepted) {
    accepted.status = 'resigned';
    accepted.notes  = (accepted.notes ? accepted.notes + ' / ' : '') + 'é€€è·: ' + quitDate;
  }

  // Slack é€šçŸ¥ â†’ #æ—©æœŸé€€è·å ±å‘Š
  slackSend(SLACK_CH.é€€è·å ±å‘Š, [
    ...slackHeader('âš ï¸', 'æ—©æœŸé€€è·å ±å‘Š'),
    'ğŸ†” *æ¡ˆä»¶ID*ï¼š' + c.id,
    'ğŸ‘¤ *å€™è£œè€…*ï¼š' + c.name,
    'ğŸ¢ *å…¥ç¤¾ä¼æ¥­*ï¼š' + companyName,
    'ğŸ“… *é€€è·æ—¥*ï¼š' + quitDate + (months ? 'ï¼ˆåœ¨ç± ' + months + 'ãƒ¶æœˆï¼‰' : ''),
    'ğŸ“‹ *é€€è·ç†ç”±*ï¼š' + reason,
    'ğŸ’¸ *æ‰‹æ•°æ–™*ï¼š' + feeStr,
    'ğŸ’´ *è¿”é‡‘äºˆå®šé¡*ï¼š' + refundStr,
    notes ? 'ğŸ“ *çµŒç·¯ãƒ»ç”³ã—é€ã‚Š*ï¼š' + notes : null,
    'ğŸ‘¨â€ğŸ’¼ *å ±å‘Šè€…*ï¼š' + (u.name || u.userId || 'â€”'),
    ...slackFooter(),
  ]);

  document.getElementById('quit-modal-overlay')?.remove();
  render();
  open_case(cid);
  toast('âš ï¸ é€€è·å ±å‘Šã‚’HQã«é€ä¿¡ã—ã¾ã—ãŸ');
}

function hrAutoStep(c) {
  if(!c.companies || !c.companies.length) return;
  const cos = c.companies;
  const hasAccepted = cos.some(x=>x.status==='accepted');
  const hasActive   = cos.some(x=>x.status==='interview'||x.status==='offered'||x.status==='screening');

  if(hasAccepted && c.step !== 'payment' && c.step !== 'done') {
    c.step = 'contract';
  } else if(!hasAccepted && hasActive && (c.step==='naiken'||c.step==='new')) {
    c.step = 'apply';
  }
}


function hrAdvance(id, nextStep) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.dates) c.dates = {};
  if(!c.hist)  c.hist  = [];
  const stepLabels = {apply:'é¢æ¥èª¿æ•´',contract:'å†…å®šãƒ»å…¥ç¤¾',payment:'åœ¨ç±ç¢ºèª',done:'å®Œäº†'};
  c.step = nextStep;
  c.hist.push(today()+' â†’ '+stepLabels[nextStep]);
  // Update HR-specific fields if provided
  const startInput = document.getElementById('hr-actual-start');
  if(startInput && startInput.value) c.startDate = startInput.value;
  const feeInput = document.getElementById('hr-fee-confirm');
  if(feeInput && feeInput.value) c.feeHR = parseInt(feeInput.value);
  render(); open_case(id);
}

function hrBatchClose(id) {
  location.href = 'coreto-batch-close.html';
}

function stepNaiken(c) {
  const today = new Date().toISOString().slice(0,10);
  const dateVal = c.dates.naiken || today;
  return '<div class="step-title">ğŸ  å†…è¦‹</div>'
    +'<div class="fi"><label>å†…è¦‹æ—¥</label><input type="date" id="s-naiken-date" class="mono" value="'+dateVal+'"></div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-naiken-prop" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 1LDK" value="'+(c.dates.naikenProp||'')+'"></div>'
    +'<button class="btn btn-ghost" style="width:100%;justify-content:center;margin-top:10px;border-color:var(--gold);color:var(--gold)" onclick="launchNaikenPage(\''+c.id+'\')">ğŸ“„ å†…è¦‹ä¾é ¼æ›¸ã‚’ç™ºè¡Œï¼ˆFAXå°åˆ·ï¼‰</button>'
    +'<div class="row" style="margin-top:8px">'
    +'<button class="btn btn-green" onclick="naikenDone(\''+c.id+'\')">âœ“ å†…è¦‹å®Œäº† â†’ ç”³è¾¼ã¸</button>'
    +'<button class="btn btn-red" onclick="naikenSkip(\''+c.id+'\')">è¦‹é€ã‚Š</button>'
    +'</div>';
}

function stepApply(c) {
  const today = new Date().toISOString().slice(0,10);
  return '<div class="step-title">ğŸ“‹ ç”³è¾¼</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-prop" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 1LDK"></div>'
    +'<div class="fi"><label>ç®¡ç†ä¼šç¤¾</label><input type="text" id="s-mgmt" placeholder="ã€‡ã€‡ç®¡ç†æ ªå¼ä¼šç¤¾"></div>'
    +'<div class="fi"><label>ç”³è¾¼æ—¥</label><input type="date" id="s-apply-date" class="mono" value="'+today+'"></div>'
    +'<button class="btn btn-green" style="width:100%;justify-content:center;margin-top:14px" onclick="submitApply(\''+c.id+'\')">ç”³è¾¼æ¸ˆã¿ã«ã™ã‚‹ â†’</button>'
    +'<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border2)">'
    +'<button class="btn btn-ghost" style="width:100%;justify-content:center;border-color:var(--gold);color:var(--gold);font-size:11px" data-cid="'+c.id+'" onclick="launchNaikenFromStep(this.dataset.cid)">ğŸ“„ åˆ¥ç‰©ä»¶ã®å†…è¦‹ä¾é ¼æ›¸ã‚’ç™ºè¡Œ</button>'
    +'</div>';
}

function stepScreening(c) {
  const activeApps = c.apps.filter(a=>a.status==='reviewing'||a.status==='submitted');
  const rejApps    = c.apps.filter(a=>a.status==='rejected');

  let html = '<div class="step-title">â³ å¯©æŸ»ä¸­</div>';

  if (activeApps.length===0 && rejApps.length>0) {
    html += '<div style="background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:8px;padding:10px;margin-bottom:12px;font-size:11px;color:var(--red)">å…¨ç‰©ä»¶ã§å¯©æŸ»è½ã¡</div>';
    html += '<button class="btn btn-blue" style="width:100%;justify-content:center" onclick="addApp(\''+c.id+'\')">ï¼‹ åˆ¥ç‰©ä»¶ã§å†ç”³è¾¼</button>';
    return html;
  }

  html += activeApps.map(a=>
    '<div class="app-item active-app" style="margin-bottom:8px">'
    +'<div class="app-name"><span>'+a.prop+'</span>'+(a.sim?'<span class="pill pill-orange">åŒæ™‚</span>':'')+'</div>'
    +'<div style="display:flex;gap:6px;margin-top:8px">'
    +'<button class="btn btn-green btn-sm" onclick="appPassed(\''+c.id+'\',\''+a.id+'\')">å¯©æŸ»é€šé â†’</button>'
    +'<button class="btn btn-red btn-sm" onclick="appRejected(\''+c.id+'\',\''+a.id+'\')">è½ã¡</button>'
    +'</div></div>'
  ).join('');

  html += '<button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;margin-top:4px" onclick="addApp(\''+c.id+'\')">ï¼‹ è¿½åŠ ç”³è¾¼</button>';
  html += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border2)">'
    +'<button class="btn btn-ghost" style="width:100%;justify-content:center;border-color:var(--gold);color:var(--gold);font-size:11px" data-cid="'+c.id+'" onclick="launchNaikenFromStep(this.dataset.cid)">ğŸ“„ åˆ¥ç‰©ä»¶ã®å†…è¦‹ä¾é ¼æ›¸ã‚’ç™ºè¡Œ</button>'
    +'</div>';
  html += bookingLinkBlock(c);
  return html;
}

function stepPrekey(c) {
  const td = c.taskDone || {};
  const ad = c.adOnly || false;
  const paidOk   = td.paid || false;
  const setsuOk  = td.itsetsu || false;
  const canKey   = setsuOk && (paidOk || ad);

  // â”€â”€ é‡èª¬æ—¥ç¨‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç”Ÿæˆ â”€â”€
  function itScheduleBlock() {
    const bk = c.itBooking;
    if (bk && bk.date) {
      const WD = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
      const d = new Date(bk.date + 'T00:00:00');
      const fmtd = (d.getMonth()+1) + '/' + d.getDate() + 'ï¼ˆ' + WD[d.getDay()] + 'ï¼‰';
      return '<div style="background:rgba(45,212,191,.06);border:1px solid rgba(45,212,191,.25);border-radius:8px;padding:12px 14px;margin-bottom:12px;font-size:11px;line-height:1.9">'
        + '<div style="font-size:10px;color:rgba(45,212,191,.8);letter-spacing:.08em;margin-bottom:6px">ğŸ“… ITé‡èª¬ æ—¥ç¨‹ç¢ºå®š</div>'
        + '<div><span style="color:var(--muted)">æ—¥æ™‚ï¼š</span><strong style="color:var(--teal)">' + fmtd + 'ã€€' + bk.time + 'ï¼ˆ' + (bk.dur||60) + 'åˆ†ï¼‰</strong></div>'
        + '<div><span style="color:var(--muted)">é‡èª¬æ‹…å½“ï¼š</span>' + (bk.agentName||'â€”') + '</div>'
        + '<div style="margin-top:6px;font-family:var(--mono,monospace);font-size:10px;word-break:break-all;color:#2dd4bf">ğŸ¥ ' + (bk.meetUrl||'â€”') + '</div>'
        + '<button style="margin-top:8px;width:100%;background:transparent;border:1px solid rgba(45,212,191,.25);border-radius:6px;padding:6px;color:rgba(45,212,191,.8);cursor:pointer;font-size:10px;font-family:inherit" data-cid="' + c.id + '" onclick="copyMeetLink(this.dataset.cid)">ğŸ“‹ Meet URLã‚’ã‚³ãƒ”ãƒ¼</button>'
        + '</div>';
    }
    // æœªäºˆç´„ - â‘¥ buildBookingUrl()ã«çµ±ä¸€ï¼ˆtel/dedicatedId/trackingNoå«ã‚€ï¼‰
    const bookingUrl = c.bookingUrl || buildBookingUrl(c);
    return '<div style="background:rgba(201,168,76,.05);border:1px solid rgba(201,168,76,.2);border-radius:8px;padding:12px 14px;margin-bottom:12px">'
      + '<div style="font-size:10px;color:var(--gold-dim,#7a5f22);letter-spacing:.08em;margin-bottom:8px">ğŸ“… ITé‡èª¬ æ—¥ç¨‹èª¿æ•´</div>'
      + '<div style="font-size:11px;color:var(--sub);margin-bottom:10px">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’é€ä»˜ã—ã¦ãã ã•ã„ã€‚ã‚¹ãƒ­ãƒƒãƒˆé¸æŠå¾Œã€è‡ªå‹•ã§ãƒãƒƒãƒãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚</div>'
      + '<div style="background:var(--card2);border:1px solid var(--border2);border-radius:6px;padding:8px 10px;font-size:10px;word-break:break-all;font-family:monospace;color:var(--blue);margin-bottom:8px">' + bookingUrl + '</div>'
      + '<div style="display:flex;gap:6px">'
      + '<button class="btn btn-ghost" style="flex:1;justify-content:center;font-size:11px" data-url="' + bookingUrl + '" onclick="copyBookingUrl(this)">ğŸ“‹ ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>'
      + '<button class="btn btn-ghost" style="flex:1;justify-content:center;font-size:11px" data-cid="' + c.id + '" onclick="checkItBooking(this.dataset.cid)">ğŸ”„ äºˆç´„ç¢ºèª</button>'
      + '</div></div>';
  }

  function taskRow(done, label, onclick) {
    if (done) return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;'
      +'background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.2);border-radius:8px;margin-bottom:8px">'
      +'<span style="font-size:16px">âœ…</span><span style="font-size:12px;color:var(--green);font-weight:700">'+label+'</span></div>';
    return '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;'
      +'background:var(--card2);border:1px solid var(--border);border-radius:8px;margin-bottom:8px">'
      +'<span style="font-size:12px">'+label+'</span>'
      +'<button class="btn btn-green btn-sm" onclick="'+onclick+'">å®Œäº†</button></div>';
  }

  let h = itScheduleBlock() + '<div class="step-title">ğŸ“ é‡èª¬ãƒ»å…¥é‡‘</div>';
  h += taskRow(setsuOk, 'ITé‡èª¬ãƒ»å¥‘ç´„',
    "openItSetsuAndConfirm('"+c.id+"')");
  if (!ad) {
    // å…¥é‡‘ç¢ºèªã¯æœ¬éƒ¨ã®ã¿å®Ÿè¡Œå¯èƒ½
    const _isHQLocal = window._SESSION && window._SESSION.type === 'hq';
    if (paidOk) {
      h += '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;'
        +'background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.2);border-radius:8px;margin-bottom:8px">'
        +'<span style="font-size:16px">âœ…</span>'
        +'<div><div style="font-size:12px;color:var(--green);font-weight:700">å…¥é‡‘ç¢ºèªæ¸ˆ</div>'
        +(c.dates.paid ? '<div style="font-size:10px;color:var(--muted)">æŒ¯è¾¼æ—¥: '+c.dates.paid+'</div>' : '')
        +'</div></div>';
    } else if (_isHQLocal) {
      h += '<button class="btn btn-green btn-sm" style="width:100%;justify-content:center;margin-bottom:8px" '
        +'onclick="openPaymentConfirmModal(\''+c.id+'\')">ğŸ’° å…¥é‡‘ç¢ºèªï¼ˆæœ¬éƒ¨ï¼‰</button>';
    } else {
      h += '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;'
        +'background:rgba(79,156,249,.05);border:1px solid rgba(79,156,249,.15);border-radius:8px;margin-bottom:8px">'
        +'<span style="font-size:16px">â³</span>'
        +'<div><div style="font-size:12px;color:var(--sub)">å…¥é‡‘å¾…ã¡</div>'
        +'<div style="font-size:10px;color:var(--muted)">å…¥é‡‘ç¢ºèªã¯æœ¬éƒ¨ãŒè¡Œã„ã¾ã™</div>'
        +'</div></div>';
    }
  } else {
    h += '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;'
      +'background:rgba(251,146,60,.06);border:1px solid rgba(251,146,60,.2);border-radius:8px;margin-bottom:8px">'
      +'<span style="font-size:12px;color:var(--orange)">ğŸ’´ å…¥é‡‘</span>'
      +'<span style="font-size:10px;color:var(--muted)">ADæ¡ˆä»¶: éµæ¸¡ã—å¾Œã§OK</span></div>';
  }
  h += '<div style="margin-top:6px">';
  if (canKey) {
    h += '<button class="btn btn-green" style="width:100%;justify-content:center" onclick="advance(\''+c.id+'\',\'key\',null,null,\'éµæ¸¡ã—æº–å‚™å®Œäº†\')">éµæ¸¡ã—ã¸ â†’</button>';
  } else {
    const miss = []; if(!setsuOk) miss.push('é‡èª¬'); if(!paidOk&&!ad) miss.push('å…¥é‡‘');
    h += '<button class="btn btn-ghost" style="width:100%;justify-content:center;opacity:.45;cursor:default">'
      +miss.join('ãƒ»')+' å®Œäº†å¾Œã«è§£æ”¾</button>';
  }
  h += '</div>';
  // â”€â”€ ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸ã‚µãƒãƒªãƒ¼ï¼ˆä¿®æ­£ãƒœã‚¿ãƒ³ä»˜ãï¼‰ â”€â”€
  if (c.invoice && c.invoice.issued) {
    const inv = c.invoice;
    const typeLabel = inv.type==='commission'?'ä»²ä»‹æ‰‹æ•°æ–™ã®ã¿':inv.type==='ad_plus'?'ADï¼‹ä»²ä»‹æ‰‹æ•°æ–™':'ADã®ã¿';
    const total = inv.grandTotal ? inv.grandTotal : (inv.commAmt||0)+(inv.adAmt||0)||(inv.totalItems||0);
    h = '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px;font-size:11px">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
      +'<span style="color:var(--gold);font-weight:700">ğŸ§¾ ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸</span>'
      +'<button onclick="editInvoice(\''+c.id+'\')" style="background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);border-radius:5px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">âœ ä¿®æ­£ã™ã‚‹</button>'
      +'</div>'
      +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub)">'
      +(inv.prop?'<span>ç‰©ä»¶</span><span style="color:var(--t)">'+inv.prop+'</span>':'')
      +'<span>ç¨®åˆ¥</span><span style="color:var(--t)">'+typeLabel+'</span>'
      +(inv.commAmt?'<span>ä»²ä»‹æ‰‹æ•°æ–™</span><span class="mono" style="color:var(--t)">Â¥'+parseInt(inv.commAmt).toLocaleString()+'</span>':'')
      +(inv.adAmt?'<span>'+(inv.adDesc||'æ¥­å‹™å§”è¨—')+' (AD)</span><span class="mono" style="color:var(--t)">Â¥'+parseInt(inv.adAmt).toLocaleString()+'</span>':'')
      +(total?'<span style="font-weight:600">åˆè¨ˆ</span><span class="mono" style="color:var(--gold);font-weight:700">Â¥'+parseInt(total).toLocaleString()+'</span>':'')
      +(inv.underReason?'<span style="color:var(--orange)">æ¸›é¡ç†ç”±</span><span style="color:var(--orange)">'+inv.underReason+'</span>':'')
      +'</div></div>'
      + h;
  }

  h += bookingLinkBlock(c);
  return h;
}
function stepPayment(c) { return stepPrekey(c); }
function stepItsetsu(c) { return stepPrekey(c); }

// â”€â”€ å£²è²· steps â”€â”€
function stepSaleNaiken(c) {
  const val = c.dates.naiken || new Date().toISOString().slice(0,10);
  return '<div class="step-title">ğŸ  å†…è¦‹ï¼ˆå£²è²·ï¼‰</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-sale-prop" value="'+(c.dates.naikenProp||'')+'" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·"></div>'
    +'<div class="fi"><label>å†…è¦‹æ—¥</label><input type="date" id="s-naiken-date" class="mono" value="'+val+'"></div>'
    +'<button class="btn btn-ghost" style="width:100%;justify-content:center;margin-top:10px;border-color:var(--gold);color:var(--gold)" onclick="launchNaikenPage(\''+c.id+'\')">ğŸ“„ å†…è¦‹ä¾é ¼æ›¸ã‚’ç™ºè¡Œï¼ˆFAXå°åˆ·ï¼‰</button>'
    +'<div style="display:flex;gap:8px;margin-top:8px">'
    +(c.type==='sannai'
      ? '<button class="btn btn-green" style="flex:1;justify-content:center" data-cid="'+c.id+'" onclick="sannaiNaikenDone(this.dataset.cid)">å†…è¦‹å®Œäº† â†’ æ¥­è€…ç¢ºèªã¸</button>'
        +'<button class="btn btn-ghost btn-sm" data-cid="'+c.id+'" onclick="sannaiSkipNaiken(this.dataset.cid)">å†…è¦‹ãªã—ãƒ»æ¥­è€…ç¢ºèªã¸</button>'
      : '<button class="btn btn-green" style="flex:1;justify-content:center" data-cid="'+c.id+'" onclick="saleNaikenDone(this.dataset.cid)">å†…è¦‹å®Œäº† â†’ è²·ä»˜ã¸</button>'
        +'<button class="btn btn-ghost btn-sm" data-cid="'+c.id+'" onclick="saleSkipNaiken(this.dataset.cid)">å†…è¦‹ãªã—ãƒ»è²·ä»˜ã¸ã‚¹ã‚­ãƒƒãƒ—</button>')
    +'</div>';
}

function sannaiNaikenDone(id) {
  try {
    const prop = document.getElementById('s-sale-prop')?.value.trim()||'';
    const d    = document.getElementById('s-naiken-date')?.value||todayISO();
    const c = CASES.find(x=>x.id===id); if(!c) return;
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(!c.buyer) c.buyer = {verifyState:'input'};
    if(prop) c.dates.naikenProp = prop;
    slackSend(SLACK_CH.å†…è¦‹, [
      ...slackHeader('ğŸ ','å†…è¦‹å®Œäº†ï¼ˆä¸‰ç‚ºï¼‰'),
      ...slackCase(c),
      'ğŸ  *ç‰©ä»¶*ï¼š'+(prop||'â€”'),
      'ğŸ“… *å†…è¦‹æ—¥*ï¼š'+d,
      ...slackFooter(),
    ]);
    advance(id,'verify','naiken',d,'å†…è¦‹å®Œäº† â†’ æ¥­è€…ç¢ºèªã¸');
  } catch(e) { console.error('sannaiNaikenDone:', e); }
}

function sannaiSkipNaiken(id) {
  try {
    const prop = document.getElementById('s-sale-prop')?.value.trim()||'';
    const c = CASES.find(x=>x.id===id); if(!c) return;
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(!c.buyer) c.buyer = {verifyState:'input'};
    if(prop) c.dates.naikenProp = prop;
    c.hist.unshift(today()+' å†…è¦‹ãªã—ãƒ»æ¥­è€…ç¢ºèªã¸');
    c.step = 'verify';
    open_case(id);
    toast('æ¥­è€…ç¢ºèªã¸');
  } catch(e) { console.error('sannaiSkipNaiken:', e); }
}

function saleNaikenDone(id) {
  try {
    const prop = document.getElementById('s-sale-prop')?.value.trim()||'';
    const d    = document.getElementById('s-naiken-date')?.value||todayISO();
    const c = CASES.find(x=>x.id===id);
    if(!c) { console.error('saleNaikenDone: case not found', id); return; }
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(prop) c.dates.naikenProp = prop;
    slackSend(SLACK_CH.å†…è¦‹, [
      ...slackHeader('ğŸ ','å†…è¦‹å®Œäº†ï¼ˆ'+( c.type==='sannai'?'ä¸‰ç‚º':'å£²è²·')+'ï¼‰'),
      ...slackCase(c),
      'ğŸ  *ç‰©ä»¶*ï¼š'+(prop||'â€”'),
      'ğŸ“… *å†…è¦‹æ—¥*ï¼š'+d,
      ...slackFooter(),
    ]);
    advance(id,'offer','naiken',d,'å†…è¦‹å®Œäº† â†’ è²·ä»˜');
  } catch(e) {
    console.error('saleNaikenDone error:', e);
  }
}

function saleSkipNaiken(id) {
  try {
    const prop = document.getElementById('s-sale-prop')?.value.trim()||'';
    const c = CASES.find(x=>x.id===id);
    if(!c) { console.error('saleSkipNaiken: case not found', id); return; }
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(prop) c.dates.naikenProp = prop;
    c.hist.unshift(today()+' å†…è¦‹ãªã—ãƒ»è²·ä»˜ã¸');
    c.step = 'offer';
    open_case(id);
    toast('å†…è¦‹ãªã—ãƒ»è²·ä»˜ã¸ã‚¹ã‚­ãƒƒãƒ—');
  } catch(e) {
    console.error('saleSkipNaiken error:', e);
  }
}

function stepOffer(c) {
  const today = new Date().toISOString().slice(0,10);
  const skipLabel = c.dates.naiken ? '' : '<span style="font-size:10px;color:var(--orange);margin-left:8px">å†…è¦‹ãªã—</span>';
  return '<div class="step-title">ğŸ“„ è²·ä»˜'+skipLabel+'</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-sale-prop" value="'+(c.dates.naikenProp||'')+'" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·"></div>'
    +'<div class="fi"><label>å£²è²·ä¾¡æ ¼ï¼ˆå††ï¼‰</label><input type="text" id="s-sale-price" class="mono" placeholder="ä¾‹: 32,000,000" value="'+(fmtYen(c.salePrice)||'')+'" style="font-size:13px" oninput="invSalePriceInput(this)"></div>'
    +'<div class="fi"><label>è²·ä»˜æ—¥</label><input type="date" id="s-offer-date" class="mono" value="'+today+'"></div>'
    +'<button class="btn btn-green" style="width:100%;justify-content:center;margin-top:14px" data-cid="'+c.id+'" onclick="offerDone(this.dataset.cid)">è²·ä»˜å—é ˜ â†’ è«‹æ±‚æ›¸ã¸</button>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸‰ç‚ºå°‚ç”¨ å¥‘ç´„ã‚¹ãƒ†ãƒƒãƒ—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stepSannaiContract(c) {
  const id  = c.id;
  const sn  = c.sannai         || {};
  const inv = c.invoice        || {};
  const sc  = c.sannaiContract || {};

  const bp = sn.buyPrice  || 0;
  const sp = sn.sellPrice || c.salePrice || 0;

  // å¼•ç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  const defBuyerName   = c.buyer?.name      || '';
  const defBuyerTakken = c.buyer?.takkenNum  || '';
  const defProp        = inv.prop || c.dates?.naikenProp || '';

  // ä»²ä»‹æ¥­è€…ãƒªã‚¹ãƒˆï¼ˆå£²ã‚Šå´ / è²·ã„å´ï¼‰
  const sellBrokers = sc.sellBrokers || (
    sn.commSellCo ? [{co:sn.commSellCo, person:'', amt:sn.commSellAmt||0}] : []
  );
  const buyBrokers  = sc.buyBrokers  || (
    sn.commBuyCo  ? [{co:sn.commBuyCo,  person:'', amt:sn.commBuyAmt ||0}] : []
  );

  // ç´¹ä»‹è€…ãƒªã‚¹ãƒˆï¼ˆside: 'sell'|'buy' è¿½åŠ ï¼‰
  const referrers = sc.referrers || (sn.delegPay||[]).map(r=>({
    name:r.co||'', type:r.type||'company', side:'buy', amt:r.amt||0, note:''
  }));

  // è«‹æ±‚æ›¸ãƒãƒƒã‚¸
  let invBadge = '';
  if (inv.issued) {
    invBadge = '<div style="margin-bottom:12px;padding:8px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px;font-size:11px;display:flex;justify-content:space-between;align-items:center">'
      +'<span style="color:var(--gold);font-weight:700">ğŸ§¾ è«‹æ±‚æ›¸ç™ºè¡Œæ¸ˆ</span>'
      +'<span style="display:flex;gap:12px">'
      +(inv.buyerTotal  ? '<span style="color:var(--blue)">è²·ä¸» Â¥'+parseInt(inv.buyerTotal).toLocaleString()+'</span>'  : '')
      +(inv.hasSellerComm&&inv.sellerTotal ? '<span style="color:var(--green)">å£²ä¸» Â¥'+parseInt(inv.sellerTotal).toLocaleString()+'</span>' : '')
      +'</span>'
      +'<button onclick="editInvoice(\''+id+'\')" style="background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);border-radius:5px;padding:2px 8px;cursor:pointer;font-size:10px">âœ ä¿®æ­£</button>'
      +'</div>';
  }

  // â”€â”€ ä»²ä»‹æ¥­è€…è¡ŒHTML â”€â”€
  function brokerRow(side, idx, r) {
    const color = side==='sell' ? '52,211,153' : '79,156,249';
    return '<div class="sn-broker-row" data-side="'+side+'" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr 1fr 120px auto;gap:5px;align-items:center;margin-bottom:6px">'
      +'<input type="text" class="sn-br-co" placeholder="ä¼šç¤¾å" value="'+(r.co||'')+'" style="font-size:11px">'
      +'<input type="text" class="sn-br-person" placeholder="æ‹…å½“è€…å" value="'+(r.person||'')+'" style="font-size:11px">'
      +'<input type="text" class="sn-br-amt mono" placeholder="æ‰‹æ•°æ–™" value="'+(r.amt?fmtYen(r.amt):'')+'" oninput="invSalePriceInput(this)" style="font-size:12px">'
      +'<button onclick="this.closest(\'.sn-broker-row\').remove();sannaiDrawFlow(\''+id+'\')" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0">Ã—</button>'
      +'</div>';
  }

  function brokerSection(side, label, color, brokers) {
    const rows = brokers.map((r,i)=>brokerRow(side,i,r)).join('');
    return '<div style="border:1px solid rgba('+color+',.2);border-radius:10px;overflow:hidden;margin-bottom:8px">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:rgba('+color+',.05)">'
      +'<span style="font-size:11px;font-weight:700;color:rgba('+color+',1)">ğŸ¤ '+label+'ä»²ä»‹æ¥­è€…</span>'
      +'<button data-side="'+side+'" data-cid="'+id+'" onclick="sannaiAddBroker(this)" style="background:rgba('+color+',.15);border:1px solid rgba('+color+',.3);color:rgba('+color+',1);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">ï¼‹ è¿½åŠ </button>'
      +'</div>'
      +'<div id="sn-brokers-'+side+'" style="padding:'+(brokers.length?'8px 10px 4px':'0 10px')+' 10px">'
      + rows
      +'</div>'
      +(brokers.length===0?'<div style="padding:6px 12px 10px;font-size:11px;color:var(--muted)">ãªã—ï¼ˆï¼‹ è¿½åŠ ã§å…¥åŠ›ï¼‰</div>':'')
      +'</div>';
  }

  // â”€â”€ ç´¹ä»‹è€…è¡ŒHTML â”€â”€
  function referrerRow(i, r) {
    const typeOpts = [
      {v:'company', label:'æ¥­è€…'},
      {v:'corp',    label:'ä¸€èˆ¬æ³•äºº'},
      {v:'person',  label:'å€‹äºº'},
    ];
    const sideOpts = [
      {v:'sell', label:'å£²ã‚Šå´'},
      {v:'buy',  label:'è²·ã„å´'},
    ];
    return '<div class="sn-referrer-row" data-idx="'+i+'" style="background:rgba(167,139,250,.04);border:1px solid rgba(167,139,250,.15);border-radius:8px;padding:10px 12px;margin-bottom:6px">'
      +'<div style="display:grid;grid-template-columns:1fr 80px 80px;gap:5px;margin-bottom:6px">'
      +'<div class="fi" style="margin:0"><label>æ°å / ä¼šç¤¾å</label><input type="text" class="sn-ref-name" placeholder="ç´¹ä»‹è€…å" value="'+(r.name||'')+'"></div>'
      +'<div class="fi" style="margin:0"><label>ç¨®åˆ¥</label>'
      +'<select class="sn-ref-type" style="background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:5px 6px;color:var(--text);font-size:11px;font-family:inherit;width:100%">'
      +typeOpts.map(o=>'<option value="'+o.v+'"'+(r.type===o.v?' selected':'')+'>'+o.label+'</option>').join('')
      +'</select></div>'
      +'<div class="fi" style="margin:0"><label>æ‰€å±</label>'
      +'<select class="sn-ref-side" style="background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:5px 6px;font-size:11px;font-family:inherit;width:100%;'
      +(r.side==='sell'?'color:#34d399;border-color:rgba(52,211,153,.5)':'color:#4f9cf9;border-color:rgba(79,156,249,.5)')+'">'
      +sideOpts.map(o=>'<option value="'+o.v+'"'+(r.side===o.v?' selected':'')+'>'+o.label+'</option>').join('')
      +'</select></div>'
      +'</div>'
      +'<div style="display:grid;grid-template-columns:1fr 1fr auto;gap:5px;align-items:end">'
      +'<div class="fi" style="margin:0"><label>æ¥­å‹™å§”è¨—è²»ç”¨ï¼ˆç¨è¾¼ï¼‰</label>'
      +'<input type="text" class="sn-ref-amt mono" placeholder="0" value="'+(r.amt?fmtYen(r.amt):'')+'" oninput="invSalePriceInput(this)" style="font-size:13px"></div>'
      +'<div class="fi" style="margin:0"><label>å‚™è€ƒ</label><input type="text" class="sn-ref-note" placeholder="ç´¹ä»‹çµŒè·¯ãªã©" value="'+(r.note||'')+'"></div>'
      +'<button onclick="this.closest(\'.sn-referrer-row\').remove();sannaiDrawFlow(\''+id+'\')" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0;flex-shrink:0">Ã—</button>'
      +'</div>'
      +'</div>';
  }

  const referrerRowsHtml = referrers.map((r,i)=>referrerRow(i,r)).join('');

  return '<div class="step-title">âœï¸ å£²è²·å¥‘ç´„ï¼ˆä¸‰ç‚ºï¼‰</div>'
    + invBadge

    // åŸºæœ¬æƒ…å ±
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'
    +'<div class="fi"><label>å¥‘ç´„æ—¥</label><input type="date" id="sn-ct-date" class="mono" value="'+(sc.contractDate||todayISO())+'"></div>'
    +'<div class="fi"><label>æ±ºæ¸ˆäºˆå®šæ—¥</label><input type="date" id="sn-ct-settle" class="mono" value="'+(sc.settleDate||'')+'"></div>'
    +'</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="sn-ct-prop" value="'+defProp+'" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·"></div>'

    // å£²ä¸»
    +'<div style="border:1px solid rgba(251,146,60,.2);border-radius:10px;overflow:hidden;margin-bottom:8px">'
    +'<div style="padding:9px 12px;background:rgba(251,146,60,.05)">'
    +'<span style="font-size:11px;font-weight:700;color:var(--orange)">ğŸ  å£²ä¸»</span>'
    +'<span style="font-size:10px;color:var(--muted);margin-left:8px">'+(bp?'ä»•å…¥ã‚Œ: Â¥'+bp.toLocaleString():'ä»•å…¥ã‚Œä¾¡æ ¼ â€” æœªå…¥åŠ›')+'</span>'
    +'</div>'
    +'<div style="padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px">'
    +'<div class="fi" style="margin:0"><label>ä¼šç¤¾å / æ°å</label><input type="text" id="sn-ct-seller-name" value="'+(sc.sellerName||'')+'" placeholder="å£²ä¸»å"></div>'
    +'<div class="fi" style="margin:0"><label>æ‹…å½“è€…å</label><input type="text" id="sn-ct-seller-person" value="'+(sc.sellerPerson||'')+'" placeholder="æ‹…å½“è€…"></div>'
    +'</div>'
    +'</div>'

    // å£²ã‚Šå´ä»²ä»‹ï¼ˆè¤‡æ•°ï¼‰
    + brokerSection('sell', 'å£²ã‚Šå´', '52,211,153', sellBrokers)

    // COREBLDG
    +'<div style="border:1px solid rgba(201,168,76,.4);border-radius:10px;padding:9px 12px;margin-bottom:8px;background:rgba(201,168,76,.06);text-align:center">'
    +'<div style="font-size:11px;font-weight:700;color:var(--gold)">ğŸ¢ COREBLDGï¼ˆè‡ªç¤¾ï¼‰</div>'
    +(bp&&sp?'<div style="font-size:10px;color:var(--muted);margin-top:2px">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰: '+(sp-bp>=0?'+':'')+'Â¥'+(sp-bp).toLocaleString()+'</div>':'')
    +'</div>'

    // è²·ã„å´ä»²ä»‹ï¼ˆè¤‡æ•°ï¼‰
    + brokerSection('buy', 'è²·ã„å´', '79,156,249', buyBrokers)

    // è²·ä¸»
    +'<div style="border:1px solid rgba(79,156,249,.2);border-radius:10px;overflow:hidden;margin-bottom:8px">'
    +'<div style="padding:9px 12px;background:rgba(79,156,249,.05)">'
    +'<span style="font-size:11px;font-weight:700;color:var(--blue)">ğŸ‘¤ è²·ä¸»</span>'
    +'<span style="font-size:10px;color:var(--muted);margin-left:8px">'+(sp?'è²©å£²: Â¥'+sp.toLocaleString():'è²©å£²ä¾¡æ ¼ â€” æœªå…¥åŠ›')+'</span>'
    +'</div>'
    +'<div style="padding:10px 12px">'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px">'
    +'<div class="fi" style="margin:0"><label>ä¼šç¤¾å / æ°å</label><input type="text" id="sn-ct-buyer-name" value="'+(sc.buyerName||defBuyerName)+'" placeholder="è²·ä¸»å"></div>'
    +'<div class="fi" style="margin:0"><label>æ‹…å½“è€…å</label><input type="text" id="sn-ct-buyer-person" value="'+(sc.buyerPerson||'')+'" placeholder="æ‹…å½“è€…"></div>'
    +'</div>'
    +(defBuyerTakken?'<div style="font-size:10px;color:var(--muted)">å®…å»ºç•ªå·: '+defBuyerTakken+'</div>':'')
    +'</div>'
    +'</div>'

    // ç´¹ä»‹è€…
    +'<div style="border:1px solid rgba(167,139,250,.2);border-radius:10px;overflow:hidden;margin-bottom:12px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:rgba(167,139,250,.05)">'
    +'<div>'
    +'<span style="font-size:11px;font-weight:700;color:var(--purple)">ğŸ”— ç´¹ä»‹è€…</span>'
    +'<span style="font-size:10px;color:var(--muted);margin-left:8px">æ¥­å‹™å§”è¨—è²»ã®ã¿ãƒ»ä»²ä»‹ã«ã¯å…¥ã‚‰ãªã„</span>'
    +'</div>'
    +'<button data-cid="'+id+'" onclick="sannaiAddReferrer(this.dataset.cid)" style="background:rgba(167,139,250,.15);border:1px solid rgba(167,139,250,.3);color:var(--purple);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">ï¼‹ è¿½åŠ </button>'
    +'</div>'
    +'<div id="sn-referrer-list" style="padding:'+(referrers.length?'8px 8px 4px':'0')+' 8px">'
    + referrerRowsHtml
    +'</div>'
    +(referrers.length===0?'<div style="padding:6px 12px 10px;font-size:11px;color:var(--muted)">ãªã—ï¼ˆï¼‹ è¿½åŠ ã§å…¥åŠ›ï¼‰</div>':'')
    +'</div>'

    // å•†æµå›³
    +'<div style="margin-bottom:12px">'
    +'<div style="font-size:10px;color:var(--muted);font-weight:600;letter-spacing:.8px;margin-bottom:8px">ğŸ“Š å•†æµ</div>'
    +'<div id="sn-flow-diagram">' + sannaiFlowDiagram(c, sc, sn, sellBrokers, buyBrokers, referrers) + '</div>'
    +'</div>'

    +'<button class="btn btn-green" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="sannaiContractDone(this.dataset.cid)">âœ“ å¥‘ç´„ç· çµ â†’ æ±ºæ¸ˆã¸</button>';
}

// â”€â”€ å•†æµãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ  â”€â”€
function sannaiFlowDiagram(c, sc, sn, sellBrokers, buyBrokers, referrers) {
  sc = sc || c.sannaiContract || {};
  sn = sn || c.sannai || {};
  const bp = sn.buyPrice  || 0;
  const sp = sn.sellPrice || c.salePrice || 0;
  const sellerName = sc.sellerName || 'å£²ä¸»';
  const buyerName  = sc.buyerName  || c.buyer?.name || 'è²·ä¸»';

  // æœ€æ–°DOMå€¤ã‚’å„ªå…ˆ
  if (!sellBrokers) {
    sellBrokers = [];
    document.querySelectorAll('.sn-broker-row[data-side="sell"]').forEach(row=>{
      const co  = row.querySelector('.sn-br-co')?.value.trim()||'';
      const amt = parseInt((row.querySelector('.sn-br-amt')?.value||'').replace(/,/g,''))||0;
      if(co||amt) sellBrokers.push({co, amt});
    });
  }
  if (!buyBrokers) {
    buyBrokers = [];
    document.querySelectorAll('.sn-broker-row[data-side="buy"]').forEach(row=>{
      const co  = row.querySelector('.sn-br-co')?.value.trim()||'';
      const amt = parseInt((row.querySelector('.sn-br-amt')?.value||'').replace(/,/g,''))||0;
      if(co||amt) buyBrokers.push({co, amt});
    });
  }
  if (!referrers) {
    referrers = [];
    document.querySelectorAll('.sn-referrer-row').forEach(row=>{
      const name = row.querySelector('.sn-ref-name')?.value.trim()||'';
      const side = row.querySelector('.sn-ref-side')?.value||'buy';
      const amt  = parseInt((row.querySelector('.sn-ref-amt')?.value||'').replace(/,/g,''))||0;
      if(name||amt) referrers.push({name, side, amt});
    });
  }

  const sellRefs = referrers.filter(r=>r.side==='sell');
  const buyRefs  = referrers.filter(r=>r.side==='buy');

  const node = (label, sub, color, bold) =>
    '<div style="background:rgba('+color+',.08);border:1px solid rgba('+color+',.35);border-radius:8px;padding:5px 9px;text-align:center;min-width:72px;max-width:120px">'
    +'<div style="font-size:'+(bold?'11':'10')+'px;font-weight:'+(bold?700:600)+';color:rgba('+color+',1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+label+'</div>'
    +(sub?'<div style="font-size:9px;color:var(--muted);margin-top:1px;white-space:nowrap">'+sub+'</div>':'')
    +'</div>';

  const arrow = (label, color) =>
    '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:20px;flex:1">'
    +(label?'<div style="font-size:8px;color:rgba('+color+',.7);margin-bottom:1px;white-space:nowrap">'+label+'</div>':'')
    +'<div style="height:1px;background:rgba('+color+',.4);width:100%;position:relative">'
    +'<div style="position:absolute;right:-1px;top:-3px;border-left:5px solid rgba('+color+',.5);border-top:3px solid transparent;border-bottom:3px solid transparent"></div>'
    +'</div>'
    +'</div>';

  const smallNode = (label, sub, color) =>
    '<div style="background:rgba('+color+',.06);border:1px dashed rgba('+color+',.3);border-radius:6px;padding:4px 8px;text-align:center">'
    +'<div style="font-size:9px;font-weight:600;color:rgba('+color+',1)">'+label+'</div>'
    +(sub?'<div style="font-size:8px;color:var(--muted)">'+sub+'</div>':'')
    +'</div>';

  // â”€â”€ ãƒ¡ã‚¤ãƒ³æ¨ªãƒ•ãƒ­ãƒ¼ â”€â”€
  let mainFlow = '<div style="display:flex;align-items:center;gap:3px;flex-wrap:nowrap;overflow-x:auto;padding:4px 0 6px">';

  // å£²ä¸»
  mainFlow += node(sellerName, bp?'Â¥'+bp.toLocaleString():'', '251,146,60', false);

  // å£²ã‚Šå´ä»²ä»‹ï¼ˆè¤‡æ•°ï¼‰
  sellBrokers.forEach(br => {
    mainFlow += arrow('', '52,211,153');
    mainFlow += node(br.co||'å£²å´ä»²ä»‹', br.amt?'-Â¥'+br.amt.toLocaleString():'', '52,211,153', false);
  });

  // â†’ è‡ªç¤¾
  mainFlow += arrow(sellBrokers.length?'':'å£²ä¸»â†’', '201,168,76');
  mainFlow += node('COREBLDG', (bp&&sp)?'å·®Â¥'+(sp-bp).toLocaleString():'', '201,168,76', true);

  // è²·ã„å´ä»²ä»‹ï¼ˆè¤‡æ•°ï¼‰
  buyBrokers.forEach(br => {
    mainFlow += arrow('', '79,156,249');
    mainFlow += node(br.co||'è²·å´ä»²ä»‹', br.amt?'-Â¥'+br.amt.toLocaleString():'', '79,156,249', false);
  });

  // â†’ è²·ä¸»
  mainFlow += arrow('', '79,156,249');
  mainFlow += node(buyerName, sp?'Â¥'+sp.toLocaleString():'', '79,156,249', false);

  mainFlow += '</div>';

  // â”€â”€ ç´¹ä»‹è€…ï¼ˆå£²ã‚Šå´ãƒ»è²·ã„å´ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰â”€â”€
  let refHtml = '';
  if (sellRefs.length || buyRefs.length) {
    refHtml = '<div style="border-top:1px solid var(--border);padding-top:8px;margin-top:2px">'
      +'<div style="font-size:9px;color:var(--muted);font-weight:600;margin-bottom:6px">ğŸ”— ç´¹ä»‹è€…ï¼ˆæ¥­å‹™å§”è¨—ã®ã¿ï¼‰</div>'
      +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';

    // å£²ã‚Šå´ç´¹ä»‹è€…
    refHtml += '<div>';
    if(sellRefs.length) {
      refHtml += '<div style="font-size:9px;color:var(--green);font-weight:600;margin-bottom:4px">å£²ã‚Šå´</div>';
      sellRefs.forEach(r=>{
        refHtml += '<div style="display:flex;justify-content:space-between;align-items:center;background:rgba(52,211,153,.05);border:1px solid rgba(52,211,153,.2);border-radius:6px;padding:4px 8px;margin-bottom:4px;font-size:10px">'
          +'<span style="color:var(--sub)">'+(r.name||'â€”')+'</span>'
          +(r.amt?'<span class="mono" style="color:var(--orange)">-Â¥'+parseInt(r.amt).toLocaleString()+'</span>':'')
          +'</div>';
      });
    } else {
      refHtml += '<div style="font-size:10px;color:var(--muted)">â€”</div>';
    }
    refHtml += '</div>';

    // è²·ã„å´ç´¹ä»‹è€…
    refHtml += '<div>';
    if(buyRefs.length) {
      refHtml += '<div style="font-size:9px;color:var(--blue);font-weight:600;margin-bottom:4px">è²·ã„å´</div>';
      buyRefs.forEach(r=>{
        refHtml += '<div style="display:flex;justify-content:space-between;align-items:center;background:rgba(79,156,249,.05);border:1px solid rgba(79,156,249,.2);border-radius:6px;padding:4px 8px;margin-bottom:4px;font-size:10px">'
          +'<span style="color:var(--sub)">'+(r.name||'â€”')+'</span>'
          +(r.amt?'<span class="mono" style="color:var(--orange)">-Â¥'+parseInt(r.amt).toLocaleString()+'</span>':'')
          +'</div>';
      });
    } else {
      refHtml += '<div style="font-size:10px;color:var(--muted)">â€”</div>';
    }
    refHtml += '</div>';

    refHtml += '</div></div>';
  }

  return mainFlow + refHtml;
}

function sannaiDrawFlow(id) {
  const el = document.getElementById('sn-flow-diagram'); if(!el) return;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  el.innerHTML = sannaiFlowDiagram(c, null, null, null, null, null);
}

function sannaiAddBroker(btn) {
  const side = btn.dataset.side;
  const id   = btn.dataset.cid;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  sannaiContractSave(c);
  if(!c.sannaiContract) c.sannaiContract={};
  if(side==='sell') {
    if(!c.sannaiContract.sellBrokers) c.sannaiContract.sellBrokers=[];
    c.sannaiContract.sellBrokers.push({co:'',person:'',amt:0});
  } else {
    if(!c.sannaiContract.buyBrokers) c.sannaiContract.buyBrokers=[];
    c.sannaiContract.buyBrokers.push({co:'',person:'',amt:0});
  }
  open_case(id);
}

function sannaiAddReferrer(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  sannaiContractSave(c);
  if(!c.sannaiContract) c.sannaiContract={};
  if(!c.sannaiContract.referrers) c.sannaiContract.referrers=[];
  c.sannaiContract.referrers.push({name:'', type:'company', side:'buy', amt:0, note:''});
  open_case(id);
}

function sannaiContractSave(c) {
  if(!c.sannaiContract) c.sannaiContract={};
  const sc = c.sannaiContract;

  sc.contractDate  = document.getElementById('sn-ct-date')?.value    || sc.contractDate  || '';
  sc.settleDate    = document.getElementById('sn-ct-settle')?.value   || sc.settleDate    || '';
  sc.prop          = document.getElementById('sn-ct-prop')?.value     || sc.prop          || '';
  sc.sellerName    = document.getElementById('sn-ct-seller-name')?.value   || sc.sellerName   || '';
  sc.sellerPerson  = document.getElementById('sn-ct-seller-person')?.value || sc.sellerPerson || '';
  sc.buyerName     = document.getElementById('sn-ct-buyer-name')?.value    || sc.buyerName    || '';
  sc.buyerPerson   = document.getElementById('sn-ct-buyer-person')?.value  || sc.buyerPerson  || '';

  // ä»²ä»‹æ¥­è€…ï¼ˆå£²ã‚Šå´ï¼‰
  const sellRows = document.querySelectorAll('.sn-broker-row[data-side="sell"]');
  if(sellRows.length > 0) {
    sc.sellBrokers = [];
    sellRows.forEach(row => {
      const co     = row.querySelector('.sn-br-co')?.value.trim()||'';
      const person = row.querySelector('.sn-br-person')?.value.trim()||'';
      const amt    = parseInt((row.querySelector('.sn-br-amt')?.value||'').replace(/,/g,''))||0;
      if(co||amt) sc.sellBrokers.push({co,person,amt});
    });
  }

  // ä»²ä»‹æ¥­è€…ï¼ˆè²·ã„å´ï¼‰
  const buyRows = document.querySelectorAll('.sn-broker-row[data-side="buy"]');
  if(buyRows.length > 0) {
    sc.buyBrokers = [];
    buyRows.forEach(row => {
      const co     = row.querySelector('.sn-br-co')?.value.trim()||'';
      const person = row.querySelector('.sn-br-person')?.value.trim()||'';
      const amt    = parseInt((row.querySelector('.sn-br-amt')?.value||'').replace(/,/g,''))||0;
      if(co||amt) sc.buyBrokers.push({co,person,amt});
    });
  }

  // ç´¹ä»‹è€…
  const refRows = document.querySelectorAll('.sn-referrer-row');
  if(refRows.length > 0) {
    sc.referrers = [];
    refRows.forEach(row => {
      const name = row.querySelector('.sn-ref-name')?.value.trim()||'';
      const type = row.querySelector('.sn-ref-type')?.value||'company';
      const side = row.querySelector('.sn-ref-side')?.value||'buy';
      const amt  = parseInt((row.querySelector('.sn-ref-amt')?.value||'').replace(/,/g,''))||0;
      const note = row.querySelector('.sn-ref-note')?.value.trim()||'';
      if(name||amt) sc.referrers.push({name,type,side,amt,note});
    });
  }
}

function sannaiContractDone(id) {
  try {
    const c = CASES.find(x=>x.id===id); if(!c) return;
    sannaiContractSave(c);
    const sc = c.sannaiContract || {};
    const d  = sc.contractDate || todayISO();
    c.hist.unshift(today()+' å£²è²·å¥‘ç´„ç· çµ'
      +(sc.sellerName?' å£²ä¸»:'+sc.sellerName:'')
      +(sc.buyerName?' è²·ä¸»:'+sc.buyerName:''));
    const sn12 = c.sannai||{};
    slackSend(SLACK_CH.å¥‘ç´„, [
      ...slackHeader('âœï¸','å£²è²·å¥‘ç´„ç· çµï¼ˆä¸‰ç‚ºï¼‰'),
      ...slackCase(c),
      'ğŸ  *ç‰©ä»¶*ï¼š'+(sc.prop||c.dates?.naikenProp||'â€”'),
      sc.sellerName ? 'ğŸ  *å£²ä¸»*ï¼š'+sc.sellerName : null,
      sc.buyerName  ? 'ğŸ‘¤ *è²·ä¸»*ï¼š'+sc.buyerName  : null,
      sn12.buyPrice  ? 'ğŸ’´ *ä»•å…¥ã‚Œ*ï¼šÂ¥'+sn12.buyPrice.toLocaleString()  : null,
      sn12.sellPrice ? 'ğŸ’´ *è²©å£²*ï¼šÂ¥'+sn12.sellPrice.toLocaleString() : null,
      sc.settleDate ? 'ğŸ“… *æ±ºæ¸ˆäºˆå®š*ï¼š'+sc.settleDate : null,
      ...slackFooter(),
    ]);
    advance(id,'settlement','contract',d,'å£²è²·å¥‘ç´„ç· çµ â†’ æ±ºæ¸ˆã¸');
  } catch(e){ console.error('sannaiContractDone:',e); }
}


function stepSaleContract(c) {
  const inv = c.invoice||{};
  const fromLabel = inv.saleFrom==='both'?'ä¸¡æ‰‹ï¼ˆå£²ä¸»ï¼‹è²·ä¸»ï¼‰':inv.saleFrom==='buyer'?'è²·ä¸»ã‹ã‚‰':'å£²ä¸»ã‹ã‚‰';

  // ä¸‰ç‚ºã®å ´åˆ: å–å¼•æ¦‚è¦ã‚µãƒãƒªãƒ¼ã‚’å…ˆé ­ã«è¡¨ç¤º
  let sannaiCostSummary = '';
  if (c.type === 'sannai') {
    const sn = c.sannai || {};
    const bp = sn.buyPrice || 0;
    const sp = sn.sellPrice || c.salePrice || 0;
    const spread = sp - bp;
    const commBuyAmt  = sn.commBuyAmt  || 0;
    const commSellAmt = sn.commSellAmt || 0;
    const delegTotal  = (sn.delegPay||[]).reduce((s,r)=>s+(r.amt||0),0);
    const totalOut = commBuyAmt + commSellAmt + delegTotal;
    const profit = spread - totalOut;

    if (bp || sp || totalOut) {
      sannaiCostSummary = '<div style="margin-bottom:12px;padding:12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:10px;font-size:11px">'
        +'<div style="font-size:10px;color:var(--gold);font-weight:700;letter-spacing:.8px;margin-bottom:8px">ğŸ“Š å–å¼•æ¦‚è¦</div>'
        +'<div style="display:grid;grid-template-columns:auto 1fr;gap:3px 12px;line-height:1.9">';
      if(bp) sannaiCostSummary += '<span style="color:var(--muted)">ä»•å…¥ã‚Œä¾¡æ ¼</span><span class="mono" style="color:var(--sub)">Â¥'+bp.toLocaleString()+'</span>';
      if(sp) sannaiCostSummary += '<span style="color:var(--muted)">è²©å£²ä¾¡æ ¼</span><span class="mono" style="color:var(--sub)">Â¥'+sp.toLocaleString()+'</span>';
      if(bp&&sp) {
        const sc = spread>=0?'var(--green)':'var(--red)';
        sannaiCostSummary += '<span style="color:var(--muted)">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰</span><span class="mono" style="color:'+sc+';font-weight:700">'+(spread>=0?'+':'')+'Â¥'+spread.toLocaleString()+'</span>';
      }
      if(sn.commPayMode && sn.commPayMode!=='none') {
        sannaiCostSummary += '<span style="color:var(--border2);grid-column:1/-1;border-top:1px solid var(--border);margin:3px 0"></span>';
        if(commBuyAmt) sannaiCostSummary += '<span style="color:var(--muted)">è²·ã„å´ä»²ä»‹æ‰‹æ•°æ–™ ('+(sn.commBuyCo||'â€”')+')</span><span class="mono" style="color:var(--orange)">-Â¥'+commBuyAmt.toLocaleString()+'</span>';
        if(commSellAmt) sannaiCostSummary += '<span style="color:var(--muted)">å£²ã‚Šå´ä»²ä»‹æ‰‹æ•°æ–™ ('+(sn.commSellCo||'â€”')+')</span><span class="mono" style="color:var(--orange)">-Â¥'+commSellAmt.toLocaleString()+'</span>';
      }
      if((sn.delegPay||[]).length > 0) {
        (sn.delegPay||[]).forEach(r => {
          const typeLabel = r.type==='broker'?'ä»²ä»‹ä¼šç¤¾':'ãã®ä»–';
          sannaiCostSummary += '<span style="color:var(--muted)">æ¥­å‹™å§”è¨— '+typeLabel+' ('+(r.co||'â€”')+')</span><span class="mono" style="color:var(--purple)">-Â¥'+(r.amt||0).toLocaleString()+'</span>';
        });
      }
      if(totalOut > 0) {
        sannaiCostSummary += '<span style="color:var(--border2);grid-column:1/-1;border-top:1px solid var(--border);margin:3px 0"></span>';
        const pc = profit>=0?'var(--green)':'var(--red)';
        sannaiCostSummary += '<span style="color:var(--text);font-weight:700">æ¦‚ç®—ç²—åˆ©</span><span class="mono" style="color:'+pc+';font-weight:700;font-size:13px">'+(profit>=0?'+':'')+'Â¥'+profit.toLocaleString()+'</span>';
      }
      sannaiCostSummary += '</div>'
        +'<button onclick="open_case(\''+c.id+'\')" style="display:none" id="sn-back-offer"></button>'
        +'<div style="margin-top:8px;text-align:right">'
        +'<a href="#" onclick="editSannaiOffer(\''+c.id+'\')" style="font-size:10px;color:var(--muted);text-decoration:none">âœ å–å¼•æ¦‚è¦ã‚’ä¿®æ­£</a>'
        +'</div>'
        +'</div>';
    }
  }

  let invSummary = '';
  if (inv.issued) {
    if (c.type === 'sannai') {
      invSummary = '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px;font-size:11px">'
        +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
        +'<span style="color:var(--gold);font-weight:700">ğŸ§¾ ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸ï¼ˆä¸‰ç‚ºï¼‰</span>'
        +'<button onclick="editInvoice(\\\''+c.id+'\\\')" style="background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);border-radius:5px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">âœ ä¿®æ­£</button>'
        +'</div>'
        +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub);font-size:11px">'
        +(inv.prop?'<span>ç‰©ä»¶</span><span style="color:var(--text)">'+inv.prop+'</span>':'')
        +(inv.sellPrice?'<span>è²©å£²ä¾¡æ ¼</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.sellPrice).toLocaleString()+'</span>':'')
        +(inv.buyPrice?'<span>ä»•å…¥ã‚Œä¾¡æ ¼</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.buyPrice).toLocaleString()+'</span>':'')
        +(inv.buyerTotal?'<span>ğŸ“„ è²·ä¸»å‘ã‘</span><span class="mono" style="color:var(--blue);font-weight:700">Â¥'+parseInt(inv.buyerTotal).toLocaleString()+'</span>':'')
        +(inv.hasSellerComm&&inv.sellerTotal?'<span>ğŸ“„ å£²ä¸»å‘ã‘</span><span class="mono" style="color:var(--green);font-weight:700">Â¥'+parseInt(inv.sellerTotal).toLocaleString()+'</span>':'')
        +(inv.grandTotal?'<span style="font-weight:700">è«‹æ±‚ç·è¨ˆ</span><span class="mono" style="color:var(--gold);font-weight:700">Â¥'+parseInt(inv.grandTotal).toLocaleString()+'</span>':'')
        +'</div></div>';
    } else {
      invSummary = '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px;font-size:11px">'
        +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
        +'<span style="color:var(--gold);font-weight:700">ğŸ§¾ ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸</span>'
        +'<button onclick="editInvoice(\\\''+c.id+'\\\')" style="background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);border-radius:5px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">âœ ä¿®æ­£</button>'
        +'</div>'
        +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub);font-size:11px">'
        +(inv.prop?'<span>ç‰©ä»¶</span><span style="color:var(--text)">'+inv.prop+'</span>':'')
        +'<span>å—é ˜å…ˆ</span><span style="color:var(--text)">'+fromLabel+'</span>'
        +(inv.salePrice?'<span>å£²è²·ä¾¡æ ¼</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.salePrice).toLocaleString()+'</span>':'')
        +(inv.totalA?'<span>å£²ä¸»å‘ã‘</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.totalA).toLocaleString()+'</span>':'')
        +(inv.totalB?'<span>è²·ä¸»å‘ã‘</span><span class="mono" style="color:var(--blue)">Â¥'+parseInt(inv.totalB).toLocaleString()+'</span>':'')
        +(inv.delegAmt?'<span>æ¥­å‹™å§”è¨—</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.delegAmt).toLocaleString()+'</span>':'')
        +(inv.grandTotal?'<span style="font-weight:700">åˆè¨ˆ</span><span class="mono" style="color:var(--gold);font-weight:700">Â¥'+parseInt(inv.grandTotal).toLocaleString()+'</span>':'')
        +'</div></div>';
    }
  }
  return sannaiCostSummary + '<div class="step-title">âœï¸ å£²è²·å¥‘ç´„</div>'
    +invSummary

    +'<button class="btn btn-green" style="width:100%;justify-content:center" data-cid="'+c.id+'" onclick="saleContractDone(this.dataset.cid)">âœ“ å¥‘ç´„ç· çµ â†’ æ±ºæ¸ˆã¸</button>';
}

function stepSettlement(c) {
  const today = new Date().toISOString().slice(0,10);
  const val = c.dates.settlement || today;
  return '<div class="step-title">ğŸ’´ æ±ºæ¸ˆãƒ»å¼•æ¸¡ã—</div>'
    +'<div class="fi"><label>æ±ºæ¸ˆæ—¥</label><input type="date" id="s-settlement" class="mono" value="'+val+'"></div>'
    +'<button class="btn btn-green" style="width:100%;justify-content:center;margin-top:12px" data-cid="'+c.id+'" onclick="settlementDone(this.dataset.cid)">âœ“ æ±ºæ¸ˆå®Œäº† â†’ æˆç´„</button>';
}

// â”€â”€ Sub components â”€â”€
function appsHTML(c) {
  return c.apps.map(a=>{
    const s = a.status;
    const pill = s==='reviewing'?'<span class="pill pill-orange">å¯©æŸ»ä¸­</span>'
      :s==='approved'?'<span class="pill pill-green">é€šé</span>'
      :s==='rejected'?'<span class="pill pill-red">è½ã¡</span>'
      :s==='cancelled'?'<span class="pill pill-muted">å–æ¶ˆ</span>'
      :'<span class="pill pill-blue">æå‡ºæ¸ˆ</span>';
    return '<div class="app-item" style="margin-bottom:6px">'
      +'<div class="app-name"><span>'+a.prop+'</span>'+pill+(a.sim?' <span class="pill pill-orange">åŒæ™‚</span>':'')+'</div>'
      +'<div class="app-meta">'+a.mgmt+' Â· '+a.date+'</div>'
      +'</div>';
  }).join('');
}

function histHTML(c) {
  if (!c.hist||!c.hist.length) return '';
  return '<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">'
    +'<div style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:1.5px;margin-bottom:10px">æ´»å‹•å±¥æ­´</div>'
    +c.hist.map((h,i)=>'<div class="hist-item">'
      +'<div><div class="hist-dot'+(i===0?' cur':'')+'"></div>'+(i<c.hist.length-1?'<div class="hist-line"></div>':'')+'</div>'
      +'<div style="font-size:11px;color:var(--sub);padding:0 0 4px 8px">'+h+'</div>'
      +'</div>').join('')
    +'<div style="display:flex;gap:6px;margin-top:8px">'
    +'<input type="text" id="memo-inp" placeholder="ãƒ¡ãƒ¢è¿½åŠ ..." style="flex:1;background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:6px 10px;color:var(--text);font-size:11px;font-family:inherit;outline:none" onkeydown="if(event.key===\'Enter\')addMemo(\''+c.id+'\')">'
    +'<button class="btn btn-ghost btn-sm" onclick="addMemo(\''+c.id+'\')">è¿½åŠ </button>'
    +'</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function today() { return new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'}); }
function todayISO() { return new Date().toISOString().slice(0,10); }

function advance(id, nextStep, dateKey, dateVal, memo) {
  try {
    const c = CASES.find(x=>x.id===id);
    if(!c) { console.error('advance: case not found', id); return; }
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    c.step = nextStep;
    c.age  = 0;
    if (dateKey) c.dates[dateKey] = dateVal || todayISO();
    if (memo) c.hist.unshift(today()+' '+memo);
    open_case(id);
    toast(memo||'æ›´æ–°ã—ã¾ã—ãŸ');
  } catch(e) {
    console.error('advance error:', e);
    toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: '+e.message);
  }
}

function naikenDone(id) {
  const c = CASES.find(x=>x.id===id);
  const d = document.getElementById('s-naiken-date')?.value || todayISO();
  const p = document.getElementById('s-naiken-prop')?.value.trim() || '';
  c.dates.naiken = d;
  if(p) c.dates.naikenProp = p;
  slackSend(SLACK_CH.å†…è¦‹, [
    ...slackHeader('ğŸ ','å†…è¦‹å®Œäº†ï¼ˆè³ƒè²¸ï¼‰'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+(p||'â€”'),
    'ğŸ“… *å†…è¦‹æ—¥*ï¼š'+d,
    ...slackFooter(),
  ]);
  advance(id, 'apply', null, null, 'å†…è¦‹å®Œäº†');
}
function naikenSkip(id) {
  if(!confirm('è¦‹é€ã‚Šã«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  advance(id, 'cancel', null, null, 'è¦‹é€ã‚Šï¼ˆå†…è¦‹å¾Œï¼‰');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å†…è¦‹ä¾é ¼æ›¸ç™ºè¡Œãƒ¢ãƒ¼ãƒ€ãƒ«
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ ITé‡èª¬æ—¥ç¨‹ ãƒ˜ãƒ«ãƒ‘ãƒ¼ â”€â”€
function saveTrackingNo(cid) {
  const c = CASES.find(x=>x.id===cid); if(!c) return;
  const inp = document.getElementById('trk-'+cid);
  if (!inp) return;
  c.trackingNo = inp.value.trim();
  // URLã‚’å†ç”Ÿæˆã—ã¦è¿½è·¡ç•ªå·ã‚’å«ã‚ã‚‹
  if (c.bookingUrl) {
    const newUrl = buildBookingUrl(c);
    c.bookingUrl = newUrl;
  }
  toast('è¿½è·¡ç•ªå·ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  render(); open_case(cid);
}

function copyBookingUrl(btn) {
  const url = btn.dataset.url;
  navigator.clipboard.writeText(url)
    .then(() => toast('ğŸ“‹ æ—¥ç¨‹é¸æŠãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'))
    .catch(() => { prompt('ãƒªãƒ³ã‚¯:', url); });
}

function copyMeetLink(cid) {
  const c = CASES.find(x=>x.id===cid);
  if (!c || !c.itBooking || !c.itBooking.meetUrl) { toast('Meet URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  navigator.clipboard.writeText(c.itBooking.meetUrl)
    .then(()=>toast('ğŸ“‹ Meet URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'))
    .catch(()=>{ prompt('Meet URL:', c.itBooking.meetUrl); });
}

function checkItBooking(cid) {
  const c = CASES.find(x=>x.id===cid);
  if (!c) return;
  // localStorageã‹ã‚‰ã‚¹ãƒ­ãƒƒãƒˆã‚’ç¢ºèª
  // â‘¢ æ­£ã—ã„ã‚­ãƒ¼: coreto_itsetsu_bookingsï¼ˆbooking.htmlã¨å…±æœ‰ï¼‰
  let bookings = [];
  try { bookings = JSON.parse(localStorage.getItem('coreto_itsetsu_bookings')||'[]'); } catch(e) {}
  const booked = bookings.find(function(b){ return b.caseId === cid && b.status === 'active'; });
  if (!booked) { toast('ã¾ã äºˆç´„ãŒå…¥ã£ã¦ã„ã¾ã›ã‚“'); return; }

  // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’æ¡ˆä»¶ã«ã‚»ãƒƒãƒˆï¼ˆbooking.htmlã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«åˆã‚ã›ã‚‹ï¼‰
  c.itBooking = {
    slotId:    booked.slotId,
    agentId:   booked.itAgentId,
    agentName: booked.itAgentName,
    agentMobile: '',
    date:      booked.date,
    time:      booked.start,
    dur:       booked.dur || 60,
    meetUrl:   booked.meetUrl,
    clientName:booked.clientName,
    bookedAt:  booked.bookedAt,
  };
  if (!c.hist) c.hist = [];
  c.hist.unshift(today() + ' ITé‡èª¬æ—¥ç¨‹ç¢ºå®š ' + booked.date + ' ' + booked.time);

  // Slacké€šçŸ¥ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨é‡èª¬æ‹…å½“ã¸ï¼‰
  const u = window._SESSION || {};
  const WD=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const d = new Date(booked.date+'T00:00:00');
  const fmtd = (d.getMonth()+1)+'/'+ d.getDate()+'ï¼ˆ'+WD[d.getDay()]+'ï¼‰';
  slackSend(SLACK_CH.é‡èª¬æ—¥ç¨‹, [
    ...slackHeader('ğŸ“…', 'ITé‡èª¬ æ—¥ç¨‹ç¢ºå®š'),
    'ğŸ†” *æ¡ˆä»¶ID*ï¼š' + cid,
    'ğŸ‘¤ *ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ*ï¼š' + c.name,
    'ğŸ  *ç‰©ä»¶*ï¼š' + (c.apps.find(a=>a.status==='approved')?.prop || c.sub || 'â€”'),
    'ğŸ“… *æ—¥æ™‚*ï¼š' + fmtd + 'ã€€' + booked.time + 'ï¼ˆ' + booked.dur + 'åˆ†ï¼‰',
    'ğŸ‘©â€ğŸ’¼ *é‡èª¬æ‹…å½“*ï¼š' + booked.agentName + (booked.agentMobile ? 'ã€€ğŸ“±' + booked.agentMobile : ''),
    'ğŸ‘¨â€ğŸ’¼ *æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ*ï¼š' + (u.name || u.userId || 'â€”'),
    'ğŸ¥ *Google Meet*ï¼š' + booked.meetUrl,
    ...slackFooter(),
  ]);

  render();
  open_case(cid);
  toast('âœ… äºˆç´„ã‚’ç¢ºèªã—ã¾ã—ãŸï¼Slackã«é€šçŸ¥ã—ã¾ã—ãŸ');
}

// â”€â”€ å†…è¦‹ä¾é ¼æ›¸ãƒšãƒ¼ã‚¸ã‚’æ¡ˆä»¶æƒ…å ±ä»˜ãã§èµ·å‹• â”€â”€
function launchNaikenPage(cid) {
  const c = CASES.find(x => x.id === cid);
  if (!c) return;

  // ç‰©ä»¶åãƒ»å†…è¦‹æ—¥ã¯ãƒ‘ãƒãƒ«ã®å…¥åŠ›å€¤ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°caseã‹ã‚‰å–å¾—
  const propEl = document.getElementById('s-sale-prop') || document.getElementById('s-naiken-prop');
  const dateEl = document.getElementById('s-naiken-date');
  const prop   = (propEl && propEl.value.trim()) || c.sub || '';
  const date   = (dateEl && dateEl.value) || c.dates?.naiken || '';

  const params = new URLSearchParams();
  params.set('caseId', cid);
  if (prop) params.set('prop', prop);
  if (date) params.set('date', date);

  location.href = 'coreto-naiken.html?' + params.toString();
}

// ç”³è¾¼ãƒ»å¯©æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰åˆ¥ç‰©ä»¶ã®å†…è¦‹ä¾é ¼æ›¸ã‚’ç™ºè¡Œï¼ˆç‰©ä»¶åã¯ç©ºç™½ã§èµ·å‹•ï¼‰
function launchNaikenFromStep(cid) {
  const params = new URLSearchParams();
  params.set('caseId', cid);
  // åˆ¥ç‰©ä»¶ã®ãŸã‚ prop ã¯ç©º â€” naiken.html ã§æ–°ãŸã«å…¥åŠ›
  location.href = 'coreto-naiken.html?' + params.toString();
}

function openNaikenDoc(cid) {
  const c = CASES.find(x => x.id === cid);
  const u = window._SESSION || {};

  // ç‰©ä»¶åã‚’ç¾åœ¨ã®å…¥åŠ›å€¤ or case ã‹ã‚‰å–å¾—
  const propVal = (document.getElementById('s-sale-prop') || document.getElementById('s-naiken-prop'))?.value || c?.sub || '';
  const dateVal = document.getElementById('s-naiken-date')?.value || new Date().toISOString().slice(0,10);

  // æ™‚åˆ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  const h = '10', m = '00';

  const overlay = document.createElement('div');
  overlay.id = 'naiken-doc-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';

  overlay.innerHTML = `
    <div style="background:#11141f;border:1px solid #2a3050;border-radius:16px;width:min(460px,100%);max-height:90vh;overflow-y:auto;font-family:inherit">
      <div style="padding:18px 20px;border-bottom:1px solid #1e2235;display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:800;color:#e8eaf0">ğŸ“„ å†…è¦‹ä¾é ¼æ›¸</div>
          <div style="font-size:10px;color:#5a6080;margin-top:2px">FAXé€ä»˜ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</div>
        </div>
        <button onclick="document.getElementById('naiken-doc-overlay').remove()" style="background:transparent;border:none;color:#5a6080;cursor:pointer;font-size:18px;padding:4px 8px">âœ•</button>
      </div>
      <div style="padding:20px">
        <div class="fi">
          <label>ç®¡ç†ä¼šç¤¾å <span style="color:#f87171">*</span></label>
          <input type="text" id="nd-mgmt" placeholder="ã€‡ã€‡ä¸å‹•ç”£æ ªå¼ä¼šç¤¾">
        </div>
        <div class="fi">
          <label>ç‰©ä»¶å <span style="color:#f87171">*</span></label>
          <input type="text" id="nd-prop" value="${propVal}" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·">
        </div>
        <div class="fi">
          <label>å†…è¦‹æ—¥</label>
          <input type="date" id="nd-date" class="mono" value="${dateVal}">
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <div style="flex:1">
            <label style="font-size:11px;color:#a0a8c0;display:block;margin-bottom:4px">æ™‚ï¼ˆæ™‚é–“ï¼‰</label>
            <select id="nd-hour" style="width:100%;background:#090b13;border:1px solid #2a3050;border-radius:8px;padding:8px 10px;color:#e8eaf0;font-family:inherit;font-size:12px">
              ${[...Array(13)].map((_,i)=>'<option value="'+(i+8)+'"'+(i+8===10?' selected':'')+'>'+String(i+8).padStart(2,'0')+'</option>').join('')}
            </select>
          </div>
          <div style="flex:1">
            <label style="font-size:11px;color:#a0a8c0;display:block;margin-bottom:4px">åˆ†</label>
            <select id="nd-min" style="width:100%;background:#090b13;border:1px solid #2a3050;border-radius:8px;padding:8px 10px;color:#e8eaf0;font-family:inherit;font-size:12px">
              <option value="00" selected>00</option>
              <option value="15">15</option>
              <option value="30">30</option>
              <option value="45">45</option>
            </select>
          </div>
        </div>
        <div class="fi">
          <label>é›†åˆå ´æ‰€ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" id="nd-place" placeholder="ç‰©ä»¶å‰ãƒ»ç®¡ç†ä¼šç¤¾å‰ãªã©">
        </div>
        <div style="background:#090b13;border:1px solid #1e2235;border-radius:8px;padding:12px;margin-bottom:16px;font-size:11px;color:#a0a8c0;line-height:1.8">
          <div style="font-size:10px;color:#5a6080;letter-spacing:1px;margin-bottom:6px">æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</div>
          <strong style="color:#e8eaf0">${u.name || 'â€”'}</strong>ã€€ID: ${u.userId || 'â€”'}<br>
          æºå¸¯: ${u.mobile || '080-XXXX-XXXX'}
        </div>
        <div style="display:flex;gap:8px">
          <button onclick="document.getElementById('naiken-doc-overlay').remove()" style="flex:1;background:transparent;border:1px solid #2a3050;color:#a0a8c0;border-radius:8px;padding:11px;cursor:pointer;font-family:inherit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button onclick="printNaikenDoc()" style="flex:2;background:rgba(201,168,76,.12);border:1px solid rgba(201,168,76,.35);color:#c9a840;border-radius:8px;padding:11px;cursor:pointer;font-family:inherit;font-weight:700">ğŸ“„ ç™ºè¡Œãƒ»å°åˆ·ï¼ˆFAXï¼‰</button>
        </div>
      </div>
    </div>`;

  document.body.appendChild(overlay);
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  setTimeout(() => document.getElementById('nd-mgmt')?.focus(), 100);
}

function printNaikenDoc() {
  const mgmt  = document.getElementById('nd-mgmt')?.value.trim();
  const prop  = document.getElementById('nd-prop')?.value.trim();
  if (!mgmt) { alert('ç®¡ç†ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); document.getElementById('nd-mgmt')?.focus(); return; }
  if (!prop) { alert('ç‰©ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); document.getElementById('nd-prop')?.focus(); return; }

  const dateV = document.getElementById('nd-date')?.value;
  const hour  = document.getElementById('nd-hour')?.value || '10';
  const min   = document.getElementById('nd-min')?.value  || '00';
  const place = document.getElementById('nd-place')?.value || '';
  const u     = window._SESSION || {};

  let month = 'ã€€', day = 'ã€€';
  if (dateV) { const d = new Date(dateV); month = d.getMonth()+1; day = d.getDate(); }

  const html = buildNaikenPrintHTML({ mgmt, prop, month, day, hour, min, place, agent: u, agentId: u.userId || 'â€”â€”' });
  const w = window.open('', '_blank', 'width=820,height=1100');
  w.document.write(html);
  w.document.close();
  w.onload = () => w.print();

  document.getElementById('naiken-doc-overlay')?.remove();
}

function buildNaikenPrintHTML({ mgmt, prop, month, day, hour, min, place, agent, agentId }) {
  const agentName    = agent.name    || 'æ‹…å½“è€…å';
  const agentMobile  = agent.mobile  || '080-XXXX-XXXX';
  const agentLicense = agent.license || 'æ±äº¬éƒ½çŸ¥äº‹(X)ç¬¬XXXXXå·';

  return `<!DOCTYPE html>
<html lang="ja"><head><meta charset="UTF-8">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans JP',sans-serif;background:#fff;color:#000;padding:20mm 18mm}
.title{font-size:22px;font-weight:700;text-align:center;border:2px solid #000;padding:8px 0;margin-bottom:24px;letter-spacing:4px}
.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px}
.to-company{font-size:18px;font-weight:700;border-bottom:2px solid #000;padding-bottom:4px;min-width:220px;display:inline-block}
.from{font-size:11px;line-height:1.8}
.field-row{display:flex;align-items:center;margin-bottom:20px;border-bottom:1.5px solid #555;padding-bottom:14px}
.field-label{font-size:14px;font-weight:700;width:80px}
.field-value{font-size:20px;font-weight:700;flex:1;padding-left:16px}
.body-text{font-size:13px;margin-bottom:8px;font-weight:500}
.note{font-size:13px;font-weight:700;margin-top:16px}
.card-wrap{margin-top:28px}
.card-label{font-size:11px;color:#888;margin-bottom:6px;font-weight:700}
.card{border:2px solid #1a2744;display:flex;width:91mm;height:55mm;overflow:hidden}
.card-left{background:#1a2744;padding:9mm 8mm;flex:1;display:flex;flex-direction:column;justify-content:space-between}
.card-name{color:#fff;font-size:15px;font-weight:700;letter-spacing:1.5px;margin-bottom:3px}
.card-kana{color:#a0b8d0;font-size:8px;letter-spacing:1px;margin-bottom:8px}
.card-info{color:#d0d8e8;font-size:8px;line-height:1.85}
.card-info .lbl{color:#c9a84c;font-size:7.5px}
.card-id{color:#7090b0;font-size:7.5px;margin-top:6px;letter-spacing:.5px}
.card-right{padding:8mm 7mm;display:flex;flex-direction:column;align-items:flex-end;justify-content:space-between;min-width:28mm;background:#fff}
.card-logo{font-size:13px;color:#1a2744;font-weight:900;letter-spacing:2px;font-family:monospace}
.card-mobile-lg{font-size:10px;font-weight:700;color:#1a2744;font-family:monospace;margin-bottom:2px}
.card-license{font-size:6.5px;color:#777;text-align:right;line-height:1.5}
</style></head><body>
<div class="title">å†…ã€€è¦‹ã€€ä¾ã€€é ¼ã€€æ›¸</div>
<div class="header">
  <div>
    <div class="to-company">${mgmt}</div>
    <div style="font-size:13px;font-weight:700;margin-top:4px">å¾¡ä¸­</div>
  </div>
  <div class="from">
    <strong>æ ªå¼ä¼šç¤¾CORETO</strong><br>
    ã€’150-0000ã€€æ±äº¬éƒ½â—‹â—‹åŒºâ—‹â—‹ 1-1-1<br>
    <strong>Telï¼š03-XXXX-XXXX</strong>ã€€<strong>Faxï¼š03-XXXX-XXXX</strong>
  </div>
</div>
<div class="field-row">
  <div class="field-label">ç‰©ä»¶å</div>
  <div class="field-value">${prop}</div>
</div>
<div class="field-row">
  <div class="field-label">æ—¥æ™‚</div>
  <div class="field-value" style="font-size:22px">${month}ã€€æœˆã€€${day}ã€€æ—¥</div>
</div>
<div class="field-row">
  <div class="field-label">æ™‚é–“</div>
  <div class="field-value" style="font-size:22px">${hour}ã€€æ™‚ã€€${min}ã€€åˆ†</div>
</div>
${place ? '<div class="field-row"><div class="field-label">é›†åˆå ´æ‰€</div><div class="field-value" style="font-size:16px">' + place + '</div></div>' : ''}
<p class="body-text">ä¸Šè¨˜ç‰©ä»¶ã‚’å†…è¦‹ã•ã›ã¦é ‚ãã¾ã™ã€‚</p>
<p class="body-text">å®œã—ããŠé¡˜ã„è‡´ã—ã¾ã™ã€‚</p>
<p class="note">â€»ã€€ä¸‹è¨˜æºå¸¯ã¾ã§ã”é€£çµ¡ä¸‹ã•ã„</p>
<div class="card-wrap">
  <div class="card-label">æ‹…å½“è€…ååˆº</div>
  <div class="card">
    <div class="card-left">
      <div>
        <div class="card-name">${agentName}</div>
        <div class="card-kana">ä¸å‹•ç”£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</div>
        <div class="card-info">
          <div>æ ªå¼ä¼šç¤¾CORETO</div>
          <div>ã€’150-0000ã€€æ±äº¬éƒ½â—‹â—‹åŒºâ—‹â—‹ 1-1-1</div>
          <div><span class="lbl">Telï¼š</span>03-XXXX-XXXXã€€<span class="lbl">Faxï¼š</span>03-XXXX-XXXX</div>
          <div><span class="lbl" style="color:#f59e0b">æºå¸¯ï¼š</span><strong style="color:#f0c040">${agentMobile}</strong></div>
        </div>
      </div>
      <div class="card-id">IDï¼š${agentId}</div>
    </div>
    <div class="card-right">
      <div class="card-logo">CORETO</div>
      <div style="text-align:right">
        <div class="card-mobile-lg">${agentMobile}</div>
        <div class="card-license">${agentLicense}<br>æ±äº¬éƒ½çŸ¥äº‹å…è¨±</div>
      </div>
    </div>
  </div>
</div>
</body></html>`;
}



function submitApply(id) {
  const prop = document.getElementById('s-prop')?.value.trim();
  const mgmt = document.getElementById('s-mgmt')?.value.trim();
  const date = document.getElementById('s-apply-date')?.value || todayISO();
  if(!prop||!mgmt){alert('ç‰©ä»¶åã¨ç®¡ç†ä¼šç¤¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const c = CASES.find(x=>x.id===id);
  c.apps.push({id:'A'+Date.now().toString().slice(-5), prop, mgmt, date, status:'reviewing'});
  c.dates.applied = date;
  slackSend(SLACK_CH.å¯©æŸ», [
    ...slackHeader('ğŸ“‹','ç”³è¾¼æå‡º'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+prop,
    'ğŸ¢ *ç®¡ç†ä¼šç¤¾*ï¼š'+mgmt,
    'ğŸ“… *ç”³è¾¼æ—¥*ï¼š'+date,
    ...slackFooter(),
  ]);
  advance(id, 'screening', null, null, prop+' ç”³è¾¼');
}

function addApp(id) {
  const c = CASES.find(x=>x.id===id);
  const activeCount = c.apps.filter(a=>a.status==='reviewing'||a.status==='submitted').length;
  openModal(
    'ï¼‹ ç”³è¾¼è¿½åŠ '
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="m-prop" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 1LDK"></div>'
    +'<div class="fi"><label>ç®¡ç†ä¼šç¤¾</label><input type="text" id="m-mgmt" placeholder="ã€‡ã€‡ç®¡ç†æ ªå¼ä¼šç¤¾"></div>'
    +(activeCount>0?'<div style="margin:10px 0 4px"><label style="display:flex;align-items:center;gap:7px;font-size:11px;cursor:pointer"><input type="checkbox" id="m-sim" checked> åŒæ™‚ç”³è¾¼ã¨ã—ã¦ãƒãƒ¼ã‚¯</label></div>':'')
    +'<div class="row" style="margin-top:14px"><button class="btn btn-ghost" style="flex:1" onclick="closeModal()">æˆ»ã‚‹</button>'
    +'<button class="btn btn-green" style="flex:2;justify-content:center" onclick="doAddApp(\''+id+'\')">ç”³è¾¼è¿½åŠ </button></div>'
  );
}

function doAddApp(id) {
  const prop = document.getElementById('m-prop')?.value.trim();
  const mgmt = document.getElementById('m-mgmt')?.value.trim();
  const sim  = document.getElementById('m-sim')?.checked || false;
  if(!prop||!mgmt){alert('å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const c = CASES.find(x=>x.id===id);
  c.apps.push({id:'A'+Date.now().toString().slice(-5), prop, mgmt, date:todayISO(), status:'reviewing', sim});
  c.hist.unshift(today()+' '+prop+' ç”³è¾¼è¿½åŠ '+(sim?' (åŒæ™‚)':''));
  closeModal();
  open_case(id);
  toast('ç”³è¾¼è¿½åŠ ã—ã¾ã—ãŸ');
}

function appPassed(id, appId) {
  const c = CASES.find(x=>x.id===id);
  const a = c.apps.find(a=>a.id===appId);
  if(!a) return;
  a.status = 'approved';
  // cancel other reviewing apps
  c.apps.filter(x=>x.id!==appId&&(x.status==='reviewing'||x.status==='submitted')).forEach(x=>{x.status='cancelled';});
  if(!c.taskDone) c.taskDone={paid:false,itsetsu:false};

  // å¯©æŸ»é€šé Slack
  slackSend(SLACK_CH.å¯©æŸ», [
    ...slackHeader('âœ…','å¯©æŸ»é€šé'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+a.prop,
    'ğŸ¢ *ç®¡ç†ä¼šç¤¾*ï¼š'+(a.mgmt||'â€”'),
    ...slackFooter(),
  ]);

  advance(id, 'invoice', 'approved', todayISO(), a.prop+' å¯©æŸ»é€šé â†’ è«‹æ±‚æ›¸ç™ºè¡Œã¸');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  é‡èª¬ãƒªãƒ³ã‚¯ç™ºè¡Œ å…±é€šãƒ­ã‚¸ãƒƒã‚¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildBookingUrl(c) {
  const u = window._SESSION || {};
  const app = (c.apps || []).find(function(a){ return a.status === 'approved'; })
    || (c.apps || [])[c.apps.length - 1] || {};
  const dedicatedId = c.agent || u.userId || '';
  const params = new URLSearchParams({
    caseId:      c.id,
    client:      encodeURIComponent(c.name || ''),
    prop:        encodeURIComponent(app.prop || c.sub || ''),
    agent:       encodeURIComponent(u.name || u.userId || ''),
    agentId:     u.userId || '',
    dedicatedId: dedicatedId,
  });
  if (c.trackingNo) params.set('tracking', c.trackingNo);
  if (c.tel)        params.set('tel', c.tel);
  return location.origin + location.pathname.replace(/[^/]+$/, '')
    + 'coreto-itsetsu-booking.html?' + params.toString();
}

// è­¦å‘Šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãç™ºè¡Œãƒ•ãƒ­ãƒ¼
function bookingLinkBlock(c) {
  let html = '<div style="margin-top:12px;padding-top:12px;border-top:1px dashed var(--border2)">';
  html += '<div style="font-size:10px;color:var(--gold-dim,#7a5f22);font-weight:700;margin-bottom:8px;letter-spacing:.05em">ğŸ“… é‡èª¬æ—¥ç¨‹èª¿æ•´ãƒªãƒ³ã‚¯</div>';

  if (c.bookingUrl) {
    // ç™ºè¡Œæ¸ˆã¿: URLã‚³ãƒ”ãƒ¼ + å†ç™ºè¡Œ
    html += '<div style="background:var(--card2);border:1px solid var(--border2);border-radius:6px;padding:7px 10px;font-size:10px;word-break:break-all;font-family:monospace;color:var(--blue);margin-bottom:8px">' + c.bookingUrl + '</div>';
    html += '<div style="display:flex;gap:6px;margin-bottom:6px">';
    html += '<button class="btn btn-ghost btn-sm" style="flex:1;justify-content:center" data-url="'+c.bookingUrl+'" onclick="copyBookingUrl(this)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>';
    html += '<button class="btn btn-ghost btn-sm" style="flex:1;justify-content:center" data-cid="'+c.id+'" onclick="launchBookingLink(this.dataset.cid)">ğŸ”„ å†ç™ºè¡Œ</button>';
    html += '</div>';
    // â‘¦ è¿½è·¡ç•ªå·å¾Œä»˜ã‘
    const trk = c.trackingNo || '';
    html += '<div style="display:flex;gap:6px;align-items:center">';
    html += '<input id="trk-'+c.id+'" type="text" placeholder="è¿½è·¡ç•ªå·ã‚’è¿½åŠ " value="'+trk+'" style="flex:1;background:var(--card2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;color:var(--t);font-size:10px;font-family:monospace;outline:none">';
    html += '<button class="btn btn-ghost btn-sm" data-cid="'+c.id+'" onclick="saveTrackingNo(this.dataset.cid)" style="white-space:nowrap">ğŸ’¾ ä¿å­˜</button>';
    html += '</div>';
  } else {
    // æœªç™ºè¡Œ
    html += '<button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;border-color:var(--gold);color:var(--gold)" data-cid="'+c.id+'" onclick="launchBookingLink(this.dataset.cid)">ğŸ“… æ—¥ç¨‹èª¿æ•´ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œ</button>';
  }

  html += '</div>';
  return html;
}

function launchBookingLink(cid) {
  const c = CASES.find(function(x){ return x.id === cid; });
  if (!c) return;

  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.72);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';
  overlay.innerHTML = `
    <div style="background:#11141f;border:1px solid #2a3050;border-radius:16px;width:min(460px,100%);font-family:inherit">
      <div style="padding:16px 20px;border-bottom:1px solid #1e2235">
        <div style="font-size:14px;font-weight:800;color:#e06060;font-family:'Syne',sans-serif">âš ï¸ é‡èª¬æ—¥ç¨‹èª¿æ•´ãƒªãƒ³ã‚¯ç™ºè¡Œ</div>
        <div style="font-size:10px;color:#5a6080;margin-top:2px">${c.name} æ§˜ / ${c.id}</div>
      </div>
      <div style="padding:18px 20px">
        <div class="warn-agree-box">
          <strong>å¿…ãšã”ç¢ºèªãã ã•ã„</strong><br><br>
          ğŸ“„ é‡èª¬ã¯<strong>å¥‘ç´„æ›¸ãŒå±Šã„ãŸå¾Œ</strong>ã«ã—ã‹å®Ÿæ–½ã§ãã¾ã›ã‚“ã€‚<br>
          ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å¿…ãšãã®æ—¨ã‚’ãŠä¼ãˆã—ã¦æ—¥ç¨‹ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚<br><br>
          â° ç›´å‰ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰ã§æ—¥ç¨‹å¤‰æ›´ã«ãªã£ãŸå ´åˆã€<strong>ç·Šæ€¥å¯¾å¿œè²»ç”¨ã¨ã—ã¦Â¥3,000ãŒã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¼•ã‹ã‚Œã¾ã™ã€‚</strong>
          <label class="warn-chk-row">
            <input type="checkbox" id="warn-chk-1" onchange="checkWarnReady()">
            <span>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã€Œå¥‘ç´„æ›¸åˆ°ç€å¾Œã«é‡èª¬å®Ÿæ–½ã€ã®æ—¨ã‚’ä¼ãˆã‚‹ã“ã¨ã‚’ç†è§£ã—ã¾ã—ãŸ</span>
          </label>
          <label class="warn-chk-row">
            <input type="checkbox" id="warn-chk-2" onchange="checkWarnReady()">
            <span>ç›´å‰å¤‰æ›´æ™‚ã«Â¥3,000ãŒã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¼•ã‹ã‚Œã‚‹ã“ã¨ã‚’ç†è§£ã—ã¾ã—ãŸ</span>
          </label>
        </div>
        <div style="margin-bottom:14px">
          <div style="font-size:11px;color:#a0a8c0;margin-bottom:6px">ğŸ“¦ éƒµä¾¿è¿½è·¡ç•ªå·ï¼ˆä»»æ„ï¼‰</div>
          <input type="text" id="warn-tracking" placeholder="ä¾‹: 1234567890123"
            style="width:100%;background:#090b13;border:1px solid #2a3050;border-radius:7px;
            padding:8px 10px;color:#e0e8f0;font-family:'DM Mono',monospace;font-size:13px;
            letter-spacing:.08em;outline:none;box-sizing:border-box">
          <div style="font-size:10px;color:#5a6080;margin-top:4px">å…¥åŠ›ã™ã‚‹ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«éƒµä¾¿å±€ã®è¿½è·¡ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
        <div style="display:flex;gap:8px">
          <button onclick="this.closest('div[style*=fixed]').remove()"
            style="flex:1;background:transparent;border:1px solid #2a3050;color:#a0a8c0;border-radius:8px;padding:10px;cursor:pointer;font-family:inherit">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="warn-issue-btn" disabled
            onclick="issueBookingLink('${cid}')"
            style="flex:2;background:rgba(201,168,64,.08);border:1px solid rgba(201,168,64,.2);color:#666;border-radius:8px;padding:10px;cursor:not-allowed;font-family:inherit;font-weight:700;transition:.2s">
            ğŸ“‹ ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œã™ã‚‹</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function checkWarnReady() {
  const c1 = document.getElementById('warn-chk-1');
  const c2 = document.getElementById('warn-chk-2');
  const btn = document.getElementById('warn-issue-btn');
  if (!btn) return;
  const ok = c1 && c2 && c1.checked && c2.checked;
  btn.disabled = !ok;
  btn.style.color = ok ? '#c9a840' : '#666';
  btn.style.borderColor = ok ? 'rgba(201,168,64,.35)' : 'rgba(201,168,64,.2)';
  btn.style.cursor = ok ? 'pointer' : 'not-allowed';
  btn.style.background = ok ? 'rgba(201,168,64,.12)' : 'rgba(201,168,64,.08)';
}

function issueBookingLink(cid) {
  const c = CASES.find(function(x){ return x.id === cid; });
  if (!c) return;
  const trackingInput = document.getElementById('warn-tracking');
  if (trackingInput && trackingInput.value.trim()) {
    c.trackingNo = trackingInput.value.trim();
  }
  const url = buildBookingUrl(c);
  c.bookingUrl = url;
  // Close warning overlay
  const overlay = document.querySelector('div[style*="fixed"][style*="9999"]');
  if (overlay) overlay.remove();
  // Slack notify
  const u = window._SESSION || {};
  const app = (c.apps || []).find(function(a){ return a.status === 'approved'; }) || {};
  slackSend(SLACK_CH.é‡èª¬æ—¥ç¨‹, [
    ...slackHeader('ğŸ“…','ITé‡èª¬ æ—¥ç¨‹èª¿æ•´ãƒªãƒ³ã‚¯ç™ºè¡Œ'),
    'ğŸ†” *æ¡ˆä»¶ID*ï¼š' + c.id,
    'ğŸ‘¤ *ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ*ï¼š' + c.name,
    'ğŸ  *ç‰©ä»¶*ï¼š' + (app.prop || c.sub || 'â€”'),
    'ğŸ‘¨â€ğŸ’¼ *æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ*ï¼š' + (u.name || u.userId || 'â€”'),
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'ğŸ“ *æ—¥ç¨‹èª¿æ•´URL*ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä»˜ï¼‰ï¼š',
    url,
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'â€» ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯ã€Œå¥‘ç´„æ›¸åˆ°ç€å¾Œã«é‡èª¬å®Ÿæ–½ã€ã®æ—¨ã‚’å¿…ãšãŠä¼ãˆãã ã•ã„',
    ...slackFooter(),
  ]);
  // Show link modal
  showBookingLinkModal(cid, url);
  open_case(cid);
}

function showBookingLinkModal(caseId, url) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';
  overlay.innerHTML = `
    <div style="background:#11141f;border:1px solid #2a3050;border-radius:16px;width:min(440px,100%);font-family:inherit">
      <div style="padding:16px 20px;border-bottom:1px solid #1e2235">
        <div style="font-size:14px;font-weight:800;color:#c9a840;font-family:'Syne',sans-serif">ğŸ“… ITé‡èª¬ æ—¥ç¨‹èª¿æ•´ãƒªãƒ³ã‚¯</div>
        <div style="font-size:10px;color:#5a6080;margin-top:2px">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä»˜ã—ã¦ãã ã•ã„</div>
      </div>
      <div style="padding:18px 20px">
        <div style="background:#090b13;border:1px solid #2a3050;border-radius:8px;padding:10px 12px;font-size:10px;
          font-family:'DM Mono',monospace;color:#a0b0c0;word-break:break-all;margin-bottom:12px;line-height:1.7">
          ${url}
        </div>
        <div style="background:rgba(201,168,64,.06);border:1px solid rgba(201,168,64,.2);border-radius:8px;
          padding:10px 12px;font-size:11px;color:#a0905a;line-height:1.8;margin-bottom:14px">
          â‘  URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«LINEãƒ»ãƒ¡ãƒ¼ãƒ«ã§é€ä»˜<br>
          â‘¡ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ—¥ç¨‹ã‚’é¸æŠã™ã‚‹ã¨è‡ªå‹•ã§ãƒãƒƒãƒãƒ³ã‚°<br>
          â‘¢ é‡èª¬æ‹…å½“ãƒ»æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåŒæ–¹ã«Slacké€šçŸ¥ãŒå±Šãã¾ã™
        </div>
        <div style="display:flex;gap:8px">
          <button onclick="this.closest('div[style*=fixed]').remove()"
            style="flex:1;background:transparent;border:1px solid #2a3050;color:#a0a8c0;
            border-radius:8px;padding:10px;cursor:pointer;font-family:inherit">é–‰ã˜ã‚‹</button>
          <button onclick="navigator.clipboard.writeText('${url.replace(/'/g, "\'")}').then(()=>{this.textContent='âœ… ã‚³ãƒ”ãƒ¼æ¸ˆã¿';setTimeout(()=>this.textContent='ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼',2000)})"
            style="flex:2;background:rgba(201,168,64,.12);border:1px solid rgba(201,168,64,.35);
            color:#c9a840;border-radius:8px;padding:10px;cursor:pointer;font-family:inherit;font-weight:700">
            ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function appRejected(id, appId) {
  const c = CASES.find(x=>x.id===id);
  const a = c.apps.find(a=>a.id===appId);
  if(!a) return;
  a.status = 'rejected';
  c.hist.unshift(today()+' '+a.prop+' å¯©æŸ»è½ã¡');
  const remaining = c.apps.filter(x=>x.status==='reviewing'||x.status==='submitted');
  if(remaining.length===0) c.hist.unshift(today()+' å…¨ç‰©ä»¶è½ã¡ â†’ åˆ¥ç‰©ä»¶è¿½åŠ ã—ã¦ãã ã•ã„');
  slackSend(SLACK_CH.å¯©æŸ», [
    ...slackHeader('âŒ','å¯©æŸ»è½ã¡'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+a.prop,
    'ğŸ¢ *ç®¡ç†ä¼šç¤¾*ï¼š'+(a.mgmt||'â€”'),
    remaining.length===0 ? 'âš  *å…¨ç‰©ä»¶è½ã¡* â€” åˆ¥ç‰©ä»¶è¿½åŠ ãŒå¿…è¦ã§ã™' : 'ğŸ“‹ æ®‹å¯©æŸ»ä¸­: '+remaining.length+'ä»¶',
    ...slackFooter(),
  ]);
  open_case(id);
}

function stepInvoice(c) {
  if (c.type==='sannai') return stepInvoiceSannai(c);
  const isSale = c.type==='reSale';
  if (isSale) return stepInvoiceSale(c);

  const app = c.apps.find(a=>a.status==='approved') || c.apps[c.apps.length-1] || {};
  const now = new Date();
  const due = new Date(now.getTime()+30*864e5).toISOString().slice(0,10);
  const ym = now.getFullYear()+String(now.getMonth()+1).padStart(2,'0');
  const invNumComm   = 'INV-'+ym+'-'+c.agent+'-A';
  const invNumAD     = 'INV-'+ym+'-'+c.agent+'-B';
  const invNumSingle = 'INV-'+ym+'-'+c.agent;
  const rentMatch = (c.sub||'').match(/Â¥([\d,]+)/);
  const rentGuess = rentMatch ? rentMatch[1].replace(/,/g,'') : '';
  const inv = c.invoice || {};
  const prevRent   = inv.rent   || rentGuess;
  const prevType   = inv.type   || 'commission';
  const prevFmt    = inv.adFmt  || null;
  const prevItems  = inv.items  || [{desc:'ä»²ä»‹æ‰‹æ•°æ–™',amt:''}];
  const prevAdAmt  = inv.adAmt  || '';
  const prevReason = inv.underReason || '';
  const id = c.id;

  const tabs = [
    {v:'commission', label:'ä»²ä»‹æ‰‹æ•°æ–™ã®ã¿'},
    {v:'ad_plus',    label:'ADï¼‹ä»²ä»‹æ‰‹æ•°æ–™'},
    {v:'ad_only',    label:'ADã®ã¿'},
  ];
  const tabHtml = tabs.map(t=>{
    const active = prevType===t.v;
    const bg = active ? 'background:var(--gold);color:#000' : 'background:var(--card2);color:var(--sub)';
    return '<button onclick="invSetType(this)" data-cid="'+id+'" data-type="'+t.v+'" style="flex:1;padding:7px 4px;border:none;cursor:pointer;font-size:11px;font-weight:600;border-radius:6px;'+bg+'">'+t.label+'</button>';
  }).join('');

  const itemRowsHtml = prevItems.map((it,i)=>invItemRow(i,it.desc,it.amt,i===0)).join('');
  const needsFmtCheck = prevType==='ad_plus' || prevType==='ad_only';
  const hasAD = prevType==='ad_plus' || prevType==='ad_only';
  const showRent = prevType==='commission' || prevType==='ad_plus' || (prevType==='ad_only' && prevFmt==='standard');
  const showItems = prevType==='commission' || prevType==='ad_plus' || (prevType==='ad_only' && prevFmt==='standard');

  const invNumHtml = (prevType==='ad_plus' && prevFmt==='standard')
    ? '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div class="fi"><label>è«‹æ±‚æ›¸ç•ªå·ï¼ˆä»²ä»‹ï¼‰</label><input type="text" class="mono" value="'+invNumComm+'" readonly style="color:var(--muted);font-size:11px;background:rgba(255,255,255,.02);cursor:not-allowed"></div><div class="fi"><label>è«‹æ±‚æ›¸ç•ªå·ï¼ˆæ¥­å‹™å§”è¨—ï¼‰</label><input type="text" class="mono" value="'+invNumAD+'" readonly style="color:var(--muted);font-size:11px;background:rgba(255,255,255,.02);cursor:not-allowed"></div></div>'
    : '<div class="fi"><label>è«‹æ±‚æ›¸ç•ªå·</label><input type="text" class="mono" value="'+invNumSingle+'" readonly style="color:var(--muted);font-size:11px;background:rgba(255,255,255,.02);cursor:not-allowed"></div>';

  const dualBadge = (prevType==='ad_plus' && prevFmt==='standard') ? (
    '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.25);border-radius:8px;font-size:11px">'
    +'<div style="color:var(--gold);font-weight:700;margin-bottom:5px">ğŸ“„ è«‹æ±‚æ›¸2æšç™ºè¡Œ</div>'
    +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub)">'
    +'<span style="color:var(--muted)">No.A</span><span>'+invNumComm+' â€” ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆæœ¬éƒ¨å®›ï¼‰</span>'
    +'<span style="color:var(--muted)">No.B</span><span>'+invNumAD+' â€” æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ï¼ˆç®¡ç†ä¼šç¤¾å®›ï¼‰</span>'
    +'</div></div>'
  ) : '';

  const adFmtHtml = needsFmtCheck ? (
    '<div style="margin-bottom:10px;padding:12px;background:var(--card2);border:1px solid var(--border2);border-radius:8px">'
    +'<div style="font-size:11px;color:var(--sub);margin-bottom:8px;font-weight:600">ğŸ“‹ ç®¡ç†ä¼šç¤¾æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</div>'
    +'<div style="display:flex;gap:8px">'
    +'<button onclick="invSetAdFmt(this)" data-cid="'+id+'" data-fmt="custom" style="flex:1;padding:7px;border:1px solid var(--border2);cursor:pointer;border-radius:6px;font-size:11px;font-weight:600;'+(prevFmt==='custom'?'background:var(--blue);color:#fff;border-color:var(--blue)':'background:transparent;color:var(--sub)')+'">ã‚ã‚Šï¼ˆæŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰</button>'
    +'<button onclick="invSetAdFmt(this)" data-cid="'+id+'" data-fmt="standard" style="flex:1;padding:7px;border:1px solid var(--border2);cursor:pointer;border-radius:6px;font-size:11px;font-weight:600;'+(prevFmt==='standard'?'background:var(--green);color:#000;border-color:var(--green)':'background:transparent;color:var(--sub)')+'">ãªã—ï¼ˆCORETOæ¨™æº–ï¼‰</button>'
    +'</div></div>'
  ) : '';

  const customFmtHtml = (needsFmtCheck && prevFmt==='custom') ? (
    '<div style="padding:14px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:8px;font-size:11px;margin-bottom:10px">'
    +'<div style="color:var(--blue);font-weight:700;margin-bottom:8px">ğŸ¦ æŒ¯è¾¼å…ˆå£åº§ï¼ˆGMOãƒãƒ¼ãƒãƒ£ãƒ«å£åº§ï¼‰</div>'
    +'<div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;color:var(--sub);line-height:1.8">'
    +'<span>éŠ€è¡Œå</span><span class="mono" style="color:var(--t)">GMOã‚ãŠãã‚‰ãƒãƒƒãƒˆéŠ€è¡Œ</span>'
    +'<span>æ”¯åº—å</span><span class="mono" style="color:var(--t)">æ³•äººå–¶æ¥­éƒ¨ï¼ˆ003ï¼‰</span>'
    +'<span>å£åº§ç¨®åˆ¥</span><span class="mono" style="color:var(--t)">æ™®é€š</span>'
    +'<span>å£åº§ç•ªå·</span><span class="mono" style="color:var(--gold);font-size:13px;letter-spacing:.1em">'+invVirtualAcct(id)+'</span>'
    +'<span>å£åº§åç¾©</span><span class="mono" style="color:var(--t)">ã‚«ï¼‰ã‚³ãƒ¬ãƒˆ</span>'
    +'</div>'
    +'<div style="margin-top:8px;padding:6px 8px;background:rgba(255,255,255,.03);border-radius:5px;color:var(--muted);font-size:10px">â€» ã“ã®å£åº§ã¯ã“ã®æ¡ˆä»¶å°‚ç”¨ã®ãƒãƒ¼ãƒãƒ£ãƒ«å£åº§ã§ã™ã€‚</div>'
    +'</div>'
  ) : '';

  return bookingLinkBlock(c) + '<div class="step-title">ğŸ§¾ è«‹æ±‚æ›¸ç™ºè¡Œ</div>'
    +'<div style="display:flex;gap:6px;margin-bottom:12px;background:var(--card2);padding:4px;border-radius:8px">'+tabHtml+'</div>'
    +'<div style="margin-bottom:4px">'+invNumHtml+'</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="inv-prop" value="'+(app.prop||'')+'" oninput="invCalc()"></div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">'
    +'<div class="fi"><label>ç™ºè¡Œæ—¥</label><input type="date" id="inv-date" class="mono" value="'+now.toISOString().slice(0,10)+'"></div>'
    +'<div class="fi"><label>æ”¯æ‰•æœŸé™</label><input type="date" id="inv-due" class="mono" value="'+due+'"></div>'
    +'</div>'
    +(showRent ? (
      '<div class="fi"><label>å®¶è³ƒï¼ˆæœˆé¡ãƒ»ç¨è¾¼ï¼‰<span style="color:var(--muted);font-size:10px;margin-left:6px">ä¸Šé™è¨ˆç®—ã®åŸºæº–é¡</span></label>'
      +'<input type="number" id="inv-rent" class="mono" placeholder="ä¾‹: 150000" value="'+(prevRent||(c.salePrice?String(c.salePrice):''))+'" oninput="invCalc()" style="font-size:13px"></div>'
    ) : '')
    +(hasAD ? (
      '<div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:end;margin-bottom:8px">'
      +'<div class="fi" style="margin-bottom:0"><label>æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ â€” é …ç›®å</label>'
      +'<input type="text" id="inv-ad-desc" placeholder="ä¾‹: æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™" value="'+(inv.adDesc||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™')+'" style="font-size:12px"></div>'
      +'<div class="fi" style="margin-bottom:0"><label>é‡‘é¡ï¼ˆç¨è¾¼ï¼‰</label>'
      +'<input type="number" id="inv-ad-amt" class="mono" placeholder="ä¾‹: 150000" value="'+prevAdAmt+'" oninput="invCalc()" style="font-size:14px"></div>'
      +'</div>'
    ) : '')
    +(showItems ? (
      '<div style="margin:10px 0 4px;font-size:11px;color:var(--sub);font-weight:600;letter-spacing:.05em">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‘ã‘è«‹æ±‚é …ç›®<span style="color:var(--muted);font-weight:400;margin-left:6px;font-size:10px">â˜…1è¡Œç›®ã®ä»²ä»‹æ‰‹æ•°æ–™ã®ã¿å®…å»ºæ¥­æ³•ä¸Šé™ãƒã‚§ãƒƒã‚¯å¯¾è±¡</span></div>'
      +'<div id="inv-items">'+itemRowsHtml+'</div>'
      +'<button onclick="invAddItem()" style="width:100%;background:transparent;border:1px dashed var(--border2);color:var(--sub);padding:7px;border-radius:7px;cursor:pointer;font-size:11px;margin-bottom:10px">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>'
    ) : '')
    +adFmtHtml
    +customFmtHtml
    +dualBadge
    +'<div id="inv-validation" style="margin-bottom:8px"></div>'
    +'<div id="inv-reason-wrap" style="display:none;margin-bottom:10px">'
    +'<div class="fi"><label style="color:var(--orange)">âš  åˆè¨ˆãŒå®¶è³ƒ1ãƒ¶æœˆåˆ†æœªæº€ â€” ç†ç”±ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„</label>'
    +'<textarea id="inv-reason" rows="2" placeholder="ä¾‹: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆäº¤æ¸‰ã®çµæœã€æ‰‹æ•°æ–™ã‚’æ¸›é¡ã€‚å…¥å±…ç‡å„ªå…ˆã®ãŸã‚ã€‚" style="font-size:12px;resize:vertical">'+prevReason+'</textarea></div>'
    +'</div>'
    +'<button class="btn btn-gold" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="issueInvoice(this.dataset.cid)">ğŸ“„ è«‹æ±‚æ›¸ç™ºè¡Œ â†’ é‡èª¬ãƒ»å…¥é‡‘ã¸</button>'

}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸‰ç‚ºå°‚ç”¨è«‹æ±‚æ›¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stepInvoiceSannai(c) {
  const now = new Date();
  const due = new Date(now.getTime()+30*864e5).toISOString().slice(0,10);
  const ym  = now.getFullYear()+String(now.getMonth()+1).padStart(2,'0');
  const inv = c.invoice || {};
  const sn  = c.sannai  || {};
  const id  = c.id;

  // â”€â”€ è²·ä»˜ã‹ã‚‰å¼•ç”¨ã—ãŸå–å¼•ä¾¡æ ¼ãƒ»æ”¯æ‰•æ‰‹æ•°æ–™ â”€â”€
  const buyPrice   = sn.buyPrice   || 0;
  const sellPrice  = sn.sellPrice  || c.salePrice || 0;
  const commBuyAmt = sn.commBuyAmt || 0;
  const commSellAmt= sn.commSellAmt|| 0;
  const delegTotal = (sn.delegPay||[]).reduce((s,r)=>s+(r.amt||0),0);
  const totalOut   = commBuyAmt + commSellAmt + delegTotal;

  // â”€â”€ æ—¢å­˜ã®è«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ï¼ˆç·¨é›†æ™‚å¼•ãç¶™ãï¼‰â”€â”€
  const prevBuyerComm  = inv.buyerComm  !== undefined ? inv.buyerComm  : (sellPrice ? Math.min(saleCommLimit(sellPrice), Math.round((sellPrice*0.03+60000)*1.1)) : '');
  const prevSellerComm = inv.sellerComm !== undefined ? inv.sellerComm : (buyPrice  ? '' : '');
  const prevBuyerDeleg = inv.buyerDeleg || [];
  const prevSellerDeleg= inv.sellerDeleg|| [];
  const prevProp = inv.prop || c.dates?.naikenProp || '';
  const prevDate = inv.date || now.toISOString().slice(0,10);
  const prevDue  = inv.due  || due;

  // è«‹æ±‚æ›¸ç•ªå·
  const invNumBuyer  = 'INV-'+ym+'-'+c.agent+'-BUY';
  const invNumSeller = 'INV-'+ym+'-'+c.agent+'-SEL';

  // ä¸Šé™
  const buyLimit  = saleCommLimit(sellPrice);
  const sellLimit = saleCommLimit(buyPrice);

  // â”€â”€ å–å¼•æ¦‚è¦ã‚µãƒãƒªãƒ¼ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰â”€â”€
  const summaryHtml = (buyPrice || sellPrice) ? (
    '<div style="margin-bottom:12px;padding:12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:10px;font-size:11px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<span style="font-size:10px;color:var(--gold);font-weight:700;letter-spacing:.8px">ğŸ“Š è²·ä»˜æƒ…å ±ï¼ˆå¼•ç”¨ï¼‰</span>'
    +'<a href="#" onclick="editSannaiOffer(\''+id+'\')" style="font-size:10px;color:var(--muted);text-decoration:none">âœ ä¿®æ­£</a>'
    +'</div>'
    +'<div style="display:grid;grid-template-columns:auto 1fr auto 1fr;gap:3px 10px;line-height:1.8">'
    +(buyPrice  ? '<span style="color:var(--muted)">ä»•å…¥ã‚Œ</span><span class="mono">Â¥'+buyPrice.toLocaleString()+'</span>' : '')
    +(sellPrice ? '<span style="color:var(--muted)">è²©å£²</span><span class="mono">Â¥'+sellPrice.toLocaleString()+'</span>' : '')
    +(buyPrice&&sellPrice ? '<span style="color:var(--muted)">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰</span><span class="mono" style="color:'+(sellPrice-buyPrice>=0?'var(--green)':'var(--red)')+'">'+((sellPrice-buyPrice>=0)?'+':'')+'Â¥'+(sellPrice-buyPrice).toLocaleString()+'</span>' : '')
    +(totalOut  ? '<span style="color:var(--muted)">æ”¯æ‰•æ‰‹æ•°æ–™è¨ˆ</span><span class="mono" style="color:var(--orange)">-Â¥'+totalOut.toLocaleString()+'</span>' : '')
    +'</div>'
    +(sn.commPayMode && sn.commPayMode!=='none' ? (
      '<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border);font-size:10px;color:var(--muted)">'
      +(commBuyAmt  ? 'è²·ã„å´ä»²ä»‹: '+(sn.commBuyCo||'â€”')+' Â¥'+commBuyAmt.toLocaleString()+'ã€€' : '')
      +(commSellAmt ? 'å£²ã‚Šå´ä»²ä»‹: '+(sn.commSellCo||'â€”')+' Â¥'+commSellAmt.toLocaleString() : '')
      +'</div>'
    ) : '')
    +((sn.delegPay||[]).length ? (
      '<div style="margin-top:4px;font-size:10px;color:var(--muted)">'
      +(sn.delegPay||[]).map(r=>'æ¥­å‹™å§”è¨—: '+(r.co||'â€”')+' Â¥'+(r.amt||0).toLocaleString()).join('ã€€')
      +'</div>'
    ) : '')
    +'</div>'
  ) : '';

  // â”€â”€ å—å–ä»²ä»‹æ‰‹æ•°æ–™: è²·ä¸»å´ â”€â”€
  const buyerCommRows = (prevBuyerDeleg.length ? prevBuyerDeleg : []).map((r,i)=>invItemRowB(i,r.desc,r.amt)).join('');
  const buyerCommLimit = buyLimit > 0 ? '<span style="font-size:10px;color:var(--muted);margin-left:6px">ä¸Šé™ Â¥'+buyLimit.toLocaleString()+'</span>' : '';

  // â”€â”€ å—å–ä»²ä»‹æ‰‹æ•°æ–™: å£²ä¸»å´ â”€â”€
  const showSellerSection = inv.hasSellerComm !== undefined ? inv.hasSellerComm : false;
  const sellerCommRows = (prevSellerDeleg.length ? prevSellerDeleg : []).map((r,i)=>sannaiInvItemRowSeller(i,r.desc,r.amt)).join('');

  return '<div class="step-title">ğŸ§¾ è«‹æ±‚æ›¸ç™ºè¡Œï¼ˆä¸‰ç‚ºï¼‰</div>'
    + summaryHtml

    // åŸºæœ¬æƒ…å ±
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="inv-prop" value="'+prevProp+'" oninput="sannaiInvCalc()"></div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'
    +'<div class="fi"><label>ç™ºè¡Œæ—¥</label><input type="date" id="inv-date" class="mono" value="'+prevDate+'"></div>'
    +'<div class="fi"><label>æ”¯æ‰•æœŸé™</label><input type="date" id="inv-due" class="mono" value="'+prevDue+'"></div>'
    +'</div>'

    // â”€â”€ è²·ä¸»å‘ã‘è«‹æ±‚æ›¸ï¼ˆå¿…é ˆï¼‰â”€â”€
    +'<div style="margin-bottom:10px;padding:12px;background:rgba(79,156,249,.06);border:1px solid rgba(79,156,249,.25);border-radius:10px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<div style="font-size:11px;color:var(--blue);font-weight:700">ğŸ“„ è²·ä¸»å‘ã‘è«‹æ±‚æ›¸ '+invNumBuyer+'</div>'
    +'<span style="font-size:9px;color:var(--blue);background:rgba(79,156,249,.15);padding:2px 7px;border-radius:4px;font-weight:600">å¿…é ˆ</span>'
    +'</div>'
    +(sellPrice ? '<div style="font-size:10px;color:var(--muted);margin-bottom:8px">è²©å£²ä¾¡æ ¼ï¼ˆä¸Šé™ï¼‰: Â¥'+sellPrice.toLocaleString()+'</div>' : '')
    +'<div style="margin-bottom:6px;font-size:10px;color:var(--sub);font-weight:600">è«‹æ±‚é …ç›®ï¼ˆä»²ä»‹æ‰‹æ•°æ–™ç­‰ï¼‰</div>'
    +'<div id="sn-inv-buyer-items">'
    +(prevBuyerDeleg.length
      ? buyerCommRows
      : invItemRowB(0, 'å£²è²·ä»£é‡‘', sellPrice||''))
    +'</div>'
    +'<button onclick="sannaiInvAddBuyerItem()" style="width:100%;background:transparent;border:1px dashed rgba(79,156,249,.4);color:var(--blue);padding:6px;border-radius:7px;cursor:pointer;font-size:11px;margin-top:4px">ï¼‹ é …ç›®è¿½åŠ </button>'
    +'<div id="sn-inv-buyer-check" style="margin-top:8px"></div>'
    +'</div>'

    // â”€â”€ å£²ä¸»å‘ã‘è«‹æ±‚æ›¸ï¼ˆä»»æ„ï¼‰â”€â”€
    +'<div style="margin-bottom:10px;padding:12px;background:rgba(52,211,153,.04);border:1px solid rgba(52,211,153,.15);border-radius:10px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<div style="font-size:11px;color:var(--green);font-weight:700">ğŸ“„ å£²ä¸»å‘ã‘è«‹æ±‚æ›¸ '+invNumSeller+'</div>'
    +'<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:10px;color:var(--sub)">'
    +'<input type="checkbox" id="sn-inv-seller-toggle"'+(showSellerSection?' checked':'')+' onchange="sannaiToggleSellerInv(this,\''+id+'\')" style="cursor:pointer"> ç™ºè¡Œã™ã‚‹'
    +'</label>'
    +'</div>'
    +(showSellerSection ? (
      (buyPrice ? '<div style="font-size:10px;color:var(--muted);margin-bottom:8px">ä»•å…¥ã‚Œä¾¡æ ¼ Â¥'+buyPrice.toLocaleString()+' ã€€ä¸Šé™: Â¥'+sellLimit.toLocaleString()+'</div>' : '')
      +'<div style="margin-bottom:6px;font-size:10px;color:var(--sub);font-weight:600">è«‹æ±‚é …ç›®ï¼ˆä»²ä»‹æ‰‹æ•°æ–™ç­‰ï¼‰</div>'
      +'<div id="sn-inv-seller-items">'
      +(prevSellerDeleg.length
        ? sellerCommRows
        : sannaiInvItemRowSeller(0, 'ä»²ä»‹æ‰‹æ•°æ–™', prevSellerComm||''))
      +'</div>'
      +'<button onclick="sannaiInvAddSellerItem()" style="width:100%;background:transparent;border:1px dashed rgba(52,211,153,.4);color:var(--green);padding:6px;border-radius:7px;cursor:pointer;font-size:11px;margin-top:4px">ï¼‹ é …ç›®è¿½åŠ </button>'
      +'<div id="sn-inv-seller-check" style="margin-top:8px"></div>'
    ) : '<div style="font-size:11px;color:var(--muted);padding:4px 0">ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨å£²ä¸»å‘ã‘è«‹æ±‚æ›¸ã‚’è¿½åŠ ç™ºè¡Œã§ãã¾ã™</div>')
    +'</div>'

    +'<div id="inv-validation" style="margin-bottom:8px"></div>'
    +'<button class="btn btn-gold" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="issueInvoiceSannai(this.dataset.cid)">ğŸ“„ è«‹æ±‚æ›¸ç™ºè¡Œ â†’ å¥‘ç´„ã¸</button>';
}

function sannaiInvItemRowSeller(idx, desc, amt) {
  return '<div class="sn-inv-row-sel" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr auto auto;gap:6px;margin-bottom:6px;align-items:center">'
    +'<input type="text" placeholder="é …ç›®å" value="'+(desc||'')+'" oninput="sannaiInvCalc()" style="font-size:12px;color:var(--green)">'
    +'<input type="number" placeholder="é‡‘é¡" value="'+(amt||'')+'" oninput="sannaiInvCalc()" class="mono" style="width:120px;font-size:13px">'
    +(idx===0
      ? '<div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:var(--green);font-size:14px">â˜…</div>'
      : '<button onclick="this.closest(\'.sn-inv-row-sel\').remove();sannaiInvCalc()" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0">Ã—</button>')
    +'</div>';
}

function sannaiInvAddBuyerItem() {
  const wrap = document.getElementById('sn-inv-buyer-items'); if(!wrap) return;
  const idx = wrap.querySelectorAll('.inv-row-b').length;
  const div = document.createElement('div');
  div.innerHTML = invItemRowB(idx,'',0);
  wrap.appendChild(div.firstChild);
  sannaiInvCalc();
}

function sannaiInvAddSellerItem() {
  const wrap = document.getElementById('sn-inv-seller-items'); if(!wrap) return;
  const idx = wrap.querySelectorAll('.sn-inv-row-sel').length;
  const div = document.createElement('div');
  div.innerHTML = sannaiInvItemRowSeller(idx,'',0);
  wrap.appendChild(div.firstChild);
  sannaiInvCalc();
}

function sannaiToggleSellerInv(cb, id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.hasSellerComm = cb.checked;
  // ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’ä¿æŒã—ã¦ã‹ã‚‰å†æç”»
  sannaiInvSave(c);
  open_case(id);
}

function sannaiInvGetBuyerItems() {
  const rows = document.querySelectorAll('#sn-inv-buyer-items .inv-row-b');
  const items = [];
  rows.forEach(r => {
    const inputs = r.querySelectorAll('input');
    const desc = inputs[0]?.value.trim()||'';
    const amt  = parseInt(inputs[1]?.value)||0;
    if(desc||amt) items.push({desc, amt});
  });
  return items;
}

function sannaiInvGetSellerItems() {
  const rows = document.querySelectorAll('#sn-inv-seller-items .sn-inv-row-sel');
  const items = [];
  rows.forEach(r => {
    const inputs = r.querySelectorAll('input');
    const desc = inputs[0]?.value.trim()||'';
    const amt  = parseInt(inputs[1]?.value)||0;
    if(desc||amt) items.push({desc, amt});
  });
  return items;
}

function sannaiInvCalc() {
  const sn = (CASES.find(x=>x.id===cur)||{}).sannai||{};
  const sellPrice = sn.sellPrice || 0;
  const buyPrice  = sn.buyPrice  || 0;
  const buyLimit  = sellPrice;  // è²·ä¸»å‘ã‘ä¸Šé™ = è²©å£²ä¾¡æ ¼
  const sellLimit = saleCommLimit(buyPrice);

  // è²·ä¸»ãƒã‚§ãƒƒã‚¯
  const buyerItems = sannaiInvGetBuyerItems();
  const buyerTotal = buyerItems.reduce((s,r)=>s+r.amt,0);
  const buyerComm  = buyerItems[0]?.amt||0;
  const buyEl = document.getElementById('sn-inv-buyer-check');
  if(buyEl && sellPrice>0 && buyerTotal>0) {
    const over = buyerComm - buyLimit;
    buyEl.innerHTML = over > 0
      ? '<div style="padding:6px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px">â›” ä¸Šé™è¶…é Â¥'+over.toLocaleString()+' â€” ä¸Šé™ Â¥'+buyLimit.toLocaleString()+'</div>'
      : '<div style="padding:5px 10px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:6px;color:var(--blue);font-size:11px">âœ… è²·ä¸»åˆè¨ˆ Â¥'+buyerTotal.toLocaleString()+' â€” ä¸Šé™å†…ï¼ˆÂ¥'+buyLimit.toLocaleString()+'ï¼‰</div>';
  }

  // å£²ä¸»ãƒã‚§ãƒƒã‚¯
  const sellerItems = sannaiInvGetSellerItems();
  const sellerTotal = sellerItems.reduce((s,r)=>s+r.amt,0);
  const sellerComm  = sellerItems[0]?.amt||0;
  const selEl = document.getElementById('sn-inv-seller-check');
  if(selEl && buyPrice>0 && sellerTotal>0) {
    const over = sellerComm - sellLimit;
    selEl.innerHTML = over > 0
      ? '<div style="padding:6px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px">â›” ä¸Šé™è¶…é Â¥'+over.toLocaleString()+' â€” ä¸Šé™ Â¥'+sellLimit.toLocaleString()+'</div>'
      : '<div style="padding:5px 10px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);border-radius:6px;color:var(--green);font-size:11px">âœ… å£²ä¸»åˆè¨ˆ Â¥'+sellerTotal.toLocaleString()+' â€” ä¸Šé™å†…ï¼ˆÂ¥'+sellLimit.toLocaleString()+'ï¼‰</div>';
  }
}

function sannaiInvSave(c) {
  if(!c.invoice) c.invoice={};
  const inv = c.invoice;
  inv.prop = document.getElementById('inv-prop')?.value.trim()||inv.prop||'';
  inv.date = document.getElementById('inv-date')?.value||inv.date||'';
  inv.due  = document.getElementById('inv-due')?.value||inv.due||'';
  const bi = sannaiInvGetBuyerItems();
  if(bi.length) inv.buyerDeleg = bi;
  const si = sannaiInvGetSellerItems();
  if(si.length) inv.sellerDeleg = si;
  inv.buyerComm  = bi[0]?.amt||0;
  inv.sellerComm = si[0]?.amt||0;
}

function issueInvoiceSannai(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  const inv = c.invoice;
  const sn  = c.sannai||{};

  const prop = document.getElementById('inv-prop')?.value.trim()||'';
  const date = document.getElementById('inv-date')?.value||todayISO();
  const due  = document.getElementById('inv-due')?.value||todayISO();
  if(!prop){alert('ç‰©ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  const buyerItems  = sannaiInvGetBuyerItems();
  const sellerItems = sannaiInvGetSellerItems();
  const buyerTotal  = buyerItems.reduce((s,r)=>s+r.amt,0);
  const sellerTotal = sellerItems.reduce((s,r)=>s+r.amt,0);

  if(buyerItems.length===0||buyerTotal===0){alert('è²·ä¸»å‘ã‘è«‹æ±‚é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  const sellPrice = sn.sellPrice||c.salePrice||0;
  const buyPrice  = sn.buyPrice||0;
  const buyLimit  = sellPrice;  // è²·ä¸»å‘ã‘ä¸Šé™ = è²©å£²ä¾¡æ ¼
  const sellLimit = saleCommLimit(buyPrice);
  const buyerComm = buyerItems[0]?.amt||0;
  const sellerComm= sellerItems[0]?.amt||0;

  if(buyLimit>0 && buyerComm>buyLimit) {
    if(!confirm('è²·ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+buyerComm.toLocaleString()+'ï¼‰ãŒä¸Šé™ï¼ˆÂ¥'+buyLimit.toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
  }
  if(inv.hasSellerComm && sellLimit>0 && sellerComm>sellLimit) {
    if(!confirm('å£²ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+sellerComm.toLocaleString()+'ï¼‰ãŒä¸Šé™ï¼ˆÂ¥'+sellLimit.toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
  }

  const grandTotal = buyerTotal + sellerTotal;
  Object.assign(inv, {
    type:'sannai', prop, date, due,
    buyerDeleg:buyerItems, sellerDeleg:sellerItems,
    buyerComm, sellerComm, buyerTotal, sellerTotal, grandTotal,
    sellPrice, buyPrice,
    hasSellerComm: inv.hasSellerComm||false,
    issued:true,
  });

  const ym = date.slice(0,7).replace('-','');
  const invNumBuyer  = 'INV-'+ym+'-'+c.agent+'-BUY';
  const invNumSeller = 'INV-'+ym+'-'+c.agent+'-SEL';

  slackSend(SLACK_CH.è«‹æ±‚æ›¸, [
    ...slackHeader('ğŸ§¾','ä¸‰ç‚º è«‹æ±‚æ›¸ç™ºè¡Œ'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+prop,
    'ğŸ’´ *ä»•å…¥ã‚Œ*ï¼šÂ¥'+(buyPrice?buyPrice.toLocaleString():'â€”'),
    'ğŸ’´ *è²©å£²*ï¼šÂ¥'+(sellPrice?sellPrice.toLocaleString():'â€”'),
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'ğŸ“„ '+invNumBuyer+' è²·ä¸»å‘ã‘åˆè¨ˆï¼šÂ¥'+buyerTotal.toLocaleString(),
    ...(inv.hasSellerComm?['ğŸ“„ '+invNumSeller+' å£²ä¸»å‘ã‘åˆè¨ˆï¼šÂ¥'+sellerTotal.toLocaleString()]:[]),
    'ğŸ’° *è«‹æ±‚ç·è¨ˆ*ï¼šÂ¥'+grandTotal.toLocaleString(),
    ...slackFooter(),
  ]);

  c.hist.unshift(today()+' ä¸‰ç‚ºè«‹æ±‚æ›¸ç™ºè¡Œ è²·ä¸»Â¥'+buyerTotal.toLocaleString()+(inv.hasSellerComm?' å£²ä¸»Â¥'+sellerTotal.toLocaleString():''));
  advance(id,'contract','invoiced',date,'è«‹æ±‚æ›¸ç™ºè¡Œå®Œäº† â†’ å¥‘ç´„ã¸');
}

// â”€â”€ å£²è²·ãƒ»ä¸‰ç‚ºå°‚ç”¨è«‹æ±‚æ›¸ â”€â”€
function saleCommLimit(price) {
  // å®…å»ºæ¥­æ³•: 800ä¸‡ä»¥ä¸‹ã¯ä¸€å¾‹330,000å††ï¼ˆç¨è¾¼ï¼‰, è¶…ãˆã‚‹ã¨ (priceÃ—3%+6ä¸‡)Ã—1.1
  if(!price||price<=0) return 0;
  if(price<=8000000) return 330000;
  return Math.round((price*0.03+60000)*1.1);
}

function invSetSaleFrom(btn) {
  const id = btn.dataset.cid;
  const from = btn.dataset.from;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.saleFrom = from;
  open_case(id);
}

function stepInvoiceSale(c) {
  const now = new Date();
  const due = new Date(now.getTime()+30*864e5).toISOString().slice(0,10);
  const ym  = now.getFullYear()+String(now.getMonth()+1).padStart(2,'0');
  const inv = c.invoice || {};
  const id  = c.id;
  const saleFrom  = inv.saleFrom || 'seller';   // seller / both / buyer
  const prevPrice = inv.salePrice || c.salePrice || '';
  const prevItems = inv.items || [{desc:'ä»²ä»‹æ‰‹æ•°æ–™',amt:''}];
  const prevDelegItems = inv.delegItems || [];
  const prevReason= inv.underReason || '';
  const invNum    = 'INV-'+ym+'-'+c.agent;
  const invNumB   = 'INV-'+ym+'-'+c.agent+'-B';

  // å—é ˜å…ˆã‚¿ãƒ–
  const fromTabs = [
    {v:'seller', label:'å£²ä¸»ã‹ã‚‰'},
    {v:'both',   label:'ä¸¡æ‰‹ï¼ˆå£²ä¸»ï¼‹è²·ä¸»ï¼‰'},
    {v:'buyer',  label:'è²·ä¸»ã‹ã‚‰'},
  ];
  const fromTabHtml = fromTabs.map(t=>{
    const active = saleFrom===t.v;
    const bg = active ? 'background:var(--gold);color:#000' : 'background:var(--card2);color:var(--sub)';
    return '<button onclick="invSetSaleFrom(this)" data-cid="'+id+'" data-from="'+t.v+'" style="flex:1;padding:7px 3px;border:none;cursor:pointer;font-size:10px;font-weight:600;border-radius:6px;'+bg+'">'+t.label+'</button>';
  }).join('');

  // ä¸¡æ‰‹ã®å ´åˆã¯è«‹æ±‚æ›¸Aï¼ˆå£²ä¸»ï¼‰ãƒ»Bï¼ˆè²·ä¸»ï¼‰ã®2æš
  const dualMsg = saleFrom==='both' ? (
    '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.25);border-radius:8px;font-size:11px">'
    +'<div style="color:var(--gold);font-weight:700;margin-bottom:5px">ğŸ“„ ä¸¡æ‰‹: è«‹æ±‚æ›¸2æšç™ºè¡Œ</div>'
    +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub)">'
    +'<span style="color:var(--muted)">No.A</span><span>'+invNum+' â€” å£²ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™</span>'
    +'<span style="color:var(--muted)">No.B</span><span>'+invNumB+' â€” è²·ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™</span>'
    +'</div></div>'
  ) : '';

  // è«‹æ±‚é …ç›®rows
  const itemRowsHtml = prevItems.map((it,i)=>invItemRow(i,it.desc,it.amt,i===0)).join('');
  const itemRowsBHtml = saleFrom==='both'
    ? (prevDelegItems.length>0 ? prevDelegItems : [{desc:'ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆè²·ä¸»ï¼‰',amt:''}]).map((it,i)=>invItemRowB(i,it.desc,it.amt)).join('')
    : '';

  // æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸Šé™è¶…ãˆå¯¾å¿œï¼‰
  const delegDesc = inv.delegDesc || 'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™';
  const delegAmt  = inv.delegAmt  || '';
  const delegSection = (
    '<div style="margin-top:10px;padding:12px;background:var(--card2);border:1px solid var(--border2);border-radius:8px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<span style="font-size:11px;color:var(--sub);font-weight:600">ğŸ’¼ æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ï¼ˆä¸Šé™è¶…éåˆ†ãƒ»ä»»æ„ï¼‰</span>'
    +'<span style="font-size:10px;color:var(--muted)">åˆ¥é€”è«‹æ±‚</span>'
    +'</div>'
    +'<div style="display:grid;grid-template-columns:1fr auto;gap:6px">'
    +'<input type="text" id="inv-deleg-desc" placeholder="ä¾‹: æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™" value="'+delegDesc+'" style="background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:6px 10px;color:var(--text);font-size:12px;font-family:inherit;outline:none">'
    +'<input type="number" id="inv-deleg-amt" class="mono" placeholder="é‡‘é¡" value="'+delegAmt+'" oninput="invCalcSale()" style="width:120px;font-size:13px">'
    +'</div></div>'
  );

  return '<div class="step-title">ğŸ§¾ è«‹æ±‚æ›¸ç™ºè¡Œï¼ˆå£²è²·ï¼‰</div>'
    +'<div style="display:flex;gap:6px;margin-bottom:12px;background:var(--card2);padding:4px;border-radius:8px">'+fromTabHtml+'</div>'
    +dualMsg
    +'<div class="fi"><label>è«‹æ±‚æ›¸ç•ªå·</label><input type="text" class="mono" value="'+invNum+'" readonly style="color:var(--muted);font-size:11px;background:rgba(255,255,255,.02);cursor:not-allowed"></div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="inv-prop" value="'+(c.dates.naikenProp||'')+'" oninput="invCalcSale()"></div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">'
    +'<div class="fi"><label>ç™ºè¡Œæ—¥</label><input type="date" id="inv-date" class="mono" value="'+now.toISOString().slice(0,10)+'"></div>'
    +'<div class="fi"><label>æ”¯æ‰•æœŸé™</label><input type="date" id="inv-due" class="mono" value="'+due+'"></div>'
    +'</div>'
    +'<div class="fi"><label>å£²è²·ä¾¡æ ¼ï¼ˆå††ï¼‰<span style="color:var(--muted);font-size:10px;margin-left:6px">ä¸Šé™è¨ˆç®—ã®åŸºæº–</span></label>'
    +'<input type="text" id="inv-sale-price" class="mono" placeholder="ä¾‹: 32,000,000" value="'+fmtYen(prevPrice)+'" oninput="invSalePriceInput(this)" style="font-size:13px"></div>'
    // å£²ä¸»å‘ã‘é …ç›®
    +(saleFrom==='both'
      ? '<div style="margin:8px 0 4px;font-size:11px;color:var(--gold);font-weight:700">ğŸ“„ A: å£²ä¸»å‘ã‘ è«‹æ±‚é …ç›®</div>'
      : '<div style="margin:8px 0 4px;font-size:11px;color:var(--sub);font-weight:600">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‘ã‘è«‹æ±‚é …ç›®<span style="color:var(--muted);font-weight:400;margin-left:6px;font-size:10px">â˜…å®…å»ºæ¥­æ³•ä¸Šé™ãƒã‚§ãƒƒã‚¯å¯¾è±¡</span></div>'
    )
    +'<div id="inv-items">'+itemRowsHtml+'</div>'
    +'<button onclick="invAddItem()" style="width:100%;background:transparent;border:1px dashed var(--border2);color:var(--sub);padding:6px;border-radius:7px;cursor:pointer;font-size:11px;margin-bottom:8px">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>'
    // è²·ä¸»å‘ã‘é …ç›®ï¼ˆä¸¡æ‰‹ã®ã¿ï¼‰
    +(saleFrom==='both' ? (
      '<div style="margin:8px 0 4px;font-size:11px;color:var(--blue);font-weight:700">ğŸ“„ B: è²·ä¸»å‘ã‘ è«‹æ±‚é …ç›®</div>'
      +'<div id="inv-items-b">'+itemRowsBHtml+'</div>'
      +'<button onclick="invAddItemB()" style="width:100%;background:transparent;border:1px dashed rgba(79,156,249,.4);color:var(--blue);padding:6px;border-radius:7px;cursor:pointer;font-size:11px;margin-bottom:8px">ï¼‹ è²·ä¸»å‘ã‘é …ç›®ã‚’è¿½åŠ </button>'
    ) : '')
    // æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ï¼ˆä¸Šé™è¶…éåˆ†ï¼‰
    +delegSection
    +'<div id="inv-validation" style="margin-bottom:8px"></div>'
    +'<button class="btn btn-gold" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="issueInvoiceSale(this.dataset.cid)">ğŸ“„ è«‹æ±‚æ›¸ç™ºè¡Œ â†’ å¥‘ç´„ã¸</button>';
}

function invItemRowB(idx, desc, amt) {
  return '<div class="inv-row-b" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr auto auto;gap:6px;margin-bottom:6px;align-items:center">'
    +'<input type="text" placeholder="é …ç›®å" value="'+desc+'" oninput="invCalcSale()" style="font-size:12px;color:var(--blue)">'
    +'<input type="number" placeholder="é‡‘é¡" value="'+amt+'" oninput="invCalcSale()" class="mono" style="width:120px;font-size:13px">'
    +(idx===0
      ? '<div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:var(--blue);font-size:14px">â˜…</div>'
      : '<button onclick="invRemoveItemB('+idx+')" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0;line-height:1">Ã—</button>')
    +'</div>';
}

let _invItemCountB=1;
function invAddItemB() {
  const wrap=document.getElementById('inv-items-b'); if(!wrap) return;
  const idx=_invItemCountB++;
  const div=document.createElement('div');
  div.innerHTML=invItemRowB(idx,'',0);
  wrap.appendChild(div.firstChild);
  invCalcSale();
}
function invRemoveItemB(idx) {
  document.querySelectorAll('#inv-items-b .inv-row-b').forEach(r=>{
    if(parseInt(r.dataset.idx)===idx) r.remove();
  });
  invCalcSale();
}
function invGetItemsB() {
  const rows=document.querySelectorAll('#inv-items-b .inv-row-b');
  const items=[];
  rows.forEach(r=>{
    const inputs=r.querySelectorAll('input');
    const desc=inputs[0]?.value.trim()||'';
    const amt=parseInt(inputs[1]?.value)||0;
    if(desc||amt) items.push({desc,amt});
  });
  return items;
}

function invCalcSale() {
  const price  = parseInt((document.getElementById('inv-sale-price')?.value||'').replace(/,/g,''))||0;
  const itemsA = invGetItems();
  const itemsB = invGetItemsB();
  const totalA = itemsA.reduce((s,it)=>s+it.amt,0);
  const totalB = itemsB.reduce((s,it)=>s+it.amt,0);
  const commA  = itemsA.length>0 ? itemsA[0].amt : 0;
  const commB  = itemsB.length>0 ? itemsB[0].amt : 0;
  const deleg  = parseInt(document.getElementById('inv-deleg-amt')?.value)||0;
  const limit  = saleCommLimit(price);
  const isBoth = !!document.getElementById('inv-items-b');

  let html='';
  if(price>0) {
    const limitLabel = price<=8000000
      ? '800ä¸‡å††ä»¥ä¸‹ ç‰¹ä¾‹: Â¥330,000'
      : 'Â¥'+limit.toLocaleString()+'ï¼ˆå£²è²·ä¾¡æ ¼Ã—3%+6ä¸‡ï¼‰Ã—1.1';

    html += '<div style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:12px">';
    html += '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--sub)">æ³•å®šä¸Šé™ï¼ˆ1ç¤¾ã‚ãŸã‚Šï¼‰</span><span class="mono" style="color:var(--muted)">Â¥'+limit.toLocaleString()+'</span></div>';

    // å£²ä¸»ãƒã‚§ãƒƒã‚¯
    if(totalA>0) {
      html += '<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px">';
      html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="color:var(--sub)">'+(isBoth?'A å£²ä¸»å‘ã‘åˆè¨ˆ':'è«‹æ±‚åˆè¨ˆ')+'</span><span class="mono">Â¥'+totalA.toLocaleString()+'</span></div>';
      if(commA>limit) {
        const over = commA-limit;
        html += '<div style="padding:7px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px;margin-top:4px">'
          +'â›” ä»²ä»‹æ‰‹æ•°æ–™ãŒä¸Šé™ã‚’ Â¥'+over.toLocaleString()+' è¶…éï¼ˆ'+limitLabel+'ï¼‰<br>'
          +'<span style="font-size:10px;opacity:.85">è¶…éåˆ† Â¥'+over.toLocaleString()+' ã¯ã€Œæ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã€ã¨ã—ã¦ä¸‹æ¬„ã«å…¥åŠ›ã—ã¦ãã ã•ã„</span>'
          +'</div>';
      } else if(commA>0) {
        html += '<div style="padding:5px 10px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);border-radius:6px;color:var(--green);font-size:11px;margin-top:4px">âœ… ä»²ä»‹æ‰‹æ•°æ–™ Â¥'+commA.toLocaleString()+' â€” é©æ­£ï¼ˆä¸Šé™: '+limitLabel+'ï¼‰</div>';
      }
      html += '</div>';
    }

    // è²·ä¸»ãƒã‚§ãƒƒã‚¯ï¼ˆä¸¡æ‰‹ï¼‰
    if(isBoth&&totalB>0) {
      html += '<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px">';
      html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="color:var(--blue)">B è²·ä¸»å‘ã‘åˆè¨ˆ</span><span class="mono">Â¥'+totalB.toLocaleString()+'</span></div>';
      if(commB>limit) {
        const overB = commB-limit;
        html += '<div style="padding:7px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px;margin-top:4px">'
          +'â›” è²·ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™ãŒä¸Šé™ã‚’ Â¥'+overB.toLocaleString()+' è¶…é<br>'
          +'<span style="font-size:10px;opacity:.85">è¶…éåˆ†ã¯åˆ¥åç›®ã§ã¯ãªãã€Œæ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã€ã¨ã—ã¦è¨ˆä¸Šã—ã¦ãã ã•ã„</span>'
          +'</div>';
      } else if(commB>0) {
        html += '<div style="padding:5px 10px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:6px;color:var(--blue);font-size:11px;margin-top:4px">âœ… è²·ä¸»å‘ã‘ Â¥'+commB.toLocaleString()+' â€” é©æ­£</div>';
      }
      html += '</div>';
    }

    // æ¥­å‹™å§”è¨—
    if(deleg>0) {
      html += '<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px;display:flex;justify-content:space-between"><span style="color:var(--sub)">æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™</span><span class="mono">Â¥'+deleg.toLocaleString()+'</span></div>';
    }

    // ã‚°ãƒ©ãƒ³ãƒ‰ãƒˆãƒ¼ã‚¿ãƒ«
    const grand = totalA+(isBoth?totalB:0)+deleg;
    if(grand>0) {
      html += '<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px;display:flex;justify-content:space-between"><span style="color:var(--sub);font-weight:700">åˆè¨ˆ</span><span class="mono" style="color:var(--gold);font-size:13px">Â¥'+grand.toLocaleString()+'</span></div>';
    }

    html += '</div>';
  }
  const vp=document.getElementById('inv-validation');
  if(vp) vp.innerHTML=html;
}

function issueInvoiceSale(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  const inv = c.invoice||{};
  const saleFrom = inv.saleFrom||'seller';
  const prop  = document.getElementById('inv-prop')?.value.trim()||'';
  const date  = document.getElementById('inv-date')?.value||todayISO();
  const due   = document.getElementById('inv-due')?.value||todayISO();
  const price = parseInt((document.getElementById('inv-sale-price')?.value||'').replace(/,/g,''))||0;
  if(!prop) {alert('ç‰©ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(!price){alert('å£²è²·ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  const itemsA    = invGetItems();
  const itemsB    = saleFrom==='both' ? invGetItemsB() : [];
  const totalA    = itemsA.reduce((s,it)=>s+it.amt,0);
  const totalB    = itemsB.reduce((s,it)=>s+it.amt,0);
  const commA     = itemsA.length>0 ? itemsA[0].amt : 0;
  const commB     = itemsB.length>0 ? itemsB[0].amt : 0;
  const delegAmt  = parseInt(document.getElementById('inv-deleg-amt')?.value)||0;
  const delegDesc = document.getElementById('inv-deleg-desc')?.value.trim()||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™';
  const limit     = saleCommLimit(price);
  const grandTotal= totalA+totalB+delegAmt;

  if(totalA===0){alert('è«‹æ±‚é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(commA>limit){
    if(!confirm('ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+commA.toLocaleString()+'ï¼‰ãŒæ³•å®šä¸Šé™ï¼ˆÂ¥'+limit.toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nè¶…éåˆ†ã¯æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã¨ã—ã¦åˆ¥é€”è«‹æ±‚ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚')) return;
  }
  if(saleFrom==='both'&&commB>limit){
    if(!confirm('è²·ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+commB.toLocaleString()+'ï¼‰ãŒæ³•å®šä¸Šé™ï¼ˆÂ¥'+limit.toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
  }

  c.salePrice = price;
  c.invoice = Object.assign(inv, {
    saleFrom, salePrice:price, items:itemsA, itemsB, commA, commB, totalA, totalB,
    delegAmt, delegDesc, grandTotal, prop, date, due, issued:true,
    dualInvoice: saleFrom==='both',
  });

  const fromLabel = saleFrom==='seller'?'å£²ä¸»ã‹ã‚‰':saleFrom==='both'?'ä¸¡æ‰‹':' è²·ä¸»ã‹ã‚‰';
  c.hist.unshift(today()+' è«‹æ±‚æ›¸ç™ºè¡Œï¼ˆå£²è²·ãƒ»'+fromLabel+'ï¼‰ åˆè¨ˆÂ¥'+grandTotal.toLocaleString());
  invSendSlack(c, grandTotal, delegAmt, delegDesc, saleFrom==='both');
  const destStep = 'contract';
  advance(id, destStep, 'invoiced', date, 'è«‹æ±‚æ›¸ç™ºè¡Œå®Œäº†');
}

setTimeout(()=>{
  if(document.getElementById('inv-sale-price')) {
    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå†é©ç”¨
    const priceEl = document.getElementById('inv-sale-price');
    if(priceEl && priceEl.value) {
      const raw = parseInt(priceEl.value.replace(/,/g,''));
      if(!isNaN(raw)) priceEl.value = raw.toLocaleString('ja-JP');
    }
    invCalcSale();
    _invItemCountB=document.querySelectorAll('#inv-items-b .inv-row-b').length;
  }
  if(document.getElementById('inv-items')) {
    invCalc();
    _invItemCount=document.querySelectorAll('#inv-items .inv-row').length;
  }
},100);


function invVirtualAcct(caseId) {
  let h=0;
  for(let i=0;i<caseId.length;i++) h=((h<<5)-h)+caseId.charCodeAt(i);
  return String(Math.abs(h)%9000000+1000000);
}

function invSetType(btn) {
  const id = btn.dataset.cid;
  const type = btn.dataset.type;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.type = type;
  if(type==='commission'||type==='ad_plus') {
    if(!c.invoice.items||c.invoice.items.length===0) c.invoice.items=[{desc:'ä»²ä»‹æ‰‹æ•°æ–™',amt:''}];
    else c.invoice.items[0].desc='ä»²ä»‹æ‰‹æ•°æ–™';
  }
  if(type==='ad_only') c.invoice.items=[{desc:'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™',amt:''}];
  c.invoice.adFmt=null;
  c.adOnly=(type==='ad_only'||type==='ad_plus');
  open_case(id);
}

function invSetAdFmt(btn) {
  const id=btn.dataset.cid, fmt=btn.dataset.fmt;
  const c=CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.adFmt=fmt;
  if(c.invoice.type==='ad_only'&&fmt==='standard') c.invoice.items=[{desc:'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™',amt:''}];
  open_case(id);
}

function invItemRow(idx, desc, amt, isFirst) {
  return '<div class="inv-row" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr auto auto;gap:6px;margin-bottom:6px;align-items:center">'
    +'<input type="text" placeholder="é …ç›®å" value="'+desc+'" oninput="invCalc()"'+(isFirst?' style="font-size:12px;color:var(--gold)"':' style="font-size:12px"')+'>'
    +'<input type="number" placeholder="é‡‘é¡" value="'+amt+'" oninput="invCalc()" class="mono" style="width:120px;font-size:13px">'
    +(isFirst
      ? '<div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:var(--gold);font-size:14px" title="ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆ1.1ãƒ¶æœˆä¸Šé™ãƒã‚§ãƒƒã‚¯å¯¾è±¡ï¼‰">â˜…</div>'
      : '<button onclick="invRemoveItem('+idx+')" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0;line-height:1">Ã—</button>')
    +'</div>';
}

let _invItemCount=1;
function invAddItem() {
  const wrap=document.getElementById('inv-items'); if(!wrap) return;
  const idx=_invItemCount++;
  const div=document.createElement('div');
  div.innerHTML=invItemRow(idx,'','',false);
  wrap.appendChild(div.firstChild);
  invCalc();
}
function invRemoveItem(idx) {
  document.querySelectorAll('#inv-items .inv-row').forEach(r=>{
    if(parseInt(r.dataset.idx)===idx) r.remove();
  });
  invCalc();
}
function invGetItems() {
  const rows=document.querySelectorAll('#inv-items .inv-row');
  const items=[];
  rows.forEach(r=>{
    const inputs=r.querySelectorAll('input');
    const desc=inputs[0]?.value.trim()||'';
    const amt=parseInt(inputs[1]?.value)||0;
    if(desc||amt) items.push({desc,amt});
  });
  return items;
}
function invCalc() {
  const rent=parseInt(document.getElementById('inv-rent')?.value)||0;
  const items=invGetItems();
  const commAmt=items.length>0?items[0].amt:0;
  const totalItems=items.reduce((s,it)=>s+it.amt,0);
  const adAmt=parseInt(document.getElementById('inv-ad-amt')?.value)||0;
  const grandTotal=totalItems+adAmt;
  // å£²è²·: å®…å»ºæ¥­æ³•ä¸Šé™ = (ä¾¡æ ¼Ã—3%+6ä¸‡)Ã—1.1
  const isSaleCalc = !document.getElementById('inv-rent') || (rent > 500000); // heuristic: large = å£²è²·ä¾¡æ ¼
  const saleLimit = rent<=0 ? 0 : Math.round((rent*0.03+60000)*1.1);
  const limit11 = rent<=0 ? 0 : (rent > 500000 ? saleLimit : Math.round(rent*1.1));
  const limit10 = rent;
  let html='';
  if(rent>0&&(totalItems>0||adAmt>0)){
    html+='<div style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:12px">';
    if(totalItems>0) html+='<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--sub)">è«‹æ±‚é …ç›®åˆè¨ˆ</span><span class="mono">Â¥'+totalItems.toLocaleString()+'</span></div>';
    const adDescDisp=document.getElementById('inv-ad-desc')?.value||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™';
    if(adAmt>0) html+='<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--sub)">'+adDescDisp+'ï¼ˆADï¼‰</span><span class="mono">Â¥'+adAmt.toLocaleString()+'</span></div>';
    if(adAmt>0&&totalItems>0) html+='<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px;display:flex;justify-content:space-between"><span style="color:var(--sub);font-weight:600">åˆè¨ˆ</span><span class="mono" style="color:var(--gold);font-size:13px">Â¥'+grandTotal.toLocaleString()+'</span></div>';
    if(commAmt>0){
      if(commAmt>limit11) html+='<div style="margin-top:6px;padding:6px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px">â›” ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+commAmt.toLocaleString()+'ï¼‰ãŒä¸Šé™ï¼ˆÂ¥'+limit11.toLocaleString()+'ï¼‰ã‚’è¶…é â€” å®…å»ºæ¥­æ³•é•å</div>';
      else html+='<div style="margin-top:6px;padding:5px 10px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);border-radius:6px;color:var(--green);font-size:11px">âœ… ä»²ä»‹æ‰‹æ•°æ–™ Â¥'+commAmt.toLocaleString()+' ï¼ ä¸Šé™ Â¥'+limit11.toLocaleString()+(rent>500000?'ï¼ˆå£²è²·ä¾¡æ ¼Ã—3%+6ä¸‡ï¼‰Ã—1.1':'ï¼ˆå®¶è³ƒÃ—1.1)')+' â€” é©æ­£</div>';
    }
    const checkAmt=grandTotal>0?grandTotal:totalItems;
    if(checkAmt>0 && rent<=500000){
      if(checkAmt>=limit10) html+='<div style="margin-top:5px;padding:5px 10px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:6px;color:var(--blue);font-size:11px">ğŸ’° åˆè¨ˆ Â¥'+checkAmt.toLocaleString()+' â‰¥ å®¶è³ƒ1ãƒ¶æœˆï¼ˆÂ¥'+limit10.toLocaleString()+'ï¼‰ â€” é©æ­£</div>';
      else html+='<div style="margin-top:5px;padding:5px 10px;background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.4);border-radius:6px;color:var(--orange);font-size:11px">âš  åˆè¨ˆ Â¥'+checkAmt.toLocaleString()+' ãŒå®¶è³ƒ1ãƒ¶æœˆï¼ˆÂ¥'+limit10.toLocaleString()+'ï¼‰æœªæº€</div>';
      const rw=document.getElementById('inv-reason-wrap');
      if(rw) rw.style.display=(checkAmt<limit10)?'block':'none';
    }
    html+='</div>';
  }
  const vp=document.getElementById('inv-validation');
  if(vp) vp.innerHTML=html;
}


function issueInvoice(id) {
  const c=CASES.find(x=>x.id===id); if(!c) return;
  const inv=c.invoice||{};
  const type=inv.type||'commission';
  const adFmt=inv.adFmt||null;
  const prop=document.getElementById('inv-prop')?.value.trim();
  const date=document.getElementById('inv-date')?.value;
  const due=document.getElementById('inv-due')?.value;
  const rent=parseInt(document.getElementById('inv-rent')?.value)||0;
  const reason=document.getElementById('inv-reason')?.value.trim()||'';
  const adAmt=parseInt(document.getElementById('inv-ad-amt')?.value)||0;
  const adDesc=document.getElementById('inv-ad-desc')?.value.trim()||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™';
  if(!prop){alert('ç‰©ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  // ADçµ¡ã‚€ï¼‹æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚ã‚Š
  if((type==='ad_only'||type==='ad_plus')&&adFmt==='custom'){
    if(!adAmt){alert('æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
    c.adOnly=true;
    c.invoice=Object.assign(inv,{type,adFmt,adAmt,adDesc,prop,date,due,issued:true,grandTotal:adAmt});
    c.hist.unshift(today()+' ADè«‹æ±‚ï¼ˆæŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰Â¥'+adAmt.toLocaleString()+' å£åº§æƒ…å ±æç¤º');
    const destStep2 = (c.type==='reSale'||c.type==='sannai') ? 'contract' : 'prekey';
  advance(id,destStep2,'invoiced',date,'ADè«‹æ±‚æ›¸ï¼ˆæŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰ç™ºè¡Œ');
    return;
  }

  const items=invGetItems();
  const commAmt=items.length>0?items[0].amt:0;
  const totalItems=items.reduce((s,it)=>s+it.amt,0);
  const grandTotal=totalItems+adAmt;
  if(items.length===0||totalItems===0){alert('è«‹æ±‚é …ç›®ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(rent>0&&commAmt>Math.round(rent*1.1)){alert('ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+commAmt.toLocaleString()+'ï¼‰ãŒä¸Šé™ï¼ˆÂ¥'+Math.round(rent*1.1).toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚');return;}
  if(rent>0&&grandTotal<rent&&!reason){alert('åˆè¨ˆãŒå®¶è³ƒ1ãƒ¶æœˆåˆ†æœªæº€ã®ãŸã‚ç†ç”±ã®è¨˜å…¥ãŒå¿…è¦ã§ã™ã€‚');return;}
  c.adOnly=(type==='ad_only'||type==='ad_plus');
  const dualInv=(type==='ad_plus'&&adFmt==='standard');
  c.invoice=Object.assign(inv,{type,adFmt,items,commAmt,totalItems,adAmt,adDesc,grandTotal,rent,prop,date,due,underReason:reason,issued:true,dualInvoice:dualInv});
  const adLabel=adAmt>0?' æ¥­å‹™å§”è¨—Â¥'+adAmt.toLocaleString():'';
  c.hist.unshift(today()+' è«‹æ±‚æ›¸ç™ºè¡Œ åˆè¨ˆÂ¥'+grandTotal.toLocaleString()+adLabel+(dualInv?' [2æš]':''));
  invSendSlack(c, grandTotal, adAmt, adDesc, dualInv);
  const destStep = (c.type==='reSale'||c.type==='sannai') ? 'contract' : 'prekey';
  advance(id,destStep,'invoiced',date,'è«‹æ±‚æ›¸ç™ºè¡Œå®Œäº†');
}


function invSendSlack(c, grandTotal, adAmt, adDesc, dualInv) {
  const inv = c.invoice || {};
  const isSaleType = c.type==='reSale' || c.type==='sannai';
  const saleFromLabel = inv.saleFrom==='both' ? 'ä¸¡æ‰‹ï¼ˆå£²ä¸»ï¼‹è²·ä¸»ï¼‰' : inv.saleFrom==='buyer' ? 'è²·ä¸»ã‹ã‚‰' : 'å£²ä¸»ã‹ã‚‰';
  const typeLabel = isSaleType
    ? ('å£²è²·ä»²ä»‹ / '+saleFromLabel)
    : (inv.type==='commission' ? 'ä»²ä»‹æ‰‹æ•°æ–™ã®ã¿' : inv.type==='ad_plus' ? 'ADï¼‹ä»²ä»‹æ‰‹æ•°æ–™' : 'ADã®ã¿');
  const fmtLabel = inv.adFmt==='custom' ? 'æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ' : inv.adFmt==='standard' ? 'CORETOæ¨™æº–' : 'â€”';
  const lines = [
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    'ğŸ§¾ *è«‹æ±‚æ›¸ç™ºè¡Œé€šçŸ¥*',
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    `ğŸ“ *æ¡ˆä»¶ID*ï¼š${c.id}`,
    `ğŸ‘¤ *ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ*ï¼š${c.name}`,
    `ğŸ  *ç‰©ä»¶*ï¼š${inv.prop||c.sub||'â€”'}`,
    `ğŸ“‹ *ç¨®åˆ¥*ï¼š${typeLabel}`,
    isSaleType && inv.salePrice ? `ğŸ’´ *å£²è²·ä¾¡æ ¼*ï¼šÂ¥${parseInt(inv.salePrice).toLocaleString()}` : null,
    !isSaleType && inv.rent ? `ğŸ· *å®¶è³ƒ*ï¼šÂ¥${parseInt(inv.rent).toLocaleString()}` : null,
    inv.commAmt ? `ğŸ’´ *ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆå£²ä¸»ï¼‰*ï¼šÂ¥${parseInt(inv.commAmt).toLocaleString()}` : null,
    inv.commB  ? `ğŸ’´ *ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆè²·ä¸»ï¼‰*ï¼šÂ¥${parseInt(inv.commB).toLocaleString()}` : null,
    adAmt ? `ğŸ’¼ *${adDesc||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™'}*ï¼šÂ¥${parseInt(adAmt).toLocaleString()}` : null,
    `ğŸ’° *åˆè¨ˆ*ï¼šÂ¥${parseInt(grandTotal).toLocaleString()}`,
    isSaleType && dualInv ? 'ğŸ“„ è«‹æ±‚æ›¸2æšç™ºè¡Œï¼ˆä¸¡æ‰‹ï¼‰' : null,
    !isSaleType && dualInv ? 'ğŸ“„ è«‹æ±‚æ›¸2æšç™ºè¡Œï¼ˆä»²ä»‹ï¼‹æ¥­å‹™å§”è¨—ï¼‰' : null,
    !isSaleType && inv.adFmt ? `ğŸ“‹ ç®¡ç†ä¼šç¤¾ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š${fmtLabel}` : null,
    inv.underReason ? `âš  æ¸›é¡ãƒ»ç†ç”±ï¼š${inv.underReason}` : null,
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    `ğŸ• ${new Date().toLocaleString('ja-JP')}`,
  ].filter(Boolean).join('\n');

  // æœ¬ç•ª: SLACK_WEBHOOK_URL ã« fetch POST
  console.log('[Slack #è«‹æ±‚æ›¸] ', lines);

  // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
  try {
    const ta = document.createElement('textarea');
    ta.value = lines; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  } catch(e) {}

  toast('Slack #è«‹æ±‚æ›¸ ã«é€ä¿¡ã—ã¾ã—ãŸ âœ…');
}

function editInvoice(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™: stepã‚’invoiceã«ã€issued ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
  if(c.invoice) c.invoice.issued = false;
  c.step = 'invoice';  // reSale will return to contract after re-issue
  c.hist.unshift(today()+' è«‹æ±‚æ›¸ä¿®æ­£ï¼ˆå†ç·¨é›†ï¼‰');
  open_case(id);
}


// â”€â”€ å…¥é‡‘ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœ¬éƒ¨ã®ã¿ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPaymentConfirmModal(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  // HQæ¨©é™ãƒã‚§ãƒƒã‚¯
  if (!window._SESSION || window._SESSION.type !== 'hq') {
    toast('âš ï¸ å…¥é‡‘ç¢ºèªã¯æœ¬éƒ¨ã®ã¿å®Ÿè¡Œã§ãã¾ã™'); return;
  }
  const inv = c.invoice;
  const totalAmt = inv ? (inv.grandTotal || (inv.commAmt||0)+(inv.adAmt||0) || inv.totalItems || 0) : 0;
  const prop = (c.apps&&c.apps.find(a=>a.status==='approved')||{}).prop || c.sub || 'â€”';

  const overlay = document.createElement('div');
  overlay.id = 'pay-confirm-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';
  overlay.innerHTML = `
    <div style="background:#11141f;border:1px solid #2a3050;border-radius:16px;width:min(440px,100%);font-family:inherit">
      <div style="padding:16px 20px;border-bottom:1px solid #1e2235">
        <div style="font-size:14px;font-weight:800;color:#e0e8f0">ğŸ’° å…¥é‡‘ç¢ºèªï¼ˆæœ¬éƒ¨å‡¦ç†ï¼‰</div>
        <div style="font-size:10px;color:#5a6080;margin-top:2px">${c.name} æ§˜ / ${c.id}</div>
      </div>
      <div style="padding:18px 20px">
        <div style="background:rgba(79,156,249,.06);border:1px solid rgba(79,156,249,.15);border-radius:8px;padding:12px;margin-bottom:16px;font-size:11px">
          <div style="display:grid;grid-template-columns:auto 1fr;gap:3px 12px;color:#a0a8c0">
            <span>ç‰©ä»¶</span><span style="color:#e0e8f0">${prop}</span>
            <span>è«‹æ±‚é‡‘é¡</span><span style="color:#c9a840;font-weight:700;font-family:monospace">${totalAmt ? 'Â¥'+totalAmt.toLocaleString() : 'â€”'}</span>
          </div>
        </div>
        <div style="margin-bottom:14px">
          <div style="font-size:11px;color:#a0a8c0;margin-bottom:6px">ğŸ“… å®Ÿéš›ã®æŒ¯è¾¼æ—¥ <span style="color:#ef4444">*</span></div>
          <input type="date" id="pay-date-input" value="${todayISO()}"
            style="width:100%;background:#090b13;border:1px solid #2a3050;border-radius:7px;padding:9px 10px;color:#e0e8f0;font-family:inherit;font-size:13px;outline:none;box-sizing:border-box">
        </div>
        <div style="margin-bottom:16px">
          <div style="font-size:11px;color:#a0a8c0;margin-bottom:6px">ğŸ“ å‚™è€ƒï¼ˆä»»æ„ï¼‰</div>
          <input type="text" id="pay-memo-input" placeholder="ä¾‹: GMOå…¥é‡‘é€šçŸ¥ ref.1234"
            style="width:100%;background:#090b13;border:1px solid #2a3050;border-radius:7px;padding:9px 10px;color:#e0e8f0;font-family:inherit;font-size:12px;outline:none;box-sizing:border-box">
        </div>
        <div style="display:flex;gap:8px">
          <button onclick="document.getElementById('pay-confirm-overlay').remove()"
            style="flex:1;background:transparent;border:1px solid #2a3050;color:#a0a8c0;border-radius:8px;padding:10px;cursor:pointer;font-family:inherit">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button onclick="paymentCheck('${id}')"
            style="flex:2;background:rgba(52,211,153,.12);border:1px solid rgba(52,211,153,.3);color:#34d399;border-radius:8px;padding:10px;cursor:pointer;font-family:inherit;font-weight:700">
            âœ… å…¥é‡‘ç¢ºèªã™ã‚‹</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function paymentCheck(id) {
  // HQæ¨©é™ãƒã‚§ãƒƒã‚¯
  if (!window._SESSION || window._SESSION.type !== 'hq') {
    toast('âš ï¸ å…¥é‡‘ç¢ºèªã¯æœ¬éƒ¨ã®ã¿å®Ÿè¡Œã§ãã¾ã™'); return;
  }
  const c = CASES.find(x=>x.id===id); if(!c) return;
  // å®Ÿéš›ã®æŒ¯è¾¼æ—¥ã‚’å–å¾—ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®å…¥åŠ›å€¤ or ä»Šæ—¥ï¼‰
  const dateInput = document.getElementById('pay-date-input');
  const memoInput = document.getElementById('pay-memo-input');
  const paidDate = dateInput ? dateInput.value : todayISO();
  const memo     = memoInput ? memoInput.value.trim() : '';
  if (!paidDate) { toast('æŒ¯è¾¼æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  if(!c.taskDone) c.taskDone={};
  c.taskDone.paid = true;
  c.dates.paid = paidDate;
  const histLine = paidDate + ' å…¥é‡‘ç¢ºèªæ¸ˆ' + (memo ? 'ï¼ˆ'+memo+'ï¼‰' : '') + 'ã€æœ¬éƒ¨ç¢ºèª: '+(window._SESSION.name||window._SESSION.userId)+'ã€‘';
  c.hist.unshift(histLine);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  const ov = document.getElementById('pay-confirm-overlay');
  if (ov) ov.remove();

  const prop = (c.apps&&c.apps.find(a=>a.status==='approved')||{}).prop || c.sub || 'â€”';
  const inv = c.invoice;
  const totalAmt = inv ? (inv.grandTotal || (inv.commAmt||0)+(inv.adAmt||0) || 0) : 0;
  slackSend(SLACK_CH.å…¥é‡‘, [
    ...slackHeader('ğŸ’°','å…¥é‡‘ç¢ºèªï¼ˆæœ¬éƒ¨å‡¦ç†ï¼‰'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š' + prop,
    'ğŸ“… *æŒ¯è¾¼æ—¥*ï¼š' + paidDate,
    ...(totalAmt ? ['ğŸ’´ *é‡‘é¡*ï¼šÂ¥' + totalAmt.toLocaleString()] : []),
    ...(memo ? ['ğŸ“ *å‚™è€ƒ*ï¼š' + memo] : []),
    'ğŸ‘¤ *ç¢ºèªè€…*ï¼š' + (window._SESSION.name || window._SESSION.userId),
    ...slackFooter(),
  ]);
  open_case(id); toast('âœ… å…¥é‡‘ç¢ºèªã—ã¾ã—ãŸï¼ˆæŒ¯è¾¼æ—¥: ' + paidDate + 'ï¼‰');
}
function openItSetsuAndConfirm(id) {
  window.open('coreto-it-setsu.html', '_blank');
  // ITé‡èª¬å®Ÿæ–½å¾Œã«å®Œäº†ãƒœã‚¿ãƒ³ã‚’åˆ¥é€”æŠ¼ã—ã¦ã‚‚ã‚‰ã†ï¼ˆé–‹ã„ãŸã ã‘ã§ã¯å®Œäº†ã«ã—ãªã„ï¼‰
  const c = CASES.find(x=>x.id===id); if(!c) return;
  const bk = c.itBooking;
  const dateStr = bk ? bk.date : '';
  const timeStr = bk ? bk.time : '';
  const overlay = document.createElement('div');
  overlay.id = 'itsetsu-confirm-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';
  overlay.innerHTML = `<div style="background:#11141f;border:1px solid #2a3050;border-radius:16px;width:min(420px,100%);padding:24px;font-family:inherit">
    <div style="font-size:14px;font-weight:800;color:#e0e8f0;margin-bottom:8px">ğŸ“ ITé‡èª¬ãƒ»å¥‘ç´„ å®Œäº†ç¢ºèª</div>
    <div style="font-size:11px;color:#5a6080;margin-bottom:18px">é‡èª¬ãƒšãƒ¼ã‚¸ã§å®Ÿæ–½å®Œäº†å¾Œã€ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    ${bk ? '<div style="background:rgba(45,212,191,.06);border:1px solid rgba(45,212,191,.2);border-radius:8px;padding:10px 12px;margin-bottom:16px;font-size:11px"><div style="color:#2dd4bf;margin-bottom:4px">ğŸ“… å®Ÿæ–½äºˆå®šæ—¥æ™‚</div><div style="font-weight:700;color:#e0e8f0">${dateStr}ã€€${timeStr}</div></div>' : ''}
    <div style="display:flex;gap:8px">
      <button onclick="document.getElementById('itsetsu-confirm-overlay').remove()"
        style="flex:1;background:transparent;border:1px solid #2a3050;color:#a0a8c0;border-radius:8px;padding:10px;cursor:pointer;font-family:inherit">
        ã¾ã å®Ÿæ–½ä¸­</button>
      <button onclick="itsetsuCheck('${id}');document.getElementById('itsetsu-confirm-overlay').remove()"
        style="flex:2;background:rgba(52,211,153,.12);border:1px solid rgba(52,211,153,.3);color:#34d399;border-radius:8px;padding:10px;cursor:pointer;font-family:inherit;font-weight:700">
        âœ… é‡èª¬ãƒ»å¥‘ç´„ å®Œäº†</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

function itsetsuCheck(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.taskDone) c.taskDone={};
  c.taskDone.itsetsu = true;
  // â‘¤ å®Ÿéš›ã®é‡èª¬å®Ÿæ–½æ—¥ã‚’ä½¿ç”¨ï¼ˆbookingæ—¥ä»˜ãŒã‚ã‚Œã°ï¼‰
  const bk = c.itBooking;
  c.dates.itsetsu = bk ? bk.date : todayISO();
  c.hist.unshift(today()+' ITé‡èª¬å®Œäº†');
  slackSend(SLACK_CH.é‡èª¬, [
    ...slackHeader('ğŸ“','ITé‡èª¬ãƒ»å¥‘ç´„å®Œäº†'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+((c.apps.find(a=>a.status==='approved')||{}).prop||c.sub||'â€”'),
    'ğŸ“… *é‡èª¬æ—¥*ï¼š'+(bk ? bk.date : todayISO()),
    ...slackFooter(),
  ]);
  open_case(id); toast('é‡èª¬å®Œäº†ã—ã¾ã—ãŸ');
}


function keyDone(id) {
  const d = document.getElementById('s-chinkaku')?.value || todayISO();
  const c = CASES.find(x=>x.id===id);
  c.dates.chinkaku = d;
  const approvedApp = c.apps?.find(a=>a.status==='approved')||{};
  slackSend(SLACK_CH.æ±ºæ¸ˆ, [
    ...slackHeader('ğŸ”‘','éµæ¸¡ã—å®Œäº† â†’ æˆç´„ï¼ˆè³ƒè²¸ï¼‰'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+(approvedApp.prop||c.sub||'â€”'),
    'ğŸ¢ *ç®¡ç†ä¼šç¤¾*ï¼š'+(approvedApp.mgmt||'â€”'),
    'ğŸ“… *è³ƒç™ºæ—¥*ï¼š'+d,
    ...slackFooter(),
  ]);
  advance(id,'done',null,null,'éµæ¸¡ã—å®Œäº† (è³ƒç™ºæ—¥: '+d+') â†’ æˆç´„');
}

// å£²è²·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸‰ç‚º STEP FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function stepSannaiOffer(c) {
  const today = new Date().toISOString().slice(0,10);
  const skipLabel = c.dates.naiken ? '' : '<span style="font-size:10px;color:var(--orange);margin-left:8px">å†…è¦‹ãªã—</span>';
  const sn = c.sannai || {};
  const commPayMode = sn.commPayMode || 'none'; // none / buy / sell / both
  const delegRows   = sn.delegPay   || [];
  const id = c.id;

  // ä»²ä»‹æ‰‹æ•°æ–™æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
  const commModes = [
    {v:'none', label:'ãªã—'},
    {v:'buy',  label:'è²·ã„å´'},
    {v:'sell', label:'å£²ã‚Šå´'},
    {v:'both', label:'ä¸¡å´'},
  ];
  const commModeBtns = commModes.map(m => {
    const active = commPayMode === m.v;
    const bg = active ? 'background:var(--orange);color:#000' : 'background:var(--card2);color:var(--sub)';
    return '<button onclick="sannaiSetCommMode(this)" data-cid="'+id+'" data-mode="'+m.v+'" style="flex:1;padding:6px 2px;border:none;cursor:pointer;font-size:11px;font-weight:600;border-radius:6px;'+bg+'">'+m.label+'</button>';
  }).join('');

  // ä»²ä»‹æ‰‹æ•°æ–™å…¥åŠ›æ¬„ï¼ˆãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰
  let commPayFields = '';
  if (commPayMode === 'buy' || commPayMode === 'both') {
    commPayFields += '<div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:end;margin-top:8px">'
      +'<div class="fi" style="margin-bottom:0"><label style="color:var(--blue)">è²·ã„å´ ä»²ä»‹ä¼šç¤¾å</label>'
      +'<input type="text" id="sn-comm-buy-co" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã€‡ã€‡ä¸å‹•ç”£" value="'+(sn.commBuyCo||'')+'" style="font-size:12px"></div>'
      +'<div class="fi" style="margin-bottom:0"><label style="color:var(--blue)">é‡‘é¡ï¼ˆç¨è¾¼ï¼‰</label>'
      +'<input type="text" id="sn-comm-buy-amt" class="mono" placeholder="0" value="'+(sn.commBuyAmt?fmtYen(sn.commBuyAmt):'')+'" oninput="invSalePriceInput(this)" style="width:110px;font-size:13px"></div>'
      +'</div>';
  }
  if (commPayMode === 'sell' || commPayMode === 'both') {
    commPayFields += '<div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:end;margin-top:8px">'
      +'<div class="fi" style="margin-bottom:0"><label style="color:var(--green)">å£²ã‚Šå´ ä»²ä»‹ä¼šç¤¾å</label>'
      +'<input type="text" id="sn-comm-sell-co" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã€‡ã€‡ä¸å‹•ç”£" value="'+(sn.commSellCo||'')+'" style="font-size:12px"></div>'
      +'<div class="fi" style="margin-bottom:0"><label style="color:var(--green)">é‡‘é¡ï¼ˆç¨è¾¼ï¼‰</label>'
      +'<input type="text" id="sn-comm-sell-amt" class="mono" placeholder="0" value="'+(sn.commSellAmt?fmtYen(sn.commSellAmt):'')+'" oninput="invSalePriceInput(this)" style="width:110px;font-size:13px"></div>'
      +'</div>';
  }

  // æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™è¡Œ
  const delegHtml = delegRows.map((r,i) => sannaiDelegRow(i, r)).join('');

  // ç²—åˆ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  const profitHtml = sannaiProfitPreview(sn, c.salePrice || sn.sellPrice || 0);

  return '<div class="step-title">ğŸ“„ è²·ä»˜ï¼ˆä¸‰ç‚ºï¼‰'+skipLabel+'</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-sale-prop" value="'+(c.dates.naikenProp||'')+'" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·"></div>'
    +'<div class="fi"><label>è²·ä»˜æ—¥</label><input type="date" id="s-offer-date" class="mono" value="'+today+'"></div>'

    // â”€â”€ å–å¼•ä¾¡æ ¼ â”€â”€
    +'<div style="margin:12px 0 8px;padding:12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:10px">'
    +'<div style="font-size:10px;color:var(--gold);font-weight:700;letter-spacing:.8px;margin-bottom:10px">ğŸ’´ å–å¼•ä¾¡æ ¼</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'
    +'<div class="fi" style="margin-bottom:0"><label>ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰<br><span style="font-size:9px;color:var(--muted);font-weight:400">å£²ä¸»ã¸ã®æ”¯æ‰•ã„</span></label>'
    +'<input type="text" id="sn-buy-price" class="mono" placeholder="ä¾‹: 40,000,000" value="'+(sn.buyPrice?fmtYen(sn.buyPrice):'')+'" oninput="sannaiCalcProfit()" style="font-size:13px"></div>'
    +'<div class="fi" style="margin-bottom:0"><label>è²©å£²ä¾¡æ ¼ï¼ˆå††ï¼‰<br><span style="font-size:9px;color:var(--muted);font-weight:400">è²·ä¸»ã‹ã‚‰ã®å—å–</span></label>'
    +'<input type="text" id="sn-sell-price" class="mono" placeholder="ä¾‹: 45,000,000" value="'+(sn.sellPrice||c.salePrice?fmtYen(sn.sellPrice||c.salePrice):'')+'" oninput="sannaiCalcProfit()" style="font-size:13px"></div>'
    +'</div>'
    +'<div id="sn-spread" style="margin-top:8px"></div>'
    +'</div>'

    // â”€â”€ æ”¯æ‰•ã„ä»²ä»‹æ‰‹æ•°æ–™ â”€â”€
    +'<div style="margin:10px 0 8px;padding:12px;background:rgba(251,146,60,.04);border:1px solid rgba(251,146,60,.15);border-radius:10px">'
    +'<div style="font-size:10px;color:var(--orange);font-weight:700;letter-spacing:.8px;margin-bottom:8px">ğŸ’¸ æ”¯æ‰•ã„ä»²ä»‹æ‰‹æ•°æ–™</div>'
    +'<div style="display:flex;gap:4px;background:var(--card2);padding:3px;border-radius:7px">'+commModeBtns+'</div>'
    +commPayFields
    +'</div>'

    // â”€â”€ æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ï¼ˆæ”¯æ‰•ã„ï¼‰ â”€â”€
    +'<div style="margin:10px 0 8px;padding:12px;background:rgba(167,139,250,.04);border:1px solid rgba(167,139,250,.15);border-radius:10px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<div style="font-size:10px;color:var(--purple);font-weight:700;letter-spacing:.8px">ğŸ“‹ æ”¯æ‰•ã„æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™</div>'
    +'<button data-cid="'+id+'" onclick="sannaiAddDeleg(this.dataset.cid)" style="background:rgba(167,139,250,.15);border:1px solid rgba(167,139,250,.3);color:var(--purple);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">ï¼‹ è¿½åŠ </button>'
    +'</div>'
    +(delegRows.length === 0
      ? '<div style="font-size:11px;color:var(--muted);text-align:center;padding:8px">ãªã—ï¼ˆï¼‹ è¿½åŠ ã§å…¥åŠ›ï¼‰</div>'
      : '<div id="sn-deleg-rows">'+delegHtml+'</div>')
    +'</div>'

    +profitHtml
    +'<button class="btn btn-green" style="width:100%;justify-content:center;margin-top:14px" data-cid="'+id+'" onclick="sannaiOfferDone(this.dataset.cid)">è²·ä»˜å—é ˜ â†’ è«‹æ±‚æ›¸ã¸</button>';
}

// â”€â”€ ä¸‰ç‚º: æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™è¡ŒHTML â”€â”€
function sannaiDelegRow(idx, r) {
  r = r || {};
  const typeOpts = [
    {v:'broker', label:'ä»²ä»‹ä¼šç¤¾'},
    {v:'other',  label:'ãã®ä»–'},
  ];
  const typeHtml = typeOpts.map(o =>
    '<option value="'+o.v+'"'+(r.type===o.v?' selected':'')+'>'+o.label+'</option>'
  ).join('');
  return '<div class="sn-deleg-row" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr 90px 100px auto;gap:5px;margin-bottom:6px;align-items:center">'
    +'<input type="text" placeholder="ä¼šç¤¾å / å†…å®¹" value="'+(r.co||'')+'" style="font-size:11px">'
    +'<select style="background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:5px 6px;color:var(--sub);font-size:10px;font-family:inherit">'+typeHtml+'</select>'
    +'<input type="text" placeholder="é‡‘é¡ï¼ˆç¨è¾¼ï¼‰" value="'+(r.amt?fmtYen(r.amt):'')+'" class="mono" style="font-size:12px" oninput="invSalePriceInput(this)">'
    +'<button onclick="sannaiRemoveDeleg(this)" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:26px;height:26px;cursor:pointer;font-size:13px;padding:0">Ã—</button>'
    +'</div>';
}

function sannaiRemoveDeleg(btn) {
  btn.closest('.sn-deleg-row')?.remove();
  sannaiCalcProfit();
}

function sannaiAddDeleg(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  sannaiReadOfferForm(id); // å…¥åŠ›ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰å†æç”»
  if(!c.sannai) c.sannai = {};
  if(!c.sannai.delegPay) c.sannai.delegPay = [];
  c.sannai.delegPay.push({co:'', type:'broker', amt:0});
  open_case(id);
}

function sannaiSetCommMode(btn) {
  const id = btn.dataset.cid, mode = btn.dataset.mode;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  sannaiReadOfferForm(id); // å…¥åŠ›ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰å†æç”»
  if(!c.sannai) c.sannai = {};
  c.sannai.commPayMode = mode;
  open_case(id);
}

function sannaiCalcProfit() {
  const buyPrice  = parseInt((document.getElementById('sn-buy-price')?.value||'').replace(/,/g,''))||0;
  const sellPrice = parseInt((document.getElementById('sn-sell-price')?.value||'').replace(/,/g,''))||0;
  const spread = sellPrice - buyPrice;

  // collect comm costs
  const commBuy  = parseInt((document.getElementById('sn-comm-buy-amt')?.value||'').replace(/,/g,''))||0;
  const commSell = parseInt((document.getElementById('sn-comm-sell-amt')?.value||'').replace(/,/g,''))||0;

  // collect deleg costs
  let delegTotal = 0;
  document.querySelectorAll('.sn-deleg-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    delegTotal += parseInt((inputs[1]?.value||'').replace(/,/g,''))||0;
  });

  const totalCost = commBuy + commSell + delegTotal;
  const profit = spread - totalCost;

  const el = document.getElementById('sn-spread');
  if (!el) return;
  if (!buyPrice && !sellPrice) { el.innerHTML = ''; return; }

  let html = '<div style="display:grid;grid-template-columns:auto 1fr;gap:3px 10px;font-size:11px;margin-top:4px">';
  if(buyPrice>0) html += '<span style="color:var(--muted)">ä»•å…¥ã‚Œ</span><span class="mono" style="color:var(--sub)">Â¥'+buyPrice.toLocaleString()+'</span>';
  if(sellPrice>0) html += '<span style="color:var(--muted)">è²©å£²</span><span class="mono" style="color:var(--sub)">Â¥'+sellPrice.toLocaleString()+'</span>';
  if(buyPrice>0 && sellPrice>0) {
    const spreadColor = spread >= 0 ? 'var(--green)' : 'var(--red)';
    html += '<span style="color:var(--muted)">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰</span><span class="mono" style="color:'+spreadColor+';font-weight:700">'+(spread>=0?'+':'')+'Â¥'+spread.toLocaleString()+'</span>';
  }
  if(totalCost > 0) {
    html += '<span style="color:var(--muted)">æ”¯æ‰•æ‰‹æ•°æ–™è¨ˆ</span><span class="mono" style="color:var(--orange)">-Â¥'+totalCost.toLocaleString()+'</span>';
    const profitColor = profit >= 0 ? 'var(--green)' : 'var(--red)';
    html += '<span style="color:var(--muted);font-weight:700">æ¦‚ç®—ç²—åˆ©</span><span class="mono" style="color:'+profitColor+';font-weight:700;font-size:13px">'+(profit>=0?'+':'')+'Â¥'+profit.toLocaleString()+'</span>';
  }
  html += '</div>';
  el.innerHTML = html;
}

function sannaiProfitPreview(sn, fallbackSell) {
  const bp = sn.buyPrice || 0;
  const sp = sn.sellPrice || fallbackSell || 0;
  if (!bp && !sp) return '';
  const spread = sp - bp;
  const commBuy = sn.commBuyAmt || 0;
  const commSell = sn.commSellAmt || 0;
  const delegTotal = (sn.delegPay || []).reduce((s, r) => s + (r.amt || 0), 0);
  const totalCost = commBuy + commSell + delegTotal;
  const profit = spread - totalCost;
  const profitColor = profit >= 0 ? 'var(--green)' : 'var(--red)';
  if (!totalCost) return '';
  return '<div style="padding:8px 12px;background:rgba(52,211,153,.04);border:1px solid rgba(52,211,153,.15);border-radius:8px;margin-bottom:8px;font-size:11px">'
    +'<div style="display:flex;justify-content:space-between">'
    +'<span style="color:var(--muted)">æ¦‚ç®—ç²—åˆ©</span>'
    +'<span class="mono" style="color:'+profitColor+';font-weight:700">'+(profit>=0?'+':'')+'Â¥'+profit.toLocaleString()+'</span>'
    +'</div></div>';
}

function sannaiReadOfferForm(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.sannai) c.sannai = {};
  const sn = c.sannai;

  const buyPrice  = parseInt((document.getElementById('sn-buy-price')?.value||'').replace(/,/g,''))||0;
  const sellPrice = parseInt((document.getElementById('sn-sell-price')?.value||'').replace(/,/g,''))||0;

  if(buyPrice)  sn.buyPrice  = buyPrice;
  if(sellPrice) { sn.sellPrice = sellPrice; c.salePrice = sellPrice; }

  // comm pay
  const commBuyCo  = document.getElementById('sn-comm-buy-co')?.value.trim()||'';
  const commBuyAmt = parseInt((document.getElementById('sn-comm-buy-amt')?.value||'').replace(/,/g,''))||0;
  const commSellCo  = document.getElementById('sn-comm-sell-co')?.value.trim()||'';
  const commSellAmt = parseInt((document.getElementById('sn-comm-sell-amt')?.value||'').replace(/,/g,''))||0;
  if(commBuyCo)  sn.commBuyCo  = commBuyCo;
  if(commBuyAmt) sn.commBuyAmt = commBuyAmt;
  if(commSellCo)  sn.commSellCo  = commSellCo;
  if(commSellAmt) sn.commSellAmt = commSellAmt;

  // deleg rows
  const rows = [];
  document.querySelectorAll('.sn-deleg-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const selects = row.querySelectorAll('select');
    const co  = inputs[0]?.value.trim()||'';
    const type = selects[0]?.value||'broker';
    const amt  = parseInt((inputs[1]?.value||'').replace(/,/g,''))||0;
    if(co || amt) rows.push({co, type, amt});
  });
  sn.delegPay = rows;
}

function sannaiOfferDone(id) {
  try {
    const prop  = document.getElementById('s-sale-prop')?.value.trim()||'';
    const d     = document.getElementById('s-offer-date')?.value||todayISO();
    const c = CASES.find(x=>x.id===id); if(!c) return;
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];

    sannaiReadOfferForm(id);

    const sn = c.sannai || {};
    if(prop) c.dates.naikenProp = prop;
    if(!c.invoice) c.invoice = {type:'commission'};

    // Build hist memo
    const bp = sn.buyPrice ? ' ä»•å…¥Â¥'+sn.buyPrice.toLocaleString() : '';
    const sp = sn.sellPrice ? ' è²©å£²Â¥'+sn.sellPrice.toLocaleString() : '';
    advance(id,'invoice','offer',d,'è²·ä»˜å—é ˜'+bp+sp+' â†’ è«‹æ±‚æ›¸ã¸');
  } catch(e) { console.error('sannaiOfferDone:', e); }
}

function stepSannaiVerify(c) {
  const b   = c.buyer || {};
  const id  = c.id;
  const state = b.verifyState || 'input'; // 'input' | 'pending' | 'verified'

  // â”€â”€ èªè¨¼æ¸ˆã¿ â†’ è²·ä»˜ã¸é€²ã‚€ â”€â”€
  if (state === 'verified') {
    const isSpecial = b.isSpecial || false;
    const statusTxt = isSpecial
      ? 'âœ… ç‰¹ä¾‹æ‰¿èªæ¸ˆ â€” æœ¬éƒ¨æ‰¿èªã‚³ãƒ¼ãƒ‰ç¢ºèªæ¸ˆ'
      : 'âœ… å®…å»ºæ¥­è€…ç¢ºèªæ¸ˆ â€” ' + (b.takkenNum||'');
    const buyerName = b.name ? b.name : '';
    return '<div class="step-title">ğŸ” è²·ä¸»æ¥­è€…ç¢ºèªï¼ˆä¸‰ç‚ºï¼‰</div>'
      +'<div style="padding:12px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);border-radius:8px;margin-bottom:12px;font-size:11px">'
      +'<div style="color:var(--green);font-weight:700;margin-bottom:4px">'+statusTxt+'</div>'
      +'<div style="color:var(--sub)">è²·ä¸»: '+buyerName+'</div>'
      +'</div>'
      +'<button class="btn btn-green" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="sannaiVerifyPass(this.dataset.cid)">â†’ è²·ä»˜å…¥åŠ›ã¸</button>'
      +'<div style="margin-top:8px;text-align:right">'
      +'<button class="btn btn-ghost btn-sm" data-cid="'+id+'" onclick="sannaiVerifyReset(this.dataset.cid)">â†© å†å…¥åŠ›</button>'
      +'</div>';
  }

  // â”€â”€ ç¢ºèªä¾é ¼é€ä¿¡æ¸ˆã¿ â†’ ã‚³ãƒ¼ãƒ‰å…¥åŠ›å¾…ã¡ â”€â”€
  const pendingHtml = (state === 'pending') ? (
    '<div style="margin-bottom:12px;padding:10px 12px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:8px;font-size:11px">'
    +'<div style="color:var(--blue);font-weight:700;margin-bottom:4px">ğŸ“¨ ç¢ºèªä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ</div>'
    +'<div style="color:var(--sub)">è²·ä¸»: '+(b.name||'â€”')+(b.takkenNum?' / '+b.takkenNum:'')+'</div>'
    +'<div style="color:var(--muted);margin-top:3px;font-size:10px">æœ¬éƒ¨ã‹ã‚‰ã®æ‰¿èªã‚³ãƒ¼ãƒ‰ã‚’ãŠå¾…ã¡ãã ã•ã„</div>'
    +'</div>'
  ) : '';

  // â”€â”€ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆinput ã¾ãŸã¯ pendingï¼‰ â”€â”€
  const showForm = (state === 'input');
  return '<div class="step-title">ğŸ” è²·ä¸»æ¥­è€…ç¢ºèªï¼ˆä¸‰ç‚ºï¼‰</div>'
    +'<div style="padding:10px 12px;background:rgba(79,156,249,.06);border:1px solid rgba(79,156,249,.2);border-radius:8px;margin-bottom:12px;font-size:11px;color:var(--sub)">'
    +'ä¸‰ç‚ºå–å¼•ã§ã¯è²·ä¸»ã®å®…å»ºæ¥­è€…ç¢ºèªãŒå¿…è¦ã§ã™ã€‚æƒ…å ±ã‚’å…¥åŠ›ã—æœ¬éƒ¨ã«ç¢ºèªä¾é ¼ã‚’é€ã£ã¦ãã ã•ã„ã€‚ä¸€èˆ¬æ³•äººã¸ã®è²©å£²ã®å ´åˆã‚‚æœ¬éƒ¨ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã‚Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
    +'</div>'
    + pendingHtml
    +(showForm
      ? '<div class="fi"><label>è²·ä¸» ä¼šç¤¾å</label><input type="text" id="sn-buyer-name" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã€‡ã€‡ä¸å‹•ç”£" value="'+(b.name||'')+'"></div>'
        +'<div class="fi"><label>å®…å»ºæ¥­è€…ç•ªå· <span style="font-size:10px;color:var(--muted);font-weight:400">ï¼ˆä¸€èˆ¬æ³•äººã®å ´åˆã¯ç©ºæ¬„å¯ï¼‰</span></label><input type="text" id="sn-takken" class="mono" placeholder="ä¾‹: æ±äº¬éƒ½çŸ¥äº‹ï¼ˆ3ï¼‰ç¬¬12345å·" value="'+(b.takkenNum||'')+'" style="font-size:12px"></div>'
        +'<button class="btn btn-blue" style="width:100%;justify-content:center;margin-top:4px" data-cid="'+id+'" onclick="sannaiRequestVerify(this.dataset.cid)">ğŸ“¨ æœ¬éƒ¨ã«ç¢ºèªä¾é ¼ã‚’é€ã‚‹</button>'
      : '<div style="display:flex;gap:6px;margin-bottom:8px">'
        +'<button class="btn btn-ghost btn-sm" data-cid="'+id+'" onclick="sannaiVerifyReset(this.dataset.cid)" style="flex-shrink:0">â†© å†å…¥åŠ›</button>'
        +'</div>'
    )
    +'<div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border)">'
    +'<div style="font-size:10px;color:var(--muted);margin-bottom:6px;font-weight:600;letter-spacing:.5px">ğŸ”‘ æœ¬éƒ¨æ‰¿èªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>'
    +'<div style="display:flex;gap:6px">'
    +'<input type="text" id="sn-verify-code" placeholder="ä¾‹: K7X9QM" maxlength="8" style="flex:1;background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:7px 10px;color:var(--text);font-size:14px;font-family:var(--mono);letter-spacing:.15em;text-transform:uppercase" oninput="this.value=this.value.toUpperCase()">'
    +'<button class="btn btn-gold btn-sm" style="font-weight:700;letter-spacing:.05em" data-cid="'+id+'" onclick="sannaiEnterCode(this.dataset.cid)">èªè¨¼</button>'
    +'</div>'
    +'<div style="font-size:10px;color:var(--muted);margin-top:5px">æœ¬éƒ¨ã‹ã‚‰å—ã‘å–ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'
    +'</div>';
}

// æœ¬éƒ¨ã«Slacké€šçŸ¥ â†’ ãƒšãƒ¼ã‚¸å†…ã§ã¯ pending çŠ¶æ…‹ã«ã™ã‚‹
function sannaiRequestVerify(id) {
  const name   = document.getElementById('sn-buyer-name')?.value.trim()||'';
  const takken = document.getElementById('sn-takken')?.value.trim()||'';
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!name) { alert('è²·ä¸»ã®ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(!c.buyer) c.buyer = {};

  // 6æ¡è‹±æ•°å­—ã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆ
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for(let i=0;i<6;i++) code += chars[Math.floor(Math.random()*chars.length)];

  c.buyer.name        = name;
  c.buyer.takkenNum   = takken;
  c.buyer.pendingCode = code;
  c.buyer.verifyState = 'pending';
  c.buyer.isSpecial   = !takken; // å®…å»ºç•ªå·ãªã— = ä¸€èˆ¬æ³•äººæ‰±ã„

  const isSpecial = !takken;
  const lines = [
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    isSpecial ? 'âš  *ä¸‰ç‚º æ¥­è€…ç¢ºèªä¾é ¼ï¼ˆä¸€èˆ¬æ³•äººç‰¹ä¾‹ï¼‰*' : 'ğŸ” *ä¸‰ç‚º æ¥­è€…ç¢ºèªä¾é ¼*',
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    `ğŸ“ *æ¡ˆä»¶ID*ï¼š${id}`,
    `ğŸ  *ç‰©ä»¶*ï¼š${c.dates?.naikenProp||c.sub||'â€”'}`,
    `ğŸ¢ *è²·ä¸»*ï¼š${name}`,
    takken ? `ğŸ“‹ *å®…å»ºç•ªå·*ï¼š${takken}` : 'ğŸ“‹ *å®…å»ºç•ªå·*ï¼šï¼ˆæœªå…¥åŠ› / ä¸€èˆ¬æ³•äººï¼‰',
    `ğŸ”‘ *æ‰¿èªã‚³ãƒ¼ãƒ‰*ï¼š\`${code}\``,
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    'âœ… ç¢ºèªå¾Œã€ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ä¼é”ã—ã¦ãã ã•ã„',
    `ğŸ• ${new Date().toLocaleString('ja-JP')}`,
  ].join('\n');

  console.log('[Slack #ä¸‰ç‚ºç¢ºèª]\n', lines);
  // Slack webhook é€ä¿¡ï¼ˆãƒ¢ãƒƒã‚¯: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼‰
  try {
    const ta=document.createElement('textarea');
    ta.value=lines; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  } catch(e){}

  c.hist.unshift(today()+' æ¥­è€…ç¢ºèªä¾é ¼é€ä¿¡ / è²·ä¸»: '+name+(takken?' ('+takken+')':'ï¼ˆä¸€èˆ¬æ³•äººï¼‰'));
  open_case(id);
  toast('ç¢ºèªä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ â€” æœ¬éƒ¨ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã£ã¦ãã ã•ã„');
}


function editSannaiOffer(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  c.step = 'offer';
  open_case(id);
}


function sannaiVerifyPass(id) {
  // èªè¨¼æ¸ˆã¿ç¢ºèªå¾Œã€è²·ä»˜ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€
  try {
    const c = CASES.find(x=>x.id===id); if(!c) return;
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(!c.invoice) c.invoice = {type:'commission'};
    advance(id,'offer',null,null,'æ¥­è€…ç¢ºèªæ¸ˆ â†’ è²·ä»˜ã¸');
  } catch(e) { console.error('sannaiVerifyPass:', e); }
}

function sannaiVerifyReset(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.buyer) c.buyer = {};
  c.buyer.verifyState = 'input';
  c.buyer.pendingCode = null;
  c.buyer.verified    = false;
  open_case(id);
}

function sannaiEnterCode(id) {
  const code = (document.getElementById('sn-verify-code')?.value||'').trim().toUpperCase();
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!code) { alert('æ‰¿èªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(!c.buyer) { alert('å…ˆã«ç¢ºèªä¾é ¼ã‚’é€ä¿¡ã—ã¦ãã ã•ã„'); return; }

  const expectedCode = c.buyer.pendingCode;
  if(!expectedCode) {
    alert('ç¢ºèªä¾é ¼ãŒã¾ã é€ä¿¡ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ã€Œæœ¬éƒ¨ã«ç¢ºèªä¾é ¼ã‚’é€ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  if(code !== expectedCode) {
    alert('æ‰¿èªã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚æœ¬éƒ¨ã‹ã‚‰å—ã‘å–ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå…¥åŠ›: ' + code);
    return;
  }

  // èªè¨¼æˆåŠŸ
  c.buyer.verified    = true;
  c.buyer.verifyState = 'verified';
  c.hist.unshift(today()+' æ¥­è€…ç¢ºèªå®Œäº† / '+c.buyer.name+(c.buyer.takkenNum?' ('+c.buyer.takkenNum+')':'ï¼ˆä¸€èˆ¬æ³•äººæ‰¿èªï¼‰'));
  slackSend(SLACK_CH.ä¸‰ç‚ºç¢ºèª, [
    ...slackHeader('âœ…','ä¸‰ç‚º æ¥­è€…ç¢ºèªã‚³ãƒ¼ãƒ‰èªè¨¼å®Œäº†'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+(c.dates?.naikenProp||c.sub||'â€”'),
    'ğŸ¢ *è²·ä¸»*ï¼š'+c.buyer.name,
    c.buyer.takkenNum ? 'ğŸ“‹ *å®…å»ºç•ªå·*ï¼š'+c.buyer.takkenNum : 'ğŸ“‹ *å®…å»ºç•ªå·*ï¼šï¼ˆä¸€èˆ¬æ³•äººï¼‰',
    'ğŸ”‘ *èªè¨¼*ï¼šå®Œäº†',
    ...slackFooter(),
  ]);
  open_case(id);
  toast('âœ… æ¥­è€…ç¢ºèªå®Œäº† â€” è²·ä»˜å…¥åŠ›ã¸é€²ã‚“ã§ãã ã•ã„');
}




function saleContractDone(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  const inv = c.invoice||{};
  slackSend(SLACK_CH.å¥‘ç´„, [
    ...slackHeader('âœï¸','å£²è²·å¥‘ç´„ç· çµ'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+(inv.prop||c.dates?.naikenProp||c.sub||'â€”'),
    inv.salePrice ? 'ğŸ’´ *å£²è²·ä¾¡æ ¼*ï¼šÂ¥'+parseInt(inv.salePrice).toLocaleString() : null,
    inv.grandTotal ? 'ğŸ’° *è«‹æ±‚åˆè¨ˆ*ï¼šÂ¥'+parseInt(inv.grandTotal).toLocaleString() : null,
    ...slackFooter(),
  ]);
  advance(id,'settlement','contract',todayISO(),'å£²è²·å¥‘ç´„ç· çµ');
}
function settlementDone(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  const d = document.getElementById('s-settlement')?.value||todayISO();
  const inv = c.invoice||{};
  const sn  = c.sannai||{};
  slackSend(SLACK_CH.æ±ºæ¸ˆ, [
    ...slackHeader('ğŸ’´','æ±ºæ¸ˆå®Œäº† â†’ æˆç´„'),
    ...slackCase(c),
    'ğŸ  *ç‰©ä»¶*ï¼š'+(inv.prop||c.dates?.naikenProp||c.sub||'â€”'),
    'ğŸ“… *æ±ºæ¸ˆæ—¥*ï¼š'+d,
    sn.sellPrice ? 'ğŸ’´ *è²©å£²ä¾¡æ ¼*ï¼šÂ¥'+sn.sellPrice.toLocaleString() : (inv.salePrice ? 'ğŸ’´ *å£²è²·ä¾¡æ ¼*ï¼šÂ¥'+parseInt(inv.salePrice).toLocaleString() : null),
    inv.grandTotal ? 'ğŸ’° *è«‹æ±‚åˆè¨ˆ*ï¼šÂ¥'+parseInt(inv.grandTotal).toLocaleString() : null,
    ...slackFooter(),
  ]);
  advance(id,'done','settlement',d,'æ±ºæ¸ˆå®Œäº† (æ±ºæ¸ˆæ—¥: '+d+') â†’ æˆç´„');
}

function offerDone(id) {
  try {
    const prop  = document.getElementById('s-sale-prop')?.value.trim()||'';
    const price = parseInt((document.getElementById('s-sale-price')?.value||'').replace(/,/g,''))||0;
    const d     = document.getElementById('s-offer-date')?.value||todayISO();
    const c = CASES.find(x=>x.id===id);
    if(!c) { console.error('offerDone: case not found', id); return; }
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(prop)  c.dates.naikenProp = prop;
    if(price) c.salePrice = price;
    if(!c.invoice) c.invoice = {type:'commission'};
    advance(id,'invoice','offer',d,'è²·ä»˜å—é ˜ â†’ è«‹æ±‚æ›¸ã¸');
  } catch(e) {
    console.error('offerDone error:', e);
    toast('ã‚¨ãƒ©ãƒ¼: '+e.message);
  }
}


function cancelCase(id) {
  if(!confirm('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  advance(id,'cancel',null,null,'ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
}
function reactivate(id) {
  const c = CASES.find(x=>x.id===id);
  c.step='naiken'; c.hist.unshift(today()+' æ¡ˆä»¶å†é–‹');
  open_case(id);
}

function jumpStep(id, stepId) {
  const c = CASES.find(x=>x.id===id);
  if(!c) return;
  const steps = c.type==='reLet'?STEPS_RELET:c.type==='sannai'?STEPS_SANNAI:STEPS_RESALE;
  const valid = steps.map(s=>s.id);
  if(!valid.includes(stepId)) return;
  c.step = stepId;
  open_case(id);
}

function addMemo(id) {
  const inp = document.getElementById('memo-inp');
  const txt = inp?.value.trim();
  if(!txt) return;
  const c = CASES.find(x=>x.id===id);
  c.hist.unshift(today()+' '+txt);
  inp.value='';
  buildStepContent(c);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW CASE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _corpMode = false;

function openNewModal(stageHint) {
  _corpMode = false;
  openModal(
    'ï¼‹ æ–°è¦æ¡ˆä»¶'
    +'<div style="display:flex;gap:6px;margin-bottom:10px">'
    +'<button id="ct-ind" class="btn btn-ghost btn-sm" style="flex:1;border-color:var(--gold);color:var(--gold)" onclick="setCorp(false)">ğŸ‘¤ å€‹äºº</button>'
    +'<button id="ct-corp" class="btn btn-ghost btn-sm" style="flex:1" onclick="setCorp(true)">ğŸ¢ æ³•äºº</button>'
    +'</div>'
    +'<div class="fi"><label id="nc-name-lbl">æ°å</label><input type="text" id="nc-name" placeholder="ç”°ä¸­ å¤ªéƒ"></div>'
    +'<div id="nc-corp-ext" style="display:none"><div class="fi"><label>æ‹…å½“è€…å</label><input type="text" id="nc-contact" placeholder="ç”°ä¸­ ä¸€éƒ"></div></div>'
    +'<div class="fi"><label>ç¨®åˆ¥</label><select id="nc-type" onchange="toggleAD()"><option value="reLet">ğŸ  è³ƒè²¸</option><option value="reSale">ğŸ¢ å£²è²·</option><option value="sannai">ğŸ”„ ä¸‰ç‚º</option><option value="hr">ğŸ‘¥ äººæ</option></select></div>'+'<div id="nc-ad-wrap" style="margin-bottom:10px"><label style="display:flex;align-items:center;gap:7px;font-size:11px;cursor:pointer"><input type="checkbox" id="nc-ad"> ADæ¡ˆä»¶ï¼ˆä»²ä»‹æ‰‹æ•°æ–™ã¯éµæ¸¡ã—å¾Œå…¥é‡‘ï¼‰</label></div>'
    +'<div class="fi"><label>å¸Œæœ›æ¡ä»¶</label><input type="text" id="nc-sub" placeholder="ä¾‹: æ¸‹è°·åŒº 1LDK / ç›®é»’åŒº ãƒãƒ³ã‚·ãƒ§ãƒ³ 3,000ä¸‡"></div>'
    +'<div id="nc-hr-wrap" style="display:none;border:1px solid var(--border2);border-radius:8px;padding:12px;margin-bottom:10px;background:var(--bg)">'+'<div style="font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:8px">ğŸ‘¥ æœ€åˆã®å¿œå‹Ÿå…ˆï¼ˆä»»æ„ãƒ»å¾Œã§è¿½åŠ å¯ï¼‰</div>'+'<div class="fi"><label>ä¼æ¥­å</label><input type="text" id="nc-company" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ãƒ†ã‚¯ãƒ"></div>'+'<div class="fi"><label>ãƒã‚¸ã‚·ãƒ§ãƒ³</label><input type="text" id="nc-position" placeholder="ä¾‹: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ / å–¶æ¥­"></div>'+'<div class="fi"><label>æƒ³å®šå¹´åï¼ˆä¸‡å††ï¼‰</label><input type="number" id="nc-salary" placeholder="ä¾‹: 600"></div>'+'</div>'+'<div class="row" style="margin-top:14px"><button class="btn btn-ghost" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
    +'<button class="btn btn-gold" style="flex:2;justify-content:center" onclick="createCase()">ç™»éŒ²</button></div>'
  );
}

function toggleAD() {
  const t = document.getElementById('nc-type')?.value;
  const wrap = document.getElementById('nc-ad-wrap');
  if(wrap) wrap.style.display = t==='reLet' ? 'block' : 'none';
  // HR fields
  const hrWrap = document.getElementById('nc-hr-wrap');
  const reProp = document.getElementById('nc-re-prop');
  if(hrWrap) hrWrap.style.display = t==='hr' ? 'block' : 'none';
  if(reProp) reProp.style.display = t==='hr' ? 'none' : 'block';
  // Update placeholder for condition field
  const sub = document.getElementById('nc-sub');
  if(sub) sub.placeholder = t==='hr' ? 'ä¾‹: ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ / Webãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ / å¸Œæœ›å¹´å700ä¸‡' : 'ä¾‹: æ¸‹è°·åŒº 1LDK / ç›®é»’åŒº ãƒãƒ³ã‚·ãƒ§ãƒ³ 3,000ä¸‡';
  const nameLbl = document.getElementById('nc-name-lbl');
  if(nameLbl) nameLbl.textContent = t==='hr' ? 'å€™è£œè€…å' : 'æ°å';
}

function setCorp(flag) {
  _corpMode = flag;
  const ind  = document.getElementById('ct-ind');
  const corp = document.getElementById('ct-corp');
  const ext  = document.getElementById('nc-corp-ext');
  const lbl  = document.getElementById('nc-name-lbl');
  const inp  = document.getElementById('nc-name');
  if(flag) {
    corp.style.borderColor='var(--purple)'; corp.style.color='var(--purple)';
    ind.style.borderColor=''; ind.style.color='';
    ext.style.display='block'; lbl.textContent='æ³•äººå'; inp.placeholder='æ ªå¼ä¼šç¤¾ã€‡ã€‡';
  } else {
    ind.style.borderColor='var(--gold)'; ind.style.color='var(--gold)';
    corp.style.borderColor=''; corp.style.color='';
    ext.style.display='none'; lbl.textContent='æ°å'; inp.placeholder='ç”°ä¸­ å¤ªéƒ';
  }
}

function createCase() {
  const name = document.getElementById('nc-name')?.value.trim();
  if(!name){alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const contact = document.getElementById('nc-contact')?.value.trim()||'';
  if(_corpMode&&!contact){alert('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const type = document.getElementById('nc-type')?.value;
  const sub  = document.getElementById('nc-sub')?.value.trim()||'â€”';
  const prefix = type==='reLet'?'R':type==='reSale'?'S':type==='sannai'?'N':'H';
  const id = prefix+String(Math.floor(Math.random()*90000+10000));
  const initStep = (type==='reLet'||type==='reSale'||type==='sannai')?'naiken':'new';
  const adOnly = document.getElementById('nc-ad')?.checked && type==='reLet';
  const _agentId = (window._SESSION && window._SESSION.userId) ? window._SESSION.userId : '10012';
  const obj = {id, name, type, corp:_corpMode, agent:_agentId, sub, step:initStep, age:0, stale:false, adOnly, taskDone:{paid:false,itsetsu:false}, apps:[], dates:{}, hist:[today()+' æ¡ˆä»¶ç™»éŒ²'+(adOnly?' [ADæ¡ˆä»¶]':'')]};
  if(_corpMode&&contact) obj.contactName = contact;
  if(type==='sannai') obj.buyer = {name:'', takkenNum:'', verified:false, bypass:false};
  if(type==='hr') {
    const firstCo = document.getElementById('nc-company')?.value.trim();
    const firstPos = document.getElementById('nc-position')?.value.trim()||'â€”';
    const firstSal = parseInt(document.getElementById('nc-salary')?.value)||0;
    obj.industry  = firstPos;
    obj.position  = firstPos;
    obj.salary    = document.getElementById('nc-salary')?.value||'';
    obj.companies = firstCo ? [{
      id: 'CO'+String(Date.now()).slice(-6),
      name: firstCo, industry:'', position: firstPos,
      salary: firstSal, status:'screening',
      interviewCount:0, nextInterview:'', fee:0, startDate:'', notes:''
    }] : [];
    obj.step = 'naiken';
  }
  CASES.unshift(obj);
  closeModal();
  render();
  open_case(id);
  // Slack #æ–°è¦æ¡ˆä»¶
  const typeLabel2 = type==='sannai'?'ä¸‰ç‚º':type==='reSale'?'å£²è²·':type==='reLet'?'è³ƒè²¸':'ãã®ä»–';
  slackSend(SLACK_CH.æ–°è¦æ¡ˆä»¶, [
    ...slackHeader('ğŸ†•','æ–°è¦æ¡ˆä»¶ç™»éŒ²'),
    'ğŸ“ *æ¡ˆä»¶ID*ï¼š'+id,
    'ğŸ‘¤ *ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ*ï¼š'+name+(_corpMode&&contact?' ï¼ˆæ‹…å½“: '+contact+'ï¼‰':''),
    'ğŸ· *ç¨®åˆ¥*ï¼š'+typeLabel2+(_corpMode?' / æ³•äºº':''),
    type==='hr' ? 'ğŸ¢ *ä¼æ¥­*ï¼š'+(document.getElementById('nc-company')?.value||'â€”') : null,
    type==='hr' ? 'ğŸ’¼ *ãƒã‚¸ã‚·ãƒ§ãƒ³*ï¼š'+(document.getElementById('nc-position')?.value||'â€”') : null,
    adOnly ? 'ğŸ’¡ ADæ¡ˆä»¶' : null,
    'ğŸ‘¨â€ğŸ’¼ *æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ*ï¼š'+obj.agent,
    sub&&sub!=='â€”' ? 'ğŸ“ *å‚™è€ƒ*ï¼š'+sub : null,
    ...slackFooter(),
  ]);
  toast('æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å£²è²·ä¾¡æ ¼ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function fmtYen(v) {
  if (!v && v !== 0) return '';
  const n = parseInt(String(v).replace(/,/g,''));
  return isNaN(n) ? '' : n.toLocaleString('ja-JP');
}

function invSalePriceInput(el) {
  const raw = el.value.replace(/[^0-9]/g,'');
  const num = parseInt(raw);
  const formatted = isNaN(num) ? '' : num.toLocaleString('ja-JP');
  const pos = el.selectionStart;
  const oldLen = el.value.length;
  el.value = formatted;
  const newLen = formatted.length;
  const delta = newLen - oldLen;
  el.setSelectionRange(Math.max(0, pos + delta), Math.max(0, pos + delta));
  if (document.getElementById('inv-sale-price')) invCalcSale();
  if (document.getElementById('sn-spread')) sannaiCalcProfit();
}

function openModal(inner) {
  document.getElementById('modal-box').innerHTML = inner;
  document.getElementById('overlay').classList.add('on');
}

function closeModal() { document.getElementById('overlay').classList.remove('on'); }
document.getElementById('overlay').addEventListener('click', e=>{if(e.target.id==='overlay')closeModal();});

function toast(msg) {
  const t=document.getElementById('toast');
  t.textContent='âœ“ '+msg; t.style.display='block';
  clearTimeout(t._t); t._t=setTimeout(()=>t.style.display='none',2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();

// â”€â”€ ç´¹ä»‹ãƒªãƒ³ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _refCurrentCode = '';
function openRefModal() {
  var overlay = document.getElementById('ref-modal-overlay');
  var selector = document.getElementById('ref-code-selector');
  var isExec = (typeof session !== 'undefined' && session && session.hqRole === 'exec')
            || (typeof CURRENT_USER !== 'undefined' && CURRENT_USER && CURRENT_USER.hqRole === 'exec');
  var agentId = (typeof session !== 'undefined' && session && session.userId) ? session.userId
              : (typeof ME !== 'undefined' && ME && ME.id) ? ME.id
              : (typeof AGENT !== 'undefined' && AGENT && AGENT.id) ? AGENT.id : '10012';
  if (isExec) {
    var SPECIAL = ['FOUNDER2026','WELCOME2026','GOLD_START','HR_PRO75'];
    var opts = SPECIAL.map(function(c){ return '<option value="'+c+'">â­ '+c+'</option>'; }).join('');
    selector.innerHTML =
      '<div style="margin-bottom:12px"><div style="font-size:10px;color:var(--sub);font-weight:600;margin-bottom:5px">ã‚³ãƒ¼ãƒ‰ç¨®åˆ¥</div>'
      +'<select id="ref-code-select" onchange="updateRefLink()" style="width:100%;padding:8px 10px;background:var(--card2);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-size:12px;font-family:inherit">'
      +'<option value="'+agentId+'">è‡ªåˆ†ã®IDï¼ˆ'+agentId+'ï¼‰</option>'
      +'<optgroup label="â”€â”€ ç‰¹åˆ¥ã‚³ãƒ¼ãƒ‰ â”€â”€">'+opts+'</optgroup>'
      +'</select></div>';
    _refCurrentCode = agentId;
  } else {
    selector.innerHTML =
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px">'
      +'<span style="font-size:11px;color:var(--muted)">ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼š</span>'
      +'<span style="font-family:\'DM Mono\',monospace;font-size:13px;font-weight:700;color:var(--gold)">'+agentId+'</span>'
      +'</div>';
    _refCurrentCode = agentId;
  }
  updateRefLink();
  overlay.classList.add('open');
}
function updateRefLink() {
  var sel = document.getElementById('ref-code-select');
  if (sel) _refCurrentCode = sel.value;
  var base = location.origin + location.pathname.replace(/[^/]*$/, '') + 'coreto-agent-signup.html';
  var url = base + '?ref=' + encodeURIComponent(_refCurrentCode);
  document.getElementById('ref-url-display').textContent = url;
}
function closeRefModal() {
  document.getElementById('ref-modal-overlay').classList.remove('open');
}
function copyRefLink() {
  var url = document.getElementById('ref-url-display').textContent;
  navigator.clipboard.writeText(url).then(function() {
    var btn = document.querySelector('.ref-copy-btn');
    btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
    setTimeout(function(){ btn.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼'; }, 2000);
  }).catch(function() {
    var ta = document.createElement('textarea');
    ta.value = url; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  });
}
</script>

<div id="ref-modal-overlay" onclick="if(event.target===this)closeRefModal()">
  <div id="ref-modal">
    <div class="ref-mhdr">
      <div class="ref-mhdr-t">ğŸ”— ç´¹ä»‹ãƒªãƒ³ã‚¯ç™ºè¡Œ</div>
      <button onclick="closeRefModal()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1">Ã—</button>
    </div>
    <div class="ref-mbody">
      <div style="font-size:11px;color:var(--sub);margin-bottom:14px;line-height:1.8">ã“ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å…¥ä¼šã™ã‚‹ã¨ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</div>
      <div id="ref-code-selector"></div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:4px;font-weight:600;letter-spacing:.5px">ç™ºè¡Œãƒªãƒ³ã‚¯</div>
      <div class="ref-url" id="ref-url-display">â€”</div>
      <button class="ref-copy-btn" onclick="copyRefLink()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>
</div>

<button id="ref-float-btn" onclick="openRefModal()">ğŸ”— ç´¹ä»‹ãƒªãƒ³ã‚¯ç™ºè¡Œ</button>
</body>
</html>
