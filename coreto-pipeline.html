<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORETO â€” æ¡ˆä»¶ç®¡ç†</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--card:#0f1119;--card2:#141720;--border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--gold-dim:#7a5f22;--gold-glow:rgba(201,168,76,.1);
  --blue:#4f9cf9;--green:#34d399;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;
  --muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;
}
html,body{height:100%;font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);overflow:hidden}

/* â”€â”€ Layout â”€â”€ */
.layout{display:flex;flex-direction:column;height:100vh}
.hdr{height:52px;display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;border-bottom:1px solid var(--border);background:rgba(7,9,15,.96);flex-shrink:0;z-index:50}
.logo{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;color:var(--gold);letter-spacing:3px}
.toolbar{height:44px;display:flex;align-items:center;gap:10px;padding:0 16px;
  border-bottom:1px solid var(--border);background:var(--card2);flex-shrink:0}
.main{display:flex;flex:1;overflow:hidden}

/* â”€â”€ Board â”€â”€ */
.board-wrap{flex:1;overflow-x:auto;overflow-y:hidden;display:flex}
.board{display:flex;height:100%}
.col{width:230px;flex-shrink:0;display:flex;flex-direction:column;border-right:1px solid var(--border)}
.col:last-child{border-right:none}
.col-hdr{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.col-title{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;display:flex;align-items:center;gap:7px}
.col-dot{width:7px;height:7px;border-radius:50%}
.col-count{font-size:9px;padding:1px 7px;border-radius:8px;font-weight:700}
.col-body{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:7px}

/* â”€â”€ Case cards â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:11px 12px;
  cursor:pointer;transition:.15s;position:relative}
.card:hover{border-color:var(--border2);background:#111420;transform:translateY(-1px)}
.card.active{border-color:var(--gold);background:#13110a}
.card-type{font-size:8px;font-weight:700;letter-spacing:.5px;margin-bottom:5px;display:flex;align-items:center;gap:5px}
.card-name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.card-sub{font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:6px}
.card-foot{display:flex;align-items:center;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px}
.card-id{font-family:'DM Mono',monospace;font-size:8px;color:var(--muted)}
.age{font-size:8px;padding:1px 6px;border-radius:4px;font-weight:700}
.stale{position:absolute;top:8px;right:8px;width:6px;height:6px;border-radius:50%;background:var(--red);animation:blink 2s infinite}
@keyframes blink{50%{opacity:.2}}
.add-row{padding:7px;border:1px dashed var(--border2);border-radius:8px;text-align:center;
  font-size:10px;color:var(--muted);cursor:pointer;transition:.15s}
.add-row:hover{border-color:var(--blue);color:var(--blue)}

/* â”€â”€ Detail Panel â”€â”€ */
.panel{width:0;overflow:hidden;border-left:1px solid var(--border);transition:.2s cubic-bezier(.4,0,.2,1);
  display:flex;flex-direction:column;background:var(--card);flex-shrink:0}
.panel.open{width:460px}
.panel-top{padding:16px 18px 0;flex-shrink:0}
.panel-body{flex:1;overflow-y:auto;padding:0 18px 18px}

/* â”€â”€ Step Progress â”€â”€ */
.step-bar{display:flex;align-items:center;margin:16px 0 20px}
.step-node{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;cursor:pointer}
.step-node:not(:last-child)::after{content:'';position:absolute;top:14px;left:50%;width:100%;height:1px;background:var(--border2);z-index:0}
.step-node.done::after{background:var(--green)}
.step-node.active::after{background:linear-gradient(90deg,var(--gold),var(--border2))}
.step-circle{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;border:2px solid var(--border2);background:var(--bg);
  position:relative;z-index:1;transition:.2s}
.step-node.done .step-circle{background:var(--green);border-color:var(--green);color:#0a0c10;font-size:12px}
.step-node.active .step-circle{background:var(--gold);border-color:var(--gold);color:#0a0c10;box-shadow:0 0 12px rgba(201,168,76,.4)}
.step-node.future .step-circle{color:var(--muted)}
.step-label{font-size:8px;margin-top:4px;font-weight:600;letter-spacing:.3px;white-space:nowrap}
.step-node.done .step-label{color:var(--green)}
.step-node.active .step-label{color:var(--gold)}
.step-node.future .step-label{color:var(--muted)}

/* â”€â”€ Step Content â”€â”€ */
.step-content{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:18px}
.step-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;margin-bottom:14px;
  display:flex;align-items:center;gap:8px}

/* â”€â”€ Inputs â”€â”€ */
.fi{margin-bottom:10px}
.fi label{font-size:10px;color:var(--sub);display:block;margin-bottom:3px}
.fi input,.fi select,.fi textarea{width:100%;background:#090b13;border:1px solid var(--border2);
  border-radius:7px;padding:8px 11px;color:var(--text);font-size:12px;
  font-family:'Noto Sans JP',sans-serif;outline:none;transition:border .15s}
.fi input:focus,.fi select:focus{border-color:var(--gold)}
input[type=date]{color-scheme:dark}
.mono{font-family:'DM Mono',monospace!important}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:9px 18px;border-radius:9px;font-size:12px;font-weight:700;cursor:pointer;
  font-family:'Noto Sans JP',sans-serif;transition:.15s;border:none;display:inline-flex;align-items:center;gap:7px}
.btn-green{background:var(--green);color:#0a0c10}
.btn-green:hover{background:#2ec98a;transform:translateY(-1px)}
.btn-red{background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.3)}
.btn-red:hover{background:rgba(248,113,113,.25)}
.btn-gold{background:linear-gradient(135deg,var(--gold),#a8872f);color:#0a0c10}
.btn-gold:hover{transform:translateY(-1px)}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--sub)}
.btn-ghost:hover{color:var(--text);border-color:var(--sub)}
.btn-blue{background:rgba(79,156,249,.15);color:var(--blue);border:1px solid rgba(79,156,249,.3)}
.btn-sm{padding:5px 12px;font-size:10px;border-radius:7px}
.btn-xs{padding:3px 9px;font-size:9px;border-radius:5px}
.row{display:flex;gap:8px}
.row .btn{flex:1;justify-content:center}

/* â”€â”€ Pill tags â”€â”€ */
.pill{display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:8px;font-weight:700}
.pill-green{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.pill-orange{background:rgba(251,146,60,.12);color:var(--orange);border:1px solid rgba(251,146,60,.2)}
.pill-red{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.2)}
.pill-purple{background:rgba(167,139,250,.12);color:var(--purple);border:1px solid rgba(167,139,250,.2)}
.pill-blue{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.2)}
.pill-muted{background:rgba(74,82,112,.15);color:var(--sub);border:1px solid var(--border2)}
.pill-gold{background:rgba(201,168,76,.12);color:var(--gold);border:1px solid rgba(201,168,76,.2)}

/* â”€â”€ App list (è¤‡æ•°ç”³è¾¼) â”€â”€ */
.app-item{background:#0b0d15;border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:6px}
.app-item.active-app{border-color:var(--gold)}
.app-name{font-size:12px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;justify-content:space-between}
.app-meta{font-size:10px;color:var(--sub)}

/* â”€â”€ History â”€â”€ */
.hist-item{display:flex;gap:8px;padding:4px 0}
.hist-dot{width:7px;height:7px;border-radius:50%;background:var(--border2);flex-shrink:0;margin-top:4px}
.hist-dot.cur{background:var(--gold)}
.hist-line{width:1px;height:14px;background:var(--border2);margin:1px auto}

/* â”€â”€ Modal â”€â”€ */
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(3px);z-index:200;align-items:center;justify-content:center}
#overlay.on{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px;max-width:400px;width:90%}
.modal-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold);margin-bottom:14px}

/* â”€â”€ Toast â”€â”€ */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--card);
  border:1px solid var(--green);border-radius:9px;padding:9px 16px;font-size:11px;
  color:var(--green);z-index:300;display:none;white-space:nowrap}

/* â”€â”€ Done state â”€â”€ */
.done-card{text-align:center;padding:20px}
.done-icon{font-size:48px;margin-bottom:8px}
.done-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--green)}

/* â”€â”€ cancel state â”€â”€ */
.cancel-card{text-align:center;padding:16px;color:var(--red)}
</style>
</head>
<body>
<div class="layout">

<div class="hdr">
  <div style="display:flex;align-items:center;gap:14px">
    <div class="logo">CORETO</div>
    <span style="font-size:9px;color:var(--muted);font-weight:600;letter-spacing:1px">æ¡ˆä»¶ç®¡ç†</span>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-ghost btn-sm" onclick="history.back()">â† æˆ»ã‚‹</button>
    <button class="btn btn-gold btn-sm" onclick="openNewModal()">ï¼‹ æ–°è¦æ¡ˆä»¶</button>
  </div>
</div>

<div class="toolbar">
  <select id="f-type" onchange="render()" style="background:#090b13;border:1px solid var(--border2);border-radius:6px;padding:4px 10px;color:var(--text);font-size:11px;font-family:inherit">
    <option value="">å…¨ç¨®åˆ¥</option>
    <option value="reLet">ğŸ  è³ƒè²¸</option>
    <option value="reSale">ğŸ¢ å£²è²·</option>
    <option value="hr">ğŸ‘¥ äººæ</option>
  </select>
  <select id="f-agent" onchange="render()" style="background:#090b13;border:1px solid var(--border2);border-radius:6px;padding:4px 10px;color:var(--text);font-size:11px;font-family:inherit">
    <option value="">å…¨æ‹…å½“</option>
    <option value="10012">å±±ç”° èª </option>
    <option value="10008">éˆ´æœ¨ å¥å¤ª</option>
    <option value="10023">ä½è—¤ èŠ±å­</option>
  </select>
  <span id="board-count" style="margin-left:auto;font-size:10px;color:var(--muted)"></span>
</div>

<div class="main">
  <div class="board-wrap"><div class="board" id="board"></div></div>

  <!-- Detail Panel -->
  <div class="panel" id="panel">
    <div class="panel-top" id="panel-top"></div>
    <div class="panel-body" id="panel-body"></div>
  </div>
</div>

</div><!-- /layout -->

<!-- Modal -->
<div id="overlay"><div class="modal" id="modal-box"></div></div>
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STAGES = [
  {id:'new',      label:'æ–°è¦',     dot:'#4a5270', color:'var(--sub)'},
  {id:'naiken',   label:'å†…è¦‹',     dot:'#4f9cf9', color:'var(--blue)'},
  {id:'apply',    label:'ç”³è¾¼ãƒ»å¯©æŸ»',dot:'#fb923c', color:'var(--orange)'},
  {id:'contract', label:'å¥‘ç´„ä¸­',   dot:'#c9a84c', color:'var(--gold)'},
  {id:'payment',  label:'å…¥é‡‘å¾…ã¡', dot:'#a78bfa', color:'var(--purple)'},
  {id:'done',     label:'å®Œäº†',     dot:'#34d399', color:'var(--green)'},
  {id:'cancel',   label:'å–æ¶ˆ',     dot:'#f87171', color:'var(--red)'},
];

// ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆè³ƒè²¸ï¼‰
const STEPS_RELET = [
  {id:'naiken',   label:'å†…è¦‹',   icon:'ğŸ ', stage:'naiken'},
  {id:'apply',    label:'ç”³è¾¼',   icon:'ğŸ“‹', stage:'apply'},
  {id:'screening',label:'å¯©æŸ»',   icon:'â³', stage:'apply'},
  {id:'invoice',  label:'è«‹æ±‚æ›¸', icon:'ğŸ§¾', stage:'contract'},
  {id:'prekey',   label:'é‡èª¬ãƒ»å…¥é‡‘', icon:'ğŸ“', stage:'contract'},
  {id:'key',      label:'éµæ¸¡ã—', icon:'ğŸ”‘', stage:'done'},
];

// ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆå£²è²·ï¼‰
const STEPS_RESALE = [
  {id:'offer',    label:'è²·ä»˜',   icon:'ğŸ“„', stage:'apply'},
  {id:'contract', label:'å¥‘ç´„',   icon:'âœï¸', stage:'contract'},
  {id:'payment',  label:'æ±ºæ¸ˆ',   icon:'ğŸ’´', stage:'payment'},
  {id:'done',     label:'å¼•æ¸¡ã—', icon:'ğŸ”‘', stage:'done'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CASES = [
  {id:'R042857', name:'ç”°ä¸­ é›„ä»‹', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸‹è°·åŒº 2LDK ã€œÂ¥220,000', step:'screening', age:3, stale:false,
   apps:[
     {id:'A001', prop:'æ¸‹è°·åŒºæ¡œä¸˜ 2LDK', mgmt:'ä¸‰äº•ä½å‹ç®¡ç†', date:'2026-02-18', status:'rejected'},
     {id:'A002', prop:'æ¸‹è°·åŒºä»£ã€…æœ¨ 2LDK', mgmt:'æ±æ€¥ãƒªãƒãƒ–ãƒ«ç®¡ç†', date:'2026-02-21', status:'reviewing'},
   ],
   dates:{naiken:'2026-02-17'}, hist:['2/17 å†…è¦‹å®Œäº†','2/18 ç”³è¾¼â†’å¯©æŸ»è½ã¡','2/21 åˆ¥ç‰©ä»¶ã§å†ç”³è¾¼'],
  },
  {id:'R039102', name:'æœ¨æ‘ å½©é¦™', type:'reLet', corp:false, agent:'10012',
   sub:'å“å·åŒº 1K ã€œÂ¥85,000', step:'screening', age:1, stale:false,
   apps:[
     {id:'A010', prop:'å“å·åŒºå¤§å´ 1K', mgmt:'å¤§å´ç®¡ç†', date:'2026-02-21', status:'reviewing', sim:true},
     {id:'A011', prop:'å“å·åŒºäº”åç”° 1K', mgmt:'æ±æ€¥ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', date:'2026-02-21', status:'reviewing', sim:true},
   ],
   dates:{naiken:'2026-02-20'}, hist:['2/20 å†…è¦‹å®Œäº†','2/21 2ç‰©ä»¶åŒæ™‚ç”³è¾¼'],
  },
  {id:'R041003', name:'æ–è—¤ äº®', type:'reLet', corp:false, agent:'10023',
   sub:'æ–°å®¿åŒº 1LDK ã€œÂ¥130,000', step:'naiken', age:9, stale:true,
   apps:[], dates:{}, hist:['2/11 å•åˆã›å—ä¿¡'],
  },
  {id:'R044201', name:'æ©‹æœ¬ æ—©è‹—', type:'reLet', corp:false, agent:'10012',
   sub:'ç›®é»’åŒº 1LDK ã€œÂ¥150,000', step:'naiken', age:1, stale:false,
   apps:[], dates:{naiken:'2026-02-23'}, hist:['2/21 å†…è¦‹äºˆç´„: 2/23 10:00'],
  },
  {id:'R045500', name:'ä¼Šè—¤ ç¿”å¤ª', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK Â¥155,000', step:'invoice', age:2, stale:false,
   apps:[{id:'A020', prop:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK', mgmt:'æ±æ€¥ç®¡ç†', date:'2026-02-15', status:'approved'}],
   dates:{naiken:'2026-02-14', applied:'2026-02-15', approved:'2026-02-17', paid:'2026-02-20'}, adOnly:false, taskDone:{paid:true,itsetsu:false},
   hist:['2/14 å†…è¦‹','2/15 ç”³è¾¼','2/17 å¯©æŸ»é€šé','2/20 å…¥é‡‘ç¢ºèªæ¸ˆ'],
  },
  {id:'R047800', name:'æ ªå¼ä¼šç¤¾ã‚¿ãƒŠã‚«å•†äº‹', type:'reLet', corp:true, contactName:'ç”°ä¸­ ä¸€éƒ', agent:'10008',
   sub:'æ–°å®¿åŒº äº‹å‹™æ‰€ ã€œÂ¥250,000', step:'screening', age:0, stale:false,
   apps:[
     {id:'A060', prop:'æ–°å®¿åŒºè¥¿æ–°å®¿ 30åª', mgmt:'ä¸‰è±åœ°æ‰€ç®¡ç†', date:'2026-02-22', status:'reviewing', sim:true},
     {id:'A061', prop:'æ–°å®¿åŒºæ–°å®¿ 25åª', mgmt:'æ±æ€¥ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', date:'2026-02-22', status:'reviewing', sim:true},
   ],
   dates:{naiken:'2026-02-22'}, hist:['2/22 å†…è¦‹','2/22 2ç‰©ä»¶åŒæ™‚ç”³è¾¼ï¼ˆæ³•äººï¼‰'],
  },
  {id:'R038291', name:'æ¾æœ¬ æµ©äºŒ', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸‹è°·åŒº 2K Â¥170,000', step:'prekey', age:0, stale:false,
   apps:[{id:'A040', prop:'æ¸‹è°·åŒº 2K', mgmt:'æ±äº¬å»ºç‰©ç®¡ç†', date:'2026-02-08', status:'approved'}],
   dates:{naiken:'2026-02-07', applied:'2026-02-08', approved:'2026-02-12', paid:'2026-02-17', itsetsu:'2026-02-20', chinkaku:'2026-03-01'}, adOnly:false, taskDone:{paid:true,itsetsu:true},
   hist:['2/07 å†…è¦‹','2/08 ç”³è¾¼','2/12 å¯©æŸ»é€šé','2/17 å…¥é‡‘ç¢ºèª','2/20 ITé‡èª¬å®Œäº†'],
  },
  {id:'R049001', name:'å±±å´ å¥', type:'reLet', corp:false, agent:'10023',
   sub:'æ¸¯åŒº 1K Â¥110,000 ADæ¡ˆä»¶', step:'prekey', age:1, stale:false, adOnly:true,
   apps:[{id:'A080', prop:'æ¸¯åŒº 1K', mgmt:'æ±äº¬å»ºç‰©ç®¡ç†', date:'2026-02-21', status:'approved'}],
   dates:{naiken:'2026-02-20', applied:'2026-02-21', approved:'2026-02-22'}, taskDone:{paid:false,itsetsu:false},
   hist:['2/20 å†…è¦‹','2/21 ç”³è¾¼','2/22 å¯©æŸ»é€šéï¼ˆADæ¡ˆä»¶ï¼‰'],
  },
  {id:'R040011', name:'ä¸­æ‘ ç”±ç¾', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸¯åŒº 1R Â¥95,000', step:'done', age:0, stale:false,
   apps:[{id:'A050', prop:'æ¸¯åŒº 1R', mgmt:'ä½å‹ä¸å‹•ç”£ç®¡ç†', date:'2026-02-01', status:'approved'}],
   dates:{naiken:'2026-02-01', applied:'2026-02-01', approved:'2026-02-05', paid:'2026-02-10', itsetsu:'2026-02-15', chinkaku:'2026-03-01'},
   hist:['2/01 å†…è¦‹ãƒ»ç”³è¾¼','2/05 å¯©æŸ»é€šé','2/10 å…¥é‡‘','2/15 é‡èª¬','2/18 éµæ¸¡ã—å®Œäº†'],
  },
  {id:'R046001', name:'åŠ è—¤ ç¾å’²', type:'reLet', corp:false, agent:'10008',
   sub:'æ¸¯åŒºå—é’å±± 1LDK Â¥180,000', step:'cancel', age:0, stale:false,
   apps:[{id:'A030', prop:'æ¸¯åŒºå—é’å±± 1LDK', mgmt:'ä½å‹ä¸å‹•ç”£ç®¡ç†', date:'2026-02-10', status:'cancelled'}],
   dates:{naiken:'2026-02-09'}, hist:['2/09 å†…è¦‹','2/10 ç”³è¾¼','2/14 å¯©æŸ»é€šé','2/21 ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæœ¬äººéƒ½åˆï¼‰'],
  },
  {id:'S819204', name:'å‰ç”° å¤§è¼”', type:'reSale', corp:false, agent:'10008',
   sub:'ç›®é»’åŒº æˆ¸å»ºã¦ 3,200ä¸‡', step:'contract', age:5, stale:false,
   apps:[], dates:{offer:'2026-02-15', contract:'2026-02-20', settlement:'2026-03-15'},
   hist:['2/15 è²·ä»˜å—é ˜','2/20 å£²è²·å¥‘ç´„ç· çµ'],
  },
];

let cur = null; // current case id

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stageOf(c) {
  const step = c.step;
  if (step==='done') return 'done';
  if (step==='cancel') return 'cancel';
  if (step==='naiken') return 'naiken';
  if (step==='apply'||step==='screening') return 'apply';
  if (step==='payment') return 'payment';
  if (step==='invoice'||step==='prekey'||step==='itsetsu'||step==='key'||step==='contract') return 'contract';
  if (step==='offer') return 'apply';
  return 'new';
}

function render() {
  const tf = document.getElementById('f-type').value;
  const af = document.getElementById('f-agent').value;
  let cs = CASES;
  if (tf) cs = cs.filter(c=>c.type===tf);
  if (af) cs = cs.filter(c=>c.agent===af);

  const board = document.getElementById('board');
  board.innerHTML = STAGES.map(st=>{
    const cols = cs.filter(c=>stageOf(c)===st.id);
    const canAdd = st.id!=='done'&&st.id!=='cancel';
    return '<div class="col">'
      +'<div class="col-hdr">'
      +'<div class="col-title"><div class="col-dot" style="background:'+st.dot+'"></div>'+st.label+'</div>'
      +'<span class="col-count" style="background:'+st.dot+'22;color:'+st.color+';border:1px solid '+st.dot+'55">'+cols.length+'</span>'
      +'</div>'
      +'<div class="col-body">'
      +cols.map(c=>cardHTML(c,st)).join('')
      +(canAdd?'<div class="add-row" onclick="openNewModal(\''+st.id+'\')">ï¼‹</div>':'')
      +'</div></div>';
  }).join('');

  document.getElementById('board-count').textContent = cs.length+' / '+CASES.length+' ä»¶';
}

function cardHTML(c, st) {
  const isCur = c.id===cur;
  const pendingApps = (c.apps||[]).filter(a=>a.status==='reviewing'||a.status==='submitted').length;
  const rejApps     = (c.apps||[]).filter(a=>a.status==='rejected').length;

  let badge = '';
  if (c.corp) badge += '<span class="pill pill-purple" style="font-size:7px">æ³•äºº</span> ';
  if (pendingApps>1) badge += '<span class="pill pill-orange" style="font-size:7px">åŒæ™‚'+pendingApps+'ä»¶</span>';
  if (rejApps>0 && c.step==='screening') badge += ' <span class="pill pill-red" style="font-size:7px">è½ã¡'+rejApps+'</span>';

  const ageEl = c.age===0
    ? '<span class="age" style="background:rgba(52,211,153,.1);color:var(--green)">æœ¬æ—¥</span>'
    : c.age>=7
    ? '<span class="age" style="background:rgba(248,113,113,.1);color:var(--red)">'+c.age+'æ—¥å‰</span>'
    : '<span class="age" style="background:rgba(74,82,112,.15);color:var(--sub)">'+c.age+'æ—¥å‰</span>';

  const typeEl = c.type==='reLet'?'ğŸ  è³ƒè²¸':c.type==='reSale'?'ğŸ¢ å£²è²·':'ğŸ‘¥ äººæ';

  return '<div class="card'+(isCur?' active':'')+'" onclick="open_case(\''+c.id+'\')">'
    +(c.stale?'<div class="stale"></div>':'')
    +'<div class="card-type" style="color:'+st.color+'">'+typeEl+(badge?' '+badge:'')+'</div>'
    +'<div class="card-name">'+c.name+'</div>'
    +'<div class="card-sub">'+c.sub+'</div>'
    +'<div class="card-foot"><span class="card-id">'+c.id+'</span>'+ageEl+'</div>'
    +'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function open_case(id) {
  cur = id;
  const c = CASES.find(x=>x.id===id);
  if(!c) return;

  document.getElementById('panel').classList.add('open');

  // Header
  const corpBadge = c.corp ? ' <span class="pill pill-purple">æ³•äºº</span>' : '';
  document.getElementById('panel-top').innerHTML =
    '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px">'
    +'<div>'
    +'<div style="font-family:\'DM Mono\',monospace;font-size:10px;color:var(--muted);margin-bottom:2px">'+c.id+'</div>'
    +'<div style="font-size:16px;font-weight:800">'+c.name+corpBadge+'</div>'
    +(c.corp&&c.contactName?'<div style="font-size:11px;color:var(--sub);margin-top:1px">æ‹…å½“: '+c.contactName+'</div>':'')
    +'<div style="font-size:11px;color:var(--muted);margin-top:2px">'+c.sub+'</div>'
    +'</div>'
    +'<button class="btn btn-ghost btn-sm" onclick="close_panel()">âœ•</button>'
    +'</div>'
    + buildStepBar(c);

  buildStepContent(c);
  render();
}

function close_panel() {
  cur = null;
  document.getElementById('panel').classList.remove('open');
  render();
}

function buildStepBar(c) {
  const steps = c.type==='reLet' ? STEPS_RELET : c.type==='reSale' ? STEPS_RESALE : [];
  if (!steps.length) return '';
  const curIdx = steps.findIndex(s=>s.id===c.step);

  return '<div class="step-bar">'
    +steps.map((s,i)=>{
      const cls = i<curIdx?'done':i===curIdx?'active':'future';
      const inner = i<curIdx ? 'âœ“' : s.icon;
      return '<div class="step-node '+cls+'" onclick="jumpStep(\''+c.id+'\',\''+s.id+'\')">'
        +'<div class="step-circle">'+inner+'</div>'
        +'<div class="step-label">'+s.label+'</div>'
        +'</div>';
    }).join('')
    +'</div>';
}

function buildStepContent(c) {
  const body = document.getElementById('panel-body');

  if (c.step==='done') {
    body.innerHTML = '<div class="done-card"><div class="done-icon">ğŸ‰</div>'
      +'<div class="done-title">æˆç´„å®Œäº†</div>'
      +'<div style="font-size:11px;color:var(--sub);margin-top:6px">'+(c.dates.chinkaku||'')+'</div>'
      +'</div>'+histHTML(c);
    return;
  }
  if (c.step==='cancel') {
    body.innerHTML = '<div class="cancel-card"><div style="font-size:32px">ğŸš«</div>'
      +'<div style="font-weight:700;margin-top:4px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div></div>'+histHTML(c)
      +'<div style="margin-top:12px"><button class="btn btn-ghost btn-sm" onclick="reactivate(\''+c.id+'\')">â†© å†é–‹</button></div>';
    return;
  }

  let html = '<div class="step-content">';

  // â”€â”€ è³ƒè²¸ãƒ•ãƒ­ãƒ¼ â”€â”€
  if (c.type==='reLet') {
    if (c.step==='naiken') html += stepNaiken(c);
    else if (c.step==='apply') html += stepApply(c);
    else if (c.step==='screening') html += stepScreening(c);
    else if (c.step==='invoice') html += stepInvoice(c);
    else if (c.step==='prekey') html += stepPrekey(c);
    else if (c.step==='payment') html += stepPayment(c);
    else if (c.step==='itsetsu') html += stepPrekey(c);
    else if (c.step==='key') html += stepKey(c);
  }
  // â”€â”€ å£²è²·ãƒ•ãƒ­ãƒ¼ â”€â”€
  else if (c.type==='reSale') {
    if (c.step==='offer') html += stepOffer(c);
    else if (c.step==='contract') html += stepSaleContract(c);
    else if (c.step==='payment') html += stepSettlement(c);
  }

  html += '</div>';

  // è¤‡æ•°ç”³è¾¼ãƒªã‚¹ãƒˆï¼ˆscreeningæ™‚ï¼‰
  if (c.step==='screening' && c.apps.length>0) {
    html += '<div style="margin-top:12px">'+appsHTML(c)+'</div>';
  }

  html += histHTML(c);

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
  html += '<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">'
    +'<button class="btn btn-red btn-sm" onclick="cancelCase(\''+c.id+'\')">ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
    +'</div>';

  body.innerHTML = html;
}

// â”€â”€ STEP RENDERERS â”€â”€

function stepNaiken(c) {
  const today = new Date().toISOString().slice(0,10);
  const dateVal = c.dates.naiken || today;
  return '<div class="step-title">ğŸ  å†…è¦‹</div>'
    +'<div class="fi"><label>å†…è¦‹æ—¥</label><input type="date" id="s-naiken-date" class="mono" value="'+dateVal+'"></div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-naiken-prop" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 1LDK" value="'+(c.dates.naikenProp||'')+'"></div>'
    +'<div class="row" style="margin-top:14px">'
    +'<button class="btn btn-green" onclick="naikenDone(\''+c.id+'\')">âœ“ å†…è¦‹å®Œäº† â†’ ç”³è¾¼ã¸</button>'
    +'<button class="btn btn-red" onclick="naikenSkip(\''+c.id+'\')">è¦‹é€ã‚Š</button>'
    +'</div>';
}

function stepApply(c) {
  const today = new Date().toISOString().slice(0,10);
  return '<div class="step-title">ğŸ“‹ ç”³è¾¼</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-prop" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 1LDK"></div>'
    +'<div class="fi"><label>ç®¡ç†ä¼šç¤¾</label><input type="text" id="s-mgmt" placeholder="ã€‡ã€‡ç®¡ç†æ ªå¼ä¼šç¤¾"></div>'
    +'<div class="fi"><label>ç”³è¾¼æ—¥</label><input type="date" id="s-apply-date" class="mono" value="'+today+'"></div>'
    +'<button class="btn btn-green" style="width:100%;justify-content:center;margin-top:14px" onclick="submitApply(\''+c.id+'\')">ç”³è¾¼æ¸ˆã¿ã«ã™ã‚‹ â†’</button>';
}

function stepScreening(c) {
  const activeApps = c.apps.filter(a=>a.status==='reviewing'||a.status==='submitted');
  const rejApps    = c.apps.filter(a=>a.status==='rejected');

  let html = '<div class="step-title">â³ å¯©æŸ»ä¸­</div>';

  if (activeApps.length===0 && rejApps.length>0) {
    html += '<div style="background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:8px;padding:10px;margin-bottom:12px;font-size:11px;color:var(--red)">å…¨ç‰©ä»¶ã§å¯©æŸ»è½ã¡</div>';
    html += '<button class="btn btn-blue" style="width:100%;justify-content:center" onclick="addApp(\''+c.id+'\')">ï¼‹ åˆ¥ç‰©ä»¶ã§å†ç”³è¾¼</button>';
    return html;
  }

  html += activeApps.map(a=>
    '<div class="app-item active-app" style="margin-bottom:8px">'
    +'<div class="app-name"><span>'+a.prop+'</span>'+(a.sim?'<span class="pill pill-orange">åŒæ™‚</span>':'')+'</div>'
    +'<div style="display:flex;gap:6px;margin-top:8px">'
    +'<button class="btn btn-green btn-sm" onclick="appPassed(\''+c.id+'\',\''+a.id+'\')">å¯©æŸ»é€šé â†’</button>'
    +'<button class="btn btn-red btn-sm" onclick="appRejected(\''+c.id+'\',\''+a.id+'\')">è½ã¡</button>'
    +'</div></div>'
  ).join('');

  html += '<button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;margin-top:4px" onclick="addApp(\''+c.id+'\')">ï¼‹ è¿½åŠ ç”³è¾¼</button>';
  return html;
}

function stepInvoice(c) {
  const app = c.apps.find(a=>a.status==='approved') || c.apps[c.apps.length-1] || {};
  const now = new Date();
  const due = new Date(now.getTime()+30*864e5).toISOString().slice(0,10);
  const invNum = 'INV-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+'-'+c.agent;
  const rentMatch = (c.sub||'').match(/\xA5([\d,]+)/);
  const rentGuess = rentMatch ? rentMatch[1].replace(/,/g,'') : '';
  const inv = c.invoice || {};
  const prevRent   = inv.rent   || rentGuess;
  const prevType   = inv.type   || 'commission';
  const prevFmt    = inv.adFmt  || null;
  const prevItems  = inv.items  || [{desc:'\u4ECB\u4EE3\u624B\u6570\u6599',amt:''}];
  const prevAdAmt  = inv.adAmt  || '';
  const prevReason = inv.underReason || '';
  const id = c.id;

  const tabs = [
    {v:'commission', label:'\u4ECB\u4EE3\u624B\u6570\u6599\u306E\u307F'},
    {v:'ad_plus',    label:'AD\uff0B\u4ECB\u4EE3\u624B\u6570\u6599'},
    {v:'ad_only',    label:'AD\u306E\u307F'},
  ];
  const tabHtml = tabs.map(t=>{
    const active = prevType===t.v;
    const bg = active ? 'background:var(--gold);color:#000' : 'background:var(--card2);color:var(--sub)';
    return '<button onclick="invSetType(this)" data-cid="'+id+'" data-type="'+t.v+'" style="flex:1;padding:7px 4px;border:none;cursor:pointer;font-size:11px;font-weight:600;border-radius:6px;'+bg+'">'+t.label+'</button>';
  }).join('');

  const itemRowsHtml = prevItems.map((it,i)=>invItemRow(i,it.desc,it.amt,i===0)).join('');

  const adFmtHtml = (prevType==='ad_plus'||prevType==='ad_only') ? (
    '<div style="margin-bottom:10px;padding:12px;background:var(--card2);border:1px solid var(--border2);border-radius:8px">'
    +'<div style="font-size:11px;color:var(--sub);margin-bottom:8px;font-weight:600">\u{1F4CB} \u7BA1\u7406\u4F1A\u793E\u6307\u5B9A\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8</div>'
    +'<div style="display:flex;gap:8px">'
    +'<button onclick="invSetAdFmt(this)" data-cid="'+id+'" data-fmt="custom" style="flex:1;padding:7px;border:1px solid var(--border2);cursor:pointer;border-radius:6px;font-size:11px;font-weight:600;'+(prevFmt==='custom'?'background:var(--blue);color:#fff;border-color:var(--blue)':'background:transparent;color:var(--sub)')+'>\u3042\u308A\uff08\u6307\u5B9A\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8\uff09</button>'
    +'<button onclick="invSetAdFmt(this)" data-cid="'+id+'" data-fmt="standard" style="flex:1;padding:7px;border:1px solid var(--border2);cursor:pointer;border-radius:6px;font-size:11px;font-weight:600;'+(prevFmt==='standard'?'background:var(--green);color:#000;border-color:var(--green)':'background:transparent;color:var(--sub)')+'>\u306A\u3057\uff08CORETO\u6A19\u6E96\uff09</button>'
    +'</div></div>'
  ) : '';

  const customFmtHtml = (prevFmt==='custom') ? (
    '<div style="margin-bottom:10px">'
    +'<div class="fi"><label>AD\u91D1\u984D\uff08\u7A0E\u8FBC\uff09</label>'
    +'<input type="number" id="inv-ad-amt" class="mono" placeholder="\u4F8B: 150000" value="'+prevAdAmt+'" oninput="invCalc()" style="font-size:14px"></div>'
    +'<div style="padding:14px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:8px;font-size:11px">'
    +'<div style="color:var(--blue);font-weight:700;margin-bottom:8px">\u{1F3E6} \u632F\u8FBC\u5148\u53E3\u5EA7\uff08GMO\u30D0\u30FC\u30C1\u30E3\u30EB\u53E3\u5EA7\uff09</div>'
    +'<div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;color:var(--sub);line-height:1.8">'
    +'<span>\u9280\u884C\u540D</span><span class="mono" style="color:var(--t)">GMO\u3042\u304A\u305E\u3089\u30CD\u30C3\u30C8\u9280\u884C</span>'
    +'<span>\u652F\u5E97\u540D</span><span class="mono" style="color:var(--t)">\u6CD5\u4EBA\u55B6\u696D\u90E8\uff08003\uff09</span>'
    +'<span>\u53E3\u5EA7\u7A2E\u5225</span><span class="mono" style="color:var(--t)">\u666E\u901A</span>'
    +'<span>\u53E3\u5EA7\u756A\u53F7</span><span class="mono" style="color:var(--gold);font-size:13px;letter-spacing:.1em">'+invVirtualAcct(id)+'</span>'
    +'<span>\u53E3\u5EA7\u540D\u7FA9</span><span class="mono" style="color:var(--t)">\u30AB\uff09\u30B3\u30EC\u30C8</span>'
    +'</div>'
    +'<div style="margin-top:8px;padding:6px 8px;background:rgba(255,255,255,.03);border-radius:5px;color:var(--muted);font-size:10px">\u203B \u3053\u306E\u53E3\u5EA7\u306F\u3053\u306E\u6848\u4EF6\u5C02\u7528\u306E\u30D0\u30FC\u30C1\u30E3\u30EB\u53E3\u5EA7\u3067\u3059\u3002\u5165\u91D1\u78BA\u8A8D\u5F8C\u81EA\u52D5\u3067\u30B7\u30B9\u30C6\u30E0\u306B\u53CD\u6620\u3055\u308C\u307E\u3059\u3002</div>'
    +'</div></div>'
  ) : '';

  const showItems = prevType==='commission' || prevType==='ad_plus' || (prevType==='ad_only' && prevFmt==='standard');
  const adAmtSection = (prevType==='ad_plus' || (prevType==='ad_only' && prevFmt==='standard')) ? (
    '<div class="fi"><label>AD\u91D1\u984D\uff08\u7BA1\u7406\u4F1A\u793E\u3088\u308A\u53D7\u9818\u30FB\u7A0E\u8FBC\uff09</label>'
    +'<input type="number" id="inv-ad-amt" class="mono" placeholder="\u4F8B: 150000" value="'+prevAdAmt+'" oninput="invCalc()" style="font-size:14px"></div>'
  ) : '';

  return '<div class="step-title">\u{1F9FE} \u8ACB\u6C42\u66F8\u767A\u884C</div>'
    +'<div style="display:flex;gap:6px;margin-bottom:12px;background:var(--card2);padding:4px;border-radius:8px">'+tabHtml+'</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px">'
    +'<div class="fi"><label>\u8ACB\u6C42\u66F8\u756A\u53F7</label>'
    +'<input type="text" class="mono" value="'+invNum+'" readonly style="color:var(--muted);font-size:11px;background:rgba(255,255,255,.02);cursor:not-allowed"></div>'
    +'<div class="fi"><label>\u7269\u4EF6\u540D</label><input type="text" id="inv-prop" value="'+(app.prop||'')+'" oninput="invCalc()"></div>'
    +'</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">'
    +'<div class="fi"><label>\u767A\u884C\u65E5</label><input type="date" id="inv-date" class="mono" value="'+now.toISOString().slice(0,10)+'"></div>'
    +'<div class="fi"><label>\u652F\u6255\u671F\u9650</label><input type="date" id="inv-due" class="mono" value="'+due+'"></div>'
    +'</div>'
    +'<div class="fi"><label>\u5BB6\u8CE3\uff08\u6708\u984D\u30FB\u7A0E\u8FBC\uff09<span style="color:var(--muted);font-size:10px;margin-left:6px">\u4E0A\u9650\u8A08\u7B97\u306E\u57FA\u6E96\u984D</span></label>'
    +'<input type="number" id="inv-rent" class="mono" placeholder="\u4F8B: 150000" value="'+prevRent+'" oninput="invCalc()" style="font-size:13px"></div>'
    +adFmtHtml
    +customFmtHtml
    +(showItems ? (
      '<div style="margin:10px 0 4px;font-size:11px;color:var(--sub);font-weight:600;letter-spacing:.05em">\u8ACB\u6C42\u9805\u76EE<span style="color:var(--muted);font-weight:400;margin-left:6px;font-size:10px">1\u884C\u76EE\u306E\u4ECB\u4EE3\u624B\u6570\u6599\u306E\u307F\u5B85\u5EFA\u696D\u6CD5\u4E0A\u9650\u30C1\u30A7\u30C3\u30AF\u5BFE\u8C61</span></div>'
      +'<div id="inv-items">'+itemRowsHtml+'</div>'
      +'<button onclick="invAddItem()" style="width:100%;background:transparent;border:1px dashed var(--border2);color:var(--sub);padding:7px;border-radius:7px;cursor:pointer;font-size:11px;margin-bottom:8px">\uff0B \u9805\u76EE\u3092\u8FFD\u52A0</button>'
      +adAmtSection
    ) : '')
    +'<div id="inv-validation" style="margin-bottom:8px"></div>'
    +'<div id="inv-reason-wrap" style="display:none;margin-bottom:10px">'
    +'<div class="fi"><label style="color:var(--orange)">\u26A0 \u5408\u8A08\u304C\u5BB6\u8CE31\u30F6\u6708\u5206\u672A\u6E80 \u2014 \u7406\u7531\u3092\u8A18\u5165\u3057\u3066\u304F\u3060\u3055\u3044</label>'
    +'<textarea id="inv-reason" rows="2" placeholder="\u4F8B: \u30AF\u30E9\u30A4\u30A2\u30F3\u30C8\u4EA4\u6E09\u306E\u7D50\u679C\u3001\u624B\u6570\u6599\u3092\u6E1B\u984D\u3002\u5165\u5C45\u7387\u512A\u5148\u306E\u305F\u3081\u3002" style="font-size:12px;resize:vertical">'+prevReason+'</textarea></div>'
    +'</div>'
    +'<button class="btn btn-gold" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="issueInvoice(this.dataset.cid)">\u{1F4C4} \u8ACB\u6C42\u66F8\u767A\u884C \u2192 \u91CD\u8AAC\u30FB\u5165\u91D1\u3078</button>';
}

function invVirtualAcct(caseId) {
  let h=0;
  for(let i=0;i<caseId.length;i++) h=((h<<5)-h)+caseId.charCodeAt(i);
  return String(Math.abs(h)%9000000+1000000);
}

function invSetType(btn) {
  const id = btn.dataset.cid;
  const type = btn.dataset.type;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.type = type;
  if(type==='commission'||type==='ad_plus') {
    if(!c.invoice.items||c.invoice.items.length===0) c.invoice.items=[{desc:'\u4ECB\u4EE3\u624B\u6570\u6599',amt:''}];
    else { const it=c.invoice.items[0]; it.desc='\u4ECB\u4EE3\u624B\u6570\u6599'; }
  }
  if(type==='ad_only') {
    c.invoice.items=[{desc:'AD\u624B\u6570\u6599',amt:''}];
    c.invoice.adFmt=null;
  }
  c.adOnly=(type==='ad_only'||type==='ad_plus');
  open_case(id);
}

function invSetAdFmt(btn) {
  const id  = btn.dataset.cid;
  const fmt = btn.dataset.fmt;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.adFmt = fmt;
  open_case(id);
}

function invItemRow(idx, desc, amt, isFirst) {
  return '<div class="inv-row" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr auto auto;gap:6px;margin-bottom:6px;align-items:center">'
    +'<input type="text" placeholder="\u9805\u76EE\u540D" value="'+desc+'" oninput="invCalc()"'+(isFirst?' style="font-size:12px;color:var(--gold)"':' style="font-size:12px"')+'>'
    +'<input type="number" placeholder="\u91D1\u984D" value="'+amt+'" oninput="invCalc()" class="mono" style="width:120px;font-size:13px">'
    +(isFirst
      ? '<div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:var(--gold);font-size:14px" title="\u4ECB\u4EE3\u624B\u6570\u6599\uff081.1\u30F6\u6708\u4E0A\u9650\u30C1\u30A7\u30C3\u30AF\u5BFE\u8C61\uff09">\u2605</div>'
      : '<button onclick="invRemoveItem('+idx+')" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0;line-height:1">\xD7</button>')
    +'</div>';
}

let _invItemCount=1;
function invAddItem() {
  const wrap=document.getElementById('inv-items'); if(!wrap) return;
  const idx=_invItemCount++;
  const div=document.createElement('div');
  div.innerHTML=invItemRow(idx,'','',false);
  wrap.appendChild(div.firstChild);
  invCalc();
}
function invRemoveItem(idx) {
  document.querySelectorAll('#inv-items .inv-row').forEach(r=>{
    if(parseInt(r.dataset.idx)===idx) r.remove();
  });
  invCalc();
}
function invGetItems() {
  const rows=document.querySelectorAll('#inv-items .inv-row');
  const items=[];
  rows.forEach(r=>{
    const inputs=r.querySelectorAll('input');
    const desc=inputs[0]?.value.trim()||'';
    const amt=parseInt(inputs[1]?.value)||0;
    if(desc||amt) items.push({desc,amt});
  });
  return items;
}
function invCalc() {
  const rent=parseInt(document.getElementById('inv-rent')?.value)||0;
  const items=invGetItems();
  const commAmt=items.length>0?items[0].amt:0;
  const totalItems=items.reduce((s,it)=>s+it.amt,0);
  const adAmt=parseInt(document.getElementById('inv-ad-amt')?.value)||0;
  const grandTotal=totalItems+adAmt;
  const limit11=Math.round(rent*1.1);
  const limit10=rent;
  let html='';
  if(rent>0&&(totalItems>0||adAmt>0)){
    html+='<div style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:12px">';
    if(totalItems>0){html+='<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--sub)">\u8ACB\u6C42\u9805\u76EE\u5408\u8A08</span><span class="mono">\xA5'+totalItems.toLocaleString()+'</span></div>';}
    if(adAmt>0){html+='<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--sub)">AD\u91D1\u984D</span><span class="mono">\xA5'+adAmt.toLocaleString()+'</span></div>';}
    if(adAmt>0&&totalItems>0){html+='<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px;display:flex;justify-content:space-between"><span style="color:var(--sub);font-weight:600">\u5408\u8A08</span><span class="mono" style="color:var(--gold);font-size:13px">\xA5'+grandTotal.toLocaleString()+'</span></div>';}
    if(commAmt>0){
      if(commAmt>limit11){html+='<div style="margin-top:6px;padding:6px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px">\u26D4 \u4ECB\u4EE3\u624B\u6570\u6599\uff08\xA5'+commAmt.toLocaleString()+'\uff09\u304C\u5BB6\u8CE3\xD71.1\uff08\xA5'+limit11.toLocaleString()+'\uff09\u3092\u8D85\u904E \u2014 \u5B85\u5EFA\u696D\u6CD5\u9055\u53CD</div>';}
      else{html+='<div style="margin-top:6px;padding:5px 10px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);border-radius:6px;color:var(--green);font-size:11px">\u2705 \u4ECB\u4EE3\u624B\u6570\u6599 \xA5'+commAmt.toLocaleString()+' \uff0F \u4E0A\u9650 \xA5'+limit11.toLocaleString()+'\uff08\xD71.1\uff09 \u2014 \u9069\u6B63</div>';}
    }
    const checkAmt=grandTotal>0?grandTotal:totalItems;
    if(checkAmt>0){
      if(checkAmt>=limit10){html+='<div style="margin-top:5px;padding:5px 10px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:6px;color:var(--blue);font-size:11px">\u{1F4B0} \u5408\u8A08 \xA5'+checkAmt.toLocaleString()+' \u2265 \u5BB6\u8CE31\u30F6\u6708\uff08\xA5'+limit10.toLocaleString()+'\uff09 \u2014 \u9069\u6B63</div>';}
      else{html+='<div style="margin-top:5px;padding:5px 10px;background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.4);border-radius:6px;color:var(--orange);font-size:11px">\u26A0 \u5408\u8A08 \xA5'+checkAmt.toLocaleString()+' \u304C\u5BB6\u8CE31\u30F6\u6708\uff08\xA5'+limit10.toLocaleString()+'\uff09\u672A\u6E80</div>';}
      const rw=document.getElementById('inv-reason-wrap');
      if(rw) rw.style.display=(checkAmt<limit10)?'block':'none';
    }
    html+='</div>';
  }
  const vp=document.getElementById('inv-validation');
  if(vp) vp.innerHTML=html;
}
setTimeout(()=>{invCalc();_invItemCount=document.querySelectorAll('#inv-items .inv-row').length;},100);

function issueInvoice(id) {
  const c=CASES.find(x=>x.id===id); if(!c) return;
  const inv=c.invoice||{};
  const type=inv.type||'commission';
  const adFmt=inv.adFmt||null;
  const prop=document.getElementById('inv-prop')?.value.trim();
  const rent=parseInt(document.getElementById('inv-rent')?.value)||0;
  const date=document.getElementById('inv-date')?.value;
  const due =document.getElementById('inv-due')?.value;
  const reason=document.getElementById('inv-reason')?.value.trim()||'';
  if(!prop){alert('\u7269\u4EF6\u540D\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044');return;}
  if((type==='ad_only'||type==='ad_plus')&&adFmt==='custom'){
    const adAmt=parseInt(document.getElementById('inv-ad-amt')?.value)||0;
    if(!adAmt){alert('AD\u91D1\u984D\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044');return;}
    c.adOnly=true;
    c.invoice=Object.assign(inv,{type,adFmt,adAmt,prop,rent,date,due,issued:true,grandTotal:adAmt});
    c.hist.unshift(today()+' AD\u8ACB\u6C42\uff08\u6307\u5B9A\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8\uff09\xA5'+adAmt.toLocaleString()+' \u53E3\u5EA7\u60C5\u5831\u63D0\u793A');
    advance(id,'prekey','invoiced',date,'AD\u8ACB\u6C42\u66F8\uff08\u6307\u5B9A\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8\uff09\u767A\u884C');
    return;
  }
  const items=invGetItems();
  const commAmt=items.length>0?items[0].amt:0;
  const totalItems=items.reduce((s,it)=>s+it.amt,0);
  const adAmt=parseInt(document.getElementById('inv-ad-amt')?.value)||0;
  const grandTotal=totalItems+adAmt;
  if(items.length===0||totalItems===0){alert('\u8ACB\u6C42\u9805\u76EE\u3068\u91D1\u984D\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044');return;}
  if(rent>0&&commAmt>Math.round(rent*1.1)){alert('\u4ECB\u4EE3\u624B\u6570\u6599\uff08\xA5'+commAmt.toLocaleString()+'\uff09\u304C\u4E0A\u9650\uff08\xA5'+Math.round(rent*1.1).toLocaleString()+'\uff09\u3092\u8D85\u904E\u3057\u3066\u3044\u307E\u3059\u3002');return;}
  if(rent>0&&grandTotal<rent&&!reason){alert('\u5408\u8A08\u304C\u5BB6\u8CE31\u30F6\u6708\u5206\u672A\u6E80\u306E\u305F\u3081\u7406\u7531\u306E\u8A18\u5165\u304C\u5FC5\u8981\u3067\u3059\u3002');return;}
  c.adOnly=(type==='ad_only'||type==='ad_plus');
  c.invoice=Object.assign(inv,{type,adFmt,items,commAmt,totalItems,adAmt,grandTotal,rent,prop,date,due,underReason:reason,issued:true});
  const adLabel=adAmt>0?' AD\xA5'+adAmt.toLocaleString():'';
  c.hist.unshift(today()+' \u8ACB\u6C42\u66F8\u767A\u884C \u5408\u8A08\xA5'+grandTotal.toLocaleString()+adLabel);
  advance(id,'prekey','invoiced',date,'\u8ACB\u6C42\u66F8\u767A\u884C\u5B8C\u4E86');
}


function paymentCheck(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.taskDone) c.taskDone={};
  c.taskDone.paid = true;
  c.dates.paid = todayISO();
  c.hist.unshift(today()+' å…¥é‡‘ç¢ºèªæ¸ˆ');
  // If both done, auto-advance step display
  open_case(id); toast('å…¥é‡‘ç¢ºèªã—ã¾ã—ãŸ');
}
function itsetsuCheck(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.taskDone) c.taskDone={};
  c.taskDone.itsetsu = true;
  c.dates.itsetsu = todayISO();
  c.hist.unshift(today()+' ITé‡èª¬å®Œäº†');
  open_case(id); toast('é‡èª¬å®Œäº†ã—ã¾ã—ãŸ');
}


function keyDone(id) {
  const d = document.getElementById('s-chinkaku')?.value || todayISO();
  const c = CASES.find(x=>x.id===id);
  c.dates.chinkaku = d;
  advance(id,'done',null,null,'éµæ¸¡ã—å®Œäº† (è³ƒç™ºæ—¥: '+d+') â†’ æˆç´„');
}

// å£²è²·
function offerDone(id) {
  const prop = document.getElementById('s-sale-prop')?.value.trim()||'';
  const d    = document.getElementById('s-offer-date')?.value||todayISO();
  if(prop){const c=CASES.find(x=>x.id===id);c.dates.naikenProp=prop;}
  advance(id,'contract','offer',d,'è²·ä»˜å—é ˜â†’å¥‘ç´„ã¸');
}
function saleContractDone(id) { advance(id,'payment','contract',todayISO(),'å£²è²·å¥‘ç´„ç· çµ'); }
function settlementDone(id) {
  const d = document.getElementById('s-settlement')?.value||todayISO();
  advance(id,'done','settlement',d,'æ±ºæ¸ˆå®Œäº† (æ±ºæ¸ˆæ—¥: '+d+') â†’ æˆç´„');
}

function cancelCase(id) {
  if(!confirm('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  advance(id,'cancel',null,null,'ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
}
function reactivate(id) {
  const c = CASES.find(x=>x.id===id);
  c.step='naiken'; c.hist.unshift(today()+' æ¡ˆä»¶å†é–‹');
  open_case(id);
}

function jumpStep(id, stepId) {
  const c = CASES.find(x=>x.id===id);
  if(!c) return;
  const steps = c.type==='reLet'?STEPS_RELET:STEPS_RESALE;
  const valid = steps.map(s=>s.id);
  if(!valid.includes(stepId)) return;
  c.step = stepId;
  open_case(id);
}

function addMemo(id) {
  const inp = document.getElementById('memo-inp');
  const txt = inp?.value.trim();
  if(!txt) return;
  const c = CASES.find(x=>x.id===id);
  c.hist.unshift(today()+' '+txt);
  inp.value='';
  buildStepContent(c);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW CASE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _corpMode = false;

function openNewModal(stageHint) {
  _corpMode = false;
  openModal(
    'ï¼‹ æ–°è¦æ¡ˆä»¶'
    +'<div style="display:flex;gap:6px;margin-bottom:10px">'
    +'<button id="ct-ind" class="btn btn-ghost btn-sm" style="flex:1;border-color:var(--gold);color:var(--gold)" onclick="setCorp(false)">ğŸ‘¤ å€‹äºº</button>'
    +'<button id="ct-corp" class="btn btn-ghost btn-sm" style="flex:1" onclick="setCorp(true)">ğŸ¢ æ³•äºº</button>'
    +'</div>'
    +'<div class="fi"><label id="nc-name-lbl">æ°å</label><input type="text" id="nc-name" placeholder="ç”°ä¸­ å¤ªéƒ"></div>'
    +'<div id="nc-corp-ext" style="display:none"><div class="fi"><label>æ‹…å½“è€…å</label><input type="text" id="nc-contact" placeholder="ç”°ä¸­ ä¸€éƒ"></div></div>'
    +'<div class="fi"><label>ç¨®åˆ¥</label><select id="nc-type"><option value="reLet">ğŸ  è³ƒè²¸</option><option value="reSale">ğŸ¢ å£²è²·</option><option value="hr">ğŸ‘¥ äººæ</option></select></div>'
    +'<div class="fi"><label>å¸Œæœ›æ¡ä»¶</label><input type="text" id="nc-sub" placeholder="æ¸‹è°·åŒº 1LDK ã€œÂ¥150,000"></div>'
    +'<div class="row" style="margin-top:14px"><button class="btn btn-ghost" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
    +'<button class="btn btn-gold" style="flex:2;justify-content:center" onclick="createCase()">ç™»éŒ²</button></div>'
  );
}

function setCorp(flag) {
  _corpMode = flag;
  const ind  = document.getElementById('ct-ind');
  const corp = document.getElementById('ct-corp');
  const ext  = document.getElementById('nc-corp-ext');
  const lbl  = document.getElementById('nc-name-lbl');
  const inp  = document.getElementById('nc-name');
  if(flag) {
    corp.style.borderColor='var(--purple)'; corp.style.color='var(--purple)';
    ind.style.borderColor=''; ind.style.color='';
    ext.style.display='block'; lbl.textContent='æ³•äººå'; inp.placeholder='æ ªå¼ä¼šç¤¾ã€‡ã€‡';
  } else {
    ind.style.borderColor='var(--gold)'; ind.style.color='var(--gold)';
    corp.style.borderColor=''; corp.style.color='';
    ext.style.display='none'; lbl.textContent='æ°å'; inp.placeholder='ç”°ä¸­ å¤ªéƒ';
  }
}

function createCase() {
  const name = document.getElementById('nc-name')?.value.trim();
  if(!name){alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const contact = document.getElementById('nc-contact')?.value.trim()||'';
  if(_corpMode&&!contact){alert('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const type = document.getElementById('nc-type')?.value;
  const sub  = document.getElementById('nc-sub')?.value.trim()||'â€”';
  const prefix = type==='reLet'?'R':type==='reSale'?'S':'H';
  const id = prefix+String(Math.floor(Math.random()*90000+10000));
  const initStep = type==='reLet'?'naiken':type==='reSale'?'offer':'new';
  const obj = {id, name, type, corp:_corpMode, agent:'10012', sub, step:initStep, age:0, stale:false, adOnly:false, taskDone:{paid:false,itsetsu:false}, apps:[], dates:{}, hist:[today()+' æ¡ˆä»¶ç™»éŒ²']};
  if(_corpMode&&contact) obj.contactName = contact;
  CASES.unshift(obj);
  closeModal();
  render();
  open_case(id);
  toast('æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(inner) {
  document.getElementById('modal-box').innerHTML = inner;
  document.getElementById('overlay').classList.add('on');
}

function closeModal() { document.getElementById('overlay').classList.remove('on'); }
document.getElementById('overlay').addEventListener('click', e=>{if(e.target.id==='overlay')closeModal();});

function toast(msg) {
  const t=document.getElementById('toast');
  t.textContent='âœ“ '+msg; t.style.display='block';
  clearTimeout(t._t); t._t=setTimeout(()=>t.style.display='none',2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();
</script>
</body>
</html>
