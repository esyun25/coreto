<!DOC
  {id:'N001001', name:'æ ªå¼ä¼šç¤¾ã‚¢ãƒ«ãƒ•ã‚¡ä¸å‹•ç”£', type:'sannai', corp:true, contactName:'å±±ç”° èª²é•·', agent:'10008',
   sub:'ä¸–ç”°è°·åŒº ä¸€æ£Ÿãƒãƒ³ã‚·ãƒ§ãƒ³ Â¥180,000,000', step:'verify', age:1, stale:false,
   salePrice:180000000,
   sannai:{buyPrice:165000000, sellPrice:180000000, commPayMode:'both',
     commBuyCo:'æ±æ€¥ãƒªãƒãƒ–ãƒ«', commBuyAmt:3300000,
     commSellCo:'ä½å‹ä¸å‹•ç”£è²©å£²', commSellAmt:2200000,
     delegPay:[{co:'ã‚³ãƒ³ã‚µãƒ«æ ªå¼ä¼šç¤¾', type:'other', amt:550000}]},
   buyer:{name:'æœ‰é™ä¼šç¤¾ãƒ™ãƒ¼ã‚¿é–‹ç™º', takkenNum:'æ±äº¬éƒ½çŸ¥äº‹ï¼ˆ3ï¼‰ç¬¬12345å·', verified:false,
     verifyState:'pending', pendingCode:'K7X9QM'},
   apps:[], dates:{naiken:'2026-02-21'},
   hist:['2/21 å†…è¦‹å®Œäº†','2/22 æ¥­è€…ç¢ºèªä¾é ¼é€ä¿¡ / æœ‰é™ä¼šç¤¾ãƒ™ãƒ¼ã‚¿é–‹ç™º (æ±äº¬éƒ½çŸ¥äº‹ï¼ˆ3ï¼‰ç¬¬12345å·)'],
  },
  {id:'N002002', name:'åˆåŒä¼šç¤¾ã‚µã‚¯ãƒ©æŠ•è³‡', type:'sannai', corp:true, contactName:'ä½è—¤ éƒ¨é•·', agent:'10012',
   sub:'ç›®é»’åŒº åŒºåˆ†ãƒãƒ³ã‚·ãƒ§ãƒ³ Â¥45,000,000', step:'naiken', age:0, stale:false,
   salePrice:45000000,
   apps:[], dates:{naiken:'2026-02-23'},
   hist:['2/23 å†…è¦‹äºˆå®š'],
  },TYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORETO â€” æ¡ˆä»¶ç®¡ç†</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--card:#0f1119;--card2:#141720;--border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--gold-dim:#7a5f22;--gold-glow:rgba(201,168,76,.1);
  --blue:#4f9cf9;--green:#34d399;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;
  --muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;
}
html,body{height:100%;font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);overflow:hidden}

/* â”€â”€ Layout â”€â”€ */
.layout{display:flex;flex-direction:column;height:100vh}
.hdr{height:52px;display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;border-bottom:1px solid var(--border);background:rgba(7,9,15,.96);flex-shrink:0;z-index:50}
.logo{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;color:var(--gold);letter-spacing:3px}
.toolbar{height:44px;display:flex;align-items:center;gap:10px;padding:0 16px;
  border-bottom:1px solid var(--border);background:var(--card2);flex-shrink:0}
.main{display:flex;flex:1;overflow:hidden}

/* â”€â”€ Board â”€â”€ */
.board-wrap{flex:1;overflow-x:auto;overflow-y:hidden;display:flex}
.board{display:flex;height:100%}
.col{width:230px;flex-shrink:0;display:flex;flex-direction:column;border-right:1px solid var(--border)}
.col:last-child{border-right:none}
.col-hdr{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.col-title{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;display:flex;align-items:center;gap:7px}
.col-dot{width:7px;height:7px;border-radius:50%}
.col-count{font-size:9px;padding:1px 7px;border-radius:8px;font-weight:700}
.col-body{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:7px}

/* â”€â”€ Case cards â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:11px 12px;
  cursor:pointer;transition:.15s;position:relative}
.card:hover{border-color:var(--border2);background:#111420;transform:translateY(-1px)}
.card.active{border-color:var(--gold);background:#13110a}
.card-type{font-size:8px;font-weight:700;letter-spacing:.5px;margin-bottom:5px;display:flex;align-items:center;gap:5px}
.card-name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.card-sub{font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:6px}
.card-foot{display:flex;align-items:center;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px}
.card-id{font-family:'DM Mono',monospace;font-size:8px;color:var(--muted)}
.age{font-size:8px;padding:1px 6px;border-radius:4px;font-weight:700}
.stale{position:absolute;top:8px;right:8px;width:6px;height:6px;border-radius:50%;background:var(--red);animation:blink 2s infinite}
@keyframes blink{50%{opacity:.2}}
.add-row{padding:7px;border:1px dashed var(--border2);border-radius:8px;text-align:center;
  font-size:10px;color:var(--muted);cursor:pointer;transition:.15s}
.add-row:hover{border-color:var(--blue);color:var(--blue)}

/* â”€â”€ Detail Panel â”€â”€ */
.panel{width:0;overflow:hidden;border-left:1px solid var(--border);transition:.2s cubic-bezier(.4,0,.2,1);
  display:flex;flex-direction:column;background:var(--card);flex-shrink:0}
.panel.open{width:460px}
.panel-top{padding:16px 18px 0;flex-shrink:0}
.panel-body{flex:1;overflow-y:auto;padding:0 18px 18px}

/* â”€â”€ Step Progress â”€â”€ */
.step-bar{display:flex;align-items:center;margin:16px 0 20px}
.step-node{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;cursor:pointer}
.step-node:not(:last-child)::after{content:'';position:absolute;top:14px;left:50%;width:100%;height:1px;background:var(--border2);z-index:0}
.step-node.done::after{background:var(--green)}
.step-node.active::after{background:linear-gradient(90deg,var(--gold),var(--border2))}
.step-circle{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;border:2px solid var(--border2);background:var(--bg);
  position:relative;z-index:1;transition:.2s}
.step-node.done .step-circle{background:var(--green);border-color:var(--green);color:#0a0c10;font-size:12px}
.step-node.active .step-circle{background:var(--gold);border-color:var(--gold);color:#0a0c10;box-shadow:0 0 12px rgba(201,168,76,.4)}
.step-node.future .step-circle{color:var(--muted)}
.step-label{font-size:8px;margin-top:4px;font-weight:600;letter-spacing:.3px;white-space:nowrap}
.step-node.done .step-label{color:var(--green)}
.step-node.active .step-label{color:var(--gold)}
.step-node.future .step-label{color:var(--muted)}

/* â”€â”€ Step Content â”€â”€ */
.step-content{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:18px}
.step-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;margin-bottom:14px;
  display:flex;align-items:center;gap:8px}

/* â”€â”€ Inputs â”€â”€ */
.fi{margin-bottom:10px}
.fi label{font-size:10px;color:var(--sub);display:block;margin-bottom:3px}
.fi input,.fi select,.fi textarea{width:100%;background:#090b13;border:1px solid var(--border2);
  border-radius:7px;padding:8px 11px;color:var(--text);font-size:12px;
  font-family:'Noto Sans JP',sans-serif;outline:none;transition:border .15s}
.fi input:focus,.fi select:focus{border-color:var(--gold)}
input[type=date]{color-scheme:dark}
.mono{font-family:'DM Mono',monospace!important}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:9px 18px;border-radius:9px;font-size:12px;font-weight:700;cursor:pointer;
  font-family:'Noto Sans JP',sans-serif;transition:.15s;border:none;display:inline-flex;align-items:center;gap:7px}
.btn-green{background:var(--green);color:#0a0c10}
.btn-green:hover{background:#2ec98a;transform:translateY(-1px)}
.btn-red{background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.3)}
.btn-red:hover{background:rgba(248,113,113,.25)}
.btn-gold{background:linear-gradient(135deg,var(--gold),#a8872f);color:#0a0c10}
.btn-gold:hover{transform:translateY(-1px)}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--sub)}
.btn-ghost:hover{color:var(--text);border-color:var(--sub)}
.btn-blue{background:rgba(79,156,249,.15);color:var(--blue);border:1px solid rgba(79,156,249,.3)}
.btn-sm{padding:5px 12px;font-size:10px;border-radius:7px}
.btn-xs{padding:3px 9px;font-size:9px;border-radius:5px}
.row{display:flex;gap:8px}
.row .btn{flex:1;justify-content:center}

/* â”€â”€ Pill tags â”€â”€ */
.pill{display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:8px;font-weight:700}
.pill-green{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.pill-orange{background:rgba(251,146,60,.12);color:var(--orange);border:1px solid rgba(251,146,60,.2)}
.pill-red{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.2)}
.pill-purple{background:rgba(167,139,250,.12);color:var(--purple);border:1px solid rgba(167,139,250,.2)}
.pill-blue{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.2)}
.pill-muted{background:rgba(74,82,112,.15);color:var(--sub);border:1px solid var(--border2)}
.pill-gold{background:rgba(201,168,76,.12);color:var(--gold);border:1px solid rgba(201,168,76,.2)}

/* â”€â”€ App list (è¤‡æ•°ç”³è¾¼) â”€â”€ */
.app-item{background:#0b0d15;border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:6px}
.app-item.active-app{border-color:var(--gold)}
.app-name{font-size:12px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;justify-content:space-between}
.app-meta{font-size:10px;color:var(--sub)}

/* â”€â”€ History â”€â”€ */
.hist-item{display:flex;gap:8px;padding:4px 0}
.hist-dot{width:7px;height:7px;border-radius:50%;background:var(--border2);flex-shrink:0;margin-top:4px}
.hist-dot.cur{background:var(--gold)}
.hist-line{width:1px;height:14px;background:var(--border2);margin:1px auto}

/* â”€â”€ Modal â”€â”€ */
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(3px);z-index:200;align-items:center;justify-content:center}
#overlay.on{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px;max-width:400px;width:90%}
.modal-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold);margin-bottom:14px}

/* â”€â”€ Toast â”€â”€ */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--card);
  border:1px solid var(--green);border-radius:9px;padding:9px 16px;font-size:11px;
  color:var(--green);z-index:300;display:none;white-space:nowrap}

/* â”€â”€ Done state â”€â”€ */
.done-card{text-align:center;padding:20px}
.done-icon{font-size:48px;margin-bottom:8px}
.done-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--green)}

/* â”€â”€ cancel state â”€â”€ */
.cancel-card{text-align:center;padding:16px;color:var(--red)}
</style>
</head>
<body>
<div class="layout">

<div class="hdr">
  <div style="display:flex;align-items:center;gap:14px">
    <div class="logo">CORETO</div>
    <span style="font-size:9px;color:var(--muted);font-weight:600;letter-spacing:1px">æ¡ˆä»¶ç®¡ç†</span>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-ghost btn-sm" onclick="history.back()">â† æˆ»ã‚‹</button>
    <button class="btn btn-gold btn-sm" onclick="openNewModal()">ï¼‹ æ–°è¦æ¡ˆä»¶</button>
  </div>
</div>

<div class="toolbar">
  <select id="f-type" onchange="render()" style="background:#090b13;border:1px solid var(--border2);border-radius:6px;padding:4px 10px;color:var(--text);font-size:11px;font-family:inherit">
    <option value="reLet">ğŸ  è³ƒè²¸</option>
    <option value="reSale">ğŸ¢ å£²è²·</option>
    <option value="sannai">ğŸ”„ ä¸‰ç‚º</option>
    <option value="hr">ğŸ‘¥ äººæ</option>
  </select>
  <select id="f-agent" onchange="render()" style="background:#090b13;border:1px solid var(--border2);border-radius:6px;padding:4px 10px;color:var(--text);font-size:11px;font-family:inherit">
    <option value="">å…¨æ‹…å½“</option>
    <option value="10012">å±±ç”° èª </option>
    <option value="10008">éˆ´æœ¨ å¥å¤ª</option>
    <option value="10023">ä½è—¤ èŠ±å­</option>
  </select>
  <span id="board-count" style="margin-left:auto;font-size:10px;color:var(--muted)"></span>
</div>

<div class="main">
  <div class="board-wrap"><div class="board" id="board"></div></div>

  <!-- Detail Panel -->
  <div class="panel" id="panel">
    <div class="panel-top" id="panel-top"></div>
    <div class="panel-body" id="panel-body"></div>
  </div>
</div>

</div><!-- /layout -->

<!-- Modal -->
<div id="overlay"><div class="modal" id="modal-box"></div></div>
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STAGES = [
  {id:'new',      label:'æ–°è¦',     dot:'#4a5270', color:'var(--sub)'},
  {id:'naiken',   label:'å†…è¦‹',     dot:'#4f9cf9', color:'var(--blue)'},
  {id:'apply',    label:'ç”³è¾¼ãƒ»å¯©æŸ»',dot:'#fb923c', color:'var(--orange)', labelSale:'è²·ä»˜'},  // label overridden per type
  {id:'contract', label:'å¥‘ç´„ä¸­',   dot:'#c9a84c', color:'var(--gold)'},
  {id:'payment',  label:'å…¥é‡‘å¾…ã¡', dot:'#a78bfa', color:'var(--purple)'},
  {id:'done',     label:'å®Œäº†',     dot:'#34d399', color:'var(--green)'},
  {id:'cancel',   label:'å–æ¶ˆ',     dot:'#f87171', color:'var(--red)'},
];

// ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆè³ƒè²¸ï¼‰
const STEPS_RELET = [
  {id:'naiken',   label:'å†…è¦‹',   icon:'ğŸ ', stage:'naiken'},
  {id:'apply',    label:'ç”³è¾¼',   icon:'ğŸ“‹', stage:'apply'},
  {id:'screening',label:'å¯©æŸ»',   icon:'â³', stage:'apply'},
  {id:'invoice',  label:'è«‹æ±‚æ›¸', icon:'ğŸ§¾', stage:'contract'},
  {id:'prekey',   label:'é‡èª¬ãƒ»å…¥é‡‘', icon:'ğŸ“', stage:'contract'},
  {id:'key',      label:'éµæ¸¡ã—', icon:'ğŸ”‘', stage:'done'},
];

// ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆå£²è²·ï¼‰
const STEPS_RESALE = [
  {id:'naiken',   label:'å†…è¦‹',   icon:'ğŸ ', stage:'naiken'},
  {id:'offer',    label:'è²·ä»˜',   icon:'ğŸ“„', stage:'apply'},
  {id:'invoice',  label:'è«‹æ±‚æ›¸', icon:'ğŸ§¾', stage:'contract'},
  {id:'contract', label:'å¥‘ç´„',   icon:'âœï¸', stage:'contract'},
  {id:'settlement',label:'æ±ºæ¸ˆ',  icon:'ğŸ’´', stage:'done'},
];

// ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆä¸‰ç‚ºï¼‰
const STEPS_SANNAI = [
  {id:'naiken',    label:'å†…è¦‹',     icon:'ğŸ ', stage:'naiken'},
  {id:'verify',    label:'æ¥­è€…ç¢ºèª', icon:'ğŸ”', stage:'apply'},
  {id:'offer',     label:'è²·ä»˜',     icon:'ğŸ“„', stage:'apply'},
  {id:'invoice',   label:'è«‹æ±‚æ›¸',   icon:'ğŸ§¾', stage:'contract'},
  {id:'contract',  label:'å¥‘ç´„',     icon:'âœï¸', stage:'contract'},
  {id:'settlement',label:'æ±ºæ¸ˆ',     icon:'ğŸ’´', stage:'done'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CASES = [
  {id:'R042857', name:'ç”°ä¸­ é›„ä»‹', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸‹è°·åŒº 2LDK ã€œÂ¥220,000', step:'screening', age:3, stale:false,
   apps:[
     {id:'A001', prop:'æ¸‹è°·åŒºæ¡œä¸˜ 2LDK', mgmt:'ä¸‰äº•ä½å‹ç®¡ç†', date:'2026-02-18', status:'rejected'},
     {id:'A002', prop:'æ¸‹è°·åŒºä»£ã€…æœ¨ 2LDK', mgmt:'æ±æ€¥ãƒªãƒãƒ–ãƒ«ç®¡ç†', date:'2026-02-21', status:'reviewing'},
   ],
   dates:{naiken:'2026-02-17'}, hist:['2/17 å†…è¦‹å®Œäº†','2/18 ç”³è¾¼â†’å¯©æŸ»è½ã¡','2/21 åˆ¥ç‰©ä»¶ã§å†ç”³è¾¼'],
  },
  {id:'R039102', name:'æœ¨æ‘ å½©é¦™', type:'reLet', corp:false, agent:'10012',
   sub:'å“å·åŒº 1K ã€œÂ¥85,000', step:'screening', age:1, stale:false,
   apps:[
     {id:'A010', prop:'å“å·åŒºå¤§å´ 1K', mgmt:'å¤§å´ç®¡ç†', date:'2026-02-21', status:'reviewing', sim:true},
     {id:'A011', prop:'å“å·åŒºäº”åç”° 1K', mgmt:'æ±æ€¥ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', date:'2026-02-21', status:'reviewing', sim:true},
   ],
   dates:{naiken:'2026-02-20'}, hist:['2/20 å†…è¦‹å®Œäº†','2/21 2ç‰©ä»¶åŒæ™‚ç”³è¾¼'],
  },
  {id:'R041003', name:'æ–è—¤ äº®', type:'reLet', corp:false, agent:'10023',
   sub:'æ–°å®¿åŒº 1LDK ã€œÂ¥130,000', step:'naiken', age:9, stale:true,
   apps:[], dates:{}, hist:['2/11 å•åˆã›å—ä¿¡'],
  },
  {id:'R044201', name:'æ©‹æœ¬ æ—©è‹—', type:'reLet', corp:false, agent:'10012',
   sub:'ç›®é»’åŒº 1LDK ã€œÂ¥150,000', step:'naiken', age:1, stale:false,
   apps:[], dates:{naiken:'2026-02-23'}, hist:['2/21 å†…è¦‹äºˆç´„: 2/23 10:00'],
  },
  {id:'R045500', name:'ä¼Šè—¤ ç¿”å¤ª', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK Â¥155,000', step:'invoice', age:2, stale:false,
   apps:[{id:'A020', prop:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK', mgmt:'æ±æ€¥ç®¡ç†', date:'2026-02-15', status:'approved'}],
   dates:{naiken:'2026-02-14', applied:'2026-02-15', approved:'2026-02-17', paid:'2026-02-20'}, adOnly:false, taskDone:{paid:true,itsetsu:false},
   hist:['2/14 å†…è¦‹','2/15 ç”³è¾¼','2/17 å¯©æŸ»é€šé','2/20 å…¥é‡‘ç¢ºèªæ¸ˆ'],
  },
  {id:'R047800', name:'æ ªå¼ä¼šç¤¾ã‚¿ãƒŠã‚«å•†äº‹', type:'reLet', corp:true, contactName:'ç”°ä¸­ ä¸€éƒ', agent:'10008',
   sub:'æ–°å®¿åŒº äº‹å‹™æ‰€ ã€œÂ¥250,000', step:'screening', age:0, stale:false,
   apps:[
     {id:'A060', prop:'æ–°å®¿åŒºè¥¿æ–°å®¿ 30åª', mgmt:'ä¸‰è±åœ°æ‰€ç®¡ç†', date:'2026-02-22', status:'reviewing', sim:true},
     {id:'A061', prop:'æ–°å®¿åŒºæ–°å®¿ 25åª', mgmt:'æ±æ€¥ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', date:'2026-02-22', status:'reviewing', sim:true},
   ],
   dates:{naiken:'2026-02-22'}, hist:['2/22 å†…è¦‹','2/22 2ç‰©ä»¶åŒæ™‚ç”³è¾¼ï¼ˆæ³•äººï¼‰'],
  },
  {id:'R038291', name:'æ¾æœ¬ æµ©äºŒ', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸‹è°·åŒº 2K Â¥170,000', step:'prekey', age:0, stale:false,
   apps:[{id:'A040', prop:'æ¸‹è°·åŒº 2K', mgmt:'æ±äº¬å»ºç‰©ç®¡ç†', date:'2026-02-08', status:'approved'}],
   dates:{naiken:'2026-02-07', applied:'2026-02-08', approved:'2026-02-12', paid:'2026-02-17', itsetsu:'2026-02-20', chinkaku:'2026-03-01'}, adOnly:false, taskDone:{paid:true,itsetsu:true},
   hist:['2/07 å†…è¦‹','2/08 ç”³è¾¼','2/12 å¯©æŸ»é€šé','2/17 å…¥é‡‘ç¢ºèª','2/20 ITé‡èª¬å®Œäº†'],
  },
  {id:'R049001', name:'å±±å´ å¥', type:'reLet', corp:false, agent:'10023',
   sub:'æ¸¯åŒº 1K Â¥110,000 ADæ¡ˆä»¶', step:'prekey', age:1, stale:false, adOnly:true,
   apps:[{id:'A080', prop:'æ¸¯åŒº 1K', mgmt:'æ±äº¬å»ºç‰©ç®¡ç†', date:'2026-02-21', status:'approved'}],
   dates:{naiken:'2026-02-20', applied:'2026-02-21', approved:'2026-02-22'}, taskDone:{paid:false,itsetsu:false},
   hist:['2/20 å†…è¦‹','2/21 ç”³è¾¼','2/22 å¯©æŸ»é€šéï¼ˆADæ¡ˆä»¶ï¼‰'],
  },
  {id:'R040011', name:'ä¸­æ‘ ç”±ç¾', type:'reLet', corp:false, agent:'10012',
   sub:'æ¸¯åŒº 1R Â¥95,000', step:'done', age:0, stale:false,
   apps:[{id:'A050', prop:'æ¸¯åŒº 1R', mgmt:'ä½å‹ä¸å‹•ç”£ç®¡ç†', date:'2026-02-01', status:'approved'}],
   dates:{naiken:'2026-02-01', applied:'2026-02-01', approved:'2026-02-05', paid:'2026-02-10', itsetsu:'2026-02-15', chinkaku:'2026-03-01'},
   hist:['2/01 å†…è¦‹ãƒ»ç”³è¾¼','2/05 å¯©æŸ»é€šé','2/10 å…¥é‡‘','2/15 é‡èª¬','2/18 éµæ¸¡ã—å®Œäº†'],
  },
  {id:'R046001', name:'åŠ è—¤ ç¾å’²', type:'reLet', corp:false, agent:'10008',
   sub:'æ¸¯åŒºå—é’å±± 1LDK Â¥180,000', step:'cancel', age:0, stale:false,
   apps:[{id:'A030', prop:'æ¸¯åŒºå—é’å±± 1LDK', mgmt:'ä½å‹ä¸å‹•ç”£ç®¡ç†', date:'2026-02-10', status:'cancelled'}],
   dates:{naiken:'2026-02-09'}, hist:['2/09 å†…è¦‹','2/10 ç”³è¾¼','2/14 å¯©æŸ»é€šé','2/21 ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæœ¬äººéƒ½åˆï¼‰'],
  },
  {id:'S819204', name:'å‰ç”° å¤§è¼”', type:'reSale', corp:false, agent:'10008',
   sub:'ç›®é»’åŒº æˆ¸å»ºã¦ Â¥32,000,000', step:'contract', age:5, stale:false,
   salePrice:32000000,
   apps:[], dates:{naiken:'2026-02-10', offer:'2026-02-15', contract:'2026-02-20'},
   hist:['2/15 è²·ä»˜å—é ˜','2/20 å£²è²·å¥‘ç´„ç· çµ'],
  },

  {id:'S291047', name:'ç”°ä¸­ ç¾å’²', type:'reSale', corp:false, agent:'10012',
   sub:'æ¸¯åŒº ã‚¿ãƒ¯ãƒãƒ³ Â¥65,000,000', step:'offer', age:2, stale:false,
   salePrice:65000000,
   apps:[], dates:{offer:'2026-02-21'},
   hist:['2/21 å†…è¦‹ãªã—ãƒ»è²·ä»˜æå‡º'],
  },
  {id:'S104382', name:'æ¸¡è¾º å¥ä¸€', type:'reSale', corp:true, agent:'10008',
   sub:'æ¸‹è°·åŒº ãƒãƒ³ã‚·ãƒ§ãƒ³ Â¥28,500,000', step:'naiken', age:1, stale:false,
   salePrice:28500000,
   apps:[], dates:{naiken:'2026-02-22'},
   hist:['2/22 å†…è¦‹äºˆå®š'],
  },];

let cur = null; // current case id

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stageOf(c) {
  const step = c.step;
  if (step==='done') return 'done';
  if (step==='cancel') return 'cancel';
  if (step==='naiken') return 'naiken';
  if (step==='apply'||step==='screening'||step==='offer'||step==='verify') return 'apply';
  if (step==='payment') return 'payment';
  if (step==='invoice'||step==='prekey'||step==='itsetsu'||step==='key'||step==='contract') return 'contract';
  if (step==='settlement') return 'done';
  if (step==='offer') return 'apply';
  return 'new';
}

function render() {
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: f-type ãŒç©ºãªã‚‰ reLet ã«ã‚»ãƒƒãƒˆ
  const ft = document.getElementById('f-type');
  if(ft && ft.value==='') ft.value='reLet';

  const tf = document.getElementById('f-type').value;
  const af = document.getElementById('f-agent').value;
  let cs = CASES;
  if (tf) cs = cs.filter(c=>c.type===tf);
  if (af) cs = cs.filter(c=>c.agent===af);

  const board = document.getElementById('board');
  board.innerHTML = STAGES.map(st=>{
    const cols = cs.filter(c=>stageOf(c)===st.id);
    const canAdd = st.id!=='done'&&st.id!=='cancel';
    return '<div class="col">'
      +'<div class="col-hdr">'
      +'<div class="col-title"><div class="col-dot" style="background:'+st.dot+'"></div>'+(tf!=='reLet'&&tf!=='hr'&&st.labelSale?st.labelSale:st.label)+'</div>'
      +'<span class="col-count" style="background:'+st.dot+'22;color:'+st.color+';border:1px solid '+st.dot+'55">'+cols.length+'</span>'
      +'</div>'
      +'<div class="col-body">'
      +cols.map(c=>cardHTML(c,st)).join('')
      +(canAdd?'<div class="add-row" onclick="openNewModal(\''+st.id+'\')">ï¼‹</div>':'')
      +'</div></div>';
  }).join('');

  document.getElementById('board-count').textContent = cs.length+' / '+CASES.length+' ä»¶';
}

function cardHTML(c, st) {
  const isCur = c.id===cur;
  const pendingApps = (c.apps||[]).filter(a=>a.status==='reviewing'||a.status==='submitted').length;
  const rejApps     = (c.apps||[]).filter(a=>a.status==='rejected').length;

  let badge = '';
  if (c.corp) badge += '<span class="pill pill-purple" style="font-size:7px">æ³•äºº</span> ';
  if (pendingApps>1) badge += '<span class="pill pill-orange" style="font-size:7px">åŒæ™‚'+pendingApps+'ä»¶</span>';
  if (rejApps>0 && c.step==='screening' && c.type==='reLet') badge += ' <span class="pill pill-red" style="font-size:7px">è½ã¡'+rejApps+'</span>';

  const ageEl = c.age===0
    ? '<span class="age" style="background:rgba(52,211,153,.1);color:var(--green)">æœ¬æ—¥</span>'
    : c.age>=7
    ? '<span class="age" style="background:rgba(248,113,113,.1);color:var(--red)">'+c.age+'æ—¥å‰</span>'
    : '<span class="age" style="background:rgba(74,82,112,.15);color:var(--sub)">'+c.age+'æ—¥å‰</span>';

  const typeEl = c.type==='reLet'?'ğŸ  è³ƒè²¸':c.type==='reSale'?'ğŸ¢ å£²è²·':c.type==='sannai'?'ğŸ”„ ä¸‰ç‚º':'ğŸ‘¥ äººæ';

  return '<div class="card'+(isCur?' active':'')+'" onclick="open_case(\''+c.id+'\')">'
    +(c.stale?'<div class="stale"></div>':'')
    +'<div class="card-type" style="color:'+st.color+'">'+typeEl+(badge?' '+badge:'')+'</div>'
    +'<div class="card-name">'+c.name+'</div>'
    +'<div class="card-sub">'+c.sub+'</div>'
    +'<div class="card-foot"><span class="card-id">'+c.id+'</span>'+ageEl+'</div>'
    +'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function open_case(id) {
  try {
  cur = id;
  const c = CASES.find(x=>x.id===id);
  if(!c) { console.error('open_case: not found', id); return; }
  if(!c.dates) c.dates = {};
  if(!c.hist)  c.hist  = [];
  if(!c.apps)  c.apps  = [];

  document.getElementById('panel').classList.add('open');

  // Header
  const corpBadge = c.corp ? ' <span class="pill pill-purple">æ³•äºº</span>' : '';
  document.getElementById('panel-top').innerHTML =
    '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px">'
    +'<div>'
    +'<div style="font-family:\'DM Mono\',monospace;font-size:10px;color:var(--muted);margin-bottom:2px">'+c.id+'</div>'
    +'<div style="font-size:16px;font-weight:800">'+c.name+corpBadge+'</div>'
    +(c.corp&&c.contactName?'<div style="font-size:11px;color:var(--sub);margin-top:1px">æ‹…å½“: '+c.contactName+'</div>':'')
    +'<div style="font-size:11px;color:var(--muted);margin-top:2px">'+c.sub+'</div>'
    +'</div>'
    +'<button class="btn btn-ghost btn-sm" onclick="close_panel()">âœ•</button>'
    +'</div>'
    + buildStepBar(c);

  buildStepContent(c);
  render();
  } catch(e) { console.error('open_case error:', e); toast('è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: '+e.message); }
}

function close_panel() {
  cur = null;
  document.getElementById('panel').classList.remove('open');
  render();
}

function buildStepBar(c) {
  const steps = c.type==='reLet' ? STEPS_RELET : c.type==='reSale' ? STEPS_RESALE : c.type==='sannai' ? STEPS_SANNAI : [];
  if (!steps.length) return '';
  const curIdx = steps.findIndex(s=>s.id===c.step);

  return '<div class="step-bar">'
    +steps.map((s,i)=>{
      const cls = i<curIdx?'done':i===curIdx?'active':'future';
      const inner = i<curIdx ? 'âœ“' : s.icon;
      // å®Œäº†æ¸ˆã¿ã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯ï¼ˆèª¤ã£ã¦å‰ã‚¹ãƒ†ãƒƒãƒ—ã«æˆ»ã‚‰ãªã„ã‚ˆã†ï¼‰
      // æœªæ¥ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ã‚¯ãƒªãƒƒã‚¯ã§å…ˆé€ã‚Šã§ãã‚‹
      if (i <= curIdx) {
        return '<div class="step-node '+cls+'" style="cursor:default">'
          +'<div class="step-circle">'+inner+'</div>'
          +'<div class="step-label">'+s.label+'</div>'
          +'</div>';
      }
      return '<div class="step-node '+cls+'" style="cursor:pointer" onclick="jumpStep(\''+c.id+'\',\''+s.id+'\')">'
          +'<div class="step-circle">'+inner+'</div>'
          +'<div class="step-label">'+s.label+'</div>'
          +'</div>';
    }).join('')
    +'</div>';
}

function buildStepContent(c) {
  const body = document.getElementById('panel-body');

  if (c.step==='done') {
    body.innerHTML = '<div class="done-card"><div class="done-icon">ğŸ‰</div>'
      +'<div class="done-title">æˆç´„å®Œäº†</div>'
      +'<div style="font-size:11px;color:var(--sub);margin-top:6px">'+(c.dates.chinkaku||'')+'</div>'
      +'</div>'+histHTML(c);
    return;
  }
  if (c.step==='cancel') {
    body.innerHTML = '<div class="cancel-card"><div style="font-size:32px">ğŸš«</div>'
      +'<div style="font-weight:700;margin-top:4px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div></div>'+histHTML(c)
      +'<div style="margin-top:12px"><button class="btn btn-ghost btn-sm" onclick="reactivate(\''+c.id+'\')">â†© å†é–‹</button></div>';
    return;
  }

  let html = '<div class="step-content">';

  // â”€â”€ è³ƒè²¸ãƒ•ãƒ­ãƒ¼ â”€â”€
  if (c.type==='reLet') {
    if (c.step==='naiken') html += stepNaiken(c);
    else if (c.step==='apply') html += stepApply(c);
    else if (c.step==='screening') html += stepScreening(c);
    else if (c.step==='invoice') html += stepInvoice(c);
    else if (c.step==='prekey') html += stepPrekey(c);
    else if (c.step==='payment') html += stepPayment(c);
    else if (c.step==='itsetsu') html += stepPrekey(c);
    else if (c.step==='key') html += stepKey(c);
  }
  // â”€â”€ ä¸‰ç‚ºãƒ•ãƒ­ãƒ¼ â”€â”€
  else if (c.type==='sannai') {
    if (c.step==='naiken') html += stepSaleNaiken(c);
    else if (c.step==='verify') html += stepSannaiVerify(c);
    else if (c.step==='offer') html += stepSannaiOffer(c);
    else if (c.step==='invoice') html += stepInvoice(c);
    else if (c.step==='contract') html += stepSannaiContract(c);
    else if (c.step==='settlement') html += stepSettlement(c);
  }
  // â”€â”€ å£²è²·ãƒ•ãƒ­ãƒ¼ â”€â”€
  else if (c.type==='reSale') {
    if (c.step==='naiken') html += stepSaleNaiken(c);
    else if (c.step==='offer') html += stepOffer(c);
    else if (c.step==='invoice') html += stepInvoice(c);
    else if (c.step==='contract') html += stepSaleContract(c);
    else if (c.step==='settlement'||c.step==='payment') html += stepSettlement(c);
  }

  html += '</div>';

  // è¤‡æ•°ç”³è¾¼ãƒªã‚¹ãƒˆï¼ˆscreeningæ™‚ = è³ƒè²¸ã®ã¿ï¼‰
  if (c.type==='reLet' && c.step==='screening' && c.apps.length>0) {
    html += '<div style="margin-top:12px">'+appsHTML(c)+'</div>';
  }

  html += histHTML(c);

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
  html += '<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">'
    +'<button class="btn btn-red btn-sm" onclick="cancelCase(\''+c.id+'\')">ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
    +'</div>';

  body.innerHTML = html;
}

// â”€â”€ STEP RENDERERS â”€â”€

function stepNaiken(c) {
  const today = new Date().toISOString().slice(0,10);
  const dateVal = c.dates.naiken || today;
  return '<div class="step-title">ğŸ  å†…è¦‹</div>'
    +'<div class="fi"><label>å†…è¦‹æ—¥</label><input type="date" id="s-naiken-date" class="mono" value="'+dateVal+'"></div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-naiken-prop" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 1LDK" value="'+(c.dates.naikenProp||'')+'"></div>'
    +'<div class="row" style="margin-top:14px">'
    +'<button class="btn btn-green" onclick="naikenDone(\''+c.id+'\')">âœ“ å†…è¦‹å®Œäº† â†’ ç”³è¾¼ã¸</button>'
    +'<button class="btn btn-red" onclick="naikenSkip(\''+c.id+'\')">è¦‹é€ã‚Š</button>'
    +'</div>';
}

function stepApply(c) {
  const today = new Date().toISOString().slice(0,10);
  return '<div class="step-title">ğŸ“‹ ç”³è¾¼</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-prop" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 1LDK"></div>'
    +'<div class="fi"><label>ç®¡ç†ä¼šç¤¾</label><input type="text" id="s-mgmt" placeholder="ã€‡ã€‡ç®¡ç†æ ªå¼ä¼šç¤¾"></div>'
    +'<div class="fi"><label>ç”³è¾¼æ—¥</label><input type="date" id="s-apply-date" class="mono" value="'+today+'"></div>'
    +'<button class="btn btn-green" style="width:100%;justify-content:center;margin-top:14px" onclick="submitApply(\''+c.id+'\')">ç”³è¾¼æ¸ˆã¿ã«ã™ã‚‹ â†’</button>';
}

function stepScreening(c) {
  const activeApps = c.apps.filter(a=>a.status==='reviewing'||a.status==='submitted');
  const rejApps    = c.apps.filter(a=>a.status==='rejected');

  let html = '<div class="step-title">â³ å¯©æŸ»ä¸­</div>';

  if (activeApps.length===0 && rejApps.length>0) {
    html += '<div style="background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:8px;padding:10px;margin-bottom:12px;font-size:11px;color:var(--red)">å…¨ç‰©ä»¶ã§å¯©æŸ»è½ã¡</div>';
    html += '<button class="btn btn-blue" style="width:100%;justify-content:center" onclick="addApp(\''+c.id+'\')">ï¼‹ åˆ¥ç‰©ä»¶ã§å†ç”³è¾¼</button>';
    return html;
  }

  html += activeApps.map(a=>
    '<div class="app-item active-app" style="margin-bottom:8px">'
    +'<div class="app-name"><span>'+a.prop+'</span>'+(a.sim?'<span class="pill pill-orange">åŒæ™‚</span>':'')+'</div>'
    +'<div style="display:flex;gap:6px;margin-top:8px">'
    +'<button class="btn btn-green btn-sm" onclick="appPassed(\''+c.id+'\',\''+a.id+'\')">å¯©æŸ»é€šé â†’</button>'
    +'<button class="btn btn-red btn-sm" onclick="appRejected(\''+c.id+'\',\''+a.id+'\')">è½ã¡</button>'
    +'</div></div>'
  ).join('');

  html += '<button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;margin-top:4px" onclick="addApp(\''+c.id+'\')">ï¼‹ è¿½åŠ ç”³è¾¼</button>';
  return html;
}

function stepPrekey(c) {
  const td = c.taskDone || {};
  const ad = c.adOnly || false;
  const paidOk   = td.paid || false;
  const setsuOk  = td.itsetsu || false;
  const canKey   = setsuOk && (paidOk || ad);

  function taskRow(done, label, onclick) {
    if (done) return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;'
      +'background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.2);border-radius:8px;margin-bottom:8px">'
      +'<span style="font-size:16px">âœ…</span><span style="font-size:12px;color:var(--green);font-weight:700">'+label+'</span></div>';
    return '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;'
      +'background:var(--card2);border:1px solid var(--border);border-radius:8px;margin-bottom:8px">'
      +'<span style="font-size:12px">'+label+'</span>'
      +'<button class="btn btn-green btn-sm" onclick="'+onclick+'">å®Œäº†</button></div>';
  }

  let h = '<div class="step-title">ğŸ“ é‡èª¬ãƒ»å…¥é‡‘</div>';
  h += taskRow(setsuOk, 'ITé‡èª¬ãƒ»å¥‘ç´„',
    "window.open('coreto-it-setsu.html','_blank');itsetsuCheck('"+c.id+"')");
  if (!ad) {
    h += taskRow(paidOk, 'å…¥é‡‘ç¢ºèª', "paymentCheck('"+c.id+"')");
  } else {
    h += '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;'
      +'background:rgba(251,146,60,.06);border:1px solid rgba(251,146,60,.2);border-radius:8px;margin-bottom:8px">'
      +'<span style="font-size:12px;color:var(--orange)">ğŸ’´ å…¥é‡‘</span>'
      +'<span style="font-size:10px;color:var(--muted)">ADæ¡ˆä»¶: éµæ¸¡ã—å¾Œã§OK</span></div>';
  }
  h += '<div style="margin-top:6px">';
  if (canKey) {
    h += '<button class="btn btn-green" style="width:100%;justify-content:center" onclick="advance(\''+c.id+'\',\'key\',null,null,\'éµæ¸¡ã—æº–å‚™å®Œäº†\')">éµæ¸¡ã—ã¸ â†’</button>';
  } else {
    const miss = []; if(!setsuOk) miss.push('é‡èª¬'); if(!paidOk&&!ad) miss.push('å…¥é‡‘');
    h += '<button class="btn btn-ghost" style="width:100%;justify-content:center;opacity:.45;cursor:default">'
      +miss.join('ãƒ»')+' å®Œäº†å¾Œã«è§£æ”¾</button>';
  }
  h += '</div>';
  // â”€â”€ ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸ã‚µãƒãƒªãƒ¼ï¼ˆä¿®æ­£ãƒœã‚¿ãƒ³ä»˜ãï¼‰ â”€â”€
  if (c.invoice && c.invoice.issued) {
    const inv = c.invoice;
    const typeLabel = inv.type==='commission'?'ä»²ä»‹æ‰‹æ•°æ–™ã®ã¿':inv.type==='ad_plus'?'ADï¼‹ä»²ä»‹æ‰‹æ•°æ–™':'ADã®ã¿';
    const total = inv.grandTotal ? inv.grandTotal : (inv.commAmt||0)+(inv.adAmt||0)||(inv.totalItems||0);
    h = '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px;font-size:11px">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
      +'<span style="color:var(--gold);font-weight:700">ğŸ§¾ ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸</span>'
      +'<button onclick="editInvoice(\''+c.id+'\')" style="background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);border-radius:5px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">âœ ä¿®æ­£ã™ã‚‹</button>'
      +'</div>'
      +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub)">'
      +(inv.prop?'<span>ç‰©ä»¶</span><span style="color:var(--t)">'+inv.prop+'</span>':'')
      +'<span>ç¨®åˆ¥</span><span style="color:var(--t)">'+typeLabel+'</span>'
      +(inv.commAmt?'<span>ä»²ä»‹æ‰‹æ•°æ–™</span><span class="mono" style="color:var(--t)">Â¥'+parseInt(inv.commAmt).toLocaleString()+'</span>':'')
      +(inv.adAmt?'<span>'+(inv.adDesc||'æ¥­å‹™å§”è¨—')+' (AD)</span><span class="mono" style="color:var(--t)">Â¥'+parseInt(inv.adAmt).toLocaleString()+'</span>':'')
      +(total?'<span style="font-weight:600">åˆè¨ˆ</span><span class="mono" style="color:var(--gold);font-weight:700">Â¥'+parseInt(total).toLocaleString()+'</span>':'')
      +(inv.underReason?'<span style="color:var(--orange)">æ¸›é¡ç†ç”±</span><span style="color:var(--orange)">'+inv.underReason+'</span>':'')
      +'</div></div>'
      + h;
  }

  return h;
}
function stepPayment(c) { return stepPrekey(c); }
function stepItsetsu(c) { return stepPrekey(c); }

// â”€â”€ å£²è²· steps â”€â”€
function stepSaleNaiken(c) {
  const val = c.dates.naiken || new Date().toISOString().slice(0,10);
  return '<div class="step-title">ğŸ  å†…è¦‹ï¼ˆå£²è²·ï¼‰</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-sale-prop" value="'+(c.dates.naikenProp||'')+'" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·"></div>'
    +'<div class="fi"><label>å†…è¦‹æ—¥</label><input type="date" id="s-naiken-date" class="mono" value="'+val+'"></div>'
    +'<div style="display:flex;gap:8px;margin-top:14px">'
    +(c.type==='sannai'
      ? '<button class="btn btn-green" style="flex:1;justify-content:center" data-cid="'+c.id+'" onclick="sannaiNaikenDone(this.dataset.cid)">å†…è¦‹å®Œäº† â†’ æ¥­è€…ç¢ºèªã¸</button>'
        +'<button class="btn btn-ghost btn-sm" data-cid="'+c.id+'" onclick="sannaiSkipNaiken(this.dataset.cid)">å†…è¦‹ãªã—ãƒ»æ¥­è€…ç¢ºèªã¸</button>'
      : '<button class="btn btn-green" style="flex:1;justify-content:center" data-cid="'+c.id+'" onclick="saleNaikenDone(this.dataset.cid)">å†…è¦‹å®Œäº† â†’ è²·ä»˜ã¸</button>'
        +'<button class="btn btn-ghost btn-sm" data-cid="'+c.id+'" onclick="saleSkipNaiken(this.dataset.cid)">å†…è¦‹ãªã—ãƒ»è²·ä»˜ã¸ã‚¹ã‚­ãƒƒãƒ—</button>')
    +'</div>';
}

function sannaiNaikenDone(id) {
  try {
    const prop = document.getElementById('s-sale-prop')?.value.trim()||'';
    const d    = document.getElementById('s-naiken-date')?.value||todayISO();
    const c = CASES.find(x=>x.id===id); if(!c) return;
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(!c.buyer) c.buyer = {verifyState:'input'};
    if(prop) c.dates.naikenProp = prop;
    advance(id,'verify','naiken',d,'å†…è¦‹å®Œäº† â†’ æ¥­è€…ç¢ºèªã¸');
  } catch(e) { console.error('sannaiNaikenDone:', e); }
}

function sannaiSkipNaiken(id) {
  try {
    const prop = document.getElementById('s-sale-prop')?.value.trim()||'';
    const c = CASES.find(x=>x.id===id); if(!c) return;
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(!c.buyer) c.buyer = {verifyState:'input'};
    if(prop) c.dates.naikenProp = prop;
    c.hist.unshift(today()+' å†…è¦‹ãªã—ãƒ»æ¥­è€…ç¢ºèªã¸');
    c.step = 'verify';
    open_case(id);
    toast('æ¥­è€…ç¢ºèªã¸');
  } catch(e) { console.error('sannaiSkipNaiken:', e); }
}

function saleNaikenDone(id) {
  try {
    const prop = document.getElementById('s-sale-prop')?.value.trim()||'';
    const d    = document.getElementById('s-naiken-date')?.value||todayISO();
    const c = CASES.find(x=>x.id===id);
    if(!c) { console.error('saleNaikenDone: case not found', id); return; }
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(prop) c.dates.naikenProp = prop;
    advance(id,'offer','naiken',d,'å†…è¦‹å®Œäº† â†’ è²·ä»˜');
  } catch(e) {
    console.error('saleNaikenDone error:', e);
  }
}

function saleSkipNaiken(id) {
  try {
    const prop = document.getElementById('s-sale-prop')?.value.trim()||'';
    const c = CASES.find(x=>x.id===id);
    if(!c) { console.error('saleSkipNaiken: case not found', id); return; }
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(prop) c.dates.naikenProp = prop;
    c.hist.unshift(today()+' å†…è¦‹ãªã—ãƒ»è²·ä»˜ã¸');
    c.step = 'offer';
    open_case(id);
    toast('å†…è¦‹ãªã—ãƒ»è²·ä»˜ã¸ã‚¹ã‚­ãƒƒãƒ—');
  } catch(e) {
    console.error('saleSkipNaiken error:', e);
  }
}

function stepOffer(c) {
  const today = new Date().toISOString().slice(0,10);
  const skipLabel = c.dates.naiken ? '' : '<span style="font-size:10px;color:var(--orange);margin-left:8px">å†…è¦‹ãªã—</span>';
  return '<div class="step-title">ğŸ“„ è²·ä»˜'+skipLabel+'</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-sale-prop" value="'+(c.dates.naikenProp||'')+'" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·"></div>'
    +'<div class="fi"><label>å£²è²·ä¾¡æ ¼ï¼ˆå††ï¼‰</label><input type="text" id="s-sale-price" class="mono" placeholder="ä¾‹: 32,000,000" value="'+(fmtYen(c.salePrice)||'')+'" style="font-size:13px" oninput="invSalePriceInput(this)"></div>'
    +'<div class="fi"><label>è²·ä»˜æ—¥</label><input type="date" id="s-offer-date" class="mono" value="'+today+'"></div>'
    +'<button class="btn btn-green" style="width:100%;justify-content:center;margin-top:14px" data-cid="'+c.id+'" onclick="offerDone(this.dataset.cid)">è²·ä»˜å—é ˜ â†’ è«‹æ±‚æ›¸ã¸</button>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸‰ç‚ºå°‚ç”¨ å¥‘ç´„ã‚¹ãƒ†ãƒƒãƒ—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stepSannaiContract(c) {
  const id  = c.id;
  const sn  = c.sannai  || {};
  const inv = c.invoice || {};
  const sc  = c.sannaiContract || {};

  const bp = sn.buyPrice  || 0;
  const sp = sn.sellPrice || c.salePrice || 0;

  // è²·ä»˜ãƒ»æ¥­è€…ç¢ºèªã‹ã‚‰å¼•ç”¨
  const defBuyerName = c.buyer?.name    || '';
  const defBuyerTakken = c.buyer?.takkenNum || '';
  const defProp = inv.prop || c.dates?.naikenProp || '';
  const defCommBuyCo  = sn.commBuyCo  || '';
  const defCommSellCo = sn.commSellCo || '';
  const defCommBuyAmt  = sn.commBuyAmt  || 0;
  const defCommSellAmt = sn.commSellAmt || 0;

  // ç´¹ä»‹è€…ãƒªã‚¹ãƒˆï¼ˆè²·ä»˜ã®æ¥­å‹™å§”è¨—ã‹ã‚‰å¼•ç”¨ or å¥‘ç´„ã§ä¸Šæ›¸ãï¼‰
  const referrers = sc.referrers || (sn.delegPay||[]).map(r=>({
    name: r.co||'', type: r.type||'other', amt: r.amt||0, note:''
  }));

  // ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸ã‚µãƒãƒªãƒ¼
  let invBadge = '';
  if (inv.issued) {
    invBadge = '<div style="margin-bottom:12px;padding:8px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px;font-size:11px;display:flex;justify-content:space-between;align-items:center">'
      +'<span style="color:var(--gold);font-weight:700">ğŸ§¾ è«‹æ±‚æ›¸ç™ºè¡Œæ¸ˆ</span>'
      +'<span style="display:flex;gap:12px">'
      +(inv.buyerTotal?'<span style="color:var(--blue)">è²·ä¸» Â¥'+parseInt(inv.buyerTotal).toLocaleString()+'</span>':'')
      +(inv.hasSellerComm&&inv.sellerTotal?'<span style="color:var(--green)">å£²ä¸» Â¥'+parseInt(inv.sellerTotal).toLocaleString()+'</span>':'')
      +'</span>'
      +'<button onclick="editInvoice(\''+id+'\')" style="background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);border-radius:5px;padding:2px 8px;cursor:pointer;font-size:10px">âœ ä¿®æ­£</button>'
      +'</div>';
  }

  // ä»²ä»‹æ¥­è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆ
  function brokerSection(side, label, color, defCo, defAmt, savedCo, savedPerson, savedAmt, toggleKey, savedToggle) {
    const show = savedToggle !== undefined ? savedToggle : !!defCo;
    const co   = savedCo     !== undefined ? savedCo     : defCo;
    const amt  = savedAmt    !== undefined ? savedAmt    : defAmt;
    return '<div style="border:1px solid rgba('+color+',.2);border-radius:10px;overflow:hidden;margin-bottom:8px">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba('+color+',.05)">'
      +'<span style="font-size:11px;font-weight:700;color:rgba('+color+',1)">ğŸ¤ '+label+'ä»²ä»‹æ¥­è€…</span>'
      +'<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:10px;color:var(--sub)">'
      +'<input type="checkbox" id="sn-ct-'+side+'-toggle"'+(show?' checked':'')+' onchange="sannaiCtToggle(\''+id+'\')"> ã‚ã‚Š'
      +'</label>'
      +'</div>'
      +(show ? (
        '<div style="padding:10px 12px">'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px">'
        +'<div class="fi" style="margin:0"><label>ä¼šç¤¾å</label><input type="text" id="sn-ct-'+side+'-co" value="'+co+'" placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡ä¸å‹•ç”£"></div>'
        +'<div class="fi" style="margin:0"><label>æ‹…å½“è€…å</label><input type="text" id="sn-ct-'+side+'-person" value="'+(savedPerson||'')+'" placeholder="å±±ç”° å¤ªéƒ"></div>'
        +'</div>'
        +'<div class="fi" style="margin:0"><label>ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆç¨è¾¼ï¼‰</label>'
        +'<input type="text" id="sn-ct-'+side+'-amt" class="mono" value="'+(amt?fmtYen(amt):'')+'" oninput="invSalePriceInput(this)" placeholder="0" style="font-size:13px"></div>'
        +'</div>'
      ) : '<div style="padding:6px 12px 10px;font-size:11px;color:var(--muted)">ãªã—</div>')
      +'</div>';
  }

  // å£²ã‚Šå´ä»²ä»‹
  const sellBrokerHtml = brokerSection(
    'sell', 'å£²ã‚Šå´', '52,211,153',
    defCommSellCo, defCommSellAmt,
    sc.sellBrokerCo, sc.sellBrokerPerson, sc.sellBrokerAmt,
    'sell', sc.hasSellBroker
  );
  // è²·ã„å´ä»²ä»‹
  const buyBrokerHtml = brokerSection(
    'buy', 'è²·ã„å´', '79,156,249',
    defCommBuyCo, defCommBuyAmt,
    sc.buyBrokerCo, sc.buyBrokerPerson, sc.buyBrokerAmt,
    'buy', sc.hasBuyBroker
  );

  // ç´¹ä»‹è€…è¡Œ
  function referrerRow(i, r) {
    const typeOpts = [
      {v:'company', label:'æ¥­è€…'},
      {v:'person',  label:'å€‹äºº'},
    ];
    return '<div class="sn-referrer-row" data-idx="'+i+'" style="background:rgba(167,139,250,.04);border:1px solid rgba(167,139,250,.15);border-radius:8px;padding:10px 12px;margin-bottom:6px">'
      +'<div style="display:grid;grid-template-columns:1fr 80px;gap:6px;margin-bottom:6px">'
      +'<div class="fi" style="margin:0"><label>æ°å / ä¼šç¤¾å</label><input type="text" class="sn-ref-name" placeholder="ç´¹ä»‹è€…å" value="'+(r.name||'')+'"></div>'
      +'<div class="fi" style="margin:0"><label>ç¨®åˆ¥</label><select class="sn-ref-type" style="background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:5px 6px;color:var(--text);font-size:11px;font-family:inherit;width:100%">'
      +typeOpts.map(o=>'<option value="'+o.v+'"'+(r.type===o.v?' selected':'')+'>'+o.label+'</option>').join('')
      +'</select></div>'
      +'</div>'
      +'<div style="display:grid;grid-template-columns:1fr 1fr auto;gap:6px;align-items:end">'
      +'<div class="fi" style="margin:0"><label>æ¥­å‹™å§”è¨—è²»ç”¨ï¼ˆç¨è¾¼ï¼‰</label><input type="text" class="sn-ref-amt mono" placeholder="0" value="'+(r.amt?fmtYen(r.amt):'')+'" oninput="invSalePriceInput(this)" style="font-size:13px"></div>'
      +'<div class="fi" style="margin:0"><label>å‚™è€ƒ</label><input type="text" class="sn-ref-note" placeholder="ç´¹ä»‹çµŒè·¯ãªã©" value="'+(r.note||'')+'"></div>'
      +'<button onclick="this.closest(\'.sn-referrer-row\').remove()" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0;flex-shrink:0;margin-bottom:0">Ã—</button>'
      +'</div>'
      +'</div>';
  }

  const referrerRowsHtml = referrers.map((r,i)=>referrerRow(i,r)).join('');

  // å•†æµãƒ•ãƒ­ãƒ¼å›³
  const flowHtml = sannaiFlowDiagram(c, sc, sn);

  return '<div class="step-title">âœï¸ å£²è²·å¥‘ç´„ï¼ˆä¸‰ç‚ºï¼‰</div>'
    + invBadge

    // åŸºæœ¬æƒ…å ±
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'
    +'<div class="fi"><label>å¥‘ç´„æ—¥</label><input type="date" id="sn-ct-date" class="mono" value="'+(sc.contractDate||todayISO())+'"></div>'
    +'<div class="fi"><label>æ±ºæ¸ˆäºˆå®šæ—¥</label><input type="date" id="sn-ct-settle" class="mono" value="'+(sc.settleDate||'')+'"></div>'
    +'</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="sn-ct-prop" value="'+defProp+'" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·"></div>'

    // å£²ä¸»
    +'<div style="border:1px solid rgba(251,146,60,.2);border-radius:10px;overflow:hidden;margin-bottom:8px">'
    +'<div style="padding:10px 12px;background:rgba(251,146,60,.05)">'
    +'<span style="font-size:11px;font-weight:700;color:var(--orange)">ğŸ  å£²ä¸»</span>'
    +'<span style="font-size:10px;color:var(--muted);margin-left:8px">ä»•å…¥ã‚Œä¾¡æ ¼'+(bp?': Â¥'+bp.toLocaleString():' â€” æœªå…¥åŠ›')+'</span>'
    +'</div>'
    +'<div style="padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px">'
    +'<div class="fi" style="margin:0"><label>ä¼šç¤¾å / æ°å</label><input type="text" id="sn-ct-seller-name" value="'+(sc.sellerName||'')+'" placeholder="å£²ä¸»å"></div>'
    +'<div class="fi" style="margin:0"><label>æ‹…å½“è€…å</label><input type="text" id="sn-ct-seller-person" value="'+(sc.sellerPerson||'')+'" placeholder="æ‹…å½“è€…"></div>'
    +'</div>'
    +'</div>'

    // å£²ã‚Šå´ä»²ä»‹
    + sellBrokerHtml

    // COREBLDGï¼ˆè‡ªç¤¾ï¼‰
    +'<div style="border:1px solid rgba(201,168,76,.4);border-radius:10px;padding:10px 12px;margin-bottom:8px;background:rgba(201,168,76,.06);text-align:center">'
    +'<div style="font-size:11px;font-weight:700;color:var(--gold)">ğŸ¢ COREBLDGï¼ˆè‡ªç¤¾ï¼‰</div>'
    +(bp&&sp?'<div style="font-size:10px;color:var(--muted);margin-top:3px">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰: '+(sp-bp>=0?'+':'')+'Â¥'+(sp-bp).toLocaleString()+'</div>':'')
    +'</div>'

    // è²·ã„å´ä»²ä»‹
    + buyBrokerHtml

    // è²·ä¸»
    +'<div style="border:1px solid rgba(79,156,249,.2);border-radius:10px;overflow:hidden;margin-bottom:8px">'
    +'<div style="padding:10px 12px;background:rgba(79,156,249,.05)">'
    +'<span style="font-size:11px;font-weight:700;color:var(--blue)">ğŸ‘¤ è²·ä¸»</span>'
    +'<span style="font-size:10px;color:var(--muted);margin-left:8px">è²©å£²ä¾¡æ ¼'+(sp?': Â¥'+sp.toLocaleString():' â€” æœªå…¥åŠ›')+'</span>'
    +'</div>'
    +'<div style="padding:10px 12px">'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px">'
    +'<div class="fi" style="margin:0"><label>ä¼šç¤¾å / æ°å</label><input type="text" id="sn-ct-buyer-name" value="'+(sc.buyerName||defBuyerName)+'" placeholder="è²·ä¸»å"></div>'
    +'<div class="fi" style="margin:0"><label>æ‹…å½“è€…å</label><input type="text" id="sn-ct-buyer-person" value="'+(sc.buyerPerson||'')+'" placeholder="æ‹…å½“è€…"></div>'
    +'</div>'
    +(defBuyerTakken?'<div style="font-size:10px;color:var(--muted)">å®…å»ºç•ªå·: '+defBuyerTakken+'</div>':'')
    +'</div>'
    +'</div>'

    // ç´¹ä»‹è€…
    +'<div style="border:1px solid rgba(167,139,250,.2);border-radius:10px;overflow:hidden;margin-bottom:12px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(167,139,250,.05)">'
    +'<span style="font-size:11px;font-weight:700;color:var(--purple)">ğŸ”— ç´¹ä»‹è€…</span>'
    +'<button data-cid="'+id+'" onclick="sannaiAddReferrer(this.dataset.cid)" style="background:rgba(167,139,250,.15);border:1px solid rgba(167,139,250,.3);color:var(--purple);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">ï¼‹ è¿½åŠ </button>'
    +'</div>'
    +'<div id="sn-referrer-list" style="padding:'+(referrers.length?'8px 8px 2px':'0')+' 8px">'
    + referrerRowsHtml
    +'</div>'
    +(referrers.length===0?'<div style="padding:6px 12px 10px;font-size:11px;color:var(--muted)">ãªã—</div>':'')
    +'</div>'

    // å•†æµå›³
    +'<div style="margin-bottom:12px">'
    +'<div style="font-size:10px;color:var(--muted);font-weight:600;letter-spacing:.8px;margin-bottom:8px">ğŸ“Š å•†æµ</div>'
    +'<div id="sn-flow-diagram">' + flowHtml + '</div>'
    +'</div>'

    +'<button class="btn btn-green" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="sannaiContractDone(this.dataset.cid)">âœ“ å¥‘ç´„ç· çµ â†’ æ±ºæ¸ˆã¸</button>';
}

// â”€â”€ å•†æµãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ  â”€â”€
function sannaiFlowDiagram(c, sc, sn) {
  const bp = sn.buyPrice  || 0;
  const sp = sn.sellPrice || c.salePrice || 0;

  const hasSellBroker = document.getElementById('sn-ct-sell-toggle')?.checked
    ?? (sc.hasSellBroker ?? !!sn.commSellCo);
  const hasBuyBroker  = document.getElementById('sn-ct-buy-toggle')?.checked
    ?? (sc.hasBuyBroker  ?? !!sn.commBuyCo);
  const sellBrokerCo  = sc.sellBrokerCo  || sn.commSellCo || 'å£²ã‚Šå´ä»²ä»‹';
  const buyBrokerCo   = sc.buyBrokerCo   || sn.commBuyCo  || 'è²·ã„å´ä»²ä»‹';
  const sellerName    = sc.sellerName    || 'å£²ä¸»';
  const buyerName     = sc.buyerName     || c.buyer?.name || 'è²·ä¸»';
  const referrers     = sc.referrers     || (sn.delegPay||[]).map(r=>({name:r.co||'ç´¹ä»‹è€…',amt:r.amt||0}));

  const node = (label, sub, color, bold) =>
    '<div style="background:rgba('+color+',.08);border:1px solid rgba('+color+',.35);border-radius:8px;padding:6px 10px;text-align:center;min-width:80px">'
    +'<div style="font-size:'+(bold?'11':'10')+'px;font-weight:'+(bold?700:600)+';color:rgba('+color+',1)">'+label+'</div>'
    +(sub?'<div style="font-size:9px;color:var(--muted);margin-top:1px">'+sub+'</div>':'')
    +'</div>';

  const arrow = (label, color) =>
    '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;min-width:28px">'
    +'<div style="font-size:9px;color:rgba('+color+',.8);margin-bottom:2px">'+label+'</div>'
    +'<div style="height:1px;background:rgba('+color+',.4);width:100%;position:relative">'
    +'<div style="position:absolute;right:-1px;top:-4px;border-left:6px solid rgba('+color+',.5);border-top:4px solid transparent;border-bottom:4px solid transparent"></div>'
    +'</div>'
    +'</div>';

  // ãƒ¡ã‚¤ãƒ³å•†æµï¼ˆæ¨ªä¸¦ã³ï¼‰
  let mainFlow = '<div style="display:flex;align-items:center;gap:4px;margin-bottom:8px;flex-wrap:nowrap;overflow-x:auto;padding-bottom:4px">';
  mainFlow += node(sellerName, bp?'Â¥'+bp.toLocaleString():'', '251,146,60', false);
  if (hasSellBroker) {
    mainFlow += arrow('å£²ä¸»â†’', '52,211,153');
    mainFlow += node(sellBrokerCo, sn.commSellAmt?'-Â¥'+sn.commSellAmt.toLocaleString():'', '52,211,153', false);
  }
  mainFlow += arrow(hasSellBroker?'â†’è‡ªç¤¾':'å£²ä¸»â†’', '201,168,76');
  mainFlow += node('COREBLDG', (bp&&sp)?'å·®Â¥'+(sp-bp).toLocaleString():'', '201,168,76', true);
  if (hasBuyBroker) {
    mainFlow += arrow('â†’', '79,156,249');
    mainFlow += node(buyBrokerCo, sn.commBuyAmt?'-Â¥'+sn.commBuyAmt.toLocaleString():'', '79,156,249', false);
  }
  mainFlow += arrow(hasBuyBroker?'â†’':'â†’', '79,156,249');
  mainFlow += node(buyerName, sp?'Â¥'+sp.toLocaleString():'', '79,156,249', false);
  mainFlow += '</div>';

  // ç´¹ä»‹è€…ï¼ˆç¸¦ãƒªã‚¹ãƒˆï¼‰
  let refFlow = '';
  if (referrers.length > 0) {
    refFlow = '<div style="border-top:1px solid var(--border);padding-top:8px;margin-top:4px">'
      +'<div style="font-size:9px;color:var(--muted);margin-bottom:6px;font-weight:600">ğŸ”— ç´¹ä»‹è€…ï¼ˆæ¥­å‹™å§”è¨—ï¼‰</div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:6px">';
    referrers.forEach(r => {
      refFlow += '<div style="display:flex;align-items:center;gap:6px;background:rgba(167,139,250,.06);border:1px solid rgba(167,139,250,.2);border-radius:6px;padding:5px 10px;font-size:10px">'
        +'<span style="color:var(--purple);font-weight:600">'+(r.name||'â€”')+'</span>'
        +(r.amt?'<span style="color:var(--muted)">æ¥­å‹™å§”è¨—</span><span class="mono" style="color:var(--orange)">-Â¥'+parseInt(r.amt).toLocaleString()+'</span>':'')
        +'</div>';
    });
    refFlow += '</div></div>';
  }

  return mainFlow + refFlow;
}

// â”€â”€ ä»²ä»‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ‡æ›¿ â”€â”€
function sannaiCtToggle(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  sannaiContractSave(c);
  open_case(id);
}

// â”€â”€ ç´¹ä»‹è€…è¿½åŠ  â”€â”€
function sannaiAddReferrer(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  sannaiContractSave(c);
  if(!c.sannaiContract) c.sannaiContract={};
  if(!c.sannaiContract.referrers) c.sannaiContract.referrers=[];
  c.sannaiContract.referrers.push({name:'', type:'company', amt:0, note:''});
  open_case(id);
}

// â”€â”€ ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ â”€â”€
function sannaiContractSave(c) {
  if(!c.sannaiContract) c.sannaiContract={};
  const sc = c.sannaiContract;

  sc.contractDate   = document.getElementById('sn-ct-date')?.value   || sc.contractDate  || '';
  sc.settleDate     = document.getElementById('sn-ct-settle')?.value  || sc.settleDate    || '';
  sc.prop           = document.getElementById('sn-ct-prop')?.value    || sc.prop          || '';
  sc.sellerName     = document.getElementById('sn-ct-seller-name')?.value   || sc.sellerName  || '';
  sc.sellerPerson   = document.getElementById('sn-ct-seller-person')?.value || sc.sellerPerson|| '';
  sc.buyerName      = document.getElementById('sn-ct-buyer-name')?.value    || sc.buyerName   || '';
  sc.buyerPerson    = document.getElementById('sn-ct-buyer-person')?.value  || sc.buyerPerson || '';

  sc.hasSellBroker  = document.getElementById('sn-ct-sell-toggle')?.checked ?? sc.hasSellBroker;
  sc.hasBuyBroker   = document.getElementById('sn-ct-buy-toggle')?.checked  ?? sc.hasBuyBroker;
  sc.sellBrokerCo   = document.getElementById('sn-ct-sell-co')?.value     || sc.sellBrokerCo   || '';
  sc.sellBrokerPerson=document.getElementById('sn-ct-sell-person')?.value  || sc.sellBrokerPerson|| '';
  sc.sellBrokerAmt  = parseInt((document.getElementById('sn-ct-sell-amt')?.value||'').replace(/,/g,''))||sc.sellBrokerAmt||0;
  sc.buyBrokerCo    = document.getElementById('sn-ct-buy-co')?.value      || sc.buyBrokerCo    || '';
  sc.buyBrokerPerson= document.getElementById('sn-ct-buy-person')?.value  || sc.buyBrokerPerson || '';
  sc.buyBrokerAmt   = parseInt((document.getElementById('sn-ct-buy-amt')?.value||'').replace(/,/g,''))||sc.buyBrokerAmt||0;

  // ç´¹ä»‹è€…
  const rows = document.querySelectorAll('.sn-referrer-row');
  if(rows.length > 0) {
    sc.referrers = [];
    rows.forEach(row => {
      const name = row.querySelector('.sn-ref-name')?.value.trim()||'';
      const type = row.querySelector('.sn-ref-type')?.value||'company';
      const amt  = parseInt((row.querySelector('.sn-ref-amt')?.value||'').replace(/,/g,''))||0;
      const note = row.querySelector('.sn-ref-note')?.value.trim()||'';
      if(name||amt) sc.referrers.push({name, type, amt, note});
    });
  }
}

function sannaiContractDone(id) {
  try {
    const c = CASES.find(x=>x.id===id); if(!c) return;
    sannaiContractSave(c);
    const sc = c.sannaiContract || {};
    const d  = sc.contractDate || todayISO();
    c.hist.unshift(today()+' å£²è²·å¥‘ç´„ç· çµ'
      +(sc.sellerName?' å£²ä¸»:'+sc.sellerName:'')
      +(sc.buyerName?' è²·ä¸»:'+sc.buyerName:''));
    advance(id,'settlement','contract',d,'å£²è²·å¥‘ç´„ç· çµ â†’ æ±ºæ¸ˆã¸');
  } catch(e){ console.error('sannaiContractDone:',e); }
}

function stepSaleContract(c) {
  const inv = c.invoice||{};
  const fromLabel = inv.saleFrom==='both'?'ä¸¡æ‰‹ï¼ˆå£²ä¸»ï¼‹è²·ä¸»ï¼‰':inv.saleFrom==='buyer'?'è²·ä¸»ã‹ã‚‰':'å£²ä¸»ã‹ã‚‰';

  // ä¸‰ç‚ºã®å ´åˆ: å–å¼•æ¦‚è¦ã‚µãƒãƒªãƒ¼ã‚’å…ˆé ­ã«è¡¨ç¤º
  let sannaiCostSummary = '';
  if (c.type === 'sannai') {
    const sn = c.sannai || {};
    const bp = sn.buyPrice || 0;
    const sp = sn.sellPrice || c.salePrice || 0;
    const spread = sp - bp;
    const commBuyAmt  = sn.commBuyAmt  || 0;
    const commSellAmt = sn.commSellAmt || 0;
    const delegTotal  = (sn.delegPay||[]).reduce((s,r)=>s+(r.amt||0),0);
    const totalOut = commBuyAmt + commSellAmt + delegTotal;
    const profit = spread - totalOut;

    if (bp || sp || totalOut) {
      sannaiCostSummary = '<div style="margin-bottom:12px;padding:12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:10px;font-size:11px">'
        +'<div style="font-size:10px;color:var(--gold);font-weight:700;letter-spacing:.8px;margin-bottom:8px">ğŸ“Š å–å¼•æ¦‚è¦</div>'
        +'<div style="display:grid;grid-template-columns:auto 1fr;gap:3px 12px;line-height:1.9">';
      if(bp) sannaiCostSummary += '<span style="color:var(--muted)">ä»•å…¥ã‚Œä¾¡æ ¼</span><span class="mono" style="color:var(--sub)">Â¥'+bp.toLocaleString()+'</span>';
      if(sp) sannaiCostSummary += '<span style="color:var(--muted)">è²©å£²ä¾¡æ ¼</span><span class="mono" style="color:var(--sub)">Â¥'+sp.toLocaleString()+'</span>';
      if(bp&&sp) {
        const sc = spread>=0?'var(--green)':'var(--red)';
        sannaiCostSummary += '<span style="color:var(--muted)">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰</span><span class="mono" style="color:'+sc+';font-weight:700">'+(spread>=0?'+':'')+'Â¥'+spread.toLocaleString()+'</span>';
      }
      if(sn.commPayMode && sn.commPayMode!=='none') {
        sannaiCostSummary += '<span style="color:var(--border2);grid-column:1/-1;border-top:1px solid var(--border);margin:3px 0"></span>';
        if(commBuyAmt) sannaiCostSummary += '<span style="color:var(--muted)">è²·ã„å´ä»²ä»‹æ‰‹æ•°æ–™ ('+(sn.commBuyCo||'â€”')+')</span><span class="mono" style="color:var(--orange)">-Â¥'+commBuyAmt.toLocaleString()+'</span>';
        if(commSellAmt) sannaiCostSummary += '<span style="color:var(--muted)">å£²ã‚Šå´ä»²ä»‹æ‰‹æ•°æ–™ ('+(sn.commSellCo||'â€”')+')</span><span class="mono" style="color:var(--orange)">-Â¥'+commSellAmt.toLocaleString()+'</span>';
      }
      if((sn.delegPay||[]).length > 0) {
        (sn.delegPay||[]).forEach(r => {
          const typeLabel = r.type==='broker'?'ä»²ä»‹ä¼šç¤¾':'ãã®ä»–';
          sannaiCostSummary += '<span style="color:var(--muted)">æ¥­å‹™å§”è¨— '+typeLabel+' ('+(r.co||'â€”')+')</span><span class="mono" style="color:var(--purple)">-Â¥'+(r.amt||0).toLocaleString()+'</span>';
        });
      }
      if(totalOut > 0) {
        sannaiCostSummary += '<span style="color:var(--border2);grid-column:1/-1;border-top:1px solid var(--border);margin:3px 0"></span>';
        const pc = profit>=0?'var(--green)':'var(--red)';
        sannaiCostSummary += '<span style="color:var(--text);font-weight:700">æ¦‚ç®—ç²—åˆ©</span><span class="mono" style="color:'+pc+';font-weight:700;font-size:13px">'+(profit>=0?'+':'')+'Â¥'+profit.toLocaleString()+'</span>';
      }
      sannaiCostSummary += '</div>'
        +'<button onclick="open_case(\''+c.id+'\')" style="display:none" id="sn-back-offer"></button>'
        +'<div style="margin-top:8px;text-align:right">'
        +'<a href="#" onclick="editSannaiOffer(\''+c.id+'\')" style="font-size:10px;color:var(--muted);text-decoration:none">âœ å–å¼•æ¦‚è¦ã‚’ä¿®æ­£</a>'
        +'</div>'
        +'</div>';
    }
  }

  let invSummary = '';
  if (inv.issued) {
    if (c.type === 'sannai') {
      invSummary = '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px;font-size:11px">'
        +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
        +'<span style="color:var(--gold);font-weight:700">ğŸ§¾ ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸ï¼ˆä¸‰ç‚ºï¼‰</span>'
        +'<button onclick="editInvoice(\\\''+c.id+'\\\')" style="background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);border-radius:5px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">âœ ä¿®æ­£</button>'
        +'</div>'
        +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub);font-size:11px">'
        +(inv.prop?'<span>ç‰©ä»¶</span><span style="color:var(--text)">'+inv.prop+'</span>':'')
        +(inv.sellPrice?'<span>è²©å£²ä¾¡æ ¼</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.sellPrice).toLocaleString()+'</span>':'')
        +(inv.buyPrice?'<span>ä»•å…¥ã‚Œä¾¡æ ¼</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.buyPrice).toLocaleString()+'</span>':'')
        +(inv.buyerTotal?'<span>ğŸ“„ è²·ä¸»å‘ã‘</span><span class="mono" style="color:var(--blue);font-weight:700">Â¥'+parseInt(inv.buyerTotal).toLocaleString()+'</span>':'')
        +(inv.hasSellerComm&&inv.sellerTotal?'<span>ğŸ“„ å£²ä¸»å‘ã‘</span><span class="mono" style="color:var(--green);font-weight:700">Â¥'+parseInt(inv.sellerTotal).toLocaleString()+'</span>':'')
        +(inv.grandTotal?'<span style="font-weight:700">è«‹æ±‚ç·è¨ˆ</span><span class="mono" style="color:var(--gold);font-weight:700">Â¥'+parseInt(inv.grandTotal).toLocaleString()+'</span>':'')
        +'</div></div>';
    } else {
      invSummary = '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px;font-size:11px">'
        +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
        +'<span style="color:var(--gold);font-weight:700">ğŸ§¾ ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸</span>'
        +'<button onclick="editInvoice(\\\''+c.id+'\\\')" style="background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);border-radius:5px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">âœ ä¿®æ­£</button>'
        +'</div>'
        +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub);font-size:11px">'
        +(inv.prop?'<span>ç‰©ä»¶</span><span style="color:var(--text)">'+inv.prop+'</span>':'')
        +'<span>å—é ˜å…ˆ</span><span style="color:var(--text)">'+fromLabel+'</span>'
        +(inv.salePrice?'<span>å£²è²·ä¾¡æ ¼</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.salePrice).toLocaleString()+'</span>':'')
        +(inv.totalA?'<span>å£²ä¸»å‘ã‘</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.totalA).toLocaleString()+'</span>':'')
        +(inv.totalB?'<span>è²·ä¸»å‘ã‘</span><span class="mono" style="color:var(--blue)">Â¥'+parseInt(inv.totalB).toLocaleString()+'</span>':'')
        +(inv.delegAmt?'<span>æ¥­å‹™å§”è¨—</span><span class="mono" style="color:var(--text)">Â¥'+parseInt(inv.delegAmt).toLocaleString()+'</span>':'')
        +(inv.grandTotal?'<span style="font-weight:700">åˆè¨ˆ</span><span class="mono" style="color:var(--gold);font-weight:700">Â¥'+parseInt(inv.grandTotal).toLocaleString()+'</span>':'')
        +'</div></div>';
    }
  }
  return sannaiCostSummary + '<div class="step-title">âœï¸ å£²è²·å¥‘ç´„</div>'
    +invSummary
    +'<div class="row" style="margin-bottom:12px">'
    +'<button class="btn btn-blue" onclick="window.open(\'coreto-sale-report.html\',\'_blank\')">å£²è²·å ±å‘Šæ›¸ã‚’é–‹ã</button>'
    +'</div>'
    +'<button class="btn btn-green" style="width:100%;justify-content:center" data-cid="'+c.id+'" onclick="saleContractDone(this.dataset.cid)">âœ“ å¥‘ç´„ç· çµ â†’ æ±ºæ¸ˆã¸</button>';
}

function stepSettlement(c) {
  const today = new Date().toISOString().slice(0,10);
  const val = c.dates.settlement || today;
  return '<div class="step-title">ğŸ’´ æ±ºæ¸ˆãƒ»å¼•æ¸¡ã—</div>'
    +'<div class="fi"><label>æ±ºæ¸ˆæ—¥</label><input type="date" id="s-settlement" class="mono" value="'+val+'"></div>'
    +'<button class="btn btn-green" style="width:100%;justify-content:center;margin-top:12px" data-cid="'+c.id+'" onclick="settlementDone(this.dataset.cid)">âœ“ æ±ºæ¸ˆå®Œäº† â†’ æˆç´„</button>';
}

// â”€â”€ Sub components â”€â”€
function appsHTML(c) {
  return c.apps.map(a=>{
    const s = a.status;
    const pill = s==='reviewing'?'<span class="pill pill-orange">å¯©æŸ»ä¸­</span>'
      :s==='approved'?'<span class="pill pill-green">é€šé</span>'
      :s==='rejected'?'<span class="pill pill-red">è½ã¡</span>'
      :s==='cancelled'?'<span class="pill pill-muted">å–æ¶ˆ</span>'
      :'<span class="pill pill-blue">æå‡ºæ¸ˆ</span>';
    return '<div class="app-item" style="margin-bottom:6px">'
      +'<div class="app-name"><span>'+a.prop+'</span>'+pill+(a.sim?' <span class="pill pill-orange">åŒæ™‚</span>':'')+'</div>'
      +'<div class="app-meta">'+a.mgmt+' Â· '+a.date+'</div>'
      +'</div>';
  }).join('');
}

function histHTML(c) {
  if (!c.hist||!c.hist.length) return '';
  return '<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">'
    +'<div style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:1.5px;margin-bottom:10px">æ´»å‹•å±¥æ­´</div>'
    +c.hist.map((h,i)=>'<div class="hist-item">'
      +'<div><div class="hist-dot'+(i===0?' cur':'')+'"></div>'+(i<c.hist.length-1?'<div class="hist-line"></div>':'')+'</div>'
      +'<div style="font-size:11px;color:var(--sub);padding:0 0 4px 8px">'+h+'</div>'
      +'</div>').join('')
    +'<div style="display:flex;gap:6px;margin-top:8px">'
    +'<input type="text" id="memo-inp" placeholder="ãƒ¡ãƒ¢è¿½åŠ ..." style="flex:1;background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:6px 10px;color:var(--text);font-size:11px;font-family:inherit;outline:none" onkeydown="if(event.key===\'Enter\')addMemo(\''+c.id+'\')">'
    +'<button class="btn btn-ghost btn-sm" onclick="addMemo(\''+c.id+'\')">è¿½åŠ </button>'
    +'</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function today() { return new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'}); }
function todayISO() { return new Date().toISOString().slice(0,10); }

function advance(id, nextStep, dateKey, dateVal, memo) {
  try {
    const c = CASES.find(x=>x.id===id);
    if(!c) { console.error('advance: case not found', id); return; }
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    c.step = nextStep;
    c.age  = 0;
    if (dateKey) c.dates[dateKey] = dateVal || todayISO();
    if (memo) c.hist.unshift(today()+' '+memo);
    open_case(id);
    toast(memo||'æ›´æ–°ã—ã¾ã—ãŸ');
  } catch(e) {
    console.error('advance error:', e);
    toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: '+e.message);
  }
}

function naikenDone(id) {
  const c = CASES.find(x=>x.id===id);
  const d = document.getElementById('s-naiken-date')?.value || todayISO();
  const p = document.getElementById('s-naiken-prop')?.value.trim() || '';
  c.dates.naiken = d;
  if(p) c.dates.naikenProp = p;
  advance(id, 'apply', null, null, 'å†…è¦‹å®Œäº†');
}
function naikenSkip(id) {
  if(!confirm('è¦‹é€ã‚Šã«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  advance(id, 'cancel', null, null, 'è¦‹é€ã‚Šï¼ˆå†…è¦‹å¾Œï¼‰');
}

function submitApply(id) {
  const prop = document.getElementById('s-prop')?.value.trim();
  const mgmt = document.getElementById('s-mgmt')?.value.trim();
  const date = document.getElementById('s-apply-date')?.value || todayISO();
  if(!prop||!mgmt){alert('ç‰©ä»¶åã¨ç®¡ç†ä¼šç¤¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const c = CASES.find(x=>x.id===id);
  c.apps.push({id:'A'+Date.now().toString().slice(-5), prop, mgmt, date, status:'reviewing'});
  c.dates.applied = date;
  advance(id, 'screening', null, null, prop+' ç”³è¾¼');
}

function addApp(id) {
  const c = CASES.find(x=>x.id===id);
  const activeCount = c.apps.filter(a=>a.status==='reviewing'||a.status==='submitted').length;
  openModal(
    'ï¼‹ ç”³è¾¼è¿½åŠ '
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="m-prop" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 1LDK"></div>'
    +'<div class="fi"><label>ç®¡ç†ä¼šç¤¾</label><input type="text" id="m-mgmt" placeholder="ã€‡ã€‡ç®¡ç†æ ªå¼ä¼šç¤¾"></div>'
    +(activeCount>0?'<div style="margin:10px 0 4px"><label style="display:flex;align-items:center;gap:7px;font-size:11px;cursor:pointer"><input type="checkbox" id="m-sim" checked> åŒæ™‚ç”³è¾¼ã¨ã—ã¦ãƒãƒ¼ã‚¯</label></div>':'')
    +'<div class="row" style="margin-top:14px"><button class="btn btn-ghost" style="flex:1" onclick="closeModal()">æˆ»ã‚‹</button>'
    +'<button class="btn btn-green" style="flex:2;justify-content:center" onclick="doAddApp(\''+id+'\')">ç”³è¾¼è¿½åŠ </button></div>'
  );
}

function doAddApp(id) {
  const prop = document.getElementById('m-prop')?.value.trim();
  const mgmt = document.getElementById('m-mgmt')?.value.trim();
  const sim  = document.getElementById('m-sim')?.checked || false;
  if(!prop||!mgmt){alert('å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const c = CASES.find(x=>x.id===id);
  c.apps.push({id:'A'+Date.now().toString().slice(-5), prop, mgmt, date:todayISO(), status:'reviewing', sim});
  c.hist.unshift(today()+' '+prop+' ç”³è¾¼è¿½åŠ '+(sim?' (åŒæ™‚)':''));
  closeModal();
  open_case(id);
  toast('ç”³è¾¼è¿½åŠ ã—ã¾ã—ãŸ');
}

function appPassed(id, appId) {
  const c = CASES.find(x=>x.id===id);
  const a = c.apps.find(a=>a.id===appId);
  if(!a) return;
  a.status = 'approved';
  // cancel other reviewing apps
  c.apps.filter(x=>x.id!==appId&&(x.status==='reviewing'||x.status==='submitted')).forEach(x=>{x.status='cancelled';});
  if(!c.taskDone) c.taskDone={paid:false,itsetsu:false};
  advance(id, 'invoice', 'approved', todayISO(), a.prop+' å¯©æŸ»é€šé â†’ è«‹æ±‚æ›¸ç™ºè¡Œã¸');
}

function appRejected(id, appId) {
  const c = CASES.find(x=>x.id===id);
  const a = c.apps.find(a=>a.id===appId);
  if(!a) return;
  a.status = 'rejected';
  c.hist.unshift(today()+' '+a.prop+' å¯©æŸ»è½ã¡');
  const remaining = c.apps.filter(x=>x.status==='reviewing'||x.status==='submitted');
  if(remaining.length===0) c.hist.unshift(today()+' å…¨ç‰©ä»¶è½ã¡ â†’ åˆ¥ç‰©ä»¶è¿½åŠ ã—ã¦ãã ã•ã„');
  open_case(id);
}

function stepInvoice(c) {
  if (c.type==='sannai') return stepInvoiceSannai(c);
  const isSale = c.type==='reSale';
  if (isSale) return stepInvoiceSale(c);

  const app = c.apps.find(a=>a.status==='approved') || c.apps[c.apps.length-1] || {};
  const now = new Date();
  const due = new Date(now.getTime()+30*864e5).toISOString().slice(0,10);
  const ym = now.getFullYear()+String(now.getMonth()+1).padStart(2,'0');
  const invNumComm   = 'INV-'+ym+'-'+c.agent+'-A';
  const invNumAD     = 'INV-'+ym+'-'+c.agent+'-B';
  const invNumSingle = 'INV-'+ym+'-'+c.agent;
  const rentMatch = (c.sub||'').match(/Â¥([\d,]+)/);
  const rentGuess = rentMatch ? rentMatch[1].replace(/,/g,'') : '';
  const inv = c.invoice || {};
  const prevRent   = inv.rent   || rentGuess;
  const prevType   = inv.type   || 'commission';
  const prevFmt    = inv.adFmt  || null;
  const prevItems  = inv.items  || [{desc:'ä»²ä»‹æ‰‹æ•°æ–™',amt:''}];
  const prevAdAmt  = inv.adAmt  || '';
  const prevReason = inv.underReason || '';
  const id = c.id;

  const tabs = [
    {v:'commission', label:'ä»²ä»‹æ‰‹æ•°æ–™ã®ã¿'},
    {v:'ad_plus',    label:'ADï¼‹ä»²ä»‹æ‰‹æ•°æ–™'},
    {v:'ad_only',    label:'ADã®ã¿'},
  ];
  const tabHtml = tabs.map(t=>{
    const active = prevType===t.v;
    const bg = active ? 'background:var(--gold);color:#000' : 'background:var(--card2);color:var(--sub)';
    return '<button onclick="invSetType(this)" data-cid="'+id+'" data-type="'+t.v+'" style="flex:1;padding:7px 4px;border:none;cursor:pointer;font-size:11px;font-weight:600;border-radius:6px;'+bg+'">'+t.label+'</button>';
  }).join('');

  const itemRowsHtml = prevItems.map((it,i)=>invItemRow(i,it.desc,it.amt,i===0)).join('');
  const needsFmtCheck = prevType==='ad_plus' || prevType==='ad_only';
  const hasAD = prevType==='ad_plus' || prevType==='ad_only';
  const showRent = prevType==='commission' || prevType==='ad_plus' || (prevType==='ad_only' && prevFmt==='standard');
  const showItems = prevType==='commission' || prevType==='ad_plus' || (prevType==='ad_only' && prevFmt==='standard');

  const invNumHtml = (prevType==='ad_plus' && prevFmt==='standard')
    ? '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div class="fi"><label>è«‹æ±‚æ›¸ç•ªå·ï¼ˆä»²ä»‹ï¼‰</label><input type="text" class="mono" value="'+invNumComm+'" readonly style="color:var(--muted);font-size:11px;background:rgba(255,255,255,.02);cursor:not-allowed"></div><div class="fi"><label>è«‹æ±‚æ›¸ç•ªå·ï¼ˆæ¥­å‹™å§”è¨—ï¼‰</label><input type="text" class="mono" value="'+invNumAD+'" readonly style="color:var(--muted);font-size:11px;background:rgba(255,255,255,.02);cursor:not-allowed"></div></div>'
    : '<div class="fi"><label>è«‹æ±‚æ›¸ç•ªå·</label><input type="text" class="mono" value="'+invNumSingle+'" readonly style="color:var(--muted);font-size:11px;background:rgba(255,255,255,.02);cursor:not-allowed"></div>';

  const dualBadge = (prevType==='ad_plus' && prevFmt==='standard') ? (
    '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.25);border-radius:8px;font-size:11px">'
    +'<div style="color:var(--gold);font-weight:700;margin-bottom:5px">ğŸ“„ è«‹æ±‚æ›¸2æšç™ºè¡Œ</div>'
    +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub)">'
    +'<span style="color:var(--muted)">No.A</span><span>'+invNumComm+' â€” ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆæœ¬éƒ¨å®›ï¼‰</span>'
    +'<span style="color:var(--muted)">No.B</span><span>'+invNumAD+' â€” æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ï¼ˆç®¡ç†ä¼šç¤¾å®›ï¼‰</span>'
    +'</div></div>'
  ) : '';

  const adFmtHtml = needsFmtCheck ? (
    '<div style="margin-bottom:10px;padding:12px;background:var(--card2);border:1px solid var(--border2);border-radius:8px">'
    +'<div style="font-size:11px;color:var(--sub);margin-bottom:8px;font-weight:600">ğŸ“‹ ç®¡ç†ä¼šç¤¾æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</div>'
    +'<div style="display:flex;gap:8px">'
    +'<button onclick="invSetAdFmt(this)" data-cid="'+id+'" data-fmt="custom" style="flex:1;padding:7px;border:1px solid var(--border2);cursor:pointer;border-radius:6px;font-size:11px;font-weight:600;'+(prevFmt==='custom'?'background:var(--blue);color:#fff;border-color:var(--blue)':'background:transparent;color:var(--sub)')+'">ã‚ã‚Šï¼ˆæŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰</button>'
    +'<button onclick="invSetAdFmt(this)" data-cid="'+id+'" data-fmt="standard" style="flex:1;padding:7px;border:1px solid var(--border2);cursor:pointer;border-radius:6px;font-size:11px;font-weight:600;'+(prevFmt==='standard'?'background:var(--green);color:#000;border-color:var(--green)':'background:transparent;color:var(--sub)')+'">ãªã—ï¼ˆCORETOæ¨™æº–ï¼‰</button>'
    +'</div></div>'
  ) : '';

  const customFmtHtml = (needsFmtCheck && prevFmt==='custom') ? (
    '<div style="padding:14px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:8px;font-size:11px;margin-bottom:10px">'
    +'<div style="color:var(--blue);font-weight:700;margin-bottom:8px">ğŸ¦ æŒ¯è¾¼å…ˆå£åº§ï¼ˆGMOãƒãƒ¼ãƒãƒ£ãƒ«å£åº§ï¼‰</div>'
    +'<div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;color:var(--sub);line-height:1.8">'
    +'<span>éŠ€è¡Œå</span><span class="mono" style="color:var(--t)">GMOã‚ãŠãã‚‰ãƒãƒƒãƒˆéŠ€è¡Œ</span>'
    +'<span>æ”¯åº—å</span><span class="mono" style="color:var(--t)">æ³•äººå–¶æ¥­éƒ¨ï¼ˆ003ï¼‰</span>'
    +'<span>å£åº§ç¨®åˆ¥</span><span class="mono" style="color:var(--t)">æ™®é€š</span>'
    +'<span>å£åº§ç•ªå·</span><span class="mono" style="color:var(--gold);font-size:13px;letter-spacing:.1em">'+invVirtualAcct(id)+'</span>'
    +'<span>å£åº§åç¾©</span><span class="mono" style="color:var(--t)">ã‚«ï¼‰ã‚³ãƒ¬ãƒˆ</span>'
    +'</div>'
    +'<div style="margin-top:8px;padding:6px 8px;background:rgba(255,255,255,.03);border-radius:5px;color:var(--muted);font-size:10px">â€» ã“ã®å£åº§ã¯ã“ã®æ¡ˆä»¶å°‚ç”¨ã®ãƒãƒ¼ãƒãƒ£ãƒ«å£åº§ã§ã™ã€‚</div>'
    +'</div>'
  ) : '';

  return '<div class="step-title">ğŸ§¾ è«‹æ±‚æ›¸ç™ºè¡Œ</div>'
    +'<div style="display:flex;gap:6px;margin-bottom:12px;background:var(--card2);padding:4px;border-radius:8px">'+tabHtml+'</div>'
    +'<div style="margin-bottom:4px">'+invNumHtml+'</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="inv-prop" value="'+(app.prop||'')+'" oninput="invCalc()"></div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">'
    +'<div class="fi"><label>ç™ºè¡Œæ—¥</label><input type="date" id="inv-date" class="mono" value="'+now.toISOString().slice(0,10)+'"></div>'
    +'<div class="fi"><label>æ”¯æ‰•æœŸé™</label><input type="date" id="inv-due" class="mono" value="'+due+'"></div>'
    +'</div>'
    +(showRent ? (
      '<div class="fi"><label>å®¶è³ƒï¼ˆæœˆé¡ãƒ»ç¨è¾¼ï¼‰<span style="color:var(--muted);font-size:10px;margin-left:6px">ä¸Šé™è¨ˆç®—ã®åŸºæº–é¡</span></label>'
      +'<input type="number" id="inv-rent" class="mono" placeholder="ä¾‹: 150000" value="'+(prevRent||(c.salePrice?String(c.salePrice):''))+'" oninput="invCalc()" style="font-size:13px"></div>'
    ) : '')
    +(hasAD ? (
      '<div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:end;margin-bottom:8px">'
      +'<div class="fi" style="margin-bottom:0"><label>æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ â€” é …ç›®å</label>'
      +'<input type="text" id="inv-ad-desc" placeholder="ä¾‹: æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™" value="'+(inv.adDesc||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™')+'" style="font-size:12px"></div>'
      +'<div class="fi" style="margin-bottom:0"><label>é‡‘é¡ï¼ˆç¨è¾¼ï¼‰</label>'
      +'<input type="number" id="inv-ad-amt" class="mono" placeholder="ä¾‹: 150000" value="'+prevAdAmt+'" oninput="invCalc()" style="font-size:14px"></div>'
      +'</div>'
    ) : '')
    +(showItems ? (
      '<div style="margin:10px 0 4px;font-size:11px;color:var(--sub);font-weight:600;letter-spacing:.05em">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‘ã‘è«‹æ±‚é …ç›®<span style="color:var(--muted);font-weight:400;margin-left:6px;font-size:10px">â˜…1è¡Œç›®ã®ä»²ä»‹æ‰‹æ•°æ–™ã®ã¿å®…å»ºæ¥­æ³•ä¸Šé™ãƒã‚§ãƒƒã‚¯å¯¾è±¡</span></div>'
      +'<div id="inv-items">'+itemRowsHtml+'</div>'
      +'<button onclick="invAddItem()" style="width:100%;background:transparent;border:1px dashed var(--border2);color:var(--sub);padding:7px;border-radius:7px;cursor:pointer;font-size:11px;margin-bottom:10px">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>'
    ) : '')
    +adFmtHtml
    +customFmtHtml
    +dualBadge
    +'<div id="inv-validation" style="margin-bottom:8px"></div>'
    +'<div id="inv-reason-wrap" style="display:none;margin-bottom:10px">'
    +'<div class="fi"><label style="color:var(--orange)">âš  åˆè¨ˆãŒå®¶è³ƒ1ãƒ¶æœˆåˆ†æœªæº€ â€” ç†ç”±ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„</label>'
    +'<textarea id="inv-reason" rows="2" placeholder="ä¾‹: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆäº¤æ¸‰ã®çµæœã€æ‰‹æ•°æ–™ã‚’æ¸›é¡ã€‚å…¥å±…ç‡å„ªå…ˆã®ãŸã‚ã€‚" style="font-size:12px;resize:vertical">'+prevReason+'</textarea></div>'
    +'</div>'
    +'<button class="btn btn-gold" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="issueInvoice(this.dataset.cid)">ğŸ“„ è«‹æ±‚æ›¸ç™ºè¡Œ â†’ é‡èª¬ãƒ»å…¥é‡‘ã¸</button>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸‰ç‚ºå°‚ç”¨è«‹æ±‚æ›¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stepInvoiceSannai(c) {
  const now = new Date();
  const due = new Date(now.getTime()+30*864e5).toISOString().slice(0,10);
  const ym  = now.getFullYear()+String(now.getMonth()+1).padStart(2,'0');
  const inv = c.invoice || {};
  const sn  = c.sannai  || {};
  const id  = c.id;

  // â”€â”€ è²·ä»˜ã‹ã‚‰å¼•ç”¨ã—ãŸå–å¼•ä¾¡æ ¼ãƒ»æ”¯æ‰•æ‰‹æ•°æ–™ â”€â”€
  const buyPrice   = sn.buyPrice   || 0;
  const sellPrice  = sn.sellPrice  || c.salePrice || 0;
  const commBuyAmt = sn.commBuyAmt || 0;
  const commSellAmt= sn.commSellAmt|| 0;
  const delegTotal = (sn.delegPay||[]).reduce((s,r)=>s+(r.amt||0),0);
  const totalOut   = commBuyAmt + commSellAmt + delegTotal;

  // â”€â”€ æ—¢å­˜ã®è«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ï¼ˆç·¨é›†æ™‚å¼•ãç¶™ãï¼‰â”€â”€
  const prevBuyerComm  = inv.buyerComm  !== undefined ? inv.buyerComm  : (sellPrice ? Math.min(saleCommLimit(sellPrice), Math.round((sellPrice*0.03+60000)*1.1)) : '');
  const prevSellerComm = inv.sellerComm !== undefined ? inv.sellerComm : (buyPrice  ? '' : '');
  const prevBuyerDeleg = inv.buyerDeleg || [];
  const prevSellerDeleg= inv.sellerDeleg|| [];
  const prevProp = inv.prop || c.dates?.naikenProp || '';
  const prevDate = inv.date || now.toISOString().slice(0,10);
  const prevDue  = inv.due  || due;

  // è«‹æ±‚æ›¸ç•ªå·
  const invNumBuyer  = 'INV-'+ym+'-'+c.agent+'-BUY';
  const invNumSeller = 'INV-'+ym+'-'+c.agent+'-SEL';

  // ä¸Šé™
  const buyLimit  = saleCommLimit(sellPrice);
  const sellLimit = saleCommLimit(buyPrice);

  // â”€â”€ å–å¼•æ¦‚è¦ã‚µãƒãƒªãƒ¼ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰â”€â”€
  const summaryHtml = (buyPrice || sellPrice) ? (
    '<div style="margin-bottom:12px;padding:12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:10px;font-size:11px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<span style="font-size:10px;color:var(--gold);font-weight:700;letter-spacing:.8px">ğŸ“Š è²·ä»˜æƒ…å ±ï¼ˆå¼•ç”¨ï¼‰</span>'
    +'<a href="#" onclick="editSannaiOffer(\''+id+'\')" style="font-size:10px;color:var(--muted);text-decoration:none">âœ ä¿®æ­£</a>'
    +'</div>'
    +'<div style="display:grid;grid-template-columns:auto 1fr auto 1fr;gap:3px 10px;line-height:1.8">'
    +(buyPrice  ? '<span style="color:var(--muted)">ä»•å…¥ã‚Œ</span><span class="mono">Â¥'+buyPrice.toLocaleString()+'</span>' : '')
    +(sellPrice ? '<span style="color:var(--muted)">è²©å£²</span><span class="mono">Â¥'+sellPrice.toLocaleString()+'</span>' : '')
    +(buyPrice&&sellPrice ? '<span style="color:var(--muted)">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰</span><span class="mono" style="color:'+(sellPrice-buyPrice>=0?'var(--green)':'var(--red)')+'">'+((sellPrice-buyPrice>=0)?'+':'')+'Â¥'+(sellPrice-buyPrice).toLocaleString()+'</span>' : '')
    +(totalOut  ? '<span style="color:var(--muted)">æ”¯æ‰•æ‰‹æ•°æ–™è¨ˆ</span><span class="mono" style="color:var(--orange)">-Â¥'+totalOut.toLocaleString()+'</span>' : '')
    +'</div>'
    +(sn.commPayMode && sn.commPayMode!=='none' ? (
      '<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border);font-size:10px;color:var(--muted)">'
      +(commBuyAmt  ? 'è²·ã„å´ä»²ä»‹: '+(sn.commBuyCo||'â€”')+' Â¥'+commBuyAmt.toLocaleString()+'ã€€' : '')
      +(commSellAmt ? 'å£²ã‚Šå´ä»²ä»‹: '+(sn.commSellCo||'â€”')+' Â¥'+commSellAmt.toLocaleString() : '')
      +'</div>'
    ) : '')
    +((sn.delegPay||[]).length ? (
      '<div style="margin-top:4px;font-size:10px;color:var(--muted)">'
      +(sn.delegPay||[]).map(r=>'æ¥­å‹™å§”è¨—: '+(r.co||'â€”')+' Â¥'+(r.amt||0).toLocaleString()).join('ã€€')
      +'</div>'
    ) : '')
    +'</div>'
  ) : '';

  // â”€â”€ å—å–ä»²ä»‹æ‰‹æ•°æ–™: è²·ä¸»å´ â”€â”€
  const buyerCommRows = (prevBuyerDeleg.length ? prevBuyerDeleg : []).map((r,i)=>invItemRowB(i,r.desc,r.amt)).join('');
  const buyerCommLimit = buyLimit > 0 ? '<span style="font-size:10px;color:var(--muted);margin-left:6px">ä¸Šé™ Â¥'+buyLimit.toLocaleString()+'</span>' : '';

  // â”€â”€ å—å–ä»²ä»‹æ‰‹æ•°æ–™: å£²ä¸»å´ â”€â”€
  const showSellerSection = inv.hasSellerComm !== undefined ? inv.hasSellerComm : false;
  const sellerCommRows = (prevSellerDeleg.length ? prevSellerDeleg : []).map((r,i)=>sannaiInvItemRowSeller(i,r.desc,r.amt)).join('');

  return '<div class="step-title">ğŸ§¾ è«‹æ±‚æ›¸ç™ºè¡Œï¼ˆä¸‰ç‚ºï¼‰</div>'
    + summaryHtml

    // åŸºæœ¬æƒ…å ±
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="inv-prop" value="'+prevProp+'" oninput="sannaiInvCalc()"></div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'
    +'<div class="fi"><label>ç™ºè¡Œæ—¥</label><input type="date" id="inv-date" class="mono" value="'+prevDate+'"></div>'
    +'<div class="fi"><label>æ”¯æ‰•æœŸé™</label><input type="date" id="inv-due" class="mono" value="'+prevDue+'"></div>'
    +'</div>'

    // â”€â”€ è²·ä¸»å‘ã‘è«‹æ±‚æ›¸ï¼ˆå¿…é ˆï¼‰â”€â”€
    +'<div style="margin-bottom:10px;padding:12px;background:rgba(79,156,249,.06);border:1px solid rgba(79,156,249,.25);border-radius:10px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<div style="font-size:11px;color:var(--blue);font-weight:700">ğŸ“„ è²·ä¸»å‘ã‘è«‹æ±‚æ›¸ '+invNumBuyer+'</div>'
    +'<span style="font-size:9px;color:var(--blue);background:rgba(79,156,249,.15);padding:2px 7px;border-radius:4px;font-weight:600">å¿…é ˆ</span>'
    +'</div>'
    +(sellPrice ? '<div style="font-size:10px;color:var(--muted);margin-bottom:8px">è²©å£²ä¾¡æ ¼ï¼ˆä¸Šé™ï¼‰: Â¥'+sellPrice.toLocaleString()+'</div>' : '')
    +'<div style="margin-bottom:6px;font-size:10px;color:var(--sub);font-weight:600">è«‹æ±‚é …ç›®ï¼ˆä»²ä»‹æ‰‹æ•°æ–™ç­‰ï¼‰</div>'
    +'<div id="sn-inv-buyer-items">'
    +(prevBuyerDeleg.length
      ? buyerCommRows
      : invItemRowB(0, 'å£²è²·ä»£é‡‘', sellPrice||''))
    +'</div>'
    +'<button onclick="sannaiInvAddBuyerItem()" style="width:100%;background:transparent;border:1px dashed rgba(79,156,249,.4);color:var(--blue);padding:6px;border-radius:7px;cursor:pointer;font-size:11px;margin-top:4px">ï¼‹ é …ç›®è¿½åŠ </button>'
    +'<div id="sn-inv-buyer-check" style="margin-top:8px"></div>'
    +'</div>'

    // â”€â”€ å£²ä¸»å‘ã‘è«‹æ±‚æ›¸ï¼ˆä»»æ„ï¼‰â”€â”€
    +'<div style="margin-bottom:10px;padding:12px;background:rgba(52,211,153,.04);border:1px solid rgba(52,211,153,.15);border-radius:10px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<div style="font-size:11px;color:var(--green);font-weight:700">ğŸ“„ å£²ä¸»å‘ã‘è«‹æ±‚æ›¸ '+invNumSeller+'</div>'
    +'<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:10px;color:var(--sub)">'
    +'<input type="checkbox" id="sn-inv-seller-toggle"'+(showSellerSection?' checked':'')+' onchange="sannaiToggleSellerInv(this,\''+id+'\')" style="cursor:pointer"> ç™ºè¡Œã™ã‚‹'
    +'</label>'
    +'</div>'
    +(showSellerSection ? (
      (buyPrice ? '<div style="font-size:10px;color:var(--muted);margin-bottom:8px">ä»•å…¥ã‚Œä¾¡æ ¼ Â¥'+buyPrice.toLocaleString()+' ã€€ä¸Šé™: Â¥'+sellLimit.toLocaleString()+'</div>' : '')
      +'<div style="margin-bottom:6px;font-size:10px;color:var(--sub);font-weight:600">è«‹æ±‚é …ç›®ï¼ˆä»²ä»‹æ‰‹æ•°æ–™ç­‰ï¼‰</div>'
      +'<div id="sn-inv-seller-items">'
      +(prevSellerDeleg.length
        ? sellerCommRows
        : sannaiInvItemRowSeller(0, 'ä»²ä»‹æ‰‹æ•°æ–™', prevSellerComm||''))
      +'</div>'
      +'<button onclick="sannaiInvAddSellerItem()" style="width:100%;background:transparent;border:1px dashed rgba(52,211,153,.4);color:var(--green);padding:6px;border-radius:7px;cursor:pointer;font-size:11px;margin-top:4px">ï¼‹ é …ç›®è¿½åŠ </button>'
      +'<div id="sn-inv-seller-check" style="margin-top:8px"></div>'
    ) : '<div style="font-size:11px;color:var(--muted);padding:4px 0">ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨å£²ä¸»å‘ã‘è«‹æ±‚æ›¸ã‚’è¿½åŠ ç™ºè¡Œã§ãã¾ã™</div>')
    +'</div>'

    +'<div id="inv-validation" style="margin-bottom:8px"></div>'
    +'<button class="btn btn-gold" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="issueInvoiceSannai(this.dataset.cid)">ğŸ“„ è«‹æ±‚æ›¸ç™ºè¡Œ â†’ å¥‘ç´„ã¸</button>';
}

function sannaiInvItemRowSeller(idx, desc, amt) {
  return '<div class="sn-inv-row-sel" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr auto auto;gap:6px;margin-bottom:6px;align-items:center">'
    +'<input type="text" placeholder="é …ç›®å" value="'+(desc||'')+'" oninput="sannaiInvCalc()" style="font-size:12px;color:var(--green)">'
    +'<input type="number" placeholder="é‡‘é¡" value="'+(amt||'')+'" oninput="sannaiInvCalc()" class="mono" style="width:120px;font-size:13px">'
    +(idx===0
      ? '<div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:var(--green);font-size:14px">â˜…</div>'
      : '<button onclick="this.closest(\'.sn-inv-row-sel\').remove();sannaiInvCalc()" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0">Ã—</button>')
    +'</div>';
}

function sannaiInvAddBuyerItem() {
  const wrap = document.getElementById('sn-inv-buyer-items'); if(!wrap) return;
  const idx = wrap.querySelectorAll('.inv-row-b').length;
  const div = document.createElement('div');
  div.innerHTML = invItemRowB(idx,'',0);
  wrap.appendChild(div.firstChild);
  sannaiInvCalc();
}

function sannaiInvAddSellerItem() {
  const wrap = document.getElementById('sn-inv-seller-items'); if(!wrap) return;
  const idx = wrap.querySelectorAll('.sn-inv-row-sel').length;
  const div = document.createElement('div');
  div.innerHTML = sannaiInvItemRowSeller(idx,'',0);
  wrap.appendChild(div.firstChild);
  sannaiInvCalc();
}

function sannaiToggleSellerInv(cb, id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.hasSellerComm = cb.checked;
  // ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’ä¿æŒã—ã¦ã‹ã‚‰å†æç”»
  sannaiInvSave(c);
  open_case(id);
}

function sannaiInvGetBuyerItems() {
  const rows = document.querySelectorAll('#sn-inv-buyer-items .inv-row-b');
  const items = [];
  rows.forEach(r => {
    const inputs = r.querySelectorAll('input');
    const desc = inputs[0]?.value.trim()||'';
    const amt  = parseInt(inputs[1]?.value)||0;
    if(desc||amt) items.push({desc, amt});
  });
  return items;
}

function sannaiInvGetSellerItems() {
  const rows = document.querySelectorAll('#sn-inv-seller-items .sn-inv-row-sel');
  const items = [];
  rows.forEach(r => {
    const inputs = r.querySelectorAll('input');
    const desc = inputs[0]?.value.trim()||'';
    const amt  = parseInt(inputs[1]?.value)||0;
    if(desc||amt) items.push({desc, amt});
  });
  return items;
}

function sannaiInvCalc() {
  const sn = (CASES.find(x=>x.id===cur)||{}).sannai||{};
  const sellPrice = sn.sellPrice || 0;
  const buyPrice  = sn.buyPrice  || 0;
  const buyLimit  = sellPrice;  // è²·ä¸»å‘ã‘ä¸Šé™ = è²©å£²ä¾¡æ ¼
  const sellLimit = saleCommLimit(buyPrice);

  // è²·ä¸»ãƒã‚§ãƒƒã‚¯
  const buyerItems = sannaiInvGetBuyerItems();
  const buyerTotal = buyerItems.reduce((s,r)=>s+r.amt,0);
  const buyerComm  = buyerItems[0]?.amt||0;
  const buyEl = document.getElementById('sn-inv-buyer-check');
  if(buyEl && sellPrice>0 && buyerTotal>0) {
    const over = buyerComm - buyLimit;
    buyEl.innerHTML = over > 0
      ? '<div style="padding:6px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px">â›” ä¸Šé™è¶…é Â¥'+over.toLocaleString()+' â€” ä¸Šé™ Â¥'+buyLimit.toLocaleString()+'</div>'
      : '<div style="padding:5px 10px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:6px;color:var(--blue);font-size:11px">âœ… è²·ä¸»åˆè¨ˆ Â¥'+buyerTotal.toLocaleString()+' â€” ä¸Šé™å†…ï¼ˆÂ¥'+buyLimit.toLocaleString()+'ï¼‰</div>';
  }

  // å£²ä¸»ãƒã‚§ãƒƒã‚¯
  const sellerItems = sannaiInvGetSellerItems();
  const sellerTotal = sellerItems.reduce((s,r)=>s+r.amt,0);
  const sellerComm  = sellerItems[0]?.amt||0;
  const selEl = document.getElementById('sn-inv-seller-check');
  if(selEl && buyPrice>0 && sellerTotal>0) {
    const over = sellerComm - sellLimit;
    selEl.innerHTML = over > 0
      ? '<div style="padding:6px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px">â›” ä¸Šé™è¶…é Â¥'+over.toLocaleString()+' â€” ä¸Šé™ Â¥'+sellLimit.toLocaleString()+'</div>'
      : '<div style="padding:5px 10px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);border-radius:6px;color:var(--green);font-size:11px">âœ… å£²ä¸»åˆè¨ˆ Â¥'+sellerTotal.toLocaleString()+' â€” ä¸Šé™å†…ï¼ˆÂ¥'+sellLimit.toLocaleString()+'ï¼‰</div>';
  }
}

function sannaiInvSave(c) {
  if(!c.invoice) c.invoice={};
  const inv = c.invoice;
  inv.prop = document.getElementById('inv-prop')?.value.trim()||inv.prop||'';
  inv.date = document.getElementById('inv-date')?.value||inv.date||'';
  inv.due  = document.getElementById('inv-due')?.value||inv.due||'';
  const bi = sannaiInvGetBuyerItems();
  if(bi.length) inv.buyerDeleg = bi;
  const si = sannaiInvGetSellerItems();
  if(si.length) inv.sellerDeleg = si;
  inv.buyerComm  = bi[0]?.amt||0;
  inv.sellerComm = si[0]?.amt||0;
}

function issueInvoiceSannai(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  const inv = c.invoice;
  const sn  = c.sannai||{};

  const prop = document.getElementById('inv-prop')?.value.trim()||'';
  const date = document.getElementById('inv-date')?.value||todayISO();
  const due  = document.getElementById('inv-due')?.value||todayISO();
  if(!prop){alert('ç‰©ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  const buyerItems  = sannaiInvGetBuyerItems();
  const sellerItems = sannaiInvGetSellerItems();
  const buyerTotal  = buyerItems.reduce((s,r)=>s+r.amt,0);
  const sellerTotal = sellerItems.reduce((s,r)=>s+r.amt,0);

  if(buyerItems.length===0||buyerTotal===0){alert('è²·ä¸»å‘ã‘è«‹æ±‚é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  const sellPrice = sn.sellPrice||c.salePrice||0;
  const buyPrice  = sn.buyPrice||0;
  const buyLimit  = sellPrice;  // è²·ä¸»å‘ã‘ä¸Šé™ = è²©å£²ä¾¡æ ¼
  const sellLimit = saleCommLimit(buyPrice);
  const buyerComm = buyerItems[0]?.amt||0;
  const sellerComm= sellerItems[0]?.amt||0;

  if(buyLimit>0 && buyerComm>buyLimit) {
    if(!confirm('è²·ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+buyerComm.toLocaleString()+'ï¼‰ãŒä¸Šé™ï¼ˆÂ¥'+buyLimit.toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
  }
  if(inv.hasSellerComm && sellLimit>0 && sellerComm>sellLimit) {
    if(!confirm('å£²ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+sellerComm.toLocaleString()+'ï¼‰ãŒä¸Šé™ï¼ˆÂ¥'+sellLimit.toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
  }

  const grandTotal = buyerTotal + sellerTotal;
  Object.assign(inv, {
    type:'sannai', prop, date, due,
    buyerDeleg:buyerItems, sellerDeleg:sellerItems,
    buyerComm, sellerComm, buyerTotal, sellerTotal, grandTotal,
    sellPrice, buyPrice,
    hasSellerComm: inv.hasSellerComm||false,
    issued:true,
  });

  const ym = date.slice(0,7).replace('-','');
  const invNumBuyer  = 'INV-'+ym+'-'+c.agent+'-BUY';
  const invNumSeller = 'INV-'+ym+'-'+c.agent+'-SEL';

  const lines = [
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    'ğŸ§¾ *ä¸‰ç‚º è«‹æ±‚æ›¸ç™ºè¡Œé€šçŸ¥*',
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    'ğŸ“ *æ¡ˆä»¶ID*ï¼š'+id,
    'ğŸ  *ç‰©ä»¶*ï¼š'+prop,
    'ğŸ’´ *ä»•å…¥ã‚Œ*ï¼šÂ¥'+(buyPrice?buyPrice.toLocaleString():'â€”'),
    'ğŸ’´ *è²©å£²*ï¼šÂ¥'+(sellPrice?sellPrice.toLocaleString():'â€”'),
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'ğŸ“„ '+invNumBuyer+' è²·ä¸»å‘ã‘åˆè¨ˆï¼šÂ¥'+buyerTotal.toLocaleString(),
    ...(inv.hasSellerComm?['ğŸ“„ '+invNumSeller+' å£²ä¸»å‘ã‘åˆè¨ˆï¼šÂ¥'+sellerTotal.toLocaleString()]:[]),
    'ğŸ’° *è«‹æ±‚ç·è¨ˆ*ï¼šÂ¥'+grandTotal.toLocaleString(),
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    'ğŸ• '+new Date().toLocaleString('ja-JP'),
  ].join('\n');
  console.log('[Slack #è«‹æ±‚æ›¸]\n', lines);
  try {
    const ta=document.createElement('textarea');
    ta.value=lines; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  } catch(e){}

  c.hist.unshift(today()+' ä¸‰ç‚ºè«‹æ±‚æ›¸ç™ºè¡Œ è²·ä¸»Â¥'+buyerTotal.toLocaleString()+(inv.hasSellerComm?' å£²ä¸»Â¥'+sellerTotal.toLocaleString():''));
  advance(id,'contract','invoiced',date,'è«‹æ±‚æ›¸ç™ºè¡Œå®Œäº† â†’ å¥‘ç´„ã¸');
}

// â”€â”€ å£²è²·ãƒ»ä¸‰ç‚ºå°‚ç”¨è«‹æ±‚æ›¸ â”€â”€
function saleCommLimit(price) {
  // å®…å»ºæ¥­æ³•: 800ä¸‡ä»¥ä¸‹ã¯ä¸€å¾‹330,000å††ï¼ˆç¨è¾¼ï¼‰, è¶…ãˆã‚‹ã¨ (priceÃ—3%+6ä¸‡)Ã—1.1
  if(!price||price<=0) return 0;
  if(price<=8000000) return 330000;
  return Math.round((price*0.03+60000)*1.1);
}

function invSetSaleFrom(btn) {
  const id = btn.dataset.cid;
  const from = btn.dataset.from;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.saleFrom = from;
  open_case(id);
}

function stepInvoiceSale(c) {
  const now = new Date();
  const due = new Date(now.getTime()+30*864e5).toISOString().slice(0,10);
  const ym  = now.getFullYear()+String(now.getMonth()+1).padStart(2,'0');
  const inv = c.invoice || {};
  const id  = c.id;
  const saleFrom  = inv.saleFrom || 'seller';   // seller / both / buyer
  const prevPrice = inv.salePrice || c.salePrice || '';
  const prevItems = inv.items || [{desc:'ä»²ä»‹æ‰‹æ•°æ–™',amt:''}];
  const prevDelegItems = inv.delegItems || [];
  const prevReason= inv.underReason || '';
  const invNum    = 'INV-'+ym+'-'+c.agent;
  const invNumB   = 'INV-'+ym+'-'+c.agent+'-B';

  // å—é ˜å…ˆã‚¿ãƒ–
  const fromTabs = [
    {v:'seller', label:'å£²ä¸»ã‹ã‚‰'},
    {v:'both',   label:'ä¸¡æ‰‹ï¼ˆå£²ä¸»ï¼‹è²·ä¸»ï¼‰'},
    {v:'buyer',  label:'è²·ä¸»ã‹ã‚‰'},
  ];
  const fromTabHtml = fromTabs.map(t=>{
    const active = saleFrom===t.v;
    const bg = active ? 'background:var(--gold);color:#000' : 'background:var(--card2);color:var(--sub)';
    return '<button onclick="invSetSaleFrom(this)" data-cid="'+id+'" data-from="'+t.v+'" style="flex:1;padding:7px 3px;border:none;cursor:pointer;font-size:10px;font-weight:600;border-radius:6px;'+bg+'">'+t.label+'</button>';
  }).join('');

  // ä¸¡æ‰‹ã®å ´åˆã¯è«‹æ±‚æ›¸Aï¼ˆå£²ä¸»ï¼‰ãƒ»Bï¼ˆè²·ä¸»ï¼‰ã®2æš
  const dualMsg = saleFrom==='both' ? (
    '<div style="margin-bottom:10px;padding:10px 12px;background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.25);border-radius:8px;font-size:11px">'
    +'<div style="color:var(--gold);font-weight:700;margin-bottom:5px">ğŸ“„ ä¸¡æ‰‹: è«‹æ±‚æ›¸2æšç™ºè¡Œ</div>'
    +'<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 10px;color:var(--sub)">'
    +'<span style="color:var(--muted)">No.A</span><span>'+invNum+' â€” å£²ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™</span>'
    +'<span style="color:var(--muted)">No.B</span><span>'+invNumB+' â€” è²·ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™</span>'
    +'</div></div>'
  ) : '';

  // è«‹æ±‚é …ç›®rows
  const itemRowsHtml = prevItems.map((it,i)=>invItemRow(i,it.desc,it.amt,i===0)).join('');
  const itemRowsBHtml = saleFrom==='both'
    ? (prevDelegItems.length>0 ? prevDelegItems : [{desc:'ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆè²·ä¸»ï¼‰',amt:''}]).map((it,i)=>invItemRowB(i,it.desc,it.amt)).join('')
    : '';

  // æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸Šé™è¶…ãˆå¯¾å¿œï¼‰
  const delegDesc = inv.delegDesc || 'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™';
  const delegAmt  = inv.delegAmt  || '';
  const delegSection = (
    '<div style="margin-top:10px;padding:12px;background:var(--card2);border:1px solid var(--border2);border-radius:8px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<span style="font-size:11px;color:var(--sub);font-weight:600">ğŸ’¼ æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ï¼ˆä¸Šé™è¶…éåˆ†ãƒ»ä»»æ„ï¼‰</span>'
    +'<span style="font-size:10px;color:var(--muted)">åˆ¥é€”è«‹æ±‚</span>'
    +'</div>'
    +'<div style="display:grid;grid-template-columns:1fr auto;gap:6px">'
    +'<input type="text" id="inv-deleg-desc" placeholder="ä¾‹: æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™" value="'+delegDesc+'" style="background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:6px 10px;color:var(--text);font-size:12px;font-family:inherit;outline:none">'
    +'<input type="number" id="inv-deleg-amt" class="mono" placeholder="é‡‘é¡" value="'+delegAmt+'" oninput="invCalcSale()" style="width:120px;font-size:13px">'
    +'</div></div>'
  );

  return '<div class="step-title">ğŸ§¾ è«‹æ±‚æ›¸ç™ºè¡Œï¼ˆå£²è²·ï¼‰</div>'
    +'<div style="display:flex;gap:6px;margin-bottom:12px;background:var(--card2);padding:4px;border-radius:8px">'+fromTabHtml+'</div>'
    +dualMsg
    +'<div class="fi"><label>è«‹æ±‚æ›¸ç•ªå·</label><input type="text" class="mono" value="'+invNum+'" readonly style="color:var(--muted);font-size:11px;background:rgba(255,255,255,.02);cursor:not-allowed"></div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="inv-prop" value="'+(c.dates.naikenProp||'')+'" oninput="invCalcSale()"></div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">'
    +'<div class="fi"><label>ç™ºè¡Œæ—¥</label><input type="date" id="inv-date" class="mono" value="'+now.toISOString().slice(0,10)+'"></div>'
    +'<div class="fi"><label>æ”¯æ‰•æœŸé™</label><input type="date" id="inv-due" class="mono" value="'+due+'"></div>'
    +'</div>'
    +'<div class="fi"><label>å£²è²·ä¾¡æ ¼ï¼ˆå††ï¼‰<span style="color:var(--muted);font-size:10px;margin-left:6px">ä¸Šé™è¨ˆç®—ã®åŸºæº–</span></label>'
    +'<input type="text" id="inv-sale-price" class="mono" placeholder="ä¾‹: 32,000,000" value="'+fmtYen(prevPrice)+'" oninput="invSalePriceInput(this)" style="font-size:13px"></div>'
    // å£²ä¸»å‘ã‘é …ç›®
    +(saleFrom==='both'
      ? '<div style="margin:8px 0 4px;font-size:11px;color:var(--gold);font-weight:700">ğŸ“„ A: å£²ä¸»å‘ã‘ è«‹æ±‚é …ç›®</div>'
      : '<div style="margin:8px 0 4px;font-size:11px;color:var(--sub);font-weight:600">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‘ã‘è«‹æ±‚é …ç›®<span style="color:var(--muted);font-weight:400;margin-left:6px;font-size:10px">â˜…å®…å»ºæ¥­æ³•ä¸Šé™ãƒã‚§ãƒƒã‚¯å¯¾è±¡</span></div>'
    )
    +'<div id="inv-items">'+itemRowsHtml+'</div>'
    +'<button onclick="invAddItem()" style="width:100%;background:transparent;border:1px dashed var(--border2);color:var(--sub);padding:6px;border-radius:7px;cursor:pointer;font-size:11px;margin-bottom:8px">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>'
    // è²·ä¸»å‘ã‘é …ç›®ï¼ˆä¸¡æ‰‹ã®ã¿ï¼‰
    +(saleFrom==='both' ? (
      '<div style="margin:8px 0 4px;font-size:11px;color:var(--blue);font-weight:700">ğŸ“„ B: è²·ä¸»å‘ã‘ è«‹æ±‚é …ç›®</div>'
      +'<div id="inv-items-b">'+itemRowsBHtml+'</div>'
      +'<button onclick="invAddItemB()" style="width:100%;background:transparent;border:1px dashed rgba(79,156,249,.4);color:var(--blue);padding:6px;border-radius:7px;cursor:pointer;font-size:11px;margin-bottom:8px">ï¼‹ è²·ä¸»å‘ã‘é …ç›®ã‚’è¿½åŠ </button>'
    ) : '')
    // æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ï¼ˆä¸Šé™è¶…éåˆ†ï¼‰
    +delegSection
    +'<div id="inv-validation" style="margin-bottom:8px"></div>'
    +'<button class="btn btn-gold" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="issueInvoiceSale(this.dataset.cid)">ğŸ“„ è«‹æ±‚æ›¸ç™ºè¡Œ â†’ å¥‘ç´„ã¸</button>';
}

function invItemRowB(idx, desc, amt) {
  return '<div class="inv-row-b" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr auto auto;gap:6px;margin-bottom:6px;align-items:center">'
    +'<input type="text" placeholder="é …ç›®å" value="'+desc+'" oninput="invCalcSale()" style="font-size:12px;color:var(--blue)">'
    +'<input type="number" placeholder="é‡‘é¡" value="'+amt+'" oninput="invCalcSale()" class="mono" style="width:120px;font-size:13px">'
    +(idx===0
      ? '<div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:var(--blue);font-size:14px">â˜…</div>'
      : '<button onclick="invRemoveItemB('+idx+')" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0;line-height:1">Ã—</button>')
    +'</div>';
}

let _invItemCountB=1;
function invAddItemB() {
  const wrap=document.getElementById('inv-items-b'); if(!wrap) return;
  const idx=_invItemCountB++;
  const div=document.createElement('div');
  div.innerHTML=invItemRowB(idx,'',0);
  wrap.appendChild(div.firstChild);
  invCalcSale();
}
function invRemoveItemB(idx) {
  document.querySelectorAll('#inv-items-b .inv-row-b').forEach(r=>{
    if(parseInt(r.dataset.idx)===idx) r.remove();
  });
  invCalcSale();
}
function invGetItemsB() {
  const rows=document.querySelectorAll('#inv-items-b .inv-row-b');
  const items=[];
  rows.forEach(r=>{
    const inputs=r.querySelectorAll('input');
    const desc=inputs[0]?.value.trim()||'';
    const amt=parseInt(inputs[1]?.value)||0;
    if(desc||amt) items.push({desc,amt});
  });
  return items;
}

function invCalcSale() {
  const price  = parseInt((document.getElementById('inv-sale-price')?.value||'').replace(/,/g,''))||0;
  const itemsA = invGetItems();
  const itemsB = invGetItemsB();
  const totalA = itemsA.reduce((s,it)=>s+it.amt,0);
  const totalB = itemsB.reduce((s,it)=>s+it.amt,0);
  const commA  = itemsA.length>0 ? itemsA[0].amt : 0;
  const commB  = itemsB.length>0 ? itemsB[0].amt : 0;
  const deleg  = parseInt(document.getElementById('inv-deleg-amt')?.value)||0;
  const limit  = saleCommLimit(price);
  const isBoth = !!document.getElementById('inv-items-b');

  let html='';
  if(price>0) {
    const limitLabel = price<=8000000
      ? '800ä¸‡å††ä»¥ä¸‹ ç‰¹ä¾‹: Â¥330,000'
      : 'Â¥'+limit.toLocaleString()+'ï¼ˆå£²è²·ä¾¡æ ¼Ã—3%+6ä¸‡ï¼‰Ã—1.1';

    html += '<div style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:12px">';
    html += '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--sub)">æ³•å®šä¸Šé™ï¼ˆ1ç¤¾ã‚ãŸã‚Šï¼‰</span><span class="mono" style="color:var(--muted)">Â¥'+limit.toLocaleString()+'</span></div>';

    // å£²ä¸»ãƒã‚§ãƒƒã‚¯
    if(totalA>0) {
      html += '<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px">';
      html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="color:var(--sub)">'+(isBoth?'A å£²ä¸»å‘ã‘åˆè¨ˆ':'è«‹æ±‚åˆè¨ˆ')+'</span><span class="mono">Â¥'+totalA.toLocaleString()+'</span></div>';
      if(commA>limit) {
        const over = commA-limit;
        html += '<div style="padding:7px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px;margin-top:4px">'
          +'â›” ä»²ä»‹æ‰‹æ•°æ–™ãŒä¸Šé™ã‚’ Â¥'+over.toLocaleString()+' è¶…éï¼ˆ'+limitLabel+'ï¼‰<br>'
          +'<span style="font-size:10px;opacity:.85">è¶…éåˆ† Â¥'+over.toLocaleString()+' ã¯ã€Œæ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã€ã¨ã—ã¦ä¸‹æ¬„ã«å…¥åŠ›ã—ã¦ãã ã•ã„</span>'
          +'</div>';
      } else if(commA>0) {
        html += '<div style="padding:5px 10px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);border-radius:6px;color:var(--green);font-size:11px;margin-top:4px">âœ… ä»²ä»‹æ‰‹æ•°æ–™ Â¥'+commA.toLocaleString()+' â€” é©æ­£ï¼ˆä¸Šé™: '+limitLabel+'ï¼‰</div>';
      }
      html += '</div>';
    }

    // è²·ä¸»ãƒã‚§ãƒƒã‚¯ï¼ˆä¸¡æ‰‹ï¼‰
    if(isBoth&&totalB>0) {
      html += '<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px">';
      html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="color:var(--blue)">B è²·ä¸»å‘ã‘åˆè¨ˆ</span><span class="mono">Â¥'+totalB.toLocaleString()+'</span></div>';
      if(commB>limit) {
        const overB = commB-limit;
        html += '<div style="padding:7px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px;margin-top:4px">'
          +'â›” è²·ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™ãŒä¸Šé™ã‚’ Â¥'+overB.toLocaleString()+' è¶…é<br>'
          +'<span style="font-size:10px;opacity:.85">è¶…éåˆ†ã¯åˆ¥åç›®ã§ã¯ãªãã€Œæ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã€ã¨ã—ã¦è¨ˆä¸Šã—ã¦ãã ã•ã„</span>'
          +'</div>';
      } else if(commB>0) {
        html += '<div style="padding:5px 10px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:6px;color:var(--blue);font-size:11px;margin-top:4px">âœ… è²·ä¸»å‘ã‘ Â¥'+commB.toLocaleString()+' â€” é©æ­£</div>';
      }
      html += '</div>';
    }

    // æ¥­å‹™å§”è¨—
    if(deleg>0) {
      html += '<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px;display:flex;justify-content:space-between"><span style="color:var(--sub)">æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™</span><span class="mono">Â¥'+deleg.toLocaleString()+'</span></div>';
    }

    // ã‚°ãƒ©ãƒ³ãƒ‰ãƒˆãƒ¼ã‚¿ãƒ«
    const grand = totalA+(isBoth?totalB:0)+deleg;
    if(grand>0) {
      html += '<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px;display:flex;justify-content:space-between"><span style="color:var(--sub);font-weight:700">åˆè¨ˆ</span><span class="mono" style="color:var(--gold);font-size:13px">Â¥'+grand.toLocaleString()+'</span></div>';
    }

    html += '</div>';
  }
  const vp=document.getElementById('inv-validation');
  if(vp) vp.innerHTML=html;
}

function issueInvoiceSale(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  const inv = c.invoice||{};
  const saleFrom = inv.saleFrom||'seller';
  const prop  = document.getElementById('inv-prop')?.value.trim()||'';
  const date  = document.getElementById('inv-date')?.value||todayISO();
  const due   = document.getElementById('inv-due')?.value||todayISO();
  const price = parseInt((document.getElementById('inv-sale-price')?.value||'').replace(/,/g,''))||0;
  if(!prop) {alert('ç‰©ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(!price){alert('å£²è²·ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  const itemsA    = invGetItems();
  const itemsB    = saleFrom==='both' ? invGetItemsB() : [];
  const totalA    = itemsA.reduce((s,it)=>s+it.amt,0);
  const totalB    = itemsB.reduce((s,it)=>s+it.amt,0);
  const commA     = itemsA.length>0 ? itemsA[0].amt : 0;
  const commB     = itemsB.length>0 ? itemsB[0].amt : 0;
  const delegAmt  = parseInt(document.getElementById('inv-deleg-amt')?.value)||0;
  const delegDesc = document.getElementById('inv-deleg-desc')?.value.trim()||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™';
  const limit     = saleCommLimit(price);
  const grandTotal= totalA+totalB+delegAmt;

  if(totalA===0){alert('è«‹æ±‚é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(commA>limit){
    if(!confirm('ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+commA.toLocaleString()+'ï¼‰ãŒæ³•å®šä¸Šé™ï¼ˆÂ¥'+limit.toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nè¶…éåˆ†ã¯æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã¨ã—ã¦åˆ¥é€”è«‹æ±‚ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚')) return;
  }
  if(saleFrom==='both'&&commB>limit){
    if(!confirm('è²·ä¸»å‘ã‘ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+commB.toLocaleString()+'ï¼‰ãŒæ³•å®šä¸Šé™ï¼ˆÂ¥'+limit.toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚ã“ã®ã¾ã¾ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
  }

  c.salePrice = price;
  c.invoice = Object.assign(inv, {
    saleFrom, salePrice:price, items:itemsA, itemsB, commA, commB, totalA, totalB,
    delegAmt, delegDesc, grandTotal, prop, date, due, issued:true,
    dualInvoice: saleFrom==='both',
  });

  const fromLabel = saleFrom==='seller'?'å£²ä¸»ã‹ã‚‰':saleFrom==='both'?'ä¸¡æ‰‹':' è²·ä¸»ã‹ã‚‰';
  c.hist.unshift(today()+' è«‹æ±‚æ›¸ç™ºè¡Œï¼ˆå£²è²·ãƒ»'+fromLabel+'ï¼‰ åˆè¨ˆÂ¥'+grandTotal.toLocaleString());
  invSendSlack(c, grandTotal, delegAmt, delegDesc, saleFrom==='both');
  const destStep = 'contract';
  advance(id, destStep, 'invoiced', date, 'è«‹æ±‚æ›¸ç™ºè¡Œå®Œäº†');
}

setTimeout(()=>{
  if(document.getElementById('inv-sale-price')) {
    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå†é©ç”¨
    const priceEl = document.getElementById('inv-sale-price');
    if(priceEl && priceEl.value) {
      const raw = parseInt(priceEl.value.replace(/,/g,''));
      if(!isNaN(raw)) priceEl.value = raw.toLocaleString('ja-JP');
    }
    invCalcSale();
    _invItemCountB=document.querySelectorAll('#inv-items-b .inv-row-b').length;
  }
  if(document.getElementById('inv-items')) {
    invCalc();
    _invItemCount=document.querySelectorAll('#inv-items .inv-row').length;
  }
},100);


function invVirtualAcct(caseId) {
  let h=0;
  for(let i=0;i<caseId.length;i++) h=((h<<5)-h)+caseId.charCodeAt(i);
  return String(Math.abs(h)%9000000+1000000);
}

function invSetType(btn) {
  const id = btn.dataset.cid;
  const type = btn.dataset.type;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.type = type;
  if(type==='commission'||type==='ad_plus') {
    if(!c.invoice.items||c.invoice.items.length===0) c.invoice.items=[{desc:'ä»²ä»‹æ‰‹æ•°æ–™',amt:''}];
    else c.invoice.items[0].desc='ä»²ä»‹æ‰‹æ•°æ–™';
  }
  if(type==='ad_only') c.invoice.items=[{desc:'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™',amt:''}];
  c.invoice.adFmt=null;
  c.adOnly=(type==='ad_only'||type==='ad_plus');
  open_case(id);
}

function invSetAdFmt(btn) {
  const id=btn.dataset.cid, fmt=btn.dataset.fmt;
  const c=CASES.find(x=>x.id===id); if(!c) return;
  if(!c.invoice) c.invoice={};
  c.invoice.adFmt=fmt;
  if(c.invoice.type==='ad_only'&&fmt==='standard') c.invoice.items=[{desc:'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™',amt:''}];
  open_case(id);
}

function invItemRow(idx, desc, amt, isFirst) {
  return '<div class="inv-row" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr auto auto;gap:6px;margin-bottom:6px;align-items:center">'
    +'<input type="text" placeholder="é …ç›®å" value="'+desc+'" oninput="invCalc()"'+(isFirst?' style="font-size:12px;color:var(--gold)"':' style="font-size:12px"')+'>'
    +'<input type="number" placeholder="é‡‘é¡" value="'+amt+'" oninput="invCalc()" class="mono" style="width:120px;font-size:13px">'
    +(isFirst
      ? '<div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:var(--gold);font-size:14px" title="ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆ1.1ãƒ¶æœˆä¸Šé™ãƒã‚§ãƒƒã‚¯å¯¾è±¡ï¼‰">â˜…</div>'
      : '<button onclick="invRemoveItem('+idx+')" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;padding:0;line-height:1">Ã—</button>')
    +'</div>';
}

let _invItemCount=1;
function invAddItem() {
  const wrap=document.getElementById('inv-items'); if(!wrap) return;
  const idx=_invItemCount++;
  const div=document.createElement('div');
  div.innerHTML=invItemRow(idx,'','',false);
  wrap.appendChild(div.firstChild);
  invCalc();
}
function invRemoveItem(idx) {
  document.querySelectorAll('#inv-items .inv-row').forEach(r=>{
    if(parseInt(r.dataset.idx)===idx) r.remove();
  });
  invCalc();
}
function invGetItems() {
  const rows=document.querySelectorAll('#inv-items .inv-row');
  const items=[];
  rows.forEach(r=>{
    const inputs=r.querySelectorAll('input');
    const desc=inputs[0]?.value.trim()||'';
    const amt=parseInt(inputs[1]?.value)||0;
    if(desc||amt) items.push({desc,amt});
  });
  return items;
}
function invCalc() {
  const rent=parseInt(document.getElementById('inv-rent')?.value)||0;
  const items=invGetItems();
  const commAmt=items.length>0?items[0].amt:0;
  const totalItems=items.reduce((s,it)=>s+it.amt,0);
  const adAmt=parseInt(document.getElementById('inv-ad-amt')?.value)||0;
  const grandTotal=totalItems+adAmt;
  // å£²è²·: å®…å»ºæ¥­æ³•ä¸Šé™ = (ä¾¡æ ¼Ã—3%+6ä¸‡)Ã—1.1
  const isSaleCalc = !document.getElementById('inv-rent') || (rent > 500000); // heuristic: large = å£²è²·ä¾¡æ ¼
  const saleLimit = rent<=0 ? 0 : Math.round((rent*0.03+60000)*1.1);
  const limit11 = rent<=0 ? 0 : (rent > 500000 ? saleLimit : Math.round(rent*1.1));
  const limit10 = rent;
  let html='';
  if(rent>0&&(totalItems>0||adAmt>0)){
    html+='<div style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:12px">';
    if(totalItems>0) html+='<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--sub)">è«‹æ±‚é …ç›®åˆè¨ˆ</span><span class="mono">Â¥'+totalItems.toLocaleString()+'</span></div>';
    const adDescDisp=document.getElementById('inv-ad-desc')?.value||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™';
    if(adAmt>0) html+='<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--sub)">'+adDescDisp+'ï¼ˆADï¼‰</span><span class="mono">Â¥'+adAmt.toLocaleString()+'</span></div>';
    if(adAmt>0&&totalItems>0) html+='<div style="border-top:1px solid var(--border);margin:5px 0;padding-top:5px;display:flex;justify-content:space-between"><span style="color:var(--sub);font-weight:600">åˆè¨ˆ</span><span class="mono" style="color:var(--gold);font-size:13px">Â¥'+grandTotal.toLocaleString()+'</span></div>';
    if(commAmt>0){
      if(commAmt>limit11) html+='<div style="margin-top:6px;padding:6px 10px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.4);border-radius:6px;color:var(--red);font-size:11px">â›” ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+commAmt.toLocaleString()+'ï¼‰ãŒä¸Šé™ï¼ˆÂ¥'+limit11.toLocaleString()+'ï¼‰ã‚’è¶…é â€” å®…å»ºæ¥­æ³•é•å</div>';
      else html+='<div style="margin-top:6px;padding:5px 10px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);border-radius:6px;color:var(--green);font-size:11px">âœ… ä»²ä»‹æ‰‹æ•°æ–™ Â¥'+commAmt.toLocaleString()+' ï¼ ä¸Šé™ Â¥'+limit11.toLocaleString()+(rent>500000?'ï¼ˆå£²è²·ä¾¡æ ¼Ã—3%+6ä¸‡ï¼‰Ã—1.1':'ï¼ˆå®¶è³ƒÃ—1.1)')+' â€” é©æ­£</div>';
    }
    const checkAmt=grandTotal>0?grandTotal:totalItems;
    if(checkAmt>0 && rent<=500000){
      if(checkAmt>=limit10) html+='<div style="margin-top:5px;padding:5px 10px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:6px;color:var(--blue);font-size:11px">ğŸ’° åˆè¨ˆ Â¥'+checkAmt.toLocaleString()+' â‰¥ å®¶è³ƒ1ãƒ¶æœˆï¼ˆÂ¥'+limit10.toLocaleString()+'ï¼‰ â€” é©æ­£</div>';
      else html+='<div style="margin-top:5px;padding:5px 10px;background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.4);border-radius:6px;color:var(--orange);font-size:11px">âš  åˆè¨ˆ Â¥'+checkAmt.toLocaleString()+' ãŒå®¶è³ƒ1ãƒ¶æœˆï¼ˆÂ¥'+limit10.toLocaleString()+'ï¼‰æœªæº€</div>';
      const rw=document.getElementById('inv-reason-wrap');
      if(rw) rw.style.display=(checkAmt<limit10)?'block':'none';
    }
    html+='</div>';
  }
  const vp=document.getElementById('inv-validation');
  if(vp) vp.innerHTML=html;
}


function issueInvoice(id) {
  const c=CASES.find(x=>x.id===id); if(!c) return;
  const inv=c.invoice||{};
  const type=inv.type||'commission';
  const adFmt=inv.adFmt||null;
  const prop=document.getElementById('inv-prop')?.value.trim();
  const date=document.getElementById('inv-date')?.value;
  const due=document.getElementById('inv-due')?.value;
  const rent=parseInt(document.getElementById('inv-rent')?.value)||0;
  const reason=document.getElementById('inv-reason')?.value.trim()||'';
  const adAmt=parseInt(document.getElementById('inv-ad-amt')?.value)||0;
  const adDesc=document.getElementById('inv-ad-desc')?.value.trim()||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™';
  if(!prop){alert('ç‰©ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  // ADçµ¡ã‚€ï¼‹æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚ã‚Š
  if((type==='ad_only'||type==='ad_plus')&&adFmt==='custom'){
    if(!adAmt){alert('æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
    c.adOnly=true;
    c.invoice=Object.assign(inv,{type,adFmt,adAmt,adDesc,prop,date,due,issued:true,grandTotal:adAmt});
    c.hist.unshift(today()+' ADè«‹æ±‚ï¼ˆæŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰Â¥'+adAmt.toLocaleString()+' å£åº§æƒ…å ±æç¤º');
    const destStep2 = (c.type==='reSale'||c.type==='sannai') ? 'contract' : 'prekey';
  advance(id,destStep2,'invoiced',date,'ADè«‹æ±‚æ›¸ï¼ˆæŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰ç™ºè¡Œ');
    return;
  }

  const items=invGetItems();
  const commAmt=items.length>0?items[0].amt:0;
  const totalItems=items.reduce((s,it)=>s+it.amt,0);
  const grandTotal=totalItems+adAmt;
  if(items.length===0||totalItems===0){alert('è«‹æ±‚é …ç›®ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(rent>0&&commAmt>Math.round(rent*1.1)){alert('ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆÂ¥'+commAmt.toLocaleString()+'ï¼‰ãŒä¸Šé™ï¼ˆÂ¥'+Math.round(rent*1.1).toLocaleString()+'ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚');return;}
  if(rent>0&&grandTotal<rent&&!reason){alert('åˆè¨ˆãŒå®¶è³ƒ1ãƒ¶æœˆåˆ†æœªæº€ã®ãŸã‚ç†ç”±ã®è¨˜å…¥ãŒå¿…è¦ã§ã™ã€‚');return;}
  c.adOnly=(type==='ad_only'||type==='ad_plus');
  const dualInv=(type==='ad_plus'&&adFmt==='standard');
  c.invoice=Object.assign(inv,{type,adFmt,items,commAmt,totalItems,adAmt,adDesc,grandTotal,rent,prop,date,due,underReason:reason,issued:true,dualInvoice:dualInv});
  const adLabel=adAmt>0?' æ¥­å‹™å§”è¨—Â¥'+adAmt.toLocaleString():'';
  c.hist.unshift(today()+' è«‹æ±‚æ›¸ç™ºè¡Œ åˆè¨ˆÂ¥'+grandTotal.toLocaleString()+adLabel+(dualInv?' [2æš]':''));
  invSendSlack(c, grandTotal, adAmt, adDesc, dualInv);
  const destStep = (c.type==='reSale'||c.type==='sannai') ? 'contract' : 'prekey';
  advance(id,destStep,'invoiced',date,'è«‹æ±‚æ›¸ç™ºè¡Œå®Œäº†');
}


function invSendSlack(c, grandTotal, adAmt, adDesc, dualInv) {
  const inv = c.invoice || {};
  const isSaleType = c.type==='reSale' || c.type==='sannai';
  const saleFromLabel = inv.saleFrom==='both' ? 'ä¸¡æ‰‹ï¼ˆå£²ä¸»ï¼‹è²·ä¸»ï¼‰' : inv.saleFrom==='buyer' ? 'è²·ä¸»ã‹ã‚‰' : 'å£²ä¸»ã‹ã‚‰';
  const typeLabel = isSaleType
    ? ('å£²è²·ä»²ä»‹ / '+saleFromLabel)
    : (inv.type==='commission' ? 'ä»²ä»‹æ‰‹æ•°æ–™ã®ã¿' : inv.type==='ad_plus' ? 'ADï¼‹ä»²ä»‹æ‰‹æ•°æ–™' : 'ADã®ã¿');
  const fmtLabel = inv.adFmt==='custom' ? 'æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ' : inv.adFmt==='standard' ? 'CORETOæ¨™æº–' : 'â€”';
  const lines = [
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    'ğŸ§¾ *è«‹æ±‚æ›¸ç™ºè¡Œé€šçŸ¥*',
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    `ğŸ“ *æ¡ˆä»¶ID*ï¼š${c.id}`,
    `ğŸ‘¤ *ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ*ï¼š${c.name}`,
    `ğŸ  *ç‰©ä»¶*ï¼š${inv.prop||c.sub||'â€”'}`,
    `ğŸ“‹ *ç¨®åˆ¥*ï¼š${typeLabel}`,
    isSaleType && inv.salePrice ? `ğŸ’´ *å£²è²·ä¾¡æ ¼*ï¼šÂ¥${parseInt(inv.salePrice).toLocaleString()}` : null,
    !isSaleType && inv.rent ? `ğŸ· *å®¶è³ƒ*ï¼šÂ¥${parseInt(inv.rent).toLocaleString()}` : null,
    inv.commAmt ? `ğŸ’´ *ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆå£²ä¸»ï¼‰*ï¼šÂ¥${parseInt(inv.commAmt).toLocaleString()}` : null,
    inv.commB  ? `ğŸ’´ *ä»²ä»‹æ‰‹æ•°æ–™ï¼ˆè²·ä¸»ï¼‰*ï¼šÂ¥${parseInt(inv.commB).toLocaleString()}` : null,
    adAmt ? `ğŸ’¼ *${adDesc||'æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™'}*ï¼šÂ¥${parseInt(adAmt).toLocaleString()}` : null,
    `ğŸ’° *åˆè¨ˆ*ï¼šÂ¥${parseInt(grandTotal).toLocaleString()}`,
    isSaleType && dualInv ? 'ğŸ“„ è«‹æ±‚æ›¸2æšç™ºè¡Œï¼ˆä¸¡æ‰‹ï¼‰' : null,
    !isSaleType && dualInv ? 'ğŸ“„ è«‹æ±‚æ›¸2æšç™ºè¡Œï¼ˆä»²ä»‹ï¼‹æ¥­å‹™å§”è¨—ï¼‰' : null,
    !isSaleType && inv.adFmt ? `ğŸ“‹ ç®¡ç†ä¼šç¤¾ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š${fmtLabel}` : null,
    inv.underReason ? `âš  æ¸›é¡ãƒ»ç†ç”±ï¼š${inv.underReason}` : null,
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    `ğŸ• ${new Date().toLocaleString('ja-JP')}`,
  ].filter(Boolean).join('\n');

  // æœ¬ç•ª: SLACK_WEBHOOK_URL ã« fetch POST
  console.log('[Slack #è«‹æ±‚æ›¸] ', lines);

  // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
  try {
    const ta = document.createElement('textarea');
    ta.value = lines; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  } catch(e) {}

  toast('Slack #è«‹æ±‚æ›¸ ã«é€ä¿¡ã—ã¾ã—ãŸ âœ…');
}

function editInvoice(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™: stepã‚’invoiceã«ã€issued ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
  if(c.invoice) c.invoice.issued = false;
  c.step = 'invoice';  // reSale will return to contract after re-issue
  c.hist.unshift(today()+' è«‹æ±‚æ›¸ä¿®æ­£ï¼ˆå†ç·¨é›†ï¼‰');
  open_case(id);
}


function paymentCheck(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.taskDone) c.taskDone={};
  c.taskDone.paid = true;
  c.dates.paid = todayISO();
  c.hist.unshift(today()+' å…¥é‡‘ç¢ºèªæ¸ˆ');
  // If both done, auto-advance step display
  open_case(id); toast('å…¥é‡‘ç¢ºèªã—ã¾ã—ãŸ');
}
function itsetsuCheck(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.taskDone) c.taskDone={};
  c.taskDone.itsetsu = true;
  c.dates.itsetsu = todayISO();
  c.hist.unshift(today()+' ITé‡èª¬å®Œäº†');
  open_case(id); toast('é‡èª¬å®Œäº†ã—ã¾ã—ãŸ');
}


function keyDone(id) {
  const d = document.getElementById('s-chinkaku')?.value || todayISO();
  const c = CASES.find(x=>x.id===id);
  c.dates.chinkaku = d;
  advance(id,'done',null,null,'éµæ¸¡ã—å®Œäº† (è³ƒç™ºæ—¥: '+d+') â†’ æˆç´„');
}

// å£²è²·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸‰ç‚º STEP FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function stepSannaiOffer(c) {
  const today = new Date().toISOString().slice(0,10);
  const skipLabel = c.dates.naiken ? '' : '<span style="font-size:10px;color:var(--orange);margin-left:8px">å†…è¦‹ãªã—</span>';
  const sn = c.sannai || {};
  const commPayMode = sn.commPayMode || 'none'; // none / buy / sell / both
  const delegRows   = sn.delegPay   || [];
  const id = c.id;

  // ä»²ä»‹æ‰‹æ•°æ–™æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
  const commModes = [
    {v:'none', label:'ãªã—'},
    {v:'buy',  label:'è²·ã„å´'},
    {v:'sell', label:'å£²ã‚Šå´'},
    {v:'both', label:'ä¸¡å´'},
  ];
  const commModeBtns = commModes.map(m => {
    const active = commPayMode === m.v;
    const bg = active ? 'background:var(--orange);color:#000' : 'background:var(--card2);color:var(--sub)';
    return '<button onclick="sannaiSetCommMode(this)" data-cid="'+id+'" data-mode="'+m.v+'" style="flex:1;padding:6px 2px;border:none;cursor:pointer;font-size:11px;font-weight:600;border-radius:6px;'+bg+'">'+m.label+'</button>';
  }).join('');

  // ä»²ä»‹æ‰‹æ•°æ–™å…¥åŠ›æ¬„ï¼ˆãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰
  let commPayFields = '';
  if (commPayMode === 'buy' || commPayMode === 'both') {
    commPayFields += '<div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:end;margin-top:8px">'
      +'<div class="fi" style="margin-bottom:0"><label style="color:var(--blue)">è²·ã„å´ ä»²ä»‹ä¼šç¤¾å</label>'
      +'<input type="text" id="sn-comm-buy-co" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã€‡ã€‡ä¸å‹•ç”£" value="'+(sn.commBuyCo||'')+'" style="font-size:12px"></div>'
      +'<div class="fi" style="margin-bottom:0"><label style="color:var(--blue)">é‡‘é¡ï¼ˆç¨è¾¼ï¼‰</label>'
      +'<input type="text" id="sn-comm-buy-amt" class="mono" placeholder="0" value="'+(sn.commBuyAmt?fmtYen(sn.commBuyAmt):'')+'" oninput="invSalePriceInput(this)" style="width:110px;font-size:13px"></div>'
      +'</div>';
  }
  if (commPayMode === 'sell' || commPayMode === 'both') {
    commPayFields += '<div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:end;margin-top:8px">'
      +'<div class="fi" style="margin-bottom:0"><label style="color:var(--green)">å£²ã‚Šå´ ä»²ä»‹ä¼šç¤¾å</label>'
      +'<input type="text" id="sn-comm-sell-co" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã€‡ã€‡ä¸å‹•ç”£" value="'+(sn.commSellCo||'')+'" style="font-size:12px"></div>'
      +'<div class="fi" style="margin-bottom:0"><label style="color:var(--green)">é‡‘é¡ï¼ˆç¨è¾¼ï¼‰</label>'
      +'<input type="text" id="sn-comm-sell-amt" class="mono" placeholder="0" value="'+(sn.commSellAmt?fmtYen(sn.commSellAmt):'')+'" oninput="invSalePriceInput(this)" style="width:110px;font-size:13px"></div>'
      +'</div>';
  }

  // æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™è¡Œ
  const delegHtml = delegRows.map((r,i) => sannaiDelegRow(i, r)).join('');

  // ç²—åˆ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  const profitHtml = sannaiProfitPreview(sn, c.salePrice || sn.sellPrice || 0);

  return '<div class="step-title">ğŸ“„ è²·ä»˜ï¼ˆä¸‰ç‚ºï¼‰'+skipLabel+'</div>'
    +'<div class="fi"><label>ç‰©ä»¶å</label><input type="text" id="s-sale-prop" value="'+(c.dates.naikenProp||'')+'" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·"></div>'
    +'<div class="fi"><label>è²·ä»˜æ—¥</label><input type="date" id="s-offer-date" class="mono" value="'+today+'"></div>'

    // â”€â”€ å–å¼•ä¾¡æ ¼ â”€â”€
    +'<div style="margin:12px 0 8px;padding:12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:10px">'
    +'<div style="font-size:10px;color:var(--gold);font-weight:700;letter-spacing:.8px;margin-bottom:10px">ğŸ’´ å–å¼•ä¾¡æ ¼</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'
    +'<div class="fi" style="margin-bottom:0"><label>ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰<br><span style="font-size:9px;color:var(--muted);font-weight:400">å£²ä¸»ã¸ã®æ”¯æ‰•ã„</span></label>'
    +'<input type="text" id="sn-buy-price" class="mono" placeholder="ä¾‹: 40,000,000" value="'+(sn.buyPrice?fmtYen(sn.buyPrice):'')+'" oninput="sannaiCalcProfit()" style="font-size:13px"></div>'
    +'<div class="fi" style="margin-bottom:0"><label>è²©å£²ä¾¡æ ¼ï¼ˆå††ï¼‰<br><span style="font-size:9px;color:var(--muted);font-weight:400">è²·ä¸»ã‹ã‚‰ã®å—å–</span></label>'
    +'<input type="text" id="sn-sell-price" class="mono" placeholder="ä¾‹: 45,000,000" value="'+(sn.sellPrice||c.salePrice?fmtYen(sn.sellPrice||c.salePrice):'')+'" oninput="sannaiCalcProfit()" style="font-size:13px"></div>'
    +'</div>'
    +'<div id="sn-spread" style="margin-top:8px"></div>'
    +'</div>'

    // â”€â”€ æ”¯æ‰•ã„ä»²ä»‹æ‰‹æ•°æ–™ â”€â”€
    +'<div style="margin:10px 0 8px;padding:12px;background:rgba(251,146,60,.04);border:1px solid rgba(251,146,60,.15);border-radius:10px">'
    +'<div style="font-size:10px;color:var(--orange);font-weight:700;letter-spacing:.8px;margin-bottom:8px">ğŸ’¸ æ”¯æ‰•ã„ä»²ä»‹æ‰‹æ•°æ–™</div>'
    +'<div style="display:flex;gap:4px;background:var(--card2);padding:3px;border-radius:7px">'+commModeBtns+'</div>'
    +commPayFields
    +'</div>'

    // â”€â”€ æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™ï¼ˆæ”¯æ‰•ã„ï¼‰ â”€â”€
    +'<div style="margin:10px 0 8px;padding:12px;background:rgba(167,139,250,.04);border:1px solid rgba(167,139,250,.15);border-radius:10px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<div style="font-size:10px;color:var(--purple);font-weight:700;letter-spacing:.8px">ğŸ“‹ æ”¯æ‰•ã„æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™</div>'
    +'<button data-cid="'+id+'" onclick="sannaiAddDeleg(this.dataset.cid)" style="background:rgba(167,139,250,.15);border:1px solid rgba(167,139,250,.3);color:var(--purple);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:10px;font-weight:600">ï¼‹ è¿½åŠ </button>'
    +'</div>'
    +(delegRows.length === 0
      ? '<div style="font-size:11px;color:var(--muted);text-align:center;padding:8px">ãªã—ï¼ˆï¼‹ è¿½åŠ ã§å…¥åŠ›ï¼‰</div>'
      : '<div id="sn-deleg-rows">'+delegHtml+'</div>')
    +'</div>'

    +profitHtml
    +'<button class="btn btn-green" style="width:100%;justify-content:center;margin-top:14px" data-cid="'+id+'" onclick="sannaiOfferDone(this.dataset.cid)">è²·ä»˜å—é ˜ â†’ è«‹æ±‚æ›¸ã¸</button>';
}

// â”€â”€ ä¸‰ç‚º: æ¥­å‹™å§”è¨—æ‰‹æ•°æ–™è¡ŒHTML â”€â”€
function sannaiDelegRow(idx, r) {
  r = r || {};
  const typeOpts = [
    {v:'broker', label:'ä»²ä»‹ä¼šç¤¾'},
    {v:'other',  label:'ãã®ä»–'},
  ];
  const typeHtml = typeOpts.map(o =>
    '<option value="'+o.v+'"'+(r.type===o.v?' selected':'')+'>'+o.label+'</option>'
  ).join('');
  return '<div class="sn-deleg-row" data-idx="'+idx+'" style="display:grid;grid-template-columns:1fr 90px 100px auto;gap:5px;margin-bottom:6px;align-items:center">'
    +'<input type="text" placeholder="ä¼šç¤¾å / å†…å®¹" value="'+(r.co||'')+'" style="font-size:11px">'
    +'<select style="background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:5px 6px;color:var(--sub);font-size:10px;font-family:inherit">'+typeHtml+'</select>'
    +'<input type="text" placeholder="é‡‘é¡ï¼ˆç¨è¾¼ï¼‰" value="'+(r.amt?fmtYen(r.amt):'')+'" class="mono" style="font-size:12px" oninput="invSalePriceInput(this)">'
    +'<button onclick="sannaiRemoveDeleg(this)" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--red);border-radius:6px;width:26px;height:26px;cursor:pointer;font-size:13px;padding:0">Ã—</button>'
    +'</div>';
}

function sannaiRemoveDeleg(btn) {
  btn.closest('.sn-deleg-row')?.remove();
  sannaiCalcProfit();
}

function sannaiAddDeleg(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  sannaiReadOfferForm(id); // å…¥åŠ›ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰å†æç”»
  if(!c.sannai) c.sannai = {};
  if(!c.sannai.delegPay) c.sannai.delegPay = [];
  c.sannai.delegPay.push({co:'', type:'broker', amt:0});
  open_case(id);
}

function sannaiSetCommMode(btn) {
  const id = btn.dataset.cid, mode = btn.dataset.mode;
  const c = CASES.find(x=>x.id===id); if(!c) return;
  sannaiReadOfferForm(id); // å…¥åŠ›ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰å†æç”»
  if(!c.sannai) c.sannai = {};
  c.sannai.commPayMode = mode;
  open_case(id);
}

function sannaiCalcProfit() {
  const buyPrice  = parseInt((document.getElementById('sn-buy-price')?.value||'').replace(/,/g,''))||0;
  const sellPrice = parseInt((document.getElementById('sn-sell-price')?.value||'').replace(/,/g,''))||0;
  const spread = sellPrice - buyPrice;

  // collect comm costs
  const commBuy  = parseInt((document.getElementById('sn-comm-buy-amt')?.value||'').replace(/,/g,''))||0;
  const commSell = parseInt((document.getElementById('sn-comm-sell-amt')?.value||'').replace(/,/g,''))||0;

  // collect deleg costs
  let delegTotal = 0;
  document.querySelectorAll('.sn-deleg-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    delegTotal += parseInt((inputs[1]?.value||'').replace(/,/g,''))||0;
  });

  const totalCost = commBuy + commSell + delegTotal;
  const profit = spread - totalCost;

  const el = document.getElementById('sn-spread');
  if (!el) return;
  if (!buyPrice && !sellPrice) { el.innerHTML = ''; return; }

  let html = '<div style="display:grid;grid-template-columns:auto 1fr;gap:3px 10px;font-size:11px;margin-top:4px">';
  if(buyPrice>0) html += '<span style="color:var(--muted)">ä»•å…¥ã‚Œ</span><span class="mono" style="color:var(--sub)">Â¥'+buyPrice.toLocaleString()+'</span>';
  if(sellPrice>0) html += '<span style="color:var(--muted)">è²©å£²</span><span class="mono" style="color:var(--sub)">Â¥'+sellPrice.toLocaleString()+'</span>';
  if(buyPrice>0 && sellPrice>0) {
    const spreadColor = spread >= 0 ? 'var(--green)' : 'var(--red)';
    html += '<span style="color:var(--muted)">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰</span><span class="mono" style="color:'+spreadColor+';font-weight:700">'+(spread>=0?'+':'')+'Â¥'+spread.toLocaleString()+'</span>';
  }
  if(totalCost > 0) {
    html += '<span style="color:var(--muted)">æ”¯æ‰•æ‰‹æ•°æ–™è¨ˆ</span><span class="mono" style="color:var(--orange)">-Â¥'+totalCost.toLocaleString()+'</span>';
    const profitColor = profit >= 0 ? 'var(--green)' : 'var(--red)';
    html += '<span style="color:var(--muted);font-weight:700">æ¦‚ç®—ç²—åˆ©</span><span class="mono" style="color:'+profitColor+';font-weight:700;font-size:13px">'+(profit>=0?'+':'')+'Â¥'+profit.toLocaleString()+'</span>';
  }
  html += '</div>';
  el.innerHTML = html;
}

function sannaiProfitPreview(sn, fallbackSell) {
  const bp = sn.buyPrice || 0;
  const sp = sn.sellPrice || fallbackSell || 0;
  if (!bp && !sp) return '';
  const spread = sp - bp;
  const commBuy = sn.commBuyAmt || 0;
  const commSell = sn.commSellAmt || 0;
  const delegTotal = (sn.delegPay || []).reduce((s, r) => s + (r.amt || 0), 0);
  const totalCost = commBuy + commSell + delegTotal;
  const profit = spread - totalCost;
  const profitColor = profit >= 0 ? 'var(--green)' : 'var(--red)';
  if (!totalCost) return '';
  return '<div style="padding:8px 12px;background:rgba(52,211,153,.04);border:1px solid rgba(52,211,153,.15);border-radius:8px;margin-bottom:8px;font-size:11px">'
    +'<div style="display:flex;justify-content:space-between">'
    +'<span style="color:var(--muted)">æ¦‚ç®—ç²—åˆ©</span>'
    +'<span class="mono" style="color:'+profitColor+';font-weight:700">'+(profit>=0?'+':'')+'Â¥'+profit.toLocaleString()+'</span>'
    +'</div></div>';
}

function sannaiReadOfferForm(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.sannai) c.sannai = {};
  const sn = c.sannai;

  const buyPrice  = parseInt((document.getElementById('sn-buy-price')?.value||'').replace(/,/g,''))||0;
  const sellPrice = parseInt((document.getElementById('sn-sell-price')?.value||'').replace(/,/g,''))||0;

  if(buyPrice)  sn.buyPrice  = buyPrice;
  if(sellPrice) { sn.sellPrice = sellPrice; c.salePrice = sellPrice; }

  // comm pay
  const commBuyCo  = document.getElementById('sn-comm-buy-co')?.value.trim()||'';
  const commBuyAmt = parseInt((document.getElementById('sn-comm-buy-amt')?.value||'').replace(/,/g,''))||0;
  const commSellCo  = document.getElementById('sn-comm-sell-co')?.value.trim()||'';
  const commSellAmt = parseInt((document.getElementById('sn-comm-sell-amt')?.value||'').replace(/,/g,''))||0;
  if(commBuyCo)  sn.commBuyCo  = commBuyCo;
  if(commBuyAmt) sn.commBuyAmt = commBuyAmt;
  if(commSellCo)  sn.commSellCo  = commSellCo;
  if(commSellAmt) sn.commSellAmt = commSellAmt;

  // deleg rows
  const rows = [];
  document.querySelectorAll('.sn-deleg-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const selects = row.querySelectorAll('select');
    const co  = inputs[0]?.value.trim()||'';
    const type = selects[0]?.value||'broker';
    const amt  = parseInt((inputs[1]?.value||'').replace(/,/g,''))||0;
    if(co || amt) rows.push({co, type, amt});
  });
  sn.delegPay = rows;
}

function sannaiOfferDone(id) {
  try {
    const prop  = document.getElementById('s-sale-prop')?.value.trim()||'';
    const d     = document.getElementById('s-offer-date')?.value||todayISO();
    const c = CASES.find(x=>x.id===id); if(!c) return;
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];

    sannaiReadOfferForm(id);

    const sn = c.sannai || {};
    if(prop) c.dates.naikenProp = prop;
    if(!c.invoice) c.invoice = {type:'commission'};

    // Build hist memo
    const bp = sn.buyPrice ? ' ä»•å…¥Â¥'+sn.buyPrice.toLocaleString() : '';
    const sp = sn.sellPrice ? ' è²©å£²Â¥'+sn.sellPrice.toLocaleString() : '';
    advance(id,'invoice','offer',d,'è²·ä»˜å—é ˜'+bp+sp+' â†’ è«‹æ±‚æ›¸ã¸');
  } catch(e) { console.error('sannaiOfferDone:', e); }
}

function stepSannaiVerify(c) {
  const b   = c.buyer || {};
  const id  = c.id;
  const state = b.verifyState || 'input'; // 'input' | 'pending' | 'verified'

  // â”€â”€ èªè¨¼æ¸ˆã¿ â†’ è²·ä»˜ã¸é€²ã‚€ â”€â”€
  if (state === 'verified') {
    const isSpecial = b.isSpecial || false;
    const statusTxt = isSpecial
      ? 'âœ… ç‰¹ä¾‹æ‰¿èªæ¸ˆ â€” æœ¬éƒ¨æ‰¿èªã‚³ãƒ¼ãƒ‰ç¢ºèªæ¸ˆ'
      : 'âœ… å®…å»ºæ¥­è€…ç¢ºèªæ¸ˆ â€” ' + (b.takkenNum||'');
    const buyerName = b.name ? b.name : '';
    return '<div class="step-title">ğŸ” è²·ä¸»æ¥­è€…ç¢ºèªï¼ˆä¸‰ç‚ºï¼‰</div>'
      +'<div style="padding:12px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);border-radius:8px;margin-bottom:12px;font-size:11px">'
      +'<div style="color:var(--green);font-weight:700;margin-bottom:4px">'+statusTxt+'</div>'
      +'<div style="color:var(--sub)">è²·ä¸»: '+buyerName+'</div>'
      +'</div>'
      +'<button class="btn btn-green" style="width:100%;justify-content:center" data-cid="'+id+'" onclick="sannaiVerifyPass(this.dataset.cid)">â†’ è²·ä»˜å…¥åŠ›ã¸</button>'
      +'<div style="margin-top:8px;text-align:right">'
      +'<button class="btn btn-ghost btn-sm" data-cid="'+id+'" onclick="sannaiVerifyReset(this.dataset.cid)">â†© å†å…¥åŠ›</button>'
      +'</div>';
  }

  // â”€â”€ ç¢ºèªä¾é ¼é€ä¿¡æ¸ˆã¿ â†’ ã‚³ãƒ¼ãƒ‰å…¥åŠ›å¾…ã¡ â”€â”€
  const pendingHtml = (state === 'pending') ? (
    '<div style="margin-bottom:12px;padding:10px 12px;background:rgba(79,156,249,.08);border:1px solid rgba(79,156,249,.3);border-radius:8px;font-size:11px">'
    +'<div style="color:var(--blue);font-weight:700;margin-bottom:4px">ğŸ“¨ ç¢ºèªä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ</div>'
    +'<div style="color:var(--sub)">è²·ä¸»: '+(b.name||'â€”')+(b.takkenNum?' / '+b.takkenNum:'')+'</div>'
    +'<div style="color:var(--muted);margin-top:3px;font-size:10px">æœ¬éƒ¨ã‹ã‚‰ã®æ‰¿èªã‚³ãƒ¼ãƒ‰ã‚’ãŠå¾…ã¡ãã ã•ã„</div>'
    +'</div>'
  ) : '';

  // â”€â”€ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆinput ã¾ãŸã¯ pendingï¼‰ â”€â”€
  const showForm = (state === 'input');
  return '<div class="step-title">ğŸ” è²·ä¸»æ¥­è€…ç¢ºèªï¼ˆä¸‰ç‚ºï¼‰</div>'
    +'<div style="padding:10px 12px;background:rgba(79,156,249,.06);border:1px solid rgba(79,156,249,.2);border-radius:8px;margin-bottom:12px;font-size:11px;color:var(--sub)">'
    +'ä¸‰ç‚ºå–å¼•ã§ã¯è²·ä¸»ã®å®…å»ºæ¥­è€…ç¢ºèªãŒå¿…è¦ã§ã™ã€‚æƒ…å ±ã‚’å…¥åŠ›ã—æœ¬éƒ¨ã«ç¢ºèªä¾é ¼ã‚’é€ã£ã¦ãã ã•ã„ã€‚ä¸€èˆ¬æ³•äººã¸ã®è²©å£²ã®å ´åˆã‚‚æœ¬éƒ¨ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã‚Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
    +'</div>'
    + pendingHtml
    +(showForm
      ? '<div class="fi"><label>è²·ä¸» ä¼šç¤¾å</label><input type="text" id="sn-buyer-name" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã€‡ã€‡ä¸å‹•ç”£" value="'+(b.name||'')+'"></div>'
        +'<div class="fi"><label>å®…å»ºæ¥­è€…ç•ªå· <span style="font-size:10px;color:var(--muted);font-weight:400">ï¼ˆä¸€èˆ¬æ³•äººã®å ´åˆã¯ç©ºæ¬„å¯ï¼‰</span></label><input type="text" id="sn-takken" class="mono" placeholder="ä¾‹: æ±äº¬éƒ½çŸ¥äº‹ï¼ˆ3ï¼‰ç¬¬12345å·" value="'+(b.takkenNum||'')+'" style="font-size:12px"></div>'
        +'<button class="btn btn-blue" style="width:100%;justify-content:center;margin-top:4px" data-cid="'+id+'" onclick="sannaiRequestVerify(this.dataset.cid)">ğŸ“¨ æœ¬éƒ¨ã«ç¢ºèªä¾é ¼ã‚’é€ã‚‹</button>'
      : '<div style="display:flex;gap:6px;margin-bottom:8px">'
        +'<button class="btn btn-ghost btn-sm" data-cid="'+id+'" onclick="sannaiVerifyReset(this.dataset.cid)" style="flex-shrink:0">â†© å†å…¥åŠ›</button>'
        +'</div>'
    )
    +'<div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border)">'
    +'<div style="font-size:10px;color:var(--muted);margin-bottom:6px;font-weight:600;letter-spacing:.5px">ğŸ”‘ æœ¬éƒ¨æ‰¿èªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>'
    +'<div style="display:flex;gap:6px">'
    +'<input type="text" id="sn-verify-code" placeholder="ä¾‹: K7X9QM" maxlength="8" style="flex:1;background:#090b13;border:1px solid var(--border2);border-radius:7px;padding:7px 10px;color:var(--text);font-size:14px;font-family:var(--mono);letter-spacing:.15em;text-transform:uppercase" oninput="this.value=this.value.toUpperCase()">'
    +'<button class="btn btn-gold btn-sm" style="font-weight:700;letter-spacing:.05em" data-cid="'+id+'" onclick="sannaiEnterCode(this.dataset.cid)">èªè¨¼</button>'
    +'</div>'
    +'<div style="font-size:10px;color:var(--muted);margin-top:5px">æœ¬éƒ¨ã‹ã‚‰å—ã‘å–ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'
    +'</div>';
}

// æœ¬éƒ¨ã«Slacké€šçŸ¥ â†’ ãƒšãƒ¼ã‚¸å†…ã§ã¯ pending çŠ¶æ…‹ã«ã™ã‚‹
function sannaiRequestVerify(id) {
  const name   = document.getElementById('sn-buyer-name')?.value.trim()||'';
  const takken = document.getElementById('sn-takken')?.value.trim()||'';
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!name) { alert('è²·ä¸»ã®ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(!c.buyer) c.buyer = {};

  // 6æ¡è‹±æ•°å­—ã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆ
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for(let i=0;i<6;i++) code += chars[Math.floor(Math.random()*chars.length)];

  c.buyer.name        = name;
  c.buyer.takkenNum   = takken;
  c.buyer.pendingCode = code;
  c.buyer.verifyState = 'pending';
  c.buyer.isSpecial   = !takken; // å®…å»ºç•ªå·ãªã— = ä¸€èˆ¬æ³•äººæ‰±ã„

  const isSpecial = !takken;
  const lines = [
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    isSpecial ? 'âš  *ä¸‰ç‚º æ¥­è€…ç¢ºèªä¾é ¼ï¼ˆä¸€èˆ¬æ³•äººç‰¹ä¾‹ï¼‰*' : 'ğŸ” *ä¸‰ç‚º æ¥­è€…ç¢ºèªä¾é ¼*',
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    `ğŸ“ *æ¡ˆä»¶ID*ï¼š${id}`,
    `ğŸ  *ç‰©ä»¶*ï¼š${c.dates?.naikenProp||c.sub||'â€”'}`,
    `ğŸ¢ *è²·ä¸»*ï¼š${name}`,
    takken ? `ğŸ“‹ *å®…å»ºç•ªå·*ï¼š${takken}` : 'ğŸ“‹ *å®…å»ºç•ªå·*ï¼šï¼ˆæœªå…¥åŠ› / ä¸€èˆ¬æ³•äººï¼‰',
    `ğŸ”‘ *æ‰¿èªã‚³ãƒ¼ãƒ‰*ï¼š\`${code}\``,
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    'âœ… ç¢ºèªå¾Œã€ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ä¼é”ã—ã¦ãã ã•ã„',
    `ğŸ• ${new Date().toLocaleString('ja-JP')}`,
  ].join('\n');

  console.log('[Slack #ä¸‰ç‚ºç¢ºèª]\n', lines);
  // Slack webhook é€ä¿¡ï¼ˆãƒ¢ãƒƒã‚¯: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼‰
  try {
    const ta=document.createElement('textarea');
    ta.value=lines; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  } catch(e){}

  c.hist.unshift(today()+' æ¥­è€…ç¢ºèªä¾é ¼é€ä¿¡ / è²·ä¸»: '+name+(takken?' ('+takken+')':'ï¼ˆä¸€èˆ¬æ³•äººï¼‰'));
  open_case(id);
  toast('ç¢ºèªä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ â€” æœ¬éƒ¨ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã£ã¦ãã ã•ã„');
}


function editSannaiOffer(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  c.step = 'offer';
  open_case(id);
}


function sannaiVerifyPass(id) {
  // èªè¨¼æ¸ˆã¿ç¢ºèªå¾Œã€è²·ä»˜ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€
  try {
    const c = CASES.find(x=>x.id===id); if(!c) return;
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(!c.invoice) c.invoice = {type:'commission'};
    advance(id,'offer',null,null,'æ¥­è€…ç¢ºèªæ¸ˆ â†’ è²·ä»˜ã¸');
  } catch(e) { console.error('sannaiVerifyPass:', e); }
}

function sannaiVerifyReset(id) {
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!c.buyer) c.buyer = {};
  c.buyer.verifyState = 'input';
  c.buyer.pendingCode = null;
  c.buyer.verified    = false;
  open_case(id);
}

function sannaiEnterCode(id) {
  const code = (document.getElementById('sn-verify-code')?.value||'').trim().toUpperCase();
  const c = CASES.find(x=>x.id===id); if(!c) return;
  if(!code) { alert('æ‰¿èªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(!c.buyer) { alert('å…ˆã«ç¢ºèªä¾é ¼ã‚’é€ä¿¡ã—ã¦ãã ã•ã„'); return; }

  const expectedCode = c.buyer.pendingCode;
  if(!expectedCode) {
    alert('ç¢ºèªä¾é ¼ãŒã¾ã é€ä¿¡ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ã€Œæœ¬éƒ¨ã«ç¢ºèªä¾é ¼ã‚’é€ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  if(code !== expectedCode) {
    alert('æ‰¿èªã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚æœ¬éƒ¨ã‹ã‚‰å—ã‘å–ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå…¥åŠ›: ' + code);
    return;
  }

  // èªè¨¼æˆåŠŸ
  c.buyer.verified    = true;
  c.buyer.verifyState = 'verified';
  c.hist.unshift(today()+' æ¥­è€…ç¢ºèªå®Œäº† / '+c.buyer.name+(c.buyer.takkenNum?' ('+c.buyer.takkenNum+')':'ï¼ˆä¸€èˆ¬æ³•äººæ‰¿èªï¼‰'));
  open_case(id);
  toast('âœ… æ¥­è€…ç¢ºèªå®Œäº† â€” è²·ä»˜å…¥åŠ›ã¸é€²ã‚“ã§ãã ã•ã„');
}




function saleContractDone(id) { advance(id,'settlement','contract',todayISO(),'å£²è²·å¥‘ç´„ç· çµ'); }
function settlementDone(id) {
  const d = document.getElementById('s-settlement')?.value||todayISO();
  advance(id,'done','settlement',d,'æ±ºæ¸ˆå®Œäº† (æ±ºæ¸ˆæ—¥: '+d+') â†’ æˆç´„');
}

function offerDone(id) {
  try {
    const prop  = document.getElementById('s-sale-prop')?.value.trim()||'';
    const price = parseInt((document.getElementById('s-sale-price')?.value||'').replace(/,/g,''))||0;
    const d     = document.getElementById('s-offer-date')?.value||todayISO();
    const c = CASES.find(x=>x.id===id);
    if(!c) { console.error('offerDone: case not found', id); return; }
    if(!c.dates) c.dates = {};
    if(!c.hist)  c.hist  = [];
    if(prop)  c.dates.naikenProp = prop;
    if(price) c.salePrice = price;
    if(!c.invoice) c.invoice = {type:'commission'};
    advance(id,'invoice','offer',d,'è²·ä»˜å—é ˜ â†’ è«‹æ±‚æ›¸ã¸');
  } catch(e) {
    console.error('offerDone error:', e);
    toast('ã‚¨ãƒ©ãƒ¼: '+e.message);
  }
}


function cancelCase(id) {
  if(!confirm('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  advance(id,'cancel',null,null,'ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
}
function reactivate(id) {
  const c = CASES.find(x=>x.id===id);
  c.step='naiken'; c.hist.unshift(today()+' æ¡ˆä»¶å†é–‹');
  open_case(id);
}

function jumpStep(id, stepId) {
  const c = CASES.find(x=>x.id===id);
  if(!c) return;
  const steps = c.type==='reLet'?STEPS_RELET:c.type==='sannai'?STEPS_SANNAI:STEPS_RESALE;
  const valid = steps.map(s=>s.id);
  if(!valid.includes(stepId)) return;
  c.step = stepId;
  open_case(id);
}

function addMemo(id) {
  const inp = document.getElementById('memo-inp');
  const txt = inp?.value.trim();
  if(!txt) return;
  const c = CASES.find(x=>x.id===id);
  c.hist.unshift(today()+' '+txt);
  inp.value='';
  buildStepContent(c);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW CASE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _corpMode = false;

function openNewModal(stageHint) {
  _corpMode = false;
  openModal(
    'ï¼‹ æ–°è¦æ¡ˆä»¶'
    +'<div style="display:flex;gap:6px;margin-bottom:10px">'
    +'<button id="ct-ind" class="btn btn-ghost btn-sm" style="flex:1;border-color:var(--gold);color:var(--gold)" onclick="setCorp(false)">ğŸ‘¤ å€‹äºº</button>'
    +'<button id="ct-corp" class="btn btn-ghost btn-sm" style="flex:1" onclick="setCorp(true)">ğŸ¢ æ³•äºº</button>'
    +'</div>'
    +'<div class="fi"><label id="nc-name-lbl">æ°å</label><input type="text" id="nc-name" placeholder="ç”°ä¸­ å¤ªéƒ"></div>'
    +'<div id="nc-corp-ext" style="display:none"><div class="fi"><label>æ‹…å½“è€…å</label><input type="text" id="nc-contact" placeholder="ç”°ä¸­ ä¸€éƒ"></div></div>'
    +'<div class="fi"><label>ç¨®åˆ¥</label><select id="nc-type" onchange="toggleAD()"><option value="reLet">ğŸ  è³ƒè²¸</option><option value="reSale">ğŸ¢ å£²è²·</option><option value="sannai">ğŸ”„ ä¸‰ç‚º</option><option value="hr">ğŸ‘¥ äººæ</option></select></div>'+'<div id="nc-ad-wrap" style="margin-bottom:10px"><label style="display:flex;align-items:center;gap:7px;font-size:11px;cursor:pointer"><input type="checkbox" id="nc-ad"> ADæ¡ˆä»¶ï¼ˆä»²ä»‹æ‰‹æ•°æ–™ã¯éµæ¸¡ã—å¾Œå…¥é‡‘ï¼‰</label></div>'
    +'<div class="fi"><label>å¸Œæœ›æ¡ä»¶</label><input type="text" id="nc-sub" placeholder="ä¾‹: æ¸‹è°·åŒº 1LDK / ç›®é»’åŒº ãƒãƒ³ã‚·ãƒ§ãƒ³ 3,000ä¸‡"></div>'
    +'<div class="row" style="margin-top:14px"><button class="btn btn-ghost" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
    +'<button class="btn btn-gold" style="flex:2;justify-content:center" onclick="createCase()">ç™»éŒ²</button></div>'
  );
}

function toggleAD() {
  const t = document.getElementById('nc-type')?.value;
  const wrap = document.getElementById('nc-ad-wrap');
  if(wrap) wrap.style.display = t==='reLet' ? 'block' : 'none';
}

function setCorp(flag) {
  _corpMode = flag;
  const ind  = document.getElementById('ct-ind');
  const corp = document.getElementById('ct-corp');
  const ext  = document.getElementById('nc-corp-ext');
  const lbl  = document.getElementById('nc-name-lbl');
  const inp  = document.getElementById('nc-name');
  if(flag) {
    corp.style.borderColor='var(--purple)'; corp.style.color='var(--purple)';
    ind.style.borderColor=''; ind.style.color='';
    ext.style.display='block'; lbl.textContent='æ³•äººå'; inp.placeholder='æ ªå¼ä¼šç¤¾ã€‡ã€‡';
  } else {
    ind.style.borderColor='var(--gold)'; ind.style.color='var(--gold)';
    corp.style.borderColor=''; corp.style.color='';
    ext.style.display='none'; lbl.textContent='æ°å'; inp.placeholder='ç”°ä¸­ å¤ªéƒ';
  }
}

function createCase() {
  const name = document.getElementById('nc-name')?.value.trim();
  if(!name){alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const contact = document.getElementById('nc-contact')?.value.trim()||'';
  if(_corpMode&&!contact){alert('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const type = document.getElementById('nc-type')?.value;
  const sub  = document.getElementById('nc-sub')?.value.trim()||'â€”';
  const prefix = type==='reLet'?'R':type==='reSale'?'S':type==='sannai'?'N':'H';
  const id = prefix+String(Math.floor(Math.random()*90000+10000));
  const initStep = (type==='reLet'||type==='reSale'||type==='sannai')?'naiken':'new';
  const adOnly = document.getElementById('nc-ad')?.checked && type==='reLet';
  const obj = {id, name, type, corp:_corpMode, agent:'10012', sub, step:initStep, age:0, stale:false, adOnly, taskDone:{paid:false,itsetsu:false}, apps:[], dates:{}, hist:[today()+' æ¡ˆä»¶ç™»éŒ²'+(adOnly?' [ADæ¡ˆä»¶]':'')]};
  if(_corpMode&&contact) obj.contactName = contact;
  if(type==='sannai') obj.buyer = {name:'', takkenNum:'', verified:false, bypass:false};
  CASES.unshift(obj);
  closeModal();
  render();
  open_case(id);
  toast('æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å£²è²·ä¾¡æ ¼ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function fmtYen(v) {
  if (!v && v !== 0) return '';
  const n = parseInt(String(v).replace(/,/g,''));
  return isNaN(n) ? '' : n.toLocaleString('ja-JP');
}

function invSalePriceInput(el) {
  const raw = el.value.replace(/[^0-9]/g,'');
  const num = parseInt(raw);
  const formatted = isNaN(num) ? '' : num.toLocaleString('ja-JP');
  const pos = el.selectionStart;
  const oldLen = el.value.length;
  el.value = formatted;
  const newLen = formatted.length;
  const delta = newLen - oldLen;
  el.setSelectionRange(Math.max(0, pos + delta), Math.max(0, pos + delta));
  if (document.getElementById('inv-sale-price')) invCalcSale();
  if (document.getElementById('sn-spread')) sannaiCalcProfit();
}

function openModal(inner) {
  document.getElementById('modal-box').innerHTML = inner;
  document.getElementById('overlay').classList.add('on');
}

function closeModal() { document.getElementById('overlay').classList.remove('on'); }
document.getElementById('overlay').addEventListener('click', e=>{if(e.target.id==='overlay')closeModal();});

function toast(msg) {
  const t=document.getElementById('toast');
  t.textContent='âœ“ '+msg; t.style.display='block';
  clearTimeout(t._t); t._t=setTimeout(()=>t.style.display='none',2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();
</script>
</body>
</html>
