<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORETO â€” æ¡ˆä»¶ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--card:#0f1119;--card2:#141720;--border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--gold-dim:#7a5f22;
  --blue:#4f9cf9;--green:#34d399;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;
  --muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;
}
html,body{height:100%;font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
.hdr{height:54px;display:flex;align-items:center;justify-content:space-between;
  padding:0 22px;border-bottom:1px solid var(--border);background:rgba(7,9,15,.95);z-index:50;position:relative}
.logo{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;color:var(--gold);letter-spacing:3px}
.toolbar{display:flex;align-items:center;gap:10px;padding:9px 22px;
  border-bottom:1px solid var(--border);background:var(--card2);flex-wrap:wrap}
.board{display:flex;gap:0;height:calc(100vh - 54px - 50px);overflow-x:auto;overflow-y:hidden}
.col{width:290px;flex-shrink:0;display:flex;flex-direction:column;border-right:1px solid var(--border)}
.col:last-child{border-right:none}
.col-hdr{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;
  justify-content:space-between;flex-shrink:0}
.col-title{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;display:flex;align-items:center;gap:8px}
.col-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.col-count{font-size:9px;padding:2px 8px;border-radius:10px;font-weight:700}
.col-body{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px}
.case-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;
  cursor:pointer;transition:.15s;position:relative}
.case-card:hover{border-color:var(--border2);background:#11141f;transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.case-card.active{border-color:var(--gold);background:#12110a}
.cc-type{font-size:8px;font-weight:700;letter-spacing:1px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.cc-client{font-size:13px;font-weight:700;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cc-sub{font-size:10px;color:var(--muted);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cc-apps{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px}
.cc-meta{display:flex;align-items:center;justify-content:space-between;margin-top:6px;padding-top:8px;border-top:1px solid var(--border)}
.cc-id{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted)}
.cc-days{font-size:9px;padding:2px 7px;border-radius:5px;font-weight:700}
.stale-dot{position:absolute;top:8px;right:8px;width:7px;height:7px;border-radius:50%;background:var(--red);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.pill{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:5px;font-size:8px;font-weight:700;white-space:nowrap}
.pill-blue{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.2)}
.pill-orange{background:rgba(251,146,60,.12);color:var(--orange);border:1px solid rgba(251,146,60,.2)}
.pill-green{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.pill-red{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.2)}
.pill-muted{background:rgba(74,82,112,.15);color:var(--sub);border:1px solid var(--border2)}
.pill-gold{background:rgba(201,168,76,.12);color:var(--gold);border:1px solid rgba(201,168,76,.2)}
.btn{padding:7px 14px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;
  font-family:'Noto Sans JP',sans-serif;transition:.15s;border:none;display:inline-flex;align-items:center;gap:6px}
.btn-blue{background:linear-gradient(135deg,var(--blue),#3070c0);color:#fff}
.btn-gold{background:linear-gradient(135deg,var(--gold),#a8872f);color:#0a0c10}
.btn-red{background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.3)}
.btn-green{background:rgba(52,211,153,.15);color:var(--green);border:1px solid rgba(52,211,153,.3)}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--sub)}
.btn-ghost:hover{color:var(--text)}
.btn-sm{padding:4px 10px;font-size:10px;border-radius:6px}
.btn-xs{padding:2px 8px;font-size:9px;border-radius:5px}
.panel{position:fixed;right:-440px;top:54px;width:440px;height:calc(100vh - 54px);
  background:var(--card);border-left:1px solid var(--border);z-index:40;
  transition:.25s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;overflow:hidden}
.panel.show{right:0}
.panel-hdr{padding:16px 18px;border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.panel-body{flex:1;overflow-y:auto;padding:16px 18px}
.panel-sec{margin-bottom:18px}
.panel-sec-title{font-size:9px;font-weight:700;letter-spacing:2px;color:var(--muted);
  text-transform:uppercase;padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:10px;
  display:flex;align-items:center;justify-content:space-between}
.stage-row{display:flex;gap:4px;flex-wrap:wrap}
.stage-btn{padding:5px 10px;border-radius:7px;font-size:10px;cursor:pointer;border:1px solid var(--border2);
  background:transparent;color:var(--muted);font-family:'Noto Sans JP',sans-serif;transition:.15s}
.stage-btn.cur{background:rgba(201,168,76,.15);border-color:var(--gold-dim);color:var(--gold);font-weight:700}
.stage-btn:hover:not(.cur){border-color:var(--border);color:var(--text)}
.app-record{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px}
.app-record.ar-approved{border-left:3px solid var(--green)}
.app-record.ar-rejected{border-left:3px solid var(--red);opacity:.75}
.app-record.ar-cancelled{border-left:3px solid var(--muted);opacity:.6}
.app-record.ar-reviewing{border-left:3px solid var(--orange)}
.app-record.ar-submitted{border-left:3px solid var(--blue)}
.app-record.ar-contracted{border-left:3px solid var(--gold)}
.ar-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;gap:6px}
.ar-prop{font-size:12px;font-weight:700;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ar-meta{display:grid;grid-template-columns:auto 1fr;gap:3px 10px;font-size:10px;color:var(--sub)}
.ar-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.memo-item{display:flex;gap:10px;padding:3px 0}
.memo-dot{width:8px;height:8px;border-radius:50%;background:var(--border2);flex-shrink:0;margin-top:3px}
.memo-dot.act{background:var(--gold)}
#modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);
  backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center}
#modal-overlay.show{display:flex}
.modal-box{background:var(--card);border:1px solid var(--border);border-radius:14px;
  padding:24px;max-width:420px;width:90%}
.modal-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;color:var(--gold);margin-bottom:14px}
.fg label{font-size:11px;color:var(--sub);display:block;margin-bottom:4px;margin-top:10px}
.fg input,.fg select,.fg textarea{width:100%;background:#0a0c14;border:1px solid var(--border2);
  border-radius:8px;padding:8px 12px;color:var(--text);font-size:12px;
  font-family:'Noto Sans JP',sans-serif;outline:none;transition:border .15s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--gold)}
input[type=date]{color-scheme:dark}
.mono{font-family:'DM Mono',monospace!important}
.add-card{padding:8px;border:1px dashed var(--border2);border-radius:8px;
  text-align:center;font-size:11px;color:var(--muted);cursor:pointer;transition:.15s}
.add-card:hover{border-color:var(--blue);color:var(--blue)}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:var(--card);border:1px solid var(--green);border-radius:10px;
  padding:10px 18px;font-size:12px;color:var(--green);z-index:300;display:none}
</style>
</head>
<body>

<div class="hdr">
  <div style="display:flex;align-items:center;gap:16px">
    <div class="logo">CORETO</div>
    <div style="font-size:10px;color:var(--muted);font-weight:600;letter-spacing:1px">æ¡ˆä»¶ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <button class="btn btn-ghost btn-sm" onclick="history.back()">â† æˆ»ã‚‹</button>
    <button class="btn btn-blue btn-sm" onclick="openAddModal()">ï¼‹ æ–°è¦æ¡ˆä»¶</button>
  </div>
</div>

<div class="toolbar">
  <select id="filter-type" onchange="renderBoard()" style="background:#0a0c14;border:1px solid var(--border2);border-radius:7px;padding:5px 10px;color:var(--text);font-size:11px;font-family:'Noto Sans JP',sans-serif">
    <option value="all">å…¨ç¨®åˆ¥</option>
    <option value="reLet">ğŸ  è³ƒè²¸</option>
    <option value="re-sale">ğŸ¢ å£²è²·</option>
    <option value="hr">ğŸ‘¥ äººæ</option>
  </select>
  <select id="filter-agent" onchange="renderBoard()" style="background:#0a0c14;border:1px solid var(--border2);border-radius:7px;padding:5px 10px;color:var(--text);font-size:11px;font-family:'Noto Sans JP',sans-serif">
    <option value="all">å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</option>
    <option value="10012">å±±ç”° èª ï¼ˆ10012ï¼‰</option>
    <option value="10008">éˆ´æœ¨ å¥å¤ªï¼ˆ10008ï¼‰</option>
    <option value="10023">ä½è—¤ èŠ±å­ï¼ˆ10023ï¼‰</option>
  </select>
  <div style="margin-left:auto;font-size:10px;color:var(--muted)" id="board-summary"></div>
</div>

<div class="board" id="board"></div>

<div class="panel" id="detail-panel">
  <div class="panel-hdr">
    <div style="flex:1;min-width:0">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px">
        <div class="mono" style="font-size:11px;color:var(--muted)" id="dp-id">â€”</div>
        <div id="dp-stage-pill"></div>
      </div>
      <div style="font-size:15px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="dp-name">â€”</div>
    </div>
    <button class="btn btn-ghost btn-sm" onclick="closePanel()" style="flex-shrink:0">âœ•</button>
  </div>
  <div class="panel-body" id="dp-body"></div>
</div>

<div id="modal-overlay">
  <div class="modal-box" id="modal-box"></div>
</div>

<div class="toast" id="toast"></div>

<script>
const STAGES = [
  { id:'inquiry',  label:'å•åˆã›',     color:'var(--sub)',    dot:'#4a5270' },
  { id:'naiken',   label:'å†…è¦‹èª¿æ•´',   color:'var(--blue)',   dot:'#4f9cf9' },
  { id:'apply',    label:'ç”³è¾¼ãƒ»å¯©æŸ»', color:'var(--orange)', dot:'#fb923c' },
  { id:'contract', label:'å¥‘ç´„ä¸­',     color:'var(--gold)',   dot:'#c9a84c' },
  { id:'payment',  label:'å…¥é‡‘å¾…ã¡',   color:'var(--purple)', dot:'#a78bfa' },
  { id:'done',     label:'æˆç´„å®Œäº†',   color:'var(--green)',  dot:'#34d399' },
  { id:'cancel',   label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', color:'var(--red)',    dot:'#f87171' },
];

const APP_STATUS = {
  submitted: { label:'ç”³è¾¼æ›¸æå‡ºæ¸ˆ', cls:'pill-blue',   icon:'ğŸ“¬' },
  reviewing: { label:'å¯©æŸ»ä¸­',       cls:'pill-orange', icon:'â³' },
  approved:  { label:'å¯©æŸ»é€šé',     cls:'pill-green',  icon:'âœ…' },
  rejected:  { label:'å¯©æŸ»è½ã¡',     cls:'pill-red',    icon:'âŒ' },
  cancelled: { label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',   cls:'pill-muted',  icon:'ğŸš«' },
  contracted:{ label:'å¥‘ç´„æˆç«‹',     cls:'pill-gold',   icon:'ğŸ†' },
};

let CASES = [
  { id:'R042857', client:'ç”°ä¸­ é›„ä»‹', type:'reLet', stage:'apply', agent:'10012',
    sub:'æ¸‹è°·åŒº å¸Œæœ› 2LDK / ã€œÂ¥220,000', days:3, stale:false,
    applications:[
      { id:'APL-001', property:'æ¸‹è°·åŒºæ¡œä¸˜ 2LDK', mgmtCo:'ä¸‰äº•ä½å‹ç®¡ç†', appliedDate:'2026-02-18',
        status:'rejected', note:'åå…¥å¯©æŸ»åŸºæº–æœªé”ï¼ˆåå…¥å€ç‡3å€ä»¥ä¸‹ï¼‰' },
      { id:'APL-002', property:'æ¸‹è°·åŒºä»£ã€…æœ¨ 2LDK', mgmtCo:'æ±æ€¥ãƒªãƒãƒ–ãƒ«ç®¡ç†', appliedDate:'2026-02-21',
        status:'reviewing', note:'ä¿è¨¼ä¼šç¤¾å¯©æŸ»ä¸­' },
    ],
    memo:['2/18 APL-001 å¯©æŸ»è½ã¡ï¼ˆåå…¥å€ç‡ï¼‰â†’ åˆ¥ç‰©ä»¶ææ¡ˆ','2/21 APL-002 ç”³è¾¼ã€‚ä¿è¨¼ä¼šç¤¾ï¼šã‚ªãƒªã‚³FS'],
  },
  { id:'R039102', client:'æœ¨æ‘ å½©é¦™', type:'reLet', stage:'apply', agent:'10012',
    sub:'å“å·åŒº å¸Œæœ› 1K / ã€œÂ¥85,000', days:1, stale:false,
    applications:[
      { id:'APL-010', property:'å“å·åŒºå¤§å´ 1K', mgmtCo:'å¤§å´ç®¡ç†ã‚»ãƒ³ã‚¿ãƒ¼', appliedDate:'2026-02-20',
        status:'reviewing', note:'åŒæ™‚ç”³è¾¼ï¼ˆBç‰©ä»¶ã‚ã‚Šï¼‰' },
      { id:'APL-011', property:'å“å·åŒºäº”åç”° 1K', mgmtCo:'æ±æ€¥ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', appliedDate:'2026-02-20',
        status:'reviewing', note:'åŒæ™‚ç”³è¾¼ï¼ˆAç‰©ä»¶ã‚ã‚Šï¼‰' },
    ],
    memo:['2/20 2ç‰©ä»¶åŒæ™‚ç”³è¾¼ï¼ˆå…ˆå‹ã¡ã§å¯¾å¿œï¼‰'],
  },
  { id:'R041003', client:'æ–è—¤ äº®', type:'reLet', stage:'inquiry', agent:'10023',
    sub:'æ–°å®¿åŒº å¸Œæœ› 1LDK / ã€œÂ¥130,000', days:9, stale:true,
    applications:[], memo:['2/11 å•åˆã›å—ä¿¡ã€‚æœªé€£çµ¡ã€‚'],
  },
  { id:'R044201', client:'æ©‹æœ¬ æ—©è‹—', type:'reLet', stage:'naiken', agent:'10012',
    sub:'ç›®é»’åŒº å¸Œæœ› 1LDK / ã€œÂ¥150,000', days:1, stale:false,
    applications:[], memo:['2/21 å†…è¦‹ä¾é ¼æ›¸é€ä»˜ã€‚2/23 10:00 äºˆå®š'],
  },
  { id:'R045500', client:'ä¼Šè—¤ ç¿”å¤ª', type:'reLet', stage:'contract', agent:'10012',
    sub:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK Â¥155,000', days:2, stale:false,
    applications:[
      { id:'APL-020', property:'æ¸‹è°·åŒºæµæ¯”å¯¿ 1LDK', mgmtCo:'æ±æ€¥ç®¡ç†', appliedDate:'2026-02-15',
        status:'contracted', note:'å¯©æŸ»é€šé â†’ ITé‡èª¬æ¸ˆã¿' },
    ],
    memo:['2/15 ç”³è¾¼','2/17 å¯©æŸ»é€šé','2/20 ITé‡èª¬å®Œäº†ã€‚æ›¸é¡è¿”é€å¾…ã¡'],
    chinkakuDate:'2026-03-01',
  },
  { id:'R046001', client:'åŠ è—¤ ç¾å’²', type:'reLet', stage:'cancel', agent:'10008',
    sub:'æ¸¯åŒºå—é’å±± 1LDK Â¥180,000', days:0, stale:false,
    applications:[
      { id:'APL-030', property:'æ¸¯åŒºå—é’å±± 1LDK', mgmtCo:'ä½å‹ä¸å‹•ç”£ç®¡ç†', appliedDate:'2026-02-10',
        status:'cancelled', note:'å¯©æŸ»é€šéå¾Œã€æœ¬äººéƒ½åˆã«ã‚ˆã‚Šã‚­ãƒ£ãƒ³ã‚»ãƒ«' },
    ],
    memo:['2/10 ç”³è¾¼','2/14 å¯©æŸ»é€šé','2/21 æœ¬äººéƒ½åˆã«ã‚ˆã‚Šã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”³å‡º'],
  },
  { id:'R038291', client:'æ¾æœ¬ æµ©äºŒ', type:'reLet', stage:'payment', agent:'10012',
    sub:'æ¸‹è°·åŒº 2K Â¥170,000', days:0, stale:false,
    applications:[
      { id:'APL-040', property:'æ¸‹è°·åŒº 2K', mgmtCo:'æ±äº¬å»ºç‰©ç®¡ç†', appliedDate:'2026-02-08',
        status:'contracted', note:'' },
    ],
    memo:['2/08 ç”³è¾¼','2/12 å¯©æŸ»é€šé','2/17 ITé‡èª¬','2/21 å…¥é‡‘ç¢ºèªå¾…ã¡'],
    chinkakuDate:'2026-03-01',
  },
  { id:'R040011', client:'ä¸­æ‘ ç”±ç¾', type:'reLet', stage:'done', agent:'10012',
    sub:'æ¸¯åŒº 1R Â¥95,000', days:0, stale:false,
    applications:[
      { id:'APL-050', property:'æ¸¯åŒº 1R', mgmtCo:'ä½å‹ä¸å‹•ç”£ç®¡ç†', appliedDate:'2026-02-01',
        status:'contracted', note:'' },
    ],
    memo:['2/01 ç”³è¾¼','2/05 å¯©æŸ»é€šé','2/10 ITé‡èª¬','2/18 æˆç´„å®Œäº†'],
    chinkakuDate:'2026-03-01',
  },
  { id:'S819204', client:'å‰ç”° å¤§è¼”', type:'re-sale', stage:'contract', agent:'10008',
    sub:'ç›®é»’åŒº æˆ¸å»ºã¦ 3,200ä¸‡', days:5, stale:false,
    applications:[], memo:['2/15 è²·ä»˜å—é ˜','2/17 å£²è²·å ±å‘Šæ›¸æå‡º','2/20 å¥‘ç´„æ›¸ä½œæˆä¸­'],
    settlementDate:'2026-03-15',
  },
  { id:'H334521', client:'ITã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—Aç¤¾', type:'hr', stage:'apply', agent:'20005',
    sub:'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ å¹´å700ä¸‡', days:2, stale:false,
    applications:[], memo:['2/19 æ›¸é¡é¸è€ƒé€šéã€‚ä¸€æ¬¡é¢æ¥èª¿æ•´ä¸­'],
  },
  { id:'R047800', client:'æ ªå¼ä¼šç¤¾ã‚¿ãƒŠã‚«å•†äº‹', type:'reLet', stage:'apply', agent:'10008',
    sub:'æ–°å®¿åŒº å¸Œæœ› äº‹å‹™æ‰€ / ã€œÂ¥250,000', days:0, stale:false,
    clientType:'corporate', contactName:'ç”°ä¸­ ä¸€éƒ', contactKana:'ã‚¿ãƒŠã‚« ã‚¤ãƒãƒ­ã‚¦',
    applications:[
      { id:'APL-060', property:'æ–°å®¿åŒºè¥¿æ–°å®¿ äº‹å‹™æ‰€30åª', mgmtCo:'ä¸‰è±åœ°æ‰€ç®¡ç†', appliedDate:'2026-02-22',
        status:'reviewing', note:'åŒæ™‚ç”³è¾¼ï¼ˆ2ä»¶ï¼‰', simultaneous:true },
      { id:'APL-061', property:'æ–°å®¿åŒºæ–°å®¿ äº‹å‹™æ‰€25åª', mgmtCo:'æ±æ€¥ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', appliedDate:'2026-02-22',
        status:'reviewing', note:'åŒæ™‚ç”³è¾¼ï¼ˆ2ä»¶ï¼‰', simultaneous:true },
    ],
    memo:['2/22 æ³•äººå¥‘ç´„ã€‚2ç‰©ä»¶åŒæ™‚ç”³è¾¼ã€‚æ‹…å½“ï¼šç”°ä¸­ä¸€éƒæ°'],
  },
];

let activeCaseId = null;

function renderBoard() {
  const typeFilter  = document.getElementById('filter-type').value;
  const agentFilter = document.getElementById('filter-agent').value;
  let cases = CASES;
  if (typeFilter !== 'all') cases = cases.filter(c => c.type === typeFilter);
  if (agentFilter !== 'all') cases = cases.filter(c => c.agent === agentFilter);

  const board = document.getElementById('board');
  board.innerHTML = STAGES.map(stage => {
    const cols = cases.filter(c => c.stage === stage.id);
    const canAdd = stage.id !== 'done' && stage.id !== 'cancel';
    return '<div class="col">'
      + '<div class="col-hdr">'
      + '<div class="col-title"><div class="col-dot" style="background:'+stage.dot+'"></div>'+stage.label+'</div>'
      + '<span class="col-count" style="background:'+stage.dot+'22;color:'+stage.color+';border:1px solid '+stage.dot+'44">'+cols.length+'</span>'
      + '</div>'
      + '<div class="col-body">'
      + cols.map(c => renderCard(c, stage)).join('')
      + (canAdd ? '<div class="add-card" onclick="openAddModal(\''+stage.id+'\')">ï¼‹ è¿½åŠ </div>' : '')
      + '</div></div>';
  }).join('');

  document.getElementById('board-summary').textContent = 'è¡¨ç¤º: '+cases.length+' ä»¶ / å…¨ '+CASES.length+' ä»¶';
}

function renderCard(c, stage) {
  const appBadges = c.applications.slice(0,3).map(a => {
    const s = APP_STATUS[a.status] || APP_STATUS.submitted;
    const prop = a.property.length > 12 ? a.property.slice(0,12)+'â€¦' : a.property;
    return '<span class="pill '+s.cls+'">'+s.icon+' '+prop+'</span>';
  }).join('') + (c.applications.length > 3 ? '<span class="pill pill-muted">+' + (c.applications.length-3) + '</span>' : '');

  const isActive = c.id === activeCaseId;
  const daysEl = c.days === 0
    ? '<span class="cc-days" style="background:rgba(52,211,153,.1);color:var(--green)">æœ¬æ—¥</span>'
    : c.days >= 7
    ? '<span class="cc-days" style="background:rgba(248,113,113,.1);color:var(--red)">'+c.days+'æ—¥å‰</span>'
    : '<span class="cc-days" style="background:rgba(74,82,112,.2);color:var(--sub)">'+c.days+'æ—¥å‰</span>';

  const typeLabel = c.type==='reLet' ? 'ğŸ  è³ƒè²¸' : c.type==='re-sale' ? 'ğŸ¢ å£²è²·' : 'ğŸ‘¥ äººæ';
  const corpBadge = c.clientType==='corporate' ? ' <span class="pill pill-purple" style="font-size:7px">æ³•äºº</span>' : '';
  const simCount = c.applications.filter(a=>a.simultaneous&&(a.status==='reviewing'||a.status==='submitted')).length;
  const simBadge = simCount>1 ? ' <span class="pill pill-orange" style="font-size:7px">åŒæ™‚'+simCount+'ä»¶</span>' : '';

  return '<div class="case-card'+(isActive?' active':'')+'" onclick="openCase(\''+c.id+'\')">'
    + (c.stale ? '<div class="stale-dot"></div>' : '')
    + '<div class="cc-type" style="color:'+stage.color+'">'+typeLabel+corpBadge+simBadge+'</div>'
    + '<div class="cc-client">'+c.client+'</div>'
    + '<div class="cc-sub">'+c.sub+'</div>'
    + (appBadges ? '<div class="cc-apps">'+appBadges+'</div>' : '')
    + '<div class="cc-meta"><span class="cc-id">'+c.id+'</span>'+daysEl+'</div>'
    + '</div>';
}

function openCase(id) {
  const c = CASES.find(c => c.id === id);
  if (!c) return;
  activeCaseId = id;
  const stage = STAGES.find(s => s.id === c.stage);
  document.getElementById('dp-id').textContent = c.id;
  document.getElementById('dp-name').textContent = c.client;
  document.getElementById('dp-stage-pill').innerHTML =
    '<span class="pill" style="background:'+stage.dot+'18;color:'+stage.color+';border:1px solid '+stage.dot+'44">'+stage.label+'</span>';
  buildDetailBody(c);
  document.getElementById('detail-panel').classList.add('show');
  renderBoard();
}

function buildDetailBody(c) {
  const body = document.getElementById('dp-body');

  // Stage buttons
  const stageRow = STAGES.map(s =>
    '<button class="stage-btn'+(s.id===c.stage?' cur':'')+'" onclick="moveCase(\''+c.id+'\',\''+s.id+'\')">'+s.label+'</button>'
  ).join('');

  // App records
  const isRE = c.type === 'reLet' || c.type === 're-sale';
  const appHtml = isRE ? buildAppRecords(c) : '<div style="font-size:11px;color:var(--muted)">ç”³è¾¼ç®¡ç†ã¯ä¸å‹•ç”£æ¡ˆä»¶ã®ã¿</div>';
  const addAppBtn = isRE ? '<button class="btn btn-ghost btn-xs" onclick="openAddAppModal(\''+c.id+'\')">ï¼‹ ç”³è¾¼è¿½åŠ </button>' : '';

  // Info rows
  const infoGrid = [
    ['ç¨®åˆ¥', c.type==='reLet'?'ğŸ  è³ƒè²¸':c.type==='re-sale'?'ğŸ¢ å£²è²·':'ğŸ‘¥ äººæ'],
    ['å€Ÿä¸»åŒºåˆ†', c.clientType==='corporate'?'ğŸ¢ æ³•äºº':'ğŸ‘¤ å€‹äºº'],
    ['æ‹…å½“', c.agent],
    ['æ›´æ–°', c.days===0?'æœ¬æ—¥':c.days+'æ—¥å‰'],
  ];
  if (c.clientType==='corporate' && c.contactName) infoGrid.push(['æ³•äººæ‹…å½“è€…', c.contactName+(c.contactKana?' ('+c.contactKana+')':'')]);
  if (c.chinkakuDate) infoGrid.push(['è³ƒç™ºæ—¥', c.chinkakuDate]);
  if (c.settlementDate) infoGrid.push(['æ±ºæ¸ˆæ—¥', c.settlementDate]);
  const infoHtml = infoGrid.map(([k,v]) => '<span style="color:var(--muted)">'+k+'</span><span>'+v+'</span>').join('');

  // Memo
  const memoHtml = (c.memo||[]).map((m,i,arr) =>
    '<div class="memo-item">'
    + '<div style="display:flex;flex-direction:column;align-items:center">'
    + '<div class="memo-dot'+(i===0?' act':'')+'"></div>'
    + (i<arr.length-1 ? '<div style="width:1px;height:16px;background:var(--border2);margin:2px auto"></div>' : '')
    + '</div>'
    + '<div style="flex:1;font-size:11px;padding:0 0 6px 8px;line-height:1.6;color:var(--sub)">'+m+'</div>'
    + '</div>'
  ).join('') || '<div style="font-size:11px;color:var(--muted)">å±¥æ­´ãªã—</div>';

  // Actions
  const actions = [];
  if (c.type==='reLet') actions.push('<button class="btn btn-ghost btn-sm" onclick="window.open(\'coreto-naiken.html\',\'_blank\')">ğŸ  å†…è¦‹ä¾é ¼æ›¸</button>');
  if (c.type==='reLet') actions.push('<button class="btn btn-ghost btn-sm" onclick="window.open(\'coreto-it-setsu.html\',\'_blank\')">ğŸ“ ITé‡èª¬</button>');
  if (c.type==='re-sale') actions.push('<button class="btn btn-ghost btn-sm" onclick="window.open(\'coreto-sale-report.html\',\'_blank\')">ğŸ¢ å£²è²·å ±å‘Šæ›¸</button>');
  if (c.stage==='payment'||c.stage==='contract') actions.push('<button class="btn btn-ghost btn-sm" onclick="window.open(\'coreto-batch-close.html\',\'_blank\')">âœ… æˆç´„å ±å‘Š</button>');
  if (c.stage!=='cancel'&&c.stage!=='done') actions.push('<button class="btn btn-red btn-sm" onclick="cancelCase(\''+c.id+'\')">ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>');

  body.innerHTML = ''
    + '<div class="panel-sec"><div class="panel-sec-title">ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´</div><div class="stage-row">'+stageRow+'</div></div>'
    + '<div class="panel-sec"><div class="panel-sec-title">åŸºæœ¬æƒ…å ±</div>'
    + '<div style="display:grid;grid-template-columns:auto 1fr;gap:5px 14px;font-size:11px;background:var(--card2);border-radius:9px;padding:10px 12px">'+infoHtml+'</div></div>'
    + '<div class="panel-sec"><div class="panel-sec-title"><span>ç”³è¾¼ç®¡ç† <span style="font-size:8px;color:var(--muted);font-weight:400;text-transform:none">('+(c.applications||[]).length+'ä»¶)</span></span>'+addAppBtn+'</div>'+appHtml+'</div>'
    + '<div class="panel-sec"><div class="panel-sec-title">æ´»å‹•å±¥æ­´</div>'
    + '<div>'+memoHtml+'</div>'
    + '<div style="display:flex;gap:8px;margin-top:8px">'
    + '<input type="text" id="memo-input" placeholder="æ´»å‹•ãƒ¡ãƒ¢ã‚’è¿½åŠ ..." style="flex:1;background:#090b13;border:1px solid var(--border2);border-radius:8px;padding:7px 11px;color:var(--text);font-size:11px;font-family:\'Noto Sans JP\',sans-serif;outline:none" onkeydown="if(event.key===\'Enter\')addMemo(\''+c.id+'\')">'
    + '<button class="btn btn-ghost btn-sm" onclick="addMemo(\''+c.id+'\')">è¿½åŠ </button>'
    + '</div></div>'
    + '<div class="panel-sec"><div class="panel-sec-title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>'
    + '<div style="display:flex;flex-wrap:wrap;gap:6px">'+actions.join('')+'</div></div>';
}

function buildAppRecords(c) {
  if (!c.applications || c.applications.length === 0) {
    return '<div style="font-size:11px;color:var(--muted);padding:10px;text-align:center;border:1px dashed var(--border2);border-radius:8px">ç”³è¾¼ãƒ¬ã‚³ãƒ¼ãƒ‰ãªã—<br>ã€Œï¼‹ ç”³è¾¼è¿½åŠ ã€ã§è¿½åŠ </div>';
  }
  return c.applications.map(a => {
    const s = APP_STATUS[a.status] || APP_STATUS.submitted;
    let actions = '';
    if (a.status==='submitted') actions = '<button class="btn btn-ghost btn-xs" onclick="updateApp(\''+c.id+'\',\''+a.id+'\',\'reviewing\')">â³ å¯©æŸ»ä¸­ã¸</button>';
    if (a.status==='reviewing') actions =
      '<button class="btn btn-green btn-xs" onclick="updateApp(\''+c.id+'\',\''+a.id+'\',\'approved\')">âœ… å¯©æŸ»é€šé</button>'
      +'<button class="btn btn-red btn-xs" onclick="updateApp(\''+c.id+'\',\''+a.id+'\',\'rejected\')">âŒ å¯©æŸ»è½ã¡</button>';
    if (a.status==='approved') actions =
      '<button class="btn btn-gold btn-xs" onclick="updateApp(\''+c.id+'\',\''+a.id+'\',\'contracted\')">ğŸ† å¥‘ç´„æˆç«‹</button>'
      +'<button class="btn btn-red btn-xs" onclick="updateApp(\''+c.id+'\',\''+a.id+'\',\'cancelled\')">ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
    if (a.status==='rejected') actions =
      '<button class="btn btn-ghost btn-xs" onclick="openAddAppModal(\''+c.id+'\')">ğŸ  åˆ¥ç‰©ä»¶ã§å†ç”³è¾¼</button>';

    const simTag = a.simultaneous ? '<span class="pill pill-orange" style="font-size:8px;margin-left:4px">åŒæ™‚ç”³è¾¼</span>' : '';
    return '<div class="app-record ar-'+a.status+'">'
      + '<div class="ar-hdr"><div class="ar-prop">'+a.property+simTag+'</div><span class="pill '+s.cls+'">'+s.icon+' '+s.label+'</span></div>'
      + '<div class="ar-meta"><span>ç®¡ç†ä¼šç¤¾</span><span>'+a.mgmtCo+'</span><span>ç”³è¾¼æ—¥</span><span class="mono">'+a.appliedDate+'</span>'
      + (a.note ? '<span>å‚™è€ƒ</span><span style="color:var(--text)">'+a.note+'</span>' : '')
      + '</div>'
      + (actions ? '<div class="ar-actions">'+actions+'</div>' : '')
      + '</div>';
  }).join('');
}

function moveCase(id, newStage) {
  const c = CASES.find(c => c.id === id);
  if (!c) return;
  c.stage = newStage;
  c.days = 0;
  const today = new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'});
  c.memo.unshift(today+' ã‚¹ãƒ†ãƒ¼ã‚¸ â†’ '+STAGES.find(s=>s.id===newStage).label);
  openCase(id);
  renderBoard();
  showToast('ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã€Œ'+STAGES.find(s=>s.id===newStage).label+'ã€ã«ç§»å‹•');
}

function updateApp(caseId, appId, newStatus) {
  const c = CASES.find(c => c.id === caseId);
  if (!c) return;
  const a = c.applications.find(a => a.id === appId);
  if (!a) return;
  a.status = newStatus;
  const today = new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'});
  c.memo.unshift(today+' '+a.property+' â†’ '+APP_STATUS[newStatus].label);
  if (newStatus==='contracted') { c.stage='contract'; c.memo.unshift(today+' ã‚¹ãƒ†ãƒ¼ã‚¸è‡ªå‹•ç§»å‹• â†’ å¥‘ç´„ä¸­'); }
  else if (newStatus==='approved') { c.stage='contract'; }
  else if (newStatus==='cancelled'||newStatus==='rejected') {
    const allDone = c.applications.every(a => a.status==='cancelled'||a.status==='rejected');
    if (allDone && confirm('å…¨ç”³è¾¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«/è½ã¡ã§ã™ã€‚æ¡ˆä»¶ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
      c.stage='cancel';
    }
  }
  openCase(caseId);
  renderBoard();
  showToast(APP_STATUS[newStatus].label+' ã«æ›´æ–°');
}

function cancelCase(id) {
  if (!confirm('ã“ã®æ¡ˆä»¶ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const c = CASES.find(c => c.id === id);
  if (!c) return;
  c.stage = 'cancel';
  c.applications.forEach(a => { if (a.status!=='contracted') a.status='cancelled'; });
  const today = new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'});
  c.memo.unshift(today+' æ¡ˆä»¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
  openCase(id);
  renderBoard();
  showToast('æ¡ˆä»¶ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
}

function addMemo(id) {
  const input = document.getElementById('memo-input');
  const text = input.value.trim();
  if (!text) return;
  const c = CASES.find(c => c.id === id);
  if (!c) return;
  const today = new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'});
  c.memo.unshift(today+' '+text);
  input.value='';
  buildDetailBody(c);
}

function closePanel() {
  document.getElementById('detail-panel').classList.remove('show');
  activeCaseId=null;
  renderBoard();
}

function openAddAppModal(caseId) {
  const c = CASES.find(c => c.id === caseId);
  const rejExists = c && c.applications.some(a => a.status==='rejected');
  const today = new Date().toISOString().slice(0,10);
  const activeApps = c ? c.applications.filter(a=>a.status==='reviewing'||a.status==='submitted').length : 0;
  const simWarning = activeApps > 0
    ? '<div style="background:rgba(251,146,60,.08);border:1px solid rgba(251,146,60,.2);border-radius:8px;padding:8px 12px;font-size:11px;color:var(--orange);margin-bottom:10px">'
      + 'ğŸ“‹ ç¾åœ¨ '+activeApps+' ä»¶ãŒå¯©æŸ»ä¸­ â€” åŒæ™‚ç”³è¾¼ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ï¼ˆä»¶æ•°ä¸Šé™ãªã—ï¼‰</div>'
    : '';
  const corpNote = c && c.clientType==='corporate'
    ? '<div style="background:rgba(167,139,250,.08);border:1px solid rgba(167,139,250,.2);border-radius:8px;padding:8px 12px;font-size:11px;color:var(--purple);margin-bottom:10px">'
      + 'ğŸ¢ æ³•äººå¥‘ç´„ â€” ä¿è¨¼ä¼šç¤¾ã¯æ³•äººå¯¾å¿œã®ã‚‚ã®ï¼ˆã‚ªãƒªã‚³FSãƒ“ã‚¸ãƒã‚¹ç­‰ï¼‰ã‚’å‚™è€ƒã«è¨˜è¼‰</div>'
    : '';
  document.getElementById('modal-box').innerHTML =
    '<div class="modal-title">ğŸ  ç”³è¾¼ãƒ¬ã‚³ãƒ¼ãƒ‰è¿½åŠ </div>'
    + (rejExists ? '<div style="background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:8px;padding:8px 12px;font-size:11px;color:var(--red);margin-bottom:10px">âš ï¸ å¯©æŸ»è½ã¡æ¡ˆä»¶ã‚ã‚Š â€” åˆ¥ç‰©ä»¶ã¸ã®å†ç”³è¾¼</div>' : '')
    + simWarning
    + corpNote
    + '<div class="fg"><label>ç‰©ä»¶å *</label><input type="text" id="m-property" placeholder="ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 1LDK"></div>'
    + '<div class="fg"><label>ç®¡ç†ä¼šç¤¾ *</label><input type="text" id="m-mgmt" placeholder="ã€‡ã€‡ç®¡ç†æ ªå¼ä¼šç¤¾"></div>'
    + '<div class="fg"><label>ç”³è¾¼æ—¥ *</label><input type="date" id="m-date" class="mono" value="'+today+'"></div>'
    + '<div class="fg"><label>åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label><select id="m-status"><option value="submitted">ç”³è¾¼æ›¸æå‡ºæ¸ˆ</option><option value="reviewing">å¯©æŸ»ä¸­</option></select></div>'
    + '<div class="fg" style="display:flex;align-items:center;gap:10px;margin-top:10px">'
    + '<label style="margin:0">åŒæ™‚ç”³è¾¼ãƒ•ãƒ©ã‚°</label>'
    + '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px;color:var(--text);margin:0">'
    + '<input type="checkbox" id="m-simul"'+(activeApps>0?' checked':'')+'> ã“ã®ç”³è¾¼ã‚’åŒæ™‚ç”³è¾¼ã¨ã—ã¦ãƒãƒ¼ã‚¯</label></div>'
    + '<div class="fg"><label>å‚™è€ƒ</label><textarea id="m-note" rows="2" placeholder="ä¿è¨¼ä¼šç¤¾ãƒ»ç‰¹è¨˜äº‹é …ãªã©"></textarea></div>'
    + '<div style="display:flex;gap:8px;margin-top:16px">'
    + '<button class="btn btn-ghost" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
    + '<button class="btn btn-blue" style="flex:2" onclick="submitApp(\''+caseId+'\')">è¿½åŠ </button></div>';
  document.getElementById('modal-overlay').classList.add('show');
}

function submitApp(caseId) {
  const property = document.getElementById('m-property').value.trim();
  const mgmtCo   = document.getElementById('m-mgmt').value.trim();
  const date     = document.getElementById('m-date').value;
  const status   = document.getElementById('m-status').value;
  const note     = document.getElementById('m-note').value.trim();
  const simultaneous = document.getElementById('m-simul')?.checked || false;
  if (!property||!mgmtCo||!date) { alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const c = CASES.find(c => c.id === caseId);
  const newId = 'APL-'+String(Date.now()).slice(-5);
  c.applications.push({ id:newId, property, mgmtCo, appliedDate:date, status, note, simultaneous });
  const today = new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'});
  c.memo.unshift(today+' ç”³è¾¼è¿½åŠ : '+property+'ï¼ˆ'+mgmtCo+'ï¼‰');
  if (c.stage==='inquiry'||c.stage==='naiken') c.stage='apply';
  closeModal();
  openCase(caseId);
  renderBoard();
  showToast('ç”³è¾¼ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

function openAddModal(defaultStage) {
  const stageOptions = STAGES.filter(s=>s.id!=='done'&&s.id!=='cancel')
    .map(s=>'<option value="'+s.id+'"'+(s.id===defaultStage?' selected':'')+'>'+s.label+'</option>').join('');
  document.getElementById('modal-box').innerHTML =
    '<div class="modal-title">ï¼‹ æ–°è¦æ¡ˆä»¶ç™»éŒ²</div>'
    +'<div class="fg"><label>å€Ÿä¸»åŒºåˆ† *</label>'
    +'<div style="display:flex;gap:8px;margin-top:4px">'
    +'<button id="ct-ind" class="btn btn-ghost btn-sm" style="flex:1;border-color:var(--gold);color:var(--gold)" onclick="setClientType(&quot;individual&quot;)">ğŸ‘¤ å€‹äºº</button>'
    +'<button id="ct-corp" class="btn btn-ghost btn-sm" style="flex:1" onclick="setClientType(&quot;corporate&quot;)">ğŸ¢ æ³•äºº</button>'
    +'</div></div>'
    +'<div class="fg"><label id="nc-client-label">æ°å *</label><input type="text" id="nc-client" placeholder="ç”°ä¸­ å¤ªéƒ"></div>'
    +'<div id="nc-corp-fields" style="display:none">'
    +'<div class="fg"><label>æ‹…å½“è€…æ°å *</label><input type="text" id="nc-contact" placeholder="ç”°ä¸­ ä¸€éƒ"></div>'
    +'<div class="fg"><label>æ‹…å½“è€…ã‚«ãƒŠ</label><input type="text" id="nc-contact-kana" placeholder="ã‚¿ãƒŠã‚« ã‚¤ãƒãƒ­ã‚¦"></div>'
    +'</div>'
    +'<div class="fg"><label>æ¡ˆä»¶ç¨®åˆ¥</label><select id="nc-type"><option value="reLet">ğŸ  è³ƒè²¸</option><option value="re-sale">ğŸ¢ å£²è²·</option><option value="hr">ğŸ‘¥ äººæ</option></select></div>'
    +'<div class="fg"><label>æ¦‚è¦ãƒ»å¸Œæœ›æ¡ä»¶</label><input type="text" id="nc-sub" placeholder="æ¸‹è°·åŒº 1LDK ã€œÂ¥150,000"></div>'
    +'<div class="fg"><label>åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¸</label><select id="nc-stage">'+stageOptions+'</select></div>'
    +'<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-ghost" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-blue" style="flex:2" onclick="submitNew()">ç™»éŒ²</button></div>';
  // default to individual
  window._ncClientType = 'individual';
  document.getElementById('modal-overlay').classList.add('show');
}

function submitNew() {
  const client = document.getElementById('nc-client').value.trim();
  if (!client) { alert('å€Ÿä¸»åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const clientType = window._ncClientType || 'individual';
  const contactName = document.getElementById('nc-contact')?.value.trim() || '';
  const contactKana = document.getElementById('nc-contact-kana')?.value.trim() || '';
  if (clientType==='corporate' && !contactName) { alert('æ³•äººã®å ´åˆã¯æ‹…å½“è€…æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const type  = document.getElementById('nc-type').value;
  const sub   = document.getElementById('nc-sub').value.trim();
  const stage = document.getElementById('nc-stage').value;
  const prefix = type==='reLet'?'R':type==='re-sale'?'S':'H';
  const newId = prefix+String(Math.floor(Math.random()*90000+10000));
  const today = new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'});
  const caseObj = { id:newId, client, clientType, type, stage, agent:'10012', sub:sub||'â€”', days:0, stale:false, applications:[], memo:[today+' æ¡ˆä»¶ç™»éŒ²ï¼ˆ'+(clientType==='corporate'?'æ³•äºº':'å€‹äºº')+'ï¼‰'] };
  if (clientType==='corporate') { caseObj.contactName=contactName; if(contactKana) caseObj.contactKana=contactKana; }
  CASES.unshift(caseObj);
  closeModal();
  renderBoard();
  openCase(newId);
  showToast('æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
}

function setClientType(type) {
  window._ncClientType = type;
  const indBtn  = document.getElementById('ct-ind');
  const corpBtn = document.getElementById('ct-corp');
  const corpFields = document.getElementById('nc-corp-fields');
  const clientLabel = document.getElementById('nc-client-label');
  if (!indBtn) return;
  if (type==='individual') {
    indBtn.style.borderColor='var(--gold)'; indBtn.style.color='var(--gold)';
    corpBtn.style.borderColor=''; corpBtn.style.color='';
    corpFields.style.display='none';
    clientLabel.textContent='æ°å *';
    document.getElementById('nc-client').placeholder='ç”°ä¸­ å¤ªéƒ';
  } else {
    corpBtn.style.borderColor='var(--purple)'; corpBtn.style.color='var(--purple)';
    indBtn.style.borderColor=''; indBtn.style.color='';
    corpFields.style.display='block';
    clientLabel.textContent='æ³•äººå *';
    document.getElementById('nc-client').placeholder='æ ªå¼ä¼šç¤¾ã€‡ã€‡';
  }
}

function closeModal() { document.getElementById('modal-overlay').classList.remove('show'); }
document.getElementById('modal-overlay').addEventListener('click', e => { if(e.target.id==='modal-overlay') closeModal(); });

function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent='âœ… '+msg;
  t.style.display='block';
  setTimeout(()=>t.style.display='none',2500);
}

renderBoard();
</script>
</body>
</html>