<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORETO ç‰¹åˆ¥ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--card:#0f1119;--card2:#141720;--border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--gold-l:#e8c96a;--gold-dim:#7a5f22;
  --blue:#4f9cf9;--green:#34d399;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;
  --teal:#2dd4bf;--muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;
}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* â”€ Header â”€ */
.header{display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:54px;
  border-bottom:1px solid var(--border);background:rgba(7,9,15,.9);backdrop-filter:blur(12px);
  position:sticky;top:0;z-index:200}
.logo{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--gold);letter-spacing:3px}

/* â”€ Layout â”€ */
.body{max-width:1280px;margin:0 auto;padding:24px 28px 60px}

/* â”€ Top bar â”€ */
.topbar{display:flex;align-items:center;gap:12px;margin-bottom:22px;flex-wrap:wrap}
.topbar-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;flex:1}
.tb-btn{padding:9px 18px;border-radius:9px;font-size:12px;font-weight:700;cursor:pointer;
  border:none;font-family:'Noto Sans JP',sans-serif;transition:all .15s;letter-spacing:.5px}
.tb-primary{background:linear-gradient(135deg,var(--gold),#a8742a);color:#0a0c10}
.tb-primary:hover{filter:brightness(1.1);transform:translateY(-1px)}
.tb-ghost{background:transparent;border:1px solid var(--border2);color:var(--sub)}
.tb-ghost:hover{color:var(--text)}

/* â”€ Stats row â”€ */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:22px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 18px;
  display:flex;flex-direction:column;gap:4px}
.sc-val{font-family:'DM Mono',monospace;font-size:28px;font-weight:500;line-height:1}
.sc-label{font-size:10px;color:var(--muted)}

/* â”€ Table â”€ */
.table-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px}
.table-header{display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;border-bottom:1px solid var(--border)}
.th-left{display:flex;align-items:center;gap:12px}
.th-title{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;
  display:flex;align-items:center;gap:8px}
.th-title::before{content:'';width:3px;height:12px;background:var(--gold);border-radius:2px}
.search-box{background:var(--card2);border:1px solid var(--border2);border-radius:8px;
  padding:7px 12px;font-size:12px;color:var(--text);font-family:'Noto Sans JP',sans-serif;width:220px}
.search-box:focus{outline:none;border-color:var(--blue)}
.search-box::placeholder{color:var(--muted)}

.filter-tabs{display:flex;gap:2px}
.ft{padding:5px 12px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;
  color:var(--muted);border:1px solid transparent;transition:all .15s;letter-spacing:.5px}
.ft.on{background:rgba(201,168,76,.12);border-color:var(--gold-dim);color:var(--gold)}
.ft:hover:not(.on){color:var(--sub)}

.tbl{width:100%;border-collapse:collapse}
.tbl th{padding:10px 16px;font-size:9px;color:var(--muted);font-weight:700;
  border-bottom:1px solid var(--border);text-align:left;letter-spacing:.5px;
  text-transform:uppercase;white-space:nowrap;background:var(--card2)}
.tbl td{padding:12px 16px;border-bottom:1px solid rgba(30,34,53,.6);font-size:12px;
  vertical-align:middle}
.tbl tr:last-child td{border:none}
.tbl tr:hover td{background:rgba(255,255,255,.012)}
.mono{font-family:'DM Mono',monospace}

/* â”€ Code cell â”€ */
.code-chip{font-family:'DM Mono',monospace;font-size:13px;font-weight:600;letter-spacing:2px;
  padding:4px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
.code-chip:hover{filter:brightness(1.15)}
.copy-hint{font-size:9px;opacity:.6}

/* â”€ Benefit badges â”€ */
.ben-wrap{display:flex;flex-wrap:wrap;gap:4px}
.ben{font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;white-space:nowrap}
.ben-fee{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.25)}
.ben-rate{background:rgba(201,168,76,.12);color:var(--gold);border:1px solid rgba(201,168,76,.25)}
.ben-corp{background:rgba(167,139,250,.12);color:var(--purple);border:1px solid rgba(167,139,250,.25)}
.ben-rank{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.25)}
.ben-custom{background:rgba(251,146,60,.12);color:var(--orange);border:1px solid rgba(251,146,60,.25)}

/* â”€ Status â”€ */
.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:5px}
.st-active{background:var(--green)}
.st-inactive{background:var(--muted)}
.st-expired{background:var(--red)}
.st-limited{background:var(--orange)}

/* â”€ Usage bar â”€ */
.usage-bar{background:var(--border2);border-radius:3px;height:5px;width:100px;overflow:hidden;margin-top:4px}
.usage-fill{height:100%;border-radius:3px}

/* â”€ Action btns â”€ */
.act-btn{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;
  font-family:'Noto Sans JP',sans-serif;border:1px solid var(--border2);
  background:transparent;color:var(--muted);transition:all .12s}
.act-btn:hover{color:var(--text);border-color:var(--sub)}
.act-edit:hover{color:var(--blue);border-color:rgba(79,156,249,.4)}
.act-del:hover{color:var(--red);border-color:rgba(248,113,113,.4)}
.act-tog:hover{color:var(--green);border-color:rgba(52,211,153,.4)}

/* â”€ Modal â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);
  z-index:300;display:none;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--border2);border-radius:16px;
  width:560px;max-height:90vh;overflow-y:auto}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;
  padding:20px 24px 16px;border-bottom:1px solid var(--border)}
.modal-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;color:var(--gold)}
.modal-close{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:2px 6px}
.modal-body{padding:20px 24px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.mf-btn{padding:9px 20px;border-radius:9px;font-size:12px;font-weight:700;cursor:pointer;
  font-family:'Noto Sans JP',sans-serif}
.mf-save{background:linear-gradient(135deg,var(--gold),#a8742a);border:none;color:#0a0c10}
.mf-cancel{background:transparent;border:1px solid var(--border2);color:var(--sub)}

/* â”€ Form fields â”€ */
.mfield{margin-bottom:14px}
.mfield label{display:block;font-size:10px;color:var(--sub);margin-bottom:5px}
.mfield input,.mfield select,.mfield textarea{
  width:100%;background:#090b13;border:1px solid var(--border2);border-radius:8px;
  padding:9px 12px;color:var(--text);font-size:12px;font-family:'Noto Sans JP',sans-serif}
.mfield input:focus,.mfield select:focus,.mfield textarea:focus{outline:none;border-color:var(--blue)}
.mfield .mono-inp{font-family:'DM Mono',monospace;letter-spacing:2px;font-size:14px}
.mfield-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.mfield-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}

/* benefit checkboxes */
.ben-checks{display:flex;flex-direction:column;gap:8px}
.ben-check-row{display:flex;align-items:center;gap:10px;background:var(--card2);
  border-radius:8px;padding:10px 12px;border:1px solid var(--border2);cursor:pointer}
.ben-check-row.selected{border-color:var(--gold-dim);background:rgba(201,168,76,.06)}
.bcr-icon{font-size:16px}
.bcr-text{flex:1}
.bcr-label{font-size:11px;font-weight:700}
.bcr-sub{font-size:10px;color:var(--sub)}
.bcr-toggle{width:14px;height:14px;border-radius:3px;border:1px solid var(--border2);
  display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;
  background:transparent}
.bcr-toggle.on{background:var(--gold);border-color:var(--gold);color:#000}

/* usage history */
.use-list{display:flex;flex-direction:column;gap:6px;max-height:240px;overflow-y:auto}
.use-item{display:flex;align-items:center;gap:12px;padding:8px 12px;
  background:var(--card2);border-radius:8px;font-size:11px}
.use-avatar{width:28px;height:28px;border-radius:50%;background:var(--border2);
  display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}

::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="logo">CORETO</div>
    <div style="width:1px;height:18px;background:var(--border2)"></div>
    <div style="font-size:10px;color:var(--muted);letter-spacing:1px">ç‰¹åˆ¥ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç®¡ç†</div>
  </div>
  <button onclick="window.location.href='coreto-hub.html'"
          style="font-size:10px;padding:5px 12px;border-radius:6px;border:1px solid var(--border2);
          background:transparent;color:var(--muted);cursor:pointer;font-family:'Noto Sans JP',sans-serif">
    â† ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«
  </button>
</div>

<div class="body">

  <div class="topbar">
    <div class="topbar-title">ç‰¹åˆ¥ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç®¡ç†</div>
    <input class="search-box" type="text" placeholder="ğŸ” ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ¡ãƒ¢ã‚’æ¤œç´¢â€¦" oninput="renderTable()" id="search-box">
    <button class="tb-btn tb-ghost" onclick="exportCSV()">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button class="tb-btn tb-primary" onclick="openModal()">ï¼‹ æ–°è¦ã‚³ãƒ¼ãƒ‰ä½œæˆ</button>
  </div>

  <!-- Stats -->
  <div class="stats-row" id="stats-row"></div>

  <!-- Table -->
  <div class="table-wrap">
    <div class="table-header">
      <div class="th-left">
        <div class="th-title">ã‚³ãƒ¼ãƒ‰ä¸€è¦§</div>
        <div class="filter-tabs">
          <div class="ft on" data-f="all" onclick="setFilter('all',this)">å…¨ã¦</div>
          <div class="ft" data-f="active" onclick="setFilter('active',this)">æœ‰åŠ¹</div>
          <div class="ft" data-f="inactive" onclick="setFilter('inactive',this)">ç„¡åŠ¹</div>
          <div class="ft" data-f="expired" onclick="setFilter('expired',this)">æœŸé™åˆ‡ã‚Œ</div>
        </div>
      </div>
      <div style="font-size:10px;color:var(--muted)" id="tbl-count">â€” ä»¶</div>
    </div>
    <div style="overflow-x:auto">
      <table class="tbl">
        <thead>
          <tr>
            <th>ã‚³ãƒ¼ãƒ‰</th>
            <th>ç‰¹å…¸å†…å®¹</th>
            <th>ä½¿ç”¨çŠ¶æ³</th>
            <th>æœ‰åŠ¹æœŸé™</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>ãƒ¡ãƒ¢</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tbl-body"></tbody>
      </table>
    </div>
  </div>

</div><!-- /body -->

<!-- â”€ Create/Edit Modal â”€ -->
<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-hdr">
      <div class="modal-title" id="modal-title">æ–°è¦ã‚³ãƒ¼ãƒ‰ä½œæˆ</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">

      <!-- Code -->
      <div class="mfield">
        <label>ã‚³ãƒ¼ãƒ‰ <span style="color:var(--red)">*</span></label>
        <div style="display:flex;gap:8px">
          <input type="text" id="m-code" class="mono-inp" placeholder="ä¾‹ï¼šWELCOME2026"
                 style="flex:1;text-transform:uppercase" oninput="this.value=this.value.toUpperCase()">
          <button onclick="generateCode()"
                  style="padding:9px 14px;border-radius:8px;border:1px solid var(--border2);
                  background:var(--card2);color:var(--sub);cursor:pointer;font-size:11px;
                  font-family:'Noto Sans JP',sans-serif;white-space:nowrap">è‡ªå‹•ç”Ÿæˆ</button>
        </div>
      </div>

      <!-- Benefits -->
      <div class="mfield">
        <label>ç‰¹å…¸å†…å®¹ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
        <div class="ben-checks" id="ben-checks">
          <div class="ben-check-row" id="bc-freefee" onclick="toggleBen('freefee')">
            <div class="bcr-icon">ğŸ·</div>
            <div class="bcr-text">
              <div class="bcr-label">æœˆä¼šè²»æ°¸ä¹…ç„¡æ–™</div>
              <div class="bcr-sub">Bronze/Silver ã®æœˆä¼šè²»ï¼ˆÂ¥980/Â¥490ï¼‰ãŒæ°¸ä¹…0å††ã«</div>
            </div>
            <div class="bcr-toggle" id="bt-freefee">âœ“</div>
          </div>
          <div class="ben-check-row" id="bc-rate" onclick="toggleBen('rate')">
            <div class="bcr-icon">ğŸ’°</div>
            <div class="bcr-text">
              <div class="bcr-label">å ±é…¬ç‡ã‚«ã‚¹ã‚¿ãƒ æŒ‡å®š</div>
              <div class="bcr-sub">ãƒ©ãƒ³ã‚¯å ±é…¬ç‡ã«é–¢ã‚ã‚‰ãšæŒ‡å®šã—ãŸç‡ã§è¨ˆç®—</div>
            </div>
            <div class="bcr-toggle" id="bt-rate"></div>
          </div>
          <div class="ben-check-row" id="bc-corp" onclick="toggleBen('corp')">
            <div class="bcr-icon">ğŸ¢</div>
            <div class="bcr-text">
              <div class="bcr-label">æ³•äººãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼çµŒç”±æ‰•ã„ï¼ˆæºæ³‰ãªã—ï¼‰</div>
              <div class="bcr-sub">å‰µæ¥­ãƒ¡ãƒ³ãƒãƒ¼å‘ã‘ã€‚å ±é…¬ã‚’æ³•äººå£åº§ã¸æŒ¯è¾¼</div>
            </div>
            <div class="bcr-toggle" id="bt-corp"></div>
          </div>
          <div class="ben-check-row" id="bc-rank" onclick="toggleBen('rank')">
            <div class="bcr-icon">â­</div>
            <div class="bcr-text">
              <div class="bcr-label">åˆæœŸãƒ©ãƒ³ã‚¯æŒ‡å®š</div>
              <div class="bcr-sub">ç™»éŒ²æ™‚ã®ãƒ©ãƒ³ã‚¯ã‚’Bronzeä»¥å¤–ã«ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
            </div>
            <div class="bcr-toggle" id="bt-rank"></div>
          </div>
        </div>
      </div>

      <!-- Rate (shown if rate is selected) -->
      <div class="mfield" id="rate-field" style="display:none">
        <label>ã‚«ã‚¹ã‚¿ãƒ å ±é…¬ç‡ï¼ˆä¸å‹•ç”£ / äººæï¼‰</label>
        <div class="mfield-row">
          <div>
            <label style="font-size:9px">ä¸å‹•ç”£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</label>
            <input type="number" id="m-rate-re" min="0" max="100" step="0.5" value="75"
                   style="font-family:'DM Mono',monospace">
          </div>
          <div>
            <label style="font-size:9px">äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</label>
            <input type="number" id="m-rate-hr" min="0" max="100" step="0.5" value="55"
                   style="font-family:'DM Mono',monospace">
          </div>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:4px">
          â€» ã“ã®ç‡ã¯ãƒ©ãƒ³ã‚¯ã«é–¢ã‚ã‚‰ãšé©ç”¨ã•ã‚Œã¾ã™ï¼ˆä¸‰ç‚ºãƒ»é«˜é¡ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ã¯é€šå¸¸é€šã‚Šï¼‰
        </div>
      </div>

      <!-- Rank (shown if rank is selected) -->
      <div class="mfield" id="rank-field" style="display:none">
        <label>åˆæœŸãƒ©ãƒ³ã‚¯æŒ‡å®š</label>
        <select id="m-rank">
          <option value="silver">ğŸ¥ˆ Silver</option>
          <option value="gold">ğŸ¥‡ Gold</option>
          <option value="platinum">ğŸ’ Platinum</option>
          <option value="founder">â­ å‰µæ¥­ãƒ¡ãƒ³ãƒãƒ¼</option>
        </select>
      </div>

      <!-- Limits -->
      <div class="mfield-row" style="margin-bottom:14px">
        <div class="mfield" style="margin-bottom:0">
          <label>ä½¿ç”¨ä¸Šé™ <span style="color:var(--muted);font-size:9px">ï¼ˆç©ºç™½=ç„¡åˆ¶é™ï¼‰</span></label>
          <input type="number" id="m-limit" min="1" step="1" placeholder="ä¾‹ï¼š10"
                 style="font-family:'DM Mono',monospace">
        </div>
        <div class="mfield" style="margin-bottom:0">
          <label>æœ‰åŠ¹æœŸé™ <span style="color:var(--muted);font-size:9px">ï¼ˆç©ºç™½=ç„¡æœŸé™ï¼‰</span></label>
          <input type="date" id="m-expiry">
        </div>
      </div>

      <!-- Target -->
      <div class="mfield">
        <label>å¯¾è±¡ã‚¿ã‚¤ãƒ—</label>
        <select id="m-target">
          <option value="all">å…¨å“¡ï¼ˆãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ»REãƒ»HRï¼‰</option>
          <option value="re">ä¸å‹•ç”£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿</option>
          <option value="hr">äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿</option>
          <option value="pt">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ã¿</option>
          <option value="founder">å‰µæ¥­ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿</option>
        </select>
      </div>

      <!-- Memo -->
      <div class="mfield" style="margin-bottom:0">
        <label>ãƒ¡ãƒ¢ãƒ»ç™ºè¡Œç†ç”±</label>
        <textarea id="m-memo" rows="2" placeholder="ä¾‹ï¼š2026å¹´Q1ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç”¨ã€‚å…ˆç€10åã¾ã§ã€‚"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="mf-btn mf-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="mf-btn mf-save" onclick="saveCode()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- â”€ Usage Modal â”€ -->
<div class="modal-overlay" id="usage-modal" onclick="if(event.target===this)closeUsageModal()">
  <div class="modal">
    <div class="modal-hdr">
      <div class="modal-title" id="um-title">ä½¿ç”¨å±¥æ­´</div>
      <button class="modal-close" onclick="closeUsageModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="use-list" id="use-list"></div>
    </div>
  </div>
</div>

<script>
// ================================================================
//  Demo data
// ================================================================
let CODES = [
  {
    id:1, code:'FOUNDER2026', active:true, expiry:null, limit:null, used:3,
    benefits:{ freefee:true, rate:false, corp:true, rank:true },
    rateRE:90, rateHR:90, rank:'founder', target:'founder',
    memo:'å‰µæ¥­ãƒ¡ãƒ³ãƒãƒ¼å‘ã‘ã€‚æ³•äººæ‰•ã„å¯¾å¿œãƒ»æœˆä¼šè²»æ°¸ä¹…ç„¡æ–™ãƒ»å‰µæ¥­ãƒ¡ãƒ³ãƒãƒ¼ãƒ©ãƒ³ã‚¯ä»˜ä¸',
    users:[
      { id:'10001', name:'Tim', type:'RE', date:'2025-10-01' },
      { id:'20001', name:'ä½è—¤ èŠ±å­', type:'HR', date:'2025-11-15' },
      { id:'10003', name:'éˆ´æœ¨ ä¸€éƒ', type:'RE', date:'2025-12-03' },
    ]
  },
  {
    id:2, code:'WELCOME2026', active:true, expiry:'2026-03-31', limit:20, used:7,
    benefits:{ freefee:true, rate:false, corp:false, rank:false },
    rateRE:null, rateHR:null, rank:null, target:'all',
    memo:'2026å¹´Q1ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç”¨ã€‚æœˆä¼šè²»æ°¸ä¹…ç„¡æ–™ç‰¹å…¸ã€‚å…ˆç€20åã€‚',
    users:[
      { id:'10012', name:'å±±ç”° èª ',   type:'RE', date:'2026-01-10' },
      { id:'20005', name:'ç”°ä¸­ ç¾ç©‚', type:'HR', date:'2026-01-18' },
      { id:'30007', name:'ä½è—¤ ç¾å’²', type:'PT', date:'2026-01-22' },
      { id:'10015', name:'æœ¨æ‘ å¤§ä»‹', type:'RE', date:'2026-02-01' },
      { id:'20008', name:'ä¸­æ‘ é¦™',   type:'HR', date:'2026-02-05' },
      { id:'10020', name:'æ¸¡è¾º éš†',   type:'RE', date:'2026-02-10' },
      { id:'30010', name:'é«˜æ©‹ å¥',   type:'PT', date:'2026-02-14' },
    ]
  },
  {
    id:3, code:'GOLD_START', active:true, expiry:'2026-06-30', limit:5, used:2,
    benefits:{ freefee:true, rate:false, corp:false, rank:true },
    rateRE:null, rateHR:null, rank:'gold', target:'re',
    memo:'å„ªç§€å€™è£œè€…ã‚¹ã‚«ã‚¦ãƒˆç”¨ã€‚Goldãƒ©ãƒ³ã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼‹æœˆä¼šè²»ç„¡æ–™ã€‚ä¸å‹•ç”£AGé™å®šã€‚',
    users:[
      { id:'10025', name:'é•·è°·å· ç¿”', type:'RE', date:'2026-01-28' },
      { id:'10030', name:'æ± ç”° èŒœ',   type:'RE', date:'2026-02-08' },
    ]
  },
  {
    id:4, code:'HR_PRO75', active:true, expiry:null, limit:3, used:1,
    benefits:{ freefee:false, rate:true, corp:false, rank:false },
    rateRE:null, rateHR:75, rank:null, target:'hr',
    memo:'äººæAGå‘ã‘é«˜å ±é…¬ç‡ã‚³ãƒ¼ãƒ‰ã€‚ç‰¹åˆ¥æ¡ç”¨å€™è£œå‘ã‘ã€‚',
    users:[
      { id:'20010', name:'å°å· å„ªå­', type:'HR', date:'2026-02-01' },
    ]
  },
  {
    id:5, code:'CAMP_2025', active:false, expiry:'2025-12-31', limit:50, used:23,
    benefits:{ freefee:true, rate:false, corp:false, rank:false },
    rateRE:null, rateHR:null, rank:null, target:'all',
    memo:'2025å¹´æœ«ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã€‚çµ‚äº†æ¸ˆã¿ã€‚',
    users:[]
  },
];

let currentFilter = 'all';
let editingId     = null;
let selectedBens  = { freefee:false, rate:false, corp:false, rank:false };

// ================================================================
//  Init
// ================================================================
window.addEventListener('DOMContentLoaded', () => {
  renderStats();
  renderTable();
});

// ================================================================
//  Stats
// ================================================================
function renderStats() {
  const total   = CODES.length;
  const active  = CODES.filter(c=>c.active && !isExpired(c)).length;
  const totalUsed = CODES.reduce((s,c)=>s+c.used, 0);
  const withLimit = CODES.filter(c=>c.limit && c.active).length;

  document.getElementById('stats-row').innerHTML = [
    { val: total,     label:'ã‚³ãƒ¼ãƒ‰ç·æ•°',     color:'var(--text)' },
    { val: active,    label:'æœ‰åŠ¹ã‚³ãƒ¼ãƒ‰æ•°',    color:'var(--green)' },
    { val: totalUsed, label:'ç·ä½¿ç”¨å›æ•°',      color:'var(--blue)' },
    { val: withLimit, label:'ä½¿ç”¨ä¸Šé™ã‚ã‚Š',    color:'var(--orange)' },
  ].map(s=>`
    <div class="stat-card">
      <div class="sc-val" style="color:${s.color}">${s.val}</div>
      <div class="sc-label">${s.label}</div>
    </div>`).join('');
}

function isExpired(c) {
  if (!c.expiry) return false;
  return new Date(c.expiry) < new Date();
}
function isLimitReached(c) {
  return c.limit && c.used >= c.limit;
}
function getStatus(c) {
  if (!c.active) return 'inactive';
  if (isExpired(c)) return 'expired';
  if (isLimitReached(c)) return 'expired';
  return 'active';
}

// ================================================================
//  Table
// ================================================================
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.ft').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderTable();
}

function renderTable() {
  const q = document.getElementById('search-box').value.toLowerCase();
  const filtered = CODES.filter(c => {
    const st = getStatus(c);
    const fOk = currentFilter === 'all' ? true
      : currentFilter === 'active'   ? st === 'active'
      : currentFilter === 'inactive' ? st === 'inactive'
      : currentFilter === 'expired'  ? st === 'expired'
      : true;
    const qOk = !q || c.code.toLowerCase().includes(q) || (c.memo||'').toLowerCase().includes(q);
    return fOk && qOk;
  });

  document.getElementById('tbl-count').textContent = `${filtered.length} ä»¶`;

  const ST_LABEL = { active:'æœ‰åŠ¹', inactive:'ç„¡åŠ¹', expired:'æœŸé™åˆ‡ã‚Œ' };
  const ST_CLS   = { active:'st-active', inactive:'st-inactive', expired:'st-expired' };

  document.getElementById('tbl-body').innerHTML = filtered.map(c => {
    const st      = getStatus(c);
    const usePct  = c.limit ? Math.min(100, Math.round(c.used / c.limit * 100)) : null;
    const bens    = buildBenBadges(c);
    return `
      <tr>
        <td>
          <div class="code-chip" style="background:rgba(201,168,76,.08);color:var(--gold);
               border:1px solid var(--gold-dim)" onclick="copyCode('${c.code}')">
            ${c.code}
            <span class="copy-hint">ğŸ“‹</span>
          </div>
        </td>
        <td><div class="ben-wrap">${bens}</div></td>
        <td>
          <div style="font-family:'DM Mono',monospace;font-size:12px">
            ${c.used}${c.limit ? ' / '+c.limit : ' / âˆ'}
          </div>
          ${usePct !== null ? `
            <div class="usage-bar">
              <div class="usage-fill" style="width:${usePct}%;background:${usePct>=90?'var(--red)':usePct>=70?'var(--orange)':'var(--green)'}"></div>
            </div>` : ''}
          <div style="font-size:10px;color:var(--muted);margin-top:2px;cursor:pointer;color:var(--blue)"
               onclick="showUsage(${c.id})">å±¥æ­´ã‚’è¦‹ã‚‹</div>
        </td>
        <td style="font-size:11px;color:${c.expiry?'var(--sub)':'var(--muted)'}">
          ${c.expiry || 'ç„¡æœŸé™'}
        </td>
        <td>
          <span class="status-dot ${ST_CLS[st]}"></span>
          <span style="font-size:11px">${ST_LABEL[st]}</span>
          ${isLimitReached(c) ? '<div style="font-size:9px;color:var(--red)">ä¸Šé™åˆ°é”</div>' : ''}
        </td>
        <td style="max-width:180px;font-size:11px;color:var(--sub);line-height:1.6">${c.memo||'â€”'}</td>
        <td>
          <div style="display:flex;gap:4px;flex-wrap:wrap">
            <button class="act-btn act-edit" onclick="openModal(${c.id})">ç·¨é›†</button>
            <button class="act-btn act-tog" onclick="toggleActive(${c.id})">
              ${c.active?'ç„¡åŠ¹åŒ–':'æœ‰åŠ¹åŒ–'}
            </button>
            <button class="act-btn act-del" onclick="deleteCode(${c.id})">å‰Šé™¤</button>
          </div>
        </td>
      </tr>`;
  }).join('') || `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:32px;font-size:12px">
    è©²å½“ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“
  </td></tr>`;
}

function buildBenBadges(c) {
  const parts = [];
  if (c.benefits.freefee) parts.push('<span class="ben ben-fee">ğŸ· æœˆä¼šè²»ç„¡æ–™</span>');
  if (c.benefits.rate)    {
    const rStr = [c.rateRE!=null?`ä¸å‹•ç”£${c.rateRE}%`:'', c.rateHR!=null?`äººæ${c.rateHR}%`:''].filter(Boolean).join('/');
    parts.push(`<span class="ben ben-rate">ğŸ’° å ±é…¬ç‡ ${rStr}</span>`);
  }
  if (c.benefits.corp)    parts.push('<span class="ben ben-corp">ğŸ¢ æ³•äººæ‰•ã„</span>');
  if (c.benefits.rank)    {
    const rl = {silver:'Silver',gold:'Gold',platinum:'Platinum',founder:'å‰µæ¥­ãƒ¡ãƒ³ãƒãƒ¼'};
    parts.push(`<span class="ben ben-rank">â­ ${rl[c.rank]||c.rank}ã‚¹ã‚¿ãƒ¼ãƒˆ</span>`);
  }
  if (!parts.length)       parts.push('<span class="ben ben-custom">â€” ç‰¹å…¸ãªã—</span>');
  return parts.join('');
}

// ================================================================
//  Modal: Create / Edit
// ================================================================
function openModal(id) {
  editingId = id || null;
  const c   = id ? CODES.find(x=>x.id===id) : null;

  document.getElementById('modal-title').textContent = c ? 'ã‚³ãƒ¼ãƒ‰ç·¨é›†' : 'æ–°è¦ã‚³ãƒ¼ãƒ‰ä½œæˆ';

  document.getElementById('m-code').value  = c ? c.code : '';
  document.getElementById('m-limit').value = c && c.limit ? c.limit : '';
  document.getElementById('m-expiry').value= c && c.expiry ? c.expiry : '';
  document.getElementById('m-target').value= c ? c.target : 'all';
  document.getElementById('m-memo').value  = c ? c.memo : '';
  document.getElementById('m-rate-re').value = c && c.rateRE != null ? c.rateRE : 75;
  document.getElementById('m-rate-hr').value = c && c.rateHR != null ? c.rateHR : 55;
  document.getElementById('m-rank').value  = c && c.rank ? c.rank : 'gold';

  // Benefits
  selectedBens = c ? { ...c.benefits } : { freefee:true, rate:false, corp:false, rank:false };
  renderBenChecks();
  document.getElementById('modal').classList.add('show');
}

function closeModal() { document.getElementById('modal').classList.remove('show'); }

function generateCode() {
  const chars  = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const prefix = ['WELCOME','SPECIAL','CAMP','PRO','VIP','START','BONUS'][Math.floor(Math.random()*7)];
  const suffix = Array.from({length:4}, ()=>chars[Math.floor(Math.random()*chars.length)]).join('');
  document.getElementById('m-code').value = prefix + suffix;
}

function toggleBen(key) {
  selectedBens[key] = !selectedBens[key];
  renderBenChecks();
  document.getElementById('rate-field').style.display = selectedBens.rate ? 'block' : 'none';
  document.getElementById('rank-field').style.display = selectedBens.rank ? 'block' : 'none';
}

function renderBenChecks() {
  ['freefee','rate','corp','rank'].forEach(k => {
    const row = document.getElementById(`bc-${k}`);
    const tog = document.getElementById(`bt-${k}`);
    if (row) row.classList.toggle('selected', selectedBens[k]);
    if (tog) { tog.classList.toggle('on', selectedBens[k]); tog.textContent = selectedBens[k] ? 'âœ“' : ''; }
  });
  document.getElementById('rate-field').style.display = selectedBens.rate ? 'block' : 'none';
  document.getElementById('rank-field').style.display = selectedBens.rank ? 'block' : 'none';
}

function saveCode() {
  const code = document.getElementById('m-code').value.trim().toUpperCase();
  if (!code) { alert('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!editingId && CODES.find(c=>c.code===code)) {
    alert('ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™'); return;
  }

  const limit  = parseInt(document.getElementById('m-limit').value) || null;
  const expiry = document.getElementById('m-expiry').value || null;
  const target = document.getElementById('m-target').value;
  const memo   = document.getElementById('m-memo').value;
  const rateRE = selectedBens.rate ? parseFloat(document.getElementById('m-rate-re').value)||null : null;
  const rateHR = selectedBens.rate ? parseFloat(document.getElementById('m-rate-hr').value)||null : null;
  const rank   = selectedBens.rank ? document.getElementById('m-rank').value : null;

  if (editingId) {
    const c = CODES.find(x=>x.id===editingId);
    Object.assign(c, { code, limit, expiry, target, memo, benefits:{...selectedBens}, rateRE, rateHR, rank });
  } else {
    CODES.unshift({ id: Date.now(), code, active:true, expiry, limit, used:0,
      benefits:{...selectedBens}, rateRE, rateHR, rank, target, memo, users:[] });
  }
  closeModal();
  renderStats();
  renderTable();
}

// ================================================================
//  Actions
// ================================================================
function copyCode(code) {
  navigator.clipboard.writeText(code).then(()=>{
    const cells = document.querySelectorAll('.code-chip');
    cells.forEach(c=>{ if(c.textContent.includes(code)) {
      c.style.background='rgba(52,211,153,.15)';
      setTimeout(()=>c.style.background='',800);
    }});
  });
}

function toggleActive(id) {
  const c = CODES.find(x=>x.id===id);
  if (c) c.active = !c.active;
  renderStats();
  renderTable();
}

function deleteCode(id) {
  const c = CODES.find(x=>x.id===id);
  if (!c) return;
  if (!confirm(`ã€Œ${c.code}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;
  CODES = CODES.filter(x=>x.id!==id);
  renderStats();
  renderTable();
}

// ================================================================
//  Usage modal
// ================================================================
function showUsage(id) {
  const c = CODES.find(x=>x.id===id);
  if (!c) return;
  document.getElementById('um-title').textContent = `ã€Œ${c.code}ã€ä½¿ç”¨å±¥æ­´ï¼ˆ${c.used}ä»¶ï¼‰`;
  const TYPE_ICON = { RE:'ğŸ ', HR:'ğŸ‘¥', PT:'ğŸ¤' };
  document.getElementById('use-list').innerHTML = c.users.length
    ? c.users.map(u=>`
        <div class="use-item">
          <div class="use-avatar">${TYPE_ICON[u.type]||'ğŸ‘¤'}</div>
          <div style="flex:1">
            <div style="font-weight:700">${u.name}</div>
            <div style="color:var(--muted);font-size:10px">${u.id} ï¼ ${u.type}</div>
          </div>
          <div style="font-size:10px;color:var(--sub)">${u.date}</div>
        </div>`).join('')
    : '<div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">ä½¿ç”¨å±¥æ­´ãªã—</div>';
  document.getElementById('usage-modal').classList.add('show');
}

function closeUsageModal() { document.getElementById('usage-modal').classList.remove('show'); }

// ================================================================
//  CSV export
// ================================================================
function exportCSV() {
  const rows = [['ã‚³ãƒ¼ãƒ‰','æœ‰åŠ¹','æœ‰åŠ¹æœŸé™','ä½¿ç”¨æ•°','ä¸Šé™','æœˆä¼šè²»ç„¡æ–™','ã‚«ã‚¹ã‚¿ãƒ å ±é…¬ç‡','æ³•äººæ‰•ã„','ãƒ©ãƒ³ã‚¯æŒ‡å®š','å¯¾è±¡','ãƒ¡ãƒ¢']];
  CODES.forEach(c => {
    rows.push([
      c.code, c.active?'â—‹':'âœ•', c.expiry||'ç„¡æœŸé™',
      c.used, c.limit||'âˆ',
      c.benefits.freefee?'â—‹':'', c.benefits.rate?`RE:${c.rateRE}%/HR:${c.rateHR}%`:'',
      c.benefits.corp?'â—‹':'', c.benefits.rank?c.rank:'', c.target, c.memo||''
    ]);
  });
  const csv = rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `coreto_codes_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}
</script>
</body>
</html>
