<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- â”€â”€ Content Security Policy (XSSè»½æ¸›) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       å¤‰æ›´æ™‚: ä½¿ç”¨ã™ã‚‹å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
       Kintoneè¿½åŠ æ™‚: connect-src ã« *.cybozu.com ã‚’è¿½åŠ 
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline'
      https://cdnjs.cloudflare.com
      https://js.stripe.com
      https://cdn-cgi/scripts;
    style-src 'self' 'unsafe-inline'
      https://fonts.googleapis.com;
    font-src 'self'
      https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    connect-src 'self'
      https://hooks.slack.com
      https://hooks.zapier.com
      https://api.stripe.com
      https://js.stripe.com
      https://www.houjin-bangou.nta.go.jp
      https://www.retio.or.jp;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
  ">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORETO å†…è¦‹ä¾é ¼æ›¸ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0d12;--card:#13161f;--card2:#191c27;--border:#222638;
  --gold:#c9a84c;--gold-l:#e8c96a;--gold-dim:#7a5f22;
  --blue:#3b82f6;--green:#22c55e;--red:#ef4444;--orange:#f59e0b;
  --muted:#5a6378;--sub:#8892a4;--text:#dde1ed;
}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ */
.header{background:linear-gradient(135deg,#0d1020,#141828);border-bottom:1px solid var(--border);padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:52px}
.logo{font-family:'DM Mono',monospace;font-size:18px;color:var(--gold);letter-spacing:3px}
.logo-sub{font-size:9px;color:var(--muted);letter-spacing:1px;margin-top:1px}

/* â”€â”€ ã‚¿ãƒ– â”€â”€ */
.tabs{background:#0e1019;border-bottom:1px solid var(--border);display:flex;padding:0 28px}
.tab{padding:11px 18px;font-size:11px;cursor:pointer;border-bottom:2px solid transparent;color:var(--muted);transition:all .2s}
.tab.on{color:var(--gold);border-bottom-color:var(--gold)}

/* â”€â”€ ãƒšãƒ¼ã‚¸ â”€â”€ */
.page{display:none;padding:22px 28px;max-width:1280px;margin:0 auto}.page.on{display:block}

/* â”€â”€ ãƒ‘ãƒãƒ« â”€â”€ */
.panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:14px}
.panel-title{font-size:11px;font-weight:700;color:var(--gold);letter-spacing:2px;text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.panel-title::before{content:'';width:3px;height:13px;background:var(--gold);border-radius:2px}
.s-label{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;padding:9px 0 6px;border-bottom:1px solid rgba(34,38,56,.8);margin-bottom:9px;margin-top:14px}
.s-label:first-child{margin-top:0}
.fg{margin-bottom:10px}
.fg label{font-size:11px;color:var(--sub);display:block;margin-bottom:3px}
.fg input,.fg select,.fg textarea{width:100%;background:#0d0f18;border:1px solid var(--border);border-radius:7px;padding:8px 11px;color:var(--text);font-size:13px;font-family:'Noto Sans JP',sans-serif;transition:border-color .15s}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--gold)}
.fg input[type=date]{color-scheme:dark}
.mono{font-family:'DM Mono',monospace}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}

/* â”€â”€ ãƒœã‚¿ãƒ³ â”€â”€ */
.btn{padding:10px 18px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Noto Sans JP',sans-serif;transition:all .15s;letter-spacing:.5px}
.btn-gold{background:var(--gold);color:#0a0c10}.btn-gold:hover{background:var(--gold-l)}
.btn-blue{background:rgba(59,130,246,.2);color:var(--blue);border:1px solid rgba(59,130,246,.4)}.btn-blue:hover{background:rgba(59,130,246,.3)}
.btn-green{background:rgba(34,197,94,.2);color:var(--green);border:1px solid rgba(34,197,94,.4)}.btn-green:hover{background:rgba(34,197,94,.3)}
.btn-muted{background:transparent;color:var(--muted);border:1px solid var(--border)}.btn-muted:hover{color:var(--text)}
.btn-full{width:100%;padding:13px;font-size:13px;margin-top:4px}
.btn-sm{padding:5px 11px;font-size:10px;border-radius:5px}

/* â”€â”€ ã‚¢ãƒ©ãƒ¼ãƒˆ â”€â”€ */
.alert{border-radius:8px;padding:10px 13px;font-size:11px;line-height:1.7;margin-bottom:12px}
.ao{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.22);color:var(--orange)}
.ag{background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.22);color:var(--green)}
.ab{background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.22);color:var(--blue)}

/* â”€â”€ ãƒãƒƒã‚¸ â”€â”€ */
.badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700}

/* â”€â”€ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰é¸æŠ â”€â”€ */
.agent-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-top:6px}
.agent-card{background:var(--card2);border:2px solid var(--border);border-radius:9px;padding:12px;cursor:pointer;transition:all .15s}
.agent-card:hover{border-color:rgba(201,168,76,.4)}
.agent-card.selected{border-color:var(--gold);background:rgba(201,168,76,.06)}
.ac-name{font-size:13px;font-weight:700;margin-bottom:3px}
.ac-id{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.ac-info{font-size:10px;color:var(--sub);margin-top:4px;line-height:1.6}
.ac-rank{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:700;display:inline-block;margin-top:3px}

/* â”€â”€ å†…è¦‹ä¾é ¼æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆFAXç”¨ï¼‰â”€â”€ */
.preview-container{background:#888;padding:20px;border-radius:8px}
.fax-doc{background:#fff;color:#000;font-family:'Noto Sans JP','MS Gothic',sans-serif;width:210mm;margin:0 auto;padding:20mm 18mm;position:relative;box-shadow:0 4px 20px rgba(0,0,0,.4);min-height:297mm}

/* å†…è¦‹ä¾é ¼æ›¸ æœ¬ä½“ */
.naiken-title{font-size:22px;font-weight:700;text-align:center;border:2px solid #000;padding:8px 0;margin-bottom:24px;letter-spacing:4px}
.naiken-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px}
.naiken-to{font-size:13px;font-weight:700}
.naiken-to-company{font-size:18px;font-weight:700;border-bottom:2px solid #000;padding-bottom:4px;margin-bottom:2px;min-width:200px;display:inline-block}
.naiken-from{font-size:11px;line-height:1.8;text-align:left}
.naiken-from-company{font-weight:700;font-size:12px}
.naiken-field-row{display:flex;align-items:center;margin-bottom:20px;border-bottom:1.5px solid #555;padding-bottom:14px}
.naiken-field-label{font-size:14px;font-weight:700;width:80px;flex-shrink:0}
.naiken-field-value{font-size:18px;font-weight:700;flex:1;padding-left:16px}
.naiken-body-text{font-size:13px;margin-bottom:8px;font-weight:500}
.naiken-note{font-size:13px;font-weight:700;margin-top:16px}

/* ååˆºéƒ¨åˆ† */
.naiken-card{border:3px solid #1a2744;margin-top:32px;display:flex;align-items:stretch;min-height:110px}
.naiken-card-left{background:#1a2744;padding:16px 20px;display:flex;flex-direction:column;justify-content:center;flex:1}
.naiken-card-name{color:#fff;font-size:30px;font-weight:700;letter-spacing:3px;margin-bottom:8px}
.naiken-card-info{color:#d0d8e8;font-size:11px;line-height:1.9}
.naiken-card-info .label{color:#c9a84c;font-size:10px}
.naiken-card-right{padding:16px 20px;display:flex;flex-direction:column;align-items:flex-end;justify-content:space-between;min-width:160px}
.naiken-card-logo{font-family:'DM Mono',monospace;font-size:22px;color:#1a2744;font-weight:700;letter-spacing:2px}
.naiken-card-license{font-size:10px;color:#666;text-align:right;margin-top:auto}
.naiken-card-mobile{font-size:13px;font-weight:700;color:#1a2744;font-family:'DM Mono',monospace}

/* â”€â”€ Slackãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â”€â”€ */
.slack-preview{background:#3f0e40;border-radius:10px;padding:16px;margin-top:12px}
.slack-channel{color:#ccc;font-size:10px;margin-bottom:8px;font-family:'DM Mono',monospace}
.slack-msg{background:#1a1d21;border-radius:8px;padding:12px;border-left:4px solid #c9a84c}
.slack-sender{font-size:11px;font-weight:700;color:#c9a84c;margin-bottom:4px}
.slack-text{font-size:12px;color:#e8e8e8;line-height:1.8;white-space:pre-line}
.slack-time{font-size:10px;color:#666;margin-top:6px}

/* â”€â”€ å†…è¦‹å±¥æ­´DB â”€â”€ */
.naiken-table{width:100%;border-collapse:collapse;font-size:12px}
.naiken-table th{padding:9px 12px;font-size:10px;color:var(--muted);font-weight:600;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
.naiken-table td{padding:9px 12px;border-bottom:1px solid rgba(34,38,56,.4);vertical-align:top}
.naiken-table tr:hover td{background:rgba(255,255,255,.02)}
.naiken-table .cl-id{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.status-badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
.s-scheduled{background:rgba(59,130,246,.15);color:var(--blue)}
.s-done{background:rgba(34,197,94,.15);color:var(--green)}
.s-cancelled{background:rgba(90,99,120,.15);color:var(--muted)}

/* â”€â”€ é¡§å®¢è©³ç´°ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« â”€â”€ */
.db-layout{display:grid;grid-template-columns:1fr 320px;gap:14px}
@media(max-width:1000px){.db-layout{grid-template-columns:1fr}}
.customer-card{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px;cursor:pointer;transition:border-color .15s}
.customer-card:hover{border-color:rgba(201,168,76,.4)}
.customer-card.selected{border-color:var(--gold)}
.cc-name{font-size:16px;font-weight:700;margin-bottom:3px}
.cc-id{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.cc-history{margin-top:8px}
.history-item{background:var(--card);border:1px solid var(--border);border-radius:7px;padding:9px 12px;margin-bottom:6px;font-size:11px}
.hi-prop{font-weight:600;margin-bottom:3px}
.hi-meta{color:var(--sub);font-size:10px}

.filter-bar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.filter-chip{padding:4px 12px;border-radius:20px;font-size:11px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Noto Sans JP',sans-serif;transition:all .15s}
.filter-chip.on{background:rgba(201,168,76,.15);border-color:var(--gold-dim);color:var(--gold);font-weight:700}
.search-box{flex:1;min-width:160px;max-width:240px;position:relative}
.search-box input{background:#0d0f18;border:1px solid var(--border);border-radius:20px;padding:5px 12px 5px 30px;color:var(--text);font-size:11px;width:100%;font-family:'Noto Sans JP',sans-serif}
.search-box::before{content:'ğŸ”';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:11px}

.empty{text-align:center;padding:48px;color:var(--muted);font-size:13px;line-height:2}
.hidden{display:none!important}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€ å°åˆ·ã‚¹ã‚¿ã‚¤ãƒ« â”€â”€ */
@media print{
  body{background:#fff !important}
  .header,.tabs,.page > :not(#printable-area){display:none !important}
  #printable-area{display:block !important}
  .fax-doc{box-shadow:none;padding:15mm 15mm}
  .preview-container{background:none;padding:0}
}

/* â”€â”€ Client Autocomplete â”€â”€ */
.cl-search-wrap{position:relative}
.cl-input{width:100%;padding:9px 12px;background:var(--bg2,#1a1e2a);border:1px solid var(--border,#2a2f42);border-radius:8px;color:var(--text,#e8eaf0);font-size:12px;font-family:inherit;outline:none;transition:border-color .15s}
.cl-input:focus{border-color:var(--gold,#c9a840)}
.cl-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--card,#151822);border:1px solid var(--border2,#2e3447);border-radius:8px;z-index:999;max-height:200px;overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,.4);display:none}
.cl-option{padding:9px 13px;cursor:pointer;border-bottom:1px solid var(--border,#2a2f42);display:flex;align-items:center;gap:10px;transition:background .1s}
.cl-option:last-child{border-bottom:none}
.cl-option:hover,.cl-option.focused{background:rgba(201,168,64,.1)}
.cl-opt-id{font-family:'DM Mono',monospace;font-size:10px;color:var(--gold,#c9a840);min-width:80px}
.cl-opt-name{font-size:12px;font-weight:600}
.cl-opt-kana{font-size:10px;color:var(--muted,#4a4f68)}
.cl-new-hint{padding:8px 13px;font-size:10px;color:var(--muted,#4a4f68);border-top:1px solid var(--border,#2a2f42)}
</style>
</head>
<body>

<!-- â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ -->
<div class="header">
  <div>
    <div class="logo">CORETO</div>
    <div class="logo-sub">å†…è¦‹ä¾é ¼æ›¸ã‚·ã‚¹ãƒ†ãƒ </div>
  </div>
  <div style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace">å†…è¦‹ / FAX / é¡§å®¢DB</div>
</div>

<!-- â”€â”€ ã‚¿ãƒ– â”€â”€ -->
<div class="tabs">
  <div class="tab on" onclick="switchTab(0)">ğŸ“‹ å†…è¦‹ä¾é ¼æ›¸ ä½œæˆãƒ»ç™ºè¡Œ</div>
  <div class="tab" onclick="switchTab(1)">ğŸ“ é¡§å®¢DBãƒ»å†…è¦‹å±¥æ­´</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  TAB 0: å†…è¦‹ä¾é ¼æ›¸ ä½œæˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page on" id="page-0">
<div style="display:grid;grid-template-columns:400px 1fr;gap:18px;align-items:start">

<!-- å·¦ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
<div>
  <div class="panel">
    <div class="panel-title">å†…è¦‹ä¾é ¼æ›¸ æƒ…å ±å…¥åŠ›</div>

    <div class="s-label">é¡§å®¢æƒ…å ±</div>
    <div class="row2">
      <div class="fg" style="grid-column:1/-1">
        <label>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID / æ°å <span style="color:var(--muted);font-size:9px">ï¼ˆIDãƒ»åå‰ãƒ»ã‚«ãƒŠã§æ¤œç´¢ï¼‰</span></label>
        <div class="cl-search-wrap">
          <input class="cl-input" id="client-search" type="text" placeholder="CL-00001 ã¾ãŸã¯ å±±ç”° ã§æ¤œç´¢..." autocomplete="off">
          <div class="cl-dropdown" id="client-dropdown"></div>
        </div>
        <input type="hidden" id="customer-id">
        <input type="hidden" id="customer-name">
      </div>
    </div>

    <div class="s-label">é€ä»˜å…ˆï¼ˆç®¡ç†ä¼šç¤¾ï¼‰</div>
    <div class="fg">
      <label>ç®¡ç†ä¼šç¤¾å</label>
      <input type="text" id="mgmt-company" placeholder="ä¾‹ï¼šã‚½ãƒ•ã‚£ã‚¢ã‚¹ã‚¿ãƒƒãƒ•æ ªå¼ä¼šç¤¾" oninput="updatePreview()">
    </div>

    <div class="s-label">ç‰©ä»¶ãƒ»æ—¥ç¨‹</div>
    <div class="fg">
      <label>ç‰©ä»¶å</label>
      <input type="text" id="prop-name" placeholder="ä¾‹ï¼šæ±æ¾æœ¬ä¸€ä¸ç›®åº—èˆ—ä»˜ãæˆ¸å»º" oninput="updatePreview()">
    </div>
    <div class="row2">
      <div class="fg">
        <label>å†…è¦‹æ—¥</label>
        <input type="date" id="naiken-date" oninput="updatePreview()">
      </div>
      <div class="fg">
        <label>é›†åˆå ´æ‰€ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="meet-place" placeholder="ä¾‹ï¼šç‰©ä»¶å‰ã€ç®¡ç†ä¼šç¤¾äº‹å‹™æ‰€" oninput="updatePreview()">
      </div>
    </div>
    <div class="row2">
      <div class="fg">
        <label>æ™‚é–“ï¼ˆæ™‚ï¼‰</label>
        <select id="naiken-hour" onchange="updatePreview()">
          <option value="09">09</option><option value="10">10</option>
          <option value="11">11</option><option value="12">12</option>
          <option value="13">13</option><option value="14">14</option>
          <option value="15" selected>15</option><option value="16">16</option>
          <option value="17">17</option><option value="18">18</option>
        </select>
      </div>
      <div class="fg">
        <label>æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
        <select id="naiken-min" onchange="updatePreview()">
          <option value="00" selected>00</option><option value="15">15</option>
          <option value="30">30</option><option value="45">45</option>
        </select>
      </div>
    </div>

    <div class="s-label">æ‹…å½“è€…ï¼ˆååˆºéƒ¨åˆ†ã«åæ˜ ï¼‰</div>
    <div id="agent-display" style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:11px;line-height:1.8;margin-bottom:6px;color:var(--sub)">
      <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰è‡ªå‹•è¨­å®š -->
    </div>

    <div class="s-label">Slackãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®š</div>
    <div class="row2">
      <div class="fg">
        <label>ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆå‰æ—¥ï¼‰</label>
        <select>
          <option>å‰æ—¥ 09:00</option>
          <option>å‰æ—¥ 18:00</option>
          <option>ãªã—</option>
        </select>
      </div>
      <div class="fg">
        <label>ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆå½“æ—¥ï¼‰</label>
        <select>
          <option>å½“æ—¥ 08:00</option>
          <option>å½“æ—¥ 30åˆ†å‰</option>
          <option>ãªã—</option>
        </select>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
      <button class="btn btn-gold btn-full" onclick="generateDoc()">ğŸ“„ å†…è¦‹ä¾é ¼æ›¸ã‚’ç”Ÿæˆãƒ»FAXå‡ºåŠ›</button>
      <button class="btn btn-blue btn-full" onclick="sendSlack()">ğŸ’¬ Slackãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®š</button>
      <button class="btn btn-muted btn-full" onclick="saveToDb()">ğŸ’¾ é¡§å®¢DBã«å†…è¦‹å±¥æ­´ã‚’ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- å³ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
<div>
  <!-- Slackãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="panel" id="slack-preview-panel">
    <div class="panel-title">Slack ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
    <div class="slack-preview">
      <div class="slack-channel" id="slack-ch-label">#æ¡ˆä»¶ç®¡ç†</div>
      <div class="slack-msg">
        <div class="slack-sender">ğŸ  CORETO å†…è¦‹ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</div>
        <div class="slack-text" id="slack-text">ç‰©ä»¶åãƒ»æ—¥æ™‚ã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        <div class="slack-time">ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡äºˆå®šï¼šå‰æ—¥ 09:00 / å½“æ—¥ 08:00</div>
      </div>
    </div>
  </div>

  <!-- FAXæ›¸é¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="panel">
    <div class="panel-title" style="justify-content:space-between">
      <span>å†…è¦‹ä¾é ¼æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆFAXç”¨ï¼‰</span>
      <div style="display:flex;gap:6px">
        <button class="btn btn-gold btn-sm" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·ãƒ»FAX</button>
        <button class="btn btn-blue btn-sm" onclick="downloadPDF()">â¬‡ï¸ PDFä¿å­˜</button>
      </div>
    </div>
    <div class="preview-container">
      <div class="fax-doc" id="fax-doc">
        <div class="naiken-title">å†…ã€€è¦‹ã€€ä¾ã€€é ¼ã€€æ›¸</div>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨ -->
        <div class="naiken-header">
          <div>
            <div class="naiken-to-company" id="prev-mgmt">ç®¡ç†ä¼šç¤¾å</div>
            <div class="naiken-to" style="margin-top:4px">å¾¡ä¸­</div>
          </div>
          <div class="naiken-from">
            <div class="naiken-from-company">æ ªå¼ä¼šç¤¾CORETO</div>
            ã€’150-0000<br>
            æ±äº¬éƒ½â—‹â—‹åŒºâ—‹â—‹ 1-1-1<br>
            <strong>Telï¼š03-XXXX-XXXX</strong>ã€€<strong>Faxï¼š03-XXXX-XXXX</strong>
          </div>
        </div>

        <!-- ç‰©ä»¶å -->
        <div class="naiken-field-row">
          <div class="naiken-field-label">ç‰©ä»¶å</div>
          <div class="naiken-field-value" id="prev-prop">ï¼ˆç‰©ä»¶åï¼‰</div>
        </div>

        <!-- æ—¥æ™‚ -->
        <div class="naiken-field-row">
          <div class="naiken-field-label">æ—¥æ™‚</div>
          <div class="naiken-field-value" id="prev-date" style="font-size:22px">
            <span id="prev-month">ã€€</span>ã€€æœˆã€€<span id="prev-day">ã€€</span>ã€€æ—¥
          </div>
        </div>

        <!-- æ™‚é–“ -->
        <div class="naiken-field-row">
          <div class="naiken-field-label">æ™‚é–“</div>
          <div class="naiken-field-value" style="font-size:22px">
            <span id="prev-hour">15</span>ã€€æ™‚ã€€<span id="prev-min">00</span>ã€€åˆ†
          </div>
        </div>

        <div class="naiken-body-text">ä¸Šè¨˜ç‰©ä»¶ã‚’å†…è¦‹ã•ã›ã¦é ‚ãã¾ã™ã€‚</div>
        <div class="naiken-body-text">å®œã—ããŠé¡˜ã„è‡´ã—ã¾ã™ã€‚</div>
        <div class="naiken-note">â€»ã€€ä¸‹è¨˜æºå¸¯ã¾ã§ã”é€£çµ¡ä¸‹ã•ã„</div>

        <!-- ååˆºéƒ¨åˆ† -->
        <div class="naiken-card">
          <div class="naiken-card-left">
            <div class="naiken-card-name" id="prev-ag-name">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå</div>
            <div class="naiken-card-info">
              <div>æ ªå¼ä¼šç¤¾CORETO</div>
              <div>ã€’150-0000ã€€æ±äº¬éƒ½â—‹â—‹åŒºâ—‹â—‹ 1-1-1</div>
              <div><span class="label">Telï¼š</span><span id="prev-ag-tel">03-XXXX-XXXX</span></div>
              <div><span class="label">Faxï¼š</span>03-XXXX-XXXX</div>
              <div><span class="label" style="color:#f59e0b">æºå¸¯ï¼š</span><span id="prev-ag-mobile" style="color:#f0c040;font-size:13px;font-weight:700">080-XXXX-XXXX</span></div>
            </div>
          </div>
          <div class="naiken-card-right">
            <div class="naiken-card-logo">CORETO</div>
            <div>
              <div class="naiken-card-mobile" id="prev-ag-mobile2">080-XXXX-XXXX</div>
              <div class="naiken-card-license" id="prev-license">æ±äº¬éƒ½çŸ¥äº‹(2)ç¬¬XXXXXå·</div>
            </div>
          </div>
        </div>

      </div><!-- /fax-doc -->
    </div><!-- /preview-container -->
  </div>
</div>

</div><!-- /grid -->
</div><!-- /page-0 -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  TAB 1: é¡§å®¢DBãƒ»å†…è¦‹å±¥æ­´
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-1">

  <div class="alert ab" style="margin-bottom:14px">
    ğŸ“‹ é¡§å®¢IDã¨ç´ã¥ã„ãŸå†…è¦‹å±¥æ­´ã€‚æ¡ˆä»¶ãŒé€²ã‚€ã«ã¤ã‚Œã¦è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨å±¥æ­´ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
  </div>

  <div class="filter-bar">
    <div class="search-box"><input type="text" placeholder="é¡§å®¢åãƒ»ç‰©ä»¶åã§æ¤œç´¢..." oninput="filterDb(this.value)"></div>
    <button class="filter-chip on" onclick="dbFilter(this,'all')">ã™ã¹ã¦</button>
    <button class="filter-chip" onclick="dbFilter(this,'scheduled')">äºˆå®šã‚ã‚Š</button>
    <button class="filter-chip" onclick="dbFilter(this,'done')">å®Œäº†</button>
    <div style="margin-left:auto;font-size:10px;color:var(--muted)" id="db-count">4åè¡¨ç¤ºä¸­</div>
  </div>

  <div class="db-layout">
    <!-- é¡§å®¢ãƒªã‚¹ãƒˆ -->
    <div id="db-list"><!-- JSç”Ÿæˆ --></div>

    <!-- è©³ç´°ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
    <div id="db-detail">
      <div class="panel"><div class="empty">â† é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„</div></div>
    </div>
  </div>
</div>

<script src="db.js"></script>
<script>
// â”€â”€ XSSã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  if (s == null) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;');
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â•â• AUTH GUARD (è¦ãƒ­ã‚°ã‚¤ãƒ³) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  var s = null;
  try { s = JSON.parse(sessionStorage.getItem('coreto_session') || 'null'); } catch(e) {}
  if (!s || !s.userId || !s.type) {
    sessionStorage.setItem('coreto_redirect', window.location.href);
    location.replace('coreto-login.html');
    return;
  }
  if (!s.sessionToken || s.sessionToken.length !== 64) {
    sessionStorage.removeItem('coreto_session');
    location.replace('coreto-login.html');
    return;
  }
  var _la = new Date(s.loginAt).getTime();
  if (isNaN(_la) || (Date.now() - _la) > 28800000) {
    sessionStorage.removeItem('coreto_session');
    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
    location.replace('coreto-login.html');
    return;
  }
  window._SESSION = s;
})();

// â”€â”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰è‡ªå‹•å…¥åŠ›ï¼‰ â”€â”€
(function() {
  const _S = JSON.parse(sessionStorage.getItem('coreto_session') || 'null');
  if (!_S) return;

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±ã‚’ selectedAgent ã«ã‚»ãƒƒãƒˆ
  selectedAgent = {
    id:      _S.userId  || 'â€”',
    name:    _S.name    || 'æ‹…å½“è€…å',
    tel:     _S.tel     || '03-XXXX-XXXX',
    mobile:  _S.mobile  || '080-XXXX-XXXX',
    license: _S.license || 'æ±äº¬éƒ½çŸ¥äº‹(X)ç¬¬XXXXXå·',
  };

  window.addEventListener('DOMContentLoaded', () => {
    // â‘  æ‹…å½“è€…è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆagent-display divï¼‰
    const disp = document.getElementById('agent-display');
    if (disp) {
      disp.innerHTML =
        '<strong style="color:var(--text)">' + selectedAgent.name + '</strong>'
        + 'ã€€<span style="color:var(--muted);font-size:10px">ID: ' + selectedAgent.id + '</span><br>'
        + '<span style="color:var(--muted)">æºå¸¯: </span>' + selectedAgent.mobile + 'ã€€'
        + '<span style="color:var(--muted)">Tel: </span>' + selectedAgent.tel;
      updatePreview();
    }

    // â‘¡ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æ¡ˆä»¶æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
    // pipeline ã‹ã‚‰ ?prop=ç‰©ä»¶å&mgmt=ç®¡ç†ä¼šç¤¾&date=YYYY-MM-DD&caseId=XXX ã§èµ·å‹•
    const params = new URLSearchParams(location.search);
    if (params.get('prop')) {
      const propEl = document.getElementById('prop-name');
      if (propEl) { propEl.value = params.get('prop'); }
    }
    if (params.get('mgmt')) {
      const mgmtEl = document.getElementById('mgmt-company');
      if (mgmtEl) { mgmtEl.value = params.get('mgmt'); }
    }
    if (params.get('date')) {
      const dateEl = document.getElementById('naiken-date');
      if (dateEl) { dateEl.value = params.get('date'); }
    }
    if (params.get('caseId')) {
      // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«è£œè¶³è¡¨ç¤º
      const titleEl = document.querySelector('.panel-title');
      if (titleEl) titleEl.textContent = 'å†…è¦‹ä¾é ¼æ›¸ æƒ…å ±å…¥åŠ›ã€€ï¼ˆæ¡ˆä»¶: ' + params.get('caseId') + 'ï¼‰';
    }
    if (params.get('prop') || params.get('mgmt')) updatePreview();

    // â‘¢ ã‚¿ãƒ–ãƒãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³è¿½åŠ 
    const tabs = document.querySelector('.tabs');
    if (tabs) {
      const back = document.createElement('div');
      back.style.cssText = 'margin-left:auto;padding:0 16px;display:flex;align-items:center;gap:10px';
      const backUrl = params.get('caseId') ? 'coreto-pipeline.html' : 'coreto-hub.html';
      const backLabel = params.get('caseId') ? 'â† æ¡ˆä»¶ç®¡ç†ã¸æˆ»ã‚‹' : 'â† ãƒã‚¤ãƒšãƒ¼ã‚¸';
      back.innerHTML = '<span style="font-size:10px;color:var(--muted)">ğŸ‘¤ ' + _S.name + '</span>' +
        '<button onclick="location.href=\'' + backUrl + '\'" style="font-size:10px;padding:4px 10px;border-radius:6px;border:1px solid var(--border2);background:transparent;color:var(--muted);cursor:pointer;font-family:sans-serif">' + backLabel + '</button>';
      tabs.appendChild(back);
    }
  });
})();

// â”€â”€ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆDB â”€â”€
const AGENTS = [
  {id:'AG-012',name:'å±±ç”° èª ',kana:'ãƒ¤ãƒãƒ€ ãƒã‚³ãƒˆ',tel:'03-XXXX-0012',mobile:'080-1234-5678',license:'æ±äº¬éƒ½çŸ¥äº‹(2)ç¬¬88001å·',rank:'Gold',rankClass:'rank-gold'},
  {id:'AG-008',name:'ä½è—¤ èŠ±å­',kana:'ã‚µãƒˆã‚¦ ãƒãƒŠã‚³',tel:'03-XXXX-0008',mobile:'080-2345-6789',license:'æ±äº¬éƒ½çŸ¥äº‹(1)ç¬¬77002å·',rank:'Platinum',rankClass:'rank-platinum'},
  {id:'AG-023',name:'éˆ´æœ¨ å¥å¤ª',kana:'ã‚¹ã‚ºã‚­ ã‚±ãƒ³ã‚¿',tel:'03-XXXX-0023',mobile:'080-3456-7890',license:'æ±äº¬éƒ½çŸ¥äº‹(2)ç¬¬99003å·',rank:'Silver',rankClass:'rank-silver'},
  {id:'AG-041',name:'æ¸¡è¾º éš†',kana:'ãƒ¯ã‚¿ãƒŠãƒ™ ã‚¿ã‚«ã‚·',tel:'03-XXXX-0041',mobile:'080-4567-8901',license:'æ±äº¬éƒ½çŸ¥äº‹(1)ç¬¬66004å·',rank:'Bronze',rankClass:'rank-bronze'},
];

const RANK_COLORS = {
  Gold:'background:rgba(201,168,76,.15);color:#c9a84c',
  Platinum:'background:rgba(200,200,255,.12);color:#b0c4de',
  Silver:'background:rgba(160,160,160,.15);color:#c0c0c0',
  Bronze:'background:rgba(180,120,60,.15);color:#cd7f32'
};

// â”€â”€ é¡§å®¢DBï¼ˆå†…è¦‹å±¥æ­´ã¤ãï¼‰â”€â”€
const CUSTOMERS_DB = [
  {id:'CL-00001',name:'å±±ç”° å¤ªéƒ',kana:'ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦',tel:'080-1111-1111',
   history:[
     {id:'NK-001',prop:'æ± è¢‹ 1K ä»®ç§°ãƒ©ã‚¤ã‚ªãƒ³ã‚ºãƒãƒ³ã‚·ãƒ§ãƒ³',date:'2026-02-10',hour:'14',min:'00',mgmt:'æ ªå¼ä¼šç¤¾ãƒ©ã‚¤ã‚ªãƒ³ã‚º',agent:'å±±ç”° èª ',status:'done',result:'æ°—ã«å…¥ã£ãŸã€€â†’ ç”³ã—è¾¼ã¿ã¸'},
     {id:'NK-002',prop:'æ± è¢‹ 1LDK ã‚¢ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒˆ',date:'2026-02-18',hour:'11',min:'00',mgmt:'ã‚½ãƒ•ã‚£ã‚¢ç®¡ç†æ ªå¼ä¼šç¤¾',agent:'å±±ç”° èª ',status:'done',result:'æ¡ä»¶åˆã‚ãš'},
     {id:'NK-003',prop:'æ±æ± è¢‹ 2LDK ã‚°ãƒ©ãƒ³ãƒ‰ãƒ‘ãƒ¬ã‚¹',date:'2026-02-25',hour:'15',min:'00',mgmt:'æ±äº¬ç®¡ç†æ ªå¼ä¼šç¤¾',agent:'å±±ç”° èª ',status:'scheduled',result:'â€”'},
   ]},
  {id:'CL-00012',name:'ä½è—¤ èŠ±å­',kana:'ã‚µãƒˆã‚¦ ãƒãƒŠã‚³',tel:'080-2222-2222',
   history:[
     {id:'NK-004',prop:'æ–°å®¿ 1LDK ã‚ªãƒ¼ã‚·ãƒ£ãƒ³ãƒ“ãƒ¥ãƒ¼',date:'2026-02-15',hour:'13',min:'30',mgmt:'æ–°å®¿ä¸å‹•ç”£ç®¡ç†',agent:'ä½è—¤ èŠ±å­',status:'done',result:'ç”³ã—è¾¼ã¿æ¤œè¨ä¸­'},
   ]},
  {id:'CL-00023',name:'éˆ´æœ¨ å¥ä¸€',kana:'ã‚¹ã‚ºã‚­ ã‚±ãƒ³ã‚¤ãƒ',tel:'090-3333-3333',
   history:[
     {id:'NK-005',prop:'æ¸‹è°· æˆ¸å»ºã¦ 3LDK',date:'2026-02-20',hour:'10',min:'00',mgmt:'æ¸‹è°·ãƒ›ãƒ¼ãƒ ã‚ºæ ªå¼ä¼šç¤¾',agent:'ä½è—¤ èŠ±å­',status:'done',result:'è³¼å…¥æ„å‘ã‚ã‚Šã€€â†’ äº¤æ¸‰ä¸­'},
     {id:'NK-006',prop:'ä»£ã€…æœ¨ ãƒãƒ³ã‚·ãƒ§ãƒ³ 2LDK',date:'2026-03-01',hour:'14',min:'00',mgmt:'ä»£ã€…æœ¨ä¸å‹•ç”£',agent:'ä½è—¤ èŠ±å­',status:'scheduled',result:'â€”'},
   ]},
  {id:'CL-00047',name:'ç”°ä¸­ ç¾å’²',kana:'ã‚¿ãƒŠã‚« ãƒŸã‚µã‚­',tel:'080-4444-4444',
   history:[]},
];

const CUSTOMER_MAP = {
  'CL-00001':'å±±ç”° å¤ªéƒ','CL-00012':'ä½è—¤ èŠ±å­',
  'CL-00023':'éˆ´æœ¨ å¥ä¸€','CL-00047':'ç”°ä¸­ ç¾å’²'
};

// selectedAgent ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰åˆæœŸåŒ–ï¼ˆsession load ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ï¼‰
let selectedAgent = { id:'â€”', name:'â€”', tel:'â€”', mobile:'â€”', license:'â€”' };
let dbFilter_current = 'all';

// â”€â”€ ã‚¿ãƒ–åˆ‡æ›¿ â”€â”€
function switchTab(i){
  document.querySelectorAll('.tab').forEach((t,j)=>t.classList.toggle('on',i===j));
  document.querySelectorAll('.page').forEach((p,j)=>p.classList.toggle('on',i===j));
  if(i===1) renderDb();
}

// renderAgentCards ã¯ä¸ä½¿ç”¨ï¼ˆsession ã‹ã‚‰è‡ªå‹•è¨­å®šï¼‰
function renderAgentCards(){ /* no-op */ }

function selectAgent(i, el){ /* no-op */ }

// â”€â”€ é¡§å®¢é¸æŠæ™‚ã®è‡ªå‹•å…¥åŠ› â”€â”€
function fillCustomerInfo(clientId, clientName){
  // autocomplete callback
  updatePreview();
}
function _fillCustomerInfo_legacy(){
  const id = document.getElementById('customer-id').value;
  const nameEl = document.getElementById('customer-name');
  if(CUSTOMER_MAP[id]){
    nameEl.value = CUSTOMER_MAP[id];
  } else if(id==='new'){
    nameEl.value = '';
    nameEl.placeholder = 'æ°åã‚’å…¥åŠ›';
  } else {
    nameEl.value = '';
    nameEl.placeholder = 'è‡ªå‹•å…¥åŠ› or æ‰‹å…¥åŠ›';
  }
  updatePreview();
}

// â”€â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–° â”€â”€
function updatePreview(){
  const mgmt  = document.getElementById('mgmt-company').value || 'ç®¡ç†ä¼šç¤¾å';
  const prop  = document.getElementById('prop-name').value    || 'ï¼ˆç‰©ä»¶åï¼‰';
  const dateV = document.getElementById('naiken-date').value;
  const hour  = document.getElementById('naiken-hour').value;
  const min   = document.getElementById('naiken-min').value;
  const custName = document.getElementById('customer-name').value;
  const channel = document.getElementById('slack-channel').value;

  // FAXãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  document.getElementById('prev-mgmt').textContent = mgmt;
  document.getElementById('prev-prop').textContent = prop;
  document.getElementById('prev-hour').textContent = hour;
  document.getElementById('prev-min').textContent  = min;

  if(dateV){
    const d = new Date(dateV);
    document.getElementById('prev-month').textContent = d.getMonth()+1;
    document.getElementById('prev-day').textContent   = d.getDate();
  } else {
    document.getElementById('prev-month').textContent = 'ã€€';
    document.getElementById('prev-day').textContent   = 'ã€€';
  }

  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆååˆº
  document.getElementById('prev-ag-name').textContent   = selectedAgent.name;
  document.getElementById('prev-ag-tel').textContent    = selectedAgent.tel;
  document.getElementById('prev-ag-mobile').textContent = selectedAgent.mobile;
  document.getElementById('prev-ag-mobile2').textContent= selectedAgent.mobile;
  document.getElementById('prev-license').textContent   = selectedAgent.license;

  // Slackãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  document.getElementById('slack-ch-label').textContent = channel;
  const dateStr = dateV ? (() => {
    const d = new Date(dateV);
    return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()]}ï¼‰`;
  })() : 'ï¼ˆæ—¥ä»˜æœªå…¥åŠ›ï¼‰';

  const place = document.getElementById('meet-place').value;
  document.getElementById('slack-text').textContent =
`ğŸ“… å†…è¦‹ãƒªãƒã‚¤ãƒ³ãƒ‰

ç‰©ä»¶ï¼š${prop}
é¡§å®¢ï¼š${custName||'ï¼ˆæœªå…¥åŠ›ï¼‰'}ã€€${document.getElementById('customer-id').value||'IDæœªè¨­å®š'}
æ‹…å½“ï¼š${selectedAgent.name}ï¼ˆ${selectedAgent.id}ï¼‰

æ—¥æ™‚ï¼š${dateStr} ${hour}:${min}ã€œ${place ? '\nå ´æ‰€ï¼š'+place : ''}
é€ä»˜å…ˆï¼š${mgmt}

âœ… å†…è¦‹ä¾é ¼æ›¸ã¯FAXæ¸ˆã¿
ğŸ“± æ‹…å½“è€…æºå¸¯ï¼š${selectedAgent.mobile}`;
}

// â”€â”€ FAXæ›¸é¡ç”Ÿæˆï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆâ†’å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼‰ â”€â”€
function generateDoc(){
  const prop  = document.getElementById('prop-name').value;
  const mgmt  = document.getElementById('mgmt-company').value;
  if(!prop || !mgmt){
    alert('ç‰©ä»¶åã¨ç®¡ç†ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  // å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆFAXï¼‰
  const w = window.open('','_blank','width=800,height=1100');
  w.document.write(buildPrintHTML());
  w.document.close();
  w.onload = () => w.print();
}

function buildPrintHTML(){
  const mgmt = document.getElementById('mgmt-company').value || 'ç®¡ç†ä¼šç¤¾å';
  const prop = document.getElementById('prop-name').value || 'ç‰©ä»¶å';
  const dateV = document.getElementById('naiken-date').value;
  const hour = document.getElementById('naiken-hour').value;
  const min  = document.getElementById('naiken-min').value;
  let month='ã€€', day='ã€€';
  if(dateV){ const d=new Date(dateV); month=d.getMonth()+1; day=d.getDate(); }

  return `<!DOCTYPE html>
<html lang="ja"><head><meta charset="UTF-8">
<style>
*{box-sizing:border-box;margin:0;padding:0}
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=DM+Mono&display=swap');
body{font-family:'Noto Sans JP',sans-serif;background:#fff;color:#000;padding:20mm 18mm}
.title{font-size:22px;font-weight:700;text-align:center;border:2px solid #000;padding:8px 0;margin-bottom:24px;letter-spacing:4px}
.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px}
.to-company{font-size:18px;font-weight:700;border-bottom:2px solid #000;padding-bottom:4px;min-width:220px;display:inline-block}
.from{font-size:11px;line-height:1.8}
.field-row{display:flex;align-items:center;margin-bottom:20px;border-bottom:1.5px solid #555;padding-bottom:14px}
.field-label{font-size:14px;font-weight:700;width:80px}
.field-value{font-size:20px;font-weight:700;flex:1;padding-left:16px}
.body-text{font-size:13px;margin-bottom:8px;font-weight:500}
.note{font-size:13px;font-weight:700;margin-top:16px}
.card{border:3px solid #1a2744;margin-top:32px;display:flex;min-height:110px}
.card-left{background:#1a2744;padding:16px 20px;flex:1}
.card-name{color:#fff;font-size:30px;font-weight:700;letter-spacing:3px;margin-bottom:8px}
.card-info{color:#d0d8e8;font-size:11px;line-height:1.9}
.card-info .label{color:#c9a84c;font-size:10px}
.card-right{padding:16px 20px;display:flex;flex-direction:column;align-items:flex-end;justify-content:space-between;min-width:160px}
.card-logo{font-size:22px;color:#1a2744;font-weight:700;letter-spacing:2px;font-family:monospace}
.card-mobile{font-size:13px;font-weight:700;color:#1a2744;font-family:monospace}
.card-license{font-size:10px;color:#666;text-align:right}
</style></head><body>
<div class="title">å†…ã€€è¦‹ã€€ä¾ã€€é ¼ã€€æ›¸</div>
<div class="header">
  <div>
    <div class="to-company">${mgmt}</div>
    <div style="font-size:13px;font-weight:700;margin-top:4px">å¾¡ä¸­</div>
  </div>
  <div class="from">
    <strong>æ ªå¼ä¼šç¤¾CORETO</strong><br>
    ã€’150-0000ã€€æ±äº¬éƒ½â—‹â—‹åŒºâ—‹â—‹ 1-1-1<br>
    <strong>Telï¼š03-XXXX-XXXX</strong>ã€€<strong>Faxï¼š03-XXXX-XXXX</strong>
  </div>
</div>
<div class="field-row">
  <div class="field-label">ç‰©ä»¶å</div>
  <div class="field-value">${prop}</div>
</div>
<div class="field-row">
  <div class="field-label">æ—¥æ™‚</div>
  <div class="field-value" style="font-size:22px">${month}ã€€æœˆã€€${day}ã€€æ—¥</div>
</div>
<div class="field-row">
  <div class="field-label">æ™‚é–“</div>
  <div class="field-value" style="font-size:22px">${hour}ã€€æ™‚ã€€${min}ã€€åˆ†</div>
</div>
<p class="body-text">ä¸Šè¨˜ç‰©ä»¶ã‚’å†…è¦‹ã•ã›ã¦é ‚ãã¾ã™ã€‚</p>
<p class="body-text">å®œã—ããŠé¡˜ã„è‡´ã—ã¾ã™ã€‚</p>
<p class="note">â€»ã€€ä¸‹è¨˜æºå¸¯ã¾ã§ã”é€£çµ¡ä¸‹ã•ã„</p>
<div class="card">
  <div class="card-left">
    <div class="card-name">${selectedAgent.name}</div>
    <div class="card-info">
      <div>æ ªå¼ä¼šç¤¾CORETO</div>
      <div>ã€’150-0000ã€€æ±äº¬éƒ½â—‹â—‹åŒºâ—‹â—‹ 1-1-1</div>
      <div><span class="label">Telï¼š</span>${selectedAgent.tel}</div>
      <div><span class="label">Faxï¼š</span>03-XXXX-XXXX</div>
      <div><span class="label" style="color:#f59e0b">æºå¸¯ï¼š</span><strong style="color:#f0c040;font-size:13px">${selectedAgent.mobile}</strong></div>
    </div>
  </div>
  <div class="card-right">
    <div class="card-logo">CORETO</div>
    <div>
      <div class="card-mobile">${selectedAgent.mobile}</div>
      <div class="card-license">${selectedAgent.license}</div>
    </div>
  </div>
</div>
</body></html>`;
}

// â”€â”€ PDFä¿å­˜ï¼ˆã‚µãƒ³ãƒ—ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰â”€â”€
function downloadPDF(){
  generateDoc(); // å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‹ã‚‰ã€ŒPDFã¨ã—ã¦ä¿å­˜ã€ã‚’æ¡ˆå†…
  setTimeout(()=>alert('å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ãã¾ã™ã€‚\né€ä¿¡å…ˆã§ã€ŒPDFã¨ã—ã¦ä¿å­˜ã€ã‚’é¸æŠã™ã‚‹ã¨PDFä¿å­˜ã§ãã¾ã™ã€‚'),200);
}

// â”€â”€ Slackãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®š â”€â”€
function sendSlack(){
  const prop = document.getElementById('prop-name').value;
  const dateV = document.getElementById('naiken-date').value;
  const custId = document.getElementById('customer-id').value;
  if(!prop || !dateV){alert('ç‰©ä»¶åã¨å†…è¦‹æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const channel = document.getElementById('slack-channel').value;
  alert(`âœ… Slackãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸï¼

ãƒãƒ£ãƒ³ãƒãƒ«ï¼š${channel}
ç‰©ä»¶ï¼š${prop}
é¡§å®¢ï¼š${CUSTOMER_MAP[custId]||'æœªç™»éŒ²'} (${custId||'â€”'})
æ‹…å½“ï¼š${selectedAgent.name}

ğŸ“… é€ä¿¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼š
  ãƒ»å‰æ—¥ 09:00
  ãƒ»å½“æ—¥ 08:00

ZapierçµŒç”±ã§Kintoneã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚`);
}

// â”€â”€ é¡§å®¢DBã«å†…è¦‹å±¥æ­´ä¿å­˜ â”€â”€
function saveToDb(){
  const custId = document.getElementById('customer-id').value;
  const prop   = document.getElementById('prop-name').value;
  const dateV  = document.getElementById('naiken-date').value;
  const mgmt   = document.getElementById('mgmt-company').value;
  if(!custId || custId==='new'){alert('é¡§å®¢IDã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  if(!prop || !dateV){alert('ç‰©ä»¶åã¨å†…è¦‹æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  const customer = CUSTOMERS_DB.find(c=>c.id===custId);
  if(customer){
    const hour = document.getElementById('naiken-hour').value;
    const min  = document.getElementById('naiken-min').value;
    const newId = 'NK-'+(100+Math.floor(Math.random()*900));
    customer.history.push({
      id:newId, prop, date:dateV, hour, min,
      mgmt:mgmt||'â€”', agent:selectedAgent.name,
      status:'scheduled', result:'â€”'
    });
    alert(`âœ… é¡§å®¢DBï¼ˆ${custId}ï¼‰ã«å†…è¦‹å±¥æ­´ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\nå±¥æ­´IDï¼š${newId}\nç‰©ä»¶ï¼š${prop}\næ—¥æ™‚ï¼š${dateV} ${hour}:${min}\næ‹…å½“ï¼š${selectedAgent.name}\n\nã€Œé¡§å®¢DBãƒ»å†…è¦‹å±¥æ­´ã€ã‚¿ãƒ–ã§ç¢ºèªã§ãã¾ã™ã€‚`);
  }
}

// â”€â”€ é¡§å®¢DBãƒ¬ãƒ³ãƒ€ãƒ¼ â”€â”€
let selectedCustomer = null;
function renderDb(){
  const list = document.getElementById('db-list');
  let filtered = CUSTOMERS_DB.filter(c=>{
    if(dbFilter_current==='scheduled') return c.history.some(h=>h.status==='scheduled');
    if(dbFilter_current==='done') return c.history.some(h=>h.status==='done');
    return true;
  });
  document.getElementById('db-count').textContent = filtered.length+'åè¡¨ç¤ºä¸­';
  list.innerHTML = filtered.map(c=>{
    const scheduled = c.history.filter(h=>h.status==='scheduled');
    const done      = c.history.filter(h=>h.status==='done');
    return `
    <div class="customer-card${selectedCustomer===c.id?' selected':''}" onclick="selectCustomer('${c.id}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="cc-name">${escHtml(c.name)}</div>
          <div class="cc-id">${c.id}</div>
        </div>
        <div style="text-align:right">
          <span class="status-badge s-scheduled" style="margin-right:4px">äºˆå®š ${scheduled.length}ä»¶</span>
          <span class="status-badge s-done">å®Œäº† ${done.length}ä»¶</span>
        </div>
      </div>
      ${c.history.length>0 ? `
      <div class="cc-history">
        ${c.history.slice(-2).map(h=>`
        <div class="history-item">
          <div class="hi-prop">ğŸ  ${h.prop}</div>
          <div class="hi-meta">
            <span class="${h.status==='scheduled'?'status-badge s-scheduled':'status-badge s-done'}">${h.status==='scheduled'?'äºˆå®š':'å®Œäº†'}</span>
            &nbsp;${h.date} ${h.hour}:${h.min}&nbsp;ãƒ»&nbsp;æ‹…å½“ï¼š${h.agent}
            ${h.result!=='â€”'?`<br>çµæœï¼š${h.result}`:''}
          </div>
        </div>`).join('')}
        ${c.history.length>2?`<div style="font-size:10px;color:var(--muted);text-align:center;padding:4px">ä»– ${c.history.length-2}ä»¶</div>`:''}
      </div>` : '<div style="font-size:11px;color:var(--muted);margin-top:8px">å†…è¦‹å±¥æ­´ãªã—</div>'}
    </div>`;
  }).join('');
}

function selectCustomer(id){
  selectedCustomer = id;
  const c = CUSTOMERS_DB.find(x=>x.id===id);
  if(!c) return;
  renderDb();

  const histHtml = c.history.length===0
    ? '<div class="empty">å†…è¦‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“<br><small>å†…è¦‹ä¾é ¼æ›¸ã‚¿ãƒ–ã‹ã‚‰ç™»éŒ²ã§ãã¾ã™</small></div>'
    : c.history.map(h=>`
      <div class="history-item" style="margin-bottom:8px;background:var(--card2);border:1px solid var(--border);border-radius:9px;padding:12px">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span class="badge" style="font-size:9px;background:rgba(59,130,246,.15);color:var(--blue);font-family:'DM Mono',monospace">${h.id}</span>
          <span class="${h.status==='scheduled'?'status-badge s-scheduled':h.status==='done'?'status-badge s-done':'status-badge s-cancelled'}">${h.status==='scheduled'?'äºˆå®š':h.status==='done'?'å®Œäº†':'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}</span>
        </div>
        <div style="font-size:13px;font-weight:700;margin-bottom:4px">ğŸ  ${h.prop}</div>
        <div style="font-size:10px;color:var(--sub);line-height:1.8">
          ğŸ“… ${h.date} ${h.hour}:${h.min}<br>
          ğŸ¢ ç®¡ç†ä¼šç¤¾ï¼š${h.mgmt}<br>
          ğŸ‘¤ æ‹…å½“AGï¼š${h.agent}
          ${h.result!=='â€”'?`<br>ğŸ“ ${h.result}`:''}
        </div>
        ${h.status==='scheduled'?`
        <div style="margin-top:8px;display:flex;gap:6px">
          <button class="btn btn-green btn-sm" onclick="markDone('${c.id}','${h.id}')">âœ… å®Œäº†</button>
          <button class="btn btn-muted btn-sm" onclick="addResult('${c.id}','${h.id}')">ğŸ“ çµæœã‚’è¨˜éŒ²</button>
          <button class="btn btn-sm" style="color:var(--orange);border:1px solid rgba(245,158,11,.3);background:transparent" onclick="reissue('${h}')">ğŸ“„ ä¾é ¼æ›¸å†ç™ºè¡Œ</button>
        </div>`:``}
      </div>`).join('');

  document.getElementById('db-detail').innerHTML = `
  <div class="panel">
    <div class="panel-title">${escHtml(c.name)} ã®å†…è¦‹å±¥æ­´</div>
    <div style="font-size:11px;color:var(--sub);margin-bottom:14px">
      ${c.id} ãƒ» ${c.tel}<br>
      å†…è¦‹åˆè¨ˆï¼š${c.history.length}ä»¶
      ï¼ˆäºˆå®šï¼š${c.history.filter(h=>h.status==='scheduled').length}ä»¶ /
        å®Œäº†ï¼š${c.history.filter(h=>h.status==='done').length}ä»¶ï¼‰
    </div>
    <button class="btn btn-gold btn-sm" onclick="switchTab(0);document.getElementById('customer-id').value='${c.id}';fillCustomerInfo()" style="margin-bottom:12px;width:100%">
      ï¼‹ ã“ã®é¡§å®¢ã®å†…è¦‹ä¾é ¼æ›¸ã‚’ä½œæˆ
    </button>
    ${histHtml}
  </div>`;
}

function dbFilter(btn, filter){
  document.querySelectorAll('.filter-chip').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  dbFilter_current = filter;
  renderDb();
}
function filterDb(q){
  // ç°¡æ˜“æ¤œç´¢ï¼ˆåå‰ãƒ»ç‰©ä»¶åï¼‰
  renderDb();
}

function markDone(custId, histId){
  const c = CUSTOMERS_DB.find(x=>x.id===custId);
  const h = c.history.find(x=>x.id===histId);
  if(h){ h.status='done'; selectCustomer(custId); }
}

function addResult(custId, histId){
  const result = prompt('å†…è¦‹çµæœã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\nä¾‹ï¼šæ°—ã«å…¥ã£ãŸâ†’ç”³ã—è¾¼ã¿ã¸ / æ¡ä»¶åˆã‚ãš / æ¤œè¨ä¸­');
  if(result){
    const c = CUSTOMERS_DB.find(x=>x.id===custId);
    const h = c.history.find(x=>x.id===histId);
    if(h){ h.result=result; h.status='done'; selectCustomer(custId); }
  }
}

function reissue(){
  switchTab(0);
  setTimeout(()=>alert('æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨æ—¥ç¨‹ã‚’å¤‰æ›´ã—ã¦å†ç™ºè¡Œã—ã¦ãã ã•ã„'),100);
}

// â”€â”€ åˆæœŸåŒ– â”€â”€
renderAgentCards();
updatePreview();
document.getElementById('naiken-date').value = new Date().toISOString().split('T')[0];
updatePreview();

// â”€â”€â”€ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initClientSearch(inputId, idHiddenId, nameHiddenId, dropdownId, onSelect) {
  const input = document.getElementById(inputId);
  const dropdown = document.getElementById(dropdownId);
  if (!input || !dropdown) return;

  let focusedIdx = -1;

  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    focusedIdx = -1;
    if (!q) { dropdown.style.display='none'; return; }
    const matches = CUSTOMERS_DB.filter(c =>
      c.id.toLowerCase().includes(q) ||
      c.name.toLowerCase().includes(q) ||
      (c.kana||'').toLowerCase().includes(q)
    ).slice(0, 8);
    if (!matches.length) { dropdown.style.display='none'; return; }
    dropdown.innerHTML = matches.map((c,i) =>
      `<div class="cl-option" data-idx="${i}" data-id="${c.id}" data-name="${escHtml(c.name)}"
            onmousedown="event.preventDefault()" onclick="pickClient('${inputId}','${idHiddenId}','${nameHiddenId}','${dropdownId}','${c.id}','${escHtml(c.name)}',${JSON.stringify(onSelect).replace(/"/g,'&quot;')})">
        <span class="cl-opt-id">${c.id}</span>
        <span class="cl-opt-name">${escHtml(c.name)}</span>
        <span class="cl-opt-kana">${c.kana||''}</span>
      </div>`
    ).join('') + `<div class="cl-new-hint">ä¸€è‡´ã—ãªã„å ´åˆã¯ãã®ã¾ã¾å…¥åŠ›ã—ã¦ãã ã•ã„</div>`;
    dropdown.style.display = 'block';
  });

  input.addEventListener('keydown', e => {
    const opts = dropdown.querySelectorAll('.cl-option');
    if (!opts.length || dropdown.style.display==='none') return;
    if (e.key==='ArrowDown') { focusedIdx=Math.min(focusedIdx+1,opts.length-1); highlight(opts); e.preventDefault(); }
    else if (e.key==='ArrowUp') { focusedIdx=Math.max(focusedIdx-1,0); highlight(opts); e.preventDefault(); }
    else if (e.key==='Enter' && focusedIdx>=0) { opts[focusedIdx].click(); e.preventDefault(); }
    else if (e.key==='Escape') { dropdown.style.display='none'; }
  });

  input.addEventListener('blur', () => { setTimeout(()=>{ dropdown.style.display='none'; }, 150); });
  input.addEventListener('focus', () => { if(input.value.trim()) input.dispatchEvent(new Event('input')); });

  function highlight(opts) {
    opts.forEach((o,i) => o.classList.toggle('focused', i===focusedIdx));
    if(focusedIdx>=0) opts[focusedIdx].scrollIntoView({block:'nearest'});
  }
}

function pickClient(inputId, idHiddenId, nameHiddenId, dropdownId, clientId, clientName, callbackName) {
  const input = document.getElementById(inputId);
  const dropdown = document.getElementById(dropdownId);
  if(input) input.value = clientId + ' / ' + clientName;
  if(idHiddenId && document.getElementById(idHiddenId)) document.getElementById(idHiddenId).value = clientId;
  if(nameHiddenId && document.getElementById(nameHiddenId)) document.getElementById(nameHiddenId).value = clientName;
  if(dropdown) dropdown.style.display = 'none';
  // callback
  if(callbackName && typeof window[callbackName]==='function') window[callbackName](clientId, clientName);
}


// â”€â”€ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¤œç´¢åˆæœŸåŒ– â”€â”€
document.addEventListener('DOMContentLoaded', function() {
  initClientSearch('client-search', 'customer-id', 'customer-name', 'client-dropdown', 'fillCustomerInfo');
});
</script>
</body>
</html>
