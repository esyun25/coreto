<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ITé‡èª¬ æ—¥ç¨‹äºˆç´„ | CORETO</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0d12;--card:#141820;--card2:#191e28;--border:#1e2435;--border2:#252c3d;
  --text:#e4e7f0;--sub:#7a82a0;--muted:#3e4565;
  --gold:#c9a840;--gold2:#e0bc5a;--green:#34d399;--blue:#4f9cf9;
  --red:#f87171;--orange:#fb923c;--purple:#a78bfa;
}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;padding:24px 16px}
.logo{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--gold);letter-spacing:4px;margin-bottom:4px;text-align:center}
.logo-sub{font-size:11px;color:var(--muted);text-align:center;margin-bottom:24px}
.container{width:100%;max-width:560px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:14px}
.card-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:800;color:var(--gold);margin-bottom:12px}
.info-row{display:flex;font-size:11px;line-height:2;gap:8px}
.info-lbl{color:var(--muted);width:68px;flex-shrink:0}
.info-val{color:var(--text);font-weight:500}
/* Slot list */
.slot-item{display:flex;align-items:center;gap:10px;padding:11px 13px;
  border:1.5px solid var(--border2);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:.12s}
.slot-item:hover{border-color:rgba(201,168,64,.4);background:rgba(201,168,64,.04)}
.slot-item.selected{border-color:var(--gold);background:rgba(201,168,64,.08)}
.slot-item.priority{border-color:rgba(167,139,250,.5);background:rgba(167,139,250,.04)}
.slot-item.priority:hover{border-color:rgba(167,139,250,.7);background:rgba(167,139,250,.08)}
.slot-item.priority.selected{border-color:var(--purple);background:rgba(167,139,250,.12)}
.radio{width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);flex-shrink:0;transition:.12s}
.slot-item.selected .radio{border-color:var(--gold);background:var(--gold);box-shadow:0 0 0 2px rgba(201,168,64,.25)}
.slot-item.priority.selected .radio{border-color:var(--purple);background:var(--purple)}
.slot-date{font-size:11px;color:var(--sub);margin-bottom:1px}
.slot-time{font-size:14px;font-weight:800;font-family:'DM Mono',monospace}
.slot-dur{font-size:10px;color:var(--muted)}
.slot-agent{font-size:10px;color:var(--sub);text-align:right;flex:1}
.priority-badge{font-size:8px;padding:1px 6px;border-radius:8px;background:rgba(167,139,250,.15);
  color:var(--purple);font-weight:700;display:block;margin-top:2px}
.no-slots{font-size:12px;color:var(--muted);text-align:center;padding:28px;border:1px dashed var(--border2);border-radius:10px}
/* Confirm / change buttons */
.btn{width:100%;padding:13px;border-radius:12px;font-family:inherit;font-size:13px;font-weight:800;
  border:none;cursor:pointer;transition:.12s}
.btn:disabled{opacity:.35;cursor:default}
.btn-gold{background:linear-gradient(135deg,#c9a840,#e0bc5a);color:#0b0d12}
.btn-ghost{background:transparent;border:1.5px solid var(--border2);color:var(--sub)}
.btn-ghost:hover:not(:disabled){border-color:var(--border);color:var(--text)}
.btn-red{background:rgba(248,113,113,.1);border:1.5px solid rgba(248,113,113,.3);color:var(--red)}
.btn-red:hover:not(:disabled){background:rgba(248,113,113,.18)}
.btn-sm{padding:7px 14px;border-radius:8px;font-size:11px;width:auto}
.btns{display:flex;flex-direction:column;gap:8px;margin-top:12px}
/* Current booking panel */
.booking-info{background:rgba(201,168,64,.06);border:1px solid rgba(201,168,64,.2);
  border-radius:10px;padding:14px;margin-bottom:12px}
.booking-date{font-size:16px;font-weight:800;color:var(--gold2);margin-bottom:6px}
.meet-link{display:inline-flex;align-items:center;gap:6px;margin-top:8px;padding:9px 14px;
  background:rgba(79,156,249,.1);border:1px solid rgba(79,156,249,.3);border-radius:8px;
  color:var(--blue);text-decoration:none;font-size:11px;font-weight:700}
/* Change counter */
.change-info{font-size:10px;color:var(--muted);margin-top:6px;display:flex;align-items:center;gap:6px}
.change-dot{width:6px;height:6px;border-radius:50%}
/* Success */
.success-icon{font-size:40px;text-align:center;margin-bottom:10px}
.success-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;text-align:center;margin-bottom:8px}
/* Warning */
.warn-box{background:rgba(251,146,60,.07);border:1px solid rgba(251,146,60,.25);
  border-radius:8px;padding:10px 12px;font-size:11px;color:var(--orange);margin-top:8px;line-height:1.8}
/* History */
.hist-item{font-size:10px;color:var(--muted);padding:5px 0;border-bottom:1px solid var(--border);line-height:1.7}
</style>
</head>
<body>
<div class="logo">CORETO</div>
<div class="logo-sub">ITé‡èª¬ æ—¥ç¨‹äºˆç´„</div>
<div class="container" id="app"></div>

<script>
// â”€â”€ Keys â”€â”€
var SLOTS_KEY    = 'coreto_itsetsu_slots';
var BOOKINGS_KEY = 'coreto_itsetsu_bookings';
function loadSlots()    { try{return JSON.parse(localStorage.getItem(SLOTS_KEY)||'[]');}catch(e){return[];} }
function saveSlots(s)   { localStorage.setItem(SLOTS_KEY, JSON.stringify(s)); }
function loadBookings() { try{return JSON.parse(localStorage.getItem(BOOKINGS_KEY)||'[]');}catch(e){return[];} }
function saveBookings(b){ localStorage.setItem(BOOKINGS_KEY, JSON.stringify(b)); }

// â”€â”€ URL params â”€â”€
var P = new URLSearchParams(location.search);
var caseId   = P.get('caseId')   || '';
var clientN  = decodeURIComponent(P.get('client')  || '');
var propName = decodeURIComponent(P.get('prop')    || '');
var agentN   = decodeURIComponent(P.get('agent')   || '');
var agentId  = P.get('agentId')  || '';
var dedicatedId = P.get('dedicatedId') || agentId; // å°‚ä»»å®…å»ºå£«ID

var WD = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
function fmtDate(ds){
  var d = new Date(ds+'T00:00:00');
  return (d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥ï¼ˆ'+WD[d.getDay()]+'ï¼‰';
}
function fmtDt(ds, st){
  return fmtDate(ds) + ' ' + st;
}
function genMeet(){
  var c='abcdefghijklmnopqrstuvwxyz';
  var rnd=function(n){return Array.from({length:n},function(){return c[Math.floor(Math.random()*c.length)];}).join('');};
  return 'https://meet.google.com/'+rnd(3)+'-'+rnd(4)+'-'+rnd(3);
}

// â”€â”€ 24h rules â”€â”€
function minsUntil(date, start) {
  return (new Date(date+'T'+start+':00') - new Date()) / 60000;
}
function canClientChange(bk) {
  if (!bk || bk.status === 'cancelled') return false;
  var mins = minsUntil(bk.date, bk.start);
  if (mins <= 0) return false;           // past
  if (mins > 24*60) return true;         // >24h: free
  return (bk.changeCount || 0) < 2;     // â‰¤24h: max 2
}
function canClientCancel(bk) {
  if (!bk || bk.status === 'cancelled') return false;
  var mins = minsUntil(bk.date, bk.start);
  if (mins <= 0) return false;
  if (mins <= 24*60) return false; // within 24h: client cannot cancel
  // Check alternative agents available at same time
  var slots = loadSlots();
  return slots.some(function(s){
    return s.id !== bk.slotId && s.date === bk.date &&
           s.start === bk.start && s.status === 'open';
  });
}
function changeLabel(bk) {
  var mins = minsUntil(bk.date, bk.start);
  if (mins > 24*60) return { text:'å¤‰æ›´è‡ªç”±ï¼ˆ24æ™‚é–“ä»¥ä¸Šå‰ï¼‰', color:'var(--green)' };
  var remaining = 2 - (bk.changeCount || 0);
  if (remaining <= 0) return { text:'å¤‰æ›´å›æ•°ä¸Šé™ã«é”ã—ã¾ã—ãŸï¼ˆæœ¬éƒ¨ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ï¼‰', color:'var(--red)' };
  return { text:'æ®‹ã‚Šå¤‰æ›´å¯èƒ½å›æ•°: '+remaining+'å›ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰', color:'var(--orange)' };
}

// â”€â”€ Slot priority sort â”€â”€
function sortedAvailableSlots() {
  var now = new Date();
  var slots = loadSlots().filter(function(s){
    return s.status === 'open' && new Date(s.date+'T'+s.start+':00') > now;
  });
  slots.sort(function(a, b){
    var aP = (a.agentId === dedicatedId) ? 0 : 1;
    var bP = (b.agentId === dedicatedId) ? 0 : 1;
    if (aP !== bP) return aP - bP;
    return (a.date+a.start).localeCompare(b.date+b.start);
  });
  return slots;
}

// â”€â”€ State â”€â”€
var selectedSlotId = null;
var mode = 'initial'; // 'initial' | 'booking' | 'changing' | 'existing'

// â”€â”€ Render â”€â”€
function render() {
  var app = document.getElementById('app');
  if (!caseId) {
    app.innerHTML = '<div class="card" style="text-align:center;padding:32px"><div style="font-size:32px;margin-bottom:12px">âš ï¸</div><div style="font-size:12px;color:var(--muted)">ç„¡åŠ¹ãªãƒªãƒ³ã‚¯ã§ã™ã€‚<br>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”é€£çµ¡ãã ã•ã„ã€‚</div></div>';
    return;
  }
  var bookings = loadBookings();
  var existing = bookings.find(function(b){ return b.caseId === caseId && b.status !== 'cancelled'; });
  if (existing) {
    renderExisting(existing);
  } else {
    renderNew();
  }
}

function caseInfoHtml() {
  var rows = [];
  if (clientN)  rows.push('<div class="info-row"><span class="info-lbl">ãŠåå‰</span><span class="info-val">'+clientN+' æ§˜</span></div>');
  if (propName) rows.push('<div class="info-row"><span class="info-lbl">ç‰©ä»¶</span><span class="info-val">'+propName+'</span></div>');
  if (agentN)   rows.push('<div class="info-row"><span class="info-lbl">æ‹…å½“</span><span class="info-val">'+agentN+'</span></div>');
  return rows.join('');
}

function renderNew() {
  var slots = sortedAvailableSlots();
  var app = document.getElementById('app');
  var slotsHtml = '';
  if (!slots.length) {
    slotsHtml = '<div class="no-slots">ğŸ˜” ç¾åœ¨ã€ç©ºãæ—¥ç¨‹ãŒã”ã–ã„ã¾ã›ã‚“ã€‚<br>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”é€£çµ¡ãã ã•ã„ã€‚</div>';
  } else {
    slotsHtml = slots.map(function(s){
      var isPriority = (s.agentId === dedicatedId);
      var cls = 'slot-item' + (isPriority ? ' priority' : '') + (s.id === selectedSlotId ? ' selected' : '');
      return '<div class="'+cls+'" onclick="selSlot(\''+s.id+'\',this)">'
        +'<div class="radio"></div>'
        +'<div style="min-width:60px"><div class="slot-date">'+fmtDate(s.date)+'</div>'
        +'<div class="slot-time">'+s.start+'</div>'
        +'<div class="slot-dur">'+fmtDur(s.dur)+'</div></div>'
        +'<div class="slot-agent">'+s.agentName
        +(isPriority ? '<span class="priority-badge">å°‚ä»»æ‹…å½“</span>' : '')
        +'</div></div>';
    }).join('');
  }
  app.innerHTML = '<div class="card"><div class="card-title">ğŸ“‹ æ¡ˆä»¶æƒ…å ±</div>'+caseInfoHtml()
    +'<div style="margin-top:10px;padding:9px 11px;background:var(--card2);border-radius:7px;font-size:10px;color:var(--sub);line-height:1.9">'
    +'éƒ½åˆã®ã‚ˆã„æ—¥ç¨‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚é¸æŠå¾Œã€æ‹…å½“ã‹ã‚‰Google Meetã®URLã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚</div></div>'
    +'<div class="card"><div class="card-title">ğŸ—“ æ—¥ç¨‹ã‚’é¸æŠ</div>'
    +(dedicatedId ? '<div style="font-size:10px;color:var(--purple);margin-bottom:10px">ğŸ”® å°‚ä»»æ‹…å½“ã®ç©ºãæ ã‚’å„ªå…ˆè¡¨ç¤ºã—ã¦ã„ã¾ã™</div>' : '')
    +'<div id="slot-list">'+slotsHtml+'</div>'
    +'<div class="btns"><button class="btn btn-gold" id="confirm-btn" onclick="doBook()" disabled>ã“ã®æ—¥ç¨‹ã§äºˆç´„ã™ã‚‹</button></div></div>';
}

function renderExisting(bk) {
  var app = document.getElementById('app');
  var d = new Date(bk.date+'T00:00:00');
  var label = fmtDate(bk.date) + ' ' + bk.start + 'ã€œï¼ˆ'+fmtDur(bk.dur)+'ï¼‰';
  var cl = changeLabel(bk);
  var canChange = canClientChange(bk);
  var canCancel = canClientCancel(bk);
  var hist = (bk.changeHistory||[]).map(function(h){
    return '<div class="hist-item">'+h.changedAt.slice(0,16).replace('T',' ')+' ï½œ '+fmtDt(h.from.date,h.from.start)+' â†’ '+fmtDt(h.to.date,h.to.start)+'</div>';
  }).join('');
  app.innerHTML = '<div class="card"><div class="card-title">ğŸ“‹ æ¡ˆä»¶æƒ…å ±</div>'+caseInfoHtml()+'</div>'
    +'<div class="card"><div class="card-title">âœ… äºˆç´„æ¸ˆã¿æ—¥ç¨‹</div>'
    +'<div class="booking-info"><div class="booking-date">'+label+'</div>'
    +'<div style="font-size:11px;color:var(--sub)">é‡èª¬æ‹…å½“ï¼š'+bk.itAgentName+'</div>'
    +(bk.meetUrl ? '<a class="meet-link" href="'+bk.meetUrl+'" target="_blank">ğŸ¥ Google Meet ã«å‚åŠ ã™ã‚‹</a>' : '')
    +'</div>'
    +'<div class="change-info"><div class="change-dot" style="background:'+cl.color+'"></div><span style="color:'+cl.color+'">'+cl.text+'</span></div>'
    +'<div class="btns">'
    +(canChange ? '<button class="btn btn-ghost" onclick="startChange()">ğŸ“… æ—¥ç¨‹ã‚’å¤‰æ›´ã™ã‚‹</button>' : '')
    +(canCancel ? '<button class="btn btn-red btn-ghost" style="margin-top:4px" onclick="doCancel()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆä»–ã®æ‹…å½“è€…ã«å¤‰æ›´ï¼‰</button>' : '')
    +'</div>'
    +(hist ? '<div style="margin-top:14px"><div style="font-size:10px;color:var(--muted);margin-bottom:6px">å¤‰æ›´å±¥æ­´</div>'+hist+'</div>' : '')
    +'</div>';
}

function renderChange(bk) {
  var slots = sortedAvailableSlots().filter(function(s){ return !(s.date===bk.date && s.start===bk.start); });
  var slotsHtml = '';
  if (!slots.length) {
    slotsHtml = '<div class="no-slots">ğŸ˜” å¤‰æ›´å¯èƒ½ãªç©ºãæ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”é€£çµ¡ãã ã•ã„ã€‚</div>';
  } else {
    slotsHtml = slots.map(function(s){
      var isPriority = (s.agentId === dedicatedId);
      var cls = 'slot-item'+(isPriority?' priority':'')+(s.id===selectedSlotId?' selected':'');
      return '<div class="'+cls+'" onclick="selSlot(\''+s.id+'\',this)">'
        +'<div class="radio"></div>'
        +'<div style="min-width:60px"><div class="slot-date">'+fmtDate(s.date)+'</div>'
        +'<div class="slot-time">'+s.start+'</div>'
        +'<div class="slot-dur">'+fmtDur(s.dur)+'</div></div>'
        +'<div class="slot-agent">'+s.agentName+(isPriority?'<span class="priority-badge">å°‚ä»»æ‹…å½“</span>':'')+'</div></div>';
    }).join('');
  }
  var mins = minsUntil(bk.date, bk.start);
  app.innerHTML = '<div class="card"><div class="card-title">ğŸ“… æ—¥ç¨‹ã‚’å¤‰æ›´ã™ã‚‹</div>'
    +(mins<=24*60 ? '<div class="warn-box">âš ï¸ 24æ™‚é–“ä»¥å†…ã®å¤‰æ›´ã§ã™ã€‚æ®‹ã‚Šå¤‰æ›´å¯èƒ½å›æ•°: '+(2-(bk.changeCount||0))+'å›</div>' : '')
    +'<div style="margin-top:10px" id="slot-list">'+slotsHtml+'</div>'
    +'<div class="btns"><button class="btn btn-gold" id="confirm-btn" onclick="doChange()" disabled>ã“ã®æ—¥ç¨‹ã«å¤‰æ›´ã™ã‚‹</button>'
    +'<button class="btn btn-ghost" onclick="render()" style="margin-top:4px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>';
}

var app = document.getElementById('app');
function selSlot(id, el) {
  selectedSlotId = id;
  document.querySelectorAll('.slot-item').forEach(function(e){ e.classList.remove('selected'); });
  el.classList.add('selected');
  var btn = document.getElementById('confirm-btn');
  if (btn) btn.disabled = false;
}

function startChange() {
  var bookings = loadBookings();
  var bk = bookings.find(function(b){ return b.caseId===caseId && b.status!=='cancelled'; });
  if (!bk || !canClientChange(bk)) { alert('ç¾åœ¨ã€å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚'); return; }
  selectedSlotId = null;
  renderChange(bk);
}

function doBook() {
  if (!selectedSlotId) return;
  var slots = loadSlots();
  var slot  = slots.find(function(s){ return s.id===selectedSlotId; });
  if (!slot || slot.status==='booked') { alert('ã“ã®æ—¥ç¨‹ã¯ã™ã§ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®æ—¥ç¨‹ã‚’ãŠé¸ã³ãã ã•ã„ã€‚'); selectedSlotId=null; renderNew(); return; }
  var meetUrl = genMeet();
  slot.status     = 'booked';
  slot.bookedCase = caseId;
  slot.bookedClient = clientN;
  slot.meetUrl    = meetUrl;
  slot.bookedAt   = new Date().toISOString();
  saveSlots(slots);
  var bookings = loadBookings();
  var bk = {
    id: 'BK'+Date.now(),
    slotId: slot.id,
    caseId: caseId,
    clientName: clientN, propName: propName,
    agentId: agentId, agentName: agentN,
    itAgentId: slot.agentId, itAgentName: slot.agentName,
    dedicatedAgentId: dedicatedId,
    date: slot.date, start: slot.start, dur: slot.dur,
    meetUrl: meetUrl,
    bookedAt: new Date().toISOString(),
    changeCount: 0,
    changeHistory: [],
    status: 'active',
    cancelledAt: null
  };
  bookings.push(bk);
  saveBookings(bookings);
  console.log('[Slack #ITé‡èª¬æ—¥ç¨‹èª¿æ•´] äºˆç´„ç¢ºå®š\næ¡ˆä»¶:'+caseId+'\nã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ:'+clientN+'\n'+fmtDate(slot.date)+' '+slot.start+'\né‡èª¬æ‹…å½“:'+slot.agentName+'\nMeet:'+meetUrl);
  renderSuccess(bk);
}

function doChange() {
  if (!selectedSlotId) return;
  var bookings = loadBookings();
  var bkIdx = bookings.findIndex(function(b){ return b.caseId===caseId && b.status!=='cancelled'; });
  if (bkIdx<0) return;
  var bk = bookings[bkIdx];
  if (!canClientChange(bk)) { alert('å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚'); render(); return; }
  var slots = loadSlots();
  var newSlot = slots.find(function(s){ return s.id===selectedSlotId && s.status==='open'; });
  if (!newSlot) { alert('é¸æŠã—ãŸæ—¥ç¨‹ã¯ã™ã§ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚'); selectedSlotId=null; renderChange(bk); return; }
  // Release old slot
  var oldSlot = slots.find(function(s){ return s.id===bk.slotId; });
  if (oldSlot) { oldSlot.status='open'; oldSlot.bookedCase=null; oldSlot.bookedClient=null; oldSlot.meetUrl=''; oldSlot.bookedAt=null; }
  // Book new slot
  var meetUrl = genMeet();
  newSlot.status='booked'; newSlot.bookedCase=caseId; newSlot.bookedClient=clientN; newSlot.meetUrl=meetUrl; newSlot.bookedAt=new Date().toISOString();
  saveSlots(slots);
  // Determine if within 24h
  var mins = minsUntil(bk.date, bk.start);
  var hist = { from:{date:bk.date,start:bk.start,agentName:bk.itAgentName}, to:{date:newSlot.date,start:newSlot.start,agentName:newSlot.agentName}, changedAt:new Date().toISOString() };
  if (mins <= 24*60) bk.changeCount = (bk.changeCount||0)+1;
  if (!bk.changeHistory) bk.changeHistory=[];
  bk.changeHistory.push(hist);
  bk.slotId=newSlot.id; bk.date=newSlot.date; bk.start=newSlot.start; bk.dur=newSlot.dur;
  bk.itAgentId=newSlot.agentId; bk.itAgentName=newSlot.agentName; bk.meetUrl=meetUrl;
  saveBookings(bookings);
  console.log('[Slack #ITé‡èª¬æ—¥ç¨‹èª¿æ•´] æ—¥ç¨‹å¤‰æ›´\næ¡ˆä»¶:'+caseId+'\n'+fmtDate(newSlot.date)+' '+newSlot.start+'\né‡èª¬æ‹…å½“:'+newSlot.agentName+'\nMeet:'+meetUrl);
  render();
}

function doCancel() {
  var bookings = loadBookings();
  var bkIdx = bookings.findIndex(function(b){ return b.caseId===caseId && b.status!=='cancelled'; });
  if (bkIdx<0) return;
  var bk = bookings[bkIdx];
  if (!canClientCancel(bk)) { alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã¾ã›ã‚“ã€‚æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”é€£çµ¡ãã ã•ã„ã€‚'); return; }
  if (!confirm('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  // Release slot
  var slots = loadSlots();
  var slot = slots.find(function(s){ return s.id===bk.slotId; });
  if (slot) { slot.status='open'; slot.bookedCase=null; slot.bookedClient=null; slot.meetUrl=''; slot.bookedAt=null; }
  saveSlots(slots);
  bk.status='cancelled'; bk.cancelledAt=new Date().toISOString(); bk.cancelReason='client';
  saveBookings(bookings);
  var app = document.getElementById('app');
  app.innerHTML = '<div class="card" style="text-align:center;padding:24px">'
    +'<div style="font-size:32px;margin-bottom:10px">âœ…</div>'
    +'<div style="font-size:14px;font-weight:700;color:var(--green);margin-bottom:6px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ</div>'
    +'<div style="font-size:11px;color:var(--muted)">æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚<br>æ”¹ã‚ã¦æ—¥ç¨‹ã‚’é¸æŠã™ã‚‹å ´åˆã¯ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div></div>';
}

function renderSuccess(bk) {
  var app = document.getElementById('app');
  app.innerHTML = '<div class="card">'
    +'<div class="success-icon">âœ…</div>'
    +'<div class="success-title" style="color:var(--green)">äºˆç´„å®Œäº†</div>'
    +'<div class="booking-info" style="margin-top:14px">'
    +'<div class="booking-date">'+fmtDate(bk.date)+' '+bk.start+'ã€œï¼ˆ'+fmtDur(bk.dur)+'ï¼‰</div>'
    +'<div style="font-size:11px;color:var(--sub)">é‡èª¬æ‹…å½“ï¼š'+bk.itAgentName+'</div>'
    +(bk.meetUrl ? '<a class="meet-link" href="'+bk.meetUrl+'" target="_blank">ğŸ¥ Google Meet ã«å‚åŠ ã™ã‚‹</a>' : '')
    +'</div>'
    +'<div style="font-size:11px;color:var(--muted);line-height:1.9;margin-top:10px">'
    +'æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸Slackã§é€šçŸ¥ã—ã¾ã—ãŸã€‚<br>'
    +'å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯ã“ã®ãƒšãƒ¼ã‚¸ã«å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚<br>'
    +'ï¼ˆ24æ™‚é–“ä»¥å†…ã¯æœ€å¤§2å›ã¾ã§å¤‰æ›´å¯èƒ½ã§ã™ï¼‰'
    +'</div></div>';
}

function fmtDur(m){ return m<60?m+'åˆ†':Math.floor(m/60)+'æ™‚é–“'+(m%60?m%60+'åˆ†':''); }

render();
</script>
</body>
</html>
