<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ITé‡èª¬ æ—¥ç¨‹é¸æŠ | CORETO</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0d12;--card:#141820;--card2:#191e28;--border:#1e2435;--border2:#252c3d;
  --text:#e4e7f0;--sub:#7a82a0;--muted:#3e4565;
  --gold:#c9a840;--gold2:#e0bc5a;--green:#34d399;--blue:#4f9cf9;--red:#f87171;
}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;
  min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:24px 16px}

.logo{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--gold);
  letter-spacing:4px;margin-bottom:4px;text-align:center}
.logo-sub{font-size:11px;color:var(--muted);text-align:center;margin-bottom:28px}

.container{width:100%;max-width:580px}

.card{background:var(--card);border:1px solid var(--border);border-radius:14px;
  padding:22px;margin-bottom:16px}
.card-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold);
  margin-bottom:14px;display:flex;align-items:center;gap:8px}

.info-row{display:flex;gap:8px;font-size:11px;line-height:2;margin-bottom:4px}
.info-label{color:var(--muted);width:72px;flex-shrink:0}
.info-val{color:var(--text);font-weight:500}

/* æ—¥ç¨‹ã‚°ãƒªãƒƒãƒ‰ */
.date-group{margin-bottom:18px}
.date-hdr{font-size:11px;font-weight:700;color:var(--sub);margin-bottom:8px;
  padding-bottom:6px;border-bottom:1px solid var(--border)}
.slots-row{display:flex;flex-wrap:wrap;gap:8px}
.slot-btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border2);
  background:var(--card2);color:var(--text);cursor:pointer;font-family:inherit;
  font-size:12px;transition:.15s;display:flex;flex-direction:column;align-items:center;gap:2px}
.slot-btn:hover{border-color:var(--gold);background:rgba(201,168,64,.08)}
.slot-btn.selected{border-color:var(--gold);background:rgba(201,168,64,.12);color:var(--gold2)}
.slot-time{font-weight:700;font-size:13px}
.slot-dur{font-size:9px;color:var(--muted)}

.empty-msg{font-size:12px;color:var(--muted);text-align:center;padding:24px;
  background:var(--card2);border-radius:10px}

/* confirm section */
.confirm-box{background:rgba(201,168,64,.06);border:1px solid rgba(201,168,64,.25);
  border-radius:10px;padding:16px;margin-top:16px;display:none}
.confirm-box.show{display:block}
.confirm-date{font-size:16px;font-weight:800;color:var(--gold2);margin-bottom:8px}
.confirm-note{font-size:11px;color:var(--sub);line-height:1.8}

.btn-confirm{width:100%;padding:14px;border-radius:12px;background:linear-gradient(135deg,#c9a840,#e0bc5a);
  color:#0b0d12;font-family:inherit;font-size:14px;font-weight:800;border:none;cursor:pointer;
  margin-top:12px;transition:.15s}
.btn-confirm:hover{opacity:.9}
.btn-confirm:disabled{opacity:.4;cursor:default}

/* success screen */
.success{display:none;text-align:center;padding:24px}
.success.show{display:block}
.success-icon{font-size:48px;margin-bottom:12px}
.success-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--green);margin-bottom:8px}
.success-sub{font-size:12px;color:var(--sub);line-height:1.8}
.meet-link{display:inline-flex;align-items:center;gap:8px;margin-top:16px;padding:12px 20px;
  background:rgba(79,156,249,.12);border:1px solid rgba(79,156,249,.35);border-radius:10px;
  color:var(--blue);text-decoration:none;font-size:13px;font-weight:700;border-radius:10px}

/* error */
.error-screen{text-align:center;padding:40px 24px}
.error-icon{font-size:40px;margin-bottom:12px}
</style>
</head>
<body>

<div class="logo">CORETO</div>
<div class="logo-sub">ITé‡èª¬ æ—¥ç¨‹é¸æŠ</div>

<div class="container" id="app">
  <div style="text-align:center;padding:40px;color:var(--muted)">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<script>
const STORE_KEY   = 'coreto_itsetsu_slots';
const BOOKING_KEY = 'coreto_itsetsu_bookings';

function loadSlots() {
  try { return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); } catch(e) { return []; }
}
function loadBookings() {
  try { return JSON.parse(localStorage.getItem(BOOKING_KEY) || '[]'); } catch(e) { return []; }
}
function saveSlots(s)    { localStorage.setItem(STORE_KEY,    JSON.stringify(s)); }
function saveBookings(b) { localStorage.setItem(BOOKING_KEY,  JSON.stringify(b)); }

// â”€â”€ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª­ã¿å–ã‚Š â”€â”€
const params   = new URLSearchParams(location.search);
const caseId   = params.get('caseId')   || '';
const clientName = decodeURIComponent(params.get('client') || '');
const propName   = decodeURIComponent(params.get('prop')   || '');
const agentName  = decodeURIComponent(params.get('agent')  || '');
const agentId    = params.get('agentId') || '';

let selectedSlotId = null;

function render() {
  const app = document.getElementById('app');

  if (!caseId) {
    app.innerHTML = `<div class="error-screen">
      <div class="error-icon">âš ï¸</div>
      <div style="font-size:13px;color:var(--muted)">ç„¡åŠ¹ãªãƒªãƒ³ã‚¯ã§ã™ã€‚<br>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”é€£çµ¡ãã ã•ã„ã€‚</div>
    </div>`;
    return;
  }

  const slots = loadSlots()
    .filter(s => s.status === 'open' && s.date >= new Date().toISOString().slice(0,10))
    .sort((a,b) => (a.date+a.start).localeCompare(b.date+b.start));

  // Group by date
  const grouped = {};
  slots.forEach(s => {
    if (!grouped[s.date]) grouped[s.date] = [];
    grouped[s.date].push(s);
  });

  const DAYS_JP = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

  app.innerHTML = `
    <!-- æ¡ˆä»¶æƒ…å ± -->
    <div class="card">
      <div class="card-title">ğŸ“‹ ITé‡èª¬ã®ã”äºˆç´„</div>
      <div class="info-row"><span class="info-label">ãŠåå‰</span><span class="info-val">${clientName || 'â€”'} æ§˜</span></div>
      <div class="info-row"><span class="info-label">ç‰©ä»¶</span><span class="info-val">${propName || 'â€”'}</span></div>
      <div class="info-row"><span class="info-label">æ‹…å½“</span><span class="info-val">${agentName || 'â€”'}</span></div>
      <div style="margin-top:12px;padding:10px 12px;background:var(--card2);border-radius:8px;font-size:11px;color:var(--sub);line-height:1.9">
        ä»¥ä¸‹ã®ç©ºãæ™‚é–“ã‹ã‚‰éƒ½åˆã®ã‚ˆã„æ—¥ç¨‹ã‚’ãŠé¸ã³ãã ã•ã„ã€‚<br>
        é¸æŠå¾Œã€Google Meet ã®ãƒªãƒ³ã‚¯ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚
      </div>
    </div>

    <!-- æ—¥ç¨‹é¸æŠ -->
    <div class="card" id="slot-picker">
      <div class="card-title">ğŸ—“ æ—¥ç¨‹ã‚’é¸æŠ</div>
      ${Object.keys(grouped).length === 0
        ? `<div class="empty-msg">ç¾åœ¨é¸æŠã§ãã‚‹ç©ºãæ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”é€£çµ¡ãã ã•ã„ã€‚</div>`
        : Object.entries(grouped).map(([date, daySlots]) => {
            const d = new Date(date);
            const label = `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${DAYS_JP[d.getDay()]}ï¼‰`;
            return `<div class="date-group">
              <div class="date-hdr">${label}</div>
              <div class="slots-row">
                ${daySlots.map(s => `
                  <button class="slot-btn" id="slot-${s.id}" onclick="selectSlot('${s.id}')">
                    <span class="slot-time">${s.start}</span>
                    <span class="slot-dur">${s.dur}åˆ†</span>
                  </button>`).join('')}
              </div>
            </div>`;
          }).join('')
      }

      <!-- ç¢ºèª -->
      <div class="confirm-box" id="confirm-box">
        <div class="confirm-date" id="confirm-date">â€”</div>
        <div class="confirm-note">
          ãƒ»é¸æŠå¾Œã€æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨é‡èª¬æ‹…å½“è€…ã«ã”é€£çµ¡ãŒå…¥ã‚Šã¾ã™<br>
          ãƒ»Google Meet ã®URLã‚’ãƒ¡ãƒ¼ãƒ«ãƒ»Slackã§ãŠé€ã‚Šã—ã¾ã™<br>
          ãƒ»æ—¥ç¨‹å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¾ã§ã”é€£çµ¡ãã ã•ã„
        </div>
        <button class="btn-confirm" id="btn-confirm" onclick="confirmBooking()">
          ã“ã®æ—¥ç¨‹ã§äºˆç´„ã™ã‚‹
        </button>
      </div>
    </div>

    <!-- æˆåŠŸç”»é¢ï¼ˆéè¡¨ç¤ºï¼‰ -->
    <div class="success card" id="success-box">
      <div class="success-icon">âœ…</div>
      <div class="success-title">äºˆç´„å®Œäº†</div>
      <div class="success-sub" id="success-detail">â€”</div>
      <a class="meet-link" id="meet-link" href="#" target="_blank">ğŸ¥ Google Meet ã«å‚åŠ ã™ã‚‹</a>
    </div>
  `;
}

function selectSlot(slotId) {
  selectedSlotId = slotId;
  // Update button states
  document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
  const btn = document.getElementById('slot-'+slotId);
  if (btn) btn.classList.add('selected');

  // Update confirm box
  const slot = loadSlots().find(s => s.id === slotId);
  if (!slot) return;
  const d = new Date(slot.date);
  const DAYS_JP = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const label = `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${DAYS_JP[d.getDay()]}ï¼‰${slot.start}ã€œ ï¼ˆ${slot.dur}åˆ†ï¼‰`;
  document.getElementById('confirm-date').textContent = label;
  document.getElementById('confirm-box').classList.add('show');
  document.getElementById('confirm-box').scrollIntoView({behavior:'smooth'});
}

function confirmBooking() {
  if (!selectedSlotId) return;
  const slots = loadSlots();
  const slot  = slots.find(s => s.id === selectedSlotId);
  if (!slot || slot.status !== 'open') {
    alert('ã“ã®æ ã¯ã™ã§ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®æ—¥ç¨‹ã‚’ãŠé¸ã³ãã ã•ã„ã€‚');
    render();
    return;
  }

  // Generate mock Google Meet URL
  const meetCode = Math.random().toString(36).slice(2,5)+'-'+Math.random().toString(36).slice(2,6)+'-'+Math.random().toString(36).slice(2,5);
  const meetUrl  = `https://meet.google.com/${meetCode}`;

  // Mark slot as booked
  slot.status      = 'booked';
  slot.bookedCase  = caseId;
  slot.bookedClient = clientName;
  slot.meetUrl     = meetUrl;
  slot.bookedAt    = new Date().toISOString();
  saveSlots(slots);

  // Record booking
  const bookings = loadBookings();
  bookings.push({
    id:          'BK'+Date.now(),
    slotId:      slot.id,
    caseId,
    clientName,
    propName,
    agentId,
    agentName,
    itAgentId:   slot.agentId,
    itAgentName: slot.agentName,
    date:        slot.date,
    start:       slot.start,
    dur:         slot.dur,
    meetUrl,
    bookedAt:    new Date().toISOString(),
    notified:    false,
  });
  saveBookings(bookings);

  // Mock Slack notification (console log)
  const d = new Date(slot.date);
  const DAYS_JP = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const dateLabel = `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${DAYS_JP[d.getDay()]}ï¼‰${slot.start}`;
  const slackMsg = [
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    'ğŸ“… *ITé‡èª¬ äºˆç´„ç¢ºå®š*',
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    `ğŸ†” *æ¡ˆä»¶ID*ï¼š${caseId}`,
    `ğŸ‘¤ *ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ*ï¼š${clientName}`,
    `ğŸ  *ç‰©ä»¶*ï¼š${propName}`,
    `ğŸ“… *æ—¥æ™‚*ï¼š${dateLabel}ï¼ˆ${slot.dur}åˆ†ï¼‰`,
    `ğŸ‘¨â€ğŸ’¼ *é‡èª¬æ‹…å½“*ï¼š${slot.agentName}ï¼ˆ${slot.agentId}ï¼‰`,
    `ğŸ‘¨â€ğŸ’¼ *æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ*ï¼š${agentName}ï¼ˆ${agentId}ï¼‰`,
    `ğŸ”— *Google Meet*ï¼š${meetUrl}`,
    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
    'ğŸ• '+new Date().toLocaleString('ja-JP'),
  ].join('\n');

  console.log('[Slack #é‡èª¬æ—¥ç¨‹èª¿æ•´]\n'+slackMsg);

  // Show success screen
  document.getElementById('slot-picker').style.display = 'none';
  const successBox = document.getElementById('success-box');
  successBox.classList.add('show');
  document.getElementById('success-detail').innerHTML =
    `${dateLabel}ï¼ˆ${slot.dur}åˆ†ï¼‰<br>é‡èª¬æ‹…å½“ï¼š${slot.agentName}<br>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼š${agentName}<br><br>Google Meet ã®ãƒªãƒ³ã‚¯ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚ˆã‚Šå…±æœ‰ã„ãŸã—ã¾ã™ã€‚`;
  const meetLink = document.getElementById('meet-link');
  meetLink.href = meetUrl;
  meetLink.textContent = 'ğŸ¥ Google Meet: '+meetUrl;
}

render();
</script>
</body>
</html>
