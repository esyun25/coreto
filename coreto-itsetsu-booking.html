<!DOCTYPE html><!-- v202602250557 -->
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ITé‡èª¬ æ—¥ç¨‹äºˆç´„ | CORETO</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0d12;--card:#141820;--card2:#191e28;--border:#1e2435;--border2:#252c3d;
  --text:#e4e7f0;--sub:#7a82a0;--muted:#3e4565;
  --gold:#c9a840;--gold2:#e0bc5a;--green:#34d399;--blue:#4f9cf9;
  --red:#f87171;--orange:#fb923c;--purple:#a78bfa;
}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;padding:24px 16px}
.logo{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--gold);letter-spacing:4px;margin-bottom:4px;text-align:center}
.logo-sub{font-size:11px;color:var(--muted);text-align:center;margin-bottom:24px}
.container{width:100%;max-width:560px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:14px}
.card-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:800;color:var(--gold);margin-bottom:12px}
.info-row{display:flex;font-size:11px;line-height:2;gap:8px}
.info-lbl{color:var(--muted);width:68px;flex-shrink:0}
.info-val{color:var(--text);font-weight:500}
/* Slot list */
.slot-item{display:flex;align-items:center;gap:10px;padding:11px 13px;
  border:1.5px solid var(--border2);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:.12s}
.slot-item:hover{border-color:rgba(201,168,64,.4);background:rgba(201,168,64,.04)}
.slot-item.selected{border-color:var(--gold);background:rgba(201,168,64,.08)}
.slot-item.priority{border-color:rgba(167,139,250,.5);background:rgba(167,139,250,.04)}
.slot-item.priority:hover{border-color:rgba(167,139,250,.7);background:rgba(167,139,250,.08)}
.slot-item.priority.selected{border-color:var(--purple);background:rgba(167,139,250,.12)}
.radio{width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);flex-shrink:0;transition:.12s}
.slot-item.selected .radio{border-color:var(--gold);background:var(--gold);box-shadow:0 0 0 2px rgba(201,168,64,.25)}
.slot-item.priority.selected .radio{border-color:var(--purple);background:var(--purple)}
.slot-date{font-size:11px;color:var(--sub);margin-bottom:1px}
.slot-time{font-size:14px;font-weight:800;font-family:'DM Mono',monospace}
.slot-dur{font-size:10px;color:var(--muted)}
.slot-agent{font-size:10px;color:var(--sub);text-align:right;flex:1}
.priority-badge{font-size:8px;padding:1px 6px;border-radius:8px;background:rgba(167,139,250,.15);
  color:var(--purple);font-weight:700;display:block;margin-top:2px}
.no-slots{font-size:12px;color:var(--muted);text-align:center;padding:28px;border:1px dashed var(--border2);border-radius:10px}
/* Confirm / change buttons */
.btn{width:100%;padding:13px;border-radius:12px;font-family:inherit;font-size:13px;font-weight:800;
  border:none;cursor:pointer;transition:.12s}
.btn:disabled{opacity:.35;cursor:default}
.btn-gold{background:linear-gradient(135deg,#c9a840,#e0bc5a);color:#0b0d12}
.btn-ghost{background:transparent;border:1.5px solid var(--border2);color:var(--sub)}
.btn-ghost:hover:not(:disabled){border-color:var(--border);color:var(--text)}
.btn-red{background:rgba(248,113,113,.1);border:1.5px solid rgba(248,113,113,.3);color:var(--red)}
.btn-red:hover:not(:disabled){background:rgba(248,113,113,.18)}
.btn-sm{padding:7px 14px;border-radius:8px;font-size:11px;width:auto}
.btns{display:flex;flex-direction:column;gap:8px;margin-top:12px}
/* Current booking panel */
.booking-info{background:rgba(201,168,64,.06);border:1px solid rgba(201,168,64,.2);
  border-radius:10px;padding:14px;margin-bottom:12px}
.booking-date{font-size:16px;font-weight:800;color:var(--gold2);margin-bottom:6px}
.meet-link{display:inline-flex;align-items:center;gap:6px;margin-top:8px;padding:9px 14px;
  background:rgba(79,156,249,.1);border:1px solid rgba(79,156,249,.3);border-radius:8px;
  color:var(--blue);text-decoration:none;font-size:11px;font-weight:700}
/* Change counter */
.change-info{font-size:10px;color:var(--muted);margin-top:6px;display:flex;align-items:center;gap:6px}
.change-dot{width:6px;height:6px;border-radius:50%}
/* Success */
.success-icon{font-size:40px;text-align:center;margin-bottom:10px}
.success-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;text-align:center;margin-bottom:8px}
/* Warning */
.warn-box{background:rgba(251,146,60,.07);border:1px solid rgba(251,146,60,.25);
  border-radius:8px;padding:10px 12px;font-size:11px;color:var(--orange);margin-top:8px;line-height:1.8}
/* History */
.hist-item{font-size:10px;color:var(--muted);padding:5px 0;border-bottom:1px solid var(--border);line-height:1.7}
/* Request form */
.req-section{border-top:1.5px dashed var(--border2);margin-top:14px;padding-top:14px}
.req-title{font-size:12px;font-weight:700;color:var(--orange);margin-bottom:8px}
.req-desc{font-size:10px;color:var(--muted);line-height:1.9;margin-bottom:12px;
  background:rgba(251,146,60,.07);border:1px solid rgba(251,146,60,.18);border-radius:8px;padding:9px 11px}
.wish-row{display:flex;align-items:center;gap:6px;margin-bottom:8px;flex-wrap:wrap}
.wish-label{font-size:10px;color:var(--sub);min-width:28px;flex-shrink:0}
.wish-del{background:transparent;border:1px solid rgba(248,113,113,.3);color:var(--red);
  border-radius:5px;padding:2px 7px;font-size:10px;cursor:pointer;font-family:inherit;flex-shrink:0}
.wish-del:hover{background:rgba(248,113,113,.1)}
.add-wish-btn{font-size:11px;padding:5px 12px;border-radius:7px;border:1px dashed var(--border2);
  background:transparent;color:var(--muted);cursor:pointer;font-family:inherit;width:100%;margin-top:2px}
.add-wish-btn:hover{border-color:var(--orange);color:var(--orange)}
.req-note{font-size:10px;color:var(--muted);margin-top:8px}
/* Calendar grid */
.cal-toggle{width:100%;margin-top:12px;padding:10px 0;background:transparent;
  border:1px dashed var(--border2);border-radius:8px;color:var(--muted);
  cursor:pointer;font-size:11px;font-family:inherit;transition:.15s}
.cal-toggle:hover{border-color:var(--gold);color:var(--gold)}
.cal-section{margin-top:14px;display:none}
.cal-section.open{display:block}
.cal-grid-outer{overflow-x:auto;overflow-y:auto;max-height:60vh;border:1px solid var(--border2);border-radius:8px}
.cal-month-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.cal-month-lbl{font-size:13px;font-weight:700;color:var(--text)}
.cal-nav-btn{background:transparent;border:1px solid var(--border2);color:var(--sub);
  border-radius:6px;padding:4px 10px;cursor:pointer;font-size:11px;font-family:inherit}
.cal-nav-btn:hover{border-color:var(--gold);color:var(--gold)}
.cal-grid{width:100%;border-collapse:collapse;font-size:11px}
.cal-grid th{padding:5px 2px;font-size:9px;color:var(--muted);font-weight:600;
  text-align:center;white-space:nowrap;border-bottom:1px solid var(--border2);
  position:sticky;top:0;z-index:2;background:#0b0d12}
.cal-grid td{padding:3px 2px;text-align:center;vertical-align:middle;
  border-right:1px solid var(--border);min-width:28px}
.cal-grid td:first-child{text-align:right;padding-right:6px;color:var(--muted);
  font-size:10px;font-family:'DM Mono',monospace;white-space:nowrap;min-width:44px;
  position:sticky;left:0;z-index:1;background:#0b0d12}
.cal-grid tr{border-bottom:1px solid var(--border)}
.cal-cell-avail{cursor:pointer;border-radius:50%;width:22px;height:22px;
  display:inline-flex;align-items:center;justify-content:center;
  border:1.5px solid var(--gold);color:var(--gold);font-size:14px;font-weight:700;
  transition:.12s}
.cal-cell-avail:hover,.cal-cell-avail.selected{background:var(--gold);color:#0b0d12}
.cal-cell-none{color:var(--border2);font-size:12px}
.cal-cell-past{color:var(--border);font-size:10px}
.col-sun{color:var(--red)!important}
.col-sat{color:var(--blue)!important}
.col-today{background:rgba(201,168,64,.06)}
.date-inp{background:var(--card2);border:1px solid var(--border2);border-radius:7px;
  padding:7px 8px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;outline:none;min-width:110px}
.date-inp:focus{border-color:var(--gold)}
.tsel-sm{background:var(--card2);border:1px solid var(--border2);border-radius:7px;
  padding:7px 6px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;outline:none}
.tsel-sm:focus{border-color:var(--gold)}
.req-status{background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.25);
  border-radius:10px;padding:16px;text-align:center;margin-top:14px}
</style>
</head>
<body>
<div class="logo">CORETO</div>
<div class="logo-sub">ITé‡èª¬ æ—¥ç¨‹äºˆç´„</div>
<div class="container" id="app"></div>

<script>
// â”€â”€ Keys â”€â”€
var SLOTS_KEY    = 'coreto_itsetsu_slots';
var BOOKINGS_KEY = 'coreto_itsetsu_bookings';
var REQUESTS_KEY = 'coreto_itsetsu_requests';
function loadSlots()    { try{return JSON.parse(localStorage.getItem(SLOTS_KEY)||'[]');}catch(e){return[];} }
function saveSlots(s)   { localStorage.setItem(SLOTS_KEY, JSON.stringify(s)); }
function loadBookings() { try{return JSON.parse(localStorage.getItem(BOOKINGS_KEY)||'[]');}catch(e){return[];} }
function saveBookings(b){ localStorage.setItem(BOOKINGS_KEY, JSON.stringify(b)); }
function loadRequests() { try{return JSON.parse(localStorage.getItem(REQUESTS_KEY)||'[]');}catch(e){return[];} }
function saveRequests(r){ localStorage.setItem(REQUESTS_KEY, JSON.stringify(r)); }

// â”€â”€ URL params â”€â”€
var P = new URLSearchParams(location.search);
var caseId   = P.get('caseId')   || '';
var clientN  = decodeURIComponent(P.get('client')  || '');
var propName = decodeURIComponent(P.get('prop')    || '');
var agentN   = decodeURIComponent(P.get('agent')   || '');
var agentId  = P.get('agentId')  || '';
var dedicatedId = P.get('dedicatedId') || agentId; // å°‚ä»»å®…å»ºå£«ID
var trackingNo  = P.get('tracking')    || ''; // éƒµä¾¿è¿½è·¡ç•ªå·

var WD = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
function fmtDate(ds){
  var d = new Date(ds+'T00:00:00');
  return (d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥ï¼ˆ'+WD[d.getDay()]+'ï¼‰';
}
function fmtDt(ds, st){
  return fmtDate(ds) + ' ' + st;
}
function genMeet(){
  var c='abcdefghijklmnopqrstuvwxyz';
  var rnd=function(n){return Array.from({length:n},function(){return c[Math.floor(Math.random()*c.length)];}).join('');};
  return 'https://meet.google.com/'+rnd(3)+'-'+rnd(4)+'-'+rnd(3);
}

// â”€â”€ 24h rules â”€â”€
function minsUntil(date, start) {
  return (new Date(date+'T'+start+':00') - new Date()) / 60000;
}
function canClientChange(bk) {
  if (!bk || bk.status === 'cancelled') return false;
  var mins = minsUntil(bk.date, bk.start);
  if (mins <= 0) return false;           // past
  if (mins > 24*60) return true;         // >24h: free
  return (bk.changeCount || 0) < 2;     // â‰¤24h: max 2
}
function canClientCancel(bk) {
  if (!bk || bk.status === 'cancelled') return false;
  var mins = minsUntil(bk.date, bk.start);
  if (mins <= 0) return false;
  if (mins <= 24*60) return false; // within 24h: client cannot cancel
  // Check alternative agents available at same time
  var slots = loadSlots();
  return slots.some(function(s){
    return s.id !== bk.slotId && s.date === bk.date &&
           s.start === bk.start && s.status === 'open';
  });
}
function changeLabel(bk) {
  var mins = minsUntil(bk.date, bk.start);
  if (mins > 24*60) return { text:'å¤‰æ›´è‡ªç”±ï¼ˆ24æ™‚é–“ä»¥ä¸Šå‰ï¼‰', color:'var(--green)' };
  var remaining = 2 - (bk.changeCount || 0);
  if (remaining <= 0) return { text:'å¤‰æ›´å›æ•°ä¸Šé™ã«é”ã—ã¾ã—ãŸï¼ˆæœ¬éƒ¨ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ï¼‰', color:'var(--red)' };
  return { text:'æ®‹ã‚Šå¤‰æ›´å¯èƒ½å›æ•°: '+remaining+'å›ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰', color:'var(--orange)' };
}

// â”€â”€ Slot priority sort â”€â”€
function sortedAvailableSlots() {
  var now = new Date();
  var slots = loadSlots().filter(function(s){
    return s.status === 'open' && new Date(s.date+'T'+s.start+':00') > now;
  });
  slots.sort(function(a, b){
    var aP = (a.agentId === dedicatedId) ? 0 : 1;
    var bP = (b.agentId === dedicatedId) ? 0 : 1;
    if (aP !== bP) return aP - bP;
    return (a.date+a.start).localeCompare(b.date+b.start);
  });
  return slots;
}

// â”€â”€ State â”€â”€
var selectedSlotId = null;
var mode = 'initial'; // 'initial' | 'booking' | 'changing' | 'existing'

// â”€â”€ Render â”€â”€
function render() {
  var app = document.getElementById('app');
  if (!caseId) {
    app.innerHTML = '<div class="card" style="text-align:center;padding:32px"><div style="font-size:32px;margin-bottom:12px">âš ï¸</div><div style="font-size:12px;color:var(--muted)">ç„¡åŠ¹ãªãƒªãƒ³ã‚¯ã§ã™ã€‚<br>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”é€£çµ¡ãã ã•ã„ã€‚</div></div>';
    return;
  }
  var bookings = loadBookings();
  var existing = bookings.find(function(b){ return b.caseId === caseId && b.status !== 'cancelled'; });
  if (existing) {
    renderExisting(existing);
  } else {
    renderNew();
  }
}

function caseInfoHtml() {
  var rows = [];
  if (clientN)  rows.push('<div class="info-row"><span class="info-lbl">ãŠåå‰</span><span class="info-val">'+clientN+' æ§˜</span></div>');
  if (propName) rows.push('<div class="info-row"><span class="info-lbl">ç‰©ä»¶</span><span class="info-val">'+propName+'</span></div>');
  if (agentN)   rows.push('<div class="info-row"><span class="info-lbl">æ‹…å½“</span><span class="info-val">'+agentN+'</span></div>');
  return rows.join('');
}

function buildTimeSelectSm(id, val) {
  var opts = '';
  for (var h = 8; h < 22; h++) {
    for (var m = 0; m < 60; m += 30) {
      var v = (h<10?'0':'')+h+':'+(m===0?'00':'30');
      opts += '<option value="'+v+'"'+(v===val?' selected':'')+'>'+v+'</option>';
    }
  }
  return '<select class="tsel-sm" id="'+id+'">'+opts+'</select>';
}

var wishList = [{ date:'', start:'10:00', end:'11:00' }]; // initial 1 wish
var requestSent = false;

function renderWishRows() {
  var html = wishList.map(function(w, i) {
    return '<div class="wish-row" id="wish-row-'+i+'">'
      +'<span class="wish-label">'+(i+1)+'.</span>'
      +'<input type="date" class="date-inp" id="wish-date-'+i+'" value="'+w.date+'"'
      +' min="'+new Date().toISOString().slice(0,10)+'"'
      +' onchange="syncWish('+i+')">'
      +buildTimeSelectSm('wish-start-'+i, w.start).replace('>', ' onchange="syncWish('+i+')">')
      +'<span style="font-size:10px;color:var(--muted)">ã€œ</span>'
      +buildTimeSelectSm('wish-end-'+i, w.end).replace('>', ' onchange="syncWish('+i+')">')
      +(wishList.length > 1 ? '<button class="wish-del" onclick="removeWish('+i+')">âœ•</button>' : '')
      +'</div>';
  }).join('');
  var el = document.getElementById('wish-rows');
  if (el) el.innerHTML = html;
  var addBtn = document.getElementById('add-wish-btn');
  if (addBtn) addBtn.style.display = wishList.length >= 3 ? 'none' : '';
}

function syncWish(i) {
  var d = document.getElementById('wish-date-'+i);
  var s = document.getElementById('wish-start-'+i);
  var e = document.getElementById('wish-end-'+i);
  if (d) wishList[i].date  = d.value;
  if (s) wishList[i].start = s.value;
  if (e) wishList[i].end   = e.value;
}

function addWish() {
  if (wishList.length >= 3) return;
  wishList.push({ date:'', start:'10:00', end:'11:00' });
  renderWishRows();
}

function removeWish(i) {
  wishList.splice(i, 1);
  renderWishRows();
}

// â”€â”€ Calendar grid for "other slots" â”€â”€
var calWeekOffset = 0;

function toggleCalendar() {
  var sec = document.getElementById('cal-section');
  if (!sec) return;
  var isOpen = sec.classList.contains('open');
  sec.classList.toggle('open', !isOpen);
  var btn = document.getElementById('cal-toggle-btn');
  if (btn) btn.textContent = isOpen ? 'â–¼ ãã®ä»–ã®æ—¥ç¨‹ã‚’è¦‹ã‚‹' : 'â–² ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‰ã˜ã‚‹';
  if (!isOpen) { calWeekOffset = 0; renderCalGrid(); }
}

function getWeekDates(offset) {
  var now = new Date();
  var day = now.getDay();
  var monday = new Date(now);
  monday.setDate(now.getDate() - day + 1 + offset * 7);
  var dates = [];
  for (var i = 0; i < 7; i++) {
    var d = new Date(monday);
    d.setDate(monday.getDate() + i);
    dates.push(d);
  }
  return dates;
}

function fmtIso(d) {
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function renderCalGrid() {
  var cont = document.getElementById('cal-grid-wrap');
  if (!cont) return;
  var slots = sortedAvailableSlots();
  // Build slot lookup: date -> [slot, ...]
  var slotMap = {};
  slots.forEach(function(s) {
    if (!slotMap[s.date]) slotMap[s.date] = [];
    slotMap[s.date].push(s);
  });

  var weekDates = getWeekDates(calWeekOffset);
  var today = new Date(); today.setHours(0,0,0,0);

  // Collect all unique time labels from available slots in this week + next 3 weeks
  var allDates = [];
  for (var w = 0; w < 4; w++) getWeekDates(calWeekOffset + w).forEach(function(d){ allDates.push(fmtIso(d)); });
  var timesSet = {};
  allDates.forEach(function(ds) {
    (slotMap[ds] || []).forEach(function(s) { timesSet[s.start] = true; });
  });
  var times = Object.keys(timesSet).sort();
  if (!times.length) {
    // Show all 30-min slots 8:00-20:30 if no data
    for (var h = 8; h < 21; h++) {
      times.push((h<10?'0':'')+h+':00');
      times.push((h<10?'0':'')+h+':30');
    }
  }

  var WD = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  var months = {};
  weekDates.forEach(function(d){ months[d.getMonth()+1] = true; });
  var monthLabel = Object.keys(months).map(function(m){ return weekDates[0].getFullYear()+'å¹´'+m+'æœˆ'; }).join('ãƒ»');

  // Month/week nav
  var navHtml = '<div class="cal-month-nav">'
    +'<button class="cal-nav-btn" onclick="shiftCalWeek(-1)">â—€ å‰ã®é€±</button>'
    +'<span class="cal-month-lbl">'+monthLabel+'</span>'
    +'<button class="cal-nav-btn" onclick="shiftCalWeek(1)">æ¬¡ã®é€± â–¶</button>'
    +'</div>';

  // Header row
  var headCols = '<th></th>' + weekDates.map(function(d, i) {
    var iso = fmtIso(d);
    var isPast = d < today;
    var isToday = iso === fmtIso(today);
    var col = (d.getDay()===0)?'col-sun':(d.getDay()===6)?'col-sat':'';
    var bg = isToday ? 'background:rgba(201,168,64,.08)' : (isPast ? 'opacity:.35' : '');
    return '<th style="'+bg+'" class="'+col+'">'
      +'<div>'+d.getDate()+'</div>'
      +'<div style="font-size:9px">('+WD[d.getDay()]+')</div>'
      +'</th>';
  }).join('');

  // Body rows
  var bodyRows = times.map(function(t) {
    var cells = weekDates.map(function(d, i) {
      var iso = fmtIso(d);
      var isPast = d < today;
      var col = (d.getDay()===0)?'col-sun':(d.getDay()===6)?'col-sat':'';
      var isToday = iso === fmtIso(today);
      var bg = isToday ? 'background:rgba(201,168,64,.04)' : '';
      if (isPast) return '<td style="'+bg+'" class="'+col+'"><span class="cal-cell-past">â€”</span></td>';
      var matching = (slotMap[iso]||[]).filter(function(s){ return s.start <= t && s.end > t; });
      if (matching.length) {
        // Use first matching slot (already priority-sorted)
        var slot = matching[0];
        var isSel = slot.id === selectedSlotId;
        var cidAttr = ' data-sid="'+slot.id+'"';
        return '<td style="'+bg+'" class="'+col+'">'+(isSel
          ? '<span class="cal-cell-avail selected"'+cidAttr+' onclick="selSlotCal(this.dataset.sid)">â—</span>'
          : '<span class="cal-cell-avail"'+cidAttr+' onclick="selSlotCal(this.dataset.sid)">â—</span>')
          +'</td>';
      }
      return '<td style="'+bg+'" class="'+col+'"><span class="cal-cell-none">Ã—</span></td>';
    }).join('');
    return '<tr><td>'+t+'</td>'+cells+'</tr>';
  }).join('');

  cont.innerHTML = navHtml
    +'<div class="cal-grid-outer">'
    +'<table class="cal-grid"><thead><tr>'+headCols+'</tr></thead>'
    +'<tbody>'+bodyRows+'</tbody></table></div>';
}

function shiftCalWeek(d) {
  calWeekOffset += d;
  if (calWeekOffset < 0) calWeekOffset = 0;
  renderCalGrid();
}

function selSlotCal(slotId) {
  selectedSlotId = slotId;
  // Re-render calendar to show selection
  renderCalGrid();
  // Also update confirm button
  var btn = document.getElementById('confirm-btn');
  if (btn) { btn.disabled = false; }
  // Show selection info
  var slot = loadSlots().find(function(s){ return s.id === slotId; });
  if (slot) {
    var info = document.getElementById('cal-sel-info');
    if (info) {
      info.innerHTML = '<div style="margin-top:8px;padding:8px 11px;background:rgba(201,168,64,.08);'
        +'border:1px solid rgba(201,168,64,.25);border-radius:7px;font-size:11px">'
        +'âœ… é¸æŠ: '+fmtDate(slot.date)+' '+slot.start+' / '+slot.agentName+'</div>';
    }
    // Scroll to confirm btn
    var confirmBtn = document.getElementById('confirm-btn-cal');
    if (confirmBtn) { confirmBtn.disabled = false; confirmBtn.scrollIntoView({behavior:'smooth',block:'nearest'}); }
  }
}

function submitRequest() {
  // Sync all wish fields first
  wishList.forEach(function(w, i) { syncWish(i); });
  var valid = wishList.filter(function(w){ return w.date && w.start < w.end; });
  if (!valid.length) { alert('å¸Œæœ›æ—¥æ™‚ã‚’1ä»¶ä»¥ä¸Šæ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆçµ‚äº†ã¯é–‹å§‹ã‚ˆã‚Šå¾Œã®æ™‚åˆ»ã«ã—ã¦ãã ã•ã„ï¼‰'); return; }
  var reqs = loadRequests();
  // Check for existing open request for this case
  var existing = reqs.find(function(r){ return r.caseId === caseId && r.status === 'open'; });
  if (existing) { alert('ã“ã®ã”æ¡ˆä»¶ã«ã¯ã™ã§ã«å—ä»˜ä¸­ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸ã”é€£çµ¡ãã ã•ã„ã€‚'); return; }
  var req = {
    id: 'RQ'+Date.now(),
    caseId: caseId, clientName: clientN, propName: propName,
    agentId: agentId, agentName: agentN, dedicatedId: dedicatedId,
    wishes: valid,
    submittedAt: new Date().toISOString(),
    status: 'open',     // open | matched | cancelled
    matchedSlotId: null,
    matchedAgentId: null
  };
  reqs.push(req);
  saveRequests(reqs);
  requestSent = true;
  // Slack mock notify
  var wishText = valid.map(function(w,i){ return (i+1)+'. '+fmtDate(w.date)+' '+w.start+'ã€œ'+w.end; }).join(' / ');
  console.log('[Slack #ITé‡èª¬æ—¥ç¨‹èª¿æ•´] ã€æ—¥ç¨‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‘æ¡ˆä»¶:'+caseId+'/'+clientN+' å¸Œæœ›:'+wishText+' æ‹…å½“:'+agentN);
  renderRequestSent(req);
}

function renderRequestSent(req) {
  var app = document.getElementById('app');
  var wishText = req.wishes.map(function(w,i){
    return '<div class="hist-item">'+(i+1)+'. '+fmtDate(w.date)+' '+w.start+'ã€œ'+w.end+'</div>';
  }).join('');
  app.innerHTML = '<div class="card">'
    +'<div class="req-status">'
    +'<div style="font-size:28px;margin-bottom:8px">ğŸ“¨</div>'
    +'<div style="font-size:14px;font-weight:800;color:var(--green);margin-bottom:4px">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä»˜ã—ã¾ã—ãŸ</div>'
    +'<div style="font-size:10px;color:var(--muted)">æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ—¥ç¨‹ã‚’èª¿æ•´ã—ã¾ã™ã€‚<br>ç¢ºå®šæ¬¡ç¬¬ã“ã®ãƒšãƒ¼ã‚¸ã§ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚</div>'
    +'</div>'
    +'<div style="margin-top:14px"><div style="font-size:10px;color:var(--muted);margin-bottom:6px">ã”å¸Œæœ›ã®æ—¥æ™‚</div>'
    +wishText+'</div></div>';
}

function contractNoticeHtml() {
  var trackingUrl = trackingNo
    ? 'https://trackings.post.japanpost.jp/services/srv/search/direct?reqCodeNo1=' + encodeURIComponent(trackingNo)
    : '';
  var html = '<div style="margin-top:8px;padding:12px 14px;'
    +'background:rgba(79,156,249,.07);border:1px solid rgba(79,156,249,.22);'
    +'border-radius:8px;font-size:11px;color:var(--sub);line-height:2">';
  html += '<div style="font-weight:700;color:var(--blue);margin-bottom:4px">ğŸ“¦ å¥‘ç´„æ›¸ã®ç™ºé€ã«ã¤ã„ã¦</div>';
  html += 'å¥‘ç´„æ›¸ã¯æ•°æ—¥ã§ãŠæ‰‹å…ƒã«å±Šãäºˆå®šã§ã™ã€‚è¿½è·¡ç•ªå·ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚<br>';
  html += '<span style="color:var(--muted);font-size:10px">â€» ç™ºé€ç›´å¾Œã¯è¿½è·¡ç•ªå·ãŒç¢ºèªã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</span>';
  if (trackingNo && trackingUrl) {
    html += '<div style="margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">'
      +'<span style="font-family:monospace;font-size:13px;font-weight:700;color:var(--text);letter-spacing:.08em">'
      +trackingNo+'</span>'
      +'<a href="'+trackingUrl+'" target="_blank" rel="noopener"'
      +' style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;'
      +'background:rgba(79,156,249,.12);border:1px solid rgba(79,156,249,.3);'
      +'border-radius:6px;color:var(--blue);font-size:10px;font-weight:700;text-decoration:none">'
      +'ğŸ” éƒµä¾¿å±€ã§è¿½è·¡ã™ã‚‹</a></div>';
  } else {
    html += '<div style="margin-top:6px;color:var(--muted);font-size:10px">ï¼ˆè¿½è·¡ç•ªå·ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ã”é€£çµ¡ã—ã¾ã™ï¼‰</div>';
  }
  html += '</div>';
  return html;
}

function renderNew() {
  var slots = sortedAvailableSlots();
  var app = document.getElementById('app');
  // Check for existing open request
  var existingReq = loadRequests().find(function(r){ return r.caseId===caseId && r.status==='open'; });
  if (existingReq) { renderRequestSent(existingReq); return; }
  var slotsHtml = '';
  var hasSlots = slots.length > 0;
  var topSlots = slots.slice(0, 3);
  var hasMore  = slots.length > 3;
  if (!hasSlots) {
    slotsHtml = '<div class="no-slots">ğŸ˜” ç¾åœ¨ã€ç©ºãæ—¥ç¨‹ãŒã”ã–ã„ã¾ã›ã‚“ã€‚</div>'
      +'<button class="cal-toggle" id="cal-toggle-btn" onclick="toggleCalendar()">â–¼ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ç©ºãæ—¥ç¨‹ã‚’ç¢ºèªã™ã‚‹</button>'      +'<div class="cal-section" id="cal-section">'      +'<div id="cal-grid-wrap"></div>'      +'<div id="cal-sel-info"></div></div>';
  } else {
    slotsHtml = topSlots.map(function(s){
      var isPriority = (s.agentId === dedicatedId);
      var cls = 'slot-item' + (isPriority ? ' priority' : '') + (s.id === selectedSlotId ? ' selected' : '');
      return '<div class="'+cls+'" onclick="selSlot(\'' + s.id + '\',this)">'
        +'<div class="radio"></div>'
        +'<div style="min-width:60px"><div class="slot-date">'+fmtDate(s.date)+'</div>'
        +'<div class="slot-time">'+s.start+'</div>'
        +'<div class="slot-dur">'+fmtDur(s.dur)+'</div></div>'
        +'<div class="slot-agent">'+s.agentName
        +(isPriority ? '<span class="priority-badge">å°‚ä»»æ‹…å½“</span>' : '')
        +'</div></div>';
    }).join('');
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯å¸¸ã«è¡¨ç¤ºï¼ˆã‚¹ãƒ­ãƒƒãƒˆæ•°ã«é–¢ã‚ã‚‰ãšï¼‰
    slotsHtml += '<button class="cal-toggle" id="cal-toggle-btn" onclick="toggleCalendar()">'
      +(hasMore ? 'â–¼ ãã®ä»–ã®æ—¥ç¨‹ã‚’è¦‹ã‚‹ï¼ˆ'+(slots.length - 3)+'æ ï¼‰' : 'â–¼ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æ—¥ç¨‹ã‚’ç¢ºèªã™ã‚‹')
      +'</button>'
      +'<div class="cal-section" id="cal-section">'
      +'<div id="cal-grid-wrap"></div>'
      +'<div id="cal-sel-info"></div>'
      +'<div class="btns" style="margin-top:10px">'
      +'<button class="btn btn-gold" id="confirm-btn-cal" onclick="doBook()" disabled>ã“ã®æ—¥ç¨‹ã§äºˆç´„ã™ã‚‹</button>'
      +'</div></div>';
  }
  var requestSection = caseId ? (
    '<div class="req-section">'
    +'<div class="req-title">ğŸ“¨ ã”å¸Œæœ›ã®æ—¥æ™‚ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹</div>'
    +'<div class="req-desc">ä¸Šè¨˜ã®æ—¥ç¨‹ãŒåˆã‚ãªã„å ´åˆã€ã”å¸Œæœ›ã®æ—¥æ™‚ã‚’æœ€å¤§3ä»¶ã”æå‡ºãã ã•ã„ã€‚<br>'
    +'å¯¾å¿œå¯èƒ½ãªã‚¹ã‚¿ãƒƒãƒ•ã‚’ãŠæ¢ã—ã—ã¾ã™ã€‚é€šå¸¸48æ™‚é–“ä»¥å†…ã«æ—¥ç¨‹ã¯ç¢ºå®šã•ã‚Œã¾ã™ã€‚</div>'
    +'<div id="wish-rows"></div>'
    +'<button class="add-wish-btn" id="add-wish-btn" onclick="addWish()">ï¼‹ å¸Œæœ›æ—¥æ™‚ã‚’è¿½åŠ ï¼ˆæœ€å¤§3ä»¶ï¼‰</button>'
    +'<div class="req-note">â€» çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹ã‚ˆã‚Šå¾Œã®æ™‚åˆ»ã«ã—ã¦ãã ã•ã„</div>'
    +'<div class="btns" style="margin-top:12px">'
    +'<button class="btn btn-ghost" onclick="submitRequest()">ğŸ“¨ ã“ã®æ—¥æ™‚ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹</button>'
    +'</div></div>'
  ) : '';
  app.innerHTML = '<div class="card"><div class="card-title">ğŸ“‹ æ¡ˆä»¶æƒ…å ±</div>'+caseInfoHtml()
    +'<div style="margin-top:10px;padding:9px 11px;background:var(--card2);border-radius:7px;font-size:10px;color:var(--sub);line-height:1.9">'
    +'éƒ½åˆã®ã‚ˆã„æ—¥ç¨‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚é¸æŠå¾Œã€æ‹…å½“ã‹ã‚‰Google Meetã®URLã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚</div></div>'+contractNoticeHtml()+'</div>'
    +'<div class="card"><div class="card-title">ğŸ—“ æ—¥ç¨‹ã‚’é¸æŠ</div>'
    +(dedicatedId ? '<div style="font-size:10px;color:var(--purple);margin-bottom:10px">ğŸ”® æ‹…å½“è€…ã‚’å„ªå…ˆçš„ã«è¡¨ç¤ºã—ã¦ã„ã¾ã™</div>' : '')
    +'<div id="slot-list">'+slotsHtml+'</div>'
    +(slots.length ? '<div class="btns"><button class="btn btn-gold" id="confirm-btn" onclick="doBook()" disabled>ã“ã®æ—¥ç¨‹ã§äºˆç´„ã™ã‚‹</button></div>' : '')
    +requestSection+'</div>';
  renderWishRows();
}

function renderExisting(bk) {
  var app = document.getElementById('app');
  var d = new Date(bk.date+'T00:00:00');
  var label = fmtDate(bk.date) + ' ' + bk.start + 'ã€œï¼ˆ'+fmtDur(bk.dur)+'ï¼‰';
  var cl = changeLabel(bk);
  var canChange = canClientChange(bk);
  var canCancel = canClientCancel(bk);
  var hist = (bk.changeHistory||[]).map(function(h){
    return '<div class="hist-item">'+h.changedAt.slice(0,16).replace('T',' ')+' ï½œ '+fmtDt(h.from.date,h.from.start)+' â†’ '+fmtDt(h.to.date,h.to.start)+'</div>';
  }).join('');
  app.innerHTML = '<div class="card"><div class="card-title">ğŸ“‹ æ¡ˆä»¶æƒ…å ±</div>'+caseInfoHtml()+'</div>'
    +'<div class="card"><div class="card-title">âœ… äºˆç´„æ¸ˆã¿æ—¥ç¨‹</div>'
    +'<div class="booking-info"><div class="booking-date">'+label+'</div>'
    +'<div style="font-size:11px;color:var(--sub)">é‡èª¬æ‹…å½“ï¼š'+bk.itAgentName+'</div>'
    +(bk.meetUrl ? '<a class="meet-link" href="'+bk.meetUrl+'" target="_blank">ğŸ¥ Google Meet ã«å‚åŠ ã™ã‚‹</a>' : '')
    +'</div>'
    +'<div class="change-info"><div class="change-dot" style="background:'+cl.color+'"></div><span style="color:'+cl.color+'">'+cl.text+'</span></div>'
    +'<div class="btns">'
    +(canChange ? '<button class="btn btn-ghost" onclick="startChange()">ğŸ“… æ—¥ç¨‹ã‚’å¤‰æ›´ã™ã‚‹</button>' : '')
    +(canCancel ? '<button class="btn btn-red btn-ghost" style="margin-top:4px" onclick="doCancel()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆä»–ã®æ‹…å½“è€…ã«å¤‰æ›´ï¼‰</button>' : '')
    +'</div>'
    +(hist ? '<div style="margin-top:14px"><div style="font-size:10px;color:var(--muted);margin-bottom:6px">å¤‰æ›´å±¥æ­´</div>'+hist+'</div>' : '')
    +'</div>';
}

function renderChange(bk) {
  var slots = sortedAvailableSlots().filter(function(s){ return !(s.date===bk.date && s.start===bk.start); });
  var slotsHtml = '';
  if (!slots.length) {
    slotsHtml = '<div class="no-slots">ğŸ˜” å¤‰æ›´å¯èƒ½ãªç©ºãæ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”é€£çµ¡ãã ã•ã„ã€‚</div>';
  } else {
    slotsHtml = slots.map(function(s){
      var isPriority = (s.agentId === dedicatedId);
      var cls = 'slot-item'+(isPriority?' priority':'')+(s.id===selectedSlotId?' selected':'');
      return '<div class="'+cls+'" onclick="selSlot(\''+s.id+'\',this)">'
        +'<div class="radio"></div>'
        +'<div style="min-width:60px"><div class="slot-date">'+fmtDate(s.date)+'</div>'
        +'<div class="slot-time">'+s.start+'</div>'
        +'<div class="slot-dur">'+fmtDur(s.dur)+'</div></div>'
        +'<div class="slot-agent">'+s.agentName+(isPriority?'<span class="priority-badge">å°‚ä»»æ‹…å½“</span>':'')+'</div></div>';
    }).join('');
  }
  var mins = minsUntil(bk.date, bk.start);
  app.innerHTML = '<div class="card"><div class="card-title">ğŸ“… æ—¥ç¨‹ã‚’å¤‰æ›´ã™ã‚‹</div>'
    +(mins<=24*60 ? '<div class="warn-box">âš ï¸ 24æ™‚é–“ä»¥å†…ã®å¤‰æ›´ã§ã™ã€‚æ®‹ã‚Šå¤‰æ›´å¯èƒ½å›æ•°: '+(2-(bk.changeCount||0))+'å›</div>' : '')
    +'<div style="margin-top:10px" id="slot-list">'+slotsHtml+'</div>'
    +'<div class="btns"><button class="btn btn-gold" id="confirm-btn" onclick="doChange()" disabled>ã“ã®æ—¥ç¨‹ã«å¤‰æ›´ã™ã‚‹</button>'
    +'<button class="btn btn-ghost" onclick="render()" style="margin-top:4px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>';
}

var app = document.getElementById('app');
function selSlot(id, el) {
  selectedSlotId = id;
  document.querySelectorAll('.slot-item').forEach(function(e){ e.classList.remove('selected'); });
  el.classList.add('selected');
  var btn = document.getElementById('confirm-btn');
  if (btn) btn.disabled = false;
}

function startChange() {
  var bookings = loadBookings();
  var bk = bookings.find(function(b){ return b.caseId===caseId && b.status!=='cancelled'; });
  if (!bk || !canClientChange(bk)) { alert('ç¾åœ¨ã€å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚'); return; }
  selectedSlotId = null;
  renderChange(bk);
}

function doBook() {
  if (!selectedSlotId) return;
  var slots = loadSlots();
  var slot  = slots.find(function(s){ return s.id===selectedSlotId; });
  if (!slot || slot.status==='booked') { alert('ã“ã®æ—¥ç¨‹ã¯ã™ã§ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®æ—¥ç¨‹ã‚’ãŠé¸ã³ãã ã•ã„ã€‚'); selectedSlotId=null; renderNew(); return; }
  var meetUrl = genMeet();
  slot.status     = 'booked';
  slot.bookedCase = caseId;
  slot.bookedClient = clientN;
  slot.meetUrl    = meetUrl;
  slot.bookedAt   = new Date().toISOString();
  saveSlots(slots);
  var bookings = loadBookings();
  var bk = {
    id: 'BK'+Date.now(),
    slotId: slot.id,
    caseId: caseId,
    clientName: clientN, propName: propName,
    agentId: agentId, agentName: agentN,
    itAgentId: slot.agentId, itAgentName: slot.agentName,
    dedicatedAgentId: dedicatedId,
    date: slot.date, start: slot.start, dur: slot.dur,
    meetUrl: meetUrl,
    bookedAt: new Date().toISOString(),
    changeCount: 0,
    changeHistory: [],
    status: 'active',
    cancelledAt: null
  };
  bookings.push(bk);
  saveBookings(bookings);
  console.log('[Slack #ITé‡èª¬æ—¥ç¨‹èª¿æ•´] äºˆç´„ç¢ºå®š\næ¡ˆä»¶:'+caseId+'\nã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ:'+clientN+'\n'+fmtDate(slot.date)+' '+slot.start+'\né‡èª¬æ‹…å½“:'+slot.agentName+'\nMeet:'+meetUrl);
  renderSuccess(bk);
}

function doChange() {
  if (!selectedSlotId) return;
  var bookings = loadBookings();
  var bkIdx = bookings.findIndex(function(b){ return b.caseId===caseId && b.status!=='cancelled'; });
  if (bkIdx<0) return;
  var bk = bookings[bkIdx];
  if (!canClientChange(bk)) { alert('å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚'); render(); return; }
  var slots = loadSlots();
  var newSlot = slots.find(function(s){ return s.id===selectedSlotId && s.status==='open'; });
  if (!newSlot) { alert('é¸æŠã—ãŸæ—¥ç¨‹ã¯ã™ã§ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚'); selectedSlotId=null; renderChange(bk); return; }
  // Release old slot
  var oldSlot = slots.find(function(s){ return s.id===bk.slotId; });
  if (oldSlot) { oldSlot.status='open'; oldSlot.bookedCase=null; oldSlot.bookedClient=null; oldSlot.meetUrl=''; oldSlot.bookedAt=null; }
  // Book new slot
  var meetUrl = genMeet();
  newSlot.status='booked'; newSlot.bookedCase=caseId; newSlot.bookedClient=clientN; newSlot.meetUrl=meetUrl; newSlot.bookedAt=new Date().toISOString();
  saveSlots(slots);
  // Determine if within 24h
  var mins = minsUntil(bk.date, bk.start);
  var hist = { from:{date:bk.date,start:bk.start,agentName:bk.itAgentName}, to:{date:newSlot.date,start:newSlot.start,agentName:newSlot.agentName}, changedAt:new Date().toISOString() };
  if (mins <= 24*60) bk.changeCount = (bk.changeCount||0)+1;
  if (!bk.changeHistory) bk.changeHistory=[];
  bk.changeHistory.push(hist);
  bk.slotId=newSlot.id; bk.date=newSlot.date; bk.start=newSlot.start; bk.dur=newSlot.dur;
  bk.itAgentId=newSlot.agentId; bk.itAgentName=newSlot.agentName; bk.meetUrl=meetUrl;
  saveBookings(bookings);
  console.log('[Slack #ITé‡èª¬æ—¥ç¨‹èª¿æ•´] æ—¥ç¨‹å¤‰æ›´\næ¡ˆä»¶:'+caseId+'\n'+fmtDate(newSlot.date)+' '+newSlot.start+'\né‡èª¬æ‹…å½“:'+newSlot.agentName+'\nMeet:'+meetUrl);
  render();
}

function doCancel() {
  var bookings = loadBookings();
  var bkIdx = bookings.findIndex(function(b){ return b.caseId===caseId && b.status!=='cancelled'; });
  if (bkIdx<0) return;
  var bk = bookings[bkIdx];
  if (!canClientCancel(bk)) { alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã¾ã›ã‚“ã€‚æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”é€£çµ¡ãã ã•ã„ã€‚'); return; }
  if (!confirm('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  // Release slot
  var slots = loadSlots();
  var slot = slots.find(function(s){ return s.id===bk.slotId; });
  if (slot) { slot.status='open'; slot.bookedCase=null; slot.bookedClient=null; slot.meetUrl=''; slot.bookedAt=null; }
  saveSlots(slots);
  bk.status='cancelled'; bk.cancelledAt=new Date().toISOString(); bk.cancelReason='client';
  saveBookings(bookings);
  var app = document.getElementById('app');
  app.innerHTML = '<div class="card" style="text-align:center;padding:24px">'
    +'<div style="font-size:32px;margin-bottom:10px">âœ…</div>'
    +'<div style="font-size:14px;font-weight:700;color:var(--green);margin-bottom:6px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ</div>'
    +'<div style="font-size:11px;color:var(--muted)">æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚<br>æ”¹ã‚ã¦æ—¥ç¨‹ã‚’é¸æŠã™ã‚‹å ´åˆã¯ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div></div>';
}

function renderSuccess(bk) {
  var app = document.getElementById('app');
  app.innerHTML = '<div class="card">'
    +'<div class="success-icon">âœ…</div>'
    +'<div class="success-title" style="color:var(--green)">äºˆç´„å®Œäº†</div>'
    +'<div class="booking-info" style="margin-top:14px">'
    +'<div class="booking-date">'+fmtDate(bk.date)+' '+bk.start+'ã€œï¼ˆ'+fmtDur(bk.dur)+'ï¼‰</div>'
    +'<div style="font-size:11px;color:var(--sub)">é‡èª¬æ‹…å½“ï¼š'+bk.itAgentName+'</div>'
    +(bk.meetUrl ? '<a class="meet-link" href="'+bk.meetUrl+'" target="_blank">ğŸ¥ Google Meet ã«å‚åŠ ã™ã‚‹</a>' : '')
    +'</div>'
    +'<div style="font-size:11px;color:var(--muted);line-height:1.9;margin-top:10px">'
    +'æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸Slackã§é€šçŸ¥ã—ã¾ã—ãŸã€‚<br>'
    +'å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯ã“ã®ãƒšãƒ¼ã‚¸ã«å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚<br>'
    +'ï¼ˆ24æ™‚é–“ä»¥å†…ã¯æœ€å¤§2å›ã¾ã§å¤‰æ›´å¯èƒ½ã§ã™ï¼‰'
    +'</div></div>';
}

function fmtDur(m){ return m<60?m+'åˆ†':Math.floor(m/60)+'æ™‚é–“'+(m%60?m%60+'åˆ†':''); }

render();
</script>
</body>
</html>
