<!DOCTYPE html>
<html lang="ja">
<head>

  <!-- â”€â”€ Content Security Policy (XSSè»½æ¸›) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       å¤‰æ›´æ™‚: ä½¿ç”¨ã™ã‚‹å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
       Kintoneè¿½åŠ æ™‚: connect-src ã« *.cybozu.com ã‚’è¿½åŠ 
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline'
      https://cdnjs.cloudflare.com
      https://js.stripe.com
      https://cdn-cgi/scripts;
    style-src 'self' 'unsafe-inline'
      https://fonts.googleapis.com;
    font-src 'self'
      https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    connect-src 'self'
      https://hooks.slack.com
      https://hooks.zapier.com
      https://api.stripe.com
      https://js.stripe.com
      https://www.houjin-bangou.nta.go.jp
      https://www.retio.or.jp;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
  ">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORETO ãƒ­ã‚°ã‚¤ãƒ³</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--card:#0f1119;--border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--gold-l:#e8c96a;--gold-dim:#7a5f22;
  --green:#34d399;--red:#f87171;--blue:#4f9cf9;
  --muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;--line:#06c755;
}
html,body{height:100%}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);
  display:flex;align-items:center;justify-content:center;min-height:100vh;
  background-image:
    radial-gradient(ellipse 80% 60% at 50% -20%,rgba(201,168,76,.08) 0%,transparent 60%),
    radial-gradient(ellipse 50% 40% at 100% 100%,rgba(79,156,249,.04) 0%,transparent 60%)}
body::before{content:'';position:fixed;inset:0;pointer-events:none;
  background-image:linear-gradient(rgba(201,168,76,.025) 1px,transparent 1px),
    linear-gradient(90deg,rgba(201,168,76,.025) 1px,transparent 1px);
  background-size:48px 48px}
.wrap{width:100%;max-width:400px;padding:20px}
.logo-area{text-align:center;margin-bottom:40px}
.logo{font-family:'Syne',sans-serif;font-size:42px;font-weight:800;color:var(--gold);
  letter-spacing:8px;display:block;text-shadow:0 0 40px rgba(201,168,76,.3)}
.tagline{font-size:11px;color:var(--muted);letter-spacing:2px;margin-top:6px}
.card{background:var(--card);border:1px solid var(--border);border-radius:20px;
  padding:32px 28px;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.4)}
.card::before{content:'';position:absolute;top:0;left:10%;right:10%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(201,168,76,.5),transparent)}
.card-title{font-size:12px;color:var(--sub);text-align:center;
  margin-bottom:24px;letter-spacing:1.5px;text-transform:uppercase;font-weight:600}
.divider{display:flex;align-items:center;gap:10px;margin:22px 0}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
.divider span{font-size:10px;color:var(--muted);letter-spacing:1px;white-space:nowrap}
.fg{margin-bottom:14px}
.fg label{font-size:11px;color:var(--sub);display:block;margin-bottom:5px}
.fg input{width:100%;background:#090b13;border:1px solid var(--border2);border-radius:10px;
  padding:12px 14px;color:var(--text);font-family:'DM Mono',monospace;
  font-size:14px;letter-spacing:2px;transition:border-color .15s,box-shadow .15s}
.fg input::placeholder{font-size:13px;letter-spacing:1px;color:var(--muted)}
.fg input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,.1)}
.type-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;
  border-radius:6px;font-size:10px;font-weight:700;margin-top:6px;opacity:0;
  transition:opacity .2s;font-family:'Noto Sans JP',sans-serif}
.type-badge.visible{opacity:1}
.tb-re{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.25)}
.tb-hr{background:rgba(20,184,166,.12);color:#2dd4bf;border:1px solid rgba(20,184,166,.25)}
.tb-pt{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.25)}
.tb-hq{background:rgba(201,168,76,.12);color:var(--gold);border:1px solid rgba(201,168,76,.25)}
.pw-wrap{position:relative}
.pw-wrap input{padding-right:52px}
.pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);
  font-size:11px;color:var(--muted);cursor:pointer;font-family:'Noto Sans JP',sans-serif;
  user-select:none}
.pw-toggle:hover{color:var(--sub)}
.btn-login{width:100%;padding:13px;border-radius:12px;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--gold) 0%,#a8862e 100%);color:#0a0c10;
  font-size:13px;font-weight:700;font-family:'Noto Sans JP',sans-serif;
  letter-spacing:.5px;transition:all .2s;margin-top:4px}
.btn-login:hover{background:linear-gradient(135deg,var(--gold-l) 0%,var(--gold) 100%);
  transform:translateY(-1px);box-shadow:0 8px 24px rgba(201,168,76,.28)}
.btn-login:active{transform:translateY(0)}
.err{background:rgba(248,113,113,.07);border:1px solid rgba(248,113,113,.25);
  border-radius:9px;padding:10px 13px;font-size:11px;color:var(--red);
  margin-bottom:12px;display:none;line-height:1.7}
.err.show{display:block}
.footer{text-align:center;margin-top:20px;font-size:10px;color:var(--muted)}
.footer a{color:var(--sub);text-decoration:none;margin:0 8px}
.footer a:hover{color:var(--gold)}
.loading{position:fixed;inset:0;background:rgba(7,9,15,.9);backdrop-filter:blur(8px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:999;opacity:0;pointer-events:none;transition:opacity .3s}
.loading.show{opacity:1;pointer-events:all}
.spinner{width:44px;height:44px;border:2px solid rgba(201,168,76,.2);
  border-top-color:var(--gold);border-radius:50%;
  animation:spin .75s linear infinite;margin-bottom:18px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-msg{font-size:12px;color:var(--sub);letter-spacing:1.5px}
</style>

<style>
@media(max-width:768px){
  body{align-items:flex-start!important;padding:0!important}
  .wrap{width:100%!important;padding:0!important}
  .card{width:100%!important;max-width:100%!important;border-radius:0!important;
    min-height:100dvh!important;border-left:none!important;border-right:none!important;
    padding:48px 24px 40px!important;display:flex;flex-direction:column;justify-content:center}
  .card-title{font-size:20px!important}
  .logo-area{margin-bottom:28px!important}
  .btn-login{min-height:52px!important;font-size:15px!important}
  .footer{position:relative!important;margin-top:auto!important;padding-top:32px!important}
}
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-msg" id="loading-msg">ãƒ­ã‚°ã‚¤ãƒ³ä¸­...</div>
</div>

<div class="wrap">
  <div class="logo-area">
    <span class="logo">CORETO</span>
    <div class="tagline">ä¸å‹•ç”£ ï¼ äººæ çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </div>
  </div>

  <div class="card">
    <div class="card-title">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ»ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ­ã‚°ã‚¤ãƒ³</div>

    <div class="err" id="err"></div>

    <div class="fg">
      <label>ä¼šå“¡ID</label>
      <input type="text" id="f-id" inputmode="numeric" maxlength="5"
             autocomplete="username" placeholder="ä¾‹ï¼š10012"
             oninput="onIdChange(this)"
             onkeydown="if(event.key==='Enter')document.getElementById('f-pw').focus()">
      <div class="type-badge" id="type-badge"></div>
    </div>

    <div class="fg">
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <div class="pw-wrap">
        <input type="password" id="f-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
               autocomplete="current-password"
               onkeydown="if(event.key==='Enter')doLogin()">
        <span class="pw-toggle" id="pw-toggle" onclick="togglePw()">è¡¨ç¤º</span>
      </div>
    </div>

    <button class="btn-login" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <div class="footer">
    <a href="#" onclick="openPasswordReset()" style="color:var(--blue)">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹</a>
    <a href="#">æ–°è¦ç™»éŒ²</a>
    <a href="coreto-login-hq.html" style="color:var(--muted)">æœ¬éƒ¨ã‚¹ã‚¿ãƒƒãƒ•ã®æ–¹</a>
  </div>
</div>

<script src="db.js"></script>
<script>
const TYPE_INFO = {
  '0':{ type:'hq', label:'ğŸ¢ æœ¬éƒ¨HQã‚¹ã‚¿ãƒƒãƒ•',       cls:'tb-hq' },
  '1':{ type:'re', label:'ğŸ  ä¸å‹•ç”£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ',     cls:'tb-re' },
  '2':{ type:'hr', label:'ğŸ‘¥ äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ',       cls:'tb-hr' },
  '3':{ type:'pt', label:'ğŸ¤ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼',             cls:'tb-pt' },
};

function onIdChange(el) {
  el.value = el.value.replace(/\D/g,'').slice(0,5);
  showErr('');
  const badge = document.getElementById('type-badge');
  const info  = TYPE_INFO[el.value.charAt(0)];
  if (el.value.length >= 1 && info) {
    badge.textContent = info.label;
    badge.className   = 'type-badge visible ' + info.cls;
  } else {
    badge.className = 'type-badge';
  }
}

function togglePw() {
  const el = document.getElementById('f-pw');
  const tg = document.getElementById('pw-toggle');
  el.type        = el.type === 'password' ? 'text' : 'password';
  tg.textContent = el.type === 'password' ? 'è¡¨ç¤º' : 'éè¡¨ç¤º';
}

function showErr(msg) {
  const el = document.getElementById('err');
  el.textContent = msg;
  el.className   = msg ? 'err show' : 'err';
}

// USERSå®šç¾©ã¯ db.js ã«ä¸€æœ¬åŒ–

// SHA-256ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒ†ã‚£ãƒ–SubtleCryptoä½¿ç”¨ï¼‰
async function verifyPassword(pw, salt, hash) {
  const encoder = new TextEncoder();
  const data = encoder.encode(salt + ':' + pw);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const computed = hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  return computed === hash;
}

// â”€â”€ ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _loginAttempts = { count:0, lockedUntil:0 };
const LOGIN_MAX_ATTEMPTS = 5;     // 5å›å¤±æ•—ã§ãƒ­ãƒƒã‚¯
const LOGIN_LOCKOUT_MS   = 300000; // 5åˆ†é–“ãƒ­ãƒƒã‚¯

function checkLoginLock() {
  if (_loginAttempts.lockedUntil > Date.now()) {
    const remaining = Math.ceil((_loginAttempts.lockedUntil - Date.now()) / 60000);
    showErr('ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚' + remaining + 'åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
    return true;
  }
  return false;
}

async function doLogin() {
  if (checkLoginLock()) return;

  const id = document.getElementById('f-id').value.trim();
  const pw = document.getElementById('f-pw').value;
  if (id.length !== 5)          { showErr('ä¼šå“¡IDã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!TYPE_INFO[id.charAt(0)]) { showErr('ä¼šå“¡IDã®å…ˆé ­æ¡ãŒç„¡åŠ¹ã§ã™'); return; }

  // USERSå®šç¾©ã¯hub.htmlã§ç®¡ç†ï¼ˆåŒä¸€originï¼‰
  // â€»æœ¬ç•ªç’°å¢ƒã§ã¯ coreto-hub.html ã‚’éå…¬é–‹åŒ–ã¾ãŸã¯Kintone APIèªè¨¼ã«ç§»è¡Œ
  const ac = (typeof USERS !== 'undefined') ? USERS[id] : null;
  if (!ac) {
    _loginAttempts.count++;
    if (_loginAttempts.count >= LOGIN_MAX_ATTEMPTS) {
      _loginAttempts.lockedUntil = Date.now() + LOGIN_LOCKOUT_MS;
      _loginAttempts.count = 0;
      showErr('ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚5åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
    } else {
      const remaining = LOGIN_MAX_ATTEMPTS - _loginAttempts.count;
      showErr('ä¼šå“¡IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆæ®‹ã‚Š' + remaining + 'å›ï¼‰');
    }
    document.getElementById('f-pw').value = '';
    return;
  }

  // ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼
  const ok = await verifyPassword(pw, ac.pwSalt, ac.pwHash);
  if (!ok) {
    _loginAttempts.count++;
    if (_loginAttempts.count >= LOGIN_MAX_ATTEMPTS) {
      _loginAttempts.lockedUntil = Date.now() + LOGIN_LOCKOUT_MS;
      _loginAttempts.count = 0;
      showErr('ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚5åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
    } else {
      const remaining = LOGIN_MAX_ATTEMPTS - _loginAttempts.count;
      showErr('ä¼šå“¡IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆæ®‹ã‚Š' + remaining + 'å›ï¼‰');
    }
    document.getElementById('f-pw').value = '';
    return;
  }

  // æˆåŠŸ â†’ ã‚«ã‚¦ãƒ³ã‚¿ãƒªã‚»ãƒƒãƒˆ
  _loginAttempts.count = 0;
  startSession(id, ac, false);
}

// â”€â”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•´åˆæ€§ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HMACçš„ãªæ¤œè¨¼: SHA-256(userId:loginAt:pwHash) â†’ sessionToken
// æ”»æ’ƒè€…ã¯pwHashã‚’çŸ¥ã‚‰ãªã„ãŸã‚ã€æ­£ã—ã„sessionTokenã‚’ç”Ÿæˆã§ããªã„
async function computeSessionToken(userId, loginAt, pwHash) {
  const encoder = new TextEncoder();
  const data = encoder.encode(userId + ':' + loginAt + ':' + pwHash);
  const buf = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function startSession(id, ac, fromLine) {
  showLoading('ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');
  const loginAt = new Date().toISOString();
  const token   = await computeSessionToken(id, loginAt, ac.pwHash);

  const session = {
    agId:id, userId:id, name:ac.name,
    rank:ac.rank || 'HQ', rankKey:ac.rankKey || 'hq',
    type:ac.type, hqRole:ac.hqRole || null,
    sennin:ac.sennin || false,
    lineLinked:fromLine,
    loginAt:loginAt,
    sessionToken:token,   // â† æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæ”¹ã–ã‚“é˜²æ­¢ï¼‰
  };
  sessionStorage.setItem('coreto_session', JSON.stringify(session));
  // ã‚¿ã‚¤ãƒ—åˆ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆã“ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã¯å…¨å“¡ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘ã‘ãƒšãƒ¼ã‚¸ã¸ï¼‰
  // HQç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã¸ã¯ coreto-login-hq.html ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³
  let dest;
  if (ac.type === 'pt') dest = 'coreto-partner.html';
  else                   dest = 'coreto-agent-mypage.html'; // HQå«ã‚€å…¨å“¡
  window._sessionRedirect = setTimeout(() => { window.location.href = dest; }, 900);
}

function showLoading(msg) {
  document.getElementById('loading-msg').textContent = msg;
  document.getElementById('loading').classList.add('show');
}
</script>

<!-- â•â•â•â• ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« â•â•â•â• -->
<div id="reset-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);
     backdrop-filter:blur(5px);z-index:400;align-items:center;justify-content:center">
  <div style="background:var(--card);border:1px solid var(--border2);border-radius:16px;
              width:440px;max-width:95vw;overflow:hidden">

    <!-- ã‚¹ãƒ†ãƒƒãƒ—0: é€ä¿¡å…ˆé¸æŠ -->
    <div id="rst-s0">
      <div style="display:flex;align-items:center;justify-content:space-between;
                  padding:16px 22px;border-bottom:1px solid var(--border)">
        <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold)">
          ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š
        </div>
        <button onclick="closePasswordReset()"
                style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer">âœ•</button>
      </div>
      <div style="padding:20px 22px">
        <div style="font-size:12px;color:var(--sub);line-height:1.8;margin-bottom:16px;
                    padding:10px 14px;background:rgba(79,156,249,.07);
                    border:1px solid rgba(79,156,249,.2);border-radius:9px">
          â„¹ï¸ ç™»éŒ²æ¸ˆã¿ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å†è¨­å®šãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã™ã€‚<br>
          ãƒªãƒ³ã‚¯æœ‰åŠ¹æœŸé™ï¼š<strong style="color:var(--orange)">30åˆ†</strong>
        </div>

        <!-- IDå…¥åŠ› -->
        <div style="margin-bottom:14px">
          <label style="display:block;font-size:10px;color:var(--sub);margin-bottom:5px;font-weight:600">
            ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆID <span style="color:var(--red)">*</span>
          </label>
          <input type="text" id="rst-id" placeholder="ä¾‹ï¼š10012"
            style="width:100%;background:#090b13;border:1px solid var(--border2);border-radius:9px;
                   padding:10px 14px;color:var(--text);font-size:14px;font-family:'DM Mono',monospace;
                   outline:none;transition:.15s"
            oninput="lookupResetUser(this.value)" onfocus="this.style.borderColor='var(--blue)'"
            onblur="this.style.borderColor='var(--border2)'">
        </div>

        <!-- é€ä¿¡å…ˆï¼ˆIDç¢ºèªå¾Œã«è¡¨ç¤ºï¼‰ -->
        <div id="rst-methods" style="display:none">
          <div style="font-size:10px;color:var(--sub);margin-bottom:8px;font-weight:600">é€ä¿¡å…ˆ</div>
          <div style="margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:10px;padding:12px;
                     background:var(--card2);border:1px solid var(--border);
                     border-radius:10px">
              <span style="font-size:18px">ğŸ“§</span>
              <div>
                <div style="font-size:12px;font-weight:700">ãƒ¡ãƒ¼ãƒ«</div>
                <div style="font-size:10px;color:var(--muted)" id="rst-email-hint">ç™»éŒ²æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã«é€ä¿¡</div>
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closePasswordReset()"
            style="padding:8px 16px;border-radius:9px;font-size:11px;font-weight:700;cursor:pointer;
                   background:transparent;border:1px solid var(--border2);color:var(--sub);
                   font-family:'Noto Sans JP',sans-serif">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="rst-send-btn" onclick="sendResetLink()" disabled
            style="padding:8px 16px;border-radius:9px;font-size:11px;font-weight:700;cursor:pointer;
                   background:linear-gradient(135deg,var(--blue),#3070c0);color:#fff;border:none;
                   font-family:'Noto Sans JP',sans-serif;transition:.15s;opacity:.4">
            ğŸ“¨ ãƒªãƒ³ã‚¯ã‚’é€ä¿¡
          </button>
        </div>
      </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—1: èªè¨¼ã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
    <div id="rst-s1" style="display:none;padding:24px 22px;text-align:center">
      <div style="width:64px;height:64px;border-radius:50%;margin:0 auto 16px;
                  background:rgba(79,156,249,.1);border:2px solid rgba(79,156,249,.3);
                  display:flex;align-items:center;justify-content:center;font-size:28px">ğŸ’¬</div>
      <div style="font-size:14px;font-weight:700;margin-bottom:6px">èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
      <div style="font-size:11px;color:var(--sub);line-height:1.8;margin-bottom:16px" id="rst-otp-desc">
        LINEã«6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ
      </div>
      <div style="display:flex;gap:7px;justify-content:center;margin-bottom:12px">
        <input class="rst-otp" maxlength="1" type="text" inputmode="numeric"
               oninput="rstOtpIn(this,0)" onkeydown="rstOtpKey(event,0)" id="ro0">
        <input class="rst-otp" maxlength="1" type="text" inputmode="numeric"
               oninput="rstOtpIn(this,1)" onkeydown="rstOtpKey(event,1)" id="ro1">
        <input class="rst-otp" maxlength="1" type="text" inputmode="numeric"
               oninput="rstOtpIn(this,2)" onkeydown="rstOtpKey(event,2)" id="ro2">
        <input class="rst-otp" maxlength="1" type="text" inputmode="numeric"
               oninput="rstOtpIn(this,3)" onkeydown="rstOtpKey(event,3)" id="ro3">
        <input class="rst-otp" maxlength="1" type="text" inputmode="numeric"
               oninput="rstOtpIn(this,4)" onkeydown="rstOtpKey(event,4)" id="ro4">
        <input class="rst-otp" maxlength="1" type="text" inputmode="numeric"
               oninput="rstOtpIn(this,5)" onkeydown="rstOtpKey(event,5)" id="ro5">
      </div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:4px">
        æœ‰åŠ¹æœŸé™ï¼š<span id="rst-timer" style="font-family:'DM Mono',monospace;color:var(--orange);font-weight:700">5:00</span>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:16px" id="rst-demo-hint"></div>
      <button onclick="closePasswordReset()"
        style="padding:6px 14px;border-radius:8px;font-size:10px;font-weight:700;cursor:pointer;
               background:transparent;border:1px solid var(--border2);color:var(--sub);
               font-family:'Noto Sans JP',sans-serif">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—2: æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š -->
    <div id="rst-s2" style="display:none;padding:20px 22px">
      <div style="text-align:center;margin-bottom:16px">
        <span style="font-size:32px">ğŸ”‘</span>
        <div style="font-size:14px;font-weight:700;margin-top:8px">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š</div>
        <div style="font-size:11px;color:var(--green);margin-top:4px">âœ… æœ¬äººç¢ºèªå®Œäº†</div>
      </div>
      <div style="margin-bottom:12px">
        <label style="display:block;font-size:10px;color:var(--sub);margin-bottom:5px;font-weight:600">
          æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span style="color:var(--red)">*</span>
        </label>
        <input type="password" id="rst-pw1" placeholder="8æ–‡å­—ä»¥ä¸Š"
          style="width:100%;background:#090b13;border:1px solid var(--border2);border-radius:9px;
                 padding:10px 14px;color:var(--text);font-size:12px;
                 font-family:'Noto Sans JP',sans-serif;outline:none;transition:.15s"
          onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--border2)'">
      </div>
      <div style="margin-bottom:16px">
        <label style="display:block;font-size:10px;color:var(--sub);margin-bottom:5px;font-weight:600">
          ç¢ºèª
        </label>
        <input type="password" id="rst-pw2" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›"
          style="width:100%;background:#090b13;border:1px solid var(--border2);border-radius:9px;
                 padding:10px 14px;color:var(--text);font-size:12px;
                 font-family:'Noto Sans JP',sans-serif;outline:none;transition:.15s"
          onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--border2)'">
      </div>
      <button onclick="submitNewPw()"
        style="width:100%;padding:12px;background:linear-gradient(135deg,var(--gold),#a8742a);
               color:#0a0c10;border:none;border-radius:10px;font-size:13px;font-weight:700;
               cursor:pointer;font-family:'Noto Sans JP',sans-serif">
        ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹
      </button>
    </div>
  </div>
</div>

<style>
.rst-otp{width:46px;height:54px;background:#090b13;border:2px solid var(--border2);
  border-radius:9px;font-size:22px;font-weight:700;text-align:center;color:var(--text);
  font-family:'DM Mono',monospace;outline:none;transition:.15s}
.rst-otp:focus{border-color:var(--blue)}
.rst-otp.ok{border-color:var(--green);background:rgba(52,211,153,.05)}
.rst-otp.err{border-color:var(--red);animation:shake .3s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
</style>
<link rel="stylesheet" href="coreto-sp.css">

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ•ãƒ­ãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RESET_// â”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ã¯Kintone APIã«åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TODO: DB_CONFIG.USE_KINTONE = true ã«ã™ã‚‹ã¨Kintoneèªè¨¼ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹
// ç¾åœ¨ã¯localStorage/ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰èªè¨¼ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
USERS = {
  '10012': { email:'yama***@gmail.com', name:'å±±ç”° èª ' },
  '10008': { email:'sato***@gmail.com', name:'ä½è—¤ èŠ±å­' },
  '10023': { email:'suzu***@gmail.com', name:'éˆ´æœ¨ å¥å¤ª' },
  '20005': { email:'tana***@gmail.com', name:'ç”°ä¸­ ç¾ç©‚' },
  '30007': { email:'misa***@gmail.com', name:'ä½è—¤ ç¾å’²' },
};
// ã€Kintoneç§»è¡Œæ™‚ã€‘ä¸Šã®USERSå®šç¾©ã‚’å‰Šé™¤ã—ã€ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ–:
// async function loadUsers() {
//   const res = await kintone.api('/k/v1/records.json','GET',{app: DB_CONFIG.KINTONE_APPS.agents});
//   return Object.fromEntries(res.records.map(r => [r.id.value, {
//     name: r.name.value, email: r.email.value, line: r.line.value
//   }]));
// }
let _rstOtp='', _rstTimer=null, _rstCountdown=300;

function openPasswordReset() {
  document.getElementById('reset-overlay').style.display='flex';
  document.getElementById('rst-s0').style.display='block';
  document.getElementById('rst-s1').style.display='none';
  document.getElementById('rst-s2').style.display='none';
  document.getElementById('rst-id').value='';
  document.getElementById('rst-methods').style.display='none';
  const btn = document.getElementById('rst-send-btn');
  btn.disabled=true; btn.style.opacity='.4';
}
function closePasswordReset() {
  clearInterval(_rstTimer);
  document.getElementById('reset-overlay').style.display='none';
}
function lookupResetUser(val) {
  const user = RESET_USERS[val.trim()];
  const methods = document.getElementById('rst-methods');
  const sendBtn = document.getElementById('rst-send-btn');
  if (user) {
    methods.style.display='block';
    document.getElementById('rst-email-hint').textContent = user.email;
    sendBtn.disabled=false; sendBtn.style.opacity='1';
  } else {
    methods.style.display='none';
    sendBtn.disabled=true; sendBtn.style.opacity='.4';
  }
}
function sendResetLink() {
  const id = document.getElementById('rst-id').value.trim();
  const user = RESET_USERS[id];
  if (!user) return;
  document.getElementById('rst-s0').style.display='none';
  document.getElementById('rst-s1').style.display='block';
  _rstOtp = String(Math.floor(100000+Math.random()*900000));
  document.getElementById('rst-otp-desc').textContent = 'ãƒ¡ãƒ¼ãƒ«ï¼ˆ'+user.email+'ï¼‰ã«6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆ'+user.name+'æ§˜ï¼‰';
  document.getElementById('rst-demo-hint').textContent = 'ã€ãƒ‡ãƒ¢ç”¨ã‚³ãƒ¼ãƒ‰: '+_rstOtp+'ã€‘';
  document.getElementById('rst-timer').textContent = '5:00';
  document.getElementById('rst-timer').style.color = 'var(--orange)';
  for(let i=0;i<6;i++){const c=document.getElementById('ro'+i);c.value='';c.className='rst-otp';c.disabled=false;}
  clearInterval(_rstTimer); _rstCountdown=300;
  _rstTimer=setInterval(()=>{
    _rstCountdown--;
    const m=Math.floor(_rstCountdown/60),s=_rstCountdown%60;
    const el=document.getElementById('rst-timer');
    if(el){el.textContent=m+':'+String(s).padStart(2,'0');if(_rstCountdown<60)el.style.color='var(--red)';}
    if(_rstCountdown<=0){clearInterval(_rstTimer);for(let i=0;i<6;i++){const c=document.getElementById('ro'+i);if(c)c.disabled=true;}}
  },1000);
  setTimeout(()=>document.getElementById('ro0').focus(),100);
}
function rstOtpIn(el,idx){
  const v=el.value.replace(/\D/g,'');el.value=v;el.className='rst-otp';
  if(v&&idx<5)document.getElementById('ro'+(idx+1)).focus();
  if(idx===5&&v)rstCheckOtp();
}
function rstOtpKey(e,idx){if(e.key==='Backspace'&&!e.target.value&&idx>0)document.getElementById('ro'+(idx-1)).focus();}
function rstCheckOtp(){
  const entered=Array.from({length:6},(_,i)=>document.getElementById('ro'+i).value).join('');
  if(entered===_rstOtp){
    for(let i=0;i<6;i++)document.getElementById('ro'+i).className='rst-otp ok';
    clearInterval(_rstTimer);
    setTimeout(()=>{
      document.getElementById('rst-s1').style.display='none';
      document.getElementById('rst-s2').style.display='block';
    },500);
  } else {
    for(let i=0;i<6;i++)document.getElementById('ro'+i).className='rst-otp err';
    setTimeout(()=>{for(let i=0;i<6;i++){const c=document.getElementById('ro'+i);c.value='';c.className='rst-otp';}document.getElementById('ro0').focus();},800);
  }
}
function submitNewPw(){
  const pw1=document.getElementById('rst-pw1').value;
  const pw2=document.getElementById('rst-pw2').value;
  if(!pw1||pw1.length<8){alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(pw1!==pw2){alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');return;}
  clearInterval(_rstTimer);
  closePasswordReset();
  alert('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†è¨­å®šã—ã¾ã—ãŸã€‚\næ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
}
</script>

<script>
(function(){
  if(window.innerWidth > 768) return;
  document.querySelectorAll('input,select').forEach(function(el){
    if(parseFloat(window.getComputedStyle(el).fontSize) < 16) el.style.fontSize = '16px';
  });
  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã®ã‚ºãƒ¼ãƒ ã‚¤ãƒ³é˜²æ­¢
  var pwInput = document.getElementById('f-pw');
  if(pwInput) pwInput.style.fontSize = '16px';
  // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¿ãƒƒãƒ—ã‚¨ãƒªã‚¢æ‹¡å¤§
  var loginBtn = document.querySelector('.btn-login');
  if(loginBtn) { loginBtn.style.minHeight = '54px'; loginBtn.style.fontSize = '16px'; }
})();
</script>


<script src="coreto-sp-init.js"></script>
</body>
</html>
