<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CORETO â€” å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç®¡ç†ã€çµŒå–¶é™£å°‚ç”¨ã€‘</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Kaisei+Tokumin:wght@400;700&family=DM+Mono:wght@400;500&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0f14;--bg2:#13161e;--bg3:#1a1e29;
  --border:#252a38;--border2:#2e3447;
  --text:#e8eaf0;--sub:#8b90a8;--muted:#4a4f68;
  --gold:#c9a840;--gold2:#e8c85a;--gold-bg:rgba(201,168,64,.08);
  --re:#4fa3c8;--hr:#52c49a;--pt:#a78bfa;
  --red:#f87171;--green:#4ade80;--blue:#60a5fa;
  --exec:#f59e0b;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif}

/* Layout */
#layout{height:100vh;display:flex;flex-direction:column}
.hdr{flex-shrink:0;height:52px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px}
.hdr-logo{font-family:'Kaisei Tokumin',serif;font-size:17px;letter-spacing:3px;color:var(--gold)}
.hdr-badge{font-size:9px;padding:3px 8px;border-radius:4px;background:rgba(245,158,11,.12);color:var(--exec);border:1px solid rgba(245,158,11,.25);font-family:'DM Mono',monospace;letter-spacing:1.5px}
.hdr-btn{padding:6px 14px;border-radius:7px;border:1px solid var(--border2);background:transparent;color:var(--sub);font-size:11px;cursor:pointer;transition:.15s;font-family:'Noto Sans JP',sans-serif}
.hdr-btn:hover{border-color:var(--gold);color:var(--gold)}

/* Summary bar */
.summary-bar{flex-shrink:0;display:flex;background:var(--bg2);border-bottom:1px solid var(--border)}
.sum-item{flex:1;padding:10px 18px;border-right:1px solid var(--border)}
.sum-item:last-child{border-right:none}
.sum-label{font-size:9px;color:var(--muted);letter-spacing:2px;font-family:'DM Mono',monospace;margin-bottom:3px}
.sum-val{font-family:'DM Mono',monospace;font-size:18px;font-weight:500}

/* Toolbar */
.toolbar{flex-shrink:0;padding:10px 16px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.tb-search{flex:1;min-width:180px;max-width:280px}
.tb-search input{width:100%;padding:7px 12px;background:var(--bg3);border:1px solid var(--border2);border-radius:7px;color:var(--text);font-size:12px;font-family:'Noto Sans JP',sans-serif;outline:none}
.tb-search input:focus{border-color:var(--gold)}
.tb-search input::placeholder{color:var(--muted)}
.tb-filter select{padding:7px 12px;background:var(--bg3);border:1px solid var(--border2);border-radius:7px;color:var(--text);font-size:11px;font-family:'Noto Sans JP',sans-serif;outline:none;cursor:pointer;-webkit-appearance:none;padding-right:28px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%234a4f68' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center}
.tb-filter select:focus{border-color:var(--gold)}
.tb-spacer{flex:1}
.tb-count{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;white-space:nowrap}

/* Body: table + detail */
.body{flex:1;display:flex;overflow:hidden}

/* Table area */
.table-area{flex:1;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{position:sticky;top:0;background:var(--bg2);border-bottom:1px solid var(--border2);padding:10px 14px;text-align:left;font-size:9px;color:var(--muted);letter-spacing:2px;font-family:'DM Mono',monospace;white-space:nowrap;cursor:pointer;user-select:none}
thead th:hover{color:var(--sub)}
thead th.sort-asc::after{content:' â–²';font-size:8px;color:var(--gold)}
thead th.sort-desc::after{content:' â–¼';font-size:8px;color:var(--gold)}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s}
tbody tr:hover{background:var(--bg3)}
tbody tr.selected{background:var(--gold-bg)}
td{padding:10px 14px;vertical-align:middle}

.type-badge{font-size:9px;padding:2px 7px;border-radius:4px;font-family:'DM Mono',monospace;letter-spacing:.5px;white-space:nowrap}
.tb-re{background:rgba(79,163,200,.15);color:var(--re);border:1px solid rgba(79,163,200,.25)}
.tb-hr{background:rgba(82,196,154,.15);color:var(--hr);border:1px solid rgba(82,196,154,.25)}
.tb-pt{background:rgba(167,139,250,.15);color:var(--pt);border:1px solid rgba(167,139,250,.25)}
.rank-badge{font-size:9px;padding:2px 6px;border-radius:3px;font-family:'DM Mono',monospace}
.rb-platinum{background:rgba(201,168,64,.2);color:var(--gold2);border:1px solid rgba(201,168,64,.3)}
.rb-gold{background:rgba(234,179,8,.15);color:#facc15;border:1px solid rgba(234,179,8,.25)}
.rb-silver{background:rgba(148,163,184,.15);color:#94a3b8;border:1px solid rgba(148,163,184,.25)}
.rb-bronze{background:rgba(180,83,9,.15);color:#fb923c;border:1px solid rgba(180,83,9,.25)}
.rb-none{background:var(--border);color:var(--muted)}
.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:5px}
.s-active{background:var(--green)}
.s-inactive{background:var(--muted)}
.s-suspended{background:var(--red)}
.mono{font-family:'DM Mono',monospace;font-size:11px}

/* Detail panel */
.detail{width:340px;flex-shrink:0;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.detail.hidden{display:none}
.det-hdr{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.det-title{font-size:10px;color:var(--muted);letter-spacing:2px;font-family:'DM Mono',monospace}
.det-close{font-size:14px;color:var(--sub);cursor:pointer;background:none;border:none;padding:2px 6px}
.det-close:hover{color:var(--text)}
.det-body{flex:1;overflow-y:auto;padding:16px}
.det-name{font-family:'Kaisei Tokumin',serif;font-size:20px;font-weight:700;margin-bottom:4px}
.det-meta{font-size:11px;color:var(--sub);margin-bottom:16px}
.det-sec{font-size:9px;color:var(--muted);letter-spacing:2px;font-family:'DM Mono',monospace;text-transform:uppercase;margin:16px 0 8px}
.det-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);font-size:11px}
.det-row:last-child{border-bottom:none}
.det-row-l{color:var(--sub)}
.det-row-v{font-family:'DM Mono',monospace}
.det-row-v.gold{color:var(--gold2)}
.det-row-v.green{color:var(--green)}
.det-row-v.red{color:var(--red)}

/* Action buttons */
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px}
.act-btn{padding:9px 12px;border-radius:8px;border:1px solid var(--border2);background:var(--bg3);color:var(--sub);font-size:11px;cursor:pointer;transition:.15s;font-family:'Noto Sans JP',sans-serif;text-align:center}
.act-btn:hover{border-color:var(--border);color:var(--text)}
.act-btn.danger{border-color:rgba(248,113,113,.3);color:var(--red)}
.act-btn.danger:hover{background:rgba(248,113,113,.08)}
.act-btn.gold{border-color:rgba(201,168,64,.3);color:var(--gold)}
.act-btn.gold:hover{background:var(--gold-bg)}

/* Rank select */
.rank-select{width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border2);border-radius:7px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none;cursor:pointer;margin-top:4px}
.rank-select:focus{border-color:var(--gold)}

/* Confirm modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;display:none}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:14px;padding:24px;width:360px}
.modal-title{font-family:'Kaisei Tokumin',serif;font-size:18px;margin-bottom:8px}
.modal-body{font-size:12px;color:var(--sub);line-height:1.8;margin-bottom:20px}
.modal-btns{display:flex;gap:10px}
.modal-btn{flex:1;padding:10px;border-radius:8px;border:none;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:12px;font-weight:700}
.modal-cancel{background:var(--border);color:var(--sub)}
.modal-confirm{background:var(--red);color:#fff}
.modal-confirm.gold{background:var(--gold);color:#000}

::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* â”€â”€ ç´¹ä»‹ãƒªãƒ³ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
#ref-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:9000;align-items:center;justify-content:center}
#ref-modal-overlay.open{display:flex}
#ref-modal{background:var(--card);border:1px solid var(--border2);border-radius:16px;padding:0;width:min(460px,92vw);overflow:hidden}
.ref-mhdr{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ref-mhdr-t{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold)}
.ref-mbody{padding:20px}
.ref-url{background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:10px 12px;font-family:'DM Mono',monospace;font-size:11px;color:var(--sub);word-break:break-all;margin:10px 0;min-height:36px}
.ref-copy-btn{width:100%;padding:10px;border-radius:8px;border:none;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;background:var(--gold);color:#0a0c10;margin-top:4px}
.ref-copy-btn:hover{opacity:.9}

/* â”€â”€ ç´¹ä»‹ãƒªãƒ³ã‚¯ å·¦ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ â”€â”€ */
#ref-float-btn {
  position: fixed;
  left: 0;
  top: 50%;
  transform: translateY(-50%) translateX(-100%) rotate(-90deg);
  transform-origin: right bottom;
  z-index: 8000;
  background: rgba(201,168,76,.18);
  border: 1px solid rgba(201,168,76,.4);
  border-bottom: none;
  border-radius: 8px 8px 0 0;
  color: var(--gold);
  padding: 6px 16px;
  font-size: 11px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  white-space: nowrap;
  letter-spacing: .5px;
  transition: background .15s;
}
#ref-float-btn:hover { background: rgba(201,168,76,.32); }
</style>
</head>
<body>

<div id="layout">

<div class="hdr">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="hdr-logo">CORETO</div>
    <div class="hdr-badge">ğŸ‘ EXEC ONLY</div>
  </div>
  <div style="font-size:11px;color:var(--sub)">å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç®¡ç†</div>
  <div style="display:flex;gap:8px">
    <button class="hdr-btn" onclick="location.href='coreto-exec-dashboard.html'">ğŸ“ˆ P&amp;L</button>
    <button class="hdr-btn" onclick="location.href='coreto-hub.html'"><button onclick="openRefModal()" style="background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.35);color:var(--gold);border-radius:7px;padding:4px 12px;cursor:pointer;font-size:11px;font-weight:700;font-family:inherit;white-space:nowrap">ğŸ”— ç´¹ä»‹ãƒªãƒ³ã‚¯</button>
    <button
  </div>
</div>

<!-- Summary -->
<div class="summary-bar" id="summary-bar"></div>

<!-- Toolbar -->
<div class="toolbar">
  <div class="tb-search">
    <input type="text" id="search-input" placeholder="åå‰ãƒ»IDãƒ»ã‚¨ãƒªã‚¢ã§æ¤œç´¢..." oninput="filterTable()">
  </div>
  <div class="tb-filter">
    <select id="filter-type" onchange="filterTable()">
      <option value="">å…¨ã‚¿ã‚¤ãƒ—</option>
      <option value="re">ğŸ  ä¸å‹•ç”£AG</option>
      <option value="hr">ğŸ‘¥ äººæAG</option>
      <option value="pt">ğŸ¤ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</option>
    </select>
  </div>
  <div class="tb-filter">
    <select id="filter-rank" onchange="filterTable()">
      <option value="">å…¨ãƒ©ãƒ³ã‚¯</option>
      <option value="Platinum">Platinum</option>
      <option value="Gold">Gold</option>
      <option value="Silver">Silver</option>
      <option value="Bronze">Bronze</option>
    </select>
  </div>
  <div class="tb-filter">
    <select id="filter-status" onchange="filterTable()">
      <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
      <option value="active">ç¨¼åƒä¸­</option>
      <option value="inactive">ä¼‘çœ </option>
      <option value="suspended">åœæ­¢</option>
    </select>
  </div>
  <div class="tb-spacer"></div>
  <div class="tb-count" id="tb-count">â€” ä»¶è¡¨ç¤ºä¸­</div>
</div>

<!-- Body -->
<div class="body">
  <div class="table-area">
    <table id="agent-table">
      <thead>
        <tr>
          <th onclick="sortBy('id')">ID</th>
          <th onclick="sortBy('name')">æ°å</th>
          <th onclick="sortBy('type')">ã‚¿ã‚¤ãƒ—</th>
          <th onclick="sortBy('rank')">ãƒ©ãƒ³ã‚¯</th>
          <th onclick="sortBy('status')">çŠ¶æ…‹</th>
          <th onclick="sortBy('joined')">å‚åŠ æ—¥</th>
          <th onclick="sortBy('cases')">æˆç´„ä»¶æ•°</th>
          <th onclick="sortBy('totalRev')">ç´¯è¨ˆå£²ä¸Š</th>
          <th onclick="sortBy('monthRev')">ä»Šæœˆå£²ä¸Š</th>
          <th>ç´¹ä»‹è€…</th>
          <th onclick="sortBy('network')">å‚˜ä¸‹</th>
          <th>æœˆä¼šè²»</th>
        </tr>
      </thead>
      <tbody id="agent-tbody"></tbody>
    </table>
  </div>

  <div class="detail hidden" id="detail-panel">
    <div class="det-hdr">
      <div class="det-title">AGENT DETAIL</div>
      <button class="det-close" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="det-body" id="det-body"></div>
  </div>
</div>

</div><!-- /layout -->

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-title" id="modal-title"></div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-btns">
      <button class="modal-btn modal-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn modal-confirm" id="modal-confirm">å®Ÿè¡Œ</button>
    </div>
  </div>
</div>

<script>
// â•â• AUTH GUARD (çµŒå–¶é™£å°‚ç”¨) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  var s = null;
  try { s = JSON.parse(sessionStorage.getItem('coreto_session') || 'null'); } catch(e) {}
  var HQ_LEVEL = { exec: 3, manager: 2, staff: 1 };
  if (!s || s.type !== 'hq' || (HQ_LEVEL[s.hqRole] || 0) < 3) { location.replace('coreto-hub.html'); }
  window._SESSION = s;
})();

// â”€ Demo data â”€
const AGENTS = [
  { id:'10008', name:'ä½è—¤ èŠ±å­', kana:'ã‚µãƒˆã‚¦ ãƒãƒŠã‚³',  type:'re', rank:'Platinum', status:'active', joined:'2024-01-15',
    cases:98, totalRev:18500000, monthRev:1800000, sennin:true, takken:'æ±äº¬(2)098765',
    referredBy:null, network:5, area:'å“å·ãƒ»æ¸‹è°·ãƒ»æ¸¯åŒº', email:'sato@example.com', tel:'090-1234-5678',
    monthlyFee:0, note:'å£²ä¸ŠNo.1ã€‚å°‚ä»»å®…å»ºå£«ã€‚ãƒ¡ãƒ³ã‚¿ãƒ¼å®Ÿç¸¾5åã€‚é«˜é¡ç‰©ä»¶ã«å¼·ã¿ã€‚' },

  { id:'10012', name:'å±±ç”° èª ',   kana:'ãƒ¤ãƒãƒ€ ãƒã‚³ãƒˆ',  type:'re', rank:'Gold',     status:'active', joined:'2024-03-01',
    cases:52, totalRev:9800000, monthRev:1200000, sennin:true, takken:'æ±äº¬(1)123456',
    referredBy:null, network:3, area:'æ¸‹è°·ãƒ»æ–°å®¿ãƒ»æ¸¯åŒº', email:'yamada@example.com', tel:'090-2345-6789',
    monthlyFee:0, note:'å‰µæ¥­æœŸã‹ã‚‰ã®ä¸­æ ¸ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚å°‚ä»»å®…å»ºå£«ã€‚' },

  { id:'10031', name:'å°æ— ä¿Šä»‹', kana:'ã‚³ãƒãƒ¤ã‚· ã‚·ãƒ¥ãƒ³ã‚¹ã‚±', type:'re', rank:'Gold', status:'active', joined:'2024-05-10',
    cases:41, totalRev:7200000, monthRev:1000000, sennin:false, takken:null,
    referredBy:'10008', network:2, area:'ç›®é»’ãƒ»ä¸–ç”°è°·', email:'kobayashi@example.com', tel:'080-3456-7890',
    monthlyFee:0, note:'ä½è—¤èŠ±å­ãŒç´¹ä»‹ã€‚å£²è²·å°‚é–€ã€‚é«˜é¡æ¡ˆä»¶å¤šæ•°ã€‚' },

  { id:'20005', name:'ç”°ä¸­ ç¾ç©‚', kana:'ã‚¿ãƒŠã‚« ãƒŸãƒ›',    type:'hr', rank:'Gold',     status:'active', joined:'2024-02-20',
    cases:44, totalRev:8400000, monthRev:860000, sennin:false, takken:null,
    referredBy:null, network:3, area:'æ±äº¬å…¨åŸŸ', email:'tanaka@example.com', tel:'090-5678-9012',
    monthlyFee:0, note:'äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒˆãƒƒãƒ—ã€‚ITãƒ»å¤–è³‡ç³»å°‚é–€ã€‚' },

  { id:'10023', name:'éˆ´æœ¨ å¥å¤ª', kana:'ã‚¹ã‚ºã‚­ ã‚±ãƒ³ã‚¿',  type:'re', rank:'Silver',   status:'active', joined:'2024-07-15',
    cases:24, totalRev:3800000, monthRev:720000, sennin:false, takken:null,
    referredBy:'10012', network:2, area:'æ¸‹è°·ãƒ»æ–°å®¿', email:'suzuki@example.com', tel:'090-6789-0123',
    monthlyFee:490, note:'å±±ç”°èª ãŒç´¹ä»‹ã€‚æˆé•·ä¸­ã€‚' },

  { id:'20010', name:'æ¾æœ¬ ç”±ç¾', kana:'ãƒãƒ„ãƒ¢ãƒˆ ãƒ¦ãƒŸ',  type:'hr', rank:'Silver',   status:'active', joined:'2024-08-01',
    cases:18, totalRev:3600000, monthRev:560000, sennin:false, takken:null,
    referredBy:'10008', network:2, area:'æ±äº¬ãƒ»ç¥å¥ˆå·', email:'matsumoto@example.com', tel:'080-7890-1234',
    monthlyFee:490, note:'ä½è—¤èŠ±å­ãŒç´¹ä»‹ã€‚ITæ¥­ç•Œå°‚é–€ã€‚' },

  { id:'10041', name:'æ¸¡è¾º éš†',   kana:'ãƒ¯ã‚¿ãƒŠãƒ™ ã‚¿ã‚«ã‚·', type:'re', rank:'Bronze',  status:'active', joined:'2025-01-10',
    cases:8, totalRev:1200000, monthRev:240000, sennin:true, takken:'åŸ¼ç‰(1)234567',
    referredBy:'10012', network:1, area:'ã•ã„ãŸã¾ãƒ»å·å£', email:'watanabe@example.com', tel:'090-8901-2345',
    monthlyFee:0, note:'å±±ç”°èª ãŒç´¹ä»‹ã€‚å°‚ä»»å®…å»ºå£«ã€‚' },

  { id:'10048', name:'å‰ç”° å¤§è¼”', kana:'ãƒ¨ã‚·ãƒ€ ãƒ€ã‚¤ã‚¹ã‚±', type:'re', rank:'Silver',  status:'active', joined:'2024-09-20',
    cases:16, totalRev:2600000, monthRev:490000, sennin:false, takken:null,
    referredBy:'10031', network:0, area:'æ¨ªæµœãƒ»å·å´', email:'yoshida@example.com', tel:'080-9012-3456',
    monthlyFee:490, note:'å°æ—ä¿Šä»‹ãŒç´¹ä»‹ã€‚ç¥å¥ˆå·ã‚¨ãƒªã‚¢æ‹…å½“ã€‚' },

  { id:'20015', name:'é«˜æ©‹ èª ',   kana:'ã‚¿ã‚«ãƒã‚· ãƒã‚³ãƒˆ', type:'hr', rank:'Bronze', status:'active', joined:'2025-02-15',
    cases:8, totalRev:1440000, monthRev:280000, sennin:false, takken:null,
    referredBy:'20010', network:0, area:'æ±äº¬å…¨åŸŸ', email:'takahashi@example.com', tel:'090-0123-4567',
    monthlyFee:980, note:'æ¾æœ¬ç”±ç¾ãŒç´¹ä»‹ã€‚è£½é€ ãƒ»åŒ»ç™‚æ¥­ç•Œæ‹…å½“ã€‚' },

  { id:'10055', name:'æ— å¥ˆç·’',   kana:'ãƒãƒ¤ã‚· ãƒŠã‚ª',    type:'re', rank:'Bronze',  status:'active', joined:'2025-04-01',
    cases:4, totalRev:700000, monthRev:150000, sennin:false, takken:null,
    referredBy:'10023', network:0, area:'æ¸‹è°·ãƒ»ç›®é»’', email:'hayashi@example.com', tel:'080-1234-5679',
    monthlyFee:980, note:'éˆ´æœ¨å¥å¤ªãŒç´¹ä»‹ã€‚éƒ½å†…è³ƒè²¸å°‚é–€ã€‚' },

  { id:'20022', name:'æœ¨æ‘ ã•ãã‚‰', kana:'ã‚­ãƒ ãƒ© ã‚µã‚¯ãƒ©', type:'hr', rank:'Silver', status:'active', joined:'2024-09-05',
    cases:12, totalRev:2210000, monthRev:430000, sennin:false, takken:null,
    referredBy:'20005', network:1, area:'æ±äº¬å…¨åŸŸ', email:'kimura@example.com', tel:'090-2345-6780',
    monthlyFee:490, note:'ç”°ä¸­ç¾ç©‚ãŒç´¹ä»‹ã€‚ãƒ™ãƒ³ãƒãƒ£ãƒ¼å°‚é–€ã€‚' },

  { id:'30007', name:'ä½è—¤ ç¾å’²', kana:'ã‚µãƒˆã‚¦ ãƒŸã‚µã‚­',  type:'pt', rank:null,      status:'active', joined:'2024-10-15',
    cases:11, totalRev:920000, monthRev:80000, sennin:false, takken:null,
    referredBy:'10031', network:0, area:'æ±äº¬å…¨åŸŸ', email:'misaki@example.com', tel:'080-3456-7891',
    monthlyFee:0, note:'å°æ—ä¿Šä»‹ãŒç´¹ä»‹ã€‚ä¸å‹•ç”£æ¥­è€…ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã€‚' },

  { id:'30012', name:'ä¼Šè—¤ èª ä¸€', kana:'ã‚¤ãƒˆã‚¦ ã‚»ã‚¤ã‚¤ãƒ', type:'pt', rank:null,     status:'active', joined:'2025-03-10',
    cases:6, totalRev:480000, monthRev:60000, sennin:false, takken:null,
    referredBy:'10023', network:0, area:'æ±äº¬ãƒ»åŸ¼ç‰', email:'ito@example.com', tel:'090-4567-8902',
    monthlyFee:0, note:'éˆ´æœ¨å¥å¤ªãŒç´¹ä»‹ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€‚ä¸å‹•ç”£ã‚ªãƒ¼ãƒŠãƒ¼ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€‚' },

  { id:'10062', name:'ä¸­æ‘ äº®',   kana:'ãƒŠã‚«ãƒ ãƒ© ãƒªãƒ§ã‚¦', type:'re', rank:'Bronze', status:'inactive', joined:'2025-06-01',
    cases:3, totalRev:485000, monthRev:0, sennin:false, takken:null,
    referredBy:'10041', network:0, area:'æ¸¯åŒºãƒ»å…­æœ¬æœ¨', email:'nakamura@example.com', tel:'080-5678-9013',
    monthlyFee:980, note:'æ¸¡è¾ºéš†ãŒç´¹ä»‹ã€‚3ãƒ¶æœˆæ¡ˆä»¶ãªã—ã€‚ãƒ•ã‚©ãƒ­ãƒ¼è¦ã€‚' },

  { id:'20031', name:'ç¦ç”° é›„ä»‹', kana:'ãƒ•ã‚¯ãƒ€ ãƒ¦ã‚¦ã‚¹ã‚±', type:'hr', rank:'Bronze', status:'suspended', joined:'2025-05-15',
    cases:6, totalRev:1040000, monthRev:0, sennin:false, takken:null,
    referredBy:'20022', network:0, area:'æ±äº¬å…¨åŸŸ', email:'fukuda@example.com', tel:'090-6789-0124',
    monthlyFee:980, note:'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢ä¸­ã€‚è¦ç´„é•åã®ç–‘ã„ã€‚è¦ç¢ºèªã€‚' },

  { id:'30022', name:'æ©‹æœ¬ å…‰å¤«', kana:'ãƒã‚·ãƒ¢ãƒˆ ãƒŸãƒ„ã‚ª', type:'pt', rank:null,     status:'active', joined:'2025-01-20',
    cases:3, totalRev:280000, monthRev:30000, sennin:false, takken:null,
    referredBy:'20005', network:0, area:'æ±äº¬å…¨åŸŸ', email:'hashimoto@example.com', tel:'080-7890-1235',
    monthlyFee:0, note:'ç”°ä¸­ç¾ç©‚ãŒç´¹ä»‹ã€‚äººæä¼šç¤¾OBãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€‚' },
];

const byId = {};
AGENTS.forEach(a=>byId[a.id]=a);

const TYPE_LABEL = { re:'ğŸ  ä¸å‹•ç”£AG', hr:'ğŸ‘¥ äººæAG', pt:'ğŸ¤ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼' };
const TYPE_COLOR = { re:'var(--re)', hr:'var(--hr)', pt:'var(--pt)' };
const RANK_CLASS = { Platinum:'rb-platinum', Gold:'rb-gold', Silver:'rb-silver', Bronze:'rb-bronze' };
const RANK_ORDER = { Platinum:4, Gold:3, Silver:2, Bronze:1, 'â€”':0 };
const STATUS_LABEL = { active:'ç¨¼åƒä¸­', inactive:'ä¼‘çœ ', suspended:'åœæ­¢' };
const STATUS_DOT   = { active:'s-active', inactive:'s-inactive', suspended:'s-suspended' };

function yen(v) {
  if(v===0) return 'â€”';
  return 'Â¥'+v.toLocaleString();
}

// â”€ Summary bar â”€
function buildSummary() {
  const active = AGENTS.filter(a=>a.status==='active').length;
  const re = AGENTS.filter(a=>a.type==='re').length;
  const hr = AGENTS.filter(a=>a.type==='hr').length;
  const pt = AGENTS.filter(a=>a.type==='pt').length;
  const totalRev = AGENTS.reduce((s,a)=>s+a.totalRev,0);
  const monthRev = AGENTS.reduce((s,a)=>s+a.monthRev,0);
  const suspended = AGENTS.filter(a=>a.status==='suspended').length;
  document.getElementById('summary-bar').innerHTML = [
    ['TOTAL', AGENTS.length+'å','var(--text)'],
    ['ç¨¼åƒä¸­', active+'å','var(--green)'],
    ['RE / HR / PT', `${re} / ${hr} / ${pt}`,'var(--sub)'],
    ['ç´¯è¨ˆå£²ä¸Šåˆè¨ˆ', yen(totalRev),'var(--gold2)'],
    ['ä»Šæœˆå£²ä¸Šåˆè¨ˆ', yen(monthRev),'var(--blue)'],
    ['åœæ­¢ä¸­', suspended+'å', suspended>0?'var(--red)':'var(--muted)'],
  ].map(([l,v,c])=>`<div class="sum-item"><div class="sum-label">${l}</div><div class="sum-val" style="color:${c}">${v}</div></div>`).join('');
}

// â”€ Table â”€
let sortKey = 'totalRev', sortDir = -1;
let selected = null;

function sortBy(key) {
  if(sortKey===key) sortDir*=-1;
  else { sortKey=key; sortDir=-1; }
  document.querySelectorAll('thead th').forEach(th=>{
    th.classList.remove('sort-asc','sort-desc');
  });
  // find th by onclick
  document.querySelectorAll('thead th').forEach(th=>{
    if(th.getAttribute('onclick')==='sortBy(\''+key+'\')')
      th.classList.add(sortDir===1?'sort-asc':'sort-desc');
  });
  renderTable();
}

function getFiltered() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const type = document.getElementById('filter-type').value;
  const rank = document.getElementById('filter-rank').value;
  const status = document.getElementById('filter-status').value;
  return AGENTS.filter(a => {
    if(type && a.type!==type) return false;
    if(rank && a.rank!==rank) return false;
    if(status && a.status!==status) return false;
    if(q && !a.name.includes(q) && !a.kana.includes(q) && !a.id.includes(q) && !(a.area||'').includes(q)) return false;
    return true;
  }).sort((a,b) => {
    let av = a[sortKey], bv = b[sortKey];
    if(sortKey==='rank') { av=RANK_ORDER[a.rank||'â€”']; bv=RANK_ORDER[b.rank||'â€”']; }
    if(av===null||av===undefined) av='';
    if(bv===null||bv===undefined) bv='';
    if(av<bv) return sortDir;
    if(av>bv) return -sortDir;
    return 0;
  });
}

function filterTable() { renderTable(); }

function renderTable() {
  const rows = getFiltered();
  document.getElementById('tb-count').textContent = rows.length+'ä»¶è¡¨ç¤ºä¸­';
  document.getElementById('agent-tbody').innerHTML = rows.map(a => {
    const refAgent = a.referredBy ? byId[a.referredBy] : null;
    const rankHtml = a.rank
      ? `<span class="rank-badge ${RANK_CLASS[a.rank]||''}">${a.rank}</span>`
      : `<span class="rank-badge rb-none">â€”</span>`;
    const statusHtml = `<span class="status-dot ${STATUS_DOT[a.status]||''}"></span>${STATUS_LABEL[a.status]||a.status}`;
    const feeHtml = a.monthlyFee > 0
      ? `<span style="color:var(--re);font-family:'DM Mono',monospace">Â¥${a.monthlyFee.toLocaleString()}</span>`
      : `<span style="color:var(--muted)">ç„¡æ–™</span>`;
    return `<tr onclick="selectAgent('${a.id}')" class="${selected===a.id?'selected':''}">
      <td class="mono">${a.id}</td>
      <td style="font-weight:500">${a.name}</td>
      <td><span class="type-badge tb-${a.type}">${TYPE_LABEL[a.type]}</span></td>
      <td>${rankHtml}</td>
      <td style="font-size:11px">${statusHtml}</td>
      <td class="mono">${a.joined}</td>
      <td class="mono">${a.cases}ä»¶</td>
      <td class="mono" style="color:var(--gold2)">${yen(a.totalRev)}</td>
      <td class="mono" style="color:${a.monthRev>0?'var(--blue)':'var(--muted)'}">${yen(a.monthRev)}</td>
      <td style="font-size:11px;color:var(--sub)">${refAgent?refAgent.name:'å¤–éƒ¨å¿œå‹Ÿ'}</td>
      <td class="mono">${a.network>0?a.network+'å':'â€”'}</td>
      <td>${feeHtml}</td>
    </tr>`;
  }).join('');
}

// â”€ Detail â”€
function selectAgent(id) {
  selected = id;
  renderTable();
  showDetail(id);
}

function showDetail(id) {
  const a = byId[id];
  if(!a) return;
  const panel = document.getElementById('detail-panel');
  panel.classList.remove('hidden');
  const ref = a.referredBy ? byId[a.referredBy] : null;
  const rankClass = a.rank ? RANK_CLASS[a.rank] : 'rb-none';

  const rankOptions = ['Platinum','Gold','Silver','Bronze'].map(r=>
    `<option value="${r}" ${a.rank===r?'selected':''}>${r}</option>`
  ).join('');

  document.getElementById('det-body').innerHTML = `
    <div>
      <div style="display:flex;gap:6px;margin-bottom:6px">
        <span class="type-badge tb-${a.type}">${TYPE_LABEL[a.type]}</span>
        ${a.rank?`<span class="rank-badge ${rankClass}">${a.rank}</span>`:''}
        <span style="font-size:10px;padding:2px 7px;border-radius:4px;background:var(--border);color:${a.status==='active'?'var(--green)':a.status==='suspended'?'var(--red)':'var(--muted)'}">${STATUS_LABEL[a.status]}</span>
      </div>
      <div class="det-name">${a.name}</div>
      <div class="det-meta">#${a.id} Â· å‚åŠ  ${a.joined}${a.sennin?' Â· å°‚ä»»å®…å»ºå£«':''}</div>
      ${a.note?`<div style="font-size:11px;color:var(--sub);background:var(--bg3);padding:8px 10px;border-radius:7px;line-height:1.8;margin-bottom:4px">${a.note}</div>`:''}
    </div>

    <div class="det-sec">é€£çµ¡å…ˆ</div>
    <div class="det-row"><div class="det-row-l">ãƒ¡ãƒ¼ãƒ«</div><div class="det-row-v">${a.email}</div></div>
    <div class="det-row"><div class="det-row-l">é›»è©±</div><div class="det-row-v">${a.tel}</div></div>
    <div class="det-row"><div class="det-row-l">å¾—æ„ã‚¨ãƒªã‚¢</div><div class="det-row-v" style="color:var(--sub)">${a.area||'â€”'}</div></div>
    ${a.takken?`<div class="det-row"><div class="det-row-l">å®…å»ºå£«è¨¼</div><div class="det-row-v" style="font-size:10px">${a.takken}</div></div>`:''}

    <div class="det-sec">å®Ÿç¸¾</div>
    <div class="det-row"><div class="det-row-l">ç´¯è¨ˆå£²ä¸Š</div><div class="det-row-v gold">${yen(a.totalRev)}</div></div>
    <div class="det-row"><div class="det-row-l">ä»Šæœˆå£²ä¸Š</div><div class="det-row-v" style="color:var(--blue)">${yen(a.monthRev)}</div></div>
    <div class="det-row"><div class="det-row-l">æˆç´„ä»¶æ•°</div><div class="det-row-v">${a.cases}ä»¶</div></div>
    <div class="det-row"><div class="det-row-l">å‚˜ä¸‹äººæ•°</div><div class="det-row-v">${a.network>0?a.network+'å':'â€”'}</div></div>
    <div class="det-row"><div class="det-row-l">æœˆä¼šè²»</div><div class="det-row-v ${a.monthlyFee>0?'red':'green'}">${a.monthlyFee>0?'Â¥'+a.monthlyFee.toLocaleString():'ç„¡æ–™'}</div></div>
    <div class="det-row"><div class="det-row-l">ç´¹ä»‹è€…</div><div class="det-row-v" style="color:var(--sub)">${ref?ref.name+' (#'+ref.id+')':'å¤–éƒ¨å¿œå‹Ÿ'}</div></div>

    ${a.type!=='pt'?`
    <div class="det-sec">ãƒ©ãƒ³ã‚¯å¤‰æ›´</div>
    <select class="rank-select" id="rank-select-${a.id}" onchange="confirmRankChange('${a.id}',this.value)">
      ${rankOptions}
    </select>
    <div style="font-size:10px;color:var(--muted);margin-top:4px">å¤‰æ›´ã¯å³æ™‚åæ˜ ã•ã‚Œã¾ã™ï¼ˆãƒ­ã‚°è¨˜éŒ²ã‚ã‚Šï¼‰</div>
    `:''}

    <div class="det-sec">æ“ä½œ</div>
    <div class="action-grid">
      ${a.status==='active'
        ? `<button class="act-btn" onclick="confirmAction('${a.id}','deactivate')">ğŸ˜´ ä¼‘çœ ã«ã™ã‚‹</button>
           <button class="act-btn danger" onclick="confirmAction('${a.id}','suspend')">ğŸš« ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢</button>`
        : a.status==='suspended'
        ? `<button class="act-btn gold" onclick="confirmAction('${a.id}','restore')">âœ… åœæ­¢è§£é™¤</button>
           <button class="act-btn danger" onclick="confirmAction('${a.id}','terminate')">ğŸ—‘ é™¤åå‡¦ç†</button>`
        : `<button class="act-btn gold" onclick="confirmAction('${a.id}','restore')">âœ… ç¨¼åƒã«æˆ»ã™</button>
           <button class="act-btn danger" onclick="confirmAction('${a.id}','suspend')">ğŸš« ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢</button>`
      }
      <button class="act-btn" onclick="confirmAction('${a.id}','senninToggle')" ${a.type!=='re'?'disabled style="opacity:.4"':''}>
        ${a.sennin?'ğŸ  å°‚ä»»è§£é™¤':'ğŸ  å°‚ä»»ç™»éŒ²'}
      </button>
      <button class="act-btn" onclick="window.open('coreto-network-tree.html','_blank')">ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèª</button>
    </div>
  `;
}

function closeDetail() {
  selected = null;
  document.getElementById('detail-panel').classList.add('hidden');
  renderTable();
}

// â”€ Actions â”€
let pendingAction = null;

const ACTION_DEFS = {
  suspend:       { title:'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢', body:(a)=>`<strong>${a.name}</strong> (#${a.id}) ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åœæ­¢ã—ã¾ã™ã€‚<br>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚ã“ã®æ“ä½œã¯ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚`, confirm:'åœæ­¢ã™ã‚‹', cls:'' },
  deactivate:    { title:'ä¼‘çœ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¤‰æ›´', body:(a)=>`<strong>${a.name}</strong> ã‚’ä¼‘çœ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¤‰æ›´ã—ã¾ã™ã€‚<br>æ¡ˆä»¶ã®æ–°è¦å—ä»˜ãŒåœæ­¢ã•ã‚Œã¾ã™ã€‚`, confirm:'ä¼‘çœ ã«ã™ã‚‹', cls:'gold' },
  restore:       { title:'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¾©æ—§', body:(a)=>`<strong>${a.name}</strong> ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¨¼åƒä¸­ã«æˆ»ã—ã¾ã™ã€‚`, confirm:'å¾©æ—§ã™ã‚‹', cls:'gold' },
  terminate:     { title:'é™¤åå‡¦ç†', body:(a)=>`<strong>${a.name}</strong> ã‚’å®Œå…¨ã«é™¤åã—ã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚Œã¾ã™ã€‚`, confirm:'é™¤åã™ã‚‹', cls:'' },
  senninToggle:  { title:'å°‚ä»»å®…å»ºå£« ç™»éŒ²/è§£é™¤', body:(a)=>`<strong>${a.name}</strong> ã®å°‚ä»»å®…å»ºå£«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã—ã¾ã™ã€‚<br>æœˆä¼šè²»ãƒ»ååˆºè²»ã«å½±éŸ¿ã—ã¾ã™ã€‚`, confirm:'å¤‰æ›´ã™ã‚‹', cls:'gold' },
};

function confirmAction(id, action) {
  const a = byId[id];
  const def = ACTION_DEFS[action];
  if(!def) return;
  pendingAction = { id, action };
  document.getElementById('modal-title').textContent = def.title;
  document.getElementById('modal-body').innerHTML = def.body(a);
  const btn = document.getElementById('modal-confirm');
  btn.textContent = def.confirm;
  btn.className = 'modal-btn modal-confirm' + (def.cls?' '+def.cls:'');
  document.getElementById('modal').style.display = 'flex';
}

function confirmRankChange(id, newRank) {
  const a = byId[id];
  pendingAction = { id, action:'rankChange', newRank };
  document.getElementById('modal-title').textContent = 'ãƒ©ãƒ³ã‚¯å¤‰æ›´';
  document.getElementById('modal-body').innerHTML = `<strong>${a.name}</strong> ã®ãƒ©ãƒ³ã‚¯ã‚’ <strong>${a.rank}</strong> â†’ <strong>${newRank}</strong> ã«å¤‰æ›´ã—ã¾ã™ã€‚<br>æœˆä¼šè²»ãƒ»å ±é…¬ç‡ã«å³æ™‚åæ˜ ã•ã‚Œã¾ã™ã€‚`;
  const btn = document.getElementById('modal-confirm');
  btn.textContent = 'å¤‰æ›´ã™ã‚‹';
  btn.className = 'modal-btn modal-confirm gold';
  document.getElementById('modal').style.display = 'flex';
}

document.getElementById('modal-confirm').addEventListener('click', () => {
  if(!pendingAction) return;
  const a = byId[pendingAction.id];
  if(!a) return;
  const { action, newRank } = pendingAction;
  if(action==='suspend')      a.status='suspended';
  else if(action==='deactivate') a.status='inactive';
  else if(action==='restore')    a.status='active';
  else if(action==='terminate')  { delete byId[a.id]; AGENTS.splice(AGENTS.indexOf(a),1); }
  else if(action==='senninToggle') a.sennin=!a.sennin;
  else if(action==='rankChange') { a.rank=newRank; a.monthlyFee={Platinum:0,Gold:0,Silver:490,Bronze:980}[newRank]||0; }
  closeModal();
  buildSummary();
  renderTable();
  if(selected && byId[selected]) showDetail(selected);
  else closeDetail();
});

function closeModal() {
  document.getElementById('modal').style.display = 'none';
  pendingAction = null;
  // reset rank select if aborted
  if(selected && byId[selected]) {
    const sel = document.getElementById('rank-select-'+selected);
    if(sel) sel.value = byId[selected].rank;
  }
}

// â”€ Init â”€
buildSummary();
renderTable();

// â”€â”€ ç´¹ä»‹ãƒªãƒ³ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _refCurrentCode = '';
function openRefModal() {
  var overlay = document.getElementById('ref-modal-overlay');
  var selector = document.getElementById('ref-code-selector');
  var isExec = (typeof session !== 'undefined' && session && session.hqRole === 'exec')
            || (typeof CURRENT_USER !== 'undefined' && CURRENT_USER && CURRENT_USER.hqRole === 'exec');
  var agentId = (typeof session !== 'undefined' && session && session.userId) ? session.userId
              : (typeof ME !== 'undefined' && ME && ME.id) ? ME.id
              : (typeof AGENT !== 'undefined' && AGENT && AGENT.id) ? AGENT.id : '10012';
  if (isExec) {
    var SPECIAL = ['FOUNDER2026','WELCOME2026','GOLD_START','HR_PRO75'];
    var opts = SPECIAL.map(function(c){ return '<option value="'+c+'">â­ '+c+'</option>'; }).join('');
    selector.innerHTML =
      '<div style="margin-bottom:12px"><div style="font-size:10px;color:var(--sub);font-weight:600;margin-bottom:5px">ã‚³ãƒ¼ãƒ‰ç¨®åˆ¥</div>'
      +'<select id="ref-code-select" onchange="updateRefLink()" style="width:100%;padding:8px 10px;background:var(--card2);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-size:12px;font-family:inherit">'
      +'<option value="'+agentId+'">è‡ªåˆ†ã®IDï¼ˆ'+agentId+'ï¼‰</option>'
      +'<optgroup label="â”€â”€ ç‰¹åˆ¥ã‚³ãƒ¼ãƒ‰ â”€â”€">'+opts+'</optgroup>'
      +'</select></div>';
    _refCurrentCode = agentId;
  } else {
    selector.innerHTML =
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px">'
      +'<span style="font-size:11px;color:var(--muted)">ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼š</span>'
      +'<span style="font-family:\'DM Mono\',monospace;font-size:13px;font-weight:700;color:var(--gold)">'+agentId+'</span>'
      +'</div>';
    _refCurrentCode = agentId;
  }
  updateRefLink();
  overlay.classList.add('open');
}
function updateRefLink() {
  var sel = document.getElementById('ref-code-select');
  if (sel) _refCurrentCode = sel.value;
  var base = location.origin + location.pathname.replace(/[^/]*$/, '') + 'coreto-agent-signup.html';
  var url = base + '?ref=' + encodeURIComponent(_refCurrentCode);
  document.getElementById('ref-url-display').textContent = url;
}
function closeRefModal() {
  document.getElementById('ref-modal-overlay').classList.remove('open');
}
function copyRefLink() {
  var url = document.getElementById('ref-url-display').textContent;
  navigator.clipboard.writeText(url).then(function() {
    var btn = document.querySelector('.ref-copy-btn');
    btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
    setTimeout(function(){ btn.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼'; }, 2000);
  }).catch(function() {
    var ta = document.createElement('textarea');
    ta.value = url; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  });
}
</script>

<div id="ref-modal-overlay" onclick="if(event.target===this)closeRefModal()">
  <div id="ref-modal">
    <div class="ref-mhdr">
      <div class="ref-mhdr-t">ğŸ”— ç´¹ä»‹ãƒªãƒ³ã‚¯ç™ºè¡Œ</div>
      <button onclick="closeRefModal()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1">Ã—</button>
    </div>
    <div class="ref-mbody">
      <div style="font-size:11px;color:var(--sub);margin-bottom:14px;line-height:1.8">ã“ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å…¥ä¼šã™ã‚‹ã¨ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</div>
      <div id="ref-code-selector"></div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:4px;font-weight:600;letter-spacing:.5px">ç™ºè¡Œãƒªãƒ³ã‚¯</div>
      <div class="ref-url" id="ref-url-display">â€”</div>
      <button class="ref-copy-btn" onclick="copyRefLink()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>
</div>

<button id="ref-float-btn" onclick="openRefModal()">ğŸ”— ç´¹ä»‹ãƒªãƒ³ã‚¯ç™ºè¡Œ</button>
</body>
</html>
