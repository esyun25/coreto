<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- â”€â”€ Content Security Policy (XSSè»½æ¸›) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       å¤‰æ›´æ™‚: ä½¿ç”¨ã™ã‚‹å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
       Kintoneè¿½åŠ æ™‚: connect-src ã« *.cybozu.com ã‚’è¿½åŠ 
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline'
      https://cdnjs.cloudflare.com
      https://js.stripe.com
      https://cdn-cgi/scripts;
    style-src 'self' 'unsafe-inline'
      https://fonts.googleapis.com;
    font-src 'self'
      https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    connect-src 'self'
      https://hooks.slack.com
      https://hooks.zapier.com
      https://api.stripe.com
      https://js.stripe.com
      https://www.houjin-bangou.nta.go.jp
      https://www.retio.or.jp;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
  ">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CORETO â€” ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå…¥ä¼šç”³è¾¼</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--card:#0f1119;--card2:#141720;--border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--blue:#4f9cf9;--green:#34d399;--red:#f87171;--orange:#fb923c;
  --muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;
}
html,body{min-height:100%;font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text)}
.hdr{height:54px;display:flex;align-items:center;justify-content:space-between;
  padding:0 26px;border-bottom:1px solid var(--border);background:rgba(7,9,15,.96)}
.logo{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;color:var(--gold);letter-spacing:3px}
/* Steps */
.steps{display:flex;justify-content:center;gap:0;padding:20px 24px;background:var(--card);
  border-bottom:1px solid var(--border);overflow-x:auto}
.step{flex:1;max-width:110px;text-align:center;position:relative;padding-bottom:4px}
.step:not(:last-child)::after{content:'';position:absolute;top:16px;left:60%;width:80%;height:2px;
  background:var(--border);z-index:0}
.step.done:not(:last-child)::after{background:var(--green)}
.step-dot{width:32px;height:32px;border-radius:50%;margin:0 auto 6px;display:flex;align-items:center;
  justify-content:center;font-size:13px;border:2px solid var(--border2);background:var(--bg);
  position:relative;z-index:1;font-family:'DM Mono',monospace;font-weight:700}
.step.on .step-dot{background:var(--blue);border-color:var(--blue);color:#fff}
.step.done .step-dot{background:var(--green);border-color:var(--green);color:#fff}
.step-lbl{font-size:9px;color:var(--muted);line-height:1.4}
.step.on .step-lbl{color:var(--blue)}
.step.done .step-lbl{color:var(--green)}
/* Layout */
.wrap{max-width:640px;margin:0 auto;padding:28px 24px 80px}
/* Card */
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:16px}
.ch{padding:13px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between}
.ch-t{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;
  display:flex;align-items:center;gap:8px}
.ch-t::before{content:'';width:3px;height:11px;border-radius:2px;background:var(--blue)}
.cb{padding:18px 20px}
.pill{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;
  border-radius:6px;font-size:9px;font-weight:700}
.pb{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.25)}
/* Fields */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{margin-bottom:12px}
.field label{display:block;font-size:10px;color:var(--sub);margin-bottom:5px;font-weight:600}
.req{color:var(--red);margin-left:2px}
.field input,.field select{width:100%;background:#090b13;border:1px solid var(--border2);
  border-radius:9px;padding:10px 13px;color:var(--text);font-size:13px;
  font-family:'Noto Sans JP',sans-serif;outline:none;transition:.15s}
.field input:focus,.field select:focus{border-color:var(--blue)}
.fhint{font-size:10px;color:var(--muted);margin-top:4px}
/* Buttons */
.btn{width:100%;padding:13px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;
  border:none;font-family:'Noto Sans JP',sans-serif;transition:.15s;
  display:flex;align-items:center;justify-content:center;gap:8px}
.btn-blue{background:linear-gradient(135deg,var(--blue),#3070c0);color:#fff}
.btn-blue:hover{filter:brightness(1.08)}
.btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--sub);padding:10px}
.btn-ghost:hover{border-color:var(--sub);color:var(--text)}
.btn-gold{background:linear-gradient(135deg,var(--gold),#a07830);color:#000}
.btn:disabled{opacity:.4;cursor:not-allowed}
/* Alert */
.al{display:flex;align-items:flex-start;gap:10px;padding:12px 16px;border-radius:10px;
  margin-bottom:14px;font-size:12px;line-height:1.7}
.al-info{background:rgba(79,156,249,.07);border:1px solid rgba(79,156,249,.2)}
.al-warn{background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.25)}
.al-ok{background:rgba(52,211,153,.07);border:1px solid rgba(52,211,153,.2)}
/* å®…å»ºå£«é¸æŠã‚«ãƒ¼ãƒ‰ */
.takken-choice{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
.tc-card{padding:20px;border:2px solid var(--border2);border-radius:14px;cursor:pointer;
  transition:.2s;text-align:center;background:var(--card2)}
.tc-card:hover{border-color:var(--blue);background:rgba(79,156,249,.05)}
.tc-card.selected{border-color:var(--gold);background:rgba(201,168,76,.07)}
.tc-card.selected-free{border-color:var(--green);background:rgba(52,211,153,.06)}
.tc-icon{font-size:32px;margin-bottom:10px}
.tc-title{font-size:14px;font-weight:700;margin-bottom:6px}
.tc-sub{font-size:11px;color:var(--sub);line-height:1.8}
/* OTP */
.otp-wrap{display:flex;gap:8px;justify-content:center;margin:16px 0}
.otp-cell{width:48px;height:58px;background:#090b13;border:2px solid var(--border2);
  border-radius:10px;text-align:center;font-size:24px;font-family:'DM Mono',monospace;
  color:var(--text);outline:none;transition:.2s}
.otp-cell:focus{border-color:var(--blue)}
.otp-cell.success{border-color:var(--green);background:rgba(52,211,153,.07);color:var(--green)}
.otp-cell.error{border-color:var(--red);background:rgba(248,113,113,.07)}
/* Summary table */
.sum-row{display:flex;justify-content:space-between;padding:10px 0;
  border-bottom:1px solid rgba(30,34,53,.4);font-size:12px}
.sum-row:last-child{border:none}
/* Fee section */
.fee-highlight{background:rgba(52,211,153,.07);border:1px solid rgba(52,211,153,.25);
  border-radius:12px;padding:16px;margin:12px 0;text-align:center}
.fee-free{font-family:'DM Mono',monospace;font-size:32px;font-weight:700;color:var(--green)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
</style>
</head>
<body>

<!-- â•â• ãƒˆãƒ¼ã‚¯ãƒ³ã‚²ãƒ¼ãƒˆ â•â• -->
<div id="token-gate" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:9999;align-items:center;justify-content:center;flex-direction:column;gap:0">
  <div style="width:min(420px,94vw);padding:32px 24px;text-align:center">
    <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:900;color:var(--gold);margin-bottom:6px">CORETO</div>
    <div style="font-size:11px;color:var(--muted);letter-spacing:2px;margin-bottom:28px">MEMBER ONBOARDING</div>

    <!-- invalid token -->
    <div id="gate-invalid" style="display:none">
      <div style="font-size:48px;margin-bottom:16px">ğŸ”’</div>
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--red);margin-bottom:10px">ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“</div>
      <div style="font-size:13px;color:var(--sub);line-height:1.8;margin-bottom:24px">
        ã“ã®URLã¯ç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚<br>
        HQã‹ã‚‰å—ã‘å–ã£ãŸURLã‚’æ­£ç¢ºã«é–‹ã„ã¦ãã ã•ã„ã€‚
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:12px;color:var(--muted);margin-bottom:20px">
        ãŠå¿ƒå½“ãŸã‚Šã®ãªã„æ–¹ãƒ»URLãŒè¦‹ã¤ã‹ã‚‰ãªã„æ–¹ã¯<br>
        <strong style="color:var(--sub)">CORETOæœ¬éƒ¨ï¼ˆLINE WORKSï¼‰</strong>ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚
      </div>
      <button onclick="location.href='coreto-hub.html'" class="btn btn-ghost" style="width:100%;justify-content:center">â† ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    </div>

    <!-- valid token -->
    <div id="gate-valid" style="display:none">
      <div style="font-size:48px;margin-bottom:16px">âœ…</div>
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--green);margin-bottom:6px">URLã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
      <div style="font-size:13px;color:var(--sub);margin-bottom:20px" id="gate-welcome"></div>
      <div style="background:var(--card);border:1px solid rgba(201,168,76,.3);border-radius:10px;padding:14px;margin-bottom:20px;text-align:left">
        <div style="font-size:10px;color:var(--muted);letter-spacing:.5px;margin-bottom:6px">å…¥ä¼šæ‰‹ç¶šãæ¦‚è¦</div>
        <div style="font-size:12px;color:var(--sub);line-height:2">
          â‘  åŸºæœ¬æƒ…å ±ã®å…¥åŠ›<br>
          â‘¡ å®…å»ºå£«è³‡æ ¼ã®ç¢ºèª<br>
          â‘¢ SMSæœ¬äººèªè¨¼<br>
          â‘£ èº«åˆ†è¨¼ï¼ˆeKYCï¼‰æå‡º<br>
          â‘¤ å£åº§æƒ…å ±ã®ç™»éŒ²<br>
          â‘¥ æ±ºæ¸ˆæƒ…å ±ã®ç™»éŒ²<br>
          â‘¦ LINEç™»éŒ²ãƒ»ç¢ºèªã‚³ãƒ¼ãƒ‰é€ä¿¡<br>
          â‘§ æœ€çµ‚ç¢ºèªãƒ»é€ä¿¡
        </div>
      </div>
      <button onclick="startOnboarding()" class="btn btn-primary" style="width:100%;justify-content:center">å…¥ä¼šæ‰‹ç¶šãã‚’é–‹å§‹ã™ã‚‹ â†’</button>
    </div>
  </div>
</div>

<div class="hdr">
  <div class="logo">CORETO</div>
  <div style="font-size:12px;color:var(--sub)">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ å…¥ä¼šç”³è¾¼</div>
</div>

<div class="steps" id="stepbar">
  <div class="step on"  id="s0"><div class="step-dot">1</div><div class="step-lbl">åŸºæœ¬<br>æƒ…å ±</div></div>
  <div class="step"     id="s1"><div class="step-dot">2</div><div class="step-lbl">å®…å»ºå£«<br>ç¢ºèª</div></div>
  <div class="step"     id="s2"><div class="step-dot">3</div><div class="step-lbl">SMS<br>èªè¨¼</div></div>
  <div class="step"     id="s3"><div class="step-dot">4</div><div class="step-lbl">èº«åˆ†è¨¼<br>æå‡º</div></div>
  <div class="step"     id="s4"><div class="step-dot">5</div><div class="step-lbl">å£åº§<br>æƒ…å ±</div></div>
  <div class="step"     id="s5"><div class="step-dot">6</div><div class="step-lbl">æ±ºæ¸ˆ<br>æƒ…å ±</div></div>
  <div class="step"     id="s6"><div class="step-dot">7</div><div class="step-lbl">LINE<br>ç™»éŒ²</div></div>
  <div class="step"     id="s7"><div class="step-dot">8</div><div class="step-lbl">ç¢ºèª<br>é€ä¿¡</div></div>
</div>

<div class="wrap" id="wrap"></div>
<!-- ãƒãƒ‹ãƒ¼ãƒãƒƒãƒˆ: äººé–“ã«ã¯è¦‹ãˆãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€‚botãŒè‡ªå‹•å…¥åŠ›ã™ã‚‹ -->
<div style="display:none;position:absolute;left:-9999px" aria-hidden="true">
  <label for="hp-field">ä¼šç¤¾åï¼ˆå…¥åŠ›ã—ãªã„ã§ãã ã•ã„ï¼‰</label>
  <input type="text" id="hp-field" name="company_name" tabindex="-1" autocomplete="off">
</div>

<script>
  // â”€â”€ Slacké€šçŸ¥è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æœ¬ç•ªé‹ç”¨å‰ã« Slack Incoming Webhook URL ã‚’è¨­å®šã—ã¦ãã ã•ã„
  // Slackç®¡ç†ç”»é¢ â†’ ã‚¢ãƒ—ãƒª â†’ Incoming Webhooks â†’ Webhook URLã‚’ã‚³ãƒ”ãƒ¼
  var SLACK_WEBHOOK = window.SLACK_CONFIG
    ? window.SLACK_CONFIG.GENERAL   // db.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
    : 'YOUR_SLACK_WEBHOOK_URL';     // ç›´æ¥è¨­å®šã™ã‚‹å ´åˆã¯ã“ã“ã«è²¼ã‚Šä»˜ã‘

  function notifySlack(msg) {
    if (!SLACK_WEBHOOK || SLACK_WEBHOOK === 'YOUR_SLACK_WEBHOOK_URL') {
      console.log('[Slackï¼ˆæœªè¨­å®šï¼‰]', msg);
      return;
    }
    fetch(SLACK_WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: msg }),
      mode: 'no-cors'
    }).catch(e => console.error('[Slacké€ä¿¡ã‚¨ãƒ©ãƒ¼]', e));
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var step = 0;
var form = {
  name:'', nameKana:'', phone:'', email:'', zip:'', addr:'',
  referral:'', agentType:'re',
  // å®…å»ºå£«
  hasTakken: null,       // true / false
  takkenSennin: null,    // true / falseï¼ˆå°‚ä»»å¸Œæœ›ï¼‰
  licNo:'', licPref:'æ±äº¬éƒ½',
  // è²»ç”¨
  monthlyFee: 980,       // å°‚ä»»ãªã‚‰0ï¼ˆãƒ–ãƒ­ãƒ³ã‚ºåˆæœŸå€¤ï¼‰
  meishiFee:  2000,      // ååˆºï¼ˆå°‚ä»»ãªã‚‰0ï¼‰
  meishiWant: true,
  // KYC
  kyc_front:'', kyc_back:'',
  // å£åº§
  bankName:'', bankBranch:'', bankBranchCode:'', bankType:'æ™®é€š', bankNum:'', bankHolder:'',
  // æ±ºæ¸ˆ â€” ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯StripeãŒç®¡ç†ï¼ˆCOREOTOã§ã¯ä¿æŒã—ãªã„ï¼‰
  stripePaymentMethodId: '',  // StripeãŒç™ºè¡Œã™ã‚‹PaymentMethod ID ã®ã¿ä¿æŒ
};

// â”€â”€ ã‚¹ãƒ‘ãƒ å¯¾ç­–: ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window._signupOpenedAt = Date.now();
var demoOtp = '';
var otpTimer = null;
var otpSec = 300;

// â”€â”€ Step control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goStep(n) {
  step = n;
  for (var i=0;i<8;i++) {
    var el = document.getElementById('s'+i);
    if(!el) continue;
    el.className = 'step'+(i<n?' done':i===n?' on':'');
    el.querySelector('.step-dot').textContent = i<n ? 'âœ“' : String(i+1);
  }
  [step0,step1,step2,step3,step4,step5,stepWorks,step6][n]();
  window.scrollTo({top:0,behavior:'smooth'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 0: åŸºæœ¬æƒ…å ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function step0() {
  document.getElementById('wrap').innerHTML =
    '<div class="card"><div class="ch"><div class="ch-t">åŸºæœ¬æƒ…å ±</div><span class="pill pb">1 / 5</span></div><div class="cb">' +
    '<div class="g2">' +
    '<div class="field"><label>æ°åï¼ˆæ¼¢å­—ï¼‰<span class="req">*</span></label><input id="f-name" value="'+form.name+'" placeholder="å±±ç”° èª "></div>' +
    '<div class="field"><label>æ°åï¼ˆã‚«ãƒŠï¼‰<span class="req">*</span></label><input id="f-kana" value="'+form.nameKana+'" placeholder="ãƒ¤ãƒãƒ€ ãƒã‚³ãƒˆ"></div>' +
    '</div>' +
    '<div class="g2">' +
    '<div class="field"><label>æºå¸¯é›»è©±ç•ªå·<span class="req">*</span></label><input id="f-phone" type="tel" value="'+form.phone+'" placeholder="090-0000-0000"></div>' +
    '<div class="field"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹<span class="req">*</span></label><input id="f-email" type="email" value="'+form.email+'" placeholder="you@example.com"></div>' +
    '</div>' +
    '<div class="field"><label>éƒµä¾¿ç•ªå·</label><input id="f-zip" value="'+form.zip+'" placeholder="150-0001" style="max-width:140px"></div>' +
    '<div class="field"><label>ä½æ‰€</label><input id="f-addr" value="'+form.addr+'" placeholder="æ±äº¬éƒ½æ¸‹è°·åŒº..."></div>' +
    '<div class="g2">' +
    '<div class="field"><label>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç¨®åˆ¥<span class="req">*</span></label>' +
    '<select id="f-type"><option value="re"'+(form.agentType==='re'?' selected':'')+'>ä¸å‹•ç”£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆREï¼‰</option>' +
    '<option value="hr"'+(form.agentType==='hr'?' selected':'')+'>äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆHRï¼‰</option></select></div>' +
    (form._refLocked
      ? '<div class="field"><label>ç´¹ä»‹ã‚³ãƒ¼ãƒ‰</label>'
        +'<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.25);border-radius:8px">'
        +'<span style="font-family:\'DM Mono\',monospace;font-size:13px;color:var(--green);font-weight:700">'+form.referral+'</span>'
        +'<span style="font-size:10px;color:var(--green)">âœ“ ç´¹ä»‹ãƒªãƒ³ã‚¯ã‹ã‚‰è‡ªå‹•å…¥åŠ›</span>'
        +'</div></div>'
      : '<div class="field"><label>ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</label><input id="f-ref" value="'+form.referral+'" placeholder="ä¾‹: 10012 ã¾ãŸã¯ WELCOME2026" style="font-family:\'DM Mono\',monospace"></div>'
    )+
    '<button class="btn btn-blue" onclick="validateStep0()">æ¬¡ã¸ â†’</button>' +
    '</div></div>';
}

// â”€â”€ ç´¹ä»‹ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// æœ‰åŠ¹ãªç´¹ä»‹ã‚³ãƒ¼ãƒ‰å½¢å¼:
//   - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆID: 5æ¡æ•°å­— (10001ã€œ19999 RE / 20001ã€œ29999 HR)
//   - ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰: è‹±å¤§æ–‡å­—+æ•°å­— 4ã€œ16æ–‡å­— (ä¾‹: WELCOME2026)
function validateReferralCode(code) {
  if (!code) return { valid: true, msg: '' }; // ä»»æ„é …ç›® â†’ ç©ºã§ã‚‚é€šã™

  // ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆID (5æ¡æ•°å­—)
  if (/^[12]\d{4}$/.test(code)) {
    // IDãƒ¬ãƒ³ã‚¸ãƒã‚§ãƒƒã‚¯ (10001-29999)
    var n = parseInt(code, 10);
    if (n >= 10001 && n <= 29999) {
      return { valid: true, msg: '' };
    }
    return { valid: false, msg: 'ç´¹ä»‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆIDãŒç„¡åŠ¹ã§ã™ï¼ˆ10001ã€œ29999ã®ç¯„å›²ï¼‰' };
  }

  // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰ (è‹±å¤§æ–‡å­—ãƒ»æ•°å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³, 4ã€œ16æ–‡å­—)
  if (/^[A-Z0-9\-]{4,16}$/.test(code)) {
    return { valid: true, msg: '' };
  }

  // ãã‚Œä»¥å¤–ã¯ç„¡åŠ¹
  return {
    valid: false,
    msg: 'ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆID 5æ¡ã€ã¾ãŸã¯ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰ è‹±å¤§æ–‡å­—ãƒ»æ•°å­— 4ã€œ16æ–‡å­—ï¼‰'
  };
}

async function validateStep0() {
  var name  = document.getElementById('f-name').value.trim();
  var kana  = document.getElementById('f-kana').value.trim();
  var phone = document.getElementById('f-phone').value.trim();
  var email = document.getElementById('f-email').value.trim();
  if (!name || !kana || !phone || !email) { alert('å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ãƒã‚§ãƒƒã‚¯
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); return;
  }

  // é›»è©±ç•ªå·å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æœ¬ã®æºå¸¯ãƒ»å›ºå®šï¼‰
  var phoneClean = phone.replace(/[-\s]/g, '');
  if (!/^(0[789]0\d{8}|0\d{9,10})$/.test(phoneClean)) {
    alert('é›»è©±ç•ªå·ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆä¾‹: 090-1234-5678ï¼‰'); return;
  }

  // ç´¹ä»‹ã‚³ãƒ¼ãƒ‰æ¤œè¨¼
  var refInput = (document.getElementById('f-ref')||{value:''}).value.trim().toUpperCase();
  if (!form._refLocked && refInput) {
    var refResult = validateReferralCode(refInput);
    if (!refResult.valid) {
      alert(refResult.msg); return;
    }
    // Zapier URLè¨­å®šæ¸ˆã¿ã®å ´åˆ: å®Ÿåœ¨ç¢ºèªã‚’éåŒæœŸã§è©¦è¡Œ
    if (typeof ZAPIER_CONFIG !== 'undefined' && ZAPIER_CONFIG.ENABLED) {
      var btn = document.querySelector('button[onclick*="validateStep0"]');
      if (btn) { btn.disabled = true; btn.textContent = 'ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç¢ºèªä¸­...'; }
      try {
        await DB.sendToZapier('SIGNUP', { action: 'verify_referral', code: refInput });
        // Zapierã‹ã‚‰ã®å¿œç­”ã¯no-corsã®ãŸã‚ç›´æ¥ç¢ºèªã§ããªã„ãŒã€é€ä¿¡ã¯è¨˜éŒ²ã•ã‚Œã‚‹
      } catch(e) {
        console.warn('[referral verify] Zapieræœªè¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'æ¬¡ã¸ â†’'; }
      }
    }
  }

  form.name      = name; form.nameKana = kana;
  form.phone     = phoneClean; form.email   = email;
  form.zip       = document.getElementById('f-zip').value.trim();
  form.addr      = document.getElementById('f-addr').value.trim();
  form.agentType = document.getElementById('f-type').value;
  if (!form._refLocked) form.referral = refInput;
  goStep(1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 1: å®…å»ºå£«ç¢ºèªï¼ˆåˆ†å²ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function step1() {
  document.getElementById('wrap').innerHTML =
    '<div class="card"><div class="ch"><div class="ch-t">å®…åœ°å»ºç‰©å–å¼•å£« è³‡æ ¼ç¢ºèª</div><span class="pill pb">2 / 5</span></div><div class="cb">' +
    '<div class="al al-info">â„¹ï¸ <div>å®…å»ºå£«è³‡æ ¼ã‚’ãŠæŒã¡ã®æ–¹ã¯ã€COREBLDGã®å°‚ä»»å®…å»ºå£«ã¨ã—ã¦ç™»éŒ²ã§ãã¾ã™ã€‚<br>' +
    'å°‚ä»»ç™»éŒ²ã‚’é¸æŠã„ãŸã ãã¨ <strong style="color:var(--green)">æœˆä¼šè²»ãƒ»ååˆºè²»ç”¨ãŒç„¡æ–™</strong> ã«ãªã‚Šã¾ã™ã€‚</div></div>' +
    '<div style="font-size:13px;font-weight:700;margin-bottom:16px">å®…åœ°å»ºç‰©å–å¼•å£«ã®è³‡æ ¼ã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ</div>' +
    '<div class="takken-choice">' +
    '<div class="tc-card" id="tc-yes" onclick="selectTakken(true)">' +
    '<div class="tc-icon">ğŸ›ï¸</div>' +
    '<div class="tc-title">ã¯ã„ã€æŒã£ã¦ã„ã¾ã™</div>' +
    '<div class="tc-sub">å®…å»ºå£«è¨¼ç•ªå·ã‚’å…¥åŠ›ã—ã¾ã™<br>å°‚ä»»ç™»éŒ²ã®æ„æ€ã‚’ç¢ºèªã—ã¾ã™</div>' +
    '</div>' +
    '<div class="tc-card" id="tc-no" onclick="selectTakken(false)">' +
    '<div class="tc-icon">ğŸ“‹</div>' +
    '<div class="tc-title">ã„ã„ãˆ</div>' +
    '<div class="tc-sub">é€šå¸¸ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦<br>å…¥ä¼šæ‰‹ç¶šãã‚’é€²ã‚ã¾ã™</div>' +
    '</div></div>' +
    '<div id="takken-detail" style="display:none"></div>' +
    '<div style="display:flex;gap:10px;margin-top:16px">' +
    '<button class="btn btn-ghost" onclick="goStep(0)" style="width:auto;padding:10px 20px">â† æˆ»ã‚‹</button>' +
    '<button class="btn btn-blue" id="step1-next" onclick="validateStep1()" disabled>æ¬¡ã¸ â†’</button>' +
    '</div></div></div>';

  // å‰å›ã®é¸æŠã‚’å¾©å…ƒ
  if (form.hasTakken === true)  selectTakken(true);
  if (form.hasTakken === false) selectTakken(false);
}

function selectTakken(has) {
  form.hasTakken = has;
  document.getElementById('tc-yes').className = 'tc-card' + (has ? ' selected' : '');
  document.getElementById('tc-no').className  = 'tc-card' + (!has ? ' selected' : '');

  var detail = document.getElementById('takken-detail');
  if (has) {
    detail.style.display = 'block';
    detail.innerHTML =
      '<div style="border-top:1px solid var(--border2);padding-top:16px;margin-top:4px">' +
      '<div style="font-size:13px;font-weight:700;margin-bottom:14px">COREBLDGã®å°‚ä»»å®…å»ºå£«ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</div>' +
      '<div class="takken-choice">' +

      '<div class="tc-card" id="tc-sennin" onclick="selectSennin(true)">' +
      '<div class="tc-icon">â­</div>' +
      '<div class="tc-title" style="color:var(--green)">å°‚ä»»ã¨ã—ã¦ç™»éŒ²ã™ã‚‹</div>' +
      '<div class="tc-sub">æœˆä¼šè²» <strong style="color:var(--green);font-size:13px">ç„¡æ–™</strong>ï¼ˆé€šå¸¸ãƒ–ãƒ­ãƒ³ã‚ºÂ¥980ãƒ»ã‚·ãƒ«ãƒãƒ¼Â¥490ãƒ»ã‚´ãƒ¼ãƒ«ãƒ‰ä»¥ä¸ŠÂ¥0ï¼‰<br>' +
      'ååˆºè²»ç”¨ <strong style="color:var(--green)">ç„¡æ–™</strong>ï¼ˆé€šå¸¸Â¥2,000ï¼‰<br>' +
      'ITé‡èª¬ å ±é…¬ã‚ã‚Šï¼ˆ1ä»¶ã‚ãŸã‚Šï¼‰<br>' +
      '<span style="font-size:10px;color:var(--muted)">â€» ä»–ç¤¾ã¸ã®å°‚ä»»å®…å»ºå£«ã¨ã—ã¦ã®ç™»éŒ²ã¯ä¸å¯</span>' +
      '</div></div>' +

      '<div class="tc-card" id="tc-nonsennin" onclick="selectSennin(false)">' +
      '<div class="tc-icon">ğŸ“‹</div>' +
      '<div class="tc-title">ä¸€èˆ¬ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦</div>' +
      '<div class="tc-sub">æœˆä¼šè²» Â¥980 / æœˆï¼ˆBronzeï¼‰ã€œÂ¥0ï¼ˆGoldä»¥ä¸Šï¼‰<br>' +
      'ååˆºè²»ç”¨ Â¥2,000<br>' +
      'ITé‡èª¬å¯¾å¿œãªã—<br>' +
      '<span style="font-size:10px;color:var(--muted)">â€» ä»–ç¤¾å‹¤å‹™ãƒ»æ›ã‘æŒã¡å¯</span>' +
      '</div></div>' +
      '</div>' +

      '<div id="sennin-form" style="display:none;margin-top:14px">' +
      '<div class="al al-warn">âš–ï¸ <div>å°‚ä»»å®…å»ºå£«ã¨ã—ã¦ç™»éŒ²ã™ã‚‹ã¨ã€å®…å»ºæ¥­æ³•ä¸Š <strong>ä»–ç¤¾ã§ã®å°‚ä»»å®…å»ºå£«ç™»éŒ²ã¯ã§ãã¾ã›ã‚“</strong>ã€‚' +
      'ä»–ç¤¾ã«å°±è·ãƒ»è»¢è·ã•ã‚ŒãŸå ´åˆã¯å¿…ãšCOREBLDGã¸ã”é€£çµ¡ãã ã•ã„ï¼ˆå°‚ä»»è§£é™¤ã¯å¼Šç¤¾ç®¡ç†è·ãŒè¡Œã„ã¾ã™ï¼‰ã€‚</div></div>' +
      '<div class="g2">' +
      '<div class="field"><label>å®…å»ºå£«è¨¼ç•ªå·<span class="req">*</span></label>' +
      '<input id="f-licno" value="'+form.licNo+'" placeholder="æ±äº¬(1)ç¬¬123456å·" style="font-family:\'DM Mono\',monospace"></div>' +
      '<div class="field"><label>ç™»éŒ²éƒ½é“åºœçœŒ<span class="req">*</span></label>' +
      '<select id="f-licpref"><option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option><option>å¤§é˜ªåºœ</option>' +
      '<option>æ„›çŸ¥çœŒ</option><option>ç¦å²¡çœŒ</option><option>ãã®ä»–</option></select></div>' +
      '</div>' +
      '<div class="fee-highlight">' +
      '<div style="font-size:11px;color:var(--muted);margin-bottom:6px">å°‚ä»»ç™»éŒ²ã®å ´åˆã®è²»ç”¨</div>' +
      '<div class="fee-free">Â¥0</div>' +
      '<div style="font-size:12px;color:var(--green);margin-top:4px">æœˆä¼šè²»ãƒ»ååˆºè²»ç”¨ã€€ã™ã¹ã¦ç„¡æ–™</div>' +
      '</div>' +
      '</div>' +
      '</div>';

    // å‰å›ã®é¸æŠã‚’å¾©å…ƒ
    if (form.takkenSennin === true)  selectSennin(true);
    if (form.takkenSennin === false) selectSennin(false);
  } else {
    detail.style.display = 'none';
    form.takkenSennin = false;
    form.monthlyFee = 980; // ãƒ–ãƒ­ãƒ³ã‚ºåˆæœŸå€¤
    form.meishiFee  = 2000;
    document.getElementById('step1-next').disabled = false;
  }
}

function selectSennin(isSennin) {
  form.takkenSennin = isSennin;
  document.getElementById('tc-sennin').className    = 'tc-card' + (isSennin ? ' selected-free' : '');
  document.getElementById('tc-nonsennin').className = 'tc-card' + (!isSennin ? ' selected' : '');

  var senninForm = document.getElementById('sennin-form');
  if (isSennin) {
    senninForm.style.display = 'block';
    form.monthlyFee = 0;
    form.meishiFee  = 0;
    form.meishiWant = true;
  } else {
    senninForm.style.display = 'none';
    form.monthlyFee = 980; // ãƒ–ãƒ­ãƒ³ã‚ºåˆæœŸå€¤
    form.meishiFee  = 2000;
  }
  document.getElementById('step1-next').disabled = false;
}

function validateStep1() {
  if (form.hasTakken === null) { alert('è³‡æ ¼ã®æœ‰ç„¡ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if (form.hasTakken && form.takkenSennin === null) { alert('å°‚ä»»ç™»éŒ²ã®æ„æ€ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if (form.hasTakken && form.takkenSennin) {
    var licNo = document.getElementById('f-licno') ? document.getElementById('f-licno').value.trim() : '';
    if (!licNo) { alert('å®…å»ºå£«è¨¼ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    form.licNo   = licNo;
    form.licPref = document.getElementById('f-licpref') ? document.getElementById('f-licpref').value : 'æ±äº¬éƒ½';
  }
  goStep(2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 2: SMSèªè¨¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ SMS OTP è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Twilio ã¾ãŸã¯ Zapier çµŒç”±ã§SMSã‚’é€ä¿¡ã—ã¾ã™ã€‚
// Zapierè¨­å®š: Webhooks â†’ Catch Hook â†’ Twilio SMSé€ä¿¡ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
// ZAPIER_CONFIG.ENABLED = true ã«è¨­å®šå¾Œã€ZAPIER_CONFIG.SMS_WEBHOOK ã«URLã‚’è¿½åŠ 
var OTP_CONFIG = {
  SMS_WEBHOOK: 'YOUR_ZAPIER_SMS_WEBHOOK',  // â† Zapier SMS Webhook URLã‚’ã“ã“ã«è¨­å®š
  // é–‹ç™ºç’°å¢ƒ: console.log ã§è¡¨ç¤ºï¼ˆSMSæœªé€ä¿¡ï¼‰
  DEV_MODE: true,   // æœ¬ç•ªå‰ã« false ã«å¤‰æ›´
};

// OTPãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹åˆ¶é™
var _otpAttempts = 0;
var _otpResends  = 0;
var OTP_MAX_ATTEMPTS = 5;
var OTP_MAX_RESENDS  = 3;

async function sendOtpSms(phone, otp) {
  if (OTP_CONFIG.DEV_MODE || !OTP_CONFIG.SMS_WEBHOOK || OTP_CONFIG.SMS_WEBHOOK === 'YOUR_ZAPIER_SMS_WEBHOOK') {
    console.log('[OTP é–‹ç™ºãƒ¢ãƒ¼ãƒ‰] ã‚³ãƒ¼ãƒ‰:', otp, 'â†’ é›»è©±:', phone);
    // é–‹ç™ºä¸­ã¯ç”»é¢ã«è¡¨ç¤ºï¼ˆæœ¬ç•ªã§ã¯çµ¶å¯¾ã«è¡¨ç¤ºã—ãªã„ï¼‰
    var devEl = document.getElementById('otp-dev-hint');
    if (devEl) devEl.textContent = '[é–‹ç™º] ã‚³ãƒ¼ãƒ‰: ' + otp;
    return;
  }
  try {
    await fetch(OTP_CONFIG.SMS_WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to: phone, code: otp, message: 'COREOTOã®èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯ ' + otp + ' ã§ã™ï¼ˆ5åˆ†é–“æœ‰åŠ¹ï¼‰' }),
      mode: 'no-cors'
    });
  } catch(e) {
    console.error('[OTP] SMSé€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function step2() {
  demoOtp = String(Math.floor(100000+Math.random()*900000));
  _otpAttempts = 0;
  otpSec = 300;

  // SMSé€ä¿¡ï¼ˆéåŒæœŸï¼‰
  sendOtpSms(form.phone, demoOtp);

  document.getElementById('wrap').innerHTML =
    '<div class="card"><div class="ch"><div class="ch-t">SMSæœ¬äººç¢ºèª</div><span class="pill pb">3 / 5</span></div><div class="cb">' +
    '<div class="al al-info">ğŸ“± <div><strong>' + form.phone + '</strong> ã«SMSã§6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚<br>' +
    '<span id="otp-dev-hint" style="font-size:10px;color:var(--amber)"></span></div></div>' +
    '<div class="otp-wrap">' +
    [0,1,2,3,4,5].map(function(i){ return '<input class="otp-cell" maxlength="1" type="text" inputmode="numeric" id="oc-'+i+'" oninput="otpIn(this,'+i+')" onkeydown="otpKey(event,'+i+')">'; }).join('') +
    '</div>' +
    '<div style="text-align:center;font-size:11px;color:var(--muted);margin-bottom:16px">æœ‰åŠ¹æœŸé™ï¼š<span id="otp-timer">5:00</span></div>' +
    '<button class="btn btn-ghost" onclick="resendOtp()" id="resend-btn" style="margin-bottom:10px" disabled>ğŸ“± å†é€ä¿¡ã™ã‚‹</button>' +
    '<div style="display:flex;gap:10px">' +
    '<button class="btn btn-ghost" onclick="goStep(1)" style="width:auto;padding:10px 20px">â† æˆ»ã‚‹</button>' +
    '</div></div></div>';

  clearInterval(otpTimer);
  otpTimer = setInterval(function() {
    otpSec--;
    var m = Math.floor(otpSec/60), s = otpSec%60;
    var el = document.getElementById('otp-timer');
    if (el) el.textContent = m+':'+(s<10?'0':'')+s;
    if (otpSec <= 0) {
      clearInterval(otpTimer);
      var rb = document.getElementById('resend-btn');
      if (rb) rb.disabled = false;
    }
  }, 1000);
}

function otpIn(el, i) {
  el.value = el.value.replace(/\D/g,'');
  if (el.value && i<5) document.getElementById('oc-'+(i+1)).focus();
  if (i===5 && el.value) checkOtp();
}
function otpKey(e, i) {
  if (e.key==='Backspace' && !e.target.value && i>0) document.getElementById('oc-'+(i-1)).focus();
}
function checkOtp() {
  var entered = [0,1,2,3,4,5].map(function(i){ return document.getElementById('oc-'+i).value; }).join('');
  // ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹åˆ¶é™
  _otpAttempts++;
  if (_otpAttempts > OTP_MAX_ATTEMPTS) {
    clearInterval(otpTimer);
    alert('èªè¨¼ã‚³ãƒ¼ãƒ‰ã®è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
    goStep(0);
    return;
  }

  if (entered === demoOtp) {
    _otpAttempts = 0;
    [0,1,2,3,4,5].forEach(function(i){ document.getElementById('oc-'+i).className='otp-cell success'; });
    clearInterval(otpTimer);
    setTimeout(function(){ goStep(3); }, 600);
  } else {
    [0,1,2,3,4,5].forEach(function(i){ document.getElementById('oc-'+i).className='otp-cell error'; });
    setTimeout(function(){
      [0,1,2,3,4,5].forEach(function(i){ document.getElementById('oc-'+i).className='otp-cell'; document.getElementById('oc-'+i).value=''; });
      document.getElementById('oc-0').focus();
    }, 800);
  }
}
function resendOtp() {
  _otpResends++;
  if (_otpResends > OTP_MAX_RESENDS) {
    alert('å†é€ä¿¡å›æ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
    goStep(0);
    return;
  }
  demoOtp = String(Math.floor(100000+Math.random()*900000));
  _otpAttempts = 0;
  sendOtpSms(form.phone, demoOtp);  // æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡
  otpSec = 300;
  document.getElementById('resend-btn').disabled = true;
  clearInterval(otpTimer);
  otpTimer = setInterval(function() {
    otpSec--;
    var m=Math.floor(otpSec/60),s=otpSec%60;
    var el=document.getElementById('otp-timer');
    if(el) el.textContent=m+':'+(s<10?'0':'')+s;
    if(otpSec<=0){clearInterval(otpTimer);var rb=document.getElementById('resend-btn');if(rb)rb.disabled=false;}
  },1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 3: èº«åˆ†è¨¼æ˜æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var kycDocType = -1;  // 0=å…è¨±è¨¼ 1=ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ 2=ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼
var kycUploads = {front: null, back: null};

function step3() {
  var docBtns = ['ğŸªª é‹è»¢å…è¨±è¨¼','ğŸ›‚ ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ','ğŸ’³ ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰'].map(function(label, i) {
    var on = kycDocType === i;
    return '<button onclick="kycSelDoc('+i+')" style="flex:1;padding:10px 8px;border:1px solid '+(on?'var(--blue)':'var(--border2)')+';border-radius:8px;cursor:pointer;background:'+(on?'rgba(79,156,249,.12)':'var(--card2)')+';color:'+(on?'var(--blue)':'var(--sub)')+';font-size:11px;font-weight:600;font-family:inherit">'+label+'</button>';
  }).join('');

  var needBack = kycDocType !== 1;
  var frontDone = !!kycUploads.front;
  var backDone  = !needBack || !!kycUploads.back;

  function uploadZone(side, label, done) {
    return '<div onclick="document.getElementById(\'kyc-'+side+'\').click()" style="border:2px dashed '+(done?'var(--green)':'var(--border2)')+';border-radius:10px;padding:20px;text-align:center;cursor:pointer;background:'+(done?'rgba(52,211,153,.04)':'var(--card2)')+';transition:.2s">'
      +'<div style="font-size:28px;margin-bottom:6px">'+(done?'âœ…':'ğŸ“·')+'</div>'
      +'<div style="font-size:11px;font-weight:600;color:'+(done?'var(--green)':'var(--sub)')+'">'+label+'</div>'
      +'<div style="font-size:10px;color:var(--muted);margin-top:4px">'+(done?'âœ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ â€” ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´':'JPGãƒ»PNGãƒ»PDFå¯¾å¿œ')+'</div>'
      +'<input type="file" id="kyc-'+side+'" accept="image/*,.pdf" style="display:none" onchange="kycUpload(this,\''+side+'\')">'
      +'</div>';
  }

  var canNext = kycDocType >= 0 && frontDone && backDone;

  document.getElementById('wrap').innerHTML =
    '<div class="card"><div class="ch"><div class="ch-t">èº«åˆ†è¨¼æ˜æ›¸</div><span class="pill pb">4 / 7</span></div><div class="cb">'
    +'<div style="font-size:11px;color:var(--sub);margin-bottom:14px;line-height:1.8">å…¥ä¼šå¯©æŸ»ã®ãŸã‚èº«åˆ†è¨¼æ˜æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚æ›¸é¡ã¯æœ¬éƒ¨ã‚¹ã‚¿ãƒƒãƒ•ãŒç›®è¦–ç¢ºèªã—ã¾ã™ï¼ˆ1ã€œ2å–¶æ¥­æ—¥ï¼‰ã€‚</div>'
    +'<div class="field"><label>æ›¸é¡ã®ç¨®é¡ <span class="req">*</span></label>'
    +'<div style="display:flex;gap:8px">'+docBtns+'</div></div>'
    +(kycDocType >= 0 ? (
      '<div style="display:grid;grid-template-columns:'+(needBack?'1fr 1fr':'1fr')+';gap:10px;margin-top:12px">'
      + uploadZone('front', needBack?'è¡¨é¢':'è¨¼æ˜æ›¸','front',frontDone)
      +(needBack ? uploadZone('back','è£é¢','back',backDone) : '')
      +'</div>'
    ) : '')
    +'<div style="display:flex;gap:10px;margin-top:20px">'
    +'<button class="btn btn-ghost" onclick="goStep(2)" style="width:auto;padding:10px 20px">â† æˆ»ã‚‹</button>'
    +'<button class="btn btn-gold" '+(canNext?'':'disabled ')+'onclick="goStep(4)" style="flex:1;justify-content:center">æ¬¡ã¸: å£åº§æƒ…å ± â†’</button>'
    +'</div>'
    +'</div></div>';
}

function kycSelDoc(n) {
  kycDocType = n;
  step3();
}

// â”€â”€ KYCãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼å®šæ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var KYC_FILE_TYPES = ['image/jpeg','image/jpg','image/png','image/webp','image/heic','application/pdf'];
var KYC_MAX_SIZE   = 10 * 1024 * 1024; // 10MB

function kycUpload(input, side) {
  if (!input.files[0]) return;
  var file = input.files[0];

  // â”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!KYC_FILE_TYPES.includes(file.type)) {
    alert('âš ï¸ å¯¾å¿œå½¢å¼ã¯JPEGãƒ»PNGãƒ»WebPãƒ»HEICãƒ»PDFã®ã¿ã§ã™');
    input.value = '';
    return;
  }
  var ext = file.name.split('.').pop().toLowerCase();
  if (!['jpg','jpeg','png','webp','heic','pdf'].includes(ext)) {
    alert('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ãŒç„¡åŠ¹ã§ã™ï¼ˆè¨±å¯: jpg, png, webp, heic, pdfï¼‰');
    input.value = '';
    return;
  }
  if (file.size > KYC_MAX_SIZE) {
    alert('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§10MBï¼‰ã€‚ç¾åœ¨: ' + (file.size/1024/1024).toFixed(1) + 'MB');
    input.value = '';
    return;
  }
  if (file.size === 0) {
    alert('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™ã€‚æ­£ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    input.value = '';
    return;
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  var reader = new FileReader();
  reader.onload = function(e) {
    kycUploads[side] = { name: file.name, data: e.target.result };
    form['kyc_'+side] = file.name;
    step3();
  };
  reader.readAsDataURL(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 4: å£åº§æƒ…å ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function step4() {
  var sv = function(id) { return (document.getElementById(id)||{}).value||''; };
  document.getElementById('wrap').innerHTML =
    '<div class="card"><div class="ch"><div class="ch-t">å£åº§æƒ…å ±</div><span class="pill pb">5 / 7</span></div><div class="cb">'
    +'<div style="font-size:11px;color:var(--sub);margin-bottom:14px;line-height:1.8">å ±é…¬ã®æŒ¯è¾¼å…ˆå£åº§ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚<strong style="color:var(--text)">æœ¬äººåç¾©ã®å£åº§ã®ã¿</strong>å—ã‘ä»˜ã‘ã¾ã™ã€‚</div>'
    +'<div class="field"><label>éŠ€è¡Œå <span class="req">*</span></label>'
    +'<input id="b-bank" type="text" placeholder="ä¾‹: GMOã‚ãŠãã‚‰ãƒãƒƒãƒˆéŠ€è¡Œ" value="'+(form.bankName||'')+'">'
    +'</div>'
    +'<div class="g2">'
    +'<div class="field"><label>æ”¯åº—å <span class="req">*</span></label>'
    +'<input id="b-branch" type="text" placeholder="ä¾‹: ãƒ“ã‚¸ãƒã‚¹å–¶æ¥­éƒ¨" value="'+(form.bankBranch||'')+'">'
    +'</div>'
    +'<div class="field"><label>æ”¯åº—ã‚³ãƒ¼ãƒ‰</label>'
    +'<input id="b-branchcode" type="text" class="mono" placeholder="ä¾‹: 010" value="'+(form.bankBranchCode||'')+'">'
    +'</div>'
    +'</div>'
    +'<div class="g2">'
    +'<div class="field"><label>å£åº§ç¨®åˆ¥ <span class="req">*</span></label>'
    +'<select id="b-type"><option value="æ™®é€š" '+(form.bankType==='æ™®é€š'?'selected':'')+'>æ™®é€š</option><option value="å½“åº§" '+(form.bankType==='å½“åº§'?'selected':'')+'>å½“åº§</option></select>'
    +'</div>'
    +'<div class="field"><label>å£åº§ç•ªå· <span class="req">*</span></label>'
    +'<input id="b-num" type="text" class="mono" placeholder="1234567" maxlength="8" value="'+(form.bankNum||'')+'">'
    +'</div>'
    +'</div>'
    +'<div class="field"><label>å£åº§åç¾©ï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰ <span class="req">*</span></label>'
    +'<input id="b-holder" type="text" class="mono" placeholder="ä¾‹: ãƒ¤ãƒãƒ€ ãƒã‚³ãƒˆ" value="'+(form.bankHolder||form.nameKana||'')+'">'
    +'</div>'
    +'<div style="margin-top:4px;padding:10px 12px;background:rgba(79,156,249,.06);border:1px solid rgba(79,156,249,.2);border-radius:8px;font-size:11px;color:var(--sub)">ğŸ’¡ æŒ¯è¾¼æ‰‹æ•°æ–™ã¯CORETOè² æ‹…ã§ã™ã€‚ã”å®‰å¿ƒãã ã•ã„ã€‚</div>'
    +'<div style="display:flex;gap:10px;margin-top:20px">'
    +'<button class="btn btn-ghost" onclick="goStep(3)" style="width:auto;padding:10px 20px">â† æˆ»ã‚‹</button>'
    +'<button class="btn btn-gold" onclick="saveBank()" style="flex:1;justify-content:center">æ¬¡ã¸: æ±ºæ¸ˆæƒ…å ± â†’</button>'
    +'</div>'
    +'</div></div>';
}

function saveBank() {
  var bank  = document.getElementById('b-bank').value.trim();
  var branch= document.getElementById('b-branch').value.trim();
  var num   = document.getElementById('b-num').value.trim();
  var holder= document.getElementById('b-holder').value.trim();
  if (!bank||!branch||!num||!holder) { alert('å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  form.bankName      = bank;
  form.bankBranch    = branch;
  form.bankBranchCode= document.getElementById('b-branchcode').value.trim();
  form.bankType      = document.getElementById('b-type').value;
  form.bankNum       = num;
  form.bankHolder    = holder;
  goStep(5);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 5: æ±ºæ¸ˆæƒ…å ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function step5() {
  var feeNote = form.takkenSennin
    ? '<div class="fee-highlight"><div style="font-size:11px;color:var(--muted);margin-bottom:4px">å°‚ä»»å®…å»ºå£« ç‰¹å…¸</div><div class="fee-free">Â¥0</div><div style="font-size:11px;color:var(--green);margin-top:4px">æœˆä¼šè²»ãƒ»ååˆºè²»ç”¨ ã™ã¹ã¦ç„¡æ–™</div></div>'
    : '<div class="al al-info">ğŸ’³ <div>æœˆä¼šè²» åŠã³ååˆºä»£é‡‘ãŒç™»éŒ²ã®ã‚«ãƒ¼ãƒ‰ã«è«‹æ±‚ã•ã‚Œã¾ã™ã€‚</div></div>';

  document.getElementById('wrap').innerHTML =
    '<div class="card"><div class="ch"><div class="ch-t">æ±ºæ¸ˆæƒ…å ±</div><span class="pill pb">4 / 5</span></div><div class="cb">' +
    feeNote +
    (form.takkenSennin ? '' :
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ğŸ”’ PCI DSS å¯¾å¿œ: ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯Stripe ElementsçµŒç”±ã§åé›†
      //    COREOTOã®JSã¯ã‚«ãƒ¼ãƒ‰ç•ªå·ãƒ»CVVãƒ»æœ‰åŠ¹æœŸé™ã«ä¸€åˆ‡ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„
      //    æœ¬ç•ªè¨­å®š: Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ API Keys â†’ Publishable key ã‚’
      //    ä¸‹è¨˜ STRIPE_PUBLISHABLE_KEY ã«è¨­å®šã—ã¦ãã ã•ã„
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      '<div class="field"><label>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±<span class="req">*</span></label>' +
      '<div id="stripe-card-element" style="border:1px solid var(--border);border-radius:8px;padding:12px 14px;background:var(--card2);font-size:15px;min-height:44px;" >' +
      '<div style="color:var(--muted);font-size:12px;padding:4px 0">ğŸ”’ Stripeå®‰å…¨æ±ºæ¸ˆ â€” ã‚«ãƒ¼ãƒ‰ç•ªå·ãƒ»CVVã¯StripeãŒç›´æ¥å‡¦ç†ã—ã¾ã™ï¼ˆCOREOTOã«ã¯å±Šãã¾ã›ã‚“ï¼‰</div>' +
      '</div></div>' +
      '<div id="stripe-card-errors" style="color:var(--danger);font-size:12px;margin-top:4px"></div>'
    ) +
    '<div style="display:flex;gap:10px;margin-top:8px">' +
    '<button class="btn btn-ghost" onclick="goStep(4)" style="width:auto;padding:10px 20px">â† æˆ»ã‚‹</button>' +
    '<button class="btn btn-blue" onclick="validateStep3()">æ¬¡ã¸ â†’</button>' +
    '</div></div></div>';
}

function fmtCard(el) {
  var v = el.value.replace(/\D/g,'').slice(0,16);
  el.value = v.replace(/(\d{4})(?=\d)/g,'$1 ');
  form.cardNo = el.value;
}
function fmtExp(el) {
  var v = el.value.replace(/\D/g,'').slice(0,4);
  el.value = v.length>2 ? v.slice(0,2)+'/'+v.slice(2) : v;
  form.cardExp = el.value;
}
function validateStep3() {
  if (!form.takkenSennin) {
    var card = document.getElementById('f-card') ? document.getElementById('f-card').value.trim() : '';
    var exp  = document.getElementById('f-exp')  ? document.getElementById('f-exp').value.trim()  : '';
    var cvv  = document.getElementById('f-cvv')  ? document.getElementById('f-cvv').value.trim()  : '';
    // ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯Stripe ElementsãŒç®¡ç† (form.cardNoç­‰ã¯CORETOå´ã«å­˜åœ¨ã—ãªã„)
    // Stripeã®PaymentMethod IDã¯ submitSignup() æ™‚ã«å–å¾—ã•ã‚Œã‚‹
  }
  goStep(6);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 6: LINE WORKS ç™»éŒ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP 6: LINE WORKS ç™»éŒ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stepWorks() {
  // ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ: CRT-{4æ¡ãƒ©ãƒ³ãƒ€ãƒ }-{ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆIDç›¸å½“}
  if (!form.worksCode) {
    var rand = Math.random().toString(36).substr(2,4).toUpperCase();
    var agSuffix = form.phone ? form.phone.slice(-4) : '0000';
    form.worksCode = 'CRT-' + rand + '-' + agSuffix;
  }
  var WORKS_ID = 'coreto-hq';
  var code = form.worksCode;
  var LINE_OA_ID = '@coreto';  // æœ¬ç•ªè¨­å®š

  document.getElementById('wrap').innerHTML =
    '<div class="card"><div class="ch"><div class="ch-t">LINE ç™»éŒ²</div><span class="pill pb">7 / 8</span></div><div class="cb">' +

    // â”€â”€ å…¬å¼LINE â”€â”€
    '<div style="margin-bottom:20px">' +
    '<div style="font-size:13px;font-weight:700;color:#e4e7f0;margin-bottom:10px">â‘  å…¬å¼LINE å‹é”ç™»éŒ²</div>' +
    '<div style="background:#191e28;border:1px solid #252c3d;border-radius:10px;padding:14px;display:flex;gap:14px;align-items:center">' +
    '<div style="font-size:32px">ğŸ“¢</div>' +
    '<div style="flex:1">' +
    '<div style="font-size:12px;color:#a0a8c0;line-height:1.8;margin-bottom:10px">ãŠçŸ¥ã‚‰ã›ãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚<br>å€‹äººè­˜åˆ¥ã¯ä¸è¦ã§ã™ã€‚å‹é”ç™»éŒ²ã ã‘ã§OKã§ã™ã€‚</div>' +
    '<div style="display:flex;gap:8px;flex-wrap:wrap">' +
    '<a href="https://line.me/R/ti/p/' + LINE_OA_ID + '" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:#06c755;color:#fff;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none">ğŸ“² å…¬å¼LINEã‚’è¿½åŠ </a>' +
    '<button onclick="copyLineOA()" style="padding:8px 14px;border:1px solid rgba(6,199,85,.3);border-radius:8px;background:transparent;color:#06c755;font-size:12px;cursor:pointer;font-family:inherit">ID: ' + LINE_OA_ID + ' ã‚’ã‚³ãƒ”ãƒ¼</button>' +
    '</div></div></div></div>' +

    '<div style="border-top:1px solid #1e2435;margin-bottom:20px"></div>' +

    // â”€â”€ LINE WORKS â”€â”€
    '<div>' +
    '<div style="font-size:13px;font-weight:700;color:#e4e7f0;margin-bottom:10px">â‘¡ LINE WORKS å‹é”ç™»éŒ²ï¼‹ç¢ºèªã‚³ãƒ¼ãƒ‰é€ä¿¡</div>' +
    '<div style="background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.3);border-radius:10px;padding:14px;margin-bottom:12px">' +
    '<div style="font-size:11px;color:#c9a840;font-weight:700;margin-bottom:6px">âš ï¸ æ¡ˆä»¶ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®å‚åŠ ã«å¿…é ˆã§ã™</div>' +
    '<div style="font-size:12px;color:#a0a8c0;line-height:1.8">CORETO WORKSï¼ˆID: <strong style="color:#c9a840">' + WORKS_ID + '</strong>ï¼‰ã‚’å‹é”ç™»éŒ²å¾Œã€<br>' +
    'ä¸‹è¨˜ã®<strong style="color:#e4e7f0">ç¢ºèªã‚³ãƒ¼ãƒ‰</strong>ã‚’ãƒˆãƒ¼ã‚¯ã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚<br>' +
    'é€ä¿¡å¾Œã€æœ¬éƒ¨ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç´ä»˜ã‘ã¦ç™»éŒ²ãŒå®Œäº†ã—ã¾ã™ã€‚</div>' +
    '</div>' +

    // ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢
    '<div style="background:#191e28;border:1px solid #252c3d;border-radius:10px;padding:16px;margin-bottom:12px">' +
    '<div style="font-size:10px;color:#4a4f68;letter-spacing:.5px;font-weight:600;margin-bottom:8px">ã‚ãªãŸã®ç¢ºèªã‚³ãƒ¼ãƒ‰</div>' +
    '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">' +
    '<div style="font-size:28px;font-weight:900;color:#c9a840;letter-spacing:3px">' + code + '</div>' +
    '<button onclick="copyWorksCode()" style="padding:6px 12px;border:1px solid rgba(201,168,76,.4);border-radius:6px;background:rgba(201,168,76,.1);color:#c9a840;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">ã‚³ãƒ”ãƒ¼</button>' +
    '</div>' +
    '<div style="background:#141820;border-radius:6px;padding:10px 12px;font-size:11px;color:#a0a8c0;line-height:1.8">' +
    'ğŸ“‹ <strong style="color:#e4e7f0">WORKSã«é€ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ï¼‰</strong><br>' +
    '<span id="works-copy-msg" style="color:#c9a840">ã€CORETOç™»éŒ²ã€‘' + form.name + ' / ' + code + '</span>' +
    '<button onclick="copyWorksMsg()" style="margin-left:10px;padding:3px 8px;border:1px solid #252c3d;border-radius:4px;background:transparent;color:#4a4f68;font-size:10px;cursor:pointer;font-family:inherit">ã‚³ãƒ”ãƒ¼</button>' +
    '</div></div>' +

    // WORKSè¿½åŠ ãƒœã‚¿ãƒ³
    '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">' +
    '<a href="https://talk.worksmobile.com/" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:#00b900;color:#fff;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none">ğŸ’¬ LINE WORKSã‚’é–‹ã</a>' +
    '<button onclick="copyWorksId2()" style="padding:8px 14px;border:1px solid rgba(201,168,76,.3);border-radius:8px;background:transparent;color:#c9a840;font-size:12px;cursor:pointer;font-family:inherit">WORKS ID: ' + WORKS_ID + ' ã‚’ã‚³ãƒ”ãƒ¼</button>' +
    '</div>' +

    // é€ä¿¡ç¢ºèªãƒã‚§ãƒƒã‚¯
    '<div id="works-sent-area">' +
    '<button onclick="markWorksSent()" style="width:100%;padding:11px;border:1px solid rgba(201,168,76,.35);border-radius:8px;background:rgba(201,168,76,.08);color:#c9a840;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">' +
    'âœ… ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ</button>' +
    '</div>' +

    '</div>' + // end LINE WORKS

    '<div style="display:flex;gap:10px;margin-top:20px">' +
    '<button class="btn btn-ghost" onclick="goStep(5)" style="width:auto;padding:10px 20px">â† æˆ»ã‚‹</button>' +
    '<button class="btn btn-primary" id="works-next-btn" onclick="validateWorksStep()" disabled style="opacity:.4">æ¬¡ã¸ â†’</button>' +
    '</div>' +
    '</div></div>';
}

function copyLineOA() {
  var ta = document.createElement('textarea');
  ta.value = '@coreto'; document.body.appendChild(ta); ta.select();
  document.execCommand('copy'); document.body.removeChild(ta);
  showSignupToast('å…¬å¼LINE IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

function copyWorksCode() {
  var ta = document.createElement('textarea');
  ta.value = form.worksCode; document.body.appendChild(ta); ta.select();
  document.execCommand('copy'); document.body.removeChild(ta);
  showSignupToast('ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

function copyWorksMsg() {
  var el = document.getElementById('works-copy-msg');
  var ta = document.createElement('textarea');
  ta.value = el ? el.textContent : form.worksCode; document.body.appendChild(ta); ta.select();
  document.execCommand('copy'); document.body.removeChild(ta);
  showSignupToast('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

function copyWorksId2() {
  var ta = document.createElement('textarea');
  ta.value = 'coreto-hq'; document.body.appendChild(ta); ta.select();
  document.execCommand('copy'); document.body.removeChild(ta);
  showSignupToast('WORKS IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

function copyWorksIdSignup() {
  copyWorksId2();
}

function markWorksSent() {
  form.worksCode_sent = true;
  document.getElementById('works-sent-area').innerHTML =
    '<div style="background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:12px;display:flex;align-items:center;gap:10px">' +
    '<div style="font-size:20px">âœ…</div>' +
    '<div style="font-size:12px;color:#c9a840;font-weight:700">ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡æ¸ˆã¿<br><span style="color:#a0a8c0;font-weight:400;font-size:11px">æœ¬éƒ¨ãŒç´ä»˜ã‘ã‚’å®Œäº†å¾Œã€ç™»éŒ²å®Œäº†ãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã™</span></div>' +
    '</div>';
  var btn = document.getElementById('works-next-btn');
  if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
  showSignupToast('ç¢ºèªã‚³ãƒ¼ãƒ‰ã®é€ä¿¡ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ âœ…');

  // Slacké€šçŸ¥: æœ¬ç•ªã§ã¯WORKSãƒœãƒƒãƒˆãŒå—ä¿¡ã—ã¦è‡ªå‹•ç…§åˆ
  console.log('[Slack] WORKSç™»éŒ²å¾…ã¡:', form.name, form.worksCode);
}

function confirmWorksAdded() { markWorksSent(); }

function validateWorksStep() {
  if (!form.worksCode_sent) { alert('ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¦ã‹ã‚‰æ¬¡ã¸é€²ã‚“ã§ãã ã•ã„ã€‚'); return; }
  goStep(7);
}

function showSignupToast(msg) {
  var t = document.getElementById('signup-toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'signup-toast';
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#1e2a1e;border:1px solid #34d399;color:#34d399;padding:10px 18px;border-radius:8px;font-size:12px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;font-family:inherit';
    document.body.appendChild(t);
  }
  t.textContent = msg; t.style.opacity = '1';
  setTimeout(function() { t.style.opacity = '0'; }, 2500);
}



function step6() {
  var rows = [
    ['æ°å', form.name + 'ï¼ˆ' + form.nameKana + 'ï¼‰'],
    ['é›»è©±ç•ªå·', form.phone],
    ['ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', form.email],
    ['ä½æ‰€', form.addr || 'â€”'],
    ['ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç¨®åˆ¥', form.agentType==='re'?'ä¸å‹•ç”£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆREï¼‰':'äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆHRï¼‰'],
    ['å®…å»ºå£«', form.hasTakken ? (form.takkenSennin ? 'â­ å°‚ä»»å®…å»ºå£«ã¨ã—ã¦ç™»éŒ²' : 'ä¸€èˆ¬ï¼ˆå®…å»ºå£«è³‡æ ¼ã‚ã‚Šï¼‰') : 'ãªã—'],
    form.hasTakken && form.takkenSennin ? ['å®…å»ºå£«è¨¼ç•ªå·', form.licNo + 'ï¼ˆ' + form.licPref + 'ï¼‰'] : null,
    ['æœˆä¼šè²»', form.monthlyFee===0 ? 'Â¥0ï¼ˆå°‚ä»»ç‰¹å…¸ãƒ»ç„¡æ–™ï¼‰' : 'Â¥980 / æœˆï¼ˆãƒ–ãƒ­ãƒ³ã‚ºã€‚ãƒ©ãƒ³ã‚¯æ˜‡æ ¼ã§å‰²å¼•ï¼‰'],
    ['ååˆº', form.meishiFee===0 ? 'Â¥0ï¼ˆå°‚ä»»ç‰¹å…¸ãƒ»ç„¡æ–™ï¼‰' : 'Â¥2,000ï¼ˆåˆå›ï¼‰'],
    ['ç´¹ä»‹ã‚³ãƒ¼ãƒ‰', form.referral || 'â€”'],
  ].filter(Boolean);

  document.getElementById('wrap').innerHTML =
    '<div class="card"><div class="ch"><div class="ch-t">ç”³è¾¼å†…å®¹ã®ç¢ºèª</div><span class="pill pb">7 / 7</span></div><div class="cb">' +
    (form.takkenSennin ? '<div class="al al-ok">â­ <div><strong style="color:var(--green)">å°‚ä»»å®…å»ºå£«ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™</strong><br>' +
    'æœˆä¼šè²»ãƒ»ååˆºè²»ç”¨ãŒç„¡æ–™ã«ãªã‚Šã¾ã™ã€‚ITé‡èª¬ã®å ±é…¬ã¯æœ¬éƒ¨ãŒè¨­å®šã—ã¾ã™ã€‚<br>' +
    '<span style="font-size:10px;color:var(--muted)">ä»–ç¤¾ã¸ã®å°‚ä»»å®…å»ºå£«ç™»éŒ²ã¯å®…å»ºæ¥­æ³•ä¸Šä¸å¯ã¨ãªã‚Šã¾ã™ã€‚</span></div></div>' : '') +
    rows.map(function(r){ return '<div class="sum-row"><span style="color:var(--sub)">'+r[0]+'</span><span style="font-weight:600">'+r[1]+'</span></div>'; }).join('') +
    '<div style="display:flex;gap:10px;margin-top:20px">' +
    '<button class="btn btn-ghost" onclick="goStep(6)" style="width:auto;padding:10px 20px">â† æˆ»ã‚‹</button>' +
    '<button class="btn btn-gold" onclick="submitSignup()">ç”³è¾¼ã‚’é€ä¿¡ã™ã‚‹ âœ“</button>' +
    '</div></div></div>';
}

async function submitSignup() {
  // â”€â”€ é€ä¿¡å…ˆè¨­å®šï¼ˆæœ¬ç•ªå‰ã«URLã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var ZAPIER_WEBHOOK_URL = 'YOUR_ZAPIER_WEBHOOK_URL_HERE';
  // â”€â”€ Webhook é€ä¿¡å…ƒæ¤œè¨¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Zapierå´ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: payload.source_sig === HMAC_SECRET ã®æœ€åˆã®8æ–‡å­—
  // æœ¬ç•ªå‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼ˆGitHubã«å…¬é–‹ã•ã‚Œã‚‹ãŸã‚å®Œå…¨ãªç§˜åŒ¿ã¯ä¸å¯ï¼‰
  var WEBHOOK_SHARED_SECRET = 'CRTv1-changeMe';
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // â”€â”€ ãƒãƒ‹ãƒ¼ãƒãƒƒãƒˆ: botãŒå…¥åŠ›ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Œã°é€ä¿¡æ‹’å¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var honeypot = document.getElementById('hp-field');
  if (honeypot && honeypot.value !== '') {
    console.warn('[Signup] ãƒãƒ‹ãƒ¼ãƒãƒƒãƒˆæ¤œçŸ¥ â€” boté€ä¿¡ã‚’ãƒ–ãƒ­ãƒƒã‚¯');
    return; // botã¯ä½•ã‚‚çŸ¥ã‚‰ã›ãšã«é™ã‹ã«ãƒ–ãƒ­ãƒƒã‚¯
  }

  // â”€â”€ ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒå¯¾ç­–: ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºã‹ã‚‰æœ€ä½5ç§’çµŒéã—ã¦ã„ã‚‹ã‹ â”€â”€â”€â”€â”€â”€
  var formOpenedAt = window._signupOpenedAt || Date.now();
  if ((Date.now() - formOpenedAt) < 5000) {
    console.warn('[Signup] é€ä¿¡ãŒé€Ÿã™ãã¾ã™ï¼ˆbotã®å¯èƒ½æ€§ï¼‰');
    return;
  }

  var appNo = 'APP-' + String(Date.now()).slice(-8);
  var submitBtn = document.querySelector('button[onclick*="submitSignup"]') || document.activeElement;
  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'é€ä¿¡ä¸­...'; }

  var payload = {
    appNo:        appNo,
    submittedAt:  new Date().toISOString(),
    agentType:    form.agentType === 're' ? 'ä¸å‹•ç”£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ' : 'äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ(HR)',
    name:         form.name,
    nameKana:     form.nameKana,
    phone:        form.phone,
    email:        form.email,
    zip:          form.zip,
    address:      form.addr,
    referralCode: form.referral || 'â€”',
    hasTakken:    form.hasTakken ? 'ã‚ã‚Š' : 'ãªã—',
    senninSpc:    form.takkenSennin ? 'å°‚ä»»å®…å»ºå£«å¸Œæœ›' : 'ä¸€èˆ¬ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ',
    licNo:        form.licNo || 'â€”',
    licPref:      form.licPref || 'â€”',
    bankName:     form.bankName,
    bankBranch:   form.bankBranch,
    bankType:     form.bankType,
    bankNum:      form.bankNum,
    bankHolder:   form.bankHolder,
    monthlyFee:   form.monthlyFee + 'å††',
    meishiWant:   form.meishiWant ? 'ã¯ã„' : 'ã„ã„ãˆ',
  };

  var sent = false;

  // Zapier Webhooké€ä¿¡
  if (ZAPIER_WEBHOOK_URL && ZAPIER_WEBHOOK_URL !== 'YOUR_ZAPIER_WEBHOOK_URL_HERE') {
    try {
      await fetch(ZAPIER_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        mode: 'no-cors'  // Zapier webhookã¯no-corsã§é€ä¿¡
      });
      sent = true;
    } catch(e) {
      console.error('[Signup] Zapier webhook failed:', e);
    }
  } else {
    console.warn('[Signup] ZAPIER_WEBHOOK_URL ãŒæœªè¨­å®šã§ã™ã€‚coreto-agent-signup.html ã® ZAPIER_WEBHOOK_URL ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
  }

  // é€ä¿¡å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
  var statusMsg = sent
    ? 'ç”³è¾¼ãƒ‡ãƒ¼ã‚¿ã‚’æœ¬éƒ¨ã«é€ä¿¡ã—ã¾ã—ãŸã€‚'
    : 'âš ï¸ ç”³è¾¼ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æœ¬éƒ¨ï¼ˆinfo@coreto.jpï¼‰ã«ç›´æ¥ã”é€£çµ¡ãã ã•ã„ã€‚';

  document.getElementById('wrap').innerHTML =
    '<div style="text-align:center;padding:60px 20px">' +
    '<div style="font-size:48px;margin-bottom:20px">' + (sent ? 'âœ…' : 'âš ï¸') + '</div>' +
    '<div style="font-family:\'Syne\',sans-serif;font-size:24px;font-weight:800;color:var(--green);margin-bottom:10px">ç”³è¾¼ãŒå®Œäº†ã—ã¾ã—ãŸ</div>' +
    '<div style="font-size:13px;color:var(--sub);line-height:2;margin-bottom:24px">' +
    statusMsg + '<br>' +
    'LINE WORKSã¸ã®ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>' +
    (form.takkenSennin
      ? 'å°‚ä»»å®…å»ºå£«ç™»éŒ²ã®å¯©æŸ»å¾Œã€æœ¬éƒ¨ã‚ˆã‚Šé€£çµ¡ã„ãŸã—ã¾ã™ã€‚<br>å¯©æŸ»å®Œäº†å¾Œã«IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚'
      : 'æœ¬éƒ¨ã§eKYCç¢ºèªå¾Œã€IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’SMSã§ãŠé€ã‚Šã—ã¾ã™ã€‚') +
    '</div>' +
    '<div style="background:var(--card2);border-radius:12px;padding:16px;font-size:12px;color:var(--muted);line-height:2;display:inline-block;text-align:left;min-width:280px">' +
    'ç”³è¾¼ç•ªå·ï¼š<span class="mono" style="color:var(--gold)">' + appNo + '</span><br>' +
    'æ°åï¼š' + form.name + '<br>' +
    'ç™»éŒ²ç¨®åˆ¥ï¼š' + (form.takkenSennin ? 'â­ å°‚ä»»å®…å»ºå£«' : 'ä¸€èˆ¬ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ') +
    '</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOKEN GATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ãƒ‡ãƒ¢ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæœ¬ç•ªã¯Kintone APIã§æ¤œè¨¼ï¼‰
var VALID_TOKENS = {
  'DEMO-AG10012': { name: 'å±±ç”° èª ',   agId: '10012', type: 're', label: 'ä¸å‹•ç”£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ' },
  'DEMO-AG20005': { name: 'ç”°ä¸­ ç¾ç©‚', agId: '20005', type: 'hr', label: 'äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ' },
  'DEMO-PT30001': { name: 'ä½è—¤ å•†äº‹', agId: '30001', type: 'pt', label: 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼' },
};

var tokenInfo = null; // èªè¨¼æ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±

function checkToken() {
  var params = new URLSearchParams(window.location.search);
  var token = params.get('token');
  var gate = document.getElementById('token-gate');

  if (!token) {
    // ãƒˆãƒ¼ã‚¯ãƒ³ãªã— = ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
    gate.style.display = 'flex';
    document.getElementById('gate-invalid').style.display = 'block';
    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã™
    document.getElementById('stepbar').style.display = 'none';
    document.getElementById('wrap').style.display = 'none';
    return;
  }

  var info = VALID_TOKENS[token.toUpperCase()];
  if (!info) {
    // ç„¡åŠ¹ãƒˆãƒ¼ã‚¯ãƒ³
    gate.style.display = 'flex';
    document.getElementById('gate-invalid').style.display = 'block';
    document.getElementById('stepbar').style.display = 'none';
    document.getElementById('wrap').style.display = 'none';
    return;
  }

  // æœ‰åŠ¹ãƒˆãƒ¼ã‚¯ãƒ³
  tokenInfo = info;
  form.agentType = info.type;
  gate.style.display = 'flex';
  document.getElementById('gate-valid').style.display = 'block';
  document.getElementById('gate-welcome').textContent =
    info.name + ' ã•ã‚“ã®å…¥ä¼šæ‰‹ç¶šããƒšãƒ¼ã‚¸ã§ã™ã€‚ï¼ˆ' + info.label + ' / ID: ' + info.agId + 'ï¼‰';
  document.getElementById('stepbar').style.display = 'none';
  document.getElementById('wrap').style.display = 'none';
}

function startOnboarding() {
  document.getElementById('token-gate').style.display = 'none';
  document.getElementById('stepbar').style.display = 'flex';
  document.getElementById('wrap').style.display = 'block';
  // æ°åãŒæ—¢çŸ¥ã®å ´åˆã¯step0ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«äº‹å‰å…¥åŠ›ï¼ˆæœ¬ç•ªï¼‰
  if (tokenInfo && tokenInfo.name) {
    // form.name = tokenInfo.name; // æœ¬ç•ª: Kintoneã‹ã‚‰å–å¾—ã—ãŸåå‰ã‚’äº‹å‰å…¥åŠ›
  }
  step0();
}

// â”€â”€ Init â”€â”€
checkToken();
</script>

  <!-- â”€â”€ Stripe.js (PCI DSSæº–æ‹ ã®ã‚«ãƒ¼ãƒ‰åé›†) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- æœ¬ç•ªå‰ã« Stripe ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã€publishable key ã‚’è¨­å®šã—ã¦ãã ã•ã„ -->
  <!-- https://stripe.com/jp â†’ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ é–‹ç™ºè€… â†’ API ã‚­ãƒ¼              -->
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // â”€â”€ Stripe è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var STRIPE_PUBLISHABLE_KEY = 'YOUR_STRIPE_PUBLISHABLE_KEY'; // â† ã“ã“ã«è¨­å®š
    var _stripe = null;
    var _stripeCardElement = null;

    function initStripeElements() {
      if (!STRIPE_PUBLISHABLE_KEY || STRIPE_PUBLISHABLE_KEY === 'YOUR_STRIPE_PUBLISHABLE_KEY') {
        // é–‹ç™ºç’°å¢ƒ: StripeãŒæœªè¨­å®šã®å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤ºã®ã¿
        var el = document.getElementById('stripe-card-element');
        if (el) el.innerHTML = '<div style="color:var(--amber);font-size:12px;padding:4px 0">âš ï¸ Stripeæœªè¨­å®šï¼ˆé–‹ç™ºç’°å¢ƒï¼‰â€” æœ¬ç•ªå‰ã« STRIPE_PUBLISHABLE_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>';
        return;
      }
      _stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
      var elements = _stripe.elements({
        fonts: [{ cssSrc: 'https://fonts.googleapis.com/css2?family=DM+Mono' }],
        locale: 'ja'
      });
      _stripeCardElement = elements.create('card', {
        style: {
          base: {
            color: '#e8e8e8', fontFamily: "'DM Mono', monospace", fontSize: '15px',
            '::placeholder': { color: '#4a5568' }
          },
          invalid: { color: '#fc8181' }
        },
        hidePostalCode: true
      });
      var mountEl = document.getElementById('stripe-card-element');
      if (mountEl) {
        _stripeCardElement.mount('#stripe-card-element');
        _stripeCardElement.on('change', function(e) {
          var errEl = document.getElementById('stripe-card-errors');
          if (errEl) errEl.textContent = e.error ? e.error.message : '';
        });
      }
    }

    // æ±ºæ¸ˆã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºæ™‚ã«Stripeã‚’ãƒã‚¦ãƒ³ãƒˆ
    var _origGoStep = window.goStep;
    document.addEventListener('DOMContentLoaded', function() {
      // Watch for card step rendering
      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(m) {
          if (document.getElementById('stripe-card-element') && !_stripeCardElement) {
            setTimeout(initStripeElements, 100);
          }
        });
      });
      observer.observe(document.body, { childList: true, subtree: true });
    });

    // submitSignup ã§Stripeã‹ã‚‰PaymentMethod IDã‚’å–å¾—
    var _origSubmit = window.submitSignup;
    window.submitSignup = async function() {
      // Stripeæœªè¨­å®šï¼ˆé–‹ç™ºç’°å¢ƒï¼‰ã®å ´åˆã¯ãã®ã¾ã¾é€ä¿¡
      if (!_stripe || !_stripeCardElement) {
        console.warn('[Stripe] æœªè¨­å®šã®ãŸã‚æ±ºæ¸ˆå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰');
        if (_origSubmit) await _origSubmit();
        return;
      }
      // Stripe PaymentMethod ã‚’ä½œæˆ
      var result = await _stripe.createPaymentMethod({
        type: 'card',
        card: _stripeCardElement,
        billing_details: { name: form.name }
      });
      if (result.error) {
        document.getElementById('stripe-card-errors').textContent = result.error.message;
        return;
      }
      // PaymentMethod IDã®ã¿ä¿æŒï¼ˆã‚«ãƒ¼ãƒ‰ç•ªå·ã¯CORETOå´ã«å±Šã‹ãªã„ï¼‰
      form.stripePaymentMethodId = result.paymentMethod.id;
      console.log('[Stripe] PaymentMethodä½œæˆæˆåŠŸ:', result.paymentMethod.id);
      if (_origSubmit) await _origSubmit();
    };
  </script>
</body>
</html>
