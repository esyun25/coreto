<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>重説スケジュール登録 | CORETO</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0d12;--bg2:#0f1219;--card:#141820;--card2:#191e28;
  --border:#1e2435;--border2:#252c3d;--text:#e4e7f0;--sub:#7a82a0;
  --muted:#3e4565;--gold:#c9a840;--gold2:#e0bc5a;
  --blue:#4f9cf9;--green:#34d399;--red:#f87171;--orange:#fb923c;
}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh}
.header{height:50px;display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;border-bottom:1px solid var(--border);background:var(--card2);flex-shrink:0}
.logo{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--gold);letter-spacing:3px}
.hdr-right{display:flex;align-items:center;gap:10px}
.agent-badge{font-size:10px;color:var(--sub);background:var(--card);border:1px solid var(--border2);border-radius:6px;padding:3px 10px}
.back-btn{font-size:10px;padding:5px 12px;border-radius:6px;border:1px solid var(--border2);background:transparent;color:var(--muted);cursor:pointer;font-family:inherit}
.layout{display:flex;flex-direction:column;height:calc(100vh - 50px);overflow:hidden}
.toolbar{height:48px;display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0}
.week-nav{display:flex;align-items:center;gap:10px}
.week-btn{background:var(--card2);border:1px solid var(--border2);color:var(--sub);border-radius:6px;
  padding:5px 12px;cursor:pointer;font-family:inherit;font-size:11px;transition:.1s}
.week-btn:hover{color:var(--text);border-color:var(--border)}
.week-label{font-size:12px;font-weight:700;color:var(--text);min-width:160px;text-align:center}
.stats{display:flex;gap:16px;font-size:11px}
.stat{display:flex;align-items:center;gap:5px}
.stat-dot{width:8px;height:8px;border-radius:50%}
.cal-wrap{flex:1;overflow:auto}
.cal-grid{display:grid;grid-template-columns:52px repeat(7,1fr);min-width:620px}
.col-head{background:var(--bg2);padding:8px 4px;text-align:center;
  position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border)}
.col-head-inner{font-size:10px;font-weight:700;color:var(--sub);line-height:1.7}
.col-head-inner .day-num{font-size:18px;font-weight:800;font-family:'Syne',sans-serif;display:block}
.time-label{background:var(--bg2);display:flex;align-items:flex-start;justify-content:flex-end;
  padding:0 6px;border-right:1px solid var(--border);font-family:'DM Mono',monospace;font-size:9px;
  color:var(--muted);position:relative}
.time-label .lbl{position:absolute;top:-6px;right:6px;font-size:9px;color:var(--sub)}
.cell{border-left:1px solid var(--border);cursor:pointer;transition:background .1s;position:relative}
.cell:hover{background:rgba(201,168,64,.05)}
.cell.past{cursor:default;opacity:.35}
.cell.past:hover{background:transparent}
.slot-block{position:absolute;inset:1px;border-radius:4px;z-index:2;
  display:flex;align-items:center;justify-content:center;
  font-size:7px;font-weight:700;line-height:1.3;padding:2px 3px;text-align:center}
.slot-block.open{background:rgba(52,211,153,.2);border:1px solid rgba(52,211,153,.5);
  color:var(--green);cursor:pointer}
.slot-block.open:hover{background:rgba(52,211,153,.3)}
.slot-block.booked{background:rgba(79,156,249,.15);border:1px solid rgba(79,156,249,.4);
  color:var(--blue);cursor:default}
/* Panel */
.day-panel{position:fixed;right:0;top:50px;bottom:0;width:340px;
  background:var(--card);border-left:1px solid var(--border);
  transform:translateX(100%);transition:transform .2s cubic-bezier(.4,0,.2,1);
  z-index:100;display:flex;flex-direction:column}
.day-panel.open{transform:translateX(0)}
.panel-hdr{padding:14px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.panel-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold)}
.close-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:4px 8px}
.panel-body{flex:1;overflow-y:auto;padding:14px 16px}
.add-form{background:var(--card2);border:1px solid var(--border2);border-radius:10px;
  padding:14px;margin-bottom:14px}
.form-lbl{font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:8px;text-transform:uppercase}
.time-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.tsel{background:var(--bg);border:1px solid var(--border2);border-radius:7px;padding:8px;
  color:var(--text);font-family:'DM Mono',monospace;font-size:13px;cursor:pointer;flex:1;outline:none}
.tsel:focus{border-color:var(--gold)}
.arr{color:var(--muted);font-size:12px;flex-shrink:0}
.btn-add{width:100%;padding:9px;border-radius:8px;background:rgba(201,168,64,.12);
  border:1px solid rgba(201,168,64,.35);color:var(--gold);font-family:inherit;
  font-size:12px;font-weight:700;cursor:pointer}
.btn-add:hover{background:rgba(201,168,64,.2)}
.list-lbl{font-size:10px;color:var(--muted);margin-bottom:8px;letter-spacing:1px}
.sitem{display:flex;align-items:center;gap:8px;padding:9px 11px;
  background:var(--card2);border:1px solid var(--border2);border-radius:8px;margin-bottom:6px}
.sitem.booked{border-color:rgba(79,156,249,.3)}
.stime{flex:1;font-family:'DM Mono',monospace;font-size:12px;font-weight:700}
.sdur{font-size:10px;color:var(--muted)}
.spill{font-size:9px;padding:2px 7px;border-radius:10px;font-weight:700}
.pill-o{background:rgba(52,211,153,.15);color:var(--green)}
.pill-b{background:rgba(79,156,249,.15);color:var(--blue)}
.del-btn{background:transparent;border:1px solid rgba(248,113,113,.25);color:var(--red);
  border-radius:5px;padding:3px 7px;font-size:10px;cursor:pointer;font-family:inherit}
.no-slots{font-size:11px;color:var(--muted);text-align:center;padding:20px;
  border:1px dashed var(--border2);border-radius:8px}
.panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:99;display:none}
.panel-overlay.show{display:block}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:var(--card2);border:1px solid var(--border);color:var(--text);
  padding:9px 18px;border-radius:10px;font-size:12px;z-index:9999;
  white-space:nowrap;pointer-events:none;transition:opacity .3s}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center;gap:10px">
    <div class="logo">CORETO</div>
    <span style="font-size:11px;color:var(--sub)">重説スケジュール管理</span>
  </div>
  <div class="hdr-right">
    <span class="agent-badge" id="agent-badge">—</span>
    <button class="back-btn" onclick="location.href='coreto-hub.html'">← マイページ</button>
  </div>
</div>

<div class="layout">
  <div class="toolbar">
    <div class="week-nav">
      <button class="week-btn" onclick="shiftWeek(-1)">◀</button>
      <div class="week-label" id="week-label">—</div>
      <button class="week-btn" onclick="shiftWeek(1)">▶</button>
      <button class="week-btn" onclick="goToday()" style="margin-left:4px">今週</button>
    </div>
    <div class="stats" id="stats-bar"></div>
  </div>
  <div class="cal-wrap" id="cal-wrap">
    <div class="cal-grid" id="cal-grid"></div>
  </div>
</div>

<div class="panel-overlay" id="panel-overlay" onclick="closePanel()"></div>

<div class="day-panel" id="day-panel">
  <div class="panel-hdr">
    <div class="panel-title" id="panel-title">—</div>
    <button class="close-btn" onclick="closePanel()">✕</button>
  </div>
  <div class="panel-body">
    <div class="add-form">
      <div class="form-lbl">⏱ 時間帯を追加</div>
      <div class="time-row">
        <select class="tsel" id="sel-start"></select>
        <span class="arr">→</span>
        <select class="tsel" id="sel-end"></select>
      </div>
      <button class="btn-add" onclick="addSlotFromPanel()">＋ この時間帯を追加</button>
    </div>
    <div class="list-lbl">登録済み時間帯</div>
    <div id="panel-slots-list"></div>
  </div>
</div>

<script>
// ── Session guard ──
(function(){
  var s = null;
  try { s = JSON.parse(sessionStorage.getItem('coreto_session') || 'null'); } catch(e) {}
  if (!s) { location.replace('coreto-hub.html'); return; }
  window._SESSION = s;
})();

// ── Storage ──
const STORE_KEY = 'coreto_itsetsu_slots';
function loadSlots() { try { return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); } catch(e) { return []; } }
function saveSlots(s) { localStorage.setItem(STORE_KEY, JSON.stringify(s)); }

// ── Agent badge ──
(function(){
  var u = window._SESSION || {};
  document.getElementById('agent-badge').textContent = (u.name || '—') + '　ID: ' + (u.userId || '—');
})();

// ── Helpers ──
function timeDiff(s, e) {
  var p1 = s.split(':').map(Number), p2 = e.split(':').map(Number);
  return (p2[0] * 60 + p2[1]) - (p1[0] * 60 + p1[1]);
}
function pad2(n) { return String(n).padStart(2, '0'); }
function fmtDur(m) { return m < 60 ? m + '分' : Math.floor(m / 60) + '時間' + (m % 60 ? m % 60 + '分' : ''); }

// ── Demo data ──
(function(){
  if (loadSlots().length > 0) return;
  var today = new Date();
  var u = window._SESSION || {};
  var aid = u.userId || 'AG-001', an = u.name || '重説担当';
  var demos = [];
  [[1,'09:30','11:00'],[1,'14:00','16:00'],[2,'10:00','12:00'],[3,'13:00','15:30'],[5,'09:00','10:30']].forEach(function(row){
    var off = row[0], s = row[1], e = row[2];
    var d = new Date(today); d.setDate(d.getDate() + off);
    demos.push({
      id: 'SL' + Date.now() + Math.random().toString(36).slice(2,5),
      agentId: aid, agentName: an,
      date: d.toISOString().slice(0,10),
      start: s, end: e, dur: timeDiff(s, e),
      status: 'open', bookedCase: null, bookedClient: null,
      meetUrl: '', bookingToken: ''
    });
  });
  demos[1].status = 'booked';
  demos[1].bookedClient = '田中 雄介';
  demos[1].bookedCase = 'R042857';
  demos[1].meetUrl = 'https://meet.google.com/demo-abc-xyz';
  saveSlots(demos);
})();

// ── State ──
var weekOffset = 0, activePanelDate = null;
var CELL_H = 20;
var DAYS_JP = ['月','火','水','木','金','土','日'];
var DAYS_F  = ['日','月','火','水','木','金','土'];

function getWeekStart(off) {
  var d = new Date(); d.setHours(0,0,0,0);
  var day = d.getDay();
  d.setDate(d.getDate() - (day === 0 ? 6 : day - 1) + off * 7);
  return d;
}
function goToday() { weekOffset = 0; renderCalendar(); }
function shiftWeek(dir) { weekOffset += dir; renderCalendar(); }

// ── Time selectors (30-min steps, 24h) ──
function buildTimeOptions(sel, selectedVal) {
  sel.innerHTML = '';
  for (var h = 0; h < 24; h++) {
    for (var m = 0; m < 60; m += 30) {
      var v = pad2(h) + ':' + pad2(m);
      var o = document.createElement('option');
      o.value = v; o.textContent = v;
      if (v === selectedVal) o.selected = true;
      sel.appendChild(o);
    }
  }
}

function onStartChange() {
  var s = document.getElementById('sel-start').value;
  var parts = s.split(':').map(Number);
  var nh = parts[0] + 1, nm = parts[1];
  if (nh >= 24) { nh = 23; nm = 30; }
  buildTimeOptions(document.getElementById('sel-end'), pad2(nh) + ':' + pad2(nm));
}

// ── Calendar render ──
function renderCalendar() {
  var ws = getWeekStart(weekOffset);
  var we = new Date(ws); we.setDate(we.getDate() + 6);
  document.getElementById('week-label').textContent =
    (ws.getMonth()+1) + '/' + ws.getDate() + ' 〜 ' + (we.getMonth()+1) + '/' + we.getDate();

  var slots = loadSlots();
  var today = new Date(); today.setHours(0,0,0,0);
  var nowH = new Date().getHours(), nowM = new Date().getMinutes();
  var grid = document.getElementById('cal-grid');
  grid.innerHTML = '';

  // Corner
  var corner = document.createElement('div');
  corner.className = 'col-head';
  corner.style.cssText = 'position:sticky;top:0;z-index:11;border-bottom:1px solid var(--border)';
  grid.appendChild(corner);

  // Day headers
  for (var d = 0; d < 7; d++) {
    var dd = new Date(ws); dd.setDate(dd.getDate() + d);
    var isToday = dd.toDateString() === today.toDateString();
    var isSat = d === 5, isSun = d === 6;
    var dateStr = dd.toISOString().slice(0,10);
    var openCnt   = slots.filter(function(s){ return s.date === dateStr && s.status === 'open'; }).length;
    var bookedCnt = slots.filter(function(s){ return s.date === dateStr && s.status === 'booked'; }).length;
    var col = isSat ? 'var(--blue)' : isSun ? 'var(--red)' : isToday ? 'var(--gold)' : '';
    var colStyle = col ? 'color:' + col : '';
    var div = document.createElement('div');
    div.className = 'col-head';
    div.style.cssText = 'position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border);border-left:1px solid var(--border);cursor:pointer';
    var badge = openCnt || bookedCnt
      ? (openCnt ? '<span style="color:var(--green)">' + openCnt + '枠</span>' : '')
        + (bookedCnt ? '<span style="color:var(--blue);margin-left:3px">' + bookedCnt + '予</span>' : '')
      : '<span style="color:var(--muted)">—</span>';
    div.innerHTML = '<div class="col-head-inner">'
      + '<span style="font-size:9px;' + colStyle + '">' + DAYS_JP[d] + '</span>'
      + '<span class="day-num" style="' + colStyle + '">' + dd.getDate() + '</span>'
      + '<span style="font-size:8px;display:block">' + badge + '</span>'
      + '</div>';
    (function(ds, dobj){ div.addEventListener('click', function(){ openPanel(ds, dobj); }); })(dateStr, dd);
    grid.appendChild(div);
  }

  // Time rows 00:00 – 23:30
  for (var h = 0; h < 24; h++) {
    for (var m = 0; m < 60; m += 30) {
      var isHour = m === 0;
      var borderCol = isHour ? 'var(--border)' : 'rgba(30,36,53,.5)';

      // Time label
      var tl = document.createElement('div');
      tl.className = 'time-label';
      tl.style.cssText = 'height:' + CELL_H + 'px;border-bottom:1px solid ' + borderCol;
      if (isHour) tl.innerHTML = '<span class="lbl">' + pad2(h) + ':00</span>';
      grid.appendChild(tl);

      // Cells
      for (var d2 = 0; d2 < 7; d2++) {
        var dd2 = new Date(ws); dd2.setDate(dd2.getDate() + d2);
        var dateStr2 = dd2.toISOString().slice(0,10);
        var timeStr  = pad2(h) + ':' + pad2(m);
        var isPast = dd2 < today || (dd2.toDateString() === today.toDateString() && (h < nowH || (h === nowH && m <= nowM)));

        var cell = document.createElement('div');
        cell.className = 'cell' + (isPast ? ' past' : '');
        cell.style.cssText = 'height:' + CELL_H + 'px;border-bottom:1px solid ' + borderCol;

        if (!isPast) {
          (function(ds, dobj){ cell.addEventListener('click', function(){ openPanel(ds, dobj); }); })(dateStr2, dd2);
        }

        // Slot blocks starting at this time
        slots.filter(function(s){ return s.date === dateStr2 && s.start === timeStr; }).forEach(function(slot){
          var rows = Math.max(1, slot.dur / 30);
          var blk = document.createElement('div');
          blk.className = 'slot-block ' + (slot.status === 'booked' ? 'booked' : 'open');
          blk.style.height = (rows * CELL_H - 2) + 'px';
          var label = slot.start + '〜' + slot.end;
          if (slot.status === 'booked') {
            blk.innerHTML = '<span>' + label + '<br>予約済</span>';
          } else {
            blk.innerHTML = '<span>' + label + '</span>';
            (function(sid, lbl){
              blk.addEventListener('click', function(e){
                e.stopPropagation();
                if (confirm(lbl + ' を削除しますか？')) removeSlot(sid);
              });
            })(slot.id, label);
          }
          cell.appendChild(blk);
        });

        grid.appendChild(cell);
      }
    }
  }

  renderStats();
}

// ── Panel ──
function openPanel(dateStr, dateObj) {
  activePanelDate = dateStr;
  var d = dateObj || new Date(dateStr);
  document.getElementById('panel-title').textContent =
    (d.getMonth()+1) + '月' + d.getDate() + '日（' + DAYS_F[d.getDay()] + '）';

  var ss = document.getElementById('sel-start');
  var se = document.getElementById('sel-end');
  buildTimeOptions(ss, '09:00');
  buildTimeOptions(se, '10:00');
  ss.onchange = onStartChange;

  renderPanelSlots();
  document.getElementById('day-panel').classList.add('open');
  document.getElementById('panel-overlay').classList.add('show');
}

function closePanel() {
  document.getElementById('day-panel').classList.remove('open');
  document.getElementById('panel-overlay').classList.remove('show');
  activePanelDate = null;
}

function renderPanelSlots() {
  if (!activePanelDate) return;
  var slots = loadSlots()
    .filter(function(s){ return s.date === activePanelDate; })
    .sort(function(a,b){ return a.start.localeCompare(b.start); });
  var el = document.getElementById('panel-slots-list');

  if (!slots.length) {
    el.innerHTML = '<div class="no-slots">登録なし<br>上から時間帯を追加してください</div>';
    return;
  }

  el.innerHTML = slots.map(function(s){
    return '<div class="sitem' + (s.status === 'booked' ? ' booked' : '') + '">'
      + '<div class="stime">' + s.start + ' 〜 ' + s.end + '</div>'
      + '<div class="sdur">' + fmtDur(s.dur) + '</div>'
      + '<span class="spill ' + (s.status === 'booked' ? 'pill-b' : 'pill-o') + '">'
      + (s.status === 'booked' ? '予約済' : '空き') + '</span>'
      + (s.status === 'open'
          ? '<button class="del-btn" onclick="removeSlot(\'' + s.id + '\')">削除</button>'
          : '<span style="font-size:9px;color:var(--blue)">' + (s.bookedClient || '') + '</span>')
      + '</div>';
  }).join('');
}

function addSlotFromPanel() {
  if (!activePanelDate) return;
  var start = document.getElementById('sel-start').value;
  var end   = document.getElementById('sel-end').value;

  if (start >= end) { toast('⚠️ 終了は開始より後にしてください'); return; }
  var dur = timeDiff(start, end);
  if (dur <= 0) { toast('⚠️ 時刻を確認してください'); return; }

  var slots = loadSlots();
  var overlap = slots.find(function(s){
    return s.date === activePanelDate && !(end <= s.start || start >= s.end);
  });
  if (overlap) { toast('⚠️ 他の時間帯と重複しています'); return; }

  var u = window._SESSION || {};
  slots.push({
    id: 'SL' + Date.now(),
    agentId:   u.userId || '—',
    agentName: u.name   || '重説担当',
    date:  activePanelDate,
    start: start,
    end:   end,
    dur:   dur,
    status: 'open',
    bookedCase: null, bookedClient: null, meetUrl: '',
    bookingToken: 'BK' + Math.random().toString(36).slice(2,8).toUpperCase()
  });
  saveSlots(slots);
  renderPanelSlots();
  renderCalendar();
  toast('✅ ' + start + ' 〜 ' + end + ' を追加');
}

function removeSlot(id) {
  saveSlots(loadSlots().filter(function(s){ return s.id !== id; }));
  renderPanelSlots();
  renderCalendar();
}

// ── Stats ──
function renderStats() {
  var today = new Date().toISOString().slice(0,10);
  var sl = loadSlots().filter(function(s){ return s.date >= today; });
  var o = sl.filter(function(s){ return s.status === 'open'; }).length;
  var b = sl.filter(function(s){ return s.status === 'booked'; }).length;
  document.getElementById('stats-bar').innerHTML =
    '<div class="stat"><div class="stat-dot" style="background:var(--green)"></div>空き: <strong>' + o + '</strong></div>'
    + '<div class="stat"><div class="stat-dot" style="background:var(--blue)"></div>予約済: <strong>' + b + '</strong></div>'
    + '<div class="stat" style="color:var(--muted)">合計: ' + (o+b) + '</div>';
}

// ── Toast ──
function toast(msg) {
  var el = document.createElement('div');
  el.className = 'toast'; el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(function(){ el.style.opacity = '0'; setTimeout(function(){ el.remove(); }, 300); }, 2200);
}

// ── Init ──
renderCalendar();
setTimeout(function(){ document.getElementById('cal-wrap').scrollTop = 16 * CELL_H; }, 50);
</script>
</body>
</html>
