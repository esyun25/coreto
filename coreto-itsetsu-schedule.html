<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- â”€â”€ Content Security Policy (XSSè»½æ¸›) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       å¤‰æ›´æ™‚: ä½¿ç”¨ã™ã‚‹å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
       Kintoneè¿½åŠ æ™‚: connect-src ã« *.cybozu.com ã‚’è¿½åŠ 
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline'
      https://cdnjs.cloudflare.com
      https://js.stripe.com
      https://cdn-cgi/scripts;
    style-src 'self' 'unsafe-inline'
      https://fonts.googleapis.com;
    font-src 'self'
      https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    connect-src 'self'
      https://hooks.slack.com
      https://hooks.zapier.com
      https://api.stripe.com
      https://js.stripe.com
      https://www.houjin-bangou.nta.go.jp
      https://www.retio.or.jp;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
  ">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>é‡èª¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ² | CORETO</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0d12;--bg2:#0f1219;--card:#141820;--card2:#191e28;
  --border:#1e2435;--border2:#252c3d;--text:#e4e7f0;--sub:#7a82a0;
  --muted:#3e4565;--gold:#c9a840;--gold2:#e0bc5a;
  --blue:#4f9cf9;--green:#34d399;--red:#f87171;--orange:#fb923c;
}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh}
.header{height:50px;display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;border-bottom:1px solid var(--border);background:var(--card2);flex-shrink:0}
.logo{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--gold);letter-spacing:3px}
.hdr-right{display:flex;align-items:center;gap:10px}
.agent-badge{font-size:10px;color:var(--sub);background:var(--card);border:1px solid var(--border2);border-radius:6px;padding:3px 10px}
.back-btn{font-size:10px;padding:5px 12px;border-radius:6px;border:1px solid var(--border2);background:transparent;color:var(--muted);cursor:pointer;font-family:inherit}
.layout{display:flex;flex-direction:column;height:calc(100vh - 50px);overflow:hidden}
.toolbar{height:48px;display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0}
.week-nav{display:flex;align-items:center;gap:10px}
.week-btn{background:var(--card2);border:1px solid var(--border2);color:var(--sub);border-radius:6px;
  padding:5px 12px;cursor:pointer;font-family:inherit;font-size:11px;transition:.1s}
.week-btn:hover{color:var(--text);border-color:var(--border)}
.week-label{font-size:12px;font-weight:700;color:var(--text);min-width:160px;text-align:center}
.stats{display:flex;gap:16px;font-size:11px}
.stat{display:flex;align-items:center;gap:5px}
.stat-dot{width:8px;height:8px;border-radius:50%}
.cal-wrap{flex:1;overflow:auto}
.cal-grid{display:grid;grid-template-columns:52px repeat(7,1fr);min-width:620px}
.col-head{background:var(--bg2);padding:8px 4px;text-align:center;
  position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border)}
.col-head-inner{font-size:10px;font-weight:700;color:var(--sub);line-height:1.7}
.col-head-inner .day-num{font-size:18px;font-weight:800;font-family:'Syne',sans-serif;display:block}
.time-label{background:var(--bg2);display:flex;align-items:flex-start;justify-content:flex-end;
  padding:0 6px;border-right:1px solid var(--border);font-family:'DM Mono',monospace;font-size:9px;
  color:var(--muted);position:relative}
.time-label .lbl{position:absolute;top:-6px;right:6px;font-size:9px;color:var(--sub)}
.cell{border-left:1px solid var(--border);cursor:pointer;transition:background .1s;position:relative}
.cell:hover{background:rgba(201,168,64,.05)}
.cell.past{cursor:default;opacity:.35}
.cell.past:hover{background:transparent}
.slot-block{position:absolute;inset:1px;border-radius:4px;z-index:2;
  display:flex;align-items:center;justify-content:center;
  font-size:7px;font-weight:700;line-height:1.3;padding:2px 3px;text-align:center}
.slot-block.open{background:rgba(52,211,153,.2);border:1px solid rgba(52,211,153,.5);
  color:var(--green);cursor:pointer}
.slot-block.open:hover{background:rgba(52,211,153,.3)}
.slot-block.booked{background:rgba(79,156,249,.15);border:1px solid rgba(79,156,249,.4);
  color:var(--blue);cursor:default}
/* Panel */
.day-panel{position:fixed;right:0;top:50px;bottom:0;width:340px;
  background:var(--card);border-left:1px solid var(--border);
  transform:translateX(100%);transition:transform .2s cubic-bezier(.4,0,.2,1);
  z-index:100;display:flex;flex-direction:column}
.day-panel.open{transform:translateX(0)}
.panel-hdr{padding:14px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.panel-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold)}
.close-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:4px 8px}
.panel-body{flex:1;overflow-y:auto;padding:14px 16px}
.add-form{background:var(--card2);border:1px solid var(--border2);border-radius:10px;
  padding:14px;margin-bottom:14px}
.form-lbl{font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:8px;text-transform:uppercase}
.time-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.tsel{background:var(--bg);border:1px solid var(--border2);border-radius:7px;padding:8px;
  color:var(--text);font-family:'DM Mono',monospace;font-size:13px;cursor:pointer;flex:1;outline:none}
.tsel:focus{border-color:var(--gold)}
.arr{color:var(--muted);font-size:12px;flex-shrink:0}
.btn-add{width:100%;padding:9px;border-radius:8px;background:rgba(201,168,64,.12);
  border:1px solid rgba(201,168,64,.35);color:var(--gold);font-family:inherit;
  font-size:12px;font-weight:700;cursor:pointer}
.btn-add:hover{background:rgba(201,168,64,.2)}
.list-lbl{font-size:10px;color:var(--muted);margin-bottom:8px;letter-spacing:1px}
.sitem{display:flex;align-items:center;gap:8px;padding:9px 11px;
  background:var(--card2);border:1px solid var(--border2);border-radius:8px;margin-bottom:6px}
.sitem.booked{border-color:rgba(79,156,249,.3)}
.stime{flex:1;font-family:'DM Mono',monospace;font-size:12px;font-weight:700}
.sdur{font-size:10px;color:var(--muted)}
.spill{font-size:9px;padding:2px 7px;border-radius:10px;font-weight:700}
.pill-o{background:rgba(52,211,153,.15);color:var(--green)}
.pill-b{background:rgba(79,156,249,.15);color:var(--blue)}
.del-btn{background:transparent;border:1px solid rgba(248,113,113,.25);color:var(--red);
  border-radius:5px;padding:3px 7px;font-size:10px;cursor:pointer;font-family:inherit}
.no-slots{font-size:11px;color:var(--muted);text-align:center;padding:20px;
  border:1px dashed var(--border2);border-radius:8px}
.panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:99;display:none}
.panel-overlay.show{display:block}
/* Request panel */
.req-badge{display:inline-flex;align-items:center;justify-content:center;
  min-width:18px;height:18px;border-radius:9px;background:var(--orange);
  color:#0b0d12;font-size:9px;font-weight:800;padding:0 4px;margin-left:4px}
.req-panel{position:fixed;top:0;right:-400px;width:380px;max-width:96vw;height:100vh;
  background:#111520;border-left:1px solid var(--border2);z-index:800;
  display:flex;flex-direction:column;transition:right .25s cubic-bezier(.4,0,.2,1)}
.req-panel.show{right:0}
.req-panel-hdr{padding:16px 18px;border-bottom:1px solid var(--border2);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.req-panel-body{flex:1;overflow-y:auto;padding:12px}
.ritem{background:var(--card);border:1px solid var(--border2);border-radius:10px;
  margin-bottom:10px;overflow:hidden}
.ritem-hdr{padding:10px 12px;display:flex;align-items:flex-start;gap:8px}
.ritem-status{font-size:9px;padding:2px 7px;border-radius:8px;font-weight:700;flex-shrink:0;margin-top:1px}
.rs-open{background:rgba(251,146,60,.15);color:var(--orange)}
.rs-matched{background:rgba(52,211,153,.15);color:var(--green)}
.rs-cancelled{background:rgba(99,107,140,.15);color:var(--muted)}
.ritem-body{padding:8px 12px 10px;border-top:1px solid var(--border)}
.wish-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;
  border-radius:6px;font-size:10px;font-family:'DM Mono',monospace;margin:3px 2px;
  background:rgba(30,36,53,.8);border:1px solid var(--border2)}
.wish-chip.match{background:rgba(201,168,64,.1);border-color:rgba(201,168,64,.35);color:var(--gold)}
.match-row{background:rgba(52,211,153,.07);border-top:1px solid rgba(52,211,153,.2);
  padding:8px 12px;font-size:10px;color:var(--green);display:flex;align-items:center;gap:6px}
.req-btn{font-size:10px;padding:5px 10px;border-radius:7px;border:none;cursor:pointer;
  font-family:inherit;font-weight:700;transition:.12s}
.req-btn-gold{background:var(--gold);color:#0b0d12}
.req-btn-gold:hover{background:var(--gold2)}
.req-btn-ghost{background:transparent;border:1px solid var(--border2);color:var(--sub)}
.req-btn-ghost:hover{border-color:var(--border);color:var(--text)}
.rank-badge{font-size:8px;padding:1px 5px;border-radius:5px}
.rank-pt{background:rgba(167,139,250,.15);color:#a78bfa}
.rank-gd{background:rgba(201,168,64,.15);color:#c9a840}
.rank-sv{background:rgba(192,192,192,.15);color:#c0c0c0}
.rank-br{background:rgba(205,127,50,.15);color:#cd7f32}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:var(--card2);border:1px solid var(--border);color:var(--text);
  padding:9px 18px;border-radius:10px;font-size:12px;z-index:9999;
  white-space:nowrap;pointer-events:none;transition:opacity .3s}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center;gap:10px">
    <div class="logo">CORETO</div>
    <span style="font-size:11px;color:var(--sub)">é‡èª¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</span>
  </div>
  <div class="hdr-right">
    <span class="agent-badge" id="agent-badge">â€”</span>
    <button class="back-btn" onclick="location.href='coreto-hub.html'">â† ãƒã‚¤ãƒšãƒ¼ã‚¸</button>
  </div>
</div>

<div class="layout">
  <div class="toolbar">
    <div class="week-nav">
      <button class="week-btn" onclick="shiftWeek(-1)">â—€</button>
      <div class="week-label" id="week-label">â€”</div>
      <button class="week-btn" onclick="shiftWeek(1)">â–¶</button>
      <button class="week-btn" onclick="goToday()" style="margin-left:4px">ä»Šé€±</button>
    </div>
    <div class="stats" id="stats-bar"></div>
    <button class="week-btn" onclick="openRequestPanel()" id="req-panel-btn"
      style="margin-left:8px;border-color:rgba(251,146,60,.4);color:var(--orange)">
      ğŸ“¨ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<span class="req-badge" id="req-badge" style="display:none">0</span>
    </button>
  </div>

  <!-- Request Panel -->
  <div class="req-panel" id="req-panel">
    <div class="req-panel-hdr">
      <div>
        <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--orange)">ğŸ“¨ æ—¥ç¨‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å¸Œæœ›æ—¥æ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
      </div>
      <button onclick="closeRequestPanel()" style="background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer">âœ•</button>
    </div>
    <div class="req-panel-body" id="req-panel-body">
      <div style="text-align:center;padding:32px;color:var(--muted);font-size:11px">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
  <div class="panel-overlay" id="req-overlay" onclick="closeRequestPanel()"></div>
  <div class="cal-wrap" id="cal-wrap">
    <div class="cal-grid" id="cal-grid"></div>
  </div>
</div>

<div class="panel-overlay" id="panel-overlay" onclick="closePanel()"></div>

<div class="day-panel" id="day-panel">
  <div class="panel-hdr">
    <div class="panel-title" id="panel-title">â€”</div>
    <button class="close-btn" onclick="closePanel()">âœ•</button>
  </div>
  <div class="panel-body">
    <div class="add-form">
      <div class="form-lbl">â± æ™‚é–“å¸¯ã‚’è¿½åŠ </div>
      <div class="time-row">
        <select class="tsel" id="sel-start"></select>
        <span class="arr">â†’</span>
        <select class="tsel" id="sel-end"></select>
      </div>
      <button class="btn-add" onclick="addSlotFromPanel()">ï¼‹ ã“ã®æ™‚é–“å¸¯ã‚’è¿½åŠ </button>
    </div>
    <div class="list-lbl">ç™»éŒ²æ¸ˆã¿æ™‚é–“å¸¯</div>
    <div id="panel-slots-list"></div>
  </div>
</div>

<script>
  // â”€â”€ Slacké€šçŸ¥è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æœ¬ç•ªé‹ç”¨å‰ã« Slack Incoming Webhook URL ã‚’è¨­å®šã—ã¦ãã ã•ã„
  // Slackç®¡ç†ç”»é¢ â†’ ã‚¢ãƒ—ãƒª â†’ Incoming Webhooks â†’ Webhook URLã‚’ã‚³ãƒ”ãƒ¼
  var SLACK_WEBHOOK = window.SLACK_CONFIG
    ? window.SLACK_CONFIG.GENERAL   // db.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
    : 'YOUR_SLACK_WEBHOOK_URL';     // ç›´æ¥è¨­å®šã™ã‚‹å ´åˆã¯ã“ã“ã«è²¼ã‚Šä»˜ã‘

  function notifySlack(msg) {
    if (!SLACK_WEBHOOK || SLACK_WEBHOOK === 'YOUR_SLACK_WEBHOOK_URL') {
      console.log('[Slackï¼ˆæœªè¨­å®šï¼‰]', msg);
      return;
    }
    fetch(SLACK_WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: msg }),
      mode: 'no-cors'
    }).catch(e => console.error('[Slacké€ä¿¡ã‚¨ãƒ©ãƒ¼]', e));
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ Session guard â”€â”€
(function(){
  var s = null;
  try { s = JSON.parse(sessionStorage.getItem('coreto_session') || 'null'); } catch(e) {}
  if (!s || !s.userId || !s.sessionToken || s.sessionToken.length !== 64) { sessionStorage.removeItem('coreto_session'); location.replace('coreto-login.html'); return; }
  var _la = new Date(s.loginAt).getTime();
  if (isNaN(_la) || (Date.now() - _la) > 28800000) { sessionStorage.removeItem('coreto_session'); alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚'); location.replace('coreto-login.html'); return; }
  window._SESSION = s;
})();

// â”€â”€ Storage â”€â”€
const STORE_KEY    = 'coreto_itsetsu_slots';
const BOOKINGS_KEY = 'coreto_itsetsu_bookings';
const REQUESTS_KEY = 'coreto_itsetsu_requests';
function loadSlots()    { try { return JSON.parse(localStorage.getItem(STORE_KEY)    || '[]'); } catch(e) { return []; } }
function saveSlots(s)   { localStorage.setItem(STORE_KEY,    JSON.stringify(s)); }
function loadBookings() { try { return JSON.parse(localStorage.getItem(BOOKINGS_KEY) || '[]'); } catch(e) { return []; } }
function saveBookings(b){ localStorage.setItem(BOOKINGS_KEY, JSON.stringify(b)); }
function loadRequests() { try { return JSON.parse(localStorage.getItem(REQUESTS_KEY) || '[]'); } catch(e) { return []; } }
function saveRequests(r){ localStorage.setItem(REQUESTS_KEY, JSON.stringify(r)); }

// â”€â”€ Rank priority map for matching â”€â”€
var RANK_PRIORITY = { Platinum:4, Gold:3, Silver:2, Bronze:1 };

// â”€â”€ Matching engine â”€â”€
// Priority: 1. dedicatedAgent  2. itCountå°‘ 3. ranké«˜ 4. ç™»éŒ²æ—©
function pickBestSlot(req, availSlots) {
  if (!availSlots.length) return null;
  var slots = availSlots.slice().sort(function(a, b) {
    // 1. dedicated agent always wins
    var aD = (a.agentId === req.dedicatedId) ? 0 : 1;
    var bD = (b.agentId === req.dedicatedId) ? 0 : 1;
    if (aD !== bD) return aD - bD;
    // 2. itCount ascending (less work = higher priority)
    var aCount = a.agentItCount || 0;
    var bCount = b.agentItCount || 0;
    if (aCount !== bCount) return aCount - bCount;
    // 3. rank descending
    var aRank = RANK_PRIORITY[a.agentRank] || 0;
    var bRank = RANK_PRIORITY[b.agentRank] || 0;
    if (aRank !== bRank) return bRank - aRank;
    // 4. registration time ascending (earlier = higher priority)
    return (a.id||'').localeCompare(b.id||'');
  });
  return slots[0];
}

function tryAutoMatch(req) {
  var slots = loadSlots();
  // Find slots matching any of req.wishes
  var candidates = [];
  req.wishes.forEach(function(w) {
    slots.filter(function(s){
      return s.status === 'open'
        && s.date === w.date
        && s.start <= w.start
        && s.end   >= w.end;
    }).forEach(function(s){ candidates.push({ slot:s, wish:w }); });
  });
  if (!candidates.length) return null;
  // Sort candidate slots using matching engine
  candidates.sort(function(a, b){
    var sa = a.slot, sb = b.slot;
    var aD = (sa.agentId === req.dedicatedId) ? 0 : 1;
    var bD = (sb.agentId === req.dedicatedId) ? 0 : 1;
    if (aD !== bD) return aD - bD;
    var aCount = sa.agentItCount || 0;
    var bCount = sb.agentItCount || 0;
    if (aCount !== bCount) return aCount - bCount;
    var aRank = RANK_PRIORITY[sa.agentRank] || 0;
    var bRank = RANK_PRIORITY[sb.agentRank] || 0;
    if (aRank !== bRank) return bRank - aRank;
    return (sa.id||'').localeCompare(sb.id||'');
  });
  return candidates[0];
}

function matchRequest(reqId) {
  var reqs  = loadRequests();
  var req   = reqs.find(function(r){ return r.id === reqId; });
  if (!req || req.status !== 'open') { toast('âš ï¸ ãƒãƒƒãƒãƒ³ã‚°ã§ãã¾ã›ã‚“ï¼ˆå—ä»˜ä¸­ä»¥å¤–ï¼‰'); return; }
  var match = tryAutoMatch(req);
  if (!match) { toast('âš ï¸ å¸Œæœ›æ—¥æ™‚ã«å¯¾å¿œã§ãã‚‹ç©ºãæ ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  // Confirm
  var slot = match.slot;
  var wish = match.wish;
  var msg = 'ãƒãƒƒãƒãƒ³ã‚°ç¢ºå®š: ' + fmtDateReq(slot.date) + ' ' + wish.start + 'ã€œ' + wish.end
    + ' / æ‹…å½“: ' + slot.agentName + (slot.agentRank ? ' (' + slot.agentRank + ')' : '')
    + ' / ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ' + req.clientName;
  if (!confirm(msg)) return;
  // Book the slot
  var slots  = loadSlots();
  var target = slots.find(function(s){ return s.id === slot.id; });
  if (!target || target.status !== 'open') { toast('âš ï¸ ã‚¹ãƒ­ãƒƒãƒˆãŒæ—¢ã«äºˆç´„æ¸ˆã¿ã§ã™'); renderRequestPanel(); return; }
  var meetUrl = genMeet();
  target.status = 'booked';
  target.bookedCase   = req.caseId;
  target.bookedClient = req.clientName;
  target.meetUrl      = meetUrl;
  target.bookedAt     = new Date().toISOString();
  saveSlots(slots);
  // Update booking
  var bookings = loadBookings();
  var bk = {
    id: 'BK'+Date.now(),
    slotId: target.id,
    caseId: req.caseId,
    clientName: req.clientName, propName: req.propName,
    agentId: req.agentId, agentName: req.agentName,
    itAgentId: target.agentId, itAgentName: target.agentName,
    dedicatedAgentId: req.dedicatedId,
    date: target.date, start: wish.start, dur: timeDiff(wish.start, wish.end),
    meetUrl: meetUrl,
    bookedAt: new Date().toISOString(),
    changeCount: 0, changeHistory: [], status: 'active', cancelledAt: null
  };
  bookings.push(bk);
  saveBookings(bookings);
  // Update request
  req.status       = 'matched';
  req.matchedSlotId   = target.id;
  req.matchedAgentId  = target.agentId;
  req.matchedAt    = new Date().toISOString();
  saveRequests(reqs);
  // â‘£ Slack: æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸è©³ç´°é€šçŸ¥ï¼‹LINEè»¢é€ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
  var matchDateStr = fmtDateReq(target.date);
  var changeUrl = location.origin + location.pathname.replace(/[^/]+$/, '')
    + 'coreto-itsetsu-booking.html?caseId=' + encodeURIComponent(req.caseId)
    + '&client='      + encodeURIComponent(req.clientName  || '')
    + '&prop='        + encodeURIComponent(req.propName    || '')
    + '&agent='       + encodeURIComponent(req.agentName   || '')
    + '&agentId='     + encodeURIComponent(req.agentId     || '')
    + '&dedicatedId=' + encodeURIComponent(req.dedicatedId || '');
  var matchMsg = '\u2705 *IT\u91cd\u8aac \u30de\u30c3\u30c1\u30f3\u30b0\u78ba\u5b9a*\n'
    + '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n'
    + '\u6848\u4ef6ID: ' + req.caseId + '\n'
    + '\u30af\u30e9\u30a4\u30a2\u30f3\u30c8: ' + req.clientName + ' \u69d8\n'
    + '\u62c5\u5f53: ' + req.agentName + '\n'
    + '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n'
    + '\u30de\u30c3\u30c1\u65e5\u6642: *' + matchDateStr + ' ' + wish.start + '\uff5e*\uff0830\uff5e45\u5206\uff09\n'
    + '\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9: ' + meetUrl + '\n'
    + '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n'
    + '\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u4ee5\u4e0b\u3092LINE\u7b49\u3067\u3054\u9023\u7d61\u304f\u3060\u3055\u3044\n'
    + '```\n'
    + '\u300c\u91cd\u8aac\u306e\u3054\u4e88\u7d04\u304c\u78ba\u5b9a\u3057\u307e\u3057\u305f\u300d\n'
    + matchDateStr + ' ' + wish.start + '\uff5e\uff0830\uff5e45\u5206\uff09\n'
    + '\n'
    + 'Google Meet\n'
    + meetUrl + '\n'
    + '\n'
    + '\u65e5\u7a0b\u5909\u66f4\u30fb\u30ad\u30e3\u30f3\u30bb\u30eb\u306f\u3053\u3061\u3089\n'
    + changeUrl + '\n'
    + '\u203224\u6642\u9593\u4ee5\u4e0a\u524d\u307e\u3067\u5909\u66f4\u53ef\u80fd\n'
    + '```';
  notifySlack('[Slack #IT\u91cd\u8aac\u65e5\u7a0b\u8abf\u6574] ' + matchMsg);
  toast('\u2705 \u30de\u30c3\u30c1\u30f3\u30b0\u5b8c\u4e86 \u2014 ' + target.agentName + ' ' + matchDateStr + ' ' + wish.start);
  renderCalendar();
  renderStats();
  renderRequestBadge();
  renderRequestPanel();
}

function cancelRequest(reqId) {
  if (!confirm('ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  var reqs = loadRequests();
  var req  = reqs.find(function(r){ return r.id === reqId; });
  if (!req) return;
  req.status = 'cancelled';
  req.cancelledAt = new Date().toISOString();
  saveRequests(reqs);
  toast('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
  renderRequestBadge();
  renderRequestPanel();
}

function fmtDateReq(ds) {
  var d = new Date(ds + 'T00:00:00');
  var WD = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  return (d.getMonth()+1) + '/' + d.getDate() + 'ï¼ˆ' + WD[d.getDay()] + 'ï¼‰';
}

// â”€â”€ Request panel UI â”€â”€
function renderRequestBadge() {
  var open = loadRequests().filter(function(r){ return r.status === 'open'; }).length;
  var badge = document.getElementById('req-badge');
  if (!badge) return;
  badge.textContent = open;
  badge.style.display = open > 0 ? '' : 'none';
}

function openRequestPanel() {
  document.getElementById('req-panel').classList.add('show');
  document.getElementById('req-overlay').classList.add('show');
  renderRequestPanel();
}

function closeRequestPanel() {
  document.getElementById('req-panel').classList.remove('show');
  document.getElementById('req-overlay').classList.remove('show');
}

function renderRequestPanel() {
  var body = document.getElementById('req-panel-body');
  if (!body) return;
  var reqs = loadRequests().filter(function(r){ return r.status !== 'cancelled'; });
  reqs.sort(function(a,b){ return b.submittedAt.localeCompare(a.submittedAt); });
  if (!reqs.length) {
    body.innerHTML = '<div style="text-align:center;padding:32px;color:var(--muted);font-size:11px">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  body.innerHTML = reqs.map(function(r) {
    var statusCls = r.status === 'open' ? 'rs-open' : (r.status === 'matched' ? 'rs-matched' : 'rs-cancelled');
    var statusLbl = r.status === 'open' ? 'å—ä»˜ä¸­' : (r.status === 'matched' ? 'ãƒãƒƒãƒãƒ³ã‚°æ¸ˆ' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
    var wishHtml = r.wishes.map(function(w) {
      // Check if any slot covers this wish
      var slots = loadSlots();
      var hasSlot = slots.some(function(s){
        return s.status==='open' && s.date===w.date && s.start<=w.start && s.end>=w.end;
      });
      return '<span class="wish-chip' + (hasSlot?' match':'') + '">'
        + fmtDateReq(w.date) + ' ' + w.start + 'ã€œ' + w.end
        + (hasSlot ? ' âœ“' : '') + '</span>';
    }).join('');
    var matchInfo = r.status === 'matched' ? (
      '<div class="match-row">âœ… ãƒãƒƒãƒãƒ³ã‚°æ¸ˆ â€” ' + (r.matchedAgentId||'â€”') + ' ' + (r.matchedAt||'').slice(0,10) + '</div>'
    ) : '';
    // Auto-match check
    var match = r.status === 'open' ? tryAutoMatch(r) : null;
    var actionHtml = '';
    if (r.status === 'open') {
      actionHtml = '<div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">'
        + (match
          ? '<button class="req-btn req-btn-gold" onclick="matchRequest(\'' + r.id + '\')">âš¡ ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ</button>'
          : '<span style="font-size:9px;color:var(--muted)">å¯¾å¿œã§ãã‚‹ç©ºãæ ãªã—</span>')
        + '<button class="req-btn req-btn-ghost" onclick="cancelRequest(\'' + r.id + '\')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
        + '</div>';
    }
    return '<div class="ritem">'
      + '<div class="ritem-hdr">'
      + '<span class="ritem-status '+statusCls+'">'+statusLbl+'</span>'
      + '<div style="flex:1">'
      + '<div style="font-size:12px;font-weight:700">'+r.clientName+' æ§˜</div>'
      + '<div style="font-size:10px;color:var(--sub)">'+r.caseId+' / æ‹…å½“: '+r.agentName+'</div>'
      + '<div style="font-size:9px;color:var(--muted);margin-top:1px">é€ä¿¡: '+(r.submittedAt||'').slice(0,16).replace('T',' ')+'</div>'
      + '</div></div>'
      + '<div class="ritem-body">'
      + '<div style="font-size:9px;color:var(--muted);margin-bottom:4px">å¸Œæœ›æ—¥æ™‚</div>'
      + wishHtml
      + actionHtml
      + '</div>'
      + matchInfo
      + '</div>';
  }).join('');
}

// â”€â”€ HQ / agent mode â”€â”€
var isHQ      = (window._SESSION && (window._SESSION.type === 'hq'));
var myAgentId = (window._SESSION && window._SESSION.userId) || '';

// â”€â”€ Cancel helpers â”€â”€
function hasAlternative(slot) {
  return loadSlots().some(function(s){
    return s.id !== slot.id && s.date === slot.date &&
           s.start === slot.start && s.status === 'open';
  });
}
function minsUntilSlot(slot) {
  return (new Date(slot.date+'T'+slot.start+':00') - new Date()) / 60000;
}
function canCancelSlot(slot) {
  if (slot.status !== 'booked') return false;
  var mins = minsUntilSlot(slot);
  if (mins <= 0) return false;
  if (isHQ) return true;
  if (mins <= 24*60) return false;
  return hasAlternative(slot);
}
function cancelReasonText(slot) {
  if (slot.status !== 'booked') return '';
  var mins = minsUntilSlot(slot);
  if (mins <= 0) return '';
  if (!isHQ && mins <= 24*60) return '24æ™‚é–“ä»¥å†… / æœ¬éƒ¨ã®ã¿å¯';
  if (!isHQ && !hasAlternative(slot)) return 'ä»£æ›¿æ‹…å½“è€…ã®ç©ºããªã—';
  return '';
}
function releaseBookingForSlot(slotId) {
  var bookings = loadBookings();
  var bk = bookings.find(function(b){ return b.slotId === slotId && b.status !== 'cancelled'; });
  if (bk) {
    bk.status = 'cancelled';
    bk.cancelledAt = new Date().toISOString();
    bk.cancelReason = isHQ ? 'hq' : 'agent';
    saveBookings(bookings);
  }
}

// â”€â”€ Agent badge â”€â”€
(function(){
  var u = window._SESSION || {};
  document.getElementById('agent-badge').textContent = (u.name || 'â€”') + 'ã€€ID: ' + (u.userId || 'â€”');
})();

// â”€â”€ Helpers â”€â”€
function timeDiff(s, e) {
  var p1 = s.split(':').map(Number), p2 = e.split(':').map(Number);
  return (p2[0] * 60 + p2[1]) - (p1[0] * 60 + p1[1]);
}
function pad2(n) { return String(n).padStart(2, '0'); }
function fmtDur(m) { return m < 60 ? m + 'åˆ†' : Math.floor(m / 60) + 'æ™‚é–“' + (m % 60 ? m % 60 + 'åˆ†' : ''); }

// â”€â”€ Demo data â”€â”€
(function(){
  if (loadSlots().length > 20) return; // ãƒ‡ãƒ¢: 20æ ä»¥ä¸‹ãªã‚‰å†ç”Ÿæˆ
  var today = new Date();
  var u = window._SESSION || {};
  var agents = [
    { id: u.userId || '10012', name: u.name || 'å±±ç”° èª ',   rank: 'Gold',   itCount: 2 },
    { id: '10015',             name: 'ä½è—¤ èŠ±å­',           rank: 'Silver', itCount: 1 },
    { id: '10023',             name: 'éˆ´æœ¨ æ‹“ä¹Ÿ',           rank: 'Platinum', itCount: 0 },
    { id: '10031',             name: 'ç”°æ‘ ã•ã‚„ã‹',         rank: 'Bronze', itCount: 3 },
  ];
  // æ™‚é–“æ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ1æ™‚é–“å˜ä½ï¼‰
  var slots9to21 = [
    '09:00','10:00','11:00','12:00','13:00','14:00',
    '15:00','16:00','17:00','18:00','19:00','20:00'
  ];
  var demos = [];
  var seed = 42;
  function rnd() { seed = (seed * 1103515245 + 12345) & 0x7fffffff; return seed / 0x7fffffff; }

  // ä»Šæ—¥ã‹ã‚‰14æ—¥é–“ Ã— å„æ™‚é–“æ  Ã— ç´„70%ã‚«ãƒãƒ¼
  for (var dayOff = 1; dayOff <= 14; dayOff++) {
    var d = new Date(today);
    d.setDate(today.getDate() + dayOff);
    var dow = d.getDay(); // 0=æ—¥
    // æ—¥æ›œã¯æ å°‘ãªã‚ï¼ˆ40%ï¼‰ã€åœŸæ›œã¯å°‘ãªã‚ï¼ˆ55%ï¼‰ã€å¹³æ—¥ã¯70%
    var fillRate = dow === 0 ? 0.4 : dow === 6 ? 0.55 : 0.7;
    slots9to21.forEach(function(start) {
      if (rnd() > fillRate) return; // ã‚¹ã‚­ãƒƒãƒ—
      var hour = parseInt(start);
      var end = (hour + 1 < 21 ? (hour + 1) : 21) + ':00';
      var agent = agents[Math.floor(rnd() * agents.length)];
      var isBooked = rnd() < 0.15; // 15%ã¯ã™ã§ã«äºˆç´„æ¸ˆã¿
      var slotId = 'SL' + d.toISOString().slice(0,10).replace(/-/g,'') + start.replace(':','') + agent.id;
      var slot = {
        id: slotId,
        agentId: agent.id, agentName: agent.name,
        agentRank: agent.rank, agentItCount: agent.itCount,
        date: d.toISOString().slice(0,10),
        start: start, end: end, dur: 60,
        status: isBooked ? 'booked' : 'open',
        bookedCase: isBooked ? 'R0' + Math.floor(rnd()*90000+10000) : null,
        bookedClient: isBooked ? ['ç”°ä¸­ é›„ä»‹','ä½è—¤ ç¾å’²','éˆ´æœ¨ å¥å¤ª','å±±æœ¬ ç”±ç¾'][Math.floor(rnd()*4)] : null,
        meetUrl: isBooked ? 'https://meet.google.com/demo-'+slotId.slice(-6) : '',
        bookingToken: 'BK' + slotId.slice(-6).toUpperCase()
      };
      demos.push(slot);
    });
  }
  saveSlots(demos);
})();

// â”€â”€ State â”€â”€
var weekOffset = 0, activePanelDate = null;
var CELL_H = 20;
var DAYS_JP = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
var DAYS_F  = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

function getWeekStart(off) {
  var d = new Date(); d.setHours(0,0,0,0);
  var day = d.getDay();
  d.setDate(d.getDate() - (day === 0 ? 6 : day - 1) + off * 7);
  return d;
}
function goToday() { weekOffset = 0; renderCalendar(); }
function shiftWeek(dir) { weekOffset += dir; renderCalendar(); }

// â”€â”€ Time selectors (30-min steps, 24h) â”€â”€
function buildTimeOptions(sel, selectedVal) {
  sel.innerHTML = '';
  for (var h = 0; h < 24; h++) {
    for (var m = 0; m < 60; m += 30) {
      var v = pad2(h) + ':' + pad2(m);
      var o = document.createElement('option');
      o.value = v; o.textContent = v;
      if (v === selectedVal) o.selected = true;
      sel.appendChild(o);
    }
  }
}

function onStartChange() {
  var s = document.getElementById('sel-start').value;
  var parts = s.split(':').map(Number);
  var nh = parts[0] + 1, nm = parts[1];
  if (nh >= 24) { nh = 23; nm = 30; }
  buildTimeOptions(document.getElementById('sel-end'), pad2(nh) + ':' + pad2(nm));
}

// â”€â”€ Calendar render â”€â”€
function renderCalendar() {
  var ws = getWeekStart(weekOffset);
  var we = new Date(ws); we.setDate(we.getDate() + 6);
  document.getElementById('week-label').textContent =
    (ws.getMonth()+1) + '/' + ws.getDate() + ' ã€œ ' + (we.getMonth()+1) + '/' + we.getDate();

  var slots = loadSlots();
  var today = new Date(); today.setHours(0,0,0,0);
  var nowH = new Date().getHours(), nowM = new Date().getMinutes();
  var grid = document.getElementById('cal-grid');
  grid.innerHTML = '';

  // Corner
  var corner = document.createElement('div');
  corner.className = 'col-head';
  corner.style.cssText = 'position:sticky;top:0;z-index:11;border-bottom:1px solid var(--border)';
  grid.appendChild(corner);

  // Day headers
  for (var d = 0; d < 7; d++) {
    var dd = new Date(ws); dd.setDate(dd.getDate() + d);
    var isToday = dd.toDateString() === today.toDateString();
    var isSat = d === 5, isSun = d === 6;
    var dateStr = dd.toISOString().slice(0,10);
    var openCnt   = slots.filter(function(s){ return s.date === dateStr && s.status === 'open'; }).length;
    var bookedCnt = slots.filter(function(s){ return s.date === dateStr && s.status === 'booked'; }).length;
    var col = isSat ? 'var(--blue)' : isSun ? 'var(--red)' : isToday ? 'var(--gold)' : '';
    var colStyle = col ? 'color:' + col : '';
    var div = document.createElement('div');
    div.className = 'col-head';
    div.style.cssText = 'position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border);border-left:1px solid var(--border);cursor:pointer';
    var badge = openCnt || bookedCnt
      ? (openCnt ? '<span style="color:var(--green)">' + openCnt + 'æ </span>' : '')
        + (bookedCnt ? '<span style="color:var(--blue);margin-left:3px">' + bookedCnt + 'äºˆ</span>' : '')
      : '<span style="color:var(--muted)">â€”</span>';
    div.innerHTML = '<div class="col-head-inner">'
      + '<span style="font-size:9px;' + colStyle + '">' + DAYS_JP[d] + '</span>'
      + '<span class="day-num" style="' + colStyle + '">' + dd.getDate() + '</span>'
      + '<span style="font-size:8px;display:block">' + badge + '</span>'
      + '</div>';
    (function(ds, dobj){ div.addEventListener('click', function(){ openPanel(ds, dobj); }); })(dateStr, dd);
    grid.appendChild(div);
  }

  // Time rows 00:00 â€“ 23:30
  for (var h = 0; h < 24; h++) {
    for (var m = 0; m < 60; m += 30) {
      var isHour = m === 0;
      var borderCol = isHour ? 'var(--border)' : 'rgba(30,36,53,.5)';

      // Time label
      var tl = document.createElement('div');
      tl.className = 'time-label';
      tl.style.cssText = 'height:' + CELL_H + 'px;border-bottom:1px solid ' + borderCol;
      if (isHour) tl.innerHTML = '<span class="lbl">' + pad2(h) + ':00</span>';
      grid.appendChild(tl);

      // Cells
      for (var d2 = 0; d2 < 7; d2++) {
        var dd2 = new Date(ws); dd2.setDate(dd2.getDate() + d2);
        var dateStr2 = dd2.toISOString().slice(0,10);
        var timeStr  = pad2(h) + ':' + pad2(m);
        var isPast = dd2 < today || (dd2.toDateString() === today.toDateString() && (h < nowH || (h === nowH && m <= nowM)));

        var cell = document.createElement('div');
        cell.className = 'cell' + (isPast ? ' past' : '');
        cell.style.cssText = 'height:' + CELL_H + 'px;border-bottom:1px solid ' + borderCol;

        if (!isPast) {
          (function(ds, dobj){ cell.addEventListener('click', function(){ openPanel(ds, dobj); }); })(dateStr2, dd2);
        }

        // Slot blocks starting at this time
        slots.filter(function(s){ return s.date === dateStr2 && s.start === timeStr; }).forEach(function(slot){
          var rows = Math.max(1, slot.dur / 30);
          var blk = document.createElement('div');
          blk.className = 'slot-block ' + (slot.status === 'booked' ? 'booked' : 'open');
          blk.style.height = (rows * CELL_H - 2) + 'px';
          var label = slot.start + 'ã€œ' + slot.end;
          if (slot.status === 'booked') {
            blk.innerHTML = '<span>' + label + '<br>äºˆç´„æ¸ˆ</span>';
          } else {
            blk.innerHTML = '<span>' + label + '</span>';
            (function(sid, lbl){
              blk.addEventListener('click', function(e){
                e.stopPropagation();
                if (confirm(lbl + ' ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) removeSlot(sid);
              });
            })(slot.id, label);
          }
          cell.appendChild(blk);
        });

        grid.appendChild(cell);
      }
    }
  }

  renderStats();
}

// â”€â”€ Panel â”€â”€
function openPanel(dateStr, dateObj) {
  activePanelDate = dateStr;
  var d = dateObj || new Date(dateStr);
  document.getElementById('panel-title').textContent =
    (d.getMonth()+1) + 'æœˆ' + d.getDate() + 'æ—¥ï¼ˆ' + DAYS_F[d.getDay()] + 'ï¼‰';

  var ss = document.getElementById('sel-start');
  var se = document.getElementById('sel-end');
  buildTimeOptions(ss, '09:00');
  buildTimeOptions(se, '10:00');
  ss.onchange = onStartChange;

  renderPanelSlots();
  document.getElementById('day-panel').classList.add('open');
  document.getElementById('panel-overlay').classList.add('show');
}

function closePanel() {
  document.getElementById('day-panel').classList.remove('open');
  document.getElementById('panel-overlay').classList.remove('show');
  activePanelDate = null;
}

function renderPanelSlots() {
  if (!activePanelDate) return;
  var slots = loadSlots()
    .filter(function(s){ return s.date === activePanelDate; })
    .sort(function(a,b){ return a.start.localeCompare(b.start); });
  var el = document.getElementById('panel-slots-list');

  if (!slots.length) {
    el.innerHTML = '<div class="no-slots">ç™»éŒ²ãªã—<br>ä¸Šã‹ã‚‰æ™‚é–“å¸¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
    return;
  }

  el.innerHTML = slots.map(function(s){
    var canCancel = canCancelSlot(s);
    var reason    = cancelReasonText(s);
    // â‘¨ äºˆç´„æ¸ˆã‚¹ãƒ­ãƒƒãƒˆ: æ¡ˆä»¶æƒ…å ±è©³ç´°ã‚’è¡¨ç¤º
    var bookedInfo = '';
    if (s.status === 'booked') {
      var bkData = loadBookings().find(function(b){ return b.slotId === s.id && b.status === 'active'; });
      var propTxt = bkData ? (bkData.propName || '') : '';
      bookedInfo = '<div style="margin-top:4px;padding:6px 8px;background:rgba(79,156,249,.06);border:1px solid rgba(79,156,249,.15);border-radius:6px">'
        + '<div style="font-size:9px;color:var(--blue);font-weight:700">' + (s.bookedClient || 'â€”') + ' æ§˜</div>'
        + (s.bookedCase ? '<div style="font-size:8px;color:var(--muted);margin-top:1px">æ¡ˆä»¶ID: ' + s.bookedCase + '</div>' : '')
        + (propTxt      ? '<div style="font-size:8px;color:var(--muted)">ç‰©ä»¶: ' + propTxt + '</div>' : '')
        + (bkData && bkData.agentName ? '<div style="font-size:8px;color:var(--muted)">æ‹…å½“AG: ' + bkData.agentName + '</div>' : '')
        + (bkData && bkData.meetUrl   ? '<div style="font-size:8px;color:var(--muted);word-break:break-all">Meet: ' + bkData.meetUrl + '</div>' : '')
        + '</div>';
    } else if (s.bookedClient) {
      bookedInfo = '<div style="font-size:9px;color:var(--blue);margin-top:1px">' + s.bookedClient + (s.bookedCase ? ' (' + s.bookedCase + ')' : '') + '</div>';
    }
    var hqBadge = (isHQ && s.status==='booked') ? '<span style="font-size:8px;padding:1px 5px;border-radius:6px;background:rgba(201,168,64,.15);color:var(--gold);margin-left:4px">HQ</span>' : '';
    var cancelBtn = canCancel
      ? '<button class="del-btn" onclick="cancelBookedSlot(\'' + s.id + '\')" style="border-color:rgba(251,146,60,.4);color:var(--orange)">è§£é™¤</button>'
      : (reason ? '<span style="font-size:8px;color:var(--muted)">' + reason + '</span>' : '');
    var deleteBtn = s.status === 'open'
      ? '<button class="del-btn" onclick="removeSlot(\'' + s.id + '\')">å‰Šé™¤</button>'
      : '';
    // â‘© é‡èª¬æ‹…å½“ã‹ã‚‰ã®å®Œäº†å ±å‘Šãƒœã‚¿ãƒ³
    var doneBtn = '';
    if (s.status === 'booked' && s.bookedCase) {
      doneBtn = s.itDone
        ? '<div style="margin-top:6px;text-align:center;font-size:9px;color:#34d399;padding:4px;background:rgba(52,211,153,.06);border-radius:6px">âœ… å®Œäº†å ±å‘Šæ¸ˆã¿</div>'
        : '<button onclick="reportItDone(\'' + s.id + '\')" style="margin-top:6px;width:100%;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);color:#34d399;border-radius:6px;padding:6px;cursor:pointer;font-size:10px;font-family:inherit;font-weight:700">âœ… é‡èª¬ãƒ»å¥‘ç´„ å®Œäº†ã‚’å ±å‘Šã™ã‚‹</button>';
    }
    return '<div class="sitem' + (s.status==='booked'?' booked':'') + '">'
      + '<div style="flex:1">'
      + '<div class="stime">' + s.start + ' ã€œ ' + s.end + hqBadge + '</div>'
      + '<div class="sdur">' + fmtDur(s.dur) + '</div>'
      + bookedInfo + doneBtn + '</div>'
      + '<span class="spill ' + (s.status==='booked'?'pill-b':'pill-o') + '">'
      + (s.status==='booked'?'äºˆç´„æ¸ˆ':'ç©ºã') + '</span>'
      + (s.status==='booked' ? cancelBtn : deleteBtn)
      + '</div>';
  }).join('');
}

function addSlotFromPanel() {
  if (!activePanelDate) return;
  var start = document.getElementById('sel-start').value;
  var end   = document.getElementById('sel-end').value;

  if (start >= end) { toast('âš ï¸ çµ‚äº†ã¯é–‹å§‹ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„'); return; }
  var dur = timeDiff(start, end);
  if (dur <= 0) { toast('âš ï¸ æ™‚åˆ»ã‚’ç¢ºèªã—ã¦ãã ã•ã„'); return; }

  var slots = loadSlots();
  var overlap = slots.find(function(s){
    return s.date === activePanelDate && !(end <= s.start || start >= s.end);
  });
  if (overlap) { toast('âš ï¸ ä»–ã®æ™‚é–“å¸¯ã¨é‡è¤‡ã—ã¦ã„ã¾ã™'); return; }

  var u = window._SESSION || {};
  // Count this agent's existing ITé‡èª¬ slots this month for matching priority
  var thisMonth = new Date().toISOString().slice(0,7);
  var agentItCount = loadSlots().filter(function(s){
    return s.agentId === (u.userId||'') && s.status === 'booked'
      && (s.date||'').slice(0,7) === thisMonth;
  }).length;
  slots.push({
    id: 'SL' + Date.now(),
    agentId:   u.userId || 'â€”',
    agentName: u.name   || 'é‡èª¬æ‹…å½“',
    agentRank: u.rank   || '',
    agentItCount: agentItCount,
    date:  activePanelDate,
    start: start,
    end:   end,
    dur:   dur,
    status: 'open',
    bookedCase: null, bookedClient: null, meetUrl: '',
    bookingToken: 'BK' + Math.random().toString(36).slice(2,8).toUpperCase()
  });
  saveSlots(slots);
  renderPanelSlots();
  renderCalendar();
  renderRequestBadge(); // æ–°ã‚¹ãƒ­ãƒƒãƒˆã§æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒãƒƒãƒå¯èƒ½ã«ãªã£ãŸå ´åˆã«åæ˜ 
  toast('âœ… ' + start + ' ã€œ ' + end + ' ã‚’è¿½åŠ ');
}

function removeSlot(id) {
  saveSlots(loadSlots().filter(function(s){ return s.id !== id; }));
  renderPanelSlots();
  renderCalendar();
}

function reportItDone(slotId) {
  if (!confirm('é‡èª¬ãƒ»å¥‘ç´„ãŒå®Œäº†ã—ã¾ã—ãŸã‹ï¼Ÿ\nHQã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«å®Œäº†é€šçŸ¥ãŒé€ã‚‰ã‚Œã¾ã™ã€‚')) return;
  var slots = loadSlots();
  var slot  = slots.find(function(s){ return s.id === slotId; });
  if (!slot) return;
  slot.itDone = true;
  slot.itDoneAt = new Date().toISOString();
  saveSlots(slots);
  // æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆbookingçµŒç”±ï¼‰ã¨HQã«Slacké€šçŸ¥
  var bk = loadBookings().find(function(b){ return b.slotId === slotId && b.status === 'active'; });
  var msg = '\u2705 *IT\u91cd\u8aac \u5b9f\u65bd\u5b8c\u4e86 (\u91cd\u8aac\u62c5\u5f53\u5831\u544a)*\n'
    + '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n'
    + '\u6848\u4ef6ID: ' + slot.bookedCase + '\n'
    + '\u30af\u30e9\u30a4\u30a2\u30f3\u30c8: ' + (slot.bookedClient || '\u2014') + '\n'
    + (bk ? '\u62c5\u5f53AG: ' + bk.agentName + '\n' : '')
    + (bk ? '\u7269\u4ef6: ' + (bk.propName || '\u2014') + '\n' : '')
    + '\u91cd\u8aac\u5b9f\u65bd\u65e5: ' + (bk ? bk.date : slot.date) + '\n'
    + '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n'
    + '\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u3067 itsetsuCheck \u3092\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044';
  notifySlack('[Slack #IT\u91cd\u8aac\u65e5\u7a0b\u8abf\u6574] ' + msg);
  renderPanelSlots();
  toast('\u5831\u544a\u3057\u307e\u3057\u305f\u3002\u62c5\u5f53AG\u306bSlack\u901a\u77e5\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002');
}

function cancelBookedSlot(slotId) {
  var slots = loadSlots();
  var slot  = slots.find(function(s){ return s.id === slotId; });
  if (!slot) return;
  if (!canCancelSlot(slot)) {
    var reason = cancelReasonText(slot);
    alert(reason || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã¾ã›ã‚“');
    return;
  }
  var confirmMsg = isHQ
    ? 'ã€æœ¬éƒ¨æ¨©é™ã€‘ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ\nã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ' + (slot.bookedClient||'â€”')
    : 'ã“ã®äºˆç´„ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\nã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ä»–ã®æ‹…å½“è€…ã®ç©ºãæ ã‹ã‚‰å†é¸æŠã§ãã¾ã™ã€‚';
  if (!confirm(confirmMsg)) return;
  // Release slot
  slot.status = 'open';
  slot.bookedCase = null; slot.bookedClient = null;
  slot.meetUrl = ''; slot.bookedAt = null;
  saveSlots(slots);
  // Mark booking cancelled
  releaseBookingForSlot(slotId);
  renderPanelSlots();
  renderCalendar();
  toast('âœ… äºˆç´„ã‚’è§£é™¤ã—ã¾ã—ãŸ');
}

// â”€â”€ Stats â”€â”€
function renderStats() {
  var today = new Date().toISOString().slice(0,10);
  var sl = loadSlots().filter(function(s){ return s.date >= today; });
  var o = sl.filter(function(s){ return s.status === 'open'; }).length;
  var b = sl.filter(function(s){ return s.status === 'booked'; }).length;
  document.getElementById('stats-bar').innerHTML =
    '<div class="stat"><div class="stat-dot" style="background:var(--green)"></div>ç©ºã: <strong>' + o + '</strong></div>'
    + '<div class="stat"><div class="stat-dot" style="background:var(--blue)"></div>äºˆç´„æ¸ˆ: <strong>' + b + '</strong></div>'
    + '<div class="stat" style="color:var(--muted)">åˆè¨ˆ: ' + (o+b) + '</div>';
}

// â”€â”€ Toast â”€â”€
function toast(msg) {
  var el = document.createElement('div');
  el.className = 'toast'; el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(function(){ el.style.opacity = '0'; setTimeout(function(){ el.remove(); }, 300); }, 2200);
}

// â”€â”€ Init â”€â”€
renderCalendar();
renderStats();
renderRequestBadge();
setTimeout(function(){ document.getElementById('cal-wrap').scrollTop = 16 * CELL_H; }, 50);
</script>
</body>
</html>
