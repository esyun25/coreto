<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CORETO â€” ç´¹ä»‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›³ã€çµŒå–¶é™£å°‚ç”¨ã€‘</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Kaisei+Tokumin:wght@400;700&family=DM+Mono:wght@400;500&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #0d0f14;--card:#141820;--card2:#191e28;
  --bg2:     #13161e;
  --bg3:     #1a1e29;
  --border:  #252a38;
  --border2: #2e3447;
  --text:    #e8eaf0;
  --sub:     #8b90a8;
  --muted:   #4a4f68;
  --gold:    #c9a840;
  --gold2:   #e8c85a;
  --gold-bg: rgba(201,168,64,.08);
  --gold-glow: rgba(201,168,64,.2);
  --re:      #4fa3c8;
  --hr:      #52c49a;
  --pt:      #a78bfa;
  --danger:  #f87171;
  --exec:    #f59e0b;
}

html, body { height: 100%; overflow: hidden; }
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--bg);
  color: var(--text);
}


/* â”€ Layout â”€ */
#app { height: 100vh; display: flex; flex-direction: column; }

/* â”€ Header â”€ */
.hdr {
  height: 52px; flex-shrink: 0;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px;
}
.hdr-left { display: flex; align-items: center; gap: 12px; }
.hdr-logo {
  font-family: 'Kaisei Tokumin', serif;
  font-size: 18px; letter-spacing: 3px; color: var(--gold);
}
.hdr-badge {
  font-size: 9px; padding: 3px 8px; border-radius: 4px;
  background: rgba(245,158,11,.15); color: var(--exec);
  border: 1px solid rgba(245,158,11,.3);
  font-family: 'DM Mono', monospace; letter-spacing: 1.5px;
}
.hdr-right { display: flex; align-items: center; gap: 12px; }
.hdr-btn {
  padding: 6px 14px; border-radius: 7px;
  border: 1px solid var(--border2); background: transparent;
  color: var(--sub); font-size: 11px; cursor: pointer;
  transition: all .15s; font-family: 'Noto Sans JP', sans-serif;
}
.hdr-btn:hover { border-color: var(--gold); color: var(--gold); }
.hdr-btn.active { background: var(--gold-bg); border-color: var(--gold); color: var(--gold); }

/* â”€ KPI bar â”€ */
.kpi-bar {
  flex-shrink: 0;
  background: var(--bg2); border-bottom: 1px solid var(--border);
  display: flex; gap: 1px;
  padding: 0;
  overflow-x: auto;
}
.kpi {
  flex: 1; min-width: 140px;
  padding: 12px 20px;
  border-right: 1px solid var(--border);
}
.kpi:last-child { border-right: none; }
.kpi-label {
  font-size: 9px; color: var(--muted);
  letter-spacing: 2px; text-transform: uppercase;
  font-family: 'DM Mono', monospace; margin-bottom: 4px;
}
.kpi-val {
  font-family: 'DM Mono', monospace;
  font-size: 20px; font-weight: 500;
  color: var(--text);
}
.kpi-val.gold { color: var(--gold2); }
.kpi-val.re   { color: var(--re); }
.kpi-val.hr   { color: var(--hr); }
.kpi-val.pt   { color: var(--pt); }
.kpi-sub { font-size: 10px; color: var(--muted); margin-top: 2px; }

/* â”€ Body â”€ */
.body {
  flex: 1; display: flex; overflow: hidden;
}

/* â”€ Sidebar â”€ */
.sidebar {
  width: 280px; flex-shrink: 0;
  background: var(--bg2); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
}
.sb-hdr {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 10px; color: var(--muted);
  letter-spacing: 2px; font-family: 'DM Mono', monospace;
}
.sb-search {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
}
.sb-search input {
  width: 100%; padding: 8px 12px;
  background: var(--bg3); border: 1px solid var(--border2);
  border-radius: 7px; color: var(--text);
  font-size: 12px; font-family: 'Noto Sans JP', sans-serif;
  outline: none;
}
.sb-search input:focus { border-color: var(--gold); }
.sb-search input::placeholder { color: var(--muted); }
.sb-list { flex: 1; overflow-y: auto; padding: 8px 0; }
.sb-item {
  padding: 9px 16px;
  cursor: pointer; transition: background .12s;
  display: flex; align-items: center; gap: 10px;
  border-left: 3px solid transparent;
}
.sb-item:hover { background: var(--bg3); }
.sb-item.active {
  background: var(--gold-bg);
  border-left-color: var(--gold);
}
.sb-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.sb-name { font-size: 12px; flex: 1; }
.sb-id { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }
.sb-net {
  font-family: 'DM Mono', monospace; font-size: 10px;
  color: var(--sub); white-space: nowrap;
}

/* â”€ Tree area â”€ */
.tree-area {
  flex: 1; overflow: auto;
  padding: 32px;
  position: relative;
}

/* â”€ Node â”€ */
.tree-root { display: flex; flex-direction: column; align-items: flex-start; }
.tree-node-wrap {
  display: flex; flex-direction: column; align-items: flex-start;
}
.tree-row { display: flex; align-items: flex-start; gap: 0; }
.tree-connector-v {
  width: 24px; flex-shrink: 0;
  border-left: 1.5px solid var(--border2);
  margin-left: 20px;
}
.tree-children {
  display: flex; flex-direction: column; gap: 12px;
  padding: 12px 0 0 0;
}
.tree-child-row {
  display: flex; align-items: flex-start;
}
.tree-elbow {
  width: 24px; flex-shrink: 0;
  display: flex; flex-direction: column;
  align-items: flex-start;
}
.tree-elbow-line {
  width: 24px; border-top: 1.5px solid var(--border2);
  margin-top: 26px; flex-shrink: 0;
}

/* Node card */
.node {
  position: relative;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 14px 16px;
  min-width: 220px; max-width: 260px;
  cursor: pointer;
  transition: all .2s;
  user-select: none;
}
.node:hover {
  border-color: var(--border);
  transform: translateY(-1px);
  box-shadow: 0 4px 20px rgba(0,0,0,.3);
}
.node.selected { border-color: var(--gold); box-shadow: 0 0 0 2px var(--gold-glow); }
.node.re { border-top: 2px solid var(--re); }
.node.hr { border-top: 2px solid var(--hr); }
.node.pt { border-top: 2px solid var(--pt); }
.node-head {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 10px;
}
.node-name {
  font-size: 13px; font-weight: 700; line-height: 1.3;
  color: var(--text);
}
.node-id {
  font-family: 'DM Mono', monospace;
  font-size: 9px; color: var(--muted);
  margin-top: 2px;
}
.node-pill {
  font-size: 9px; padding: 2px 7px; border-radius: 4px;
  font-family: 'DM Mono', monospace; letter-spacing: .5px;
  white-space: nowrap; flex-shrink: 0;
}
.pill-re { background: rgba(79,163,200,.15); color: var(--re); border: 1px solid rgba(79,163,200,.3); }
.pill-hr { background: rgba(82,196,154,.15); color: var(--hr); border: 1px solid rgba(82,196,154,.3); }
.pill-pt { background: rgba(167,139,250,.15); color: var(--pt); border: 1px solid rgba(167,139,250,.3); }
.node-stats {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 6px;
}
.ns-item {
  background: var(--bg3); border-radius: 6px;
  padding: 6px 8px;
}
.ns-label { font-size: 9px; color: var(--muted); margin-bottom: 2px; font-family: 'DM Mono', monospace; }
.ns-val { font-size: 12px; font-weight: 700; font-family: 'DM Mono', monospace; }
.ns-val.gold { color: var(--gold2); }
.ns-val.green { color: var(--hr); }
.node-toggle {
  position: absolute; right: -10px; top: 50%;
  transform: translateY(-50%);
  width: 20px; height: 20px; border-radius: 50%;
  background: var(--bg3); border: 1px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; color: var(--sub); cursor: pointer;
  z-index: 1; transition: all .15s;
}
.node-toggle:hover { background: var(--gold-bg); border-color: var(--gold); color: var(--gold); }

/* â”€ Detail panel â”€ */
.detail {
  width: 320px; flex-shrink: 0;
  background: var(--bg2); border-left: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
}
.detail-hdr {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.detail-title {
  font-size: 10px; color: var(--muted);
  letter-spacing: 2px; font-family: 'DM Mono', monospace;
}
.detail-close {
  font-size: 14px; color: var(--muted); cursor: pointer;
  background: none; border: none; color: var(--sub);
}
.detail-close:hover { color: var(--text); }
.detail-body { flex: 1; overflow-y: auto; padding: 18px; }
.detail-name {
  font-family: 'Kaisei Tokumin', serif;
  font-size: 22px; font-weight: 700;
  margin-bottom: 4px;
}
.detail-meta { font-size: 11px; color: var(--sub); margin-bottom: 16px; }
.detail-sec {
  font-size: 9px; color: var(--muted);
  letter-spacing: 2px; font-family: 'DM Mono', monospace;
  margin: 16px 0 8px;
}
.detail-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 7px 0; border-bottom: 1px solid var(--border);
  font-size: 12px;
}
.detail-row:last-child { border-bottom: none; }
.detail-row-label { color: var(--sub); }
.detail-row-val { font-family: 'DM Mono', monospace; color: var(--text); }
.detail-row-val.gold { color: var(--gold2); }
.detail-row-val.green { color: var(--hr); }

/* Network member list in detail */
.net-member {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 10px;
  background: var(--bg3); border-radius: 7px;
  margin-bottom: 6px;
}
.net-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.nm-name { font-size: 12px; flex: 1; }
.nm-depth { font-family: 'DM Mono', monospace; font-size: 9px; color: var(--muted); }
.nm-rev { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--sub); }
.depth-badge {
  font-size: 9px; padding: 1px 6px; border-radius: 3px;
  font-family: 'DM Mono', monospace;
  background: var(--border); color: var(--muted);
}

/* â”€ Empty state â”€ */
.empty-state {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; height: 100%;
  gap: 12px; color: var(--muted);
}
.empty-icon { font-size: 40px; opacity: .4; }
.empty-text { font-size: 12px; text-align: center; line-height: 2; }

/* â”€ Rank badges â”€ */
.rank-badge {
  display: inline-block; font-size: 9px; padding: 1px 6px;
  border-radius: 3px; font-family: 'DM Mono', monospace;
}
.rb-platinum { background: rgba(201,168,64,.2); color: var(--gold2); border: 1px solid rgba(201,168,64,.3); }
.rb-gold     { background: rgba(234,179,8,.15); color: #facc15; border: 1px solid rgba(234,179,8,.25); }
.rb-silver   { background: rgba(148,163,184,.15); color: #94a3b8; border: 1px solid rgba(148,163,184,.25); }
.rb-bronze   { background: rgba(180,83,9,.15); color: #fb923c; border: 1px solid rgba(180,83,9,.25); }

/* scrollbar */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* â”€â”€ ç´¹ä»‹ãƒªãƒ³ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
#ref-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:9000;align-items:center;justify-content:center}
#ref-modal-overlay.open{display:flex}
#ref-modal{background:var(--card);border:1px solid var(--border2);border-radius:16px;padding:0;width:min(460px,92vw);overflow:hidden}
.ref-mhdr{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ref-mhdr-t{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--gold)}
.ref-mbody{padding:20px}
.ref-url{background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:10px 12px;font-family:'DM Mono',monospace;font-size:11px;color:var(--sub);word-break:break-all;margin:10px 0;min-height:36px}
.ref-copy-btn{width:100%;padding:10px;border-radius:8px;border:none;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;background:var(--gold);color:#0a0c10;margin-top:4px}
.ref-copy-btn:hover{opacity:.9}

/* â”€â”€ ç´¹ä»‹ãƒªãƒ³ã‚¯ å·¦ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ â”€â”€ */
#ref-float-btn {
  position: fixed;
  left: 0;
  top: 50%;
  transform: translateY(-50%) translateX(-100%) rotate(-90deg);
  transform-origin: right bottom;
  z-index: 8000;
  background: rgba(201,168,76,.18);
  border: 1px solid rgba(201,168,76,.4);
  border-bottom: none;
  border-radius: 8px 8px 0 0;
  color: var(--gold);
  padding: 6px 16px;
  font-size: 11px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  white-space: nowrap;
  letter-spacing: .5px;
  transition: background .15s;
}
#ref-float-btn:hover { background: rgba(201,168,76,.32); }
</style>
</head>
<body>

<!-- â”€ Main App â”€ -->
<div id="app">

  <!-- Header -->
  <div class="hdr">
    <div class="hdr-left">
      <div class="hdr-logo">CORETO</div>
      <div class="hdr-badge">ğŸ‘ EXEC ONLY</div>
    </div>
    <div class="hdr-right">
      <span style="font-size:11px;color:var(--muted)">ç´¹ä»‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ</span>
      <button class="hdr-btn" onclick="window.location.href='coreto-hub.html'">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    
    </div>
  </div>

  <!-- KPI bar -->
  <div class="kpi-bar" id="kpi-bar"></div>

  <!-- Body -->
  <div class="body">

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sb-hdr">NETWORK ROOTS â€” èµ·ç‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸€è¦§</div>
      <div class="sb-search">
        <input type="text" placeholder="åå‰ãƒ»IDã§æ¤œç´¢..." id="sb-search" oninput="filterSidebar(this.value)">
      </div>
      <div class="sb-list" id="sb-list"></div>
    </div>

    <!-- Tree -->
    <div class="tree-area" id="tree-area">
      <div class="empty-state" id="empty-state">
        <div class="empty-icon">ğŸŒ</div>
        <div class="empty-text">å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨<br>ç´¹ä»‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>
      <div id="tree-root" style="display:none"></div>
    </div>

    <!-- Detail panel -->
    <div class="detail" id="detail-panel">
      <div class="detail-hdr">
        <div class="detail-title">AGENT DETAIL</div>
        <button class="detail-close" onclick="closeDetail()">âœ•</button>
      </div>
      <div class="detail-body" id="detail-body">
        <div class="empty-state">
          <div class="empty-icon">ğŸ‘†</div>
          <div class="empty-text">ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// â•â• AUTH GUARD (çµŒå–¶é™£å°‚ç”¨) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  var s = null;
  try { s = JSON.parse(sessionStorage.getItem('coreto_session') || 'null'); } catch(e) {}
  var HQ_LEVEL = { exec: 3, manager: 2, staff: 1 };
  if (!s || s.type !== 'hq' || (HQ_LEVEL[s.hqRole] || 0) < 3) { location.replace('coreto-hub.html'); }
  window._SESSION = s;
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEMO DATA
//  referredBy: ç´¹ä»‹è€…ã®IDï¼ˆnullã¯å¤–éƒ¨å¿œå‹Ÿï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AGENTS = [
  // â”€ å±±ç”° èª ãƒ©ã‚¤ãƒ³ (10012) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'10012', name:'å±±ç”° èª ',   kana:'ãƒ¤ãƒãƒ€ ãƒã‚³ãƒˆ',  type:'re', rank:'Gold',     joined:'2024-03',
    referredBy:null,
    monthlyRev:[980000,1100000,1200000,1050000,1300000,1150000],
    totalRev:9800000, cases:52, sennin:true,
    note:'å‰µæ¥­æœŸã‹ã‚‰ã®ä¸­æ ¸ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚å®…å»ºå£«å°‚ä»»ã€‚ãƒ¡ãƒ³ã‚¿ãƒ¼å®Ÿç¸¾3åã€‚' },

  { id:'10023', name:'éˆ´æœ¨ å¥å¤ª', kana:'ã‚¹ã‚ºã‚­ ã‚±ãƒ³ã‚¿',  type:'re', rank:'Silver',   joined:'2024-07',
    referredBy:'10012',
    monthlyRev:[520000,620000,720000,580000,700000,650000],
    totalRev:3800000, cases:24, sennin:false,
    note:'å±±ç”°èª ãŒç´¹ä»‹ã€‚æ¸‹è°·ãƒ»æ–°å®¿ã‚¨ãƒªã‚¢æ‹…å½“ã€‚' },

  { id:'10041', name:'æ¸¡è¾º éš†',   kana:'ãƒ¯ã‚¿ãƒŠãƒ™ ã‚¿ã‚«ã‚·', type:'re', rank:'Bronze',  joined:'2025-01',
    referredBy:'10012',
    monthlyRev:[180000,210000,240000,160000,200000,190000],
    totalRev:1200000, cases:8, sennin:true,
    note:'å±±ç”°èª ãŒç´¹ä»‹ã€‚å®…å»ºå£«å°‚ä»»ç™»éŒ²ã€‚æˆé•·æ ªã€‚' },

  { id:'10055', name:'æ— å¥ˆç·’',   kana:'ãƒãƒ¤ã‚· ãƒŠã‚ª',    type:'re', rank:'Bronze',  joined:'2025-04',
    referredBy:'10023',
    monthlyRev:[90000,120000,150000,100000,130000,110000],
    totalRev:700000, cases:4, sennin:false,
    note:'éˆ´æœ¨å¥å¤ªãŒç´¹ä»‹ã€‚éƒ½å†…è³ƒè²¸å°‚é–€ã€‚' },

  { id:'30012', name:'ä¼Šè—¤ èª ä¸€', kana:'ã‚¤ãƒˆã‚¦ ã‚»ã‚¤ã‚¤ãƒ', type:'pt', rank:null,     joined:'2025-03',
    referredBy:'10023',
    monthlyRev:[0,0,0,0,0,0],
    totalRev:480000, cases:6, sennin:false,
    note:'éˆ´æœ¨å¥å¤ªãŒç´¹ä»‹ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€‚ä¸å‹•ç”£ã‚ªãƒ¼ãƒŠãƒ¼ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¿æœ‰ã€‚' },

  { id:'10062', name:'ä¸­æ‘ äº®',   kana:'ãƒŠã‚«ãƒ ãƒ© ãƒªãƒ§ã‚¦', type:'re', rank:'Bronze',  joined:'2025-06',
    referredBy:'10041',
    monthlyRev:[60000,80000,100000,70000,90000,85000],
    totalRev:485000, cases:3, sennin:false,
    note:'æ¸¡è¾ºéš†ãŒç´¹ä»‹ã€‚æ¸¯åŒºãƒ»å…­æœ¬æœ¨ã‚¨ãƒªã‚¢å¿—æœ›ã€‚' },

  // â”€ ä½è—¤ èŠ±å­ãƒ©ã‚¤ãƒ³ (10008) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'10008', name:'ä½è—¤ èŠ±å­', kana:'ã‚µãƒˆã‚¦ ãƒãƒŠã‚³',  type:'re', rank:'Platinum', joined:'2024-01',
    referredBy:null,
    monthlyRev:[1400000,1600000,1800000,1500000,1900000,1700000],
    totalRev:18500000, cases:98, sennin:true,
    note:'æœ€é«˜ãƒ©ãƒ³ã‚¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚å°‚ä»»å®…å»ºå£«ã€‚ãƒ¡ãƒ³ã‚¿ãƒ¼å®Ÿç¸¾5åã€‚å£²ä¸ŠNo.1ã€‚' },

  { id:'10031', name:'å°æ— ä¿Šä»‹', kana:'ã‚³ãƒãƒ¤ã‚· ã‚·ãƒ¥ãƒ³ã‚¹ã‚±', type:'re', rank:'Gold', joined:'2024-05',
    referredBy:'10008',
    monthlyRev:[800000,900000,1000000,850000,1100000,950000],
    totalRev:7200000, cases:41, sennin:false,
    note:'ä½è—¤èŠ±å­ãŒç´¹ä»‹ã€‚å£²è²·å°‚é–€ã€‚é«˜é¡æ¡ˆä»¶å¤šæ•°ã€‚' },

  { id:'20010', name:'æ¾æœ¬ ç”±ç¾', kana:'ãƒãƒ„ãƒ¢ãƒˆ ãƒ¦ãƒŸ',  type:'hr', rank:'Silver',  joined:'2024-08',
    referredBy:'10008',
    monthlyRev:[420000,500000,560000,480000,620000,540000],
    totalRev:3600000, cases:18, sennin:false,
    note:'ä½è—¤èŠ±å­ãŒç´¹ä»‹ã€‚äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚ITæ¥­ç•Œå°‚é–€ã€‚' },

  { id:'10048', name:'å‰ç”° å¤§è¼”', kana:'ãƒ¨ã‚·ãƒ€ ãƒ€ã‚¤ã‚¹ã‚±', type:'re', rank:'Silver', joined:'2024-09',
    referredBy:'10031',
    monthlyRev:[350000,420000,490000,380000,460000,410000],
    totalRev:2600000, cases:16, sennin:false,
    note:'å°æ—ä¿Šä»‹ãŒç´¹ä»‹ã€‚ç¥å¥ˆå·ã‚¨ãƒªã‚¢æ‹…å½“ã€‚' },

  { id:'30007', name:'ä½è—¤ ç¾å’²', kana:'ã‚µãƒˆã‚¦ ãƒŸã‚µã‚­',  type:'pt', rank:null,     joined:'2024-10',
    referredBy:'10031',
    monthlyRev:[0,0,0,0,0,0],
    totalRev:920000, cases:11, sennin:false,
    note:'å°æ—ä¿Šä»‹ãŒç´¹ä»‹ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€‚ä¸å‹•ç”£æ¥­è€…ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã€‚' },

  { id:'20015', name:'é«˜æ©‹ èª ',   kana:'ã‚¿ã‚«ãƒã‚· ãƒã‚³ãƒˆ', type:'hr', rank:'Bronze', joined:'2025-02',
    referredBy:'20010',
    monthlyRev:[200000,240000,280000,220000,260000,240000],
    totalRev:1440000, cases:8, sennin:false,
    note:'æ¾æœ¬ç”±ç¾ãŒç´¹ä»‹ã€‚è£½é€ æ¥­ãƒ»åŒ»ç™‚æ¥­ç•Œæ‹…å½“ã€‚' },

  { id:'30015', name:'ç”°ä¸­ å¥',   kana:'ã‚¿ãƒŠã‚« ã‚±ãƒ³',    type:'pt', rank:null,     joined:'2025-03',
    referredBy:'20010',
    monthlyRev:[0,0,0,0,0,0],
    totalRev:360000, cases:4, sennin:false,
    note:'æ¾æœ¬ç”±ç¾ãŒç´¹ä»‹ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€‚ä¸­å°ä¼æ¥­çµŒå–¶è€…ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€‚' },

  // â”€ ç”°ä¸­ ç¾ç©‚ãƒ©ã‚¤ãƒ³ (20005) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'20005', name:'ç”°ä¸­ ç¾ç©‚', kana:'ã‚¿ãƒŠã‚« ãƒŸãƒ›',    type:'hr', rank:'Gold',    joined:'2024-02',
    referredBy:null,
    monthlyRev:[700000,780000,860000,740000,900000,820000],
    totalRev:8400000, cases:44, sennin:false,
    note:'äººæã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒˆãƒƒãƒ—ã€‚ITãƒ»å¤–è³‡ç³»å°‚é–€ã€‚ãƒ¡ãƒ³ã‚¿ãƒ¼å®Ÿç¸¾2åã€‚' },

  { id:'20022', name:'æœ¨æ‘ ã•ãã‚‰', kana:'ã‚­ãƒ ãƒ© ã‚µã‚¯ãƒ©', type:'hr', rank:'Silver', joined:'2024-09',
    referredBy:'20005',
    monthlyRev:[310000,370000,430000,340000,400000,360000],
    totalRev:2210000, cases:12, sennin:false,
    note:'ç”°ä¸­ç¾ç©‚ãŒç´¹ä»‹ã€‚ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ»ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—å°‚é–€ã€‚' },

  { id:'30022', name:'æ©‹æœ¬ å…‰å¤«', kana:'ãƒã‚·ãƒ¢ãƒˆ ãƒŸãƒ„ã‚ª', type:'pt', rank:null,     joined:'2025-01',
    referredBy:'20005',
    monthlyRev:[0,0,0,0,0,0],
    totalRev:280000, cases:3, sennin:false,
    note:'ç”°ä¸­ç¾ç©‚ãŒç´¹ä»‹ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€‚äººæä¼šç¤¾OBãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€‚' },

  { id:'20031', name:'ç¦ç”° é›„ä»‹', kana:'ãƒ•ã‚¯ãƒ€ ãƒ¦ã‚¦ã‚¹ã‚±', type:'hr', rank:'Bronze', joined:'2025-05',
    referredBy:'20022',
    monthlyRev:[140000,170000,200000,160000,190000,180000],
    totalRev:1040000, cases:6, sennin:false,
    note:'æœ¨æ‘ã•ãã‚‰ãŒç´¹ä»‹ã€‚é‡‘èæ¥­ç•Œå°‚é–€ã€‚' },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Build tree structure
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const byId = {};
AGENTS.forEach(a => { byId[a.id] = a; });

// Pre-compute: for each agent, find all descendants
function getDescendants(id) {
  const children = AGENTS.filter(a => a.referredBy === id);
  let all = [...children];
  children.forEach(c => { all = all.concat(getDescendants(c.id)); });
  return all;
}

// Pre-compute network stats for every agent
const stats = {};
AGENTS.forEach(a => {
  const desc = getDescendants(a.id);
  const netRevTotal = desc.reduce((s,d) => s + d.totalRev, 0);
  stats[a.id] = {
    directCount: AGENTS.filter(x => x.referredBy === a.id).length,
    totalNetwork: desc.length,
    networkRevTotal: netRevTotal,
    descendants: desc,
  };
});

// Root agents
const roots = AGENTS.filter(a => a.referredBy === null);

const TYPE_COLOR = { re:'var(--re)', hr:'var(--hr)', pt:'var(--pt)' };
const TYPE_LABEL = { re:'ä¸å‹•ç”£AG', hr:'äººæAG', pt:'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼' };
const RANK_CLASS = { Platinum:'rb-platinum', Gold:'rb-gold', Silver:'rb-silver', Bronze:'rb-bronze' };
const YEN = v => v >= 1000000 ? (v/1000000).toFixed(1)+'M' : (v/1000).toFixed(0)+'K';
const YEN_FULL = v => 'Â¥' + v.toLocaleString();

function yen(v) { return 'Â¥' + v.toLocaleString(); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initApp() {
  buildKPIs();
  buildSidebar(roots);
}

function buildKPIs() {
  const totalAgents = AGENTS.filter(a => a.type !== 'pt').length;
  const totalPT     = AGENTS.filter(a => a.type === 'pt').length;
  const totalRev    = AGENTS.reduce((s,a) => s + a.totalRev, 0);
  const avgNetwork  = roots.length > 0
    ? Math.round(AGENTS.length / roots.length * 10)/10 : 0;

  document.getElementById('kpi-bar').innerHTML = [
    ['TOTAL MEMBERS', AGENTS.length + ' å', 'text', 'å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ»ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼'],
    ['ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ', totalAgents + ' å', 're', 'RE + HR'],
    ['ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', totalPT + ' å', 'pt', 'ç´¹ä»‹å°‚é–€'],
    ['ç´¯è¨ˆå£²ä¸Š', 'Â¥' + Math.round(totalRev).toLocaleString(), 'gold', 'å…¨ãƒ¡ãƒ³ãƒãƒ¼åˆè¨ˆ'],
    ['èµ·ç‚¹ / å¹³å‡å‚˜ä¸‹', roots.length + ' å / ' + avgNetwork + 'å', 'text', 'å¤–éƒ¨å¿œå‹Ÿãƒ«ãƒ¼ãƒˆæ•°'],
  ].map(([l,v,cls,sub]) =>
    `<div class="kpi">
      <div class="kpi-label">${l}</div>
      <div class="kpi-val ${cls}">${v}</div>
      <div class="kpi-sub">${sub}</div>
    </div>`
  ).join('');
}

function buildSidebar(list) {
  document.getElementById('sb-list').innerHTML = list.map(a => {
    const st = stats[a.id];
    return `<div class="sb-item" id="sb-${a.id}" onclick="selectRoot('${a.id}')">
      <div class="sb-dot" style="background:${TYPE_COLOR[a.type]}"></div>
      <div class="sb-name">${a.name}</div>
      <div class="sb-id">#${a.id}</div>
      <div class="sb-net">å‚˜ä¸‹${st.totalNetwork}</div>
    </div>`;
  }).join('');
}

function filterSidebar(q) {
  const filtered = roots.filter(a =>
    a.name.includes(q) || a.id.includes(q) || a.kana.includes(q)
  );
  buildSidebar(filtered);
  // Re-bind active
  if (selectedRoot) {
    const el = document.getElementById('sb-'+selectedRoot);
    if (el) el.classList.add('active');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Tree rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedRoot = null;
let selectedNode = null;
const collapsed = new Set();

function selectRoot(id) {
  selectedRoot = id;
  selectedNode = null;
  document.querySelectorAll('.sb-item').forEach(el => el.classList.remove('active'));
  const sb = document.getElementById('sb-'+id);
  if (sb) sb.classList.add('active');
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('tree-root').style.display = 'block';
  renderTree(id);
  closeDetail();
}

function renderTree(rootId) {
  const container = document.getElementById('tree-root');
  container.innerHTML = renderNode(rootId, 0);
}

function renderNode(id, depth) {
  const a = byId[id];
  if (!a) return '';
  const children = AGENTS.filter(c => c.referredBy === id);
  const st = stats[id];
  const isCollapsed = collapsed.has(id);
  const typePill = `<span class="node-pill pill-${a.type}">${TYPE_LABEL[a.type]}</span>`;
  const rankHtml = a.rank ? `<span class="rank-badge ${RANK_CLASS[a.rank] || ''}">${a.rank}</span>` : '';

  const nodeHtml = `
    <div class="node ${a.type} ${selectedNode===id?'selected':''}" id="node-${id}" onclick="selectNode('${id}')">
      <div class="node-head">
        <div>
          <div class="node-name">${a.name} ${rankHtml}</div>
          <div class="node-id">#${id} Â· å‚åŠ  ${a.joined}</div>
        </div>
        ${typePill}
      </div>
      <div class="node-stats">
        <div class="ns-item">
          <div class="ns-label">è‡ªèº«ã®å£²ä¸Š</div>
          <div class="ns-val gold">Â¥${YEN(a.totalRev)}</div>
        </div>
        <div class="ns-item">
          <div class="ns-label">å‚˜ä¸‹äººæ•°</div>
          <div class="ns-val">${st.totalNetwork} å</div>
        </div>
        <div class="ns-item">
          <div class="ns-label">å‚˜ä¸‹å£²ä¸Šåˆè¨ˆ</div>
          <div class="ns-val green">Â¥${YEN(st.networkRevTotal)}</div>
        </div>
        <div class="ns-item">
          <div class="ns-label">ç›´æ¥ç´¹ä»‹</div>
          <div class="ns-val">${st.directCount} å</div>
        </div>
      </div>
      ${children.length > 0 ? `<div class="node-toggle" onclick="event.stopPropagation();toggleNode('${id}')">${isCollapsed?'+':'-'}</div>` : ''}
    </div>`;

  if (children.length === 0 || isCollapsed) {
    return `<div class="tree-node-wrap">${nodeHtml}</div>`;
  }

  const childrenHtml = children.map((c, i) => {
    const isLast = i === children.length - 1;
    return `<div class="tree-child-row">
      <div style="display:flex;flex-direction:column;align-items:flex-start">
        <div style="width:32px;border-left:1.5px solid var(--border2);border-bottom:1.5px solid var(--border2);height:26px;border-radius:0 0 0 5px;margin-left:12px;flex-shrink:0"></div>
      </div>
      ${renderNode(c.id, depth+1)}
    </div>`;
  }).join('');

  return `<div class="tree-node-wrap">
    ${nodeHtml}
    <div style="padding-left:28px;margin-top:8px;display:flex;flex-direction:column;gap:10px">
      ${childrenHtml}
    </div>
  </div>`;
}

function toggleNode(id) {
  if (collapsed.has(id)) collapsed.delete(id);
  else collapsed.add(id);
  renderTree(selectedRoot);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Detail panel
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectNode(id) {
  selectedNode = id;
  // Re-render to update selected state
  renderTree(selectedRoot);
  showDetail(id);
}

function showDetail(id) {
  const a = byId[id];
  if (!a) return;
  const st = stats[id];
  const referrer = a.referredBy ? byId[a.referredBy] : null;
  const typePill = `<span class="node-pill pill-${a.type}" style="font-size:10px">${TYPE_LABEL[a.type]}</span>`;
  const rankHtml = a.rank ? `<span class="rank-badge ${RANK_CLASS[a.rank] || ''}">${a.rank}</span>` : '<span style="color:var(--muted);font-size:11px">â€”</span>';

  // Monthly rev sparkline (text)
  const months = ['9æœˆ','10æœˆ','11æœˆ','12æœˆ','1æœˆ','2æœˆ'];
  const recentRevHtml = a.monthlyRev.map((r,i) =>
    `<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:11px;border-bottom:1px solid var(--border)">
      <span style="color:var(--muted)">${months[i]}</span>
      <span style="font-family:'DM Mono',monospace;color:${r>0?'var(--text)':'var(--muted)'}">${r>0?yen(r):'â€”'}</span>
    </div>`
  ).join('');

  // Descendants list (depth-labeled)
  function listDesc(parentId, depth) {
    return AGENTS.filter(x => x.referredBy === parentId).map(x => {
      const color = TYPE_COLOR[x.type];
      return `<div class="net-member">
        <div class="net-dot" style="background:${color}"></div>
        <div class="nm-name">${x.name}</div>
        <div class="nm-rev">${x.totalRev>0?'Â¥'+YEN(x.totalRev):'â€”'}</div>
        <div class="depth-badge">L${depth}</div>
      </div>` + listDesc(x.id, depth+1);
    }).join('');
  }

  document.getElementById('detail-body').innerHTML = `
    <div>
      <div style="margin-bottom:4px">${typePill} ${rankHtml}</div>
      <div class="detail-name">${a.name}</div>
      <div class="detail-meta">#${a.id} Â· å‚åŠ  ${a.joined}${a.sennin?' Â· å°‚ä»»å®…å»ºå£«':''}</div>
      ${a.note ? `<div style="font-size:11px;color:var(--sub);background:var(--bg3);padding:8px 10px;border-radius:7px;line-height:1.8;margin-bottom:4px">${a.note}</div>` : ''}
    </div>

    <div class="detail-sec">REFERRAL INFO</div>
    <div class="detail-row">
      <span class="detail-row-label">ç´¹ä»‹è€…</span>
      <span class="detail-row-val">${referrer ? referrer.name + ' (#'+referrer.id+')' : 'å¤–éƒ¨å¿œå‹Ÿ'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-row-label">ç›´æ¥ç´¹ä»‹</span>
      <span class="detail-row-val">${st.directCount} å</span>
    </div>
    <div class="detail-row">
      <span class="detail-row-label">å‚˜ä¸‹ç·æ•°</span>
      <span class="detail-row-val">${st.totalNetwork} å</span>
    </div>

    <div class="detail-sec">REVENUE</div>
    <div class="detail-row">
      <span class="detail-row-label">è‡ªèº«ã®ç´¯è¨ˆå£²ä¸Š</span>
      <span class="detail-row-val gold">${yen(a.totalRev)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-row-label">å‚˜ä¸‹å£²ä¸Šåˆè¨ˆ</span>
      <span class="detail-row-val green">${yen(st.networkRevTotal)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-row-label">è‡ªèº« + å‚˜ä¸‹åˆè¨ˆ</span>
      <span class="detail-row-val gold">${yen(a.totalRev + st.networkRevTotal)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-row-label">æˆç´„ä»¶æ•°</span>
      <span class="detail-row-val">${a.cases} ä»¶</span>
    </div>

    <div class="detail-sec">æœˆåˆ¥å£²ä¸Šï¼ˆç›´è¿‘6ãƒ¶æœˆï¼‰</div>
    <div style="background:var(--bg3);border-radius:8px;padding:10px 12px;margin-bottom:4px">
      ${recentRevHtml}
    </div>

    ${st.totalNetwork > 0 ? `
      <div class="detail-sec">ç´¹ä»‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆ${st.totalNetwork}åï¼‰</div>
      <div>${listDesc(id, 1)}</div>
    ` : ''}
  `;
}

function closeDetail() {
  selectedNode = null;
  document.getElementById('detail-body').innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">ğŸ‘†</div>
      <div class="empty-text">ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>`;
  if (selectedRoot) renderTree(selectedRoot);
}
initApp();

// â”€â”€ ç´¹ä»‹ãƒªãƒ³ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _refCurrentCode = '';
function openRefModal() {
  var overlay = document.getElementById('ref-modal-overlay');
  var selector = document.getElementById('ref-code-selector');
  var isExec = (typeof session !== 'undefined' && session && session.hqRole === 'exec')
            || (typeof CURRENT_USER !== 'undefined' && CURRENT_USER && CURRENT_USER.hqRole === 'exec');
  var agentId = (typeof session !== 'undefined' && session && session.userId) ? session.userId
              : (typeof ME !== 'undefined' && ME && ME.id) ? ME.id
              : (typeof AGENT !== 'undefined' && AGENT && AGENT.id) ? AGENT.id : '10012';
  if (isExec) {
    var SPECIAL = ['FOUNDER2026','WELCOME2026','GOLD_START','HR_PRO75'];
    var opts = SPECIAL.map(function(c){ return '<option value="'+c+'">â­ '+c+'</option>'; }).join('');
    selector.innerHTML =
      '<div style="margin-bottom:12px"><div style="font-size:10px;color:var(--sub);font-weight:600;margin-bottom:5px">ã‚³ãƒ¼ãƒ‰ç¨®åˆ¥</div>'
      +'<select id="ref-code-select" onchange="updateRefLink()" style="width:100%;padding:8px 10px;background:var(--card2);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-size:12px;font-family:inherit">'
      +'<option value="'+agentId+'">è‡ªåˆ†ã®IDï¼ˆ'+agentId+'ï¼‰</option>'
      +'<optgroup label="â”€â”€ ç‰¹åˆ¥ã‚³ãƒ¼ãƒ‰ â”€â”€">'+opts+'</optgroup>'
      +'</select></div>';
    _refCurrentCode = agentId;
  } else {
    selector.innerHTML =
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px 12px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:8px">'
      +'<span style="font-size:11px;color:var(--muted)">ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼š</span>'
      +'<span style="font-family:\'DM Mono\',monospace;font-size:13px;font-weight:700;color:var(--gold)">'+agentId+'</span>'
      +'</div>';
    _refCurrentCode = agentId;
  }
  updateRefLink();
  overlay.classList.add('open');
}
function updateRefLink() {
  var sel = document.getElementById('ref-code-select');
  if (sel) _refCurrentCode = sel.value;
  var base = location.origin + location.pathname.replace(/[^/]*$/, '') + 'coreto-agent-signup.html';
  var url = base + '?ref=' + encodeURIComponent(_refCurrentCode);
  document.getElementById('ref-url-display').textContent = url;
}
function closeRefModal() {
  document.getElementById('ref-modal-overlay').classList.remove('open');
}
function copyRefLink() {
  var url = document.getElementById('ref-url-display').textContent;
  navigator.clipboard.writeText(url).then(function() {
    var btn = document.querySelector('.ref-copy-btn');
    btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
    setTimeout(function(){ btn.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼'; }, 2000);
  }).catch(function() {
    var ta = document.createElement('textarea');
    ta.value = url; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  });
}
</script>

<div id="ref-modal-overlay" onclick="if(event.target===this)closeRefModal()">
  <div id="ref-modal">
    <div class="ref-mhdr">
      <div class="ref-mhdr-t">ğŸ”— ç´¹ä»‹ãƒªãƒ³ã‚¯ç™ºè¡Œ</div>
      <button onclick="closeRefModal()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1">Ã—</button>
    </div>
    <div class="ref-mbody">
      <div style="font-size:11px;color:var(--sub);margin-bottom:14px;line-height:1.8">ã“ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å…¥ä¼šã™ã‚‹ã¨ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</div>
      <div id="ref-code-selector"></div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:4px;font-weight:600;letter-spacing:.5px">ç™ºè¡Œãƒªãƒ³ã‚¯</div>
      <div class="ref-url" id="ref-url-display">â€”</div>
      <button class="ref-copy-btn" onclick="copyRefLink()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>
</div>

<button id="ref-float-btn" onclick="openRefModal()">ğŸ”— ç´¹ä»‹ãƒªãƒ³ã‚¯ç™ºè¡Œ</button>
</body>
</html>
