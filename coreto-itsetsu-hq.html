<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ITé‡èª¬ ç®¡ç†ãƒ‘ãƒãƒ« | CORETO HQ</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://hooks.slack.com https://hooks.zapier.com; frame-src 'none'; object-src 'none';">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--bg2:#0c0e18;--card:#0f1119;--card2:#131621;
  --border:#1e2235;--border2:#252a3d;
  --gold:#c9a84c;--gold2:#e8c96a;
  --blue:#4f9cf9;--blue2:#6ab0ff;
  --green:#34d399;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;
  --muted:#4a5270;--sub:#7a849e;--text:#e2e6f3;
  --urgent:#ff6b6b;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif}
body{display:grid;grid-template-rows:52px 1fr;overflow:hidden}

/* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hdr{background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 20px;gap:16px;z-index:100}
.hdr-logo{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;
  color:var(--gold);letter-spacing:4px;margin-right:4px}
.hdr-sep{color:var(--border2);font-size:18px}
.hdr-title{font-size:12px;font-weight:700;color:var(--blue);letter-spacing:.5px}
.hdr-badge{font-size:10px;padding:2px 8px;border-radius:10px;
  background:rgba(79,156,249,.12);border:1px solid rgba(79,156,249,.25);color:var(--blue)}
.hdr-r{margin-left:auto;display:flex;align-items:center;gap:12px}
.hdr-user{font-size:11px;color:var(--sub)}
.hdr-back{font-size:11px;color:var(--muted);text-decoration:none;
  padding:4px 10px;border:1px solid var(--border2);border-radius:7px;transition:.15s}
.hdr-back:hover{color:var(--text);border-color:var(--sub)}

/* â”€â”€ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout{display:grid;grid-template-columns:200px 1fr;height:100%;overflow:hidden}

/* â”€â”€ ã‚µã‚¤ãƒ‰ãƒŠãƒ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidenav{background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;padding:12px 0}
.nav-section{font-size:9px;font-weight:700;color:var(--muted);letter-spacing:1.5px;
  padding:10px 16px 4px;text-transform:uppercase}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 16px;
  font-size:12px;color:var(--sub);cursor:pointer;transition:.15s;
  border-left:2px solid transparent;user-select:none}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,.03)}
.nav-item.active{color:var(--blue);background:rgba(79,156,249,.06);border-left-color:var(--blue)}
.nav-item .nav-icon{font-size:14px;width:18px;text-align:center;flex-shrink:0}
.nav-badge{margin-left:auto;font-size:9px;font-weight:700;
  background:var(--red);color:#fff;border-radius:8px;padding:1px 5px;min-width:16px;text-align:center}
.nav-badge.warn{background:var(--orange)}
.nav-badge.blue{background:var(--blue)}

/* â”€â”€ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px}

/* â”€â”€ çµ±è¨ˆã‚«ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:14px 16px;cursor:pointer;transition:all .15s}
.stat-card:hover{border-color:var(--border2);transform:translateY(-1px)}
.stat-card.alert{border-color:rgba(248,113,113,.3);background:rgba(248,113,113,.04)}
.stat-card.ok{border-color:rgba(52,211,153,.2)}
.stat-label{font-size:9px;font-weight:700;color:var(--muted);letter-spacing:1px;
  text-transform:uppercase;margin-bottom:6px}
.stat-val{font-family:'DM Mono',monospace;font-size:24px;font-weight:500;color:var(--text)}
.stat-val.red{color:var(--red)}
.stat-val.green{color:var(--green)}
.stat-val.gold{color:var(--gold)}
.stat-val.blue{color:var(--blue)}
.stat-sub{font-size:10px;color:var(--muted);margin-top:3px}

/* â”€â”€ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-hdr{display:flex;align-items:center;gap:12px;margin-bottom:2px}
.page-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--text)}
.page-sub{font-size:11px;color:var(--muted)}

/* â”€â”€ ã‚«ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.card-hdr{display:flex;align-items:center;gap:10px;padding:14px 18px;
  border-bottom:1px solid var(--border)}
.card-hdr-title{font-size:13px;font-weight:700;color:var(--text)}
.card-hdr-sub{font-size:10px;color:var(--muted);margin-left:auto}
.card-body{padding:16px 18px}

/* â”€â”€ ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbl{width:100%;border-collapse:collapse;font-size:11px}
.tbl th{font-size:9px;font-weight:700;color:var(--muted);letter-spacing:1px;
  padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);
  text-transform:uppercase;white-space:nowrap}
.tbl td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:rgba(255,255,255,.015)}
.mono{font-family:'DM Mono',monospace;font-size:11px}

/* â”€â”€ ãƒãƒƒã‚¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;
  padding:2px 8px;border-radius:8px;white-space:nowrap}
.b-wait  {background:rgba(251,146,60,.12);color:var(--orange);border:1px solid rgba(251,146,60,.25)}
.b-booked{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.25)}
.b-done  {background:rgba(52,211,153,.1);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.b-cancel{background:rgba(248,113,113,.1);color:var(--red);border:1px solid rgba(248,113,113,.2)}
.b-urgent{background:rgba(255,107,107,.15);color:var(--urgent);border:1px solid rgba(255,107,107,.3)}
.b-hq    {background:rgba(201,168,76,.12);color:var(--gold);border:1px solid rgba(201,168,76,.25)}

/* â”€â”€ ãƒœã‚¿ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;
  border-radius:8px;border:none;cursor:pointer;font-size:11px;font-weight:700;
  font-family:'Noto Sans JP',sans-serif;transition:all .15s;white-space:nowrap}
.btn-primary{background:var(--blue);color:#fff}
.btn-primary:hover{background:var(--blue2)}
.btn-gold{background:var(--gold);color:#0a0c10}
.btn-gold:hover{background:var(--gold2)}
.btn-ghost{background:transparent;color:var(--sub);border:1px solid var(--border2)}
.btn-ghost:hover{color:var(--text);border-color:var(--sub)}
.btn-danger{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.25)}
.btn-danger:hover{background:rgba(248,113,113,.2)}
.btn-sm{padding:4px 10px;font-size:10px}
.btn-xs{padding:3px 8px;font-size:10px;border-radius:6px}

/* â”€â”€ ãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input,select,textarea{background:var(--bg);border:1px solid var(--border2);border-radius:8px;
  color:var(--text);font-family:'Noto Sans JP',sans-serif;font-size:12px;
  padding:8px 12px;outline:none;transition:border-color .15s;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--blue)}
.fg{margin-bottom:12px}
.fg label{display:block;font-size:10px;font-weight:700;color:var(--sub);
  margin-bottom:5px;letter-spacing:.3px}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

/* â”€â”€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cal-hdr{display:grid;grid-template-columns:140px repeat(7,1fr);
  font-size:9px;font-weight:700;color:var(--muted);letter-spacing:.5px;
  border-bottom:1px solid var(--border);padding:0 0 8px}
.cal-hdr div{text-align:center;padding:4px 0}
.cal-hdr div:first-child{text-align:left;padding-left:4px}
.cal-row{display:grid;grid-template-columns:140px repeat(7,1fr);
  border-bottom:1px solid var(--border);min-height:52px;align-items:start}
.cal-row:last-child{border-bottom:none}
.cal-agent{font-size:11px;font-weight:600;color:var(--text);
  padding:10px 8px;align-self:center}
.cal-agent-sub{font-size:9px;color:var(--muted);margin-top:1px}
.cal-cell{padding:4px;border-left:1px solid var(--border);min-height:52px;
  cursor:pointer;transition:.1s}
.cal-cell:hover{background:rgba(79,156,249,.04)}
.cal-slot{font-size:9px;padding:3px 5px;border-radius:4px;margin-bottom:2px;
  line-height:1.3;cursor:pointer}
.slot-open  {background:rgba(52,211,153,.1);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.slot-booked{background:rgba(79,156,249,.12);color:var(--blue);border:1px solid rgba(79,156,249,.25)}
.slot-done  {background:rgba(90,90,120,.15);color:var(--muted)}
.cal-add{font-size:10px;color:var(--muted);text-align:center;padding:6px 0;
  border-radius:6px;border:1px dashed var(--border2);cursor:pointer;transition:.15s}
.cal-add:hover{color:var(--blue);border-color:rgba(79,156,249,.4)}

/* â”€â”€ ä»‹å…¥ãƒ­ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.log-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);font-size:11px}
.log-item:last-child{border-bottom:none}
.log-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:13px;flex-shrink:0;margin-top:1px}
.log-time{font-size:9px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px}
.log-body{color:var(--sub);line-height:1.6}
.log-body strong{color:var(--text)}

/* â”€â”€ ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);
  backdrop-filter:blur(6px);z-index:900;display:none;
  align-items:center;justify-content:center;padding:20px}
.modal-bg.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border2);
  border-radius:16px;width:540px;max-width:100%;max-height:90vh;
  overflow-y:auto;box-shadow:0 24px 60px rgba(0,0,0,.6)}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;
  padding:18px 22px;border-bottom:1px solid var(--border)}
.modal-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;color:var(--text)}
.modal-close{background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;line-height:1}
.modal-close:hover{color:var(--text)}
.modal-body{padding:20px 22px}
.modal-footer{padding:14px 22px;border-top:1px solid var(--border);
  display:flex;gap:8px;justify-content:flex-end}

/* â”€â”€ ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒŠãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert{border-radius:10px;padding:10px 14px;font-size:11px;line-height:1.8;margin-bottom:14px}
.alert-warn{background:rgba(251,146,60,.07);border:1px solid rgba(251,146,60,.2);color:var(--orange)}
.alert-info{background:rgba(79,156,249,.07);border:1px solid rgba(79,156,249,.2);color:var(--blue)}
.alert-danger{background:rgba(248,113,113,.07);border:1px solid rgba(248,113,113,.2);color:var(--red)}

/* â”€â”€ ãƒãƒƒãƒãƒ³ã‚°UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.match-card{background:var(--card2);border:1px solid var(--border);border-radius:12px;
  padding:14px 16px;margin-bottom:10px}
.match-req{font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px}
.match-meta{font-size:10px;color:var(--sub);margin-bottom:10px;line-height:1.7}
.match-slots{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.match-slot-opt{display:flex;align-items:center;gap:10px;padding:8px 12px;
  background:var(--bg);border:1px solid var(--border2);border-radius:8px;cursor:pointer;
  transition:.15s;font-size:11px}
.match-slot-opt:hover{border-color:var(--blue);background:rgba(79,156,249,.04)}
.match-slot-opt.selected{border-color:var(--green);background:rgba(52,211,153,.05)}
.slot-time{font-family:'DM Mono',monospace;font-weight:700;color:var(--text)}
.slot-agent{color:var(--sub);margin-left:auto;font-size:10px}
.slot-score{font-size:9px;padding:2px 6px;border-radius:5px;
  background:rgba(52,211,153,.1);color:var(--green);font-weight:700}

/* â”€â”€ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timeline{display:flex;flex-direction:column;gap:0}
.tl-item{display:flex;gap:12px;position:relative;padding-bottom:16px}
.tl-item::before{content:'';position:absolute;left:13px;top:28px;
  bottom:0;width:1px;background:var(--border)}
.tl-item:last-child::before{display:none}
.tl-item:last-child{padding-bottom:0}
.tl-dot{width:28px;height:28px;border-radius:50%;background:var(--card2);
  border:2px solid var(--border2);display:flex;align-items:center;
  justify-content:center;font-size:12px;flex-shrink:0;z-index:1}
.tl-dot.active{border-color:var(--blue);background:rgba(79,156,249,.1)}
.tl-dot.done{border-color:var(--green);background:rgba(52,211,153,.08)}
.tl-dot.warn{border-color:var(--orange);background:rgba(251,146,60,.08)}
.tl-content{flex:1;padding-top:4px}
.tl-title{font-size:11px;font-weight:700;color:var(--text)}
.tl-time{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:1px}

/* â”€â”€ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}

/* â”€â”€ ãƒˆãƒ¼ã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{position:fixed;bottom:24px;right:24px;background:var(--card2);
  border:1px solid var(--border2);border-radius:10px;padding:10px 16px;
  font-size:12px;color:var(--text);opacity:0;transition:opacity .3s;
  z-index:999;pointer-events:none;max-width:360px}
.toast.show{opacity:1}

/* â”€â”€ ç©ºçŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:40px 20px;color:var(--muted);font-size:12px}
.empty-icon{font-size:32px;margin-bottom:8px}

/* â”€â”€ é€±åˆ‡æ›¿ãƒŠãƒ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.week-nav{display:flex;align-items:center;gap:12px}
.week-label{font-size:13px;font-weight:700;color:var(--text);min-width:180px;text-align:center}
.week-btn{width:28px;height:28px;border-radius:7px;border:1px solid var(--border2);
  background:transparent;color:var(--sub);cursor:pointer;display:flex;
  align-items:center;justify-content:center;font-size:13px;transition:.15s}
.week-btn:hover{color:var(--text);border-color:var(--sub)}

/* â”€â”€ ã‚¹ãƒ­ãƒƒãƒˆè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.slot-form{background:rgba(79,156,249,.04);border:1px solid rgba(79,156,249,.15);
  border-radius:10px;padding:14px;margin-top:10px}
.slot-form-title{font-size:11px;font-weight:700;color:var(--blue);margin-bottom:10px}

/* â”€â”€ ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.accordion-item{border-bottom:1px solid var(--border)}
.accordion-item:last-child{border-bottom:none}
.accordion-hdr{display:flex;align-items:center;gap:10px;padding:12px 0;
  cursor:pointer;user-select:none}
.accordion-hdr:hover .accordion-title{color:var(--text)}
.accordion-title{font-size:12px;font-weight:700;color:var(--sub);flex:1}
.accordion-arrow{font-size:12px;color:var(--muted);transition:transform .2s}
.accordion-body{display:none;padding-bottom:14px}
.accordion-item.open .accordion-arrow{transform:rotate(180deg)}
.accordion-item.open .accordion-body{display:block}
.accordion-item.open .accordion-title{color:var(--text)}
</style>
</head>
<body>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="hdr">
  <span class="hdr-logo">CORETO</span>
  <span class="hdr-sep">|</span>
  <span class="hdr-title">ITé‡èª¬ ç®¡ç†ãƒ‘ãƒãƒ«</span>
  <span class="hdr-badge" id="hdr-role-badge">HQ</span>
  <div class="hdr-r">
    <span class="hdr-user" id="hdr-user">â€”â€”</span>
    <a href="coreto-hub.html" class="hdr-back">â† ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</a>
  </div>
</div>

<div class="layout">
  <!-- ã‚µã‚¤ãƒ‰ãƒŠãƒ“ -->
  <nav class="sidenav">
    <div class="nav-section">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <div class="nav-item active" data-view="dashboard" onclick="switchView('dashboard',this)">
      <span class="nav-icon">ğŸ“Š</span>æ¦‚è¦
    </div>

    <div class="nav-section">ãƒãƒƒãƒãƒ³ã‚°ç®¡ç†</div>
    <div class="nav-item" data-view="matching" onclick="switchView('matching',this)">
      <span class="nav-icon">ğŸ¯</span>æœªãƒãƒƒãƒãƒ³ã‚°
      <span class="nav-badge" id="nav-badge-match">0</span>
    </div>
    <div class="nav-item" data-view="reassign" onclick="switchView('reassign',this)">
      <span class="nav-icon">ğŸ”„</span>æ‹…å½“è€…å¤‰æ›´
    </div>

    <div class="nav-section">äºˆç´„ç®¡ç†</div>
    <div class="nav-item" data-view="bookings" onclick="switchView('bookings',this)">
      <span class="nav-icon">ğŸ“…</span>äºˆç´„ä¸€è¦§
      <span class="nav-badge warn" id="nav-badge-today">0</span>
    </div>
    <div class="nav-item" data-view="calendar" onclick="switchView('calendar',this)">
      <span class="nav-icon">ğŸ—“</span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    </div>
    <div class="nav-item" data-view="slots" onclick="switchView('slots',this)">
      <span class="nav-icon">â•</span>ã‚¹ãƒ­ãƒƒãƒˆç®¡ç†
    </div>

    <div class="nav-section">æ¡ˆä»¶ãƒ»å±¥æ­´</div>
    <div class="nav-item" data-view="requests" onclick="switchView('requests',this)">
      <span class="nav-icon">ğŸ“‹</span>ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´
    </div>
    <div class="nav-item" data-view="log" onclick="switchView('log',this)">
      <span class="nav-icon">ğŸ“</span>ä»‹å…¥ãƒ­ã‚°
    </div>
  </nav>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main" id="main-content">
    <!-- å‹•çš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° -->
  </main>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="modal-bg">
  <div class="modal" id="modal">
    <div class="modal-hdr">
      <span class="modal-title" id="modal-title"></span>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer" id="modal-footer"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="db.js"></script>
<script>
// â•â• AUTH GUARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  var s = null;
  try { s = JSON.parse(sessionStorage.getItem('coreto_session')||'null'); } catch(e){}
  if (!s||!s.userId||!s.sessionToken||s.sessionToken.length!==64){
    sessionStorage.removeItem('coreto_session');
    location.replace('coreto-login-hq.html'); return;
  }
  var la = new Date(s.loginAt).getTime();
  if (isNaN(la)||(Date.now()-la)>28800000){
    sessionStorage.removeItem('coreto_session');
    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚');
    location.replace('coreto-login-hq.html'); return;
  }
  if (s.type!=='hq'){ location.replace('coreto-login.html'); return; }
  window._SESSION = s;
})();

const SESSION = window._SESSION || {};
document.getElementById('hdr-user').textContent = SESSION.name || SESSION.userId || 'â€”â€”';
document.getElementById('hdr-role-badge').textContent =
  SESSION.hqRole==='exec'?'çµ±æ‹¬':SESSION.hqRole==='manager'?'ç®¡ç†è·':'HQã‚¹ã‚¿ãƒƒãƒ•';

// â•â• è¨­å®š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SLACK_WEBHOOK = (typeof window.SLACK_CONFIG !== 'undefined' && window.SLACK_CONFIG)
  ? window.SLACK_CONFIG.IT_SETSU || window.SLACK_CONFIG.GENERAL
  : 'YOUR_SLACK_WEBHOOK_URL';

const KEYS = {
  bookings : 'coreto_itsetsu_bookings',
  slots    : 'coreto_itsetsu_slots',
  requests : 'coreto_itsetsu_requests',
  hqLog    : 'coreto_itsetsu_hq_log',
};

// â”€â”€ å®…å»ºå£«ãƒã‚¹ã‚¿ï¼ˆæœ¬ç•ª: db.jsã®USERSã¾ãŸã¯Kintoneã‹ã‚‰å–å¾—ï¼‰
const TAKKEN_AGENTS = [
  { id:'10008', name:'ä½è—¤ èŠ±å­', takken:'æ±äº¬(2)098765', color:'var(--purple)' },
  { id:'10012', name:'å±±ç”° èª ',   takken:'æ±äº¬(1)123456', color:'var(--gold)' },
  { id:'10041', name:'æ¸¡è¾º éš†',   takken:'åŸ¼ç‰(1)234567', color:'var(--green)' },
  { id:'00001', name:'HQ çµ±æ‹¬',   takken:'æ±äº¬(1)999001', color:'var(--blue)' },
  { id:'00347', name:'HQãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', takken:'æ±äº¬(2)998501', color:'var(--blue)' },
];

// â•â• ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function load(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch(e){ return []; } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function loadBookings(){ return load(KEYS.bookings); }
function loadSlots()   { return load(KEYS.slots); }
function loadRequests(){ return load(KEYS.requests); }
function loadHqLog()   { return load(KEYS.hqLog); }

function saveHqLog(action, detail){
  var logs = loadHqLog();
  logs.unshift({
    id: 'LOG-'+Date.now(),
    action, detail,
    operator: SESSION.name || SESSION.userId,
    at: new Date().toISOString()
  });
  if (logs.length > 200) logs = logs.slice(0, 200);
  save(KEYS.hqLog, logs);
}

// â•â• ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function today(){ return new Date().toISOString().slice(0,10); }
function fmtDate(d){
  if (!d) return 'â€”';
  var dt = new Date(d+'T00:00:00');
  return dt.toLocaleDateString('ja-JP',{month:'short',day:'numeric',weekday:'short'});
}
function fmtDt(iso){
  if (!iso) return 'â€”';
  return iso.slice(0,16).replace('T',' ');
}
function uid(){ return 'HQ-'+Date.now().toString(36).toUpperCase(); }
function minsUntil(date, time){
  var dt = new Date(date+'T'+time+':00');
  return Math.floor((dt.getTime()-Date.now())/60000);
}
function agentName(id){
  var a = TAKKEN_AGENTS.find(function(x){ return x.id===id; });
  return a ? a.name : id || 'â€”â€”';
}
function escHtml(s){
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function notifySlack(msg, channel){
  if (!SLACK_WEBHOOK || SLACK_WEBHOOK==='YOUR_SLACK_WEBHOOK_URL'){
    console.log('[Slackæœªè¨­å®š]', msg); return;
  }
  fetch(SLACK_WEBHOOK, {
    method:'POST', mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ text: '[ITé‡èª¬HQ] '+msg })
  }).catch(function(e){ console.error('[Slack]', e); });
}

function toast(msg, type){
  var t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show';
  setTimeout(function(){ t.className = 'toast'; }, 3000);
}

// â•â• ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var currentView = 'dashboard';
function switchView(view, el){
  currentView = view;
  document.querySelectorAll('.nav-item').forEach(function(n){ n.classList.remove('active'); });
  if (el) el.classList.add('active');
  renderView(view);
}
function renderView(view){
  var views = {
    dashboard : renderDashboard,
    matching  : renderMatching,
    reassign  : renderReassign,
    bookings  : renderBookings,
    calendar  : renderCalendar,
    slots     : renderSlots,
    requests  : renderRequests,
    log       : renderLog,
  };
  if (views[view]) views[view]();
}

// â•â• çµ±è¨ˆ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcStats(){
  var bks   = loadBookings();
  var reqs  = loadRequests();
  var slots = loadSlots();
  var today_= today();

  var active   = bks.filter(function(b){ return b.status==='active'; });
  var todayBks = active.filter(function(b){ return b.date===today_; });
  var unmatched= reqs.filter(function(r){ return r.status==='open'; });
  var lateBks  = active.filter(function(b){ return (b.changeCount||0)>=2; });
  var openSlots= slots.filter(function(s){ return s.status==='open' && s.date>=today_; });
  var doneBks  = bks.filter(function(b){ return b.status==='active' && b.hqForceCompleted; });

  return { active:active.length, todayBks:todayBks.length,
           unmatched:unmatched.length, lateBks:lateBks.length,
           openSlots:openSlots.length, doneBks:doneBks.length };
}

function updateNavBadges(){
  var s = calcStats();
  document.getElementById('nav-badge-match').textContent = s.unmatched;
  document.getElementById('nav-badge-today').textContent = s.todayBks;
  if (s.unmatched===0) document.getElementById('nav-badge-match').style.display='none';
  if (s.todayBks===0)  document.getElementById('nav-badge-today').style.display='none';
}

// â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  var s = calcStats();
  var bks = loadBookings();
  var reqs = loadRequests();
  var today_ = today();

  var html = '<div class="page-hdr"><span style="font-size:20px">ğŸ“Š</span>'
    + '<div><div class="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>'
    + '<div class="page-sub">ITé‡èª¬ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¢ºèª</div></div></div>';

  // çµ±è¨ˆã‚«ãƒ¼ãƒ‰
  html += '<div class="stats-row">'
    + statCard('æœªãƒãƒƒãƒãƒ³ã‚°', s.unmatched, s.unmatched>0?'red':'green', 'å³å¯¾å¿œè¦', s.unmatched>0?'alert':'ok')
    + statCard('æœ¬æ—¥ã®äºˆç´„', s.todayBks, s.todayBks>0?'blue':'', 'ä»¶', '')
    + statCard('äºˆç´„ç¢ºå®šä¸­', s.active, 'gold', 'ä»¶', '')
    + statCard('å¤‰æ›´2å›ä»¥ä¸Š', s.lateBks, s.lateBks>0?'red':'', 'ä»¶', s.lateBks>0?'alert':'')
    + statCard('ç©ºãã‚¹ãƒ­ãƒƒãƒˆ', s.openSlots, 'green', 'æ ', 'ok')
    + '</div>';

  // æœ¬æ—¥ã®äºˆç´„
  var todayBks = bks.filter(function(b){ return b.status==='active' && b.date===today_; });
  todayBks.sort(function(a,b){ return a.start.localeCompare(b.start); });

  html += '<div class="card"><div class="card-hdr">'
    + '<span style="font-size:14px">ğŸ“…</span><span class="card-hdr-title">æœ¬æ—¥ã®é‡èª¬äºˆç´„</span>'
    + '<span class="card-hdr-sub">'+today_+'</span></div><div class="card-body">';

  if (!todayBks.length){
    html += '<div class="empty"><div class="empty-icon">ğŸ‰</div>æœ¬æ—¥ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    html += '<table class="tbl"><thead><tr>'
      + '<th>æ™‚é–“</th><th>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</th><th>Case ID</th>'
      + '<th>æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</th><th>é‡èª¬æ‹…å½“</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>';
    todayBks.forEach(function(bk){
      var mins = minsUntil(bk.date, bk.start);
      var statusBadge = mins<0
        ? '<span class="badge b-wait">å®Ÿæ–½æ¸ˆï¼ˆç¢ºèªå¾…ï¼‰</span>'
        : mins<60 ? '<span class="badge b-urgent">âš¡ ç›´å‰</span>'
        : '<span class="badge b-booked">æœ¬æ—¥</span>';
      html += '<tr>'
        + '<td class="mono" style="color:var(--gold);font-weight:700">'+escHtml(bk.start)+'ã€œ</td>'
        + '<td style="font-weight:600">'+escHtml(bk.clientName)+'</td>'
        + '<td class="mono" style="color:var(--sub)">'+escHtml(bk.caseId)+'</td>'
        + '<td>'+escHtml(bk.agentName)+'</td>'
        + '<td style="color:var(--blue)">'+escHtml(bk.itAgentName)+'</td>'
        + '<td>'+statusBadge+'</td>'
        + '<td><div style="display:flex;gap:4px">'
        + '<button class="btn btn-ghost btn-xs" onclick="openReassignModal(\''+bk.id+'\')">æ‹…å½“å¤‰æ›´</button>'
        + '<button class="btn btn-ghost btn-xs" onclick="openRescheduleModal(\''+bk.id+'\')">æ—¥ç¨‹å¤‰æ›´</button>'
        + '</div></td></tr>';
    });
    html += '</tbody></table>';
  }
  html += '</div></div>';

  // æœªãƒãƒƒãƒãƒ³ã‚°è­¦å‘Š
  var unmatched = reqs.filter(function(r){ return r.status==='open'; });
  if (unmatched.length){
    html += '<div class="alert alert-danger">âš ï¸ æœªãƒãƒƒãƒãƒ³ã‚°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ <strong>'+unmatched.length+'ä»¶</strong> ã‚ã‚Šã¾ã™ã€‚'
      + '<button class="btn btn-danger btn-sm" style="margin-left:12px" onclick="switchView(\'matching\',document.querySelector(\'[data-view=matching]\'))">ä»Šã™ãå¯¾å¿œ</button></div>';
  }

  // ç›´è¿‘ã®ä»‹å…¥ãƒ­ã‚°
  var logs = loadHqLog().slice(0,5);
  html += '<div class="card"><div class="card-hdr">'
    + '<span style="font-size:14px">ğŸ“</span><span class="card-hdr-title">æœ€è¿‘ã®HQä»‹å…¥</span>'
    + '<button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="switchView(\'log\',document.querySelector(\'[data-view=log]\'))">ã™ã¹ã¦è¦‹ã‚‹</button>'
    + '</div><div class="card-body">';

  if (!logs.length){
    html += '<div class="empty">ä»‹å…¥å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    html += '<div class="timeline">';
    logs.forEach(function(l){
      html += '<div class="tl-item">'
        + '<div class="tl-dot done">ğŸ¢</div>'
        + '<div class="tl-content">'
        + '<div class="tl-title">'+escHtml(l.action)+'</div>'
        + '<div style="font-size:10px;color:var(--sub);margin-top:2px">'+escHtml(l.detail)+'</div>'
        + '<div class="tl-time">'+fmtDt(l.at)+' â€” '+escHtml(l.operator)+'</div>'
        + '</div></div>';
    });
    html += '</div>';
  }
  html += '</div></div>';

  document.getElementById('main-content').innerHTML = html;
}

function statCard(label, val, cls, sub, cardCls){
  return '<div class="stat-card '+cardCls+'">'
    + '<div class="stat-label">'+label+'</div>'
    + '<div class="stat-val '+(cls||'')+'">'+val+'</div>'
    + '<div class="stat-sub">'+sub+'</div></div>';
}

// â•â• MATCHINGï¼ˆæ‰‹å‹•ãƒãƒƒãƒãƒ³ã‚°ï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMatching(){
  var reqs   = loadRequests().filter(function(r){ return r.status==='open'; });
  var slots  = loadSlots().filter(function(s){ return s.status==='open' && s.date>=today(); });
  var today_ = today();

  var html = '<div class="page-hdr"><span style="font-size:20px">ğŸ¯</span>'
    + '<div><div class="page-title">æœªãƒãƒƒãƒãƒ³ã‚°å‡¦ç†</div>'
    + '<div class="page-sub">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«æœ€é©ãªã‚¹ãƒ­ãƒƒãƒˆã‚’é¸æŠã—ã¦ç¢ºå®šã—ã¾ã™</div></div></div>';

  if (!reqs.length){
    html += '<div class="empty" style="padding:80px"><div class="empty-icon">âœ…</div>'
      + '<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:6px">ã™ã¹ã¦ãƒãƒƒãƒãƒ³ã‚°æ¸ˆã¿ã§ã™</div>'
      + '<div>æœªå¯¾å¿œã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div></div>';
    document.getElementById('main-content').innerHTML = html;
    return;
  }

  html += '<div class="alert alert-info">ğŸ“Œ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é¸æŠã—ã€æœ€é©ãªã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œç¢ºå®šã€ã—ã¦ãã ã•ã„ã€‚è‡ªå‹•ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆå¸Œæœ›æ™‚é–“ä¸€è‡´åº¦ï¼‰ã§ã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚½ãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚</div>';

  reqs.forEach(function(r){
    // å¸Œæœ›æ—¥æ™‚ã¨ä¸€è‡´ã™ã‚‹ã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
    var candidateSlots = slots.map(function(s){
      var score = r.wishes.reduce(function(acc, w){
        if (s.date===w.date){
          if (s.start<=w.start && s.end>=w.end) return acc+10;
          if (s.start<=w.start && s.end>w.start) return acc+5;
        }
        return acc;
      }, 0);
      return { slot:s, score:score };
    }).filter(function(x){ return x.slot.date>=today_; })
      .sort(function(a,b){ return b.score-a.score; });

    html += '<div class="match-card" id="req-'+r.id+'">'
      + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">'
      + '<span class="badge b-wait">æœªãƒãƒƒãƒãƒ³ã‚°</span>'
      + '<span style="font-size:13px;font-weight:700;color:var(--text)">'+escHtml(r.clientName)+'æ§˜</span>'
      + '<span class="mono" style="font-size:10px;color:var(--sub)">'+escHtml(r.caseId)+'</span>'
      + '</div>'
      + '<div class="match-meta">'
      + 'æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: <strong>'+escHtml(r.agentName)+'</strong>ã€€'
      + 'å—ä»˜æ—¥æ™‚: '+fmtDt(r.submittedAt)+'<br>'
      + 'å¸Œæœ›æ—¥æ™‚:<br>'
      + r.wishes.map(function(w,i){ return 'ã€€'+(i+1)+'. '+fmtDate(w.date)+' '+w.start+'ã€œ'+w.end; }).join('<br>')
      + '</div>';

    if (!candidateSlots.length){
      html += '<div class="alert alert-warn">âš ï¸ å¯¾å¿œå¯èƒ½ãªã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚<button class="btn btn-ghost btn-sm" onclick="switchView(\'slots\',document.querySelector(\'[data-view=slots]\'))">ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ </button></div>';
    } else {
      html += '<div style="font-size:10px;font-weight:700;color:var(--sub);margin-bottom:6px;letter-spacing:.5px">å¯¾å¿œå¯èƒ½ãªã‚¹ãƒ­ãƒƒãƒˆï¼ˆã‚¹ã‚³ã‚¢é †ï¼‰</div>';
      html += '<div class="match-slots" id="slots-'+r.id+'">';
      candidateSlots.slice(0,5).forEach(function(x){
        var s = x.slot;
        html += '<div class="match-slot-opt" id="opt-'+s.id+'" onclick="selectSlot(\''+r.id+'\',\''+s.id+'\')">'
          + '<span class="slot-time">'+fmtDate(s.date)+' '+s.start+'ã€œ'+s.end+'</span>'
          + '<span class="slot-agent">'+agentName(s.agentId)+'</span>'
          + (x.score>0?'<span class="slot-score">â˜… å¸Œæœ›ä¸€è‡´</span>':'')
          + '</div>';
      });
      html += '</div>';
      html += '<div style="display:flex;gap:8px;margin-top:10px">'
        + '<button class="btn btn-gold" id="match-btn-'+r.id+'" disabled onclick="confirmMatch(\''+r.id+'\')" style="opacity:.4">âœ… ãƒãƒƒãƒãƒ³ã‚°ç¢ºå®š</button>'
        + '<button class="btn btn-ghost" onclick="openManualSlotModal(\''+r.id+'\')">ğŸ—“ æ‰‹å‹•ã§æ—¥ç¨‹ã‚’æŒ‡å®š</button>'
        + '</div>';
    }
    html += '</div>';
  });

  document.getElementById('main-content').innerHTML = html;
}

var selectedSlots = {}; // reqId â†’ slotId
function selectSlot(reqId, slotId){
  if (selectedSlots[reqId]) {
    var prev = document.getElementById('opt-'+selectedSlots[reqId]);
    if (prev) prev.classList.remove('selected');
  }
  selectedSlots[reqId] = slotId;
  var el = document.getElementById('opt-'+slotId);
  if (el) el.classList.add('selected');
  var btn = document.getElementById('match-btn-'+reqId);
  if (btn){ btn.disabled=false; btn.style.opacity='1'; }
}

function confirmMatch(reqId){
  var slotId = selectedSlots[reqId];
  if (!slotId) return;
  var reqs  = loadRequests();
  var slots = loadSlots();
  var bks   = loadBookings();
  var req   = reqs.find(function(r){ return r.id===reqId; });
  var slot  = slots.find(function(s){ return s.id===slotId; });
  if (!req||!slot) return toast('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');

  // ã‚¹ãƒ­ãƒƒãƒˆâ†’äºˆç´„ç¢ºå®š
  slot.status      = 'booked';
  slot.bookedCase  = req.caseId;
  slot.bookedClient= req.clientName;
  req.status       = 'matched';
  req.matchedAt    = new Date().toISOString();
  req.matchedSlot  = slotId;

  var newBk = {
    id: uid(), caseId: req.caseId, clientName: req.clientName,
    propName: req.propName||'', agentId: req.agentId, agentName: req.agentName,
    itAgentId: slot.agentId, itAgentName: agentName(slot.agentId),
    slotId: slotId, date: slot.date, start: slot.start, end: slot.end,
    status: 'active', meetUrl: '', changeCount: 0,
    hqMatched: true, matchedBy: SESSION.name || SESSION.userId,
    matchedAt: new Date().toISOString(),
  };
  bks.push(newBk);

  save(KEYS.requests, reqs);
  save(KEYS.slots, slots);
  save(KEYS.bookings, bks);

  var detail = req.caseId+'ï¼ˆ'+req.clientName+'ï¼‰â†’ '+fmtDate(slot.date)+' '+slot.start+'ã€œ / æ‹…å½“: '+agentName(slot.agentId);
  saveHqLog('HQãƒãƒƒãƒãƒ³ã‚°ç¢ºå®š', detail);
  notifySlack('âœ… HQãƒãƒƒãƒãƒ³ã‚°ç¢ºå®š: '+detail);

  toast('âœ… ãƒãƒƒãƒãƒ³ã‚°ã‚’ç¢ºå®šã—ã¾ã—ãŸ');
  delete selectedSlots[reqId];
  renderMatching();
  updateNavBadges();
}

function openManualSlotModal(reqId){
  var reqs = loadRequests();
  var req  = reqs.find(function(r){ return r.id===reqId; });
  if (!req) return;

  var agentOpts = TAKKEN_AGENTS.map(function(a){
    return '<option value="'+a.id+'">'+a.name+'ï¼ˆ'+a.takken+'ï¼‰</option>';
  }).join('');

  openModal('æ‰‹å‹•ã§æ—¥ç¨‹ãƒ»æ‹…å½“è€…ã‚’æŒ‡å®š',
    '<div class="alert alert-info" style="margin-bottom:16px">æ¡ˆä»¶: <strong>'+escHtml(req.caseId)+'</strong> / '+escHtml(req.clientName)+'æ§˜</div>'
    + '<div class="fg"><label>é‡èª¬æ‹…å½“è€…</label><select id="m-agent">'+agentOpts+'</select></div>'
    + '<div class="fg-row"><div class="fg"><label>æ—¥ä»˜</label><input type="date" id="m-date" min="'+today()+'" value="'+today()+'"></div>'
    + '<div class="fg"><label>é–‹å§‹æ™‚åˆ»</label><input type="time" id="m-start" value="10:00"></div>'
    + '<div class="fg"><label>çµ‚äº†æ™‚åˆ»</label><input type="time" id="m-end" value="11:00"></div></div>'
    + '<div class="fg"><label>Google Meet / Zoom URL</label><input type="text" id="m-url" placeholder="https://meet.google.com/..."></div>'
    + '<div class="fg"><label>HQãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><textarea id="m-memo" rows="2" placeholder="æ—¥ç¨‹èª¿æ•´ã®çµŒç·¯ãªã©"></textarea></div>',
    [
      { label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', cls:'btn-ghost', fn:'closeModal()' },
      { label:'âœ… ç¢ºå®šã™ã‚‹', cls:'btn-gold', fn:'execManualMatch("'+reqId+'")' }
    ]
  );
}

function execManualMatch(reqId){
  var agentId = document.getElementById('m-agent').value;
  var date    = document.getElementById('m-date').value;
  var start   = document.getElementById('m-start').value;
  var end     = document.getElementById('m-end').value;
  var url     = document.getElementById('m-url').value;
  var memo    = document.getElementById('m-memo').value;

  if (!date||!start||!end){ toast('æ—¥ä»˜ãƒ»æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

  var reqs = loadRequests();
  var bks  = loadBookings();
  var req  = reqs.find(function(r){ return r.id===reqId; });
  if (!req) return;

  req.status    = 'matched';
  req.matchedAt = new Date().toISOString();

  var newBk = {
    id: uid(), caseId: req.caseId, clientName: req.clientName,
    propName: req.propName||'', agentId: req.agentId, agentName: req.agentName,
    itAgentId: agentId, itAgentName: agentName(agentId),
    slotId: null, date, start, end, status: 'active',
    meetUrl: url, changeCount: 0,
    hqMatched: true, hqManual: true,
    matchedBy: SESSION.name || SESSION.userId,
    matchedAt: new Date().toISOString(),
    hqMemo: memo,
  };
  bks.push(newBk);

  save(KEYS.requests, reqs);
  save(KEYS.bookings, bks);

  var detail = req.caseId+'ï¼ˆ'+req.clientName+'ï¼‰â†’ HQæ‰‹å‹•æŒ‡å®š: '+fmtDate(date)+' '+start+'ã€œ / æ‹…å½“: '+agentName(agentId);
  saveHqLog('HQæ‰‹å‹•ãƒãƒƒãƒãƒ³ã‚°', detail);
  notifySlack('ğŸ¢ HQæ‰‹å‹•ãƒãƒƒãƒãƒ³ã‚°: '+detail+(memo?' ãƒ¡ãƒ¢: '+memo:''));

  closeModal();
  toast('âœ… æ‰‹å‹•ãƒãƒƒãƒãƒ³ã‚°ã‚’ç¢ºå®šã—ã¾ã—ãŸ');
  renderMatching();
  updateNavBadges();
}

// â•â• REASSIGNï¼ˆæ‹…å½“è€…å¤‰æ›´ï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReassign(){
  var bks = loadBookings().filter(function(b){ return b.status==='active'; });
  bks.sort(function(a,b){ return a.date.localeCompare(b.date)||a.start.localeCompare(b.start); });

  var html = '<div class="page-hdr"><span style="font-size:20px">ğŸ”„</span>'
    + '<div><div class="page-title">æ‹…å½“è€…å¤‰æ›´</div>'
    + '<div class="page-sub">ç¢ºå®šæ¸ˆã¿äºˆç´„ã®é‡èª¬æ‹…å½“è€…ã‚’å¤‰æ›´ã—ã¾ã™</div></div></div>';

  if (!bks.length){
    html += '<div class="empty"><div class="empty-icon">ğŸ“­</div>å¯¾è±¡ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    document.getElementById('main-content').innerHTML = html;
    return;
  }

  html += '<div class="alert alert-warn">âš ï¸ æ‹…å½“è€…å¤‰æ›´å¾Œã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸Slacké€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚å¤‰æ›´å‰ã«åŒæ–¹ã®åŒæ„ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
  html += '<div class="card"><div class="card-body" style="padding:0"><table class="tbl"><thead><tr>'
    + '<th>æ—¥æ™‚</th><th>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</th><th>Case ID</th><th>æ‹…å½“AG</th><th>ç¾åœ¨ã®é‡èª¬æ‹…å½“</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>';

  bks.forEach(function(bk){
    var mins = minsUntil(bk.date, bk.start);
    var isUrgent = mins>=0 && mins<1440;
    html += '<tr>'
      + '<td class="mono" style="'+(isUrgent?'color:var(--orange)':'color:var(--sub)')+'">'+fmtDate(bk.date)+' '+bk.start+'</td>'
      + '<td style="font-weight:600">'+escHtml(bk.clientName)+'</td>'
      + '<td class="mono" style="color:var(--sub)">'+escHtml(bk.caseId)+'</td>'
      + '<td>'+escHtml(bk.agentName)+'</td>'
      + '<td style="color:var(--blue)">'+escHtml(bk.itAgentName)+'</td>'
      + '<td>'+(isUrgent?'<span class="badge b-urgent">ç›´å‰å¤‰æ›´</span>':'<span class="badge b-booked">é€šå¸¸</span>')+'</td>'
      + '<td><button class="btn btn-primary btn-xs" onclick="openReassignModal(\''+bk.id+'\')">æ‹…å½“å¤‰æ›´</button></td></tr>';
  });

  html += '</tbody></table></div></div>';
  document.getElementById('main-content').innerHTML = html;
}

function openReassignModal(bkId){
  var bks = loadBookings();
  var bk  = bks.find(function(b){ return b.id===bkId; });
  if (!bk) return;

  var mins = minsUntil(bk.date, bk.start);
  var warning = mins>=0 && mins<1440
    ? '<div class="alert alert-danger">âš ï¸ ç›´å‰å¤‰æ›´ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰ã§ã™ã€‚å¤‰æ›´æ‰‹æ•°æ–™ Â¥3,000 ãŒç™ºç”Ÿã—ã¾ã™ã€‚</div>'
    : '';

  var agentOpts = TAKKEN_AGENTS.map(function(a){
    var sel = a.id===bk.itAgentId ? ' selected' : '';
    return '<option value="'+a.id+'"'+sel+'>'+a.name+'ï¼ˆ'+a.takken+'ï¼‰</option>';
  }).join('');

  openModal('é‡èª¬æ‹…å½“è€…ã®å¤‰æ›´',
    warning
    + '<div style="background:var(--bg);border:1px solid var(--border2);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:11px">'
    + '<div style="color:var(--sub);margin-bottom:4px">å¤‰æ›´å¯¾è±¡</div>'
    + '<div style="font-weight:700;font-size:13px;color:var(--text)">'+escHtml(bk.clientName)+'æ§˜ â€” '+escHtml(bk.caseId)+'</div>'
    + '<div style="color:var(--sub);margin-top:4px">'+fmtDate(bk.date)+' '+bk.start+'ã€œ / ç¾åœ¨ã®æ‹…å½“: <span style="color:var(--blue)">'+escHtml(bk.itAgentName)+'</span></div>'
    + '</div>'
    + '<div class="fg"><label>æ–°ã—ã„é‡èª¬æ‹…å½“è€…</label><select id="ra-agent">'+agentOpts+'</select></div>'
    + '<div class="fg"><label>å¤‰æ›´ç†ç”±ï¼ˆSlacké€šçŸ¥ã«å«ã¾ã‚Œã¾ã™ï¼‰</label><textarea id="ra-reason" rows="2" placeholder="æ€¥ç—…ã®ãŸã‚ / æ—¥ç¨‹èª¿æ•´ã®ãŸã‚ ãªã©"></textarea></div>',
    [
      { label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', cls:'btn-ghost', fn:'closeModal()' },
      { label:'ğŸ”„ æ‹…å½“è€…ã‚’å¤‰æ›´ã™ã‚‹', cls:'btn-primary', fn:'execReassign("'+bkId+'")' }
    ]
  );
}

function execReassign(bkId){
  var newAgentId = document.getElementById('ra-agent').value;
  var reason     = document.getElementById('ra-reason').value;
  var bks        = loadBookings();
  var bk         = bks.find(function(b){ return b.id===bkId; });
  if (!bk) return;

  var prevName = bk.itAgentName;
  bk.prevItAgentId   = bk.itAgentId;
  bk.prevItAgentName = bk.itAgentName;
  bk.itAgentId   = newAgentId;
  bk.itAgentName = agentName(newAgentId);
  bk.changeCount = (bk.changeCount||0) + 1;
  bk.changeHistory = bk.changeHistory || [];
  bk.changeHistory.push({
    at: new Date().toISOString(), from: prevName, to: bk.itAgentName,
    reason: reason, by: SESSION.name||SESSION.userId
  });
  save(KEYS.bookings, bks);

  var detail = bk.caseId+' æ‹…å½“å¤‰æ›´: '+prevName+' â†’ '+bk.itAgentName+(reason?' ç†ç”±: '+reason:'');
  saveHqLog('æ‹…å½“è€…å¤‰æ›´', detail);
  notifySlack('ğŸ”„ é‡èª¬æ‹…å½“å¤‰æ›´: '+detail);

  closeModal();
  toast('âœ… æ‹…å½“è€…ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
  renderReassign();
}

// â•â• BOOKINGSï¼ˆäºˆç´„ä¸€è¦§ï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBookings(){
  var bks = loadBookings();
  bks.sort(function(a,b){ return a.date.localeCompare(b.date)||a.start.localeCompare(b.start); });

  var html = '<div class="page-hdr"><span style="font-size:20px">ğŸ“…</span>'
    + '<div><div class="page-title">äºˆç´„ä¸€è¦§</div>'
    + '<div class="page-sub">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®é‡èª¬äºˆç´„ã‚’ç®¡ç†</div></div></div>';

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  html += '<div style="display:flex;gap:8px;margin-bottom:16px">'
    + '<button class="btn btn-ghost btn-sm active-filter" id="f-all"    onclick="filterBk(\'all\')"   >ã™ã¹ã¦</button>'
    + '<button class="btn btn-ghost btn-sm" id="f-active" onclick="filterBk(\'active\')" >ç¢ºå®šä¸­</button>'
    + '<button class="btn btn-ghost btn-sm" id="f-today"  onclick="filterBk(\'today\')"  >æœ¬æ—¥</button>'
    + '<button class="btn btn-ghost btn-sm" id="f-late"   onclick="filterBk(\'late\')"   >è¦æ³¨æ„</button>'
    + '<button class="btn btn-ghost btn-sm" id="f-cancel" onclick="filterBk(\'cancel\')" >ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
    + '</div>';

  if (!bks.length){
    html += '<div class="empty"><div class="empty-icon">ğŸ“­</div>äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    document.getElementById('main-content').innerHTML = html;
    return;
  }

  html += '<div class="card" id="bk-list-wrap"><div class="card-body" style="padding:0"><table class="tbl" id="bk-tbl"><thead><tr>'
    + '<th>æ—¥æ™‚</th><th>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</th><th>Case ID</th>'
    + '<th>æ‹…å½“AG</th><th>é‡èª¬æ‹…å½“</th><th>å¤‰æ›´å›æ•°</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr></thead>'
    + '<tbody id="bk-tbody">';

  bks.forEach(function(bk){
    var mins = minsUntil(bk.date, bk.start);
    var isPast = mins<0, isUrgent = mins>=0&&mins<1440;
    var st = bk.status==='active'
      ? isPast ? '<span class="badge b-wait">è¦ç¢ºèª</span>'
        : isUrgent ? '<span class="badge b-urgent">ç›´å‰</span>'
        : '<span class="badge b-booked">äºˆç´„æ¸ˆ</span>'
      : '<span class="badge b-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>';

    html += '<tr class="bk-row" data-status="'+bk.status+'" data-date="'+bk.date+'" data-change="'+(bk.changeCount||0)+'">'
      + '<td class="mono">'+fmtDate(bk.date)+' '+bk.start+'</td>'
      + '<td style="font-weight:600">'+escHtml(bk.clientName)+'</td>'
      + '<td class="mono" style="color:var(--sub)">'+escHtml(bk.caseId)+'</td>'
      + '<td>'+escHtml(bk.agentName)+'</td>'
      + '<td style="color:var(--blue)">'+escHtml(bk.itAgentName)+'</td>'
      + '<td class="mono" style="'+(bk.changeCount>=2?'color:var(--red)':'')+'">'+((bk.changeCount||0)+'å›')+'</td>'
      + '<td>'+st+'</td>'
      + '<td><div style="display:flex;gap:4px">'
      + (bk.status==='active' ? [
          '<button class="btn btn-ghost btn-xs" onclick="openReassignModal(\''+bk.id+'\')">æ‹…å½“å¤‰æ›´</button>',
          '<button class="btn btn-ghost btn-xs" onclick="openRescheduleModal(\''+bk.id+'\')">æ—¥ç¨‹å¤‰æ›´</button>',
          '<button class="btn btn-danger btn-xs" onclick="openCancelModal(\''+bk.id+'\')">å–æ¶ˆ</button>',
          (isPast?'<button class="btn btn-gold btn-xs" onclick="execForceComplete(\''+bk.id+'\')">å®Œäº†ç¢ºèª</button>':'')
        ].join('') : '')
      + '</div></td></tr>';
  });

  html += '</tbody></table></div></div>';
  document.getElementById('main-content').innerHTML = html;
}

function filterBk(type){
  var rows = document.querySelectorAll('.bk-row');
  var today_ = today();
  rows.forEach(function(r){
    var status = r.dataset.status;
    var date   = r.dataset.date;
    var change = parseInt(r.dataset.change)||0;
    var show = true;
    if (type==='active') show = status==='active';
    else if (type==='today') show = date===today_;
    else if (type==='late') show = status==='active' && change>=2;
    else if (type==='cancel') show = status==='cancelled';
    r.style.display = show ? '' : 'none';
  });
}

function openRescheduleModal(bkId){
  var bks = loadBookings();
  var bk  = bks.find(function(b){ return b.id===bkId; });
  if (!bk) return;

  openModal('æ—¥ç¨‹å¤‰æ›´',
    '<div style="background:var(--bg);border:1px solid var(--border2);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:11px">'
    + '<div style="font-weight:700;font-size:13px;color:var(--text)">'+escHtml(bk.clientName)+'æ§˜ â€” '+escHtml(bk.caseId)+'</div>'
    + '<div style="color:var(--sub);margin-top:4px">ç¾åœ¨: '+fmtDate(bk.date)+' '+bk.start+'ã€œ / æ‹…å½“: '+escHtml(bk.itAgentName)+'</div>'
    + '</div>'
    + '<div class="fg-row"><div class="fg"><label>æ–°ã—ã„æ—¥ä»˜</label><input type="date" id="rs-date" min="'+today()+'" value="'+bk.date+'"></div>'
    + '<div class="fg"><label>é–‹å§‹æ™‚åˆ»</label><input type="time" id="rs-start" value="'+bk.start+'"></div>'
    + '<div class="fg"><label>çµ‚äº†æ™‚åˆ»</label><input type="time" id="rs-end" value="'+(bk.end||'')+'"></div></div>'
    + '<div class="fg"><label>Google Meet URLï¼ˆå¤‰æ›´ã™ã‚‹å ´åˆï¼‰</label><input type="text" id="rs-url" value="'+(bk.meetUrl||'')+'" placeholder="https://meet.google.com/..."></div>'
    + '<div class="fg"><label>å¤‰æ›´ç†ç”±</label><textarea id="rs-reason" rows="2" placeholder="ç†ç”±ã‚’å…¥åŠ›"></textarea></div>',
    [
      { label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', cls:'btn-ghost', fn:'closeModal()' },
      { label:'ğŸ“… æ—¥ç¨‹ã‚’å¤‰æ›´ã™ã‚‹', cls:'btn-primary', fn:'execReschedule("'+bkId+'")' }
    ]
  );
}

function execReschedule(bkId){
  var date   = document.getElementById('rs-date').value;
  var start  = document.getElementById('rs-start').value;
  var end    = document.getElementById('rs-end').value;
  var url    = document.getElementById('rs-url').value;
  var reason = document.getElementById('rs-reason').value;
  if (!date||!start){ toast('æ—¥ä»˜ãƒ»æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

  var bks = loadBookings();
  var bk  = bks.find(function(b){ return b.id===bkId; });
  if (!bk) return;

  var prevDate = bk.date, prevStart = bk.start;
  bk.date  = date; bk.start = start; bk.end = end;
  if (url) bk.meetUrl = url;
  bk.changeCount = (bk.changeCount||0)+1;
  bk.changeHistory = bk.changeHistory||[];
  bk.changeHistory.push({
    at: new Date().toISOString(), type:'reschedule',
    from: prevDate+' '+prevStart, to: date+' '+start,
    reason, by: SESSION.name||SESSION.userId
  });
  save(KEYS.bookings, bks);

  var detail = bk.caseId+' æ—¥ç¨‹å¤‰æ›´: '+fmtDate(prevDate)+' '+prevStart+' â†’ '+fmtDate(date)+' '+start+(reason?' ç†ç”±: '+reason:'');
  saveHqLog('æ—¥ç¨‹å¤‰æ›´', detail);
  notifySlack('ğŸ“… æ—¥ç¨‹å¤‰æ›´: '+detail);

  closeModal();
  toast('âœ… æ—¥ç¨‹ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼ˆå¤‰æ›´å›æ•°: '+bk.changeCount+'å›ï¼‰');
  renderBookings();
}

function openCancelModal(bkId){
  var bks = loadBookings();
  var bk  = bks.find(function(b){ return b.id===bkId; });
  if (!bk) return;

  var mins = minsUntil(bk.date, bk.start);
  var penalty = mins>=0&&mins<1440 ? '<div class="alert alert-danger">âš ï¸ ç›´å‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰ã®ãŸã‚ Â¥3,000 ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒç™ºç”Ÿã—ã¾ã™ã€‚</div>' : '';

  openModal('äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    penalty
    + '<div style="background:var(--bg);border:1px solid rgba(248,113,113,.2);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:11px">'
    + '<div style="font-weight:700;font-size:13px;color:var(--text)">'+escHtml(bk.clientName)+'æ§˜ â€” '+escHtml(bk.caseId)+'</div>'
    + '<div style="color:var(--sub);margin-top:4px">'+fmtDate(bk.date)+' '+bk.start+'ã€œ / æ‹…å½“: '+escHtml(bk.itAgentName)+'</div>'
    + '</div>'
    + '<div class="fg"><label>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”± <span style="color:var(--red)">*</span></label><textarea id="ca-reason" rows="2" placeholder="ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆéƒ½åˆ / æ‹…å½“è€…éƒ½åˆ ãªã©"></textarea></div>'
    + '<div class="fg"><label>Slacké€šçŸ¥å…ˆ</label><select id="ca-notify"><option value="both">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ»æ‹…å½“è€…ä¸¡æ–¹</option><option value="agent">æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿</option><option value="none">é€šçŸ¥ã—ãªã„</option></select></div>',
    [
      { label:'æˆ»ã‚‹', cls:'btn-ghost', fn:'closeModal()' },
      { label:'ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹', cls:'btn-danger', fn:'execCancel("'+bkId+'")' }
    ]
  );
}

function execCancel(bkId){
  var reason = document.getElementById('ca-reason').value.trim();
  if (!reason){ toast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

  var bks = loadBookings();
  var bk  = bks.find(function(b){ return b.id===bkId; });
  if (!bk) return;

  bk.status      = 'cancelled';
  bk.cancelledAt = new Date().toISOString();
  bk.cancelReason= reason;
  bk.cancelledBy = SESSION.name||SESSION.userId;

  // ã‚¹ãƒ­ãƒƒãƒˆã‚’ç©ºãã«æˆ»ã™
  if (bk.slotId){
    var slots = loadSlots();
    var slot  = slots.find(function(s){ return s.id===bk.slotId; });
    if (slot){ slot.status='open'; slot.bookedCase=null; slot.bookedClient=null; save(KEYS.slots, slots); }
  }
  save(KEYS.bookings, bks);

  var detail = bk.caseId+'ï¼ˆ'+bk.clientName+'ï¼‰ã‚­ãƒ£ãƒ³ã‚»ãƒ« ç†ç”±: '+reason;
  saveHqLog('äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«', detail);
  notifySlack('ğŸš« äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«: '+detail);

  closeModal();
  toast('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
  renderBookings();
}

function execForceComplete(bkId){
  if (!confirm('ã“ã®äºˆç´„ã‚’ã€Œå®Œäº†æ¸ˆã¿ã€ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆé‡èª¬æ‹…å½“ã‹ã‚‰ã®å ±å‘ŠãŒãªã„å ´åˆã®HQæ‰‹å‹•å‡¦ç†ï¼‰')) return;
  var bks = loadBookings();
  var bk  = bks.find(function(b){ return b.id===bkId; });
  if (!bk) return;
  bk.hqForceCompleted = true;
  bk.hqCompletedAt    = new Date().toISOString();
  bk.hqCompletedBy    = SESSION.name||SESSION.userId;
  save(KEYS.bookings, bks);

  saveHqLog('å¼·åˆ¶å®Œäº†ç¢ºèª', bk.caseId+'ï¼ˆ'+bk.clientName+'ï¼‰');
  notifySlack('âœ… HQæ‰‹å‹•å®Œäº†ç¢ºèª: '+bk.caseId+' '+bk.clientName);
  toast('âœ… å®Œäº†ç¢ºèªã—ã¾ã—ãŸ');
  renderBookings();
}

// â•â• CALENDARï¼ˆé€±æ¬¡ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var calOffset = 0; // é€±ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
function renderCalendar(){
  var bks   = loadBookings().filter(function(b){ return b.status==='active'; });
  var slots  = loadSlots();

  // ä»Šé€±ã®é–‹å§‹æ—¥ï¼ˆæœˆæ›œæ—¥ï¼‰
  var base = new Date();
  base.setDate(base.getDate() - base.getDay() + 1 + (calOffset*7));
  var weekDays = [];
  for (var i=0;i<7;i++){
    var d = new Date(base); d.setDate(base.getDate()+i);
    weekDays.push(d.toISOString().slice(0,10));
  }
  var weekStart = weekDays[0], weekEnd = weekDays[6];

  var weekLabel = fmtDate(weekStart)+' ã€œ '+fmtDate(weekEnd);

  var html = '<div class="page-hdr"><span style="font-size:20px">ğŸ—“</span>'
    + '<div><div class="page-title">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼</div>'
    + '<div class="page-sub">å®…å»ºå£«åˆ¥ã®é€±æ¬¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div></div>'
    + '<div style="margin-left:auto" class="week-nav">'
    + '<button class="week-btn" onclick="calOffset--;renderCalendar()">â€¹</button>'
    + '<span class="week-label">'+weekLabel+'</span>'
    + '<button class="week-btn" onclick="calOffset++;renderCalendar()">â€º</button>'
    + '<button class="btn btn-ghost btn-sm" onclick="calOffset=0;renderCalendar()" style="margin-left:8px">ä»Šé€±</button>'
    + '</div></div>';

  html += '<div class="card"><div class="card-body">';

  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ›œæ—¥ï¼‰
  var dayNames = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
  html += '<div class="cal-hdr"><div>å®…å»ºå£«</div>';
  weekDays.forEach(function(d,i){
    var isToday = d===today();
    html += '<div style="'+(isToday?'color:var(--blue);font-weight:700':'')+'">'
      + d.slice(8)+' <span style="font-weight:400;font-size:8px">('+dayNames[i]+')</span></div>';
  });
  html += '</div>';

  // å„å®…å»ºå£«è¡Œ
  TAKKEN_AGENTS.forEach(function(ag){
    html += '<div class="cal-row"><div class="cal-agent">'
      + '<div>'+escHtml(ag.name)+'</div>'
      + '<div class="cal-agent-sub">'+escHtml(ag.takken)+'</div>'
      + '</div>';

    weekDays.forEach(function(d){
      html += '<div class="cal-cell" onclick="openAddSlotModal(\''+ag.id+'\',\''+d+'\')">';

      // ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ»ã“ã®æ—¥ã®ã‚¹ãƒ­ãƒƒãƒˆ
      var daySlots = slots.filter(function(s){ return s.agentId===ag.id && s.date===d; });
      var dayBks   = bks.filter(function(b){ return b.itAgentId===ag.id && b.date===d; });

      dayBks.forEach(function(bk){
        html += '<div class="cal-slot slot-booked" title="'+escHtml(bk.clientName)+' '+bk.start+'" onclick="event.stopPropagation();openReassignModal(\''+bk.id+'\')">'
          + bk.start+' '+escHtml(bk.clientName.slice(0,3))+'..</div>';
      });

      daySlots.filter(function(s){ return s.status==='open'; }).forEach(function(s){
        html += '<div class="cal-slot slot-open" title="ç©ºã '+s.start+'ã€œ'+s.end+'" onclick="event.stopPropagation()">'
          + s.start+' ç©ºã</div>';
      });

      if (!dayBks.length && !daySlots.length){
        html += '<div class="cal-add">+ è¿½åŠ </div>';
      }

      html += '</div>';
    });
    html += '</div>';
  });

  html += '</div></div>';

  // å‡¡ä¾‹
  html += '<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:10px;color:var(--sub)">'
    + '<span><span class="cal-slot slot-booked" style="display:inline-block;padding:2px 6px">â–ª</span> äºˆç´„ç¢ºå®š</span>'
    + '<span><span class="cal-slot slot-open" style="display:inline-block;padding:2px 6px">â–ª</span> ç©ºãã‚¹ãƒ­ãƒƒãƒˆ</span>'
    + '<span style="margin-left:4px">ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚¹ãƒ­ãƒƒãƒˆè¿½åŠ ã€€é’ã„ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ æ‹…å½“è€…å¤‰æ›´</span>'
    + '</div>';

  document.getElementById('main-content').innerHTML = html;
}

// â•â• SLOTSï¼ˆã‚¹ãƒ­ãƒƒãƒˆç®¡ç†ï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSlots(){
  var slots = loadSlots();
  var today_= today();
  var future= slots.filter(function(s){ return s.date>=today_; });
  future.sort(function(a,b){ return a.date.localeCompare(b.date)||a.start.localeCompare(b.start); });

  var html = '<div class="page-hdr"><span style="font-size:20px">â•</span>'
    + '<div><div class="page-title">ã‚¹ãƒ­ãƒƒãƒˆç®¡ç†</div>'
    + '<div class="page-sub">å®…å»ºå£«ã®ç©ºãæ ã‚’è¿½åŠ ãƒ»å‰Šé™¤ã—ã¾ã™</div></div>'
    + '<button class="btn btn-gold" style="margin-left:auto" onclick="openAddSlotModal()">ï¼‹ ã‚¹ãƒ­ãƒƒãƒˆè¿½åŠ </button></div>';

  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  html += '<div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap">'
    + '<button class="btn btn-ghost btn-sm" onclick="filterSlots(\'all\')">å…¨å“¡</button>';
  TAKKEN_AGENTS.forEach(function(a){
    html += '<button class="btn btn-ghost btn-sm" onclick="filterSlots(\''+a.id+'\')">'+a.name+'</button>';
  });
  html += '</div>';

  if (!future.length){
    html += '<div class="empty"><div class="empty-icon">ğŸ“­</div>ã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“<br>'
      + '<button class="btn btn-primary" style="margin-top:12px" onclick="openAddSlotModal()">ï¼‹ æœ€åˆã®ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ </button></div>';
    document.getElementById('main-content').innerHTML = html;
    return;
  }

  html += '<div class="card"><div class="card-body" style="padding:0"><table class="tbl"><thead><tr>'
    + '<th>æ—¥ä»˜</th><th>æ™‚é–“</th><th>æ‹…å½“å®…å»ºå£«</th><th>çŠ¶æ…‹</th><th>äºˆç´„æ¡ˆä»¶</th><th>æ“ä½œ</th></tr></thead>'
    + '<tbody id="slots-tbody">';

  future.forEach(function(s){
    var badge = s.status==='open'
      ? '<span class="badge b-done">ç©ºã</span>'
      : s.status==='booked'
      ? '<span class="badge b-booked">äºˆç´„æ¸ˆ</span>'
      : '<span class="badge b-cancel">å®Œäº†</span>';

    html += '<tr class="slot-row" data-agent="'+s.agentId+'">'
      + '<td class="mono">'+fmtDate(s.date)+'</td>'
      + '<td class="mono" style="color:var(--text)">'+s.start+'ã€œ'+s.end+'</td>'
      + '<td style="color:var(--blue)">'+agentName(s.agentId)+'</td>'
      + '<td>'+badge+'</td>'
      + '<td style="font-size:10px;color:var(--sub)">'+(s.bookedCase||'â€”')+'</td>'
      + '<td><div style="display:flex;gap:4px">'
      + (s.status==='open'?'<button class="btn btn-danger btn-xs" onclick="deleteSlot(\''+s.id+'\')">å‰Šé™¤</button>':'')
      + '</div></td></tr>';
  });

  html += '</tbody></table></div></div>';
  document.getElementById('main-content').innerHTML = html;
}

function filterSlots(agentId){
  document.querySelectorAll('.slot-row').forEach(function(r){
    r.style.display = agentId==='all'||r.dataset.agent===agentId ? '' : 'none';
  });
}

function openAddSlotModal(preAgentId, preDate){
  var agentOpts = TAKKEN_AGENTS.map(function(a){
    var sel = preAgentId&&a.id===preAgentId ? ' selected' : '';
    return '<option value="'+a.id+'"'+sel+'>'+a.name+'ï¼ˆ'+a.takken+'ï¼‰</option>';
  }).join('');

  openModal('ã‚¹ãƒ­ãƒƒãƒˆè¿½åŠ ',
    '<div class="alert alert-info" style="margin-bottom:14px">ç©ºãæ ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ã“ã®æ ã‚’é¸æŠã§ãã¾ã™ã€‚</div>'
    + '<div class="fg"><label>æ‹…å½“å®…å»ºå£«</label><select id="sl-agent">'+agentOpts+'</select></div>'
    + '<div class="fg-row">'
    + '<div class="fg"><label>æ—¥ä»˜</label><input type="date" id="sl-date" min="'+today()+'" value="'+(preDate||today())+'"></div>'
    + '<div class="fg"><label>é–‹å§‹æ™‚åˆ»</label><input type="time" id="sl-start" value="10:00"></div>'
    + '<div class="fg"><label>çµ‚äº†æ™‚åˆ»</label><input type="time" id="sl-end" value="11:00"></div>'
    + '</div>'
    + '<div class="fg"><label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label><input type="text" id="sl-note" placeholder="ä¾‹: Zoomå„ªå…ˆ / é¦–éƒ½åœã®ã¿"></div>',
    [
      { label:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', cls:'btn-ghost', fn:'closeModal()' },
      { label:'â• ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ ', cls:'btn-gold', fn:'execAddSlot()' }
    ]
  );
}

function execAddSlot(){
  var agentId = document.getElementById('sl-agent').value;
  var date    = document.getElementById('sl-date').value;
  var start   = document.getElementById('sl-start').value;
  var end     = document.getElementById('sl-end').value;
  var note    = document.getElementById('sl-note').value;
  if (!date||!start||!end){ toast('æ—¥ä»˜ãƒ»æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

  var slots = loadSlots();
  var newSlot = {
    id: 'SL-'+Date.now().toString(36).toUpperCase(),
    agentId, agentName: agentName(agentId),
    date, start, end, status: 'open',
    note, addedBy: SESSION.name||SESSION.userId,
    addedAt: new Date().toISOString(),
    bookedCase: null, bookedClient: null,
  };
  slots.push(newSlot);
  save(KEYS.slots, slots);

  var detail = agentName(agentId)+' '+fmtDate(date)+' '+start+'ã€œ'+end;
  saveHqLog('ã‚¹ãƒ­ãƒƒãƒˆè¿½åŠ ', detail);

  closeModal();
  toast('âœ… ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  renderSlots();
  updateNavBadges();
}

function deleteSlot(slotId){
  if (!confirm('ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  var slots = loadSlots().filter(function(s){ return s.id!==slotId; });
  save(KEYS.slots, slots);
  saveHqLog('ã‚¹ãƒ­ãƒƒãƒˆå‰Šé™¤', slotId);
  toast('ã‚¹ãƒ­ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  renderSlots();
}

// â•â• REQUESTSï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´ï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRequests(){
  var reqs = loadRequests();
  reqs.sort(function(a,b){ return b.submittedAt.localeCompare(a.submittedAt); });

  var html = '<div class="page-hdr"><span style="font-size:20px">ğŸ“‹</span>'
    + '<div><div class="page-title">ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´</div>'
    + '<div class="page-sub">å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å—ä»˜ãƒ»ãƒãƒƒãƒãƒ³ã‚°å±¥æ­´</div></div></div>';

  if (!reqs.length){
    html += '<div class="empty"><div class="empty-icon">ğŸ“­</div>ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
    document.getElementById('main-content').innerHTML = html;
    return;
  }

  html += '<div class="card"><div class="card-body" style="padding:0"><table class="tbl"><thead><tr>'
    + '<th>å—ä»˜æ—¥æ™‚</th><th>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</th><th>Case ID</th>'
    + '<th>æ‹…å½“AG</th><th>å¸Œæœ›æ—¥æ™‚</th><th>çŠ¶æ…‹</th><th>ç¢ºå®šæ—¥æ™‚</th></tr></thead><tbody>';

  reqs.forEach(function(r){
    var badge = r.status==='open'
      ? '<span class="badge b-wait">å—ä»˜ä¸­</span>'
      : r.status==='matched'
      ? '<span class="badge b-done">ãƒãƒƒãƒãƒ³ã‚°æ¸ˆ</span>'
      : '<span class="badge b-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>';

    html += '<tr>'
      + '<td class="mono" style="font-size:10px">'+fmtDt(r.submittedAt)+'</td>'
      + '<td style="font-weight:600">'+escHtml(r.clientName)+'</td>'
      + '<td class="mono" style="color:var(--sub)">'+escHtml(r.caseId)+'</td>'
      + '<td>'+escHtml(r.agentName)+'</td>'
      + '<td style="font-size:10px;line-height:1.6">'
      + r.wishes.map(function(w){ return fmtDate(w.date)+' '+w.start+'ã€œ'+w.end; }).join('<br>')
      + '</td>'
      + '<td>'+badge+'</td>'
      + '<td class="mono" style="font-size:10px;color:var(--sub)">'+(r.matchedAt?fmtDt(r.matchedAt):'â€”')+'</td></tr>';
  });

  html += '</tbody></table></div></div>';
  document.getElementById('main-content').innerHTML = html;
}

// â•â• LOGï¼ˆä»‹å…¥ãƒ­ã‚°ï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLog(){
  var logs = loadHqLog();

  var html = '<div class="page-hdr"><span style="font-size:20px">ğŸ“</span>'
    + '<div><div class="page-title">HQä»‹å…¥ãƒ­ã‚°</div>'
    + '<div class="page-sub">ã™ã¹ã¦ã®ç®¡ç†æ“ä½œã®è¨˜éŒ²</div></div>'
    + '<button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="if(confirm(\'ãƒ­ã‚°ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\')){localStorage.removeItem(\''+KEYS.hqLog+'\');renderLog();}">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>'
    + '</div>';

  if (!logs.length){
    html += '<div class="empty"><div class="empty-icon">ğŸ“‹</div>æ“ä½œãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
    document.getElementById('main-content').innerHTML = html;
    return;
  }

  html += '<div class="card"><div class="card-body">';
  logs.forEach(function(l){
    var icon = {
      'HQãƒãƒƒãƒãƒ³ã‚°ç¢ºå®š':'ğŸ¯', 'HQæ‰‹å‹•ãƒãƒƒãƒãƒ³ã‚°':'ğŸ¢', 'HQå¼·åˆ¶å®Œäº†':'âœ…',
      'æ‹…å½“è€…å¤‰æ›´':'ğŸ”„', 'æ—¥ç¨‹å¤‰æ›´':'ğŸ“…', 'äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«':'ğŸš«',
      'ã‚¹ãƒ­ãƒƒãƒˆè¿½åŠ ':'â•', 'ã‚¹ãƒ­ãƒƒãƒˆå‰Šé™¤':'ğŸ—‘', 'å¼·åˆ¶å®Œäº†ç¢ºèª':'âœ…',
    }[l.action] || 'ğŸ“';
    var iconBg = {
      'ğŸ¯':'rgba(52,211,153,.1)', 'ğŸ¢':'rgba(79,156,249,.1)',
      'ğŸ”„':'rgba(79,156,249,.1)', 'ğŸ“…':'rgba(251,146,60,.1)',
      'ğŸš«':'rgba(248,113,113,.1)', 'âœ…':'rgba(52,211,153,.1)',
    }[icon] || 'var(--card2)';

    html += '<div class="log-item">'
      + '<div class="log-icon" style="background:'+iconBg+'">'+icon+'</div>'
      + '<div><div class="log-body"><strong>'+escHtml(l.action)+'</strong>ã€€'+escHtml(l.detail)+'</div>'
      + '<div style="display:flex;gap:10px;margin-top:2px">'
      + '<span class="log-time">'+fmtDt(l.at)+'</span>'
      + '<span style="font-size:9px;color:var(--muted)">æ“ä½œè€…: '+escHtml(l.operator)+'</span>'
      + '</div></div></div>';
  });
  html += '</div></div>';
  document.getElementById('main-content').innerHTML = html;
}

// â•â• ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(title, bodyHtml, buttons){
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').innerHTML = bodyHtml;
  document.getElementById('modal-footer').innerHTML = buttons.map(function(b){
    return '<button class="btn '+b.cls+'" onclick="'+b.fn+'">'+b.label+'</button>';
  }).join('');
  document.getElementById('modal-bg').classList.add('open');
}
function closeModal(){
  document.getElementById('modal-bg').classList.remove('open');
}
document.getElementById('modal-bg').addEventListener('click', function(e){
  if (e.target===this) closeModal();
});

// â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
updateNavBadges();
renderView('dashboard');
setInterval(function(){ updateNavBadges(); }, 30000);
</script>
</body>
</html>
