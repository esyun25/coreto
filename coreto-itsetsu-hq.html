<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ITé‡èª¬ ç®¡ç†ãƒ‘ãƒãƒ« | CORETO HQ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans','Hiragino Kaku Gothic ProN',sans-serif;background:#0b0d12;color:#e4e7f0;min-height:100vh;padding:16px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #1e2435}
.header h1{font-size:16px;font-weight:800;letter-spacing:.05em}
.header a{font-size:11px;color:#4f9cf9;text-decoration:none}
.tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
.tab{padding:7px 14px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid #1e2435;background:#141820;color:#7a86a0;white-space:nowrap;transition:.2s}
.tab.active{background:rgba(79,156,249,.12);border-color:rgba(79,156,249,.3);color:#4f9cf9}
.card{background:#141820;border:1px solid #1e2435;border-radius:12px;padding:14px;margin-bottom:10px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.badge{font-size:9px;padding:2px 8px;border-radius:12px;font-weight:700}
.badge-wait{background:rgba(251,191,36,.12);color:#fbbf24;border:1px solid rgba(251,191,36,.2)}
.badge-booked{background:rgba(79,156,249,.12);color:#4f9cf9;border:1px solid rgba(79,156,249,.2)}
.badge-done{background:rgba(52,211,153,.12);color:#34d399;border:1px solid rgba(52,211,153,.2)}
.badge-cancel{background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.15)}
.badge-request{background:rgba(167,139,250,.12);color:#a78bfa;border:1px solid rgba(167,139,250,.2)}
.info-grid{display:grid;grid-template-columns:auto 1fr;gap:3px 12px;font-size:10px}
.info-label{color:#5a6080}
.info-val{color:#c8d0e0}
.info-val.highlight{color:#4f9cf9;font-weight:700}
.info-val.green{color:#34d399;font-weight:700}
.info-val.warn{color:#fbbf24}
.stat-row{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.stat{background:#141820;border:1px solid #1e2435;border-radius:10px;padding:12px 16px;flex:1;min-width:100px;text-align:center}
.stat-num{font-size:22px;font-weight:900;margin-bottom:2px}
.stat-label{font-size:9px;color:#5a6080;letter-spacing:.05em}
.empty{text-align:center;padding:32px;color:#3a4060;font-size:11px}
.action-btn{background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.25);color:#34d399;border-radius:7px;padding:5px 12px;cursor:pointer;font-size:10px;font-family:inherit;font-weight:700;transition:.2s}
.action-btn:hover{background:rgba(52,211,153,.18)}
.warn-btn{background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.25);color:#fb923c;border-radius:7px;padding:5px 12px;cursor:pointer;font-size:10px;font-family:inherit}
.alert-box{background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:10px 12px;margin-bottom:10px;font-size:11px;color:#ef4444}
.section-title{font-size:10px;font-weight:700;color:#5a6080;letter-spacing:.08em;margin:16px 0 8px;text-transform:uppercase}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#34d399;color:#000;padding:8px 18px;border-radius:20px;font-size:12px;font-weight:700;pointer-events:none;opacity:0;transition:opacity .3s;z-index:9999}
.meet-link{font-size:9px;color:#4f9cf9;word-break:break-all;font-family:monospace}
.change-warn{background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:6px;padding:6px 10px;margin-top:6px;font-size:9px;color:#ef4444}
</style>
</head>
<body>
<div class="header">
  <h1>ğŸ“… ITé‡èª¬ ç®¡ç†ãƒ‘ãƒãƒ«</h1>
  <a href="coreto-hub.html">â† Hub</a>
</div>

<div id="alert-area"></div>

<div class="stat-row" id="stats"></div>

<div class="tabs">
  <div class="tab active" onclick="showTab('waiting')">â³ é‡èª¬å¾…ã¡</div>
  <div class="tab" onclick="showTab('booked')">ğŸ“… äºˆç´„ç¢ºå®š</div>
  <div class="tab" onclick="showTab('requests')">ğŸ“¨ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
  <div class="tab" onclick="showTab('payment')">ğŸ’° å…¥é‡‘ç¢ºèª</div>
  <div class="tab" onclick="showTab('done')">âœ… å®Œäº†æ¸ˆã¿</div>
</div>

<div id="tab-content"></div>
<div class="toast" id="toast"></div>

<script>
  // â”€â”€ Slacké€šçŸ¥è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æœ¬ç•ªé‹ç”¨å‰ã« Slack Incoming Webhook URL ã‚’è¨­å®šã—ã¦ãã ã•ã„
  // Slackç®¡ç†ç”»é¢ â†’ ã‚¢ãƒ—ãƒª â†’ Incoming Webhooks â†’ Webhook URLã‚’ã‚³ãƒ”ãƒ¼
  var SLACK_WEBHOOK = window.SLACK_CONFIG
    ? window.SLACK_CONFIG.GENERAL   // db.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
    : 'YOUR_SLACK_WEBHOOK_URL';     // ç›´æ¥è¨­å®šã™ã‚‹å ´åˆã¯ã“ã“ã«è²¼ã‚Šä»˜ã‘

  function notifySlack(msg) {
    if (!SLACK_WEBHOOK || SLACK_WEBHOOK === 'YOUR_SLACK_WEBHOOK_URL') {
      console.log('[Slackï¼ˆæœªè¨­å®šï¼‰]', msg);
      return;
    }
    fetch(SLACK_WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: msg }),
      mode: 'no-cors'
    }).catch(e => console.error('[Slacké€ä¿¡ã‚¨ãƒ©ãƒ¼]', e));
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(function(){
  var s = null;
  try { s = JSON.parse(sessionStorage.getItem('coreto_session')||'null'); } catch(e){}
  if (!s || s.type !== 'hq') {
    location.href = 'coreto-login.html';
    return;
  }
  window._SESSION = s;
})();

var activeTab = 'waiting';

// â”€â”€ Storage readers (shared with booking/schedule)
var BOOKINGS_KEY = 'coreto_itsetsu_bookings';
var SLOTS_KEY    = 'coreto_itsetsu_slots';
var REQUESTS_KEY = 'coreto_itsetsu_requests';

function loadBookings() { try { return JSON.parse(localStorage.getItem(BOOKINGS_KEY)||'[]'); } catch(e){ return []; } }
function loadSlots()    { try { return JSON.parse(localStorage.getItem(SLOTS_KEY)||'[]');    } catch(e){ return []; } }
function loadRequests() { try { return JSON.parse(localStorage.getItem(REQUESTS_KEY)||'[]'); } catch(e){ return []; } }
function saveBookings(b){ localStorage.setItem(BOOKINGS_KEY, JSON.stringify(b)); }

function today(){ return new Date().toISOString().slice(0,10); }
function fmtDate(d){
  if (!d) return 'â€”';
  var dt = new Date(d+'T00:00:00');
  var WD = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  return (dt.getMonth()+1)+'æœˆ'+dt.getDate()+'æ—¥ï¼ˆ'+WD[dt.getDay()]+'ï¼‰';
}
function minsUntil(dateStr, timeStr){
  if (!dateStr || !timeStr) return 9999;
  var dt = new Date(dateStr+'T'+timeStr+':00');
  return (dt - new Date()) / 60000;
}

// â”€â”€ ç›´å‰å¤‰æ›´æ¤œçŸ¥ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰
function isLateChange(bk){
  if (!bk.changeHistory || !bk.changeHistory.length) return false;
  var last = bk.changeHistory[bk.changeHistory.length-1];
  if (!last || !last.at) return false;
  var minsSinceChange = (new Date() - new Date(last.at)) / 60000;
  var minsUntilAppt   = minsUntil(bk.date, bk.start);
  return minsUntilAppt < 1440 && minsSinceChange < 2880;
}

function renderStats(){
  var bks = loadBookings();
  var active = bks.filter(function(b){ return b.status==='active'; });
  var cancelled = bks.filter(function(b){ return b.status==='cancelled'; });
  var reqs = loadRequests().filter(function(r){ return r.status==='open'; });
  var today_ = today();
  var todayBks = active.filter(function(b){ return b.date === today_; });
  var lateChanges = active.filter(isLateChange);

  var html = '';
  // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‹ã‚‰å…¥é‡‘å¾…ã¡æ¡ˆä»¶ã‚’å–å¾—ï¼ˆCASESå…±æœ‰ï¼‰
  var allCases = [];
  try { allCases = (window.CASES || []); } catch(e){}
  var payWait = allCases.filter(function(c){
    return c.step === 'prekey' && !(c.taskDone && c.taskDone.paid) && !c.adOnly;
  });
  var stats = [
    { num: active.length,      label:'äºˆç´„ä¸­',           color:'#4f9cf9' },
    { num: todayBks.length,    label:'æœ¬æ—¥ã®é‡èª¬',        color:'#34d399' },
    { num: reqs.length,        label:'æœªå¯¾å¿œãƒªã‚¯ã‚¨ã‚¹ãƒˆ',   color:'#a78bfa' },
    { num: payWait.length,     label:'å…¥é‡‘å¾…ã¡',          color:'#fbbf24' },
    { num: lateChanges.length, label:'ç›´å‰å¤‰æ›´ï¼ˆè¦ç¢ºèªï¼‰', color:'#ef4444' },
  ];
  stats.forEach(function(s){
    html += '<div class="stat"><div class="stat-num" style="color:'+s.color+'">'+s.num+'</div><div class="stat-label">'+s.label+'</div></div>';
  });
  document.getElementById('stats').innerHTML = html;

  // ã‚¢ãƒ©ãƒ¼ãƒˆï¼šç›´å‰å¤‰æ›´
  var alertHtml = '';
  if (lateChanges.length) {
    alertHtml += '<div class="alert-box">âš ï¸ ç›´å‰å¤‰æ›´ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰ãŒ '+lateChanges.length+' ä»¶ã‚ã‚Šã¾ã™ã€‚ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰Â¥3,000ãŒå·®ã—å¼•ã‹ã‚Œã¾ã™ã€‚</div>';
  }
  document.getElementById('alert-area').innerHTML = alertHtml;
}

function showTab(tab){
  activeTab = tab;
  document.querySelectorAll('.tab').forEach(function(t,i){
    var tabs = ['waiting','booked','requests','payment','done'];
    t.classList.toggle('active', tabs[i] === tab);
  });
  renderTab();
}

function renderTab(){
  var el = document.getElementById('tab-content');
  if (activeTab === 'waiting')  renderWaiting(el);
  if (activeTab === 'booked')   renderBooked(el);
  if (activeTab === 'requests') renderRequests(el);
  if (activeTab === 'payment')  renderPayment(el);
  if (activeTab === 'done')     renderDone(el);
}

// â”€â”€ â‘  é‡èª¬å¾…ã¡: pipelineä¸Šã§prekeyçŠ¶æ…‹ã ãŒ bookingæœªç¢ºå®šã®æ¡ˆä»¶
//    â€» localStorageã®bookingsã«ãªã„ caseId ã‚’é‡èª¬å¾…ã¡ã¨ã—ã¦æ‰±ã†
function renderWaiting(el){
  var bks = loadBookings();
  var bookedCases = bks.filter(function(b){ return b.status==='active'; }).map(function(b){ return b.caseId; });
  // caseIdãªã—ã§bookingãŒæœªäºˆç´„ã®ã‚‚ã®ã¯requestsã«ã‚ã‚‹
  var reqs = loadRequests().filter(function(r){ return r.status === 'open'; });
  if (!reqs.length && !bookedCases.length) {
    el.innerHTML = '<div class="empty">é‡èª¬å¾…ã¡ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  // ä»Šæ—¥ä»¥é™ã§ç©ºãæ ã®ã‚ã‚‹æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±
  var slots = loadSlots();
  var today_ = today();
  var availSlots = slots.filter(function(s){ return s.status==='open' && s.date >= today_; });

  var html = '';
  if (reqs.length) {
    html += '<div class="section-title">ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœªãƒãƒƒãƒãƒ³ã‚°</div>';
    reqs.forEach(function(r){
      var matchable = availSlots.some(function(s){
        return r.wishes.some(function(w){ return s.date===w.date && s.start<=w.start && s.end>=w.end; });
      });
      html += '<div class="card">'
        + '<div class="card-header">'
        + '<div><div style="font-size:12px;font-weight:700">'+r.clientName+' æ§˜</div>'
        + '<div style="font-size:10px;color:#5a6080;margin-top:2px">'+r.caseId+' / '+r.propName+'</div></div>'
        + '<span class="badge badge-request">ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­</span>'
        + '</div>'
        + '<div class="info-grid">'
        + '<span class="info-label">æ‹…å½“AG</span><span class="info-val">'+r.agentName+'</span>'
        + '<span class="info-label">å¸Œæœ›æ—¥æ™‚</span><span class="info-val">'
        + r.wishes.map(function(w,i){ return (i+1)+'. '+fmtDate(w.date)+' '+w.start+'ã€œ'+w.end; }).join(' / ')
        + '</span>'
        + '<span class="info-label">ãƒãƒƒãƒå¯èƒ½</span><span class="info-val '+(matchable?'green':'warn')+'">'+(matchable?'âœ… ç©ºãæ ã‚ã‚Š':'âš ï¸ ç©ºãæ ãªã—')+'</span>'
        + '</div>'
        + '<div style="margin-top:10px"><a href="coreto-itsetsu-schedule.html" style="display:block;text-align:center;padding:8px;background:rgba(167,139,250,.1);border:1px solid rgba(167,139,250,.25);color:#a78bfa;border-radius:8px;font-size:11px;font-weight:700;text-decoration:none">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã§ãƒãƒƒãƒãƒ³ã‚°</a></div>'
        + '</div>';
    });
  }
  el.innerHTML = html || '<div class="empty">æœªãƒãƒƒãƒãƒ³ã‚°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
}

// â”€â”€ â‘¡ äºˆç´„ç¢ºå®šä¸€è¦§
function renderBooked(el){
  var bks = loadBookings().filter(function(b){ return b.status==='active'; });
  bks.sort(function(a,b){ return a.date.localeCompare(b.date) || a.start.localeCompare(b.start); });
  if (!bks.length){ el.innerHTML = '<div class="empty">äºˆç´„ç¢ºå®šä¸­ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }

  var today_ = today();
  var html = '';
  bks.forEach(function(bk){
    var mins = minsUntil(bk.date, bk.start);
    var isPast = mins < 0;
    var isToday = bk.date === today_;
    var isSoon = mins >= 0 && mins < 1440;
    var lateChg = isLateChange(bk);

    var statusBadge = isPast
      ? '<span class="badge badge-wait">å®Ÿæ–½å¾…ã¡ç¢ºèª</span>'
      : isToday
        ? '<span class="badge badge-done">æœ¬æ—¥</span>'
        : isSoon
          ? '<span class="badge badge-booked">æ˜æ—¥ä»¥å†…</span>'
          : '<span class="badge badge-booked">äºˆç´„æ¸ˆ</span>';

    html += '<div class="card">';
    if (lateChg) html += '<div class="change-warn">âš ï¸ ç›´å‰å¤‰æ›´ã‚ã‚Š â€” Â¥3,000å·®ã—å¼•ãå¯¾è±¡</div>';
    html += '<div class="card-header">'
      + '<div><div style="font-size:12px;font-weight:700">'+bk.clientName+' æ§˜</div>'
      + '<div style="font-size:10px;color:#5a6080;margin-top:2px">'+bk.caseId+' / '+(bk.propName||'â€”')+'</div></div>'
      + statusBadge
      + '</div>'
      + '<div class="info-grid">'
      + '<span class="info-label">æ—¥æ™‚</span><span class="info-val highlight">'+fmtDate(bk.date)+'ã€€'+bk.start+'ã€œ</span>'
      + '<span class="info-label">é‡èª¬æ‹…å½“</span><span class="info-val">'+bk.itAgentName+'</span>'
      + '<span class="info-label">æ‹…å½“AG</span><span class="info-val">'+bk.agentName+'</span>'
      + '<span class="info-label">å¤‰æ›´å›æ•°</span><span class="info-val '+(bk.changeCount>=2?'warn':'')+'">'+bk.changeCount+'å›</span>'
      + '</div>';
    if (bk.meetUrl) html += '<div class="meet-link" style="margin-top:8px">ğŸ¥ '+bk.meetUrl+'</div>';
    if (isPast) {
      html += '<button class="action-btn" style="margin-top:10px;width:100%" onclick="forceComplete(\''+bk.id+'\')">âœ… å®Œäº†ç¢ºèªï¼ˆéå»ã®äºˆç´„ï¼‰</button>';
    }
    html += '</div>';
  });
  el.innerHTML = html;
}

// â”€â”€ â‘¢ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ï¼ˆå…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
function renderRequests(el){
  var reqs = loadRequests();
  reqs.sort(function(a,b){ return b.submittedAt.localeCompare(a.submittedAt); });
  if (!reqs.length){ el.innerHTML = '<div class="empty">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }

  var html = '';
  reqs.forEach(function(r){
    var cls = r.status==='open' ? 'badge-request' : r.status==='matched' ? 'badge-done' : 'badge-cancel';
    var lbl = r.status==='open' ? 'å—ä»˜ä¸­' : r.status==='matched' ? 'ãƒãƒƒãƒãƒ³ã‚°æ¸ˆ' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    html += '<div class="card">'
      + '<div class="card-header">'
      + '<div><div style="font-size:12px;font-weight:700">'+r.clientName+' æ§˜</div>'
      + '<div style="font-size:10px;color:#5a6080;margin-top:2px">'+r.caseId+'</div></div>'
      + '<span class="badge '+cls+'">'+lbl+'</span>'
      + '</div>'
      + '<div class="info-grid">'
      + '<span class="info-label">æ‹…å½“AG</span><span class="info-val">'+r.agentName+'</span>'
      + '<span class="info-label">å—ä»˜æ—¥æ™‚</span><span class="info-val">'+r.submittedAt.slice(0,16).replace('T',' ')+'</span>'
      + '<span class="info-label">å¸Œæœ›æ—¥æ™‚</span><span class="info-val">'
      + r.wishes.map(function(w,i){ return (i+1)+'. '+fmtDate(w.date)+' '+w.start+'ã€œ'+w.end; }).join('<br>')
      + '</span>'
      + (r.matchedAt ? '<span class="info-label">ç¢ºå®šæ—¥æ™‚</span><span class="info-val green">'+r.matchedAt.slice(0,16).replace('T',' ')+'</span>' : '')
      + '</div>'
      + '</div>';
  });
  el.innerHTML = html;
}

// â”€â”€ â‘¢.5 å…¥é‡‘ç¢ºèªã‚¿ãƒ–
function renderPayment(el) {
  // CASES ãŒ pipeline.html ã‹ã‚‰èª­ã‚ãªã„å ´åˆã¯localStorageçµŒç”±
  // ã“ã“ã§ã¯ pipeline.html ã¨åŒä¸€ãƒ–ãƒ©ã‚¦ã‚¶ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ WINDOW.CASES ãŒå…±æœ‰ã•ã‚Œãªã„å‰æã§
  // Slacké€šçŸ¥ãƒ™ãƒ¼ã‚¹ã®é‹ç”¨æ¡ˆå†…ï¼‹pipeline.htmlã¸ã®ãƒªãƒ³ã‚¯ã‚’æä¾›
  var html = '<div style="background:rgba(79,156,249,.06);border:1px solid rgba(79,156,249,.15);'
    + 'border-radius:10px;padding:16px;margin-bottom:14px;font-size:11px;color:#a0b0c8">'
    + '<div style="font-size:12px;font-weight:700;color:#4f9cf9;margin-bottom:8px">ğŸ’° å…¥é‡‘ç¢ºèªã«ã¤ã„ã¦</div>'
    + '<div style="line-height:1.9">'
    + 'å…¥é‡‘ç¢ºèªã¯ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç”»é¢ï¼ˆæœ¬éƒ¨ãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰ã®å„æ¡ˆä»¶ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚<br>'
    + 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã¯ã€Œå…¥é‡‘å¾…ã¡ã€è¡¨ç¤ºã®ã¿ã€ç¢ºèªãƒœã‚¿ãƒ³ã¯æœ¬éƒ¨ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>'
    + '<br>'
    + 'â€¢ æŒ¯è¾¼ç¢ºèªå¾Œã€<strong style="color:#e0e8f0">å®Ÿéš›ã®æŒ¯è¾¼æ—¥</strong>ã‚’å…¥åŠ›ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„<br>'
    + 'â€¢ GMOå…¥é‡‘é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ç­‰ã‚’å‚ç…§ã—ã€æŒ¯è¾¼æ—¥ãƒ»å‚™è€ƒã‚’è¨˜éŒ²ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™<br>'
    + 'â€¢ ç¢ºèªå¾Œ Slack #å…¥é‡‘ç¢ºèª ã«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã€æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é€£çµ¡ãŒå±Šãã¾ã™<br>'
    + '</div>'
    + '</div>';

  // å…¥é‡‘ç¢ºèªæ¸ˆã¿å±¥æ­´ï¼ˆCASES ã‹ã‚‰ paid: true ã®ã‚‚ã®ã‚’è¡¨ç¤ºï¼‰
  // pipeline ã¨åŒã˜ localStorage ã‚­ãƒ¼ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
  var cases = [];
  try {
    var raw = localStorage.getItem('coreto_cases');
    if (raw) cases = JSON.parse(raw);
    else cases = window.CASES || [];
  } catch(e) { cases = window.CASES || []; }

  var paidCases = cases.filter(function(c){
    return c.taskDone && c.taskDone.paid;
  }).sort(function(a,b){
    return (b.dates&&b.dates.paid||'').localeCompare(a.dates&&a.dates.paid||'');
  });

  var waitCases = cases.filter(function(c){
    return c.step === 'prekey' && !(c.taskDone && c.taskDone.paid) && !c.adOnly;
  });

  if (waitCases.length) {
    html += '<div style="font-size:10px;font-weight:700;color:#fbbf24;letter-spacing:.08em;margin-bottom:8px;text-transform:uppercase">â³ å…¥é‡‘å¾…ã¡ï¼ˆ' + waitCases.length + 'ä»¶ï¼‰</div>';
    waitCases.forEach(function(c) {
      var inv = c.invoice;
      var totalAmt = inv ? (inv.grandTotal || (inv.commAmt||0)+(inv.adAmt||0) || 0) : 0;
      var prop = (c.apps&&c.apps.find(function(a){return a.status==='approved';})||{}).prop || c.sub || 'â€”';
      html += '<div class="card">'
        + '<div class="card-header">'
        + '<div><div style="font-size:12px;font-weight:700">'+c.name+' æ§˜</div>'
        + '<div style="font-size:10px;color:#5a6080;margin-top:2px">'+c.id+' / '+prop+'</div></div>'
        + '<span class="badge badge-wait">å…¥é‡‘å¾…ã¡</span>'
        + '</div>'
        + '<div class="info-grid">'
        + '<span class="info-label">æ‹…å½“AG</span><span class="info-val">'+c.agent+'</span>'
        + (totalAmt ? '<span class="info-label">è«‹æ±‚é‡‘é¡</span><span class="info-val warn">Â¥'+totalAmt.toLocaleString()+'</span>' : '')
        + '</div>'
        + '<div style="margin-top:10px;display:flex;gap:6px">'
        + '<input type="date" id="pd-'+c.id+'" value="'+today_()+'" style="flex:1;background:#090b13;border:1px solid #2a3050;border-radius:7px;padding:7px 8px;color:#e0e8f0;font-family:inherit;font-size:11px;outline:none">'
        + '<button onclick="hqPaymentConfirm(\'' + c.id + '\')" class="action-btn">âœ… å…¥é‡‘ç¢ºèª</button>'
        + '</div>'
        + '<div style="font-size:9px;color:#3a4060;margin-top:4px">â†‘ GMOé€šçŸ¥ç­‰ã§ç¢ºèªã—ãŸå®Ÿéš›ã®æŒ¯è¾¼æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'
        + '</div>';
    });
    html += '<div style="margin-bottom:16px"></div>';
  }

  if (paidCases.length) {
    html += '<div style="font-size:10px;font-weight:700;color:#34d399;letter-spacing:.08em;margin-bottom:8px;text-transform:uppercase">âœ… å…¥é‡‘ç¢ºèªæ¸ˆã¿ï¼ˆ' + paidCases.length + 'ä»¶ï¼‰</div>';
    paidCases.slice(0,20).forEach(function(c) {
      var inv = c.invoice;
      var totalAmt = inv ? (inv.grandTotal || (inv.commAmt||0)+(inv.adAmt||0) || 0) : 0;
      html += '<div class="card">'
        + '<div class="card-header">'
        + '<div><div style="font-size:12px;font-weight:700">'+c.name+' æ§˜</div>'
        + '<div style="font-size:10px;color:#5a6080;margin-top:2px">'+c.id+'</div></div>'
        + '<span class="badge badge-done">ç¢ºèªæ¸ˆ</span>'
        + '</div>'
        + '<div class="info-grid">'
        + '<span class="info-label">æŒ¯è¾¼æ—¥</span><span class="info-val green">'+(c.dates&&c.dates.paid||'â€”')+'</span>'
        + (totalAmt ? '<span class="info-label">é‡‘é¡</span><span class="info-val">Â¥'+totalAmt.toLocaleString()+'</span>' : '')
        + '</div></div>';
    });
  }

  if (!waitCases.length && !paidCases.length) {
    html += '<div class="empty">å…¥é‡‘é–¢é€£ã®æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br><span style="font-size:10px">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç”»é¢ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™</span></div>';
  }

  el.innerHTML = html;
}

function hqPaymentConfirm(caseId) {
  // pipeline.html ã¨åŒã˜ CASES ã‚’å‚ç…§ã§ãã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
  var cases = [];
  try {
    var raw = localStorage.getItem('coreto_cases');
    if (raw) cases = JSON.parse(raw);
    else cases = window.CASES || [];
  } catch(e) { cases = window.CASES || []; }

  var c = cases.find(function(x){ return x.id === caseId; });
  if (!c) {
    alert('æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç”»é¢ã‹ã‚‰å…¥é‡‘ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  var inp = document.getElementById('pd-' + caseId);
  var paidDate = inp ? inp.value : today_();
  if (!paidDate) { toast('æŒ¯è¾¼æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  if(!c.taskDone) c.taskDone = {};
  c.taskDone.paid = true;
  c.dates.paid = paidDate;
  c.hist = c.hist || [];
  c.hist.unshift(paidDate + ' å…¥é‡‘ç¢ºèªæ¸ˆã€æœ¬éƒ¨ç¢ºèª: ' + (window._SESSION.name||window._SESSION.userId) + 'ã€‘');

  // localStorage ã«ä¿å­˜ï¼ˆCASESé…åˆ—å…¨ä½“ï¼‰
  try {
    if (localStorage.getItem('coreto_cases')) {
      localStorage.setItem('coreto_cases', JSON.stringify(cases));
    }
  } catch(e) {}

  notifySlack('[Slack #å…¥é‡‘ç¢ºèª] å…¥é‡‘ç¢ºèª æ¡ˆä»¶:' + caseId + ' æŒ¯è¾¼æ—¥:' + paidDate
    + ' ç¢ºèªè€…:' + (window._SESSION.name||window._SESSION.userId)));
  toast('âœ… å…¥é‡‘ç¢ºèªã—ã¾ã—ãŸï¼ˆæŒ¯è¾¼æ—¥: ' + paidDate + 'ï¼‰');
  renderTab();
  renderStats();
}

// â”€â”€ â‘£ å®Œäº†æ¸ˆã¿
function renderDone(el){
  var slots = loadSlots().filter(function(s){ return s.itDone; });
  var cancelled = loadBookings().filter(function(b){ return b.status==='cancelled'; });
  if (!slots.length && !cancelled.length){ el.innerHTML = '<div class="empty">å®Œäº†ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }

  var html = '';
  if (slots.length) {
    html += '<div class="section-title">é‡èª¬å®Œäº†ï¼ˆæ‹…å½“å ±å‘Šæ¸ˆã¿ï¼‰</div>';
    slots.forEach(function(s){
      var bk = loadBookings().find(function(b){ return b.slotId===s.id; });
      html += '<div class="card">'
        + '<div class="card-header">'
        + '<div><div style="font-size:12px;font-weight:700">'+(s.bookedClient||'â€”')+' æ§˜</div>'
        + '<div style="font-size:10px;color:#5a6080;margin-top:2px">'+(s.bookedCase||'â€”')+'</div></div>'
        + '<span class="badge badge-done">å®Œäº†</span>'
        + '</div>'
        + '<div class="info-grid">'
        + '<span class="info-label">å®Ÿæ–½æ—¥</span><span class="info-val green">'+fmtDate(s.date)+'</span>'
        + '<span class="info-label">é‡èª¬æ‹…å½“</span><span class="info-val">'+s.agentName+'</span>'
        + (bk ? '<span class="info-label">æ‹…å½“AG</span><span class="info-val">'+bk.agentName+'</span>' : '')
        + '<span class="info-label">å ±å‘Šæ—¥æ™‚</span><span class="info-val">'+(s.itDoneAt||'').slice(0,16).replace('T',' ')+'</span>'
        + '</div></div>';
    });
  }
  if (cancelled.length) {
    html += '<div class="section-title">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿</div>';
    cancelled.sort(function(a,b){ return b.cancelledAt.localeCompare(a.cancelledAt); }).slice(0,20).forEach(function(bk){
      html += '<div class="card">'
        + '<div class="card-header">'
        + '<div><div style="font-size:12px;font-weight:700">'+bk.clientName+' æ§˜</div>'
        + '<div style="font-size:10px;color:#5a6080;margin-top:2px">'+bk.caseId+'</div></div>'
        + '<span class="badge badge-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>'
        + '</div>'
        + '<div class="info-grid">'
        + '<span class="info-label">äºˆå®šæ—¥æ™‚</span><span class="info-val">'+fmtDate(bk.date)+'ã€€'+bk.start+'</span>'
        + '<span class="info-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ—¥</span><span class="info-val">'+(bk.cancelledAt||'').slice(0,16).replace('T',' ')+'</span>'
        + '<span class="info-label">æ‹…å½“AG</span><span class="info-val">'+bk.agentName+'</span>'
        + '</div></div>';
    });
  }
  el.innerHTML = html;
}

// â”€â”€ HQæ¨©é™: éå»äºˆç´„ã®å®Œäº†å¼·åˆ¶ç¢ºèª
function forceComplete(bkId){
  if (!confirm('ã“ã®äºˆç´„ã‚’ã€Œå®Œäº†ã€ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆé‡èª¬æ‹…å½“ã‹ã‚‰å®Œäº†å ±å‘ŠãŒãªã„å ´åˆã®HQæ‰‹å‹•å‡¦ç†ï¼‰')) return;
  var bks = loadBookings();
  var bk = bks.find(function(b){ return b.id===bkId; });
  if (!bk) return;
  bk.hqForceCompleted = true;
  bk.hqCompletedAt = new Date().toISOString();
  saveBookings(bks);
  notifySlack('[Slack #ITé‡èª¬æ—¥ç¨‹èª¿æ•´] HQæ‰‹å‹•å®Œäº†ç¢ºèª æ¡ˆä»¶:'+bk.caseId+' ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ:'+bk.clientName));
  toast('âœ… å®Œäº†ç¢ºèªã—ã¾ã—ãŸã€‚æ‹…å½“AGã«Slacké€šçŸ¥ã—ã¾ã—ãŸã€‚');
  renderTab();
  renderStats();
}

function toast(msg){
  var t = document.getElementById('toast');
  t.textContent = msg; t.style.opacity = 1;
  setTimeout(function(){ t.style.opacity = 0; }, 2500);
}

// â”€â”€ init
renderStats();
renderTab();
setInterval(function(){ renderStats(); }, 30000);
</script>
</body>
</html>
