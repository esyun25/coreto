<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ── Content Security Policy (XSS軽減) ──────────────────────────────────
       変更時: 使用する外部サービスのオリジンを追加してください
       Kintone追加時: connect-src に *.cybozu.com を追加
  ─────────────────────────────────────────────────────────────────────── -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline'
      https://cdnjs.cloudflare.com
      https://js.stripe.com
      https://cdn-cgi/scripts;
    style-src 'self' 'unsafe-inline'
      https://fonts.googleapis.com;
    font-src 'self'
      https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    connect-src 'self'
      https://hooks.slack.com
      https://hooks.zapier.com
      https://api.stripe.com
      https://js.stripe.com
      https://www.houjin-bangou.nta.go.jp
      https://www.retio.or.jp;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
  ">

<meta charset="UTF-8">
<title>CORETO 宛名ラベルシート</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Noto Sans JP', sans-serif;
  background: #f0f0f0;
}

/* ===== 画面プレビュー用UI ===== */
.ui-bar {
  background: #1a1a2e;
  color: #e8eaf0;
  padding: 14px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}

.ui-logo { font-weight: 700; color: #c9a84c; letter-spacing: 2px; font-size: 16px; }
.ui-sub { font-size: 11px; color: #6b7280; margin-top: 2px; }

.ui-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

.ui-btn {
  padding: 7px 16px;
  border-radius: 5px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  font-family: 'Noto Sans JP', sans-serif;
  transition: all 0.15s;
}

.btn-print { background: #c9a84c; color: #0a0c10; }
.btn-print:hover { background: #e8c96a; }
.btn-outline { background: transparent; color: #9ca3af; border: 1px solid #374151; }
.btn-outline:hover { border-color: #c9a84c; color: #c9a84c; }

.ui-info {
  font-size: 11px;
  color: #6b7280;
  background: rgba(201,168,76,0.1);
  border: 1px solid rgba(201,168,76,0.2);
  padding: 6px 12px;
  border-radius: 4px;
}

/* ===== タブ ===== */
.tabs {
  background: #111827;
  padding: 0 24px;
  display: flex;
  gap: 0;
  border-bottom: 1px solid #1f2937;
}

.tab {
  padding: 10px 18px;
  font-size: 12px;
  color: #6b7280;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
  white-space: nowrap;
}

.tab:hover { color: #e8eaf0; }
.tab.active { color: #c9a84c; border-bottom-color: #c9a84c; }

/* ===== シート全体 ===== */
.sheet-wrapper {
  padding: 24px;
  display: flex;
  justify-content: center;
}

/* A4 = 210mm × 297mm を画面表示用にスケール */
.sheet {
  width: 210mm;
  min-height: 297mm;
  background: white;
  padding: 10mm 8mm;
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: repeat(5, 1fr);
  gap: 3mm;
  box-shadow: 0 4px 24px rgba(0,0,0,0.2);
}

/* ===== 1枚のラベル ===== */
.label {
  border: 1.5px dashed #ccc;
  border-radius: 3px;
  padding: 4mm 5mm;
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
  min-height: 52mm;
}

/* ラベル種別ごとの上部カラーバー */
.label::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
}

.label-client::before { background: #3b82f6; }
.label-client-return::before { background: #8b5cf6; }
.label-mgmt::before { background: #f59e0b; }
.label-blank::before { background: #e5e7eb; }

/* ラベル種別タグ */
.label-type-tag {
  font-size: 7px;
  font-weight: 700;
  letter-spacing: 0.5px;
  padding: 1.5px 5px;
  border-radius: 2px;
  display: inline-block;
  margin-bottom: 3mm;
  margin-top: 1mm;
  width: fit-content;
}

.tag-client { background: #dbeafe; color: #1d4ed8; }
.tag-return { background: #ede9fe; color: #6d28d9; }
.tag-mgmt { background: #fef3c7; color: #b45309; }
.tag-blank { background: #f3f4f6; color: #9ca3af; }

/* 宛先部分 */
.to-section { flex: 1; }

.postal { font-size: 11px; color: #374151; letter-spacing: 2px; margin-bottom: 1mm; font-weight: 500; }
.address { font-size: 8px; color: #374151; line-height: 1.5; margin-bottom: 1mm; }
.name { font-size: 12px; font-weight: 700; color: #111827; line-height: 1.3; }
.honorific { font-size: 9px; font-weight: 400; color: #374151; }

/* 仕切り線 */
.divider-line {
  border: none;
  border-top: 0.5px solid #e5e7eb;
  margin: 2mm 0;
}

/* 差出人部分 */
.from-section { }

.from-label-text {
  font-size: 6.5px;
  color: #9ca3af;
  letter-spacing: 0.5px;
  margin-bottom: 1mm;
}

.from-name { font-size: 8px; font-weight: 700; color: #374151; line-height: 1.4; }
.from-address { font-size: 7px; color: #6b7280; line-height: 1.4; }
.from-tel { font-size: 7px; color: #6b7280; }

/* 案件情報 */
.case-info {
  position: absolute;
  bottom: 3mm;
  right: 4mm;
  font-size: 6.5px;
  color: #9ca3af;
  text-align: right;
  line-height: 1.4;
}

/* 空白ラベル */
.blank-content {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #e5e7eb;
  font-size: 9px;
}

/* 印刷時 */
@media print {
  .ui-bar, .tabs, .sheet-wrapper > *:not(.sheet) { display: none !important; }
  .sheet-wrapper { padding: 0; background: white; }
  .sheet {
    width: 210mm;
    min-height: 297mm;
    box-shadow: none;
    padding: 10mm 8mm;
  }
  .label { border: 0.5px dashed #bbb; }
  body { background: white; }
}

/* ===== 設定パネル ===== */
.settings-panel {
  display: none;
  padding: 24px;
  max-width: 900px;
  margin: 0 auto;
}

.settings-panel.active { display: block; }
.sheet-wrapper.hidden { display: none; }

.s-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
}

.s-title { font-size: 14px; font-weight: 700; color: #111827; margin-bottom: 14px; }
.s-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
.s-group { flex: 1; min-width: 180px; }
.s-label { font-size: 11px; color: #6b7280; margin-bottom: 5px; }
.s-input { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; font-family: 'Noto Sans JP', sans-serif; }
.s-select { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 13px; background: white; font-family: 'Noto Sans JP', sans-serif; }

.s-hint {
  font-size: 11px;
  color: #6b7280;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 5px;
  padding: 10px 12px;
  line-height: 1.7;
  margin-top: 12px;
}

.s-step {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  padding: 12px 0;
  border-bottom: 1px solid #f3f4f6;
}
.s-step:last-child { border-bottom: none; }
.s-step-num {
  width: 24px; height: 24px;
  background: #c9a84c;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: white;
  flex-shrink: 0;
}
.s-step-content { flex: 1; }
.s-step-title { font-size: 13px; font-weight: 600; color: #111827; margin-bottom: 3px; }
.s-step-sub { font-size: 12px; color: #6b7280; line-height: 1.6; }

code {
  background: #f3f4f6;
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 11px;
  color: #374151;
  font-family: monospace;
}
</style>
</head>
<body>
<div style="position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(7,9,15,.95);
        border-bottom:1px solid #1e2235;padding:8px 20px;display:flex;align-items:center;gap:12px;
        font-family:'Noto Sans JP',sans-serif">
      <span style="font-family:'DM Mono',monospace;font-size:16px;font-weight:800;color:#c9a84c;letter-spacing:3px">CORETO</span>
      <span style="width:1px;height:14px;background:#252a3d"></span>
      <span style="font-size:10px;color:#4a5270">宛名ラベルシート</span>
      <div style="flex:1"></div>
      <button onclick="location.href='coreto-hub.html'" style="font-size:10px;padding:5px 12px;border-radius:6px;
        border:1px solid #252a3d;background:transparent;color:#4a5270;cursor:pointer">← 戻る</button>
    </div>
    <div style="height:54px"></div>

<!-- UI バー -->
<div class="ui-bar">
  <div>
    <div class="ui-logo">CORETO</div>
    <div class="ui-sub">宛名ラベルシート印刷システム ／ A4 10面（エーワン 72303対応）</div>
  </div>
  <div class="ui-actions">
    <div class="ui-info">案件 C-003 / 渋谷区代々木 賃貸</div>
    <button class="ui-btn btn-outline" onclick="showTab('settings')">⚙️ 設定・手順</button>
    <button class="ui-btn btn-print" onclick="window.print()">🖨️ このシートを印刷</button>
  </div>
</div>

<!-- タブ -->
<div class="tabs">
  <div class="tab active" onclick="showTab('preview')" id="tab-preview">🖨 印刷プレビュー</div>
  <div class="tab" onclick="showTab('settings')" id="tab-settings">⚙️ Print Creator 設定手順</div>
</div>

<!-- ===== 印刷プレビュー ===== -->
<div class="sheet-wrapper" id="view-preview">
  <div class="sheet">

    <!-- ラベル1：顧客宛（契約書送付） -->
    <div class="label label-client">
      <span class="label-type-tag tag-client">📄 契約書送付 → お客様</span>
      <div class="to-section">
        <div class="postal">〒150-0001</div>
        <div class="address">東京都渋谷区神宮前1-1-1<br>○○マンション 201号室</div>
        <div class="name">鈴木 一郎 <span class="honorific">様</span></div>
      </div>
      <hr class="divider-line">
      <div class="from-section">
        <div class="from-label-text">差出人</div>
        <div class="from-name">CORETO ／ 担当：山田 誠</div>
        <div class="from-address">〒171-0021 東京都豊島区西池袋1-1-1</div>
        <div class="from-tel">TEL: 03-XXXX-XXXX</div>
      </div>
      <div class="case-info">C-003<br>渋谷代々木 賃貸</div>
    </div>

    <!-- ラベル2：顧客宛（鍵送付） -->
    <div class="label label-client">
      <span class="label-type-tag tag-client">🔑 鍵送付 → お客様</span>
      <div class="to-section">
        <div class="postal">〒150-0001</div>
        <div class="address">東京都渋谷区神宮前1-1-1<br>○○マンション 201号室</div>
        <div class="name">鈴木 一郎 <span class="honorific">様</span></div>
      </div>
      <hr class="divider-line">
      <div class="from-section">
        <div class="from-label-text">差出人</div>
        <div class="from-name">CORETO ／ 担当：山田 誠</div>
        <div class="from-address">〒171-0021 東京都豊島区西池袋1-1-1</div>
        <div class="from-tel">TEL: 03-XXXX-XXXX</div>
      </div>
      <div class="case-info">C-003<br>渋谷代々木 賃貸</div>
    </div>

    <!-- ラベル3：顧客宛（契約書返送用・返信用） -->
    <div class="label label-client-return">
      <span class="label-type-tag tag-return">↩️ 返信用（契約書返送）</span>
      <div class="to-section">
        <div class="postal">〒171-0021</div>
        <div class="address">東京都豊島区西池袋1-1-1</div>
        <div class="name">合同会社帝国開発<br><span style="font-size:9px;font-weight:500">CORETO 契約書受付 係</span></div>
      </div>
      <hr class="divider-line">
      <div class="from-section">
        <div class="from-label-text">差出人（お客様のお名前）</div>
        <div class="from-name">鈴木 一郎 様</div>
        <div class="from-address">〒150-0001 東京都渋谷区神宮前1-1-1</div>
      </div>
      <div class="case-info">C-003 返送用<br>署名後にご投函ください</div>
    </div>

    <!-- ラベル4：管理会社宛 -->
    <div class="label label-mgmt">
      <span class="label-type-tag tag-mgmt">🏢 管理会社送付</span>
      <div class="to-section">
        <div class="postal">〒160-0022</div>
        <div class="address">東京都新宿区新宿2-3-4<br>○○ビル 5階</div>
        <div class="name">株式会社渋谷管理 <span class="honorific">御中</span></div>
        <div style="font-size:8px;color:#374151;margin-top:1mm">管理部 ご担当者様</div>
      </div>
      <hr class="divider-line">
      <div class="from-section">
        <div class="from-label-text">差出人</div>
        <div class="from-name">CORETO ／ 担当：山田 誠</div>
        <div class="from-address">〒171-0021 東京都豊島区西池袋1-1-1</div>
        <div class="from-tel">TEL: 03-XXXX-XXXX</div>
      </div>
      <div class="case-info">C-003<br>渋谷代々木 賃貸</div>
    </div>

    <!-- ラベル5〜10：次の案件 or 空白 -->
    <div class="label label-client">
      <span class="label-type-tag tag-client">📄 契約書送付 → お客様</span>
      <div class="to-section">
        <div class="postal">〒171-0022</div>
        <div class="address">東京都豊島区南池袋3-5-7<br>池袋パークハウス 805号室</div>
        <div class="name">田中 花子 <span class="honorific">様</span></div>
      </div>
      <hr class="divider-line">
      <div class="from-section">
        <div class="from-label-text">差出人</div>
        <div class="from-name">CORETO ／ 担当：高橋 明</div>
        <div class="from-address">〒171-0021 東京都豊島区西池袋1-1-1</div>
        <div class="from-tel">TEL: 03-XXXX-XXXX</div>
      </div>
      <div class="case-info">C-007<br>南池袋 賃貸</div>
    </div>

    <div class="label label-client">
      <span class="label-type-tag tag-client">🔑 鍵送付 → お客様</span>
      <div class="to-section">
        <div class="postal">〒171-0022</div>
        <div class="address">東京都豊島区南池袋3-5-7<br>池袋パークハウス 805号室</div>
        <div class="name">田中 花子 <span class="honorific">様</span></div>
      </div>
      <hr class="divider-line">
      <div class="from-section">
        <div class="from-label-text">差出人</div>
        <div class="from-name">CORETO ／ 担当：高橋 明</div>
        <div class="from-address">〒171-0021 東京都豊島区西池袋1-1-1</div>
        <div class="from-tel">TEL: 03-XXXX-XXXX</div>
      </div>
      <div class="case-info">C-007<br>南池袋 賃貸</div>
    </div>

    <div class="label label-client-return">
      <span class="label-type-tag tag-return">↩️ 返信用（契約書返送）</span>
      <div class="to-section">
        <div class="postal">〒171-0021</div>
        <div class="address">東京都豊島区西池袋1-1-1</div>
        <div class="name">合同会社帝国開発<br><span style="font-size:9px;font-weight:500">CORETO 契約書受付 係</span></div>
      </div>
      <hr class="divider-line">
      <div class="from-section">
        <div class="from-label-text">差出人（お客様のお名前）</div>
        <div class="from-name">田中 花子 様</div>
        <div class="from-address">〒171-0022 東京都豊島区南池袋3-5-7</div>
      </div>
      <div class="case-info">C-007 返送用<br>署名後にご投函ください</div>
    </div>

    <div class="label label-mgmt">
      <span class="label-type-tag tag-mgmt">🏢 管理会社送付</span>
      <div class="to-section">
        <div class="postal">〒170-0013</div>
        <div class="address">東京都豊島区東池袋1-10-5<br>池袋センタービル 3F</div>
        <div class="name">株式会社池袋不動産 <span class="honorific">御中</span></div>
        <div style="font-size:8px;color:#374151;margin-top:1mm">管理部 ご担当者様</div>
      </div>
      <hr class="divider-line">
      <div class="from-section">
        <div class="from-label-text">差出人</div>
        <div class="from-name">CORETO ／ 担当：高橋 明</div>
        <div class="from-address">〒171-0021 東京都豊島区西池袋1-1-1</div>
        <div class="from-tel">TEL: 03-XXXX-XXXX</div>
      </div>
      <div class="case-info">C-007<br>南池袋 賃貸</div>
    </div>

    <!-- 空白ラベル -->
    <div class="label label-blank">
      <span class="label-type-tag tag-blank">空白</span>
      <div class="blank-content">— 未使用 —</div>
    </div>

    <div class="label label-blank">
      <span class="label-type-tag tag-blank">空白</span>
      <div class="blank-content">— 未使用 —</div>
    </div>

  </div>
</div>

<!-- ===== 設定手順パネル ===== -->
<div class="settings-panel" id="view-settings">

  <div class="s-card">
    <div class="s-title">📋 このシステムの全体フロー</div>
    <div style="background:#f9fafb;border-radius:6px;padding:16px;font-size:12px;color:#374151;line-height:2">
      Kintone 契約レコード
      <span style="color:#c9a84c;margin:0 8px">→</span>
      「宛名印刷」ボタンをクリック
      <span style="color:#c9a84c;margin:0 8px">→</span>
      Print Creator が住所データを取得
      <span style="color:#c9a84c;margin:0 8px">→</span>
      A4・10面 PDF を自動生成
      <span style="color:#c9a84c;margin:0 8px">→</span>
      ダウンロード
      <span style="color:#c9a84c;margin:0 8px">→</span>
      シールシートにそのまま印刷
    </div>
    <div style="margin-top:12px;font-size:12px;color:#6b7280;line-height:1.8">
      <strong style="color:#374151">1案件あたり4枚を自動生成：</strong><br>
      ① 顧客宛（契約書送付）　② 顧客宛（鍵送付）　③ 返信用（顧客→CORETO）　④ 管理会社宛<br>
      2案件分 = 8枚 → A4・1枚に収まる（残り2マスは空白）
    </div>
  </div>

  <div class="s-card">
    <div class="s-title">🔧 Print Creator 設定手順</div>

    <div class="s-step">
      <div class="s-step-num">1</div>
      <div class="s-step-content">
        <div class="s-step-title">テンプレートを新規作成</div>
        <div class="s-step-sub">
          Print Creator の管理画面 → 「テンプレート追加」<br>
          用紙サイズ：<code>A4（210mm × 297mm）</code><br>
          テンプレート名：<code>宛名ラベル_10面</code>
        </div>
      </div>
    </div>

    <div class="s-step">
      <div class="s-step-num">2</div>
      <div class="s-step-content">
        <div class="s-step-title">グリッド設定（ラベルの枠）</div>
        <div class="s-step-sub">
          列数：<code>2</code>　行数：<code>5</code>　合計：<code>10面</code><br>
          余白（上下）：<code>10mm</code>　余白（左右）：<code>8mm</code><br>
          ラベル間隔：<code>3mm</code><br>
          ※エーワン 72303 の実寸に合わせた数値
        </div>
      </div>
    </div>

    <div class="s-step">
      <div class="s-step-num">3</div>
      <div class="s-step-content">
        <div class="s-step-title">差し込みフィールドの設定</div>
        <div class="s-step-sub">
          Kintoneの「契約・請求管理」アプリと紐付け。以下のフィールドを差し込み：<br><br>
          宛先郵便番号：<code>{{申込者_郵便番号}}</code><br>
          宛先住所：<code>{{申込者_住所}}</code><br>
          宛先氏名：<code>{{申込者_氏名}}</code><br>
          管理会社名：<code>{{管理会社名}}</code><br>
          管理会社住所：<code>{{管理会社_住所}}</code><br>
          担当エージェント名：<code>{{担当エージェント_氏名}}</code><br>
          案件ID：<code>{{契約ID}}</code><br>
          物件名：<code>{{物件名}}</code>
        </div>
      </div>
    </div>

    <div class="s-step">
      <div class="s-step-num">4</div>
      <div class="s-step-content">
        <div class="s-step-title">ラベルの並び順を設定</div>
        <div class="s-step-sub">
          1番（左上）：顧客宛・契約書送付<br>
          2番（右上）：顧客宛・鍵送付<br>
          3番（左2段目）：返信用（顧客→CORETO）<br>
          4番（右2段目）：管理会社宛<br>
          5〜10番：次の案件 or 空白<br><br>
          ※ Print Creator の「ラベル種別」ごとに別テンプレートを作るか、条件分岐フィールドで制御
        </div>
      </div>
    </div>

    <div class="s-step">
      <div class="s-step-num">5</div>
      <div class="s-step-content">
        <div class="s-step-title">Kintone にボタンを設置</div>
        <div class="s-step-sub">
          Kintone の「契約・請求管理」アプリの詳細画面にカスタムボタンを追加<br>
          ボタン名：<code>🖨 宛名ラベルを印刷</code><br>
          クリック → Print Creator の該当テンプレートで PDF 生成 → ダウンロード<br><br>
          設定場所：Kintone → アプリ設定 → JavaScript/CSSカスタマイズ<br>
          または Print Creator の「Kintoneプラグイン」から直接設置（コード不要）
        </div>
      </div>
    </div>

    <div class="s-step">
      <div class="s-step-num">6</div>
      <div class="s-step-content">
        <div class="s-step-title">印刷設定の注意点</div>
        <div class="s-step-sub">
          プリンター設定：「用紙に合わせて縮小」<strong>オフ</strong>（等倍で印刷）<br>
          余白：<strong>なし（0mm）</strong> に設定<br>
          シールシートをトレイにセットしてから印刷実行<br>
          初回は普通紙でテスト印刷して位置を確認することを推奨
        </div>
      </div>
    </div>

    <div class="s-hint">
      💡 <strong>管理会社住所が毎回同じ場合：</strong> Kintone の「管理会社マスタ」アプリを作り、管理会社名から住所を自動引用するルックアップ設定にすると入力が1回で済みます。<br><br>
      💡 <strong>エージェントが複数いる場合：</strong> 担当エージェントのユーザー管理レコードから住所・電話番号を自動引用できるので、差出人欄の打ち直し不要です。
    </div>
  </div>

  <div class="s-card">
    <div class="s-title">🛒 必要な物品</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div style="background:#f9fafb;border-radius:6px;padding:14px">
        <div style="font-size:13px;font-weight:600;color:#111827;margin-bottom:6px">シールシート</div>
        <div style="font-size:12px;color:#6b7280;line-height:1.7">
          エーワン 72303<br>
          A4・10面（95×61mm）<br>
          100枚入り 約¥1,800<br>
          Amazon / ヨドバシで購入可
        </div>
      </div>
      <div style="background:#f9fafb;border-radius:6px;padding:14px">
        <div style="font-size:13px;font-weight:600;color:#111827;margin-bottom:6px">プリンター</div>
        <div style="font-size:12px;color:#6b7280;line-height:1.7">
          レーザー推奨（滲まない）<br>
          インクジェットでも可<br>
          A4対応であれば機種不問<br>
          両面印刷機能は不要
        </div>
      </div>
    </div>
  </div>

</div>

<script src="db.js"></script>
<script>

  // ═══════════════════════════════════════════════════════════════
  //  CORETO 認証ガード v2 — セッション整合性チェック付き
  // ═══════════════════════════════════════════════════════════════
  (function() {
    var s;
    try { s = JSON.parse(sessionStorage.getItem('coreto_session') || 'null'); } catch(e) { s = null; }

    // 1. セッションなし → ログインへ
    if (!s || !s.userId || !s.type) {
      sessionStorage.setItem('coreto_redirect', window.location.href);
      window.location.replace('coreto-login.html');
      return;
    }

    // 2. セッション整合性検証（改ざん・偽造検知）
    //    DB.verifySessionSync: USERSとのtype/hqRole照合 + tokenLength確認
    if (typeof DB === 'undefined' || !DB.verifySessionSync(s)) {
      console.warn('[CORETO Auth] セッション整合性エラー（偽造または改ざん）— ログアウト');
      sessionStorage.removeItem('coreto_session');
      window.location.replace('coreto-login.html');
      return;
    }

    // 3. セッション有効期限チェック（8時間）
    var loginAt = new Date(s.loginAt).getTime();
    var SESSION_TTL = 8 * 60 * 60 * 1000; // 8時間
    if (isNaN(loginAt) || (Date.now() - loginAt) > SESSION_TTL) {
      sessionStorage.removeItem('coreto_session');
      alert('セッションの有効期限が切れました。再度ログインしてください。');
      window.location.replace('coreto-login.html');
      return;
    }

    window._SESSION = s;
  })();
  // ═══════════════════════════════════════════════════════════════


function showTab(tab) {
  document.getElementById('view-preview').style.display = tab === 'preview' ? 'flex' : 'none';
  document.getElementById('view-settings').style.display = tab === 'settings' ? 'block' : 'none';
  document.getElementById('tab-preview').className = 'tab' + (tab === 'preview' ? ' active' : '');
  document.getElementById('tab-settings').className = 'tab' + (tab === 'settings' ? ' active' : '');
}
</script>
</body>
</html>
